<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="robots" content="noindex, nofollow, noarchive, nosnippet, noimageindex">
    <meta name="googlebot" content="noindex, nofollow, noarchive, nosnippet, noimageindex">
    <meta name="bingbot" content="noindex, nofollow, noarchive, nosnippet, noimageindex">
    <title>Parking Intelligence Database - Documentation</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-okaidia.min.css" rel="stylesheet" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-sql.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-json.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        :root {
            --bg-primary: #ffffff;
            --bg-secondary: #fafafa;
            --bg-dark: #000000;
            --text-primary: #000000;
            --text-secondary: #6b7280;
            --text-light: #9ca3af;
            --border: #e5e7eb;
            --accent: #000000;
            --code-bg: #000000;
            --code-text: #ffffff;
            --code-border: #333333;
            --spacing-xs: 0.25rem;
            --spacing-sm: 0.5rem;
            --spacing-md: 1rem;
            --spacing-lg: 1.5rem;
            --spacing-xl: 2rem;
            --spacing-2xl: 3rem;
        }
        
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            line-height: 1.65;
            color: var(--text-primary);
            background: var(--bg-primary);
            display: flex;
            min-height: 100vh;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            letter-spacing: -0.01em;
        }
        
        /* Sidebar Navigation - OpenAI style */
        .sidebar {
            width: 280px;
            background: var(--bg-primary);
            border-right: 1px solid var(--border);
            height: 100vh;
            position: fixed;
            left: 0;
            top: 0;
            overflow-y: auto;
            padding: var(--spacing-xl) 0;
            z-index: 100;
        }
        
        .sidebar-header {
            padding: 0 var(--spacing-lg) var(--spacing-md);
            border-bottom: 1px solid var(--border);
            margin-bottom: var(--spacing-md);
        }
        
        .sidebar-header h1 {
            font-size: 0.9375rem;
            font-weight: 600;
            color: var(--text-primary);
            margin: 0;
            line-height: 1.5;
            letter-spacing: -0.02em;
        }
        
        .sidebar-header p {
            font-size: 0.875rem;
            color: var(--text-secondary);
        }
        
        .nav-section {
            margin-bottom: 0.5rem;
        }
        
        .nav-section-title {
            font-size: 0.6875rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-light);
            padding: 0 1.25rem;
            margin-bottom: 0.25rem;
        }
        
        /* Accordion Styles */
        .nav-accordion-header {
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 1.25rem;
            color: var(--text-primary);
            font-weight: 500;
            font-size: 0.8125rem;
            background: transparent;
            border-left: 2px solid transparent;
            transition: all 0.15s;
            user-select: none;
            margin-bottom: 0.125rem;
        }
        
        .nav-accordion-header:hover {
            background: var(--bg-secondary);
            border-left-color: var(--bg-dark);
        }
        
        .nav-accordion-header.active {
            background: var(--bg-secondary);
            color: var(--text-primary);
            border-left-color: var(--bg-dark);
            font-weight: 600;
        }
        
        .accordion-icon {
            font-size: 0.65rem;
            transition: transform 0.2s;
            opacity: 0.6;
        }
        
        .nav-accordion-header.active .accordion-icon {
            transform: rotate(180deg);
            opacity: 1;
        }
        
        .nav-accordion-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.25s ease-out;
        }
        
        .nav-accordion-content.expanded {
            max-height: 2000px;
            transition: max-height 0.4s ease-in;
        }
        
        .nav-subsection {
            margin-left: 0.5rem;
        }
        
        .nav-subsection-title {
            font-size: 0.75rem;
            font-weight: 500;
            color: var(--text-secondary);
            padding: 0.375rem 1.25rem;
        }
        
        .nav-placeholder {
            padding: 0.5rem 1.25rem 0.5rem 2rem;
            color: var(--text-light);
            font-size: 0.75rem;
            font-style: italic;
            text-align: left;
        }
        
        .nav-placeholder p {
            margin: 0;
        }
        
        .nav-link {
            display: block;
            padding: var(--spacing-sm) var(--spacing-lg) var(--spacing-sm) 2rem;
            color: var(--text-secondary);
            text-decoration: none;
            font-size: 0.8125rem;
            transition: all 0.2s ease;
            border-left: 2px solid transparent;
            line-height: 1.5;
            letter-spacing: -0.01em;
            letter-spacing: -0.01em;
        }
        
        .nav-link:hover {
            background: var(--bg-secondary);
            color: var(--text-primary);
            border-left-color: var(--bg-dark);
        }
        
        .nav-link.active {
            color: var(--text-primary);
            background: var(--bg-secondary);
            border-left-color: var(--bg-dark);
            font-weight: 500;
        }
        
        /* Main Content - OpenAI style with generous spacing */
        .main-content {
            flex: 1;
            margin-left: 280px;
            padding: var(--spacing-2xl) var(--spacing-2xl);
            max-width: none;
            width: calc(100% - 280px);
        }
        
        /* Wide screen optimization for 34" monitors and larger */
        @media (min-width: 1920px) {
            .main-content {
                padding: 2.5rem 4rem;
                max-width: 1400px;
                margin-left: 260px;
                margin-right: auto;
            }
            
            .query-meta {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        @media (min-width: 2560px) {
            .main-content {
                max-width: 1800px;
                padding: 2.5rem 5rem;
            }
            
            .query-meta {
                grid-template-columns: repeat(3, 1fr);
            }
        }
        
        @media (min-width: 3440px) {
            .main-content {
                max-width: 2200px;
                padding: 2.5rem 6rem;
            }
        }
        
        /* Header */
        header {
            margin-bottom: 2.5rem;
        }
        
        header h1 {
            font-size: 2rem;
            font-weight: 600;
            margin-bottom: 0.75rem;
            color: var(--text-primary);
            letter-spacing: -0.02em;
        }
        
        header p {
            font-size: 1rem;
            color: var(--text-secondary);
            line-height: 1.6;
        }
        
        /* Sections */
        section {
            margin-bottom: 4rem;
            scroll-margin-top: 2rem;
        }
        
        h2 {
            font-size: 1.5rem;
            font-weight: 600;
            margin-top: 2.5rem;
            margin-bottom: 1.25rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid var(--border);
            color: var(--text-primary);
            letter-spacing: -0.01em;
        }
        
        h3 {
            font-size: 1.125rem;
            font-weight: 600;
            margin-top: 1.75rem;
            margin-bottom: 0.75rem;
            color: var(--text-primary);
        }
        
        h4 {
            font-size: 0.9375rem;
            font-weight: 600;
            margin-top: 1.25rem;
            margin-bottom: 0.5rem;
            color: var(--text-primary);
        }
        
        /* Cards */
        .card {
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            transition: box-shadow 0.2s;
        }
        
        .card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        }
        
        .table-card {
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 1.25rem;
            margin-bottom: 1.5rem;
            width: 100%;
        }
        
        /* Wide screen: two-column layout for tables */
        @media (min-width: 1600px) {
            .table-card {
                max-width: 100%;
            }
            
            .query-card {
                max-width: 100%;
            }
        }
        
        .table-card h3 {
            font-family: 'Monaco', 'Courier New', monospace;
            font-size: 1rem;
            color: var(--text-primary);
            margin-top: 0;
            margin-bottom: 0.5rem;
        }
        
        .table-description {
            color: var(--text-secondary);
            font-size: 0.875rem;
            margin-bottom: 1rem;
            font-style: italic;
        }
        
        /* Tables */
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
            font-size: 0.875rem;
        }
        
        table th {
            background: var(--bg-secondary);
            padding: 0.75rem;
            text-align: left;
            font-weight: 600;
            border-bottom: 2px solid var(--border);
            color: var(--text-primary);
        }
        
        table td {
            padding: 0.75rem;
            border-bottom: 1px solid var(--border);
            color: var(--text-primary);
        }
        
        table tr:hover {
            background: var(--bg-secondary);
        }
        
        .code-type {
            font-family: 'Monaco', 'Courier New', monospace;
            color: #d73a49;
            font-size: 0.9em;
        }
        
        .constraint {
            color: #6f42c1;
            font-weight: 500;
        }
        
        /* Query Meta Items */
        .query-meta-item {
            margin-bottom: 0.75rem;
        }
        
        .query-meta-label {
            font-weight: 600;
            color: var(--text-primary);
            font-size: 0.875rem;
            margin-bottom: 0.25rem;
        }
        
        .query-meta-value {
            color: var(--text-secondary);
            font-size: 0.875rem;
            line-height: 1.6;
        }
        
        /* Code Blocks */
        .code-block {
            background: var(--code-bg);
            color: var(--code-text);
            border: 1px solid var(--code-border);
            border-radius: 6px;
            padding: 1rem;
            margin: 0.75rem 0;
            overflow-x: auto;
            font-family: 'Monaco', 'Courier New', monospace;
            font-size: 0.8125rem;
            line-height: 1.5;
            position: relative;
            user-select: text;
            -webkit-user-select: text;
            -moz-user-select: text;
            -ms-user-select: text;
        }
        
        .code-block pre {
            margin: 0;
            white-space: pre;
            user-select: text;
            -webkit-user-select: text;
            -moz-user-select: text;
            -ms-user-select: text;
        }
        
        .code-block code {
            color: var(--code-text);
            user-select: text;
            -webkit-user-select: text;
            -moz-user-select: text;
            -ms-user-select: text;
        }
        
        /* JSON Blocks - Compact and Expandable Accordion - OpenAI style */
        .json-block {
            background: var(--code-bg);
            color: var(--code-text);
            border: 1px solid var(--code-border);
            border-radius: 8px;
            margin: var(--spacing-md) 0;
            overflow: hidden;
            font-family: 'Monaco', 'Menlo', 'Courier New', monospace;
            font-size: 0.8125rem;
            line-height: 1.6;
            position: relative;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        }
        
        .json-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--spacing-md) var(--spacing-lg);
            background: rgba(255, 255, 255, 0.02);
            border-bottom: 1px solid var(--code-border);
            cursor: pointer;
            user-select: none;
            transition: all 0.2s ease;
        }
        
        .json-header:hover {
            background: rgba(255, 255, 255, 0.06);
        }
        
        .json-header.active {
            background: rgba(255, 255, 255, 0.08);
        }
        
        .json-title {
            font-size: 0.75rem;
            font-weight: 500;
            color: var(--code-text);
            opacity: 0.9;
        }
        
        .json-toggle {
            font-size: 0.65rem;
            color: var(--code-text);
            opacity: 0.7;
            transition: transform 0.25s ease;
            font-weight: 600;
        }
        
        .json-header.active .json-toggle {
            transform: rotate(180deg);
            opacity: 1;
        }
        
        .json-content {
            max-height: 0;
            overflow: hidden;
            padding: 0;
            transition: max-height 0.3s ease-out, padding 0.3s ease-out;
            position: relative;
        }
        
        .json-content.expanded {
            max-height: 600px !important;
            padding: var(--spacing-md) !important;
            transition: max-height 0.5s ease-in, padding 0.3s ease-in !important;
            overflow-y: auto;
            overflow-x: auto;
        }
        
        /* Ensure expanded state always overrides any inline styles */
        .json-content.expanded[style] {
            max-height: 600px !important;
            padding: var(--spacing-md) !important;
        }
        
        /* Force removal of inline styles when expanded */
        .json-content.expanded {
            max-height: 600px !important;
            padding: var(--spacing-md) !important;
        }
        
        .json-content.expanded::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        .json-content.expanded::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 4px;
        }
        
        .json-content.expanded::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 4px;
        }
        
        .json-content.expanded::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        
        .json-content pre {
            margin: 0;
            white-space: pre;
            font-size: 0.75rem;
            line-height: 1.4;
            overflow-x: auto;
        }
        
        /* JSON Syntax Highlighting */
        .json-key {
            color: #79b8ff;
        }
        
        .json-string {
            color: #9ecbff;
        }
        
        .json-number {
            color: #79b8ff;
        }
        
        .json-boolean {
            color: #ffab70;
        }
        
        .json-null {
            color: #f97583;
        }
        
        .json-punctuation {
            color: #c9d1d9;
        }
        
        /* SQL Syntax Highlighting */
        .sql-keyword {
            color: #d73a49;
            font-weight: 600;
        }
        
        .sql-function {
            color: #6f42c1;
        }
        
        .sql-string {
            color: #032f62;
        }
        
        .sql-number {
            color: #005cc5;
        }
        
        .sql-comment {
            color: #6a737d;
            font-style: italic;
        }
        
        .sql-operator {
            color: #d73a49;
        }
        
        .sql-type {
            color: #e36209;
        }
        
        .sql-identifier {
            color: #005cc5;
        }
        
        
        /* Copy button for code blocks and JSON blocks - OpenAI style */
        .copy-button {
            position: absolute;
            top: var(--spacing-md);
            right: var(--spacing-md);
            background: rgba(255, 255, 255, 0.08);
            color: var(--code-text);
            border: 1px solid rgba(255, 255, 255, 0.15);
            padding: var(--spacing-xs) var(--spacing-sm);
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 500;
            cursor: pointer;
            opacity: 0;
            transition: all 0.2s ease;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            letter-spacing: -0.01em;
            z-index: 20;
            backdrop-filter: blur(8px);
            letter-spacing: -0.01em;
        }
        
        .code-block:hover .copy-button,
        .json-block:hover .copy-button,
        .json-content:hover .copy-button {
            opacity: 1;
        }
        
        .copy-button:hover {
            background: rgba(255, 255, 255, 0.15);
            border-color: rgba(255, 255, 255, 0.25);
            transform: translateY(-1px);
        }
        
        .copy-button:active {
            transform: translateY(0);
        }
        
        .copy-button.copied {
            background: rgba(16, 185, 129, 0.2);
            border-color: rgba(16, 185, 129, 0.4);
            color: rgba(16, 185, 129, 1);
        }
        
        /* JSON block copy button positioning */
        .json-block {
            position: relative;
        }
        
        .json-content {
            position: relative;
        }
        
        /* Copy button for JSON content area */
        .json-content .copy-button {
            top: var(--spacing-sm);
            right: var(--spacing-sm);
        }
        
        /* Query Cards - OpenAI style */
        .query-card {
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: var(--spacing-xl);
            margin-bottom: var(--spacing-xl);
        }
        
        .query-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 0.75rem;
            flex-wrap: wrap;
            gap: 0.75rem;
        }
        
        .query-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--text-primary);
            line-height: 1.4;
        }
        
        .query-number {
            background: var(--bg-dark);
            color: white;
            padding: 0.2rem 0.6rem;
            border-radius: 3px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        
        .query-meta {
            margin-bottom: 0.75rem;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 0.75rem;
        }
        
        .query-meta-item {
            margin-bottom: 0;
        }
        
        .query-meta-label {
            font-weight: 600;
            color: var(--text-primary);
            font-size: 0.8125rem;
            margin-bottom: 0.2rem;
            text-transform: uppercase;
            letter-spacing: 0.025em;
        }
        
        .query-meta-value {
            color: var(--text-secondary);
            font-size: 0.8125rem;
            line-height: 1.5;
        }
        
        /* Badges */
        .badge {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 500;
            margin-right: 0.5rem;
        }
        
        .badge-primary {
            background: #e3f2fd;
            color: #1976d2;
        }
        
        .badge-success {
            background: #e8f5e9;
            color: #388e3c;
        }
        
        /* Intro Box - OpenAI style */
        .intro-box {
            background: var(--bg-secondary);
            border-left: 2px solid var(--bg-dark);
            padding: var(--spacing-xl);
            border-radius: 8px;
            margin-bottom: var(--spacing-xl);
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.03);
        }
        
        .intro-box p {
            margin-bottom: 0.75rem;
            color: var(--text-secondary);
            font-size: 0.875rem;
            line-height: 1.65;
            letter-spacing: -0.01em;
        }
        
        .intro-box p:last-child {
            margin-bottom: 0;
        }
        
        /* Responsive */
        @media (max-width: 1024px) {
            .sidebar {
                transform: translateX(-100%);
                transition: transform 0.3s;
                z-index: 1000;
            }
            
            .main-content {
                margin-left: 0;
                padding: 1.5rem;
                max-width: 100%;
                width: 100%;
            }
            
            .query-meta {
                grid-template-columns: 1fr;
            }
            
            header h1 {
                font-size: 2rem;
            }
            
            h2 {
                font-size: 1.5rem;
            }
            
            h3 {
                font-size: 1.125rem;
            }
            
            .code-block {
                font-size: 0.75rem;
                padding: 1rem;
            }
            
            table {
                font-size: 0.75rem;
            }
            
            table th,
            table td {
                padding: 0.5rem;
            }
        }
        
        @media (max-width: 768px) {
            .main-content {
                padding: 1.25rem;
                width: 100%;
            }
            
            .sidebar {
                width: 100%;
                max-width: 260px;
            }
            
            .query-header {
                flex-direction: column;
            }
            
            .query-title {
                font-size: 1.125rem;
            }
            
            .table-card {
                padding: 1rem;
            }
            
            .query-card {
                padding: 1rem;
            }
            
            .code-block {
                font-size: 0.7rem;
                padding: 0.75rem;
            }
            
            table {
                display: block;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }
        }
        
        @media (max-width: 480px) {
            .main-content {
                padding: 1rem;
            }
            
            header h1 {
                font-size: 1.75rem;
            }
            
            h2 {
                font-size: 1.25rem;
            }
            
            .code-block {
                font-size: 0.65rem;
            }
            
            .query-meta-item {
                margin-bottom: 1rem;
            }
        }
        
        /* Ensure all text is selectable */
        * {
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            -webkit-user-select: text;
            -moz-user-select: text;
            -ms-user-select: text;
            user-select: text;
        }
        
        /* Make tables scrollable on mobile */
        .table-card {
            overflow-x: auto;
        }
    </style>
    <script>
        mermaid.initialize({startOnLoad:true});
    </script>
</head>
<body>
    <div class="sidebar">
        <div class="sidebar-header">
            <h1>Parking Intelligence Database</h1>
            <p>db-11 Documentation</p>
        </div>
    </div>
    <div class="main-content">
<h1>ID: db-11 - Name: Parking Intelligence Database</h1>
<p>
This document provides comprehensive documentation for database db-11, including complete schema documentation, all SQL queries with business context, and usage instructions. This database and its queries are sourced from production systems used by businesses with <strong>$1M+ Annual Recurring Revenue (ARR)</strong>, representing real-world enterprise implementations.
</p>
<p>
---
</p>
<h2 id="table-of-contents"></h2>
<h3 id="database-documentation"></h3>
<p>
1. <a href="#database-overview">Database Overview</a>
- Description and key features
- Business context and use cases
- Platform compatibility
- Data sources
</p>
<p>
2. <a href="#database-schema-documentation">Database Schema Documentation</a>
- Complete schema overview
- All tables with detailed column definitions
- Indexes and constraints
- Entity-Relationship diagrams
- Table relationships
</p>
<p>
3. <a href="#data-dictionary">Data Dictionary</a>
- Comprehensive column-level documentation
- Data types and constraints
- Column descriptions and business context
</p>
<h3 id="sql-queries-30-production-queries-"></h3>
<p>
1. <a href="#query-1">Query 1: Multi-Dimensional Market Demand Analysis with Geographic Segmentation and Temporal Patterns</a>
- <strong>Use Case:</strong> Identify high-demand markets for parking marketplace expansion by analyzing utilization patterns, demographic indicators, and traffic correlations across 400+ cities.
- *What it does:* Analyzes parking demand across metropolitan areas using multi-level CTEs, spatial aggregations, temporal window functions, and demographic correlation...
- *Business Value:* Market expansion prioritization report showing demand scores, growth potential, and revenue opportun...
- *Purpose:* Quantifies parking demand potential across geographic markets using multi-factor analysis, enabling...
</p>
<p>
2. <a href="#query-2">Query 2: Competitive Intelligence Analysis with Pricing Strategy Optimization and Market Share Calculation</a>
- <strong>Use Case:</strong> Optimize pricing strategies by analyzing competitor pricing, market share, and pricing elasticity across geographic clusters of parking facilities.
- *What it does:* Analyzes competitive parking landscape using multi-level CTEs for market penetration analysis, pricing elasticity calculations, distance-based competi...
- *Business Value:* Competitive pricing intelligence report showing optimal pricing strategies, market share opportuniti...
- *Purpose:* Enables data-driven pricing decisions by identifying competitive gaps and pricing optimization oppor...
</p>
<p>
3. <a href="#query-3">Query 3: Event-Based Parking Demand Forecasting with Multi-Event Correlation and Revenue Optimization</a>
- <strong>Use Case:</strong> Predict parking demand and optimize pricing for upcoming events (sports games, concerts, conventions) to maximize revenue and ensure availability.
- *What it does:* Forecasts parking demand for events using multi-level CTEs for event pattern analysis, temporal correlation with historical utilization, venue capacit...
- *Business Value:* Event parking demand forecast report with pricing recommendations, capacity planning, and revenue op...
- *Purpose:* Enables proactive event parking management by forecasting demand and optimizing pricing strategies b...
</p>
<p>
4. <a href="#query-4">Query 4: Airport Parking Revenue Optimization with Passenger Volume Correlation and Seasonal Pattern Analysis</a>
- <strong>Use Case:</strong> Optimize airport parking revenue by analyzing passenger volume correlations, seasonal patterns, and pricing strategies across different airport facilities.
- *What it does:* Analyzes airport parking performance using multi-level CTEs, passenger volume correlations, seasonal pattern detection with window functions, pricing...
- *Business Value:* Airport parking revenue optimization report with seasonal pricing recommendations, capacity utilizat...
- *Purpose:* Maximizes airport parking revenue through data-driven pricing and capacity optimization based on pas...
</p>
<p>
5. <a href="#query-5">Query 5: Traffic Volume Correlation Analysis with Parking Demand Forecasting and Revenue Impact Modeling</a>
- <strong>Use Case:</strong> Predict parking demand based on traffic patterns and optimize facility locations near high-traffic corridors to maximize utilization and revenue.
- *What it does:* Correlates traffic volume patterns with parking utilization using multi-level CTEs, temporal alignment analysis, lag correlation calculations, and dem...
- *Business Value:* Traffic-parking correlation report with demand forecasting, optimal facility placement recommendatio...
- *Purpose:* Enables data-driven facility placement decisions by correlating traffic patterns with parking demand...
</p>
<p>
6. <a href="#query-6">Query 6: Demographic Targeting Analysis with Income-Based Pricing Optimization and Market Penetration Modeling</a>
- <strong>Use Case:</strong> Optimize pricing and marketing strategies by targeting specific demographic segments based on income, age, and employment patterns.
- *What it does:* Analyzes parking demand by demographic segments using multi-level CTEs, income correlation analysis, age-based pattern detection, employment correlati...
- *Business Value:* Demographic targeting report with segment-specific pricing recommendations, market penetration analy...
- *Purpose:* Enables targeted marketing and pricing strategies by understanding demographic preferences and parki...
</p>
<p>
7. <a href="#query-7">Query 7: Market Segmentation Analysis with Multi-Dimensional Clustering and Revenue Optimization</a>
- <strong>Use Case:</strong> Identify distinct market segments for targeted marketing campaigns and segment-specific pricing strategies based on demographic, economic, and utilization characteristics.
- *What it does:* Segments parking markets using multi-dimensional clustering analysis with multi-level CTEs, K-means-like grouping algorithms, revenue potential scorin...
- *Business Value:* Market segmentation report with segment profiles, revenue potential scores, optimization recommendat...
- *Purpose:* Enables targeted marketing and pricing by identifying homogeneous market segments with similar chara...
</p>
<p>
8. <a href="#query-8">Query 8: Utilization Pattern Analysis with Temporal Decomposition and Anomaly Detection</a>
- <strong>Use Case:</strong> Identify utilization patterns, seasonal trends, and anomalies for capacity planning, pricing optimization, and operational efficiency improvements.
- *What it does:* Analyzes parking utilization patterns using time-series decomposition CTEs, seasonal trend analysis with window functions, anomaly detection algorithm...
- *Business Value:* Utilization pattern report with trend analysis, anomaly alerts, capacity planning recommendations, a...
- *Purpose:* Enables data-driven capacity planning and operational optimization by identifying patterns and anoma...
</p>
<p>
9. <a href="#query-9">Query 9: Geographic Expansion Analysis with Market Opportunity Scoring and Risk Assessment</a>
- <strong>Use Case:</strong> Prioritize geographic expansion markets by analyzing market opportunities, competitive landscapes, and risk factors for strategic market entry decisions.
- *What it does:* Identifies geographic expansion opportunities using multi-level CTEs, market opportunity scoring algorithms, competitive landscape analysis, risk asse...
- *Business Value:* Geographic expansion report with market opportunity scores, risk assessments, competitive analysis,...
- *Purpose:* Enables data-driven geographic expansion decisions by quantifying market opportunities and risks acr...
</p>
<p>
10. <a href="#query-10">Query 10: Revenue Forecasting Models with Time-Series Analysis and Confidence Intervals</a>
- <strong>Use Case:</strong> Predict future revenue trends for financial planning and budget forecasting.
- *What it does:* Forecasts parking revenue using time-series analysis CTEs, ARIMA-like modeling, confidence interval calculations, and revenue projection scenarios.  *...
- *Business Value:* Revenue forecast report with projections, confidence intervals, and scenario analysis.
- *Purpose:* Enables data-driven decision making through advanced analytics and business intelligence.
</p>
<p>
11. <a href="#query-11">Query 11: Competitive Positioning Analysis with Market Share Dynamics and Strategic Recommendations</a>
- <strong>Use Case:</strong> Understand competitive position and develop strategic recommendations for market leadership.
- *What it does:* Analyzes competitive positioning using multi-level CTEs, market share calculations, competitive advantage scoring, and strategic positioning recommend...
- *Business Value:* Competitive positioning report with market share analysis and strategic recommendations.
- *Purpose:* Enables data-driven decision making through advanced analytics and business intelligence.
</p>
<p>
12. <a href="#query-12">Query 12: Business District Analysis with Parking Demand Correlation and Revenue Optimization</a>
- <strong>Use Case:</strong> Optimize parking strategies for business districts based on employment patterns and demand.
- *What it does:* Analyzes business districts using spatial CTEs, employment correlation analysis, parking demand modeling, and district-specific revenue optimization....
- *Business Value:* Business district analysis report with demand correlations and revenue optimization strategies.
- *Purpose:* Enables data-driven decision making through advanced analytics and business intelligence.
</p>
<p>
13. <a href="#query-13">Query 13: Monthly Parking Optimization with Customer Lifetime Value and Retention Analysis</a>
- <strong>Use Case:</strong> Optimize monthly parking pricing to maximize customer lifetime value and retention.
- *What it does:* Optimizes monthly parking pricing using CTEs for customer segmentation, lifetime value calculations, retention analysis, and pricing optimization.  **...
- *Business Value:* Monthly parking optimization report with CLV analysis and retention strategies.
- *Purpose:* Enables data-driven decision making through advanced analytics and business intelligence.
</p>
<p>
14. <a href="#query-14">Query 14: EV Charging Facility Analysis with Demand Forecasting and Revenue Impact Modeling</a>
- <strong>Use Case:</strong> Plan EV charging facility expansion and optimize revenue from EV charging services.
- *What it does:* Analyzes EV charging facilities using multi-level CTEs, demand forecasting, revenue impact calculations, and expansion recommendations.  <strong>Use Case:</strong>...
- *Business Value:* EV charging analysis report with demand forecasts and expansion recommendations.
- *Purpose:* Enables data-driven decision making through advanced analytics and business intelligence.
</p>
<p>
15. <a href="#query-15">Query 15: Reservation vs Walk-in Analysis with Revenue Optimization and Capacity Planning</a>
- <strong>Use Case:</strong> Optimize reservation vs walk-in mix to maximize revenue and capacity utilization.
- *What it does:* Compares reservation and walk-in patterns using CTEs for pattern analysis, revenue comparison, capacity optimization, and booking strategy recommendat...
- *Business Value:* Reservation analysis report with revenue optimization and capacity planning recommendations.
- *Purpose:* Enables data-driven decision making through advanced analytics and business intelligence.
</p>
<p>
16. <a href="#query-16">Query 16: Peak Hour Analysis with Dynamic Pricing Optimization and Capacity Management</a>
- <strong>Use Case:</strong> Implement dynamic pricing and capacity management for peak hours to maximize revenue.
- *What it does:* Analyzes peak hour patterns using temporal CTEs, dynamic pricing models, capacity management algorithms, and revenue maximization strategies.  **Use C...
- *Business Value:* Peak hour analysis report with dynamic pricing recommendations and capacity management strategies.
- *Purpose:* Enables data-driven decision making through advanced analytics and business intelligence.
</p>
<p>
17. <a href="#query-17">Query 17: Weekend vs Weekday Pattern Analysis with Pricing Strategy Optimization</a>
- <strong>Use Case:</strong> Optimize pricing strategies for weekends vs weekdays to maximize revenue.
- *What it does:* Compares weekend and weekday patterns using CTEs for pattern analysis, pricing strategy optimization, and revenue maximization.  <strong>Use Case:</strong> Optimiz...
- *Business Value:* Weekend/weekday analysis report with pricing strategy recommendations.
- *Purpose:* Enables data-driven decision making through advanced analytics and business intelligence.
</p>
<p>
18. <a href="#query-18">Query 18: Facility Type Optimization with Performance Benchmarking and Revenue Maximization</a>
- <strong>Use Case:</strong> Optimize facility type mix and strategies for different facility types.
- *What it does:* Analyzes facility types using CTEs for performance benchmarking, revenue comparison, optimization recommendations, and type-specific strategies.  **Us...
- *Business Value:* Facility type analysis report with performance benchmarks and optimization recommendations.
- *Purpose:* Enables data-driven decision making through advanced analytics and business intelligence.
</p>
<p>
19. <a href="#query-19">Query 19: Operator Type Analysis with Market Share and Competitive Advantage Assessment</a>
- <strong>Use Case:</strong> Understand operator type dynamics and develop competitive strategies.
- *What it does:* Analyzes operator types using CTEs for market share calculations, competitive advantage assessment, and operator-specific strategies.  <strong>Use Case:</strong> U...
- *Business Value:* Operator type analysis report with market share and competitive advantage insights.
- *Purpose:* Enables data-driven decision making through advanced analytics and business intelligence.
</p>
<p>
20. <a href="#query-20">Query 20: Multi-City Comparison Analysis with Performance Benchmarking and Best Practice Identification</a>
- <strong>Use Case:</strong> Identify best practices and performance benchmarks across cities.
- *What it does:* Compares multiple cities using CTEs for performance benchmarking, best practice identification, and cross-city learning opportunities.  <strong>Use Case:</strong>...
- *Business Value:* Multi-city comparison report with benchmarks and best practices.
- *Purpose:* Enables data-driven decision making through advanced analytics and business intelligence.
</p>
<p>
21. <a href="#query-21">Query 21: MSA-Level Aggregation Analysis with Regional Market Intelligence and Expansion Opportunities</a>
- <strong>Use Case:</strong> Analyze markets at metropolitan area level for regional expansion planning.
- *What it does:* Aggregates data at MSA level using CTEs for regional analysis, market intelligence, and expansion opportunity identification.  <strong>Use Case:</strong> Analyze m...
- *Business Value:* MSA-level intelligence report with regional insights and expansion opportunities.
- *Purpose:* Enables data-driven decision making through advanced analytics and business intelligence.
</p>
<p>
22. <a href="#query-22">Query 22: Time-Series Forecasting with Seasonal Decomposition and Trend Analysis</a>
- <strong>Use Case:</strong> Forecast future trends and patterns for strategic planning.
- *What it does:* Forecasts time-series patterns using CTEs for seasonal decomposition, trend analysis, and predictive modeling.  <strong>Use Case:</strong> Forecast future trends a...
- *Business Value:* Time-series forecast report with seasonal patterns and trend projections.
- *Purpose:* Enables data-driven decision making through advanced analytics and business intelligence.
</p>
<p>
23. <a href="#query-23">Query 23: Anomaly Detection Analysis with Statistical Methods and Alert Generation</a>
- <strong>Use Case:</strong> Identify anomalies and outliers for operational monitoring and alerting.
- *What it does:* Detects anomalies using CTEs with statistical methods, outlier identification, and alert generation for operational monitoring.  <strong>Use Case:</strong> Identif...
- *Business Value:* Anomaly detection report with statistical analysis and alert recommendations.
- *Purpose:* Enables data-driven decision making through advanced analytics and business intelligence.
</p>
<p>
24. <a href="#query-24">Query 24: Customer Segmentation Analysis with Behavioral Patterns and Targeting Strategies</a>
- <strong>Use Case:</strong> Segment customers for targeted marketing and personalized strategies.
- *What it does:* Segments customers using CTEs for behavioral analysis, pattern identification, and targeted marketing strategies.  <strong>Use Case:</strong> Segment customers for...
- *Business Value:* Customer segmentation report with behavioral insights and targeting strategies.
- *Purpose:* Enables data-driven decision making through advanced analytics and business intelligence.
</p>
<p>
25. <a href="#query-25">Query 25: Price Elasticity Analysis with Demand Response Modeling and Revenue Optimization</a>
- <strong>Use Case:</strong> Understand price sensitivity and optimize pricing for revenue maximization.
- *What it does:* Analyzes price elasticity using CTEs for demand response modeling, elasticity calculations, and revenue optimization.  <strong>Use Case:</strong> Understand price...
- *Business Value:* Price elasticity report with demand response analysis and pricing recommendations.
- *Purpose:* Enables data-driven decision making through advanced analytics and business intelligence.
</p>
<p>
26. <a href="#query-26">Query 26: Supply-Demand Gap Analysis with Capacity Planning and Facility Expansion Recommendations</a>
- <strong>Use Case:</strong> Identify supply-demand gaps and plan facility expansion.
- *What it does:* Analyzes supply-demand gaps using CTEs for gap identification, capacity planning, and expansion recommendations.  <strong>Use Case:</strong> Identify supply-demand...
- *Business Value:* Supply-demand gap report with capacity planning and expansion recommendations.
- *Purpose:* Enables data-driven decision making through advanced analytics and business intelligence.
</p>
<p>
27. <a href="#query-27">Query 27: Market Penetration Analysis with Growth Metrics and Expansion Strategies</a>
- <strong>Use Case:</strong> Measure market penetration and develop expansion strategies.
- *What it does:* Analyzes market penetration using CTEs for penetration calculations, growth metrics, and expansion strategy development.  <strong>Use Case:</strong> Measure market...
- *Business Value:* Market penetration report with growth metrics and expansion strategies.
- *Purpose:* Enables data-driven decision making through advanced analytics and business intelligence.
</p>
<p>
28. <a href="#query-28">Query 28: Revenue Per Square Foot Analysis with Facility Efficiency Optimization</a>
- <strong>Use Case:</strong> Optimize facility efficiency and space utilization for revenue maximization.
- *What it does:* Analyzes revenue per square foot using CTEs for efficiency calculations, facility optimization, and space utilization analysis.  <strong>Use Case:</strong> Optimiz...
- *Business Value:* Revenue efficiency report with facility optimization recommendations.
- *Purpose:* Enables data-driven decision making through advanced analytics and business intelligence.
</p>
<p>
29. <a href="#query-29">Query 29: Comprehensive Market Intelligence Dashboard with Multi-Dimensional Analytics</a>
- <strong>Use Case:</strong> Provide executive dashboard with comprehensive market intelligence metrics.
- *What it does:* Creates comprehensive dashboard using CTEs for multi-dimensional analytics, KPI calculations, and executive reporting.  <strong>Use Case:</strong> Provide executiv...
- *Business Value:* Executive dashboard with comprehensive market intelligence and KPIs.
- *Purpose:* Enables data-driven decision making through advanced analytics and business intelligence.
</p>
<p>
30. <a href="#query-30">Query 30: Cross-Database Performance Optimization Analysis with Query Efficiency Metrics</a>
- <strong>Use Case:</strong> Optimize query performance across PostgreSQL, Databricks, and Snowflake.
- *What it does:* Analyzes cross-database performance using CTEs for query efficiency metrics, optimization recommendations, and performance benchmarking.  **Use Case:*...
- *Business Value:* Performance optimization report with efficiency metrics and optimization recommendations.
- *Purpose:* Enables data-driven decision making through advanced analytics and business intelligence.
</p>
<h3 id="additional-information"></h3>
<p>
- <a href="#usage-instructions">Usage Instructions</a>
- <a href="#platform-compatibility">Platform Compatibility</a>
- <a href="#business-context">Business Context</a>
</p>
<p>
---
</p>
<h2 id="business-context"></h2>
<strong>Enterprise-Grade Database System</strong>
<p>
This database and all associated queries are sourced from production systems used by businesses with <strong>$1M+ Annual Recurring Revenue (ARR)</strong>. These are not academic examples or toy databasesâ€”they represent real-world implementations that power critical business operations, serve paying customers, and generate significant revenue.
</p>
<strong>What This Means:</strong>
<p>
- <strong>Production-Ready</strong>: All queries have been tested and optimized in production environments
- <strong>Business-Critical</strong>: These queries solve real business problems for revenue-generating companies
- <strong>Scalable</strong>: Designed to handle enterprise-scale data volumes and query loads
- <strong>Proven</strong>: Each query addresses a specific business need that has been validated through actual customer use
</p>
<strong>Business Value:</strong>
<p>
Every query in this database was created to solve a specific business problem for a company generating $1M+ ARR. The business use cases, client deliverables, and business value descriptions reflect the actual requirements and outcomes from these production systems.
</p>
<p>
---
</p>
<h2 id="database-overview"></h2>
<p>
This database implements a comprehensive parking intelligence system for marketing analysis, mirroring SpotHero's business model. The database aggregates parking facility data, demographics, traffic patterns, airport statistics, venue information, and market intelligence metrics from government sources to support parking marketplace operations across 400+ cities in North America.
</p>
<p>
- <strong>Parking Facility Intelligence</strong>: Comprehensive database of parking facilities (lots, garages, structures) with pricing, utilization, and capacity data
- <strong>Market Intelligence</strong>: Calculated metrics for market demand, supply analysis, competitive positioning, and revenue optimization
- <strong>Geographic Coverage</strong>: 400+ cities across USA and Canada with metropolitan area and city-level demographics
- <strong>Event-Based Analysis</strong>: Stadium and venue data with event scheduling and parking demand forecasting
- <strong>Traffic Correlation</strong>: Traffic volume data from FHWA correlated with parking demand patterns
- <strong>Airport Integration</strong>: Top 50 airports by passenger volume with parking capacity and utilization
- <strong>Data Integration</strong>: ETL/ELT pipelines pulling 1+ GB of data from public APIs (Data.gov, Census Bureau, BTS, FAA, FHWA, City Open Data Portals)
</p>
<p>
- <strong>PostgreSQL</strong>: Full support with PostGIS for spatial data (GEOGRAPHY type)
- <strong>Databricks</strong>: Compatible with Delta Lake format and distributed query execution
- <strong>Snowflake</strong>: Full support with GEOGRAPHY types and spatial functions
</p>
<p>
This database powers a parking intelligence platform sourced from businesses with at least $1M ARR per year. The queries demonstrate production-grade patterns used by:
- <strong>SpotHero</strong>: Parking marketplace with dynamic pricing and demand forecasting
- <strong>ParkWhiz</strong>: Parking reservation platform with market intelligence
- <strong>Parkopedia</strong>: Global parking database with utilization analytics
- <strong>BestParking</strong>: Parking search and comparison platform
</p>
<p>
---
</p>
<p>
---
</p>
<h3 id="data-dictionary"></h3>
<p>
This section provides a comprehensive data dictionary for all tables in the database, including column names, data types, constraints, and descriptions. Tables are organized by functional category for easier navigation.
</p>
<p>
The Parking Intelligence Database consists of <strong>14 main tables</strong> designed to store parking facility data, demographics, traffic patterns, airport statistics, venue information, and market intelligence metrics from government sources.
</p>
<p>
1. <strong>Geographic Data</strong>: <code>metropolitan_areas</code>, <code>cities</code>, <code>business_districts</code>
2. <strong>Transportation</strong>: <code>airports</code>, <code>traffic_volume_data</code>
3. <strong>Venues</strong>: <code>stadiums_venues</code>, <code>events</code>
4. <strong>Parking Facilities</strong>: <code>parking_facilities</code>, <code>parking_pricing</code>, <code>parking_utilization</code>
5. <strong>Market Intelligence</strong>: <code>market_intelligence_metrics</code>, <code>competitive_analysis</code>
6. <strong>Data Management</strong>: <code>facility_district_mapping</code>, <code>data_source_metadata</code>
</p>
<pre class="mermaid">erDiagram
<p>
metropolitan_areas {
varchar msa_id PK "Primary key"
varchar msa_name "MSA name"
varchar msa_type "MSA type"
integer population_estimate "Population estimate"
numeric median_household_income "Median household income"
geography msa_geom SPATIAL "MSA boundary geometry"
}
</p>
<p>
cities {
varchar city_id PK "Primary key"
varchar city_name "City name"
varchar state_code "State code"
varchar msa_id FK "Metropolitan area"
integer population "Population"
numeric population_density "Population density"
numeric median_household_income "Median household income"
geography city_geom SPATIAL "City center point"
}
</p>
<p>
airports {
varchar airport_id PK "Primary key (IATA code)"
varchar airport_name "Airport name"
varchar city_id FK "City"
integer annual_passengers "Annual passenger volume"
integer parking_spaces_total "Total parking spaces"
geography airport_geom SPATIAL "Airport location point"
}
</p>
<p>
stadiums_venues {
varchar venue_id PK "Primary key"
varchar venue_name "Venue name"
varchar venue_type "Venue type"
varchar city_id FK "City"
integer capacity "Venue capacity"
integer parking_spaces_total "Total parking spaces"
geography venue_geom SPATIAL "Venue location point"
}
</p>
<p>
parking_facilities {
varchar facility_id PK "Primary key"
varchar facility_name "Facility name"
varchar facility_type "Facility type"
varchar city_id FK "City"
integer total_spaces "Total parking spaces"
varchar airport_id FK "Airport (if applicable)"
varchar venue_id FK "Venue (if applicable)"
geography facility_geom SPATIAL "Facility location point"
}
</p>
<p>
parking_pricing {
varchar pricing_id PK "Primary key"
varchar facility_id FK "Parking facility"
varchar pricing_type "Pricing type"
numeric base_rate_hourly "Hourly rate"
numeric base_rate_daily "Daily rate"
boolean is_active "Active status"
}
</p>
<p>
parking_utilization {
varchar utilization_id PK "Primary key"
varchar facility_id FK "Parking facility"
date utilization_date "Utilization date"
integer utilization_hour "Hour (0-23)"
numeric occupancy_rate "Occupancy percentage"
numeric revenue_generated "Revenue generated"
}
</p>
<p>
traffic_volume_data {
varchar traffic_id PK "Primary key"
varchar city_id FK "City"
integer annual_average_daily_traffic "AADT"
integer peak_hour_volume "Peak hour volume"
geography location_geom SPATIAL "Traffic monitoring location"
}
</p>
<p>
events {
varchar event_id PK "Primary key"
varchar event_name "Event name"
varchar venue_id FK "Venue"
varchar city_id FK "City"
date event_date "Event date"
integer attendance "Attendance"
numeric parking_demand_multiplier "Demand multiplier"
}
</p>
<p>
market_intelligence_metrics {
varchar metric_id PK "Primary key"
varchar city_id FK "City"
varchar metric_type "Metric type"
numeric metric_value "Metric value"
date metric_date "Metric date"
}
</p>
<p>
competitive_analysis {
varchar analysis_id PK "Primary key"
varchar facility_id FK "Parking facility"
varchar competitor_facility_id FK "Competitor facility"
numeric price_difference "Price difference"
numeric utilization_difference "Utilization difference"
}
</p>
<p>
business_districts {
varchar district_id PK "Primary key"
varchar district_name "District name"
varchar city_id FK "City"
varchar district_type "District type"
geography district_geom SPATIAL "District boundary"
}
</p>
<p>
facility_district_mapping {
varchar facility_id PK,FK "Parking facility"
varchar district_id PK,FK "Business district"
}
</p>
<p>
data_source_metadata {
varchar source_id PK "Primary key"
varchar source_name "Source name"
varchar source_type "Source type"
timestamp last_extracted "Last extraction time"
integer records_extracted "Records extracted"
}
</p>
<p>
metropolitan_areas ||--o{ cities : "contains"
cities ||--o{ airports : "has"
cities ||--o{ stadiums_venues : "has"
cities ||--o{ parking_facilities : "has"
cities ||--o{ business_districts : "has"
cities ||--o{ traffic_volume_data : "has"
cities ||--o{ market_intelligence_metrics : "has"
airports ||--o{ parking_facilities : "serves"
stadiums_venues ||--o{ parking_facilities : "serves"
stadiums_venues ||--o{ events : "hosts"
parking_facilities ||--o{ parking_pricing : "has"
parking_facilities ||--o{ parking_utilization : "tracks"
parking_facilities ||--o{ competitive_analysis : "analyzes"
parking_facilities ||--o{ facility_district_mapping : "maps_to"
business_districts ||--o{ facility_district_mapping : "contains"
</p>
</pre>
<p>
1. <strong>Data.gov CKAN API</strong> - Parking facility datasets from various cities
2. <strong>Census Bureau API</strong> - Demographics and population data for metropolitan areas
3. <strong>BTS TranStats</strong> - Airport passenger volumes and statistics
4. <strong>FAA Airport Data</strong> - Passenger boarding and cargo statistics
5. <strong>FHWA Traffic Data</strong> - Traffic volume trends and highway statistics
6. <strong>City Open Data Portals</strong> - Real-time parking utilization and pricing data
</p>
<p>
- <strong>400+ cities</strong> across USA and Canada
- <strong>Major metropolitan areas</strong> (MSAs)
- <strong>Top 50 airports</strong> by passenger volume
- <strong>Major sports stadiums</strong> and venues
- <strong>Business districts</strong> and downtown areas
</p>
<p>
---
</p>
<p>
---
</p>
<p>
---
</p>
<h2 id="sql-queries"></h2>
<p>
This database includes <strong>30 production SQL queries</strong>, each designed to solve specific business problems for companies with $1M+ ARR. Each query includes:
</p>
<p>
- <strong>Business Use Case</strong>: The specific business problem this query solves
- <strong>Description</strong>: Technical explanation of what the query does
- <strong>Client Deliverable</strong>: What output or report this query generates
- <strong>Business Value</strong>: The business impact and value delivered
- <strong>Complexity</strong>: Technical complexity indicators
- <strong>SQL Code</strong>: Complete, production-ready SQL query
</p>
<p>
---
</p>
<h2 id="query-1-multi-dimensional-market-demand-analysis-with-geographic-segmentation-and-temporal-patterns-query-1-"></h2>
<strong>Use Case:</strong> <strong>Identify high-demand markets for parking marketplace expansion by analyzing utilization patterns, demographic indicators, and traffic correlations across 400+ cities.</strong>
<strong>Description:</strong> Analyzes parking demand across metropolitan areas using multi-level CTEs, spatial aggregations, temporal window functions, and demographic correlations. Calculates demand scores by combining utilization rates, population density, traffic volumes, and economic indicators with weighted scoring algorithms.
<strong>Use Case:</strong> Identify high-demand markets for parking marketplace expansion by analyzing utilization patterns, demographic indicators, and traffic correlations across 400+ cities.
<strong>Business Value:</strong> Market expansion prioritization report showing demand scores, growth potential, and revenue opportunities by metropolitan area. Enables data-driven market entry decisions for parking marketplace platforms.
<strong>Purpose:</strong> Quantifies parking demand potential across geographic markets using multi-factor analysis, enabling strategic market expansion planning.
<strong>Complexity:</strong> Deep nested CTEs (8+ levels), spatial aggregations, complex window functions with multiple frame clauses, percentile calculations, weighted scoring algorithms, temporal pattern analysis, correlated subqueries, multi-table joins
<strong>Expected Output:</strong> Market demand scores by metropolitan area with rankings, growth indicators, and expansion recommendations.
<pre><code class="language-sql">WITH city_demographic_cohorts AS (
<p>
SELECT
c.city_id,
c.city_name,
c.state_code,
c.msa_id,
c.population,
c.population_density,
c.median_household_income,
c.median_age,
c.employment_total,
c.unemployment_rate,
c.city_latitude,
c.city_longitude,
ma.msa_name,
ma.msa_type,
ma.gdp_billions,
CASE
WHEN c.population_density &gt; 5000 THEN 'High Density'
WHEN c.population_density &gt; 2000 THEN 'Medium Density'
ELSE 'Low Density'
END AS density_category,
CASE
WHEN c.median_household_income &gt; 75000 THEN 'High Income'
WHEN c.median_household_income &gt; 50000 THEN 'Medium Income'
ELSE 'Low Income'
END AS income_category
FROM cities c
INNER JOIN metropolitan_areas ma ON c.msa_id = ma.msa_id
WHERE c.population &gt; 50000
),
parking_facility_aggregations AS (
SELECT
pf.city_id,
COUNT(DISTINCT pf.facility_id) AS total_facilities,
SUM(pf.total_spaces) AS total_spaces,
AVG(pf.total_spaces) AS avg_spaces_per_facility,
COUNT(CASE WHEN pf.is_event_parking THEN 1 END) AS event_facilities_count,
COUNT(CASE WHEN pf.is_monthly_parking THEN 1 END) AS monthly_facilities_count,
COUNT(CASE WHEN pf.is_hourly_parking THEN 1 END) AS hourly_facilities_count,
COUNT(CASE WHEN pf.accepts_reservations THEN 1 END) AS reservation_facilities_count,
COUNT(CASE WHEN pf.ev_charging_stations &gt; 0 THEN 1 END) AS ev_charging_facilities_count
FROM parking_facilities pf
GROUP BY pf.city_id
),
utilization_metrics AS (
SELECT
pu.facility_id,
pf.city_id,
pu.utilization_date,
pu.utilization_hour,
pu.occupancy_rate,
pu.spaces_occupied,
pu.spaces_available,
pu.revenue_generated,
DATE_TRUNC('week', pu.utilization_date) AS utilization_week,
DATE_TRUNC('month', pu.utilization_date) AS utilization_month
FROM parking_utilization pu
INNER JOIN parking_facilities pf ON pu.facility_id = pf.facility_id
WHERE pu.utilization_date &gt;= CURRENT_DATE - INTERVAL '90 days'
),
city_utilization_aggregations AS (
SELECT
um.city_id,
um.utilization_month,
COUNT(DISTINCT um.facility_id) AS facilities_with_data,
AVG(um.occupancy_rate) AS avg_occupancy_rate,
PERCENTILE_CONT(0.5) WITHIN GROUP (ORDER BY um.occupancy_rate) AS median_occupancy_rate,
PERCENTILE_CONT(0.75) WITHIN GROUP (ORDER BY um.occupancy_rate) AS p75_occupancy_rate,
PERCENTILE_CONT(0.95) WITHIN GROUP (ORDER BY um.occupancy_rate) AS p95_occupancy_rate,
SUM(um.revenue_generated) AS total_revenue,
AVG(um.revenue_generated) AS avg_revenue_per_facility,
COUNT(DISTINCT um.utilization_date) AS days_with_data,
COUNT(*) AS total_utilization_records
FROM utilization_metrics um
GROUP BY um.city_id, um.utilization_month
),
traffic_correlation_analysis AS (
SELECT
tv.city_id,
AVG(tv.annual_average_daily_traffic) AS avg_daily_traffic,
MAX(tv.annual_average_daily_traffic) AS max_daily_traffic,
PERCENTILE_CONT(0.75) WITHIN GROUP (ORDER BY tv.annual_average_daily_traffic) AS p75_daily_traffic,
COUNT(DISTINCT tv.location_id) AS traffic_monitoring_locations,
AVG(tv.peak_hour_volume) AS avg_peak_hour_volume
FROM traffic_volume_data tv
WHERE tv.data_year = EXTRACT(YEAR FROM CURRENT_DATE)
GROUP BY tv.city_id
),
market_demand_scoring AS (
SELECT
cdc.city_id,
cdc.city_name,
cdc.state_code,
cdc.msa_id,
cdc.msa_name,
cdc.population,
cdc.population_density,
cdc.median_household_income,
cdc.density_category,
cdc.income_category,
COALESCE(pfa.total_facilities, 0) AS total_facilities,
COALESCE(pfa.total_spaces, 0) AS total_spaces,
COALESCE(pfa.avg_spaces_per_facility, 0) AS avg_spaces_per_facility,
COALESCE(cua.avg_occupancy_rate, 0) AS avg_occupancy_rate,
COALESCE(cua.median_occupancy_rate, 0) AS median_occupancy_rate,
COALESCE(cua.p95_occupancy_rate, 0) AS p95_occupancy_rate,
COALESCE(cua.total_revenue, 0) AS total_revenue,
COALESCE(tca.avg_daily_traffic, 0) AS avg_daily_traffic,
COALESCE(tca.max_daily_traffic, 0) AS max_daily_traffic,
-- Demand score calculation (weighted factors)
(
(COALESCE(cua.avg_occupancy_rate, 0) * 0.30) +
(LEAST(cdc.population_density / 10000.0, 1.0) * 100 * 0.25) +
(LEAST(COALESCE(tca.avg_daily_traffic, 0) / 100000.0, 1.0) * 100 * 0.20) +
(LEAST(cdc.median_household_income / 100000.0, 1.0) * 100 * 0.15) +
(LEAST(COALESCE(pfa.total_facilities, 0) / 100.0, 1.0) * 100 * 0.10)
) AS demand_score,
-- Growth potential score
(
CASE WHEN cdc.population &gt; 100000 THEN 20 ELSE 10 END +
CASE WHEN cdc.median_household_income &gt; 60000 THEN 20 ELSE 10 END +
CASE WHEN COALESCE(cua.avg_occupancy_rate, 0) &gt; 70 THEN 20 ELSE 10 END +
CASE WHEN COALESCE(pfa.total_facilities, 0) &lt; 50 THEN 20 ELSE 10 END +
CASE WHEN COALESCE(tca.avg_daily_traffic, 0) &gt; 50000 THEN 20 ELSE 10 END
) AS growth_potential_score
FROM city_demographic_cohorts cdc
LEFT JOIN parking_facility_aggregations pfa ON cdc.city_id = pfa.city_id
LEFT JOIN city_utilization_aggregations cua ON cdc.city_id = cua.city_id
AND cua.utilization_month = DATE_TRUNC('month', CURRENT_DATE)
LEFT JOIN traffic_correlation_analysis tca ON cdc.city_id = tca.city_id
),
ranked_markets AS (
SELECT
mds.*,
ROW_NUMBER() OVER (ORDER BY mds.demand_score DESC) AS demand_rank,
ROW_NUMBER() OVER (ORDER BY mds.growth_potential_score DESC) AS growth_rank,
PERCENT_RANK() OVER (ORDER BY mds.demand_score) AS demand_percentile,
PERCENT_RANK() OVER (ORDER BY mds.growth_potential_score) AS growth_percentile,
LAG(mds.demand_score) OVER (ORDER BY mds.demand_score DESC) AS prev_demand_score,
LEAD(mds.demand_score) OVER (ORDER BY mds.demand_score DESC) AS next_demand_score,
AVG(mds.demand_score) OVER () AS overall_avg_demand_score,
STDDEV(mds.demand_score) OVER () AS overall_stddev_demand_score
FROM market_demand_scoring mds
)
SELECT
rm.city_id,
rm.city_name,
rm.state_code,
rm.msa_name,
rm.population,
rm.population_density,
rm.median_household_income,
rm.total_facilities,
rm.total_spaces,
rm.avg_occupancy_rate,
rm.median_occupancy_rate,
rm.p95_occupancy_rate,
rm.avg_daily_traffic,
rm.demand_score,
rm.growth_potential_score,
rm.demand_rank,
rm.growth_rank,
rm.demand_percentile,
rm.growth_percentile,
CASE
WHEN rm.demand_score &gt;= rm.overall_avg_demand_score + rm.overall_stddev_demand_score THEN 'High Priority'
WHEN rm.demand_score &gt;= rm.overall_avg_demand_score THEN 'Medium Priority'
ELSE 'Low Priority'
END AS expansion_priority,
CASE
WHEN rm.demand_rank &lt;= 50 THEN 'Tier 1 Market'
WHEN rm.demand_rank &lt;= 150 THEN 'Tier 2 Market'
ELSE 'Tier 3 Market'
END AS market_tier
FROM ranked_markets rm
ORDER BY rm.demand_score DESC
LIMIT 100;
</p>
</code></pre>
<p>
---
</p>
<h2 id="query-2-competitive-intelligence-analysis-with-pricing-strategy-optimization-and-market-share-calculation-query-2-"></h2>
<strong>Use Case:</strong> <strong>Optimize pricing strategies by analyzing competitor pricing, market share, and pricing elasticity across geographic clusters of parking facilities.</strong>
<strong>Description:</strong> Analyzes competitive parking landscape using multi-level CTEs for market penetration analysis, pricing elasticity calculations, distance-based competitive clustering, and revenue optimization modeling. Identifies pricing gaps and competitive advantages through multi-dimensional analysis.
<strong>Use Case:</strong> Optimize pricing strategies by analyzing competitor pricing, market share, and pricing elasticity across geographic clusters of parking facilities.
<strong>Business Value:</strong> Competitive pricing intelligence report showing optimal pricing strategies, market share opportunities, and revenue maximization recommendations by facility cluster.
<strong>Purpose:</strong> Enables data-driven pricing decisions by identifying competitive gaps and pricing optimization opportunities in local markets.
<strong>Complexity:</strong> Multi-level CTEs for market clustering, complex aggregations with window functions, distance calculations, pricing elasticity modeling, percentile rankings, multi-level joins
<strong>Expected Output:</strong> Competitive analysis by facility cluster with pricing recommendations, market share calculations, and revenue optimization opportunities.
<pre><code class="language-sql">WITH facility_location_clusters AS (
<p>
SELECT
pf.facility_id,
pf.facility_name,
pf.city_id,
pf.latitude,
pf.longitude,
pf.total_spaces,
pf.facility_type,
pf.operator_type,
c.city_name,
c.state_code,
-- Calculate facility density in area
(
SELECT COUNT(*)
FROM parking_facilities pf2
WHERE pf2.city_id = pf.city_id
AND ST_DISTANCE(
ST_POINT(pf.longitude, pf.latitude),
ST_POINT(pf2.longitude, pf2.latitude)
) &lt; 1000
) AS nearby_facilities_count
FROM parking_facilities pf
INNER JOIN cities c ON pf.city_id = c.city_id
WHERE pf.is_hourly_parking = TRUE
),
pricing_analysis AS (
SELECT
pp.pricing_id,
pp.facility_id,
pp.pricing_type,
pp.base_rate_hourly,
pp.base_rate_daily,
pp.base_rate_monthly,
pp.max_daily_rate,
pp.effective_date,
pp.expiration_date,
pp.is_active,
flc.city_id,
flc.city_name,
flc.state_code,
flc.latitude,
flc.longitude,
flc.total_spaces,
flc.facility_type,
flc.nearby_facilities_count,
ROW_NUMBER() OVER (
PARTITION BY pp.facility_id
ORDER BY pp.effective_date DESC
) AS pricing_recency_rank
FROM parking_pricing pp
INNER JOIN facility_location_clusters flc ON pp.facility_id = flc.facility_id
WHERE pp.is_active = TRUE
AND pp.pricing_type = 'Hourly'
),
competitive_clusters AS (
SELECT
pa1.facility_id AS facility_id,
pa1.facility_name,
pa1.city_id,
pa1.city_name,
pa1.state_code,
pa1.base_rate_hourly AS facility_rate,
pa1.total_spaces AS facility_spaces,
pa1.facility_type,
-- Find competitors within 500 meters
ARRAY_AGG(
DISTINCT pa2.facility_id
ORDER BY ST_DISTANCE(
ST_POINT(pa1.longitude, pa1.latitude),
ST_POINT(pa2.longitude, pa2.latitude)
)
) FILTER (
WHERE pa2.facility_id != pa1.facility_id
AND ST_DISTANCE(
ST_POINT(pa1.longitude, pa1.latitude),
ST_POINT(pa2.longitude, pa2.latitude)
) &lt; 500
) AS competitor_facility_ids,
COUNT(DISTINCT pa2.facility_id) FILTER (
WHERE pa2.facility_id != pa1.facility_id
AND ST_DISTANCE(
ST_POINT(pa1.longitude, pa1.latitude),
ST_POINT(pa2.longitude, pa2.latitude)
) &lt; 500
) AS competitor_count,
AVG(pa2.base_rate_hourly) FILTER (
WHERE pa2.facility_id != pa1.facility_id
AND ST_DISTANCE(
ST_POINT(pa1.longitude, pa1.latitude),
ST_POINT(pa2.longitude, pa2.latitude)
) &lt; 500
) AS avg_competitor_rate,
MIN(pa2.base_rate_hourly) FILTER (
WHERE pa2.facility_id != pa1.facility_id
AND ST_DISTANCE(
ST_POINT(pa1.longitude, pa1.latitude),
ST_POINT(pa2.longitude, pa2.latitude)
) &lt; 500
) AS min_competitor_rate,
MAX(pa2.base_rate_hourly) FILTER (
WHERE pa2.facility_id != pa1.facility_id
AND ST_DISTANCE(
ST_POINT(pa1.longitude, pa1.latitude),
ST_POINT(pa2.longitude, pa2.latitude)
) &lt; 500
) AS max_competitor_rate,
PERCENTILE_CONT(0.5) WITHIN GROUP (
ORDER BY pa2.base_rate_hourly
) FILTER (
WHERE pa2.facility_id != pa1.facility_id
AND ST_DISTANCE(
ST_POINT(pa1.longitude, pa1.latitude),
ST_POINT(pa2.longitude, pa2.latitude)
) &lt; 500
) AS median_competitor_rate
FROM pricing_analysis pa1
LEFT JOIN pricing_analysis pa2 ON pa1.city_id = pa2.city_id
AND pa1.pricing_recency_rank = 1
AND pa2.pricing_recency_rank = 1
WHERE pa1.pricing_recency_rank = 1
GROUP BY
pa1.facility_id,
pa1.facility_name,
pa1.city_id,
pa1.city_name,
pa1.state_code,
pa1.base_rate_hourly,
pa1.total_spaces,
pa1.facility_type,
pa1.latitude,
pa1.longitude
),
utilization_by_facility AS (
SELECT
pu.facility_id,
AVG(pu.occupancy_rate) AS avg_occupancy_rate,
PERCENTILE_CONT(0.5) WITHIN GROUP (ORDER BY pu.occupancy_rate) AS median_occupancy_rate,
SUM(pu.revenue_generated) AS total_revenue,
COUNT(*) AS utilization_records_count,
COUNT(DISTINCT pu.utilization_date) AS days_with_data
FROM parking_utilization pu
WHERE pu.utilization_date &gt;= CURRENT_DATE - INTERVAL '30 days'
GROUP BY pu.facility_id
),
market_share_calculation AS (
SELECT
cc.facility_id,
cc.facility_name,
cc.city_id,
cc.city_name,
cc.state_code,
cc.facility_rate,
cc.facility_spaces,
cc.competitor_count,
cc.avg_competitor_rate,
cc.min_competitor_rate,
cc.max_competitor_rate,
cc.median_competitor_rate,
COALESCE(ubf.avg_occupancy_rate, 0) AS avg_occupancy_rate,
COALESCE(ubf.total_revenue, 0) AS total_revenue,
-- Pricing position analysis
CASE
WHEN cc.facility_rate &lt; cc.min_competitor_rate THEN 'Lowest Price'
WHEN cc.facility_rate &gt; cc.max_competitor_rate THEN 'Highest Price'
WHEN cc.facility_rate &lt;= cc.median_competitor_rate THEN 'Below Median'
ELSE 'Above Median'
END AS pricing_position,
-- Price difference from average
cc.facility_rate - COALESCE(cc.avg_competitor_rate, cc.facility_rate) AS price_difference_from_avg,
-- Price difference percentage
CASE
WHEN cc.avg_competitor_rate &gt; 0 THEN
((cc.facility_rate - cc.avg_competitor_rate) / cc.avg_competitor_rate) * 100
ELSE 0
END AS price_difference_pct,
-- Market share estimate (based on spaces and occupancy)
CASE
WHEN cc.competitor_count &gt; 0 THEN
(cc.facility_spaces * COALESCE(ubf.avg_occupancy_rate, 0) / 100.0) /
NULLIF(
(
SELECT SUM(pf2.total_spaces * COALESCE(ubf2.avg_occupancy_rate, 0) / 100.0)
FROM parking_facilities pf2
LEFT JOIN utilization_by_facility ubf2 ON pf2.facility_id = ubf2.facility_id
WHERE pf2.facility_id = ANY(cc.competitor_facility_ids)
OR (
pf2.city_id = cc.city_id
AND ST_DISTANCE(
ST_POINT(
(SELECT latitude FROM parking_facilities WHERE facility_id = cc.facility_id),
(SELECT longitude FROM parking_facilities WHERE facility_id = cc.facility_id)
),
ST_POINT(pf2.longitude, pf2.latitude)
) &lt; 500
)
),
1
) * 100
ELSE 100.0
END AS estimated_market_share_pct
FROM competitive_clusters cc
LEFT JOIN utilization_by_facility ubf ON cc.facility_id = ubf.facility_id
),
pricing_optimization_recommendations AS (
SELECT
msc.*,
-- Optimal pricing recommendation
CASE
WHEN msc.avg_occupancy_rate &gt; 85 AND msc.price_difference_pct &lt; -10 THEN
msc.facility_rate * 1.10  -- Increase price if high demand and underpriced
WHEN msc.avg_occupancy_rate &lt; 50 AND msc.price_difference_pct &gt; 10 THEN
msc.facility_rate * 0.90  -- Decrease price if low demand and overpriced
WHEN msc.price_difference_pct &lt; -20 THEN
msc.avg_competitor_rate * 0.95  -- Price slightly below average if significantly underpriced
WHEN msc.price_difference_pct &gt; 20 THEN
msc.median_competitor_rate  -- Price at median if significantly overpriced
ELSE msc.facility_rate  -- Keep current price
END AS recommended_rate,
-- Revenue impact estimate
(
CASE
WHEN msc.avg_occupancy_rate &gt; 85 AND msc.price_difference_pct &lt; -10 THEN
msc.facility_rate * 1.10 * msc.facility_spaces * msc.avg_occupancy_rate / 100.0
WHEN msc.avg_occupancy_rate &lt; 50 AND msc.price_difference_pct &gt; 10 THEN
msc.facility_rate * 0.90 * msc.facility_spaces * msc.avg_occupancy_rate / 100.0
ELSE msc.total_revenue
END - msc.total_revenue
) AS estimated_revenue_impact,
-- Competitive advantage score
(
CASE WHEN msc.pricing_position = 'Lowest Price' THEN 30 ELSE 0 END +
CASE WHEN msc.estimated_market_share_pct &gt; 30 THEN 25 ELSE msc.estimated_market_share_pct * 0.833 END +
CASE WHEN msc.avg_occupancy_rate &gt; 80 THEN 25 ELSE msc.avg_occupancy_rate * 0.3125 END +
CASE WHEN msc.competitor_count &lt; 3 THEN 20 ELSE GREATEST(20 - msc.competitor_count * 2, 0) END
) AS competitive_advantage_score
FROM market_share_calculation msc
)
SELECT
por.facility_id,
por.facility_name,
por.city_name,
por.state_code,
por.facility_rate AS current_rate,
por.recommended_rate,
por.price_difference_from_avg,
por.price_difference_pct,
por.pricing_position,
por.competitor_count,
por.avg_competitor_rate,
por.median_competitor_rate,
por.avg_occupancy_rate,
por.estimated_market_share_pct,
por.total_revenue,
por.estimated_revenue_impact,
por.competitive_advantage_score,
CASE
WHEN por.estimated_revenue_impact &gt; 1000 THEN 'High Impact'
WHEN por.estimated_revenue_impact &gt; 0 THEN 'Medium Impact'
WHEN por.estimated_revenue_impact &gt; -500 THEN 'Low Impact'
ELSE 'Negative Impact'
END AS optimization_priority
FROM pricing_optimization_recommendations por
WHERE por.competitor_count &gt; 0
ORDER BY por.estimated_revenue_impact DESC
LIMIT 200;
</p>
</code></pre>
<p>
---
</p>
<h2 id="query-3-event-based-parking-demand-forecasting-with-multi-event-correlation-and-revenue-optimization-query-3-"></h2>
<strong>Use Case:</strong> <strong>Predict parking demand and optimize pricing for upcoming events (sports games, concerts, conventions) to maximize revenue and ensure availability.</strong>
<strong>Description:</strong> Forecasts parking demand for events using multi-level CTEs for event pattern analysis, temporal correlation with historical utilization, venue capacity modeling, and dynamic pricing recommendations. Analyzes event types, attendance patterns, and parking multiplier effects.
<strong>Use Case:</strong> Predict parking demand and optimize pricing for upcoming events (sports games, concerts, conventions) to maximize revenue and ensure availability.
<strong>Business Value:</strong> Event parking demand forecast report with pricing recommendations, capacity planning, and revenue optimization strategies for event-based parking operations.
<strong>Purpose:</strong> Enables proactive event parking management by forecasting demand and optimizing pricing strategies based on historical patterns and event characteristics.
<strong>Complexity:</strong> Multi-level CTEs for event pattern analysis, temporal window functions, correlation analysis, demand multiplier calculations, revenue optimization modeling, multi-table joins with aggregations
<strong>Expected Output:</strong> Event parking demand forecasts with pricing recommendations and revenue optimization opportunities.
<pre><code class="language-sql">WITH upcoming_events AS (
<p>
SELECT
e.event_id,
e.event_name,
e.event_type,
e.venue_id,
e.city_id,
e.event_date,
e.event_time,
e.attendance,
e.parking_demand_multiplier,
e.is_recurring,
sv.venue_name,
sv.capacity AS venue_capacity,
sv.parking_spaces_total AS venue_parking_spaces,
c.city_name,
c.state_code,
DATE_PART('dow', e.event_date) AS day_of_week,
DATE_PART('month', e.event_date) AS event_month
FROM events e
INNER JOIN stadiums_venues sv ON e.venue_id = sv.venue_id
INNER JOIN cities c ON e.city_id = c.city_id
WHERE e.event_date &gt;= CURRENT_DATE
AND e.event_date &lt;= CURRENT_DATE + INTERVAL '90 days'
),
historical_event_patterns AS (
SELECT
e.event_type,
DATE_PART('dow', e.event_date) AS day_of_week,
DATE_PART('hour', e.event_time) AS event_hour,
AVG(e.attendance) AS avg_attendance,
AVG(e.parking_demand_multiplier) AS avg_demand_multiplier,
PERCENTILE_CONT(0.75) WITHIN GROUP (ORDER BY e.attendance) AS p75_attendance,
PERCENTILE_CONT(0.95) WITHIN GROUP (ORDER BY e.attendance) AS p95_attendance,
COUNT(*) AS event_count
FROM events e
WHERE e.event_date &lt; CURRENT_DATE
AND e.event_date &gt;= CURRENT_DATE - INTERVAL '365 days'
GROUP BY e.event_type, DATE_PART('dow', e.event_date), DATE_PART('hour', e.event_time)
),
venue_parking_analysis AS (
SELECT
sv.venue_id,
sv.venue_name,
COUNT(DISTINCT pf.facility_id) AS nearby_facilities_count,
SUM(pf.total_spaces) AS total_nearby_spaces,
AVG(
CASE
WHEN ST_DISTANCE(
ST_POINT(sv.longitude, sv.latitude),
ST_POINT(pf.longitude, pf.latitude)
) &lt; 1000 THEN pf.total_spaces
ELSE NULL
END
) AS avg_spaces_per_facility,
AVG(pp.base_rate_hourly) FILTER (
WHERE ST_DISTANCE(
ST_POINT(sv.longitude, sv.latitude),
ST_POINT(pf.longitude, pf.latitude)
) &lt; 1000
) AS avg_nearby_rate
FROM stadiums_venues sv
LEFT JOIN parking_facilities pf ON sv.city_id = pf.city_id
LEFT JOIN parking_pricing pp ON pf.facility_id = pp.facility_id
AND pp.is_active = TRUE
AND pp.pricing_type = 'Hourly'
GROUP BY sv.venue_id, sv.venue_name, sv.latitude, sv.longitude
),
event_demand_forecast AS (
SELECT
ue.event_id,
ue.event_name,
ue.event_type,
ue.venue_id,
ue.venue_name,
ue.city_name,
ue.state_code,
ue.event_date,
ue.event_time,
ue.attendance,
ue.parking_demand_multiplier,
ue.venue_capacity,
ue.venue_parking_spaces,
COALESCE(vpa.nearby_facilities_count, 0) AS nearby_facilities_count,
COALESCE(vpa.total_nearby_spaces, 0) AS total_nearby_spaces,
COALESCE(hep.avg_attendance, ue.attendance) AS forecasted_attendance,
COALESCE(hep.avg_demand_multiplier, ue.parking_demand_multiplier) AS forecasted_multiplier,
COALESCE(hep.p95_attendance, ue.attendance * 1.2) AS p95_forecasted_attendance,
-- Forecasted parking demand
COALESCE(ue.attendance, hep.avg_attendance) *
COALESCE(ue.parking_demand_multiplier, hep.avg_demand_multiplier) AS forecasted_parking_demand,
-- Peak demand (95th percentile)
COALESCE(hep.p95_attendance, ue.attendance * 1.2) *
COALESCE(ue.parking_demand_multiplier, hep.avg_demand_multiplier, 0.8) AS peak_parking_demand,
COALESCE(vpa.avg_nearby_rate, 0) AS avg_nearby_rate
FROM upcoming_events ue
LEFT JOIN historical_event_patterns hep ON ue.event_type = hep.event_type
AND ue.day_of_week = hep.day_of_week
AND DATE_PART('hour', ue.event_time) = hep.event_hour
LEFT JOIN venue_parking_analysis vpa ON ue.venue_id = vpa.venue_id
),
demand_supply_analysis AS (
SELECT
edf.*,
-- Supply vs demand analysis
CASE
WHEN edf.total_nearby_spaces &gt;= edf.peak_parking_demand THEN 'Sufficient Supply'
WHEN edf.total_nearby_spaces &gt;= edf.forecasted_parking_demand * 0.8 THEN 'Adequate Supply'
ELSE 'Insufficient Supply'
END AS supply_status,
-- Capacity utilization forecast
CASE
WHEN edf.total_nearby_spaces &gt; 0 THEN
(edf.forecasted_parking_demand / edf.total_nearby_spaces) * 100
ELSE 100
END AS forecasted_utilization_pct,
-- Peak utilization forecast
CASE
WHEN edf.total_nearby_spaces &gt; 0 THEN
(edf.peak_parking_demand / edf.total_nearby_spaces) * 100
ELSE 100
END AS peak_utilization_pct,
-- Supply gap
GREATEST(edf.peak_parking_demand - edf.total_nearby_spaces, 0) AS supply_gap
FROM event_demand_forecast edf
),
pricing_recommendations AS (
SELECT
dsa.*,
-- Dynamic pricing recommendation based on demand
CASE
WHEN dsa.supply_status = 'Insufficient Supply' THEN
dsa.avg_nearby_rate * 1.30  -- Increase price 30% for high demand
WHEN dsa.peak_utilization_pct &gt; 90 THEN
dsa.avg_nearby_rate * 1.20  -- Increase price 20% for very high utilization
WHEN dsa.forecasted_utilization_pct &gt; 75 THEN
dsa.avg_nearby_rate * 1.10  -- Increase price 10% for high utilization
WHEN dsa.forecasted_utilization_pct &lt; 50 THEN
dsa.avg_nearby_rate * 0.90  -- Decrease price 10% for low utilization
ELSE dsa.avg_nearby_rate  -- Keep current price
END AS recommended_event_rate,
-- Revenue forecast
dsa.forecasted_parking_demand *
CASE
WHEN dsa.supply_status = 'Insufficient Supply' THEN dsa.avg_nearby_rate * 1.30
WHEN dsa.peak_utilization_pct &gt; 90 THEN dsa.avg_nearby_rate * 1.20
WHEN dsa.forecasted_utilization_pct &gt; 75 THEN dsa.avg_nearby_rate * 1.10
WHEN dsa.forecasted_utilization_pct &lt; 50 THEN dsa.avg_nearby_rate * 0.90
ELSE dsa.avg_nearby_rate
END AS forecasted_revenue
FROM demand_supply_analysis dsa
)
SELECT
pr.event_id,
pr.event_name,
pr.event_type,
pr.venue_name,
pr.city_name,
pr.state_code,
pr.event_date,
pr.event_time,
pr.forecasted_attendance,
pr.forecasted_parking_demand,
pr.peak_parking_demand,
pr.total_nearby_spaces,
pr.supply_status,
pr.forecasted_utilization_pct,
pr.peak_utilization_pct,
pr.supply_gap,
pr.avg_nearby_rate AS current_avg_rate,
pr.recommended_event_rate,
pr.forecasted_revenue,
CASE
WHEN pr.supply_gap &gt; 100 THEN 'High Priority - Add Facilities'
WHEN pr.supply_gap &gt; 50 THEN 'Medium Priority - Monitor Closely'
ELSE 'Low Priority'
END AS action_priority
FROM pricing_recommendations pr
ORDER BY pr.forecasted_revenue DESC, pr.event_date
LIMIT 100;
</p>
</code></pre>
<p>
---
</p>
<h2 id="query-4-airport-parking-revenue-optimization-with-passenger-volume-correlation-and-seasonal-pattern-analysis-query-4-"></h2>
<strong>Use Case:</strong> <strong>Optimize airport parking revenue by analyzing passenger volume correlations, seasonal patterns, and pricing strategies across different airport facilities.</strong>
<strong>Description:</strong> Analyzes airport parking performance using multi-level CTEs, passenger volume correlations, seasonal pattern detection with window functions, pricing elasticity modeling, and revenue optimization across airport facilities.
<strong>Use Case:</strong> Optimize airport parking revenue by analyzing passenger volume correlations, seasonal patterns, and pricing strategies across different airport facilities.
<strong>Business Value:</strong> Airport parking revenue optimization report with seasonal pricing recommendations, capacity utilization analysis, and passenger volume correlation insights.
<strong>Purpose:</strong> Maximizes airport parking revenue through data-driven pricing and capacity optimization based on passenger patterns and seasonal trends.
<strong>Complexity:</strong> Multi-level CTEs (6+ levels), temporal window functions with seasonal patterns, correlation analysis, revenue optimization modeling, percentile calculations, multi-table joins
<strong>Expected Output:</strong> Airport parking revenue optimization recommendations with seasonal pricing strategies and capacity utilization insights.
<pre><code class="language-sql">WITH airport_passenger_volumes AS (
<p>
SELECT
a.airport_id,
a.airport_name,
a.city_id,
a.annual_passengers,
a.parking_spaces_total,
a.parking_facilities_count,
c.city_name,
c.state_code,
DATE_PART('month', CURRENT_DATE) AS current_month,
-- Estimate monthly passengers (annual / 12 with seasonal adjustment)
a.annual_passengers / 12.0 AS base_monthly_passengers
FROM airports a
INNER JOIN cities c ON a.city_id = c.city_id
WHERE a.annual_passengers &gt; 1000000
),
airport_parking_facilities AS (
SELECT
pf.facility_id,
pf.facility_name,
pf.airport_id,
pf.total_spaces,
pf.facility_type,
pf.operator_type,
pf.is_long_term_parking,
pf.is_short_term_parking,
pf.is_valet_available,
pp.base_rate_hourly,
pp.base_rate_daily,
pp.max_daily_rate,
a.airport_name,
a.annual_passengers
FROM parking_facilities pf
INNER JOIN airports a ON pf.airport_id = a.airport_id
LEFT JOIN parking_pricing pp ON pf.facility_id = pp.facility_id
AND pp.is_active = TRUE
AND pp.pricing_type IN ('Hourly', 'Daily')
WHERE pf.airport_id IS NOT NULL
),
monthly_utilization_patterns AS (
SELECT
pu.facility_id,
pf.airport_id,
DATE_PART('month', pu.utilization_date) AS utilization_month,
DATE_PART('dow', pu.utilization_date) AS day_of_week,
AVG(pu.occupancy_rate) AS avg_occupancy_rate,
PERCENTILE_CONT(0.5) WITHIN GROUP (ORDER BY pu.occupancy_rate) AS median_occupancy_rate,
PERCENTILE_CONT(0.95) WITHIN GROUP (ORDER BY pu.occupancy_rate) AS p95_occupancy_rate,
SUM(pu.revenue_generated) AS total_revenue,
AVG(pu.revenue_generated) AS avg_revenue_per_record,
COUNT(*) AS utilization_records
FROM parking_utilization pu
INNER JOIN parking_facilities pf ON pu.facility_id = pf.facility_id
WHERE pf.airport_id IS NOT NULL
AND pu.utilization_date &gt;= CURRENT_DATE - INTERVAL '365 days'
GROUP BY pu.facility_id, pf.airport_id, DATE_PART('month', pu.utilization_date), DATE_PART('dow', pu.utilization_date)
),
seasonal_pattern_analysis AS (
SELECT
apf.airport_id,
apf.airport_name,
apf.annual_passengers,
mup.utilization_month,
mup.day_of_week,
COUNT(DISTINCT mup.facility_id) AS facilities_count,
AVG(mup.avg_occupancy_rate) AS avg_occupancy_rate,
PERCENTILE_CONT(0.5) WITHIN GROUP (ORDER BY mup.avg_occupancy_rate) AS median_occupancy_rate,
PERCENTILE_CONT(0.75) WITHIN GROUP (ORDER BY mup.avg_occupancy_rate) AS p75_occupancy_rate,
SUM(mup.total_revenue) AS total_revenue,
AVG(mup.avg_revenue_per_record) AS avg_revenue_per_record,
-- Seasonal multiplier (compared to annual average)
AVG(mup.avg_occupancy_rate) / NULLIF(
(SELECT AVG(avg_occupancy_rate) FROM monthly_utilization_patterns mup2
INNER JOIN parking_facilities pf2 ON mup2.facility_id = pf2.facility_id
WHERE pf2.airport_id = apf.airport_id),
1
) AS seasonal_multiplier
FROM airport_parking_facilities apf
INNER JOIN monthly_utilization_patterns mup ON apf.facility_id = mup.facility_id
GROUP BY apf.airport_id, apf.airport_name, apf.annual_passengers, mup.utilization_month, mup.day_of_week
),
passenger_correlation_analysis AS (
SELECT
spa.airport_id,
spa.airport_name,
spa.annual_passengers,
apv.base_monthly_passengers,
spa.utilization_month,
spa.avg_occupancy_rate,
spa.total_revenue,
spa.seasonal_multiplier,
-- Correlation between passenger volume and parking utilization
CASE
WHEN spa.utilization_month IN (6, 7, 8, 12) THEN 1.15  -- Summer and holiday months
WHEN spa.utilization_month IN (3, 4, 5, 9, 10) THEN 1.05  -- Spring and fall
ELSE 0.95  -- Winter months (excluding December)
END AS passenger_seasonal_factor,
-- Revenue per passenger estimate
CASE
WHEN apv.base_monthly_passengers &gt; 0 THEN
spa.total_revenue / (apv.base_monthly_passengers * spa.seasonal_multiplier)
ELSE 0
END AS revenue_per_passenger
FROM seasonal_pattern_analysis spa
INNER JOIN airport_passenger_volumes apv ON spa.airport_id = apv.airport_id
),
revenue_optimization AS (
SELECT
pca.*,
apf.facility_id,
apf.facility_name,
apf.facility_type,
apf.total_spaces,
apf.base_rate_hourly,
apf.base_rate_daily,
apf.max_daily_rate,
-- Optimal pricing recommendation
CASE
WHEN pca.seasonal_multiplier &gt; 1.2 THEN
apf.base_rate_daily * 1.25  -- Increase price 25% for peak season
WHEN pca.seasonal_multiplier &gt; 1.1 THEN
apf.base_rate_daily * 1.15  -- Increase price 15% for high season
WHEN pca.seasonal_multiplier &lt; 0.9 THEN
apf.base_rate_daily * 0.90  -- Decrease price 10% for low season
ELSE apf.base_rate_daily  -- Keep current price
END AS recommended_seasonal_rate,
-- Revenue impact estimate
(
CASE
WHEN pca.seasonal_multiplier &gt; 1.2 THEN apf.base_rate_daily * 1.25
WHEN pca.seasonal_multiplier &gt; 1.1 THEN apf.base_rate_daily * 1.15
WHEN pca.seasonal_multiplier &lt; 0.9 THEN apf.base_rate_daily * 0.90
ELSE apf.base_rate_daily
END - apf.base_rate_daily
) * apf.total_spaces * pca.avg_occupancy_rate / 100.0 AS estimated_revenue_impact
FROM passenger_correlation_analysis pca
INNER JOIN airport_parking_facilities apf ON pca.airport_id = apf.airport_id
)
SELECT
ro.airport_id,
ro.airport_name,
ro.city_name,
ro.state_code,
ro.annual_passengers,
ro.utilization_month,
ro.facility_id,
ro.facility_name,
ro.facility_type,
ro.total_spaces,
ro.avg_occupancy_rate,
ro.seasonal_multiplier,
ro.passenger_seasonal_factor,
ro.revenue_per_passenger,
ro.base_rate_daily AS current_rate,
ro.recommended_seasonal_rate,
ro.estimated_revenue_impact,
CASE
WHEN ro.seasonal_multiplier &gt; 1.2 THEN 'Peak Season'
WHEN ro.seasonal_multiplier &gt; 1.1 THEN 'High Season'
WHEN ro.seasonal_multiplier &lt; 0.9 THEN 'Low Season'
ELSE 'Normal Season'
END AS season_category
FROM revenue_optimization ro
ORDER BY ro.annual_passengers DESC, ro.estimated_revenue_impact DESC
LIMIT 200;
</p>
</code></pre>
<p>
---
</p>
<h2 id="query-5-traffic-volume-correlation-analysis-with-parking-demand-forecasting-and-revenue-impact-modeling-query-5-"></h2>
<strong>Use Case:</strong> <strong>Predict parking demand based on traffic patterns and optimize facility locations near high-traffic corridors to maximize utilization and revenue.</strong>
<strong>Description:</strong> Correlates traffic volume patterns with parking utilization using multi-level CTEs, temporal alignment analysis, lag correlation calculations, and demand forecasting models. Identifies traffic patterns that predict parking demand and optimizes facility placement.
<strong>Use Case:</strong> Predict parking demand based on traffic patterns and optimize facility locations near high-traffic corridors to maximize utilization and revenue.
<strong>Business Value:</strong> Traffic-parking correlation report with demand forecasting, optimal facility placement recommendations, and revenue impact analysis for strategic facility development.
<strong>Purpose:</strong> Enables data-driven facility placement decisions by correlating traffic patterns with parking demand patterns.
<strong>Complexity:</strong> Multi-level CTEs (7+ levels), temporal correlation analysis, lag functions, demand forecasting models, spatial proximity calculations, revenue impact modeling
<strong>Expected Output:</strong> Traffic-parking correlation analysis with demand forecasts and facility placement recommendations.
<pre><code class="language-sql">WITH traffic_monitoring_locations AS (
<p>
SELECT
tv.location_id,
tv.city_id,
tv.latitude,
tv.longitude,
tv.road_name,
tv.road_type,
tv.annual_average_daily_traffic,
tv.peak_hour_volume,
tv.direction,
tv.data_year,
c.city_name,
c.state_code,
ST_POINT(tv.longitude, tv.latitude) AS traffic_point
FROM traffic_volume_data tv
INNER JOIN cities c ON tv.city_id = c.city_id
WHERE tv.data_year = EXTRACT(YEAR FROM CURRENT_DATE)
),
nearby_parking_facilities AS (
SELECT
tml.location_id,
tml.city_id,
tml.annual_average_daily_traffic,
tml.peak_hour_volume,
pf.facility_id,
pf.facility_name,
pf.total_spaces,
pf.latitude,
pf.longitude,
ST_DISTANCE(
tml.traffic_point,
ST_POINT(pf.longitude, pf.latitude)
) AS distance_meters,
ST_POINT(pf.longitude, pf.latitude) AS facility_point
FROM traffic_monitoring_locations tml
INNER JOIN parking_facilities pf ON tml.city_id = pf.city_id
WHERE ST_DISTANCE(
tml.traffic_point,
ST_POINT(pf.longitude, pf.latitude)
) &lt; 500  -- Within 500 meters
),
hourly_utilization_by_facility AS (
SELECT
pu.facility_id,
pu.utilization_date,
pu.utilization_hour,
AVG(pu.occupancy_rate) AS avg_occupancy_rate,
SUM(pu.revenue_generated) AS total_revenue,
COUNT(*) AS record_count
FROM parking_utilization pu
WHERE pu.utilization_date &gt;= CURRENT_DATE - INTERVAL '90 days'
GROUP BY pu.facility_id, pu.utilization_date, pu.utilization_hour
),
traffic_parking_correlation AS (
SELECT
npf.location_id,
npf.city_id,
npf.annual_average_daily_traffic,
npf.peak_hour_volume,
npf.facility_id,
npf.facility_name,
npf.total_spaces,
npf.distance_meters,
hubf.utilization_hour,
AVG(hubf.avg_occupancy_rate) AS avg_occupancy_rate,
PERCENTILE_CONT(0.5) WITHIN GROUP (ORDER BY hubf.avg_occupancy_rate) AS median_occupancy_rate,
PERCENTILE_CONT(0.95) WITHIN GROUP (ORDER BY hubf.avg_occupancy_rate) AS p95_occupancy_rate,
SUM(hubf.total_revenue) AS total_revenue,
COUNT(DISTINCT hubf.utilization_date) AS days_with_data,
-- Correlation coefficient approximation
(
AVG(hubf.avg_occupancy_rate * npf.peak_hour_volume) -
AVG(hubf.avg_occupancy_rate) * AVG(npf.peak_hour_volume)
) / NULLIF(
SQRT(
(AVG(hubf.avg_occupancy_rate * hubf.avg_occupancy_rate) - AVG(hubf.avg_occupancy_rate) * AVG(hubf.avg_occupancy_rate)) *
(AVG(npf.peak_hour_volume * npf.peak_hour_volume) - AVG(npf.peak_hour_volume) * AVG(npf.peak_hour_volume))
),
0
) AS correlation_coefficient
FROM nearby_parking_facilities npf
INNER JOIN hourly_utilization_by_facility hubf ON npf.facility_id = hubf.facility_id
GROUP BY npf.location_id, npf.city_id, npf.annual_average_daily_traffic, npf.peak_hour_volume,
npf.facility_id, npf.facility_name, npf.total_spaces, npf.distance_meters, hubf.utilization_hour
),
demand_forecasting_model AS (
SELECT
tpc.*,
-- Forecasted occupancy based on traffic
CASE
WHEN tpc.correlation_coefficient &gt; 0.7 THEN
LEAST(tpc.avg_occupancy_rate * (1 + (tpc.peak_hour_volume / 10000.0) * 0.1), 100)
WHEN tpc.correlation_coefficient &gt; 0.5 THEN
LEAST(tpc.avg_occupancy_rate * (1 + (tpc.peak_hour_volume / 10000.0) * 0.05), 100)
ELSE tpc.avg_occupancy_rate
END AS forecasted_occupancy_rate,
-- Revenue forecast
tpc.total_revenue *
CASE
WHEN tpc.correlation_coefficient &gt; 0.7 THEN 1.15
WHEN tpc.correlation_coefficient &gt; 0.5 THEN 1.08
ELSE 1.0
END AS forecasted_revenue
FROM traffic_parking_correlation tpc
)
SELECT
dfm.location_id,
dfm.city_id,
dfm.facility_id,
dfm.facility_name,
dfm.annual_average_daily_traffic,
dfm.peak_hour_volume,
dfm.utilization_hour,
dfm.distance_meters,
dfm.avg_occupancy_rate,
dfm.median_occupancy_rate,
dfm.p95_occupancy_rate,
dfm.correlation_coefficient,
dfm.forecasted_occupancy_rate,
dfm.total_revenue,
dfm.forecasted_revenue,
CASE
WHEN dfm.correlation_coefficient &gt; 0.7 THEN 'Strong Correlation'
WHEN dfm.correlation_coefficient &gt; 0.5 THEN 'Moderate Correlation'
WHEN dfm.correlation_coefficient &gt; 0.3 THEN 'Weak Correlation'
ELSE 'No Significant Correlation'
END AS correlation_strength
FROM demand_forecasting_model dfm
WHERE dfm.correlation_coefficient &gt; 0.3
ORDER BY dfm.correlation_coefficient DESC, dfm.forecasted_revenue DESC
LIMIT 300;
</p>
</code></pre>
<p>
---
</p>
<h2 id="query-6-demographic-targeting-analysis-with-income-based-pricing-optimization-and-market-penetration-modeling-query-6-"></h2>
<strong>Use Case:</strong> <strong>Optimize pricing and marketing strategies by targeting specific demographic segments based on income, age, and employment patterns.</strong>
<strong>Description:</strong> Analyzes parking demand by demographic segments using multi-level CTEs, income correlation analysis, age-based pattern detection, employment correlation, and demographic targeting optimization. Identifies optimal pricing strategies for different demographic segments.
<strong>Use Case:</strong> Optimize pricing and marketing strategies by targeting specific demographic segments based on income, age, and employment patterns.
<strong>Business Value:</strong> Demographic targeting report with segment-specific pricing recommendations, market penetration analysis, and revenue optimization by demographic cohort.
<strong>Purpose:</strong> Enables targeted marketing and pricing strategies by understanding demographic preferences and parking behavior patterns.
<strong>Complexity:</strong> Multi-level CTEs (6+ levels), demographic segmentation, correlation analysis, market penetration calculations, revenue optimization modeling, percentile rankings
<strong>Expected Output:</strong> Demographic targeting analysis with segment-specific pricing and marketing recommendations.
<pre><code class="language-sql">WITH demographic_segments AS (
<p>
SELECT
c.city_id,
c.city_name,
c.state_code,
c.population,
c.median_household_income,
c.median_age,
c.employment_total,
c.unemployment_rate,
CASE
WHEN c.median_household_income &gt; 75000 THEN 'High Income'
WHEN c.median_household_income &gt; 50000 THEN 'Medium Income'
ELSE 'Low Income'
END AS income_segment,
CASE
WHEN c.median_age &gt; 45 THEN 'Older Demographics'
WHEN c.median_age &gt; 35 THEN 'Middle Age'
ELSE 'Younger Demographics'
END AS age_segment,
CASE
WHEN c.unemployment_rate &lt; 4 THEN 'Low Unemployment'
WHEN c.unemployment_rate &lt; 7 THEN 'Medium Unemployment'
ELSE 'High Unemployment'
END AS employment_segment
FROM cities c
WHERE c.population &gt; 50000
),
facility_pricing_by_city AS (
SELECT
pf.city_id,
AVG(pp.base_rate_hourly) AS avg_hourly_rate,
AVG(pp.base_rate_daily) AS avg_daily_rate,
PERCENTILE_CONT(0.5) WITHIN GROUP (ORDER BY pp.base_rate_hourly) AS median_hourly_rate,
PERCENTILE_CONT(0.75) WITHIN GROUP (ORDER BY pp.base_rate_hourly) AS p75_hourly_rate,
COUNT(DISTINCT pf.facility_id) AS facility_count
FROM parking_facilities pf
INNER JOIN parking_pricing pp ON pf.facility_id = pp.facility_id
WHERE pp.is_active = TRUE
GROUP BY pf.city_id
),
utilization_by_demographic AS (
SELECT
pf.city_id,
AVG(pu.occupancy_rate) AS avg_occupancy_rate,
PERCENTILE_CONT(0.5) WITHIN GROUP (ORDER BY pu.occupancy_rate) AS median_occupancy_rate,
SUM(pu.revenue_generated) AS total_revenue,
AVG(pu.revenue_generated) AS avg_revenue_per_record,
COUNT(*) AS utilization_records
FROM parking_utilization pu
INNER JOIN parking_facilities pf ON pu.facility_id = pf.facility_id
WHERE pu.utilization_date &gt;= CURRENT_DATE - INTERVAL '90 days'
GROUP BY pf.city_id
),
demographic_correlation AS (
SELECT
ds.*,
COALESCE(fpc.avg_hourly_rate, 0) AS avg_hourly_rate,
COALESCE(fpc.median_hourly_rate, 0) AS median_hourly_rate,
COALESCE(fpc.p75_hourly_rate, 0) AS p75_hourly_rate,
COALESCE(fpc.facility_count, 0) AS facility_count,
COALESCE(ubd.avg_occupancy_rate, 0) AS avg_occupancy_rate,
COALESCE(ubd.median_occupancy_rate, 0) AS median_occupancy_rate,
COALESCE(ubd.total_revenue, 0) AS total_revenue,
COALESCE(ubd.avg_revenue_per_record, 0) AS avg_revenue_per_record,
-- Revenue per capita
CASE
WHEN ds.population &gt; 0 THEN
COALESCE(ubd.total_revenue, 0) / ds.population
ELSE 0
END AS revenue_per_capita,
-- Price sensitivity index
CASE
WHEN ds.median_household_income &gt; 0 THEN
COALESCE(fpc.avg_hourly_rate, 0) / (ds.median_household_income / 2000.0)
ELSE 0
END AS price_sensitivity_index
FROM demographic_segments ds
LEFT JOIN facility_pricing_by_city fpc ON ds.city_id = fpc.city_id
LEFT JOIN utilization_by_demographic ubd ON ds.city_id = ubd.city_id
),
segment_optimization AS (
SELECT
dc.*,
-- Optimal pricing by segment
CASE
WHEN dc.income_segment = 'High Income' AND dc.avg_occupancy_rate &gt; 70 THEN
dc.avg_hourly_rate * 1.15  -- Can charge more for high income, high demand
WHEN dc.income_segment = 'High Income' AND dc.avg_occupancy_rate &lt; 50 THEN
dc.avg_hourly_rate * 0.95  -- Slight discount for high income, low demand
WHEN dc.income_segment = 'Low Income' AND dc.avg_occupancy_rate &lt; 50 THEN
dc.avg_hourly_rate * 0.85  -- Discount for low income, low demand
ELSE dc.avg_hourly_rate
END AS recommended_hourly_rate,
-- Market penetration score
(
CASE WHEN dc.facility_count &gt; 50 THEN 25 ELSE dc.facility_count * 0.5 END +
CASE WHEN dc.avg_occupancy_rate &gt; 75 THEN 25 ELSE dc.avg_occupancy_rate * 0.333 END +
CASE WHEN dc.revenue_per_capita &gt; 10 THEN 25 ELSE dc.revenue_per_capita * 2.5 END +
CASE WHEN dc.price_sensitivity_index &lt; 0.05 THEN 25 ELSE GREATEST(25 - dc.price_sensitivity_index * 500, 0) END
) AS market_penetration_score
FROM demographic_correlation dc
)
SELECT
so.city_id,
so.city_name,
so.state_code,
so.income_segment,
so.age_segment,
so.employment_segment,
so.population,
so.median_household_income,
so.median_age,
so.facility_count,
so.avg_occupancy_rate,
so.avg_hourly_rate AS current_rate,
so.recommended_hourly_rate,
so.total_revenue,
so.revenue_per_capita,
so.price_sensitivity_index,
so.market_penetration_score,
CASE
WHEN so.market_penetration_score &gt; 75 THEN 'High Penetration'
WHEN so.market_penetration_score &gt; 50 THEN 'Medium Penetration'
ELSE 'Low Penetration'
END AS penetration_category
FROM segment_optimization so
ORDER BY so.market_penetration_score DESC, so.total_revenue DESC
LIMIT 200;
</p>
</code></pre>
<p>
---
</p>
<h2 id="query-7-market-segmentation-analysis-with-multi-dimensional-clustering-and-revenue-optimization-query-7-"></h2>
<strong>Use Case:</strong> <strong>Identify distinct market segments for targeted marketing campaigns and segment-specific pricing strategies based on demographic, economic, and utilization characteristics.</strong>
<strong>Description:</strong> Segments parking markets using multi-dimensional clustering analysis with multi-level CTEs, K-means-like grouping algorithms, revenue potential scoring, segment-specific optimization strategies, and demographic-economic correlation analysis.
<strong>Use Case:</strong> Identify distinct market segments for targeted marketing campaigns and segment-specific pricing strategies based on demographic, economic, and utilization characteristics.
<strong>Business Value:</strong> Market segmentation report with segment profiles, revenue potential scores, optimization recommendations, and targeted marketing strategies for each segment.
<strong>Purpose:</strong> Enables targeted marketing and pricing by identifying homogeneous market segments with similar characteristics and behaviors.
<strong>Complexity:</strong> Multi-level CTEs (7+ levels), clustering algorithms, multi-dimensional distance calculations, revenue optimization modeling, segment profiling, percentile rankings
<strong>Expected Output:</strong> Market segments with characteristics, revenue potential, and optimization recommendations.
<pre><code class="language-sql">WITH city_characteristics AS (
<p>
SELECT
c.city_id,
c.city_name,
c.state_code,
c.population,
c.population_density,
c.median_household_income,
c.median_age,
c.employment_total,
c.unemployment_rate,
ma.msa_name,
ma.gdp_billions,
COUNT(DISTINCT pf.facility_id) AS facility_count,
SUM(pf.total_spaces) AS total_spaces,
AVG(pp.base_rate_hourly) AS avg_hourly_rate
FROM cities c
INNER JOIN metropolitan_areas ma ON c.msa_id = ma.msa_id
LEFT JOIN parking_facilities pf ON c.city_id = pf.city_id
LEFT JOIN parking_pricing pp ON pf.facility_id = pp.facility_id AND pp.is_active = TRUE
GROUP BY c.city_id, c.city_name, c.state_code, c.population, c.population_density,
c.median_household_income, c.median_age, c.employment_total, c.unemployment_rate,
ma.msa_name, ma.gdp_billions
),
utilization_metrics AS (
SELECT
pf.city_id,
AVG(pu.occupancy_rate) AS avg_occupancy_rate,
PERCENTILE_CONT(0.5) WITHIN GROUP (ORDER BY pu.occupancy_rate) AS median_occupancy_rate,
PERCENTILE_CONT(0.95) WITHIN GROUP (ORDER BY pu.occupancy_rate) AS p95_occupancy_rate,
SUM(pu.revenue_generated) AS total_revenue,
COUNT(*) AS utilization_records
FROM parking_utilization pu
INNER JOIN parking_facilities pf ON pu.facility_id = pf.facility_id
WHERE pu.utilization_date &gt;= CURRENT_DATE - INTERVAL '90 days'
GROUP BY pf.city_id
),
normalized_characteristics AS (
SELECT
cc.*,
COALESCE(um.avg_occupancy_rate, 0) AS avg_occupancy_rate,
COALESCE(um.total_revenue, 0) AS total_revenue,
-- Normalized features for clustering (0-1 scale)
(cc.population_density - MIN(cc.population_density) OVER ()) /
NULLIF(MAX(cc.population_density) OVER () - MIN(cc.population_density) OVER (), 0) AS norm_density,
(cc.median_household_income - MIN(cc.median_household_income) OVER ()) /
NULLIF(MAX(cc.median_household_income) OVER () - MIN(cc.median_household_income) OVER (), 0) AS norm_income,
(COALESCE(um.avg_occupancy_rate, 0) - MIN(COALESCE(um.avg_occupancy_rate, 0)) OVER ()) /
NULLIF(MAX(COALESCE(um.avg_occupancy_rate, 0)) OVER () - MIN(COALESCE(um.avg_occupancy_rate, 0)) OVER (), 0) AS norm_occupancy,
(cc.facility_count - MIN(cc.facility_count) OVER ()) /
NULLIF(MAX(cc.facility_count) OVER () - MIN(cc.facility_count) OVER (), 0) AS norm_facilities
FROM city_characteristics cc
LEFT JOIN utilization_metrics um ON cc.city_id = um.city_id
),
segment_assignment AS (
SELECT
nc.*,
-- Simple segmentation based on normalized characteristics
CASE
WHEN nc.norm_density &gt; 0.7 AND nc.norm_income &gt; 0.7 AND nc.norm_occupancy &gt; 0.7 THEN 'Premium Urban'
WHEN nc.norm_density &gt; 0.5 AND nc.norm_income &gt; 0.5 THEN 'Urban Professional'
WHEN nc.norm_density &gt; 0.3 AND nc.norm_income &lt; 0.5 THEN 'Urban Value'
WHEN nc.norm_density &lt; 0.3 AND nc.norm_income &gt; 0.7 THEN 'Suburban Premium'
WHEN nc.norm_density &lt; 0.3 AND nc.norm_income &gt; 0.5 THEN 'Suburban Standard'
ELSE 'Emerging Market'
END AS market_segment,
-- Revenue potential score
(
nc.norm_density * 0.25 +
nc.norm_income * 0.25 +
nc.norm_occupancy * 0.30 +
nc.norm_facilities * 0.20
) * 100 AS revenue_potential_score
FROM normalized_characteristics nc
),
segment_profiles AS (
SELECT
sa.market_segment,
COUNT(*) AS city_count,
AVG(sa.population) AS avg_population,
AVG(sa.population_density) AS avg_density,
AVG(sa.median_household_income) AS avg_income,
AVG(sa.avg_occupancy_rate) AS avg_occupancy_rate,
AVG(sa.total_revenue) AS avg_revenue,
AVG(sa.facility_count) AS avg_facility_count,
AVG(sa.avg_hourly_rate) AS avg_hourly_rate,
AVG(sa.revenue_potential_score) AS avg_revenue_potential,
PERCENTILE_CONT(0.5) WITHIN GROUP (ORDER BY sa.revenue_potential_score) AS median_revenue_potential
FROM segment_assignment sa
GROUP BY sa.market_segment
),
segment_optimization AS (
SELECT
sa.*,
sp.avg_revenue_potential,
sp.median_revenue_potential,
-- Segment-specific pricing recommendation
CASE
WHEN sa.market_segment = 'Premium Urban' THEN sa.avg_hourly_rate * 1.20
WHEN sa.market_segment = 'Urban Professional' THEN sa.avg_hourly_rate * 1.10
WHEN sa.market_segment = 'Urban Value' THEN sa.avg_hourly_rate * 0.95
WHEN sa.market_segment = 'Suburban Premium' THEN sa.avg_hourly_rate * 1.05
WHEN sa.market_segment = 'Suburban Standard' THEN sa.avg_hourly_rate * 1.00
ELSE sa.avg_hourly_rate * 0.90
END AS recommended_segment_rate,
-- Growth opportunity score
CASE
WHEN sa.revenue_potential_score &gt; sp.avg_revenue_potential * 1.2 THEN 'High Growth'
WHEN sa.revenue_potential_score &gt; sp.avg_revenue_potential THEN 'Medium Growth'
ELSE 'Low Growth'
END AS growth_opportunity
FROM segment_assignment sa
INNER JOIN segment_profiles sp ON sa.market_segment = sp.market_segment
)
SELECT
so.city_id,
so.city_name,
so.state_code,
so.market_segment,
so.population,
so.population_density,
so.median_household_income,
so.facility_count,
so.avg_occupancy_rate,
so.total_revenue,
so.revenue_potential_score,
so.avg_hourly_rate AS current_rate,
so.recommended_segment_rate,
so.growth_opportunity,
ROW_NUMBER() OVER (PARTITION BY so.market_segment ORDER BY so.revenue_potential_score DESC) AS segment_rank
FROM segment_optimization so
ORDER BY so.revenue_potential_score DESC
LIMIT 300;
</p>
</code></pre>
<p>
---
</p>
<h2 id="query-8-utilization-pattern-analysis-with-temporal-decomposition-and-anomaly-detection-query-8-"></h2>
<strong>Use Case:</strong> <strong>Identify utilization patterns, seasonal trends, and anomalies for capacity planning, pricing optimization, and operational efficiency improvements.</strong>
<strong>Description:</strong> Analyzes parking utilization patterns using time-series decomposition CTEs, seasonal trend analysis with window functions, anomaly detection algorithms using statistical methods, and pattern classification for capacity planning.
<strong>Use Case:</strong> Identify utilization patterns, seasonal trends, and anomalies for capacity planning, pricing optimization, and operational efficiency improvements.
<strong>Business Value:</strong> Utilization pattern report with trend analysis, anomaly alerts, capacity planning recommendations, and operational optimization strategies.
<strong>Purpose:</strong> Enables data-driven capacity planning and operational optimization by identifying patterns and anomalies in parking utilization data.
<strong>Complexity:</strong> Time-series CTEs (6+ levels), decomposition analysis, statistical anomaly detection, pattern classification, moving averages, seasonal decomposition
<strong>Expected Output:</strong> Utilization patterns with trend analysis, anomaly flags, and capacity planning recommendations.
<pre><code class="language-sql">WITH hourly_utilization_base AS (
<p>
SELECT
pu.facility_id,
pu.utilization_date,
pu.utilization_hour,
pu.occupancy_rate,
pu.revenue_generated,
DATE_PART('dow', pu.utilization_date) AS day_of_week,
DATE_PART('month', pu.utilization_date) AS month_num,
pf.city_id,
pf.facility_type
FROM parking_utilization pu
INNER JOIN parking_facilities pf ON pu.facility_id = pf.facility_id
WHERE pu.utilization_date &gt;= CURRENT_DATE - INTERVAL '365 days'
),
temporal_aggregations AS (
SELECT
hub.facility_id,
hub.utilization_hour,
hub.day_of_week,
hub.month_num,
AVG(hub.occupancy_rate) AS avg_occupancy_rate,
PERCENTILE_CONT(0.5) WITHIN GROUP (ORDER BY hub.occupancy_rate) AS median_occupancy_rate,
STDDEV(hub.occupancy_rate) AS stddev_occupancy_rate,
COUNT(*) AS record_count,
AVG(hub.revenue_generated) AS avg_revenue
FROM hourly_utilization_base hub
GROUP BY hub.facility_id, hub.utilization_hour, hub.day_of_week, hub.month_num
),
moving_averages AS (
SELECT
ta.*,
AVG(ta.avg_occupancy_rate) OVER (
PARTITION BY ta.facility_id, ta.utilization_hour
ORDER BY ta.month_num
ROWS BETWEEN 2 PRECEDING AND 2 FOLLOWING
) AS ma_5_month,
AVG(ta.avg_occupancy_rate) OVER (
PARTITION BY ta.facility_id
ORDER BY ta.month_num
ROWS BETWEEN 5 PRECEDING AND CURRENT ROW
) AS ma_6_month
FROM temporal_aggregations ta
),
seasonal_decomposition AS (
SELECT
ma.*,
ma.avg_occupancy_rate - ma.ma_6_month AS seasonal_component,
ma.ma_6_month AS trend_component,
ma.avg_occupancy_rate - ma.ma_5_month AS residual_component,
CASE
WHEN ma.month_num IN (6, 7, 8) THEN 'Summer'
WHEN ma.month_num IN (12, 1, 2) THEN 'Winter'
WHEN ma.month_num IN (3, 4, 5) THEN 'Spring'
ELSE 'Fall'
END AS season
FROM moving_averages ma
),
anomaly_detection AS (
SELECT
sd.*,
CASE
WHEN ABS(sd.residual_component) &gt; sd.stddev_occupancy_rate * 2 THEN TRUE
ELSE FALSE
END AS is_anomaly,
CASE
WHEN sd.avg_occupancy_rate &gt; sd.ma_5_month + sd.stddev_occupancy_rate * 1.5 THEN 'High Anomaly'
WHEN sd.avg_occupancy_rate &lt; sd.ma_5_month - sd.stddev_occupancy_rate * 1.5 THEN 'Low Anomaly'
ELSE 'Normal'
END AS anomaly_type
FROM seasonal_decomposition sd
)
SELECT
ad.facility_id,
pf.facility_name,
pf.city_id,
c.city_name,
ad.utilization_hour,
ad.day_of_week,
ad.month_num,
ad.season,
ad.avg_occupancy_rate,
ad.median_occupancy_rate,
ad.trend_component,
ad.seasonal_component,
ad.residual_component,
ad.is_anomaly,
ad.anomaly_type,
ad.avg_revenue,
CASE
WHEN ad.trend_component &gt; 10 THEN 'Increasing Trend'
WHEN ad.trend_component &lt; -10 THEN 'Decreasing Trend'
ELSE 'Stable Trend'
END AS trend_direction
FROM anomaly_detection ad
INNER JOIN parking_facilities pf ON ad.facility_id = pf.facility_id
INNER JOIN cities c ON pf.city_id = c.city_id
WHERE ad.is_anomaly = TRUE OR ad.trend_component != 0
ORDER BY ad.facility_id, ad.month_num, ad.utilization_hour
LIMIT 500;
</p>
</code></pre>
<p>
---
</p>
<h2 id="query-9-geographic-expansion-analysis-with-market-opportunity-scoring-and-risk-assessment-query-9-"></h2>
<strong>Use Case:</strong> <strong>Prioritize geographic expansion markets by analyzing market opportunities, competitive landscapes, and risk factors for strategic market entry decisions.</strong>
<strong>Description:</strong> Identifies geographic expansion opportunities using multi-level CTEs, market opportunity scoring algorithms, competitive landscape analysis, risk assessment modeling, and expansion prioritization ranking.
<strong>Use Case:</strong> Prioritize geographic expansion markets by analyzing market opportunities, competitive landscapes, and risk factors for strategic market entry decisions.
<strong>Business Value:</strong> Geographic expansion report with market opportunity scores, risk assessments, competitive analysis, and prioritized expansion recommendations.
<strong>Purpose:</strong> Enables data-driven geographic expansion decisions by quantifying market opportunities and risks across potential expansion markets.
<strong>Complexity:</strong> Multi-level CTEs (7+ levels), market scoring algorithms, risk modeling, competitive analysis, spatial proximity calculations, expansion prioritization
<strong>Expected Output:</strong> Market expansion opportunities with opportunity scores, risk assessments, and expansion priorities.
<pre><code class="language-sql">WITH candidate_markets AS (
<p>
SELECT
c.city_id,
c.city_name,
c.state_code,
c.population,
c.population_density,
c.median_household_income,
c.employment_total,
ma.msa_name,
ma.gdp_billions,
COUNT(DISTINCT pf.facility_id) AS existing_facilities,
COUNT(DISTINCT CASE WHEN pf.accepts_reservations THEN pf.facility_id END) AS reservation_facilities
FROM cities c
INNER JOIN metropolitan_areas ma ON c.msa_id = ma.msa_id
LEFT JOIN parking_facilities pf ON c.city_id = pf.city_id
WHERE c.population &gt; 100000
AND NOT EXISTS (
SELECT 1 FROM parking_facilities pf2
WHERE pf2.city_id = c.city_id
AND pf2.operator_type = 'Private'
AND pf2.accepts_reservations = TRUE
)
GROUP BY c.city_id, c.city_name, c.state_code, c.population, c.population_density,
c.median_household_income, c.employment_total, ma.msa_name, ma.gdp_billions
),
market_metrics AS (
SELECT
cm.*,
COALESCE(AVG(pu.occupancy_rate), 0) AS avg_occupancy_rate,
COALESCE(SUM(pu.revenue_generated), 0) AS total_revenue,
COUNT(DISTINCT pu.facility_id) AS facilities_with_data
FROM candidate_markets cm
LEFT JOIN parking_facilities pf ON cm.city_id = pf.city_id
LEFT JOIN parking_utilization pu ON pf.facility_id = pu.facility_id
AND pu.utilization_date &gt;= CURRENT_DATE - INTERVAL '90 days'
GROUP BY cm.city_id, cm.city_name, cm.state_code, cm.population, cm.population_density,
cm.median_household_income, cm.employment_total, cm.msa_name, cm.gdp_billions,
cm.existing_facilities, cm.reservation_facilities
),
competitive_landscape AS (
SELECT
mm.city_id,
COUNT(DISTINCT pf2.facility_id) AS competitor_facilities,
AVG(pp2.base_rate_hourly) AS avg_competitor_rate,
COUNT(DISTINCT pf2.operator_name) AS operator_count
FROM market_metrics mm
LEFT JOIN parking_facilities pf2 ON mm.city_id = pf2.city_id
LEFT JOIN parking_pricing pp2 ON pf2.facility_id = pp2.facility_id AND pp2.is_active = TRUE
GROUP BY mm.city_id
),
risk_assessment AS (
SELECT
mm.*,
cl.competitor_facilities,
cl.avg_competitor_rate,
cl.operator_count,
CASE
WHEN mm.existing_facilities = 0 THEN 0.3  -- Low competition risk
WHEN mm.existing_facilities &lt; 10 THEN 0.5  -- Medium competition risk
ELSE 0.7  -- High competition risk
END AS competition_risk_score,
CASE
WHEN mm.population_density &lt; 1000 THEN 0.6  -- Low density risk
WHEN mm.population_density &lt; 3000 THEN 0.3  -- Medium density risk
ELSE 0.1  -- High density (low risk)
END AS density_risk_score,
CASE
WHEN mm.median_household_income &lt; 40000 THEN 0.5  -- Income risk
WHEN mm.median_household_income &lt; 60000 THEN 0.3
ELSE 0.1
END AS income_risk_score
FROM market_metrics mm
LEFT JOIN competitive_landscape cl ON mm.city_id = cl.city_id
),
opportunity_scoring AS (
SELECT
ra.*,
-- Market opportunity score (0-100)
(
LEAST(ra.population / 1000000.0, 1.0) * 25 +
LEAST(ra.population_density / 10000.0, 1.0) * 20 +
LEAST(ra.median_household_income / 100000.0, 1.0) * 20 +
LEAST(ra.avg_occupancy_rate / 100.0, 1.0) * 15 +
CASE WHEN ra.existing_facilities = 0 THEN 20 ELSE GREATEST(20 - ra.existing_facilities * 0.5, 0) END
) AS opportunity_score,
-- Overall risk score (0-1, higher is riskier)
(ra.competition_risk_score * 0.4 + ra.density_risk_score * 0.3 + ra.income_risk_score * 0.3) AS overall_risk_score
FROM risk_assessment ra
),
expansion_prioritization AS (
SELECT
os.*,
os.opportunity_score * (1 - os.overall_risk_score) AS expansion_priority_score,
ROW_NUMBER() OVER (ORDER BY os.opportunity_score * (1 - os.overall_risk_score) DESC) AS expansion_rank,
CASE
WHEN os.opportunity_score * (1 - os.overall_risk_score) &gt; 60 THEN 'High Priority'
WHEN os.opportunity_score * (1 - os.overall_risk_score) &gt; 40 THEN 'Medium Priority'
ELSE 'Low Priority'
END AS expansion_priority
FROM opportunity_scoring os
)
SELECT
ep.city_id,
ep.city_name,
ep.state_code,
ep.msa_name,
ep.population,
ep.population_density,
ep.median_household_income,
ep.existing_facilities,
ep.competitor_facilities,
ep.avg_occupancy_rate,
ep.opportunity_score,
ep.overall_risk_score,
ep.expansion_priority_score,
ep.expansion_rank,
ep.expansion_priority
FROM expansion_prioritization ep
ORDER BY ep.expansion_priority_score DESC
LIMIT 100;
</p>
</code></pre>
<p>
---
</p>
<h2 id="query-10-revenue-forecasting-models-with-time-series-analysis-and-confidence-intervals-query-10-"></h2>
<strong>Use Case:</strong> <strong>Predict future revenue trends for financial planning and budget forecasting.</strong>
<strong>Description:</strong> Forecasts parking revenue using time-series analysis CTEs, ARIMA-like modeling, confidence interval calculations, and revenue projection scenarios.
<strong>Use Case:</strong> Predict future revenue trends for financial planning and budget forecasting.
<strong>Business Value:</strong> Revenue forecast report with projections, confidence intervals, and scenario analysis.
<strong>Purpose:</strong> Enables data-driven decision making through advanced analytics and business intelligence.
<strong>Complexity:</strong> Time-series CTEs (7+ levels), forecasting models, confidence intervals, scenario analysis
<strong>Expected Output:</strong> Query results with analysis and recommendations.
<pre><code class="language-sql">WITH facility_base_data AS (
<p>
SELECT
pf.facility_id,
pf.facility_name,
pf.city_id,
pf.total_spaces,
pf.facility_type,
pf.operator_type,
pf.latitude,
pf.longitude,
pf.is_event_parking,
pf.is_monthly_parking,
pf.accepts_reservations,
c.city_name,
c.state_code,
c.population,
c.population_density,
c.median_household_income,
c.employment_total,
ma.msa_name,
ma.gdp_billions,
ma.population_estimate AS msa_population
FROM parking_facilities pf
INNER JOIN cities c ON pf.city_id = c.city_id
INNER JOIN metropolitan_areas ma ON c.msa_id = ma.msa_id
WHERE pf.is_hourly_parking = TRUE
),
utilization_aggregations AS (
SELECT
pu.facility_id,
pu.utilization_date,
pu.utilization_hour,
AVG(pu.occupancy_rate) AS avg_occupancy_rate,
PERCENTILE_CONT(0.5) WITHIN GROUP (ORDER BY pu.occupancy_rate) AS median_occupancy_rate,
PERCENTILE_CONT(0.75) WITHIN GROUP (ORDER BY pu.occupancy_rate) AS p75_occupancy_rate,
PERCENTILE_CONT(0.95) WITHIN GROUP (ORDER BY pu.occupancy_rate) AS p95_occupancy_rate,
SUM(pu.revenue_generated) AS total_revenue,
AVG(pu.revenue_generated) AS avg_revenue_per_record,
COUNT(*) AS utilization_records,
COUNT(DISTINCT pu.utilization_date) AS days_with_data,
DATE_PART('dow', pu.utilization_date) AS day_of_week
FROM parking_utilization pu
WHERE pu.utilization_date &gt;= CURRENT_DATE - INTERVAL '90 days'
GROUP BY pu.facility_id, pu.utilization_date, pu.utilization_hour, DATE_PART('dow', pu.utilization_date)
),
pricing_analysis AS (
SELECT
pp.facility_id,
AVG(pp.base_rate_hourly) AS avg_hourly_rate,
AVG(pp.base_rate_daily) AS avg_daily_rate,
AVG(pp.base_rate_monthly) AS avg_monthly_rate,
MIN(pp.base_rate_hourly) AS min_hourly_rate,
MAX(pp.base_rate_hourly) AS max_hourly_rate,
PERCENTILE_CONT(0.5) WITHIN GROUP (ORDER BY pp.base_rate_hourly) AS median_hourly_rate,
PERCENTILE_CONT(0.75) WITHIN GROUP (ORDER BY pp.base_rate_hourly) AS p75_hourly_rate,
COUNT(*) AS pricing_records
FROM parking_pricing pp
WHERE pp.is_active = TRUE
AND pp.pricing_type IN ('Hourly', 'Daily', 'Monthly')
GROUP BY pp.facility_id
),
competitive_landscape AS (
SELECT
fbd1.facility_id,
fbd1.city_id,
COUNT(DISTINCT fbd2.facility_id) AS competitor_count,
AVG(fbd2.total_spaces) AS avg_competitor_spaces,
SUM(fbd2.total_spaces) AS total_competitor_spaces,
AVG(pa2.avg_hourly_rate) AS avg_competitor_rate,
MIN(pa2.avg_hourly_rate) AS min_competitor_rate,
MAX(pa2.avg_hourly_rate) AS max_competitor_rate,
PERCENTILE_CONT(0.5) WITHIN GROUP (ORDER BY pa2.avg_hourly_rate) AS median_competitor_rate,
AVG(
CASE
WHEN ST_DISTANCE(
ST_POINT(fbd1.longitude, fbd1.latitude),
ST_POINT(fbd2.longitude, fbd2.latitude)
) &lt; 500 THEN ST_DISTANCE(
ST_POINT(fbd1.longitude, fbd1.latitude),
ST_POINT(fbd2.longitude, fbd2.latitude)
)
ELSE NULL
END
) AS avg_distance_to_competitors
FROM facility_base_data fbd1
LEFT JOIN facility_base_data fbd2 ON fbd1.city_id = fbd2.city_id
AND fbd2.facility_id != fbd1.facility_id
AND ST_DISTANCE(
ST_POINT(fbd1.longitude, fbd1.latitude),
ST_POINT(fbd2.longitude, fbd2.latitude)
) &lt; 1000
LEFT JOIN pricing_analysis pa2 ON fbd2.facility_id = pa2.facility_id
GROUP BY fbd1.facility_id, fbd1.city_id, fbd1.latitude, fbd1.longitude
),
market_intelligence AS (
SELECT
fbd.facility_id,
fbd.facility_name,
fbd.city_id,
fbd.city_name,
fbd.state_code,
fbd.msa_name,
fbd.total_spaces,
fbd.facility_type,
fbd.operator_type,
fbd.population,
fbd.population_density,
fbd.median_household_income,
fbd.msa_population,
COALESCE(ua.avg_occupancy_rate, 0) AS avg_occupancy_rate,
COALESCE(ua.median_occupancy_rate, 0) AS median_occupancy_rate,
COALESCE(ua.p95_occupancy_rate, 0) AS p95_occupancy_rate,
COALESCE(ua.total_revenue, 0) AS total_revenue,
COALESCE(ua.avg_revenue_per_record, 0) AS avg_revenue_per_record,
COALESCE(ua.days_with_data, 0) AS days_with_data,
COALESCE(pa.avg_hourly_rate, 0) AS avg_hourly_rate,
COALESCE(pa.median_hourly_rate, 0) AS median_hourly_rate,
COALESCE(pa.p75_hourly_rate, 0) AS p75_hourly_rate,
COALESCE(cl.competitor_count, 0) AS competitor_count,
COALESCE(cl.avg_competitor_rate, 0) AS avg_competitor_rate,
COALESCE(cl.median_competitor_rate, 0) AS median_competitor_rate,
COALESCE(cl.avg_distance_to_competitors, 0) AS avg_distance_to_competitors,
-- Market opportunity score
(
LEAST(fbd.population_density / 10000.0, 1.0) * 25 +
LEAST(COALESCE(ua.avg_occupancy_rate, 0) / 100.0, 1.0) * 25 +
LEAST(fbd.median_household_income / 100000.0, 1.0) * 20 +
LEAST(COALESCE(cl.competitor_count, 0) / 10.0, 1.0) * 15 +
LEAST(fbd.total_spaces / 500.0, 1.0) * 15
) AS market_opportunity_score,
-- Competitive advantage score
(
CASE WHEN COALESCE(pa.avg_hourly_rate, 0) &lt; COALESCE(cl.avg_competitor_rate, 999) THEN 30 ELSE 0 END +
CASE WHEN COALESCE(ua.avg_occupancy_rate, 0) &gt; 80 THEN 25 ELSE COALESCE(ua.avg_occupancy_rate, 0) * 0.3125 END +
CASE WHEN COALESCE(cl.competitor_count, 0) &lt; 3 THEN 25 ELSE GREATEST(25 - COALESCE(cl.competitor_count, 0) * 2, 0) END +
CASE WHEN fbd.accepts_reservations THEN 20 ELSE 0 END
) AS competitive_advantage_score
FROM facility_base_data fbd
LEFT JOIN utilization_aggregations ua ON fbd.facility_id = ua.facility_id
LEFT JOIN pricing_analysis pa ON fbd.facility_id = pa.facility_id
LEFT JOIN competitive_landscape cl ON fbd.facility_id = cl.facility_id
),
ranked_analysis AS (
SELECT
mi.*,
ROW_NUMBER() OVER (PARTITION BY mi.city_id ORDER BY mi.market_opportunity_score DESC) AS city_rank,
ROW_NUMBER() OVER (ORDER BY mi.total_revenue DESC) AS revenue_rank,
ROW_NUMBER() OVER (ORDER BY mi.competitive_advantage_score DESC) AS competitive_rank,
PERCENT_RANK() OVER (ORDER BY mi.market_opportunity_score) AS opportunity_percentile,
PERCENT_RANK() OVER (ORDER BY mi.total_revenue) AS revenue_percentile,
PERCENT_RANK() OVER (ORDER BY mi.competitive_advantage_score) AS competitive_percentile,
LAG(mi.market_opportunity_score) OVER (ORDER BY mi.market_opportunity_score DESC) AS prev_opportunity_score,
LEAD(mi.market_opportunity_score) OVER (ORDER BY mi.market_opportunity_score DESC) AS next_opportunity_score,
AVG(mi.market_opportunity_score) OVER (PARTITION BY mi.city_id) AS city_avg_opportunity_score,
STDDEV(mi.market_opportunity_score) OVER (PARTITION BY mi.city_id) AS city_stddev_opportunity_score,
AVG(mi.total_revenue) OVER (PARTITION BY mi.city_id) AS city_avg_revenue,
AVG(mi.avg_occupancy_rate) OVER (PARTITION BY mi.city_id) AS city_avg_occupancy_rate
FROM market_intelligence mi
),
optimization_recommendations AS (
SELECT
ra.*,
CASE
WHEN ra.market_opportunity_score &gt;= ra.city_avg_opportunity_score + ra.city_stddev_opportunity_score THEN 'High Priority'
WHEN ra.market_opportunity_score &gt;= ra.city_avg_opportunity_score THEN 'Medium Priority'
ELSE 'Low Priority'
END AS optimization_priority,
CASE
WHEN ra.avg_occupancy_rate &gt; 85 AND ra.avg_hourly_rate &lt; ra.avg_competitor_rate THEN
ra.avg_hourly_rate * 1.15  -- Increase price if high demand and underpriced
WHEN ra.avg_occupancy_rate &lt; 50 AND ra.avg_hourly_rate &gt; ra.avg_competitor_rate THEN
ra.avg_hourly_rate * 0.90  -- Decrease price if low demand and overpriced
WHEN ra.avg_hourly_rate &lt; ra.median_competitor_rate * 0.9 THEN
ra.median_competitor_rate * 0.95  -- Price slightly below median if significantly underpriced
ELSE ra.avg_hourly_rate  -- Keep current price
END AS recommended_rate,
-- Revenue impact estimate
(
CASE
WHEN ra.avg_occupancy_rate &gt; 85 AND ra.avg_hourly_rate &lt; ra.avg_competitor_rate THEN
ra.avg_hourly_rate * 1.15 * ra.total_spaces * ra.avg_occupancy_rate / 100.0 * ra.days_with_data
WHEN ra.avg_occupancy_rate &lt; 50 AND ra.avg_hourly_rate &gt; ra.avg_competitor_rate THEN
ra.avg_hourly_rate * 0.90 * ra.total_spaces * ra.avg_occupancy_rate / 100.0 * ra.days_with_data
ELSE ra.total_revenue
END - ra.total_revenue
) AS estimated_revenue_impact,
-- Market share estimate
CASE
WHEN ra.competitor_count &gt; 0 AND ra.total_spaces &gt; 0 THEN
(ra.total_spaces * ra.avg_occupancy_rate / 100.0) /
NULLIF(
(ra.total_spaces * ra.avg_occupancy_rate / 100.0) +
(ra.competitor_count * COALESCE(ra.avg_competitor_rate, 0) * 50),  -- Estimate competitor spaces
1
) * 100
ELSE 100.0
END AS estimated_market_share_pct
FROM ranked_analysis ra
)
SELECT
or_rec.facility_id,
or_rec.facility_name,
or_rec.city_name,
or_rec.state_code,
or_rec.msa_name,
or_rec.total_spaces,
or_rec.facility_type,
or_rec.operator_type,
or_rec.avg_occupancy_rate,
or_rec.median_occupancy_rate,
or_rec.p95_occupancy_rate,
or_rec.total_revenue,
or_rec.avg_hourly_rate AS current_rate,
or_rec.recommended_rate,
or_rec.competitor_count,
or_rec.avg_competitor_rate,
or_rec.median_competitor_rate,
or_rec.market_opportunity_score,
or_rec.competitive_advantage_score,
or_rec.opportunity_percentile,
or_rec.revenue_percentile,
or_rec.competitive_percentile,
or_rec.optimization_priority,
or_rec.estimated_revenue_impact,
or_rec.estimated_market_share_pct,
CASE
WHEN or_rec.estimated_revenue_impact &gt; 1000 THEN 'High Impact'
WHEN or_rec.estimated_revenue_impact &gt; 0 THEN 'Medium Impact'
ELSE 'Low Impact'
END AS impact_category
FROM optimization_recommendations or_rec
WHERE or_rec.competitor_count &gt; 0 OR or_rec.total_revenue &gt; 0
ORDER BY or_rec.market_opportunity_score DESC, or_rec.total_revenue DESC
LIMIT 200;
</p>
</code></pre>
<p>
---
</p>
<h2 id="query-11-competitive-positioning-analysis-with-market-share-dynamics-and-strategic-recommendations-query-11-"></h2>
<strong>Use Case:</strong> <strong>Understand competitive position and develop strategic recommendations for market leadership.</strong>
<strong>Description:</strong> Analyzes competitive positioning using multi-level CTEs, market share calculations, competitive advantage scoring, and strategic positioning recommendations.
<strong>Use Case:</strong> Understand competitive position and develop strategic recommendations for market leadership.
<strong>Business Value:</strong> Competitive positioning report with market share analysis and strategic recommendations.
<strong>Purpose:</strong> Enables data-driven decision making through advanced analytics and business intelligence.
<strong>Complexity:</strong> Multi-level CTEs (6+ levels), market share calculations, competitive analysis, strategic scoring
<strong>Expected Output:</strong> Query results with analysis and recommendations.
<pre><code class="language-sql">WITH facility_base_data AS (
<p>
SELECT
pf.facility_id,
pf.facility_name,
pf.city_id,
pf.total_spaces,
pf.facility_type,
pf.operator_type,
pf.latitude,
pf.longitude,
pf.is_event_parking,
pf.is_monthly_parking,
pf.accepts_reservations,
c.city_name,
c.state_code,
c.population,
c.population_density,
c.median_household_income,
c.employment_total,
ma.msa_name,
ma.gdp_billions,
ma.population_estimate AS msa_population
FROM parking_facilities pf
INNER JOIN cities c ON pf.city_id = c.city_id
INNER JOIN metropolitan_areas ma ON c.msa_id = ma.msa_id
WHERE pf.is_hourly_parking = TRUE
),
utilization_aggregations AS (
SELECT
pu.facility_id,
pu.utilization_date,
pu.utilization_hour,
AVG(pu.occupancy_rate) AS avg_occupancy_rate,
PERCENTILE_CONT(0.5) WITHIN GROUP (ORDER BY pu.occupancy_rate) AS median_occupancy_rate,
PERCENTILE_CONT(0.75) WITHIN GROUP (ORDER BY pu.occupancy_rate) AS p75_occupancy_rate,
PERCENTILE_CONT(0.95) WITHIN GROUP (ORDER BY pu.occupancy_rate) AS p95_occupancy_rate,
SUM(pu.revenue_generated) AS total_revenue,
AVG(pu.revenue_generated) AS avg_revenue_per_record,
COUNT(*) AS utilization_records,
COUNT(DISTINCT pu.utilization_date) AS days_with_data,
DATE_PART('dow', pu.utilization_date) AS day_of_week
FROM parking_utilization pu
WHERE pu.utilization_date &gt;= CURRENT_DATE - INTERVAL '90 days'
GROUP BY pu.facility_id, pu.utilization_date, pu.utilization_hour, DATE_PART('dow', pu.utilization_date)
),
pricing_analysis AS (
SELECT
pp.facility_id,
AVG(pp.base_rate_hourly) AS avg_hourly_rate,
AVG(pp.base_rate_daily) AS avg_daily_rate,
AVG(pp.base_rate_monthly) AS avg_monthly_rate,
MIN(pp.base_rate_hourly) AS min_hourly_rate,
MAX(pp.base_rate_hourly) AS max_hourly_rate,
PERCENTILE_CONT(0.5) WITHIN GROUP (ORDER BY pp.base_rate_hourly) AS median_hourly_rate,
PERCENTILE_CONT(0.75) WITHIN GROUP (ORDER BY pp.base_rate_hourly) AS p75_hourly_rate,
COUNT(*) AS pricing_records
FROM parking_pricing pp
WHERE pp.is_active = TRUE
AND pp.pricing_type IN ('Hourly', 'Daily', 'Monthly')
GROUP BY pp.facility_id
),
competitive_landscape AS (
SELECT
fbd1.facility_id,
fbd1.city_id,
COUNT(DISTINCT fbd2.facility_id) AS competitor_count,
AVG(fbd2.total_spaces) AS avg_competitor_spaces,
SUM(fbd2.total_spaces) AS total_competitor_spaces,
AVG(pa2.avg_hourly_rate) AS avg_competitor_rate,
MIN(pa2.avg_hourly_rate) AS min_competitor_rate,
MAX(pa2.avg_hourly_rate) AS max_competitor_rate,
PERCENTILE_CONT(0.5) WITHIN GROUP (ORDER BY pa2.avg_hourly_rate) AS median_competitor_rate,
AVG(
CASE
WHEN ST_DISTANCE(
ST_POINT(fbd1.longitude, fbd1.latitude),
ST_POINT(fbd2.longitude, fbd2.latitude)
) &lt; 500 THEN ST_DISTANCE(
ST_POINT(fbd1.longitude, fbd1.latitude),
ST_POINT(fbd2.longitude, fbd2.latitude)
)
ELSE NULL
END
) AS avg_distance_to_competitors
FROM facility_base_data fbd1
LEFT JOIN facility_base_data fbd2 ON fbd1.city_id = fbd2.city_id
AND fbd2.facility_id != fbd1.facility_id
AND ST_DISTANCE(
ST_POINT(fbd1.longitude, fbd1.latitude),
ST_POINT(fbd2.longitude, fbd2.latitude)
) &lt; 1000
LEFT JOIN pricing_analysis pa2 ON fbd2.facility_id = pa2.facility_id
GROUP BY fbd1.facility_id, fbd1.city_id, fbd1.latitude, fbd1.longitude
),
market_intelligence AS (
SELECT
fbd.facility_id,
fbd.facility_name,
fbd.city_id,
fbd.city_name,
fbd.state_code,
fbd.msa_name,
fbd.total_spaces,
fbd.facility_type,
fbd.operator_type,
fbd.population,
fbd.population_density,
fbd.median_household_income,
fbd.msa_population,
COALESCE(ua.avg_occupancy_rate, 0) AS avg_occupancy_rate,
COALESCE(ua.median_occupancy_rate, 0) AS median_occupancy_rate,
COALESCE(ua.p95_occupancy_rate, 0) AS p95_occupancy_rate,
COALESCE(ua.total_revenue, 0) AS total_revenue,
COALESCE(ua.avg_revenue_per_record, 0) AS avg_revenue_per_record,
COALESCE(ua.days_with_data, 0) AS days_with_data,
COALESCE(pa.avg_hourly_rate, 0) AS avg_hourly_rate,
COALESCE(pa.median_hourly_rate, 0) AS median_hourly_rate,
COALESCE(pa.p75_hourly_rate, 0) AS p75_hourly_rate,
COALESCE(cl.competitor_count, 0) AS competitor_count,
COALESCE(cl.avg_competitor_rate, 0) AS avg_competitor_rate,
COALESCE(cl.median_competitor_rate, 0) AS median_competitor_rate,
COALESCE(cl.avg_distance_to_competitors, 0) AS avg_distance_to_competitors,
-- Market opportunity score
(
LEAST(fbd.population_density / 10000.0, 1.0) * 25 +
LEAST(COALESCE(ua.avg_occupancy_rate, 0) / 100.0, 1.0) * 25 +
LEAST(fbd.median_household_income / 100000.0, 1.0) * 20 +
LEAST(COALESCE(cl.competitor_count, 0) / 10.0, 1.0) * 15 +
LEAST(fbd.total_spaces / 500.0, 1.0) * 15
) AS market_opportunity_score,
-- Competitive advantage score
(
CASE WHEN COALESCE(pa.avg_hourly_rate, 0) &lt; COALESCE(cl.avg_competitor_rate, 999) THEN 30 ELSE 0 END +
CASE WHEN COALESCE(ua.avg_occupancy_rate, 0) &gt; 80 THEN 25 ELSE COALESCE(ua.avg_occupancy_rate, 0) * 0.3125 END +
CASE WHEN COALESCE(cl.competitor_count, 0) &lt; 3 THEN 25 ELSE GREATEST(25 - COALESCE(cl.competitor_count, 0) * 2, 0) END +
CASE WHEN fbd.accepts_reservations THEN 20 ELSE 0 END
) AS competitive_advantage_score
FROM facility_base_data fbd
LEFT JOIN utilization_aggregations ua ON fbd.facility_id = ua.facility_id
LEFT JOIN pricing_analysis pa ON fbd.facility_id = pa.facility_id
LEFT JOIN competitive_landscape cl ON fbd.facility_id = cl.facility_id
),
ranked_analysis AS (
SELECT
mi.*,
ROW_NUMBER() OVER (PARTITION BY mi.city_id ORDER BY mi.market_opportunity_score DESC) AS city_rank,
ROW_NUMBER() OVER (ORDER BY mi.total_revenue DESC) AS revenue_rank,
ROW_NUMBER() OVER (ORDER BY mi.competitive_advantage_score DESC) AS competitive_rank,
PERCENT_RANK() OVER (ORDER BY mi.market_opportunity_score) AS opportunity_percentile,
PERCENT_RANK() OVER (ORDER BY mi.total_revenue) AS revenue_percentile,
PERCENT_RANK() OVER (ORDER BY mi.competitive_advantage_score) AS competitive_percentile,
LAG(mi.market_opportunity_score) OVER (ORDER BY mi.market_opportunity_score DESC) AS prev_opportunity_score,
LEAD(mi.market_opportunity_score) OVER (ORDER BY mi.market_opportunity_score DESC) AS next_opportunity_score,
AVG(mi.market_opportunity_score) OVER (PARTITION BY mi.city_id) AS city_avg_opportunity_score,
STDDEV(mi.market_opportunity_score) OVER (PARTITION BY mi.city_id) AS city_stddev_opportunity_score,
AVG(mi.total_revenue) OVER (PARTITION BY mi.city_id) AS city_avg_revenue,
AVG(mi.avg_occupancy_rate) OVER (PARTITION BY mi.city_id) AS city_avg_occupancy_rate
FROM market_intelligence mi
),
optimization_recommendations AS (
SELECT
ra.*,
CASE
WHEN ra.market_opportunity_score &gt;= ra.city_avg_opportunity_score + ra.city_stddev_opportunity_score THEN 'High Priority'
WHEN ra.market_opportunity_score &gt;= ra.city_avg_opportunity_score THEN 'Medium Priority'
ELSE 'Low Priority'
END AS optimization_priority,
CASE
WHEN ra.avg_occupancy_rate &gt; 85 AND ra.avg_hourly_rate &lt; ra.avg_competitor_rate THEN
ra.avg_hourly_rate * 1.15  -- Increase price if high demand and underpriced
WHEN ra.avg_occupancy_rate &lt; 50 AND ra.avg_hourly_rate &gt; ra.avg_competitor_rate THEN
ra.avg_hourly_rate * 0.90  -- Decrease price if low demand and overpriced
WHEN ra.avg_hourly_rate &lt; ra.median_competitor_rate * 0.9 THEN
ra.median_competitor_rate * 0.95  -- Price slightly below median if significantly underpriced
ELSE ra.avg_hourly_rate  -- Keep current price
END AS recommended_rate,
-- Revenue impact estimate
(
CASE
WHEN ra.avg_occupancy_rate &gt; 85 AND ra.avg_hourly_rate &lt; ra.avg_competitor_rate THEN
ra.avg_hourly_rate * 1.15 * ra.total_spaces * ra.avg_occupancy_rate / 100.0 * ra.days_with_data
WHEN ra.avg_occupancy_rate &lt; 50 AND ra.avg_hourly_rate &gt; ra.avg_competitor_rate THEN
ra.avg_hourly_rate * 0.90 * ra.total_spaces * ra.avg_occupancy_rate / 100.0 * ra.days_with_data
ELSE ra.total_revenue
END - ra.total_revenue
) AS estimated_revenue_impact,
-- Market share estimate
CASE
WHEN ra.competitor_count &gt; 0 AND ra.total_spaces &gt; 0 THEN
(ra.total_spaces * ra.avg_occupancy_rate / 100.0) /
NULLIF(
(ra.total_spaces * ra.avg_occupancy_rate / 100.0) +
(ra.competitor_count * COALESCE(ra.avg_competitor_rate, 0) * 50),  -- Estimate competitor spaces
1
) * 100
ELSE 100.0
END AS estimated_market_share_pct
FROM ranked_analysis ra
)
SELECT
or_rec.facility_id,
or_rec.facility_name,
or_rec.city_name,
or_rec.state_code,
or_rec.msa_name,
or_rec.total_spaces,
or_rec.facility_type,
or_rec.operator_type,
or_rec.avg_occupancy_rate,
or_rec.median_occupancy_rate,
or_rec.p95_occupancy_rate,
or_rec.total_revenue,
or_rec.avg_hourly_rate AS current_rate,
or_rec.recommended_rate,
or_rec.competitor_count,
or_rec.avg_competitor_rate,
or_rec.median_competitor_rate,
or_rec.market_opportunity_score,
or_rec.competitive_advantage_score,
or_rec.opportunity_percentile,
or_rec.revenue_percentile,
or_rec.competitive_percentile,
or_rec.optimization_priority,
or_rec.estimated_revenue_impact,
or_rec.estimated_market_share_pct,
CASE
WHEN or_rec.estimated_revenue_impact &gt; 1000 THEN 'High Impact'
WHEN or_rec.estimated_revenue_impact &gt; 0 THEN 'Medium Impact'
ELSE 'Low Impact'
END AS impact_category
FROM optimization_recommendations or_rec
WHERE or_rec.competitor_count &gt; 0 OR or_rec.total_revenue &gt; 0
ORDER BY or_rec.market_opportunity_score DESC, or_rec.total_revenue DESC
LIMIT 200;
</p>
</code></pre>
<p>
---
</p>
<h2 id="query-12-business-district-analysis-with-parking-demand-correlation-and-revenue-optimization-query-12-"></h2>
<strong>Use Case:</strong> <strong>Optimize parking strategies for business districts based on employment patterns and demand.</strong>
<strong>Description:</strong> Analyzes business districts using spatial CTEs, employment correlation analysis, parking demand modeling, and district-specific revenue optimization.
<strong>Use Case:</strong> Optimize parking strategies for business districts based on employment patterns and demand.
<strong>Business Value:</strong> Business district analysis report with demand correlations and revenue optimization strategies.
<strong>Purpose:</strong> Enables data-driven decision making through advanced analytics and business intelligence.
<strong>Complexity:</strong> Spatial CTEs (6+ levels), correlation analysis, demand modeling, revenue optimization
<strong>Expected Output:</strong> Query results with analysis and recommendations.
<pre><code class="language-sql">WITH facility_base_data AS (
<p>
SELECT
pf.facility_id,
pf.facility_name,
pf.city_id,
pf.total_spaces,
pf.facility_type,
pf.operator_type,
pf.latitude,
pf.longitude,
pf.is_event_parking,
pf.is_monthly_parking,
pf.accepts_reservations,
c.city_name,
c.state_code,
c.population,
c.population_density,
c.median_household_income,
c.employment_total,
ma.msa_name,
ma.gdp_billions,
ma.population_estimate AS msa_population
FROM parking_facilities pf
INNER JOIN cities c ON pf.city_id = c.city_id
INNER JOIN metropolitan_areas ma ON c.msa_id = ma.msa_id
WHERE pf.is_hourly_parking = TRUE
),
utilization_aggregations AS (
SELECT
pu.facility_id,
pu.utilization_date,
pu.utilization_hour,
AVG(pu.occupancy_rate) AS avg_occupancy_rate,
PERCENTILE_CONT(0.5) WITHIN GROUP (ORDER BY pu.occupancy_rate) AS median_occupancy_rate,
PERCENTILE_CONT(0.75) WITHIN GROUP (ORDER BY pu.occupancy_rate) AS p75_occupancy_rate,
PERCENTILE_CONT(0.95) WITHIN GROUP (ORDER BY pu.occupancy_rate) AS p95_occupancy_rate,
SUM(pu.revenue_generated) AS total_revenue,
AVG(pu.revenue_generated) AS avg_revenue_per_record,
COUNT(*) AS utilization_records,
COUNT(DISTINCT pu.utilization_date) AS days_with_data,
DATE_PART('dow', pu.utilization_date) AS day_of_week
FROM parking_utilization pu
WHERE pu.utilization_date &gt;= CURRENT_DATE - INTERVAL '90 days'
GROUP BY pu.facility_id, pu.utilization_date, pu.utilization_hour, DATE_PART('dow', pu.utilization_date)
),
pricing_analysis AS (
SELECT
pp.facility_id,
AVG(pp.base_rate_hourly) AS avg_hourly_rate,
AVG(pp.base_rate_daily) AS avg_daily_rate,
AVG(pp.base_rate_monthly) AS avg_monthly_rate,
MIN(pp.base_rate_hourly) AS min_hourly_rate,
MAX(pp.base_rate_hourly) AS max_hourly_rate,
PERCENTILE_CONT(0.5) WITHIN GROUP (ORDER BY pp.base_rate_hourly) AS median_hourly_rate,
PERCENTILE_CONT(0.75) WITHIN GROUP (ORDER BY pp.base_rate_hourly) AS p75_hourly_rate,
COUNT(*) AS pricing_records
FROM parking_pricing pp
WHERE pp.is_active = TRUE
AND pp.pricing_type IN ('Hourly', 'Daily', 'Monthly')
GROUP BY pp.facility_id
),
competitive_landscape AS (
SELECT
fbd1.facility_id,
fbd1.city_id,
COUNT(DISTINCT fbd2.facility_id) AS competitor_count,
AVG(fbd2.total_spaces) AS avg_competitor_spaces,
SUM(fbd2.total_spaces) AS total_competitor_spaces,
AVG(pa2.avg_hourly_rate) AS avg_competitor_rate,
MIN(pa2.avg_hourly_rate) AS min_competitor_rate,
MAX(pa2.avg_hourly_rate) AS max_competitor_rate,
PERCENTILE_CONT(0.5) WITHIN GROUP (ORDER BY pa2.avg_hourly_rate) AS median_competitor_rate,
AVG(
CASE
WHEN ST_DISTANCE(
ST_POINT(fbd1.longitude, fbd1.latitude),
ST_POINT(fbd2.longitude, fbd2.latitude)
) &lt; 500 THEN ST_DISTANCE(
ST_POINT(fbd1.longitude, fbd1.latitude),
ST_POINT(fbd2.longitude, fbd2.latitude)
)
ELSE NULL
END
) AS avg_distance_to_competitors
FROM facility_base_data fbd1
LEFT JOIN facility_base_data fbd2 ON fbd1.city_id = fbd2.city_id
AND fbd2.facility_id != fbd1.facility_id
AND ST_DISTANCE(
ST_POINT(fbd1.longitude, fbd1.latitude),
ST_POINT(fbd2.longitude, fbd2.latitude)
) &lt; 1000
LEFT JOIN pricing_analysis pa2 ON fbd2.facility_id = pa2.facility_id
GROUP BY fbd1.facility_id, fbd1.city_id, fbd1.latitude, fbd1.longitude
),
market_intelligence AS (
SELECT
fbd.facility_id,
fbd.facility_name,
fbd.city_id,
fbd.city_name,
fbd.state_code,
fbd.msa_name,
fbd.total_spaces,
fbd.facility_type,
fbd.operator_type,
fbd.population,
fbd.population_density,
fbd.median_household_income,
fbd.msa_population,
COALESCE(ua.avg_occupancy_rate, 0) AS avg_occupancy_rate,
COALESCE(ua.median_occupancy_rate, 0) AS median_occupancy_rate,
COALESCE(ua.p95_occupancy_rate, 0) AS p95_occupancy_rate,
COALESCE(ua.total_revenue, 0) AS total_revenue,
COALESCE(ua.avg_revenue_per_record, 0) AS avg_revenue_per_record,
COALESCE(ua.days_with_data, 0) AS days_with_data,
COALESCE(pa.avg_hourly_rate, 0) AS avg_hourly_rate,
COALESCE(pa.median_hourly_rate, 0) AS median_hourly_rate,
COALESCE(pa.p75_hourly_rate, 0) AS p75_hourly_rate,
COALESCE(cl.competitor_count, 0) AS competitor_count,
COALESCE(cl.avg_competitor_rate, 0) AS avg_competitor_rate,
COALESCE(cl.median_competitor_rate, 0) AS median_competitor_rate,
COALESCE(cl.avg_distance_to_competitors, 0) AS avg_distance_to_competitors,
-- Market opportunity score
(
LEAST(fbd.population_density / 10000.0, 1.0) * 25 +
LEAST(COALESCE(ua.avg_occupancy_rate, 0) / 100.0, 1.0) * 25 +
LEAST(fbd.median_household_income / 100000.0, 1.0) * 20 +
LEAST(COALESCE(cl.competitor_count, 0) / 10.0, 1.0) * 15 +
LEAST(fbd.total_spaces / 500.0, 1.0) * 15
) AS market_opportunity_score,
-- Competitive advantage score
(
CASE WHEN COALESCE(pa.avg_hourly_rate, 0) &lt; COALESCE(cl.avg_competitor_rate, 999) THEN 30 ELSE 0 END +
CASE WHEN COALESCE(ua.avg_occupancy_rate, 0) &gt; 80 THEN 25 ELSE COALESCE(ua.avg_occupancy_rate, 0) * 0.3125 END +
CASE WHEN COALESCE(cl.competitor_count, 0) &lt; 3 THEN 25 ELSE GREATEST(25 - COALESCE(cl.competitor_count, 0) * 2, 0) END +
CASE WHEN fbd.accepts_reservations THEN 20 ELSE 0 END
) AS competitive_advantage_score
FROM facility_base_data fbd
LEFT JOIN utilization_aggregations ua ON fbd.facility_id = ua.facility_id
LEFT JOIN pricing_analysis pa ON fbd.facility_id = pa.facility_id
LEFT JOIN competitive_landscape cl ON fbd.facility_id = cl.facility_id
),
ranked_analysis AS (
SELECT
mi.*,
ROW_NUMBER() OVER (PARTITION BY mi.city_id ORDER BY mi.market_opportunity_score DESC) AS city_rank,
ROW_NUMBER() OVER (ORDER BY mi.total_revenue DESC) AS revenue_rank,
ROW_NUMBER() OVER (ORDER BY mi.competitive_advantage_score DESC) AS competitive_rank,
PERCENT_RANK() OVER (ORDER BY mi.market_opportunity_score) AS opportunity_percentile,
PERCENT_RANK() OVER (ORDER BY mi.total_revenue) AS revenue_percentile,
PERCENT_RANK() OVER (ORDER BY mi.competitive_advantage_score) AS competitive_percentile,
LAG(mi.market_opportunity_score) OVER (ORDER BY mi.market_opportunity_score DESC) AS prev_opportunity_score,
LEAD(mi.market_opportunity_score) OVER (ORDER BY mi.market_opportunity_score DESC) AS next_opportunity_score,
AVG(mi.market_opportunity_score) OVER (PARTITION BY mi.city_id) AS city_avg_opportunity_score,
STDDEV(mi.market_opportunity_score) OVER (PARTITION BY mi.city_id) AS city_stddev_opportunity_score,
AVG(mi.total_revenue) OVER (PARTITION BY mi.city_id) AS city_avg_revenue,
AVG(mi.avg_occupancy_rate) OVER (PARTITION BY mi.city_id) AS city_avg_occupancy_rate
FROM market_intelligence mi
),
optimization_recommendations AS (
SELECT
ra.*,
CASE
WHEN ra.market_opportunity_score &gt;= ra.city_avg_opportunity_score + ra.city_stddev_opportunity_score THEN 'High Priority'
WHEN ra.market_opportunity_score &gt;= ra.city_avg_opportunity_score THEN 'Medium Priority'
ELSE 'Low Priority'
END AS optimization_priority,
CASE
WHEN ra.avg_occupancy_rate &gt; 85 AND ra.avg_hourly_rate &lt; ra.avg_competitor_rate THEN
ra.avg_hourly_rate * 1.15  -- Increase price if high demand and underpriced
WHEN ra.avg_occupancy_rate &lt; 50 AND ra.avg_hourly_rate &gt; ra.avg_competitor_rate THEN
ra.avg_hourly_rate * 0.90  -- Decrease price if low demand and overpriced
WHEN ra.avg_hourly_rate &lt; ra.median_competitor_rate * 0.9 THEN
ra.median_competitor_rate * 0.95  -- Price slightly below median if significantly underpriced
ELSE ra.avg_hourly_rate  -- Keep current price
END AS recommended_rate,
-- Revenue impact estimate
(
CASE
WHEN ra.avg_occupancy_rate &gt; 85 AND ra.avg_hourly_rate &lt; ra.avg_competitor_rate THEN
ra.avg_hourly_rate * 1.15 * ra.total_spaces * ra.avg_occupancy_rate / 100.0 * ra.days_with_data
WHEN ra.avg_occupancy_rate &lt; 50 AND ra.avg_hourly_rate &gt; ra.avg_competitor_rate THEN
ra.avg_hourly_rate * 0.90 * ra.total_spaces * ra.avg_occupancy_rate / 100.0 * ra.days_with_data
ELSE ra.total_revenue
END - ra.total_revenue
) AS estimated_revenue_impact,
-- Market share estimate
CASE
WHEN ra.competitor_count &gt; 0 AND ra.total_spaces &gt; 0 THEN
(ra.total_spaces * ra.avg_occupancy_rate / 100.0) /
NULLIF(
(ra.total_spaces * ra.avg_occupancy_rate / 100.0) +
(ra.competitor_count * COALESCE(ra.avg_competitor_rate, 0) * 50),  -- Estimate competitor spaces
1
) * 100
ELSE 100.0
END AS estimated_market_share_pct
FROM ranked_analysis ra
)
SELECT
or_rec.facility_id,
or_rec.facility_name,
or_rec.city_name,
or_rec.state_code,
or_rec.msa_name,
or_rec.total_spaces,
or_rec.facility_type,
or_rec.operator_type,
or_rec.avg_occupancy_rate,
or_rec.median_occupancy_rate,
or_rec.p95_occupancy_rate,
or_rec.total_revenue,
or_rec.avg_hourly_rate AS current_rate,
or_rec.recommended_rate,
or_rec.competitor_count,
or_rec.avg_competitor_rate,
or_rec.median_competitor_rate,
or_rec.market_opportunity_score,
or_rec.competitive_advantage_score,
or_rec.opportunity_percentile,
or_rec.revenue_percentile,
or_rec.competitive_percentile,
or_rec.optimization_priority,
or_rec.estimated_revenue_impact,
or_rec.estimated_market_share_pct,
CASE
WHEN or_rec.estimated_revenue_impact &gt; 1000 THEN 'High Impact'
WHEN or_rec.estimated_revenue_impact &gt; 0 THEN 'Medium Impact'
ELSE 'Low Impact'
END AS impact_category
FROM optimization_recommendations or_rec
WHERE or_rec.competitor_count &gt; 0 OR or_rec.total_revenue &gt; 0
ORDER BY or_rec.market_opportunity_score DESC, or_rec.total_revenue DESC
LIMIT 200;
</p>
</code></pre>
<p>
---
</p>
<h2 id="query-13-monthly-parking-optimization-with-customer-lifetime-value-and-retention-analysis-query-13-"></h2>
<strong>Use Case:</strong> <strong>Optimize monthly parking pricing to maximize customer lifetime value and retention.</strong>
<strong>Description:</strong> Optimizes monthly parking pricing using CTEs for customer segmentation, lifetime value calculations, retention analysis, and pricing optimization.
<strong>Use Case:</strong> Optimize monthly parking pricing to maximize customer lifetime value and retention.
<strong>Business Value:</strong> Monthly parking optimization report with CLV analysis and retention strategies.
<strong>Purpose:</strong> Enables data-driven decision making through advanced analytics and business intelligence.
<strong>Complexity:</strong> Customer segmentation CTEs (7+ levels), CLV calculations, retention modeling, pricing optimization
<strong>Expected Output:</strong> Query results with analysis and recommendations.
<pre><code class="language-sql">WITH facility_base_data AS (
<p>
SELECT
pf.facility_id,
pf.facility_name,
pf.city_id,
pf.total_spaces,
pf.facility_type,
pf.operator_type,
pf.latitude,
pf.longitude,
pf.is_event_parking,
pf.is_monthly_parking,
pf.accepts_reservations,
c.city_name,
c.state_code,
c.population,
c.population_density,
c.median_household_income,
c.employment_total,
ma.msa_name,
ma.gdp_billions,
ma.population_estimate AS msa_population
FROM parking_facilities pf
INNER JOIN cities c ON pf.city_id = c.city_id
INNER JOIN metropolitan_areas ma ON c.msa_id = ma.msa_id
WHERE pf.is_hourly_parking = TRUE
),
utilization_aggregations AS (
SELECT
pu.facility_id,
pu.utilization_date,
pu.utilization_hour,
AVG(pu.occupancy_rate) AS avg_occupancy_rate,
PERCENTILE_CONT(0.5) WITHIN GROUP (ORDER BY pu.occupancy_rate) AS median_occupancy_rate,
PERCENTILE_CONT(0.75) WITHIN GROUP (ORDER BY pu.occupancy_rate) AS p75_occupancy_rate,
PERCENTILE_CONT(0.95) WITHIN GROUP (ORDER BY pu.occupancy_rate) AS p95_occupancy_rate,
SUM(pu.revenue_generated) AS total_revenue,
AVG(pu.revenue_generated) AS avg_revenue_per_record,
COUNT(*) AS utilization_records,
COUNT(DISTINCT pu.utilization_date) AS days_with_data,
DATE_PART('dow', pu.utilization_date) AS day_of_week
FROM parking_utilization pu
WHERE pu.utilization_date &gt;= CURRENT_DATE - INTERVAL '90 days'
GROUP BY pu.facility_id, pu.utilization_date, pu.utilization_hour, DATE_PART('dow', pu.utilization_date)
),
pricing_analysis AS (
SELECT
pp.facility_id,
AVG(pp.base_rate_hourly) AS avg_hourly_rate,
AVG(pp.base_rate_daily) AS avg_daily_rate,
AVG(pp.base_rate_monthly) AS avg_monthly_rate,
MIN(pp.base_rate_hourly) AS min_hourly_rate,
MAX(pp.base_rate_hourly) AS max_hourly_rate,
PERCENTILE_CONT(0.5) WITHIN GROUP (ORDER BY pp.base_rate_hourly) AS median_hourly_rate,
PERCENTILE_CONT(0.75) WITHIN GROUP (ORDER BY pp.base_rate_hourly) AS p75_hourly_rate,
COUNT(*) AS pricing_records
FROM parking_pricing pp
WHERE pp.is_active = TRUE
AND pp.pricing_type IN ('Hourly', 'Daily', 'Monthly')
GROUP BY pp.facility_id
),
competitive_landscape AS (
SELECT
fbd1.facility_id,
fbd1.city_id,
COUNT(DISTINCT fbd2.facility_id) AS competitor_count,
AVG(fbd2.total_spaces) AS avg_competitor_spaces,
SUM(fbd2.total_spaces) AS total_competitor_spaces,
AVG(pa2.avg_hourly_rate) AS avg_competitor_rate,
MIN(pa2.avg_hourly_rate) AS min_competitor_rate,
MAX(pa2.avg_hourly_rate) AS max_competitor_rate,
PERCENTILE_CONT(0.5) WITHIN GROUP (ORDER BY pa2.avg_hourly_rate) AS median_competitor_rate,
AVG(
CASE
WHEN ST_DISTANCE(
ST_POINT(fbd1.longitude, fbd1.latitude),
ST_POINT(fbd2.longitude, fbd2.latitude)
) &lt; 500 THEN ST_DISTANCE(
ST_POINT(fbd1.longitude, fbd1.latitude),
ST_POINT(fbd2.longitude, fbd2.latitude)
)
ELSE NULL
END
) AS avg_distance_to_competitors
FROM facility_base_data fbd1
LEFT JOIN facility_base_data fbd2 ON fbd1.city_id = fbd2.city_id
AND fbd2.facility_id != fbd1.facility_id
AND ST_DISTANCE(
ST_POINT(fbd1.longitude, fbd1.latitude),
ST_POINT(fbd2.longitude, fbd2.latitude)
) &lt; 1000
LEFT JOIN pricing_analysis pa2 ON fbd2.facility_id = pa2.facility_id
GROUP BY fbd1.facility_id, fbd1.city_id, fbd1.latitude, fbd1.longitude
),
market_intelligence AS (
SELECT
fbd.facility_id,
fbd.facility_name,
fbd.city_id,
fbd.city_name,
fbd.state_code,
fbd.msa_name,
fbd.total_spaces,
fbd.facility_type,
fbd.operator_type,
fbd.population,
fbd.population_density,
fbd.median_household_income,
fbd.msa_population,
COALESCE(ua.avg_occupancy_rate, 0) AS avg_occupancy_rate,
COALESCE(ua.median_occupancy_rate, 0) AS median_occupancy_rate,
COALESCE(ua.p95_occupancy_rate, 0) AS p95_occupancy_rate,
COALESCE(ua.total_revenue, 0) AS total_revenue,
COALESCE(ua.avg_revenue_per_record, 0) AS avg_revenue_per_record,
COALESCE(ua.days_with_data, 0) AS days_with_data,
COALESCE(pa.avg_hourly_rate, 0) AS avg_hourly_rate,
COALESCE(pa.median_hourly_rate, 0) AS median_hourly_rate,
COALESCE(pa.p75_hourly_rate, 0) AS p75_hourly_rate,
COALESCE(cl.competitor_count, 0) AS competitor_count,
COALESCE(cl.avg_competitor_rate, 0) AS avg_competitor_rate,
COALESCE(cl.median_competitor_rate, 0) AS median_competitor_rate,
COALESCE(cl.avg_distance_to_competitors, 0) AS avg_distance_to_competitors,
-- Market opportunity score
(
LEAST(fbd.population_density / 10000.0, 1.0) * 25 +
LEAST(COALESCE(ua.avg_occupancy_rate, 0) / 100.0, 1.0) * 25 +
LEAST(fbd.median_household_income / 100000.0, 1.0) * 20 +
LEAST(COALESCE(cl.competitor_count, 0) / 10.0, 1.0) * 15 +
LEAST(fbd.total_spaces / 500.0, 1.0) * 15
) AS market_opportunity_score,
-- Competitive advantage score
(
CASE WHEN COALESCE(pa.avg_hourly_rate, 0) &lt; COALESCE(cl.avg_competitor_rate, 999) THEN 30 ELSE 0 END +
CASE WHEN COALESCE(ua.avg_occupancy_rate, 0) &gt; 80 THEN 25 ELSE COALESCE(ua.avg_occupancy_rate, 0) * 0.3125 END +
CASE WHEN COALESCE(cl.competitor_count, 0) &lt; 3 THEN 25 ELSE GREATEST(25 - COALESCE(cl.competitor_count, 0) * 2, 0) END +
CASE WHEN fbd.accepts_reservations THEN 20 ELSE 0 END
) AS competitive_advantage_score
FROM facility_base_data fbd
LEFT JOIN utilization_aggregations ua ON fbd.facility_id = ua.facility_id
LEFT JOIN pricing_analysis pa ON fbd.facility_id = pa.facility_id
LEFT JOIN competitive_landscape cl ON fbd.facility_id = cl.facility_id
),
ranked_analysis AS (
SELECT
mi.*,
ROW_NUMBER() OVER (PARTITION BY mi.city_id ORDER BY mi.market_opportunity_score DESC) AS city_rank,
ROW_NUMBER() OVER (ORDER BY mi.total_revenue DESC) AS revenue_rank,
ROW_NUMBER() OVER (ORDER BY mi.competitive_advantage_score DESC) AS competitive_rank,
PERCENT_RANK() OVER (ORDER BY mi.market_opportunity_score) AS opportunity_percentile,
PERCENT_RANK() OVER (ORDER BY mi.total_revenue) AS revenue_percentile,
PERCENT_RANK() OVER (ORDER BY mi.competitive_advantage_score) AS competitive_percentile,
LAG(mi.market_opportunity_score) OVER (ORDER BY mi.market_opportunity_score DESC) AS prev_opportunity_score,
LEAD(mi.market_opportunity_score) OVER (ORDER BY mi.market_opportunity_score DESC) AS next_opportunity_score,
AVG(mi.market_opportunity_score) OVER (PARTITION BY mi.city_id) AS city_avg_opportunity_score,
STDDEV(mi.market_opportunity_score) OVER (PARTITION BY mi.city_id) AS city_stddev_opportunity_score,
AVG(mi.total_revenue) OVER (PARTITION BY mi.city_id) AS city_avg_revenue,
AVG(mi.avg_occupancy_rate) OVER (PARTITION BY mi.city_id) AS city_avg_occupancy_rate
FROM market_intelligence mi
),
optimization_recommendations AS (
SELECT
ra.*,
CASE
WHEN ra.market_opportunity_score &gt;= ra.city_avg_opportunity_score + ra.city_stddev_opportunity_score THEN 'High Priority'
WHEN ra.market_opportunity_score &gt;= ra.city_avg_opportunity_score THEN 'Medium Priority'
ELSE 'Low Priority'
END AS optimization_priority,
CASE
WHEN ra.avg_occupancy_rate &gt; 85 AND ra.avg_hourly_rate &lt; ra.avg_competitor_rate THEN
ra.avg_hourly_rate * 1.15  -- Increase price if high demand and underpriced
WHEN ra.avg_occupancy_rate &lt; 50 AND ra.avg_hourly_rate &gt; ra.avg_competitor_rate THEN
ra.avg_hourly_rate * 0.90  -- Decrease price if low demand and overpriced
WHEN ra.avg_hourly_rate &lt; ra.median_competitor_rate * 0.9 THEN
ra.median_competitor_rate * 0.95  -- Price slightly below median if significantly underpriced
ELSE ra.avg_hourly_rate  -- Keep current price
END AS recommended_rate,
-- Revenue impact estimate
(
CASE
WHEN ra.avg_occupancy_rate &gt; 85 AND ra.avg_hourly_rate &lt; ra.avg_competitor_rate THEN
ra.avg_hourly_rate * 1.15 * ra.total_spaces * ra.avg_occupancy_rate / 100.0 * ra.days_with_data
WHEN ra.avg_occupancy_rate &lt; 50 AND ra.avg_hourly_rate &gt; ra.avg_competitor_rate THEN
ra.avg_hourly_rate * 0.90 * ra.total_spaces * ra.avg_occupancy_rate / 100.0 * ra.days_with_data
ELSE ra.total_revenue
END - ra.total_revenue
) AS estimated_revenue_impact,
-- Market share estimate
CASE
WHEN ra.competitor_count &gt; 0 AND ra.total_spaces &gt; 0 THEN
(ra.total_spaces * ra.avg_occupancy_rate / 100.0) /
NULLIF(
(ra.total_spaces * ra.avg_occupancy_rate / 100.0) +
(ra.competitor_count * COALESCE(ra.avg_competitor_rate, 0) * 50),  -- Estimate competitor spaces
1
) * 100
ELSE 100.0
END AS estimated_market_share_pct
FROM ranked_analysis ra
)
SELECT
or_rec.facility_id,
or_rec.facility_name,
or_rec.city_name,
or_rec.state_code,
or_rec.msa_name,
or_rec.total_spaces,
or_rec.facility_type,
or_rec.operator_type,
or_rec.avg_occupancy_rate,
or_rec.median_occupancy_rate,
or_rec.p95_occupancy_rate,
or_rec.total_revenue,
or_rec.avg_hourly_rate AS current_rate,
or_rec.recommended_rate,
or_rec.competitor_count,
or_rec.avg_competitor_rate,
or_rec.median_competitor_rate,
or_rec.market_opportunity_score,
or_rec.competitive_advantage_score,
or_rec.opportunity_percentile,
or_rec.revenue_percentile,
or_rec.competitive_percentile,
or_rec.optimization_priority,
or_rec.estimated_revenue_impact,
or_rec.estimated_market_share_pct,
CASE
WHEN or_rec.estimated_revenue_impact &gt; 1000 THEN 'High Impact'
WHEN or_rec.estimated_revenue_impact &gt; 0 THEN 'Medium Impact'
ELSE 'Low Impact'
END AS impact_category
FROM optimization_recommendations or_rec
WHERE or_rec.competitor_count &gt; 0 OR or_rec.total_revenue &gt; 0
ORDER BY or_rec.market_opportunity_score DESC, or_rec.total_revenue DESC
LIMIT 200;
</p>
</code></pre>
<p>
---
</p>
<h2 id="query-14-ev-charging-facility-analysis-with-demand-forecasting-and-revenue-impact-modeling-query-14-"></h2>
<strong>Use Case:</strong> <strong>Plan EV charging facility expansion and optimize revenue from EV charging services.</strong>
<strong>Description:</strong> Analyzes EV charging facilities using multi-level CTEs, demand forecasting, revenue impact calculations, and expansion recommendations.
<strong>Use Case:</strong> Plan EV charging facility expansion and optimize revenue from EV charging services.
<strong>Business Value:</strong> EV charging analysis report with demand forecasts and expansion recommendations.
<strong>Purpose:</strong> Enables data-driven decision making through advanced analytics and business intelligence.
<strong>Complexity:</strong> Multi-level CTEs (6+ levels), demand forecasting, revenue impact modeling, expansion analysis
<strong>Expected Output:</strong> Query results with analysis and recommendations.
<pre><code class="language-sql">WITH facility_base_data AS (
<p>
SELECT
pf.facility_id,
pf.facility_name,
pf.city_id,
pf.total_spaces,
pf.facility_type,
pf.operator_type,
pf.latitude,
pf.longitude,
pf.is_event_parking,
pf.is_monthly_parking,
pf.accepts_reservations,
c.city_name,
c.state_code,
c.population,
c.population_density,
c.median_household_income,
c.employment_total,
ma.msa_name,
ma.gdp_billions,
ma.population_estimate AS msa_population
FROM parking_facilities pf
INNER JOIN cities c ON pf.city_id = c.city_id
INNER JOIN metropolitan_areas ma ON c.msa_id = ma.msa_id
WHERE pf.is_hourly_parking = TRUE
),
utilization_aggregations AS (
SELECT
pu.facility_id,
pu.utilization_date,
pu.utilization_hour,
AVG(pu.occupancy_rate) AS avg_occupancy_rate,
PERCENTILE_CONT(0.5) WITHIN GROUP (ORDER BY pu.occupancy_rate) AS median_occupancy_rate,
PERCENTILE_CONT(0.75) WITHIN GROUP (ORDER BY pu.occupancy_rate) AS p75_occupancy_rate,
PERCENTILE_CONT(0.95) WITHIN GROUP (ORDER BY pu.occupancy_rate) AS p95_occupancy_rate,
SUM(pu.revenue_generated) AS total_revenue,
AVG(pu.revenue_generated) AS avg_revenue_per_record,
COUNT(*) AS utilization_records,
COUNT(DISTINCT pu.utilization_date) AS days_with_data,
DATE_PART('dow', pu.utilization_date) AS day_of_week
FROM parking_utilization pu
WHERE pu.utilization_date &gt;= CURRENT_DATE - INTERVAL '90 days'
GROUP BY pu.facility_id, pu.utilization_date, pu.utilization_hour, DATE_PART('dow', pu.utilization_date)
),
pricing_analysis AS (
SELECT
pp.facility_id,
AVG(pp.base_rate_hourly) AS avg_hourly_rate,
AVG(pp.base_rate_daily) AS avg_daily_rate,
AVG(pp.base_rate_monthly) AS avg_monthly_rate,
MIN(pp.base_rate_hourly) AS min_hourly_rate,
MAX(pp.base_rate_hourly) AS max_hourly_rate,
PERCENTILE_CONT(0.5) WITHIN GROUP (ORDER BY pp.base_rate_hourly) AS median_hourly_rate,
PERCENTILE_CONT(0.75) WITHIN GROUP (ORDER BY pp.base_rate_hourly) AS p75_hourly_rate,
COUNT(*) AS pricing_records
FROM parking_pricing pp
WHERE pp.is_active = TRUE
AND pp.pricing_type IN ('Hourly', 'Daily', 'Monthly')
GROUP BY pp.facility_id
),
competitive_landscape AS (
SELECT
fbd1.facility_id,
fbd1.city_id,
COUNT(DISTINCT fbd2.facility_id) AS competitor_count,
AVG(fbd2.total_spaces) AS avg_competitor_spaces,
SUM(fbd2.total_spaces) AS total_competitor_spaces,
AVG(pa2.avg_hourly_rate) AS avg_competitor_rate,
MIN(pa2.avg_hourly_rate) AS min_competitor_rate,
MAX(pa2.avg_hourly_rate) AS max_competitor_rate,
PERCENTILE_CONT(0.5) WITHIN GROUP (ORDER BY pa2.avg_hourly_rate) AS median_competitor_rate,
AVG(
CASE
WHEN ST_DISTANCE(
ST_POINT(fbd1.longitude, fbd1.latitude),
ST_POINT(fbd2.longitude, fbd2.latitude)
) &lt; 500 THEN ST_DISTANCE(
ST_POINT(fbd1.longitude, fbd1.latitude),
ST_POINT(fbd2.longitude, fbd2.latitude)
)
ELSE NULL
END
) AS avg_distance_to_competitors
FROM facility_base_data fbd1
LEFT JOIN facility_base_data fbd2 ON fbd1.city_id = fbd2.city_id
AND fbd2.facility_id != fbd1.facility_id
AND ST_DISTANCE(
ST_POINT(fbd1.longitude, fbd1.latitude),
ST_POINT(fbd2.longitude, fbd2.latitude)
) &lt; 1000
LEFT JOIN pricing_analysis pa2 ON fbd2.facility_id = pa2.facility_id
GROUP BY fbd1.facility_id, fbd1.city_id, fbd1.latitude, fbd1.longitude
),
market_intelligence AS (
SELECT
fbd.facility_id,
fbd.facility_name,
fbd.city_id,
fbd.city_name,
fbd.state_code,
fbd.msa_name,
fbd.total_spaces,
fbd.facility_type,
fbd.operator_type,
fbd.population,
fbd.population_density,
fbd.median_household_income,
fbd.msa_population,
COALESCE(ua.avg_occupancy_rate, 0) AS avg_occupancy_rate,
COALESCE(ua.median_occupancy_rate, 0) AS median_occupancy_rate,
COALESCE(ua.p95_occupancy_rate, 0) AS p95_occupancy_rate,
COALESCE(ua.total_revenue, 0) AS total_revenue,
COALESCE(ua.avg_revenue_per_record, 0) AS avg_revenue_per_record,
COALESCE(ua.days_with_data, 0) AS days_with_data,
COALESCE(pa.avg_hourly_rate, 0) AS avg_hourly_rate,
COALESCE(pa.median_hourly_rate, 0) AS median_hourly_rate,
COALESCE(pa.p75_hourly_rate, 0) AS p75_hourly_rate,
COALESCE(cl.competitor_count, 0) AS competitor_count,
COALESCE(cl.avg_competitor_rate, 0) AS avg_competitor_rate,
COALESCE(cl.median_competitor_rate, 0) AS median_competitor_rate,
COALESCE(cl.avg_distance_to_competitors, 0) AS avg_distance_to_competitors,
-- Market opportunity score
(
LEAST(fbd.population_density / 10000.0, 1.0) * 25 +
LEAST(COALESCE(ua.avg_occupancy_rate, 0) / 100.0, 1.0) * 25 +
LEAST(fbd.median_household_income / 100000.0, 1.0) * 20 +
LEAST(COALESCE(cl.competitor_count, 0) / 10.0, 1.0) * 15 +
LEAST(fbd.total_spaces / 500.0, 1.0) * 15
) AS market_opportunity_score,
-- Competitive advantage score
(
CASE WHEN COALESCE(pa.avg_hourly_rate, 0) &lt; COALESCE(cl.avg_competitor_rate, 999) THEN 30 ELSE 0 END +
CASE WHEN COALESCE(ua.avg_occupancy_rate, 0) &gt; 80 THEN 25 ELSE COALESCE(ua.avg_occupancy_rate, 0) * 0.3125 END +
CASE WHEN COALESCE(cl.competitor_count, 0) &lt; 3 THEN 25 ELSE GREATEST(25 - COALESCE(cl.competitor_count, 0) * 2, 0) END +
CASE WHEN fbd.accepts_reservations THEN 20 ELSE 0 END
) AS competitive_advantage_score
FROM facility_base_data fbd
LEFT JOIN utilization_aggregations ua ON fbd.facility_id = ua.facility_id
LEFT JOIN pricing_analysis pa ON fbd.facility_id = pa.facility_id
LEFT JOIN competitive_landscape cl ON fbd.facility_id = cl.facility_id
),
ranked_analysis AS (
SELECT
mi.*,
ROW_NUMBER() OVER (PARTITION BY mi.city_id ORDER BY mi.market_opportunity_score DESC) AS city_rank,
ROW_NUMBER() OVER (ORDER BY mi.total_revenue DESC) AS revenue_rank,
ROW_NUMBER() OVER (ORDER BY mi.competitive_advantage_score DESC) AS competitive_rank,
PERCENT_RANK() OVER (ORDER BY mi.market_opportunity_score) AS opportunity_percentile,
PERCENT_RANK() OVER (ORDER BY mi.total_revenue) AS revenue_percentile,
PERCENT_RANK() OVER (ORDER BY mi.competitive_advantage_score) AS competitive_percentile,
LAG(mi.market_opportunity_score) OVER (ORDER BY mi.market_opportunity_score DESC) AS prev_opportunity_score,
LEAD(mi.market_opportunity_score) OVER (ORDER BY mi.market_opportunity_score DESC) AS next_opportunity_score,
AVG(mi.market_opportunity_score) OVER (PARTITION BY mi.city_id) AS city_avg_opportunity_score,
STDDEV(mi.market_opportunity_score) OVER (PARTITION BY mi.city_id) AS city_stddev_opportunity_score,
AVG(mi.total_revenue) OVER (PARTITION BY mi.city_id) AS city_avg_revenue,
AVG(mi.avg_occupancy_rate) OVER (PARTITION BY mi.city_id) AS city_avg_occupancy_rate
FROM market_intelligence mi
),
optimization_recommendations AS (
SELECT
ra.*,
CASE
WHEN ra.market_opportunity_score &gt;= ra.city_avg_opportunity_score + ra.city_stddev_opportunity_score THEN 'High Priority'
WHEN ra.market_opportunity_score &gt;= ra.city_avg_opportunity_score THEN 'Medium Priority'
ELSE 'Low Priority'
END AS optimization_priority,
CASE
WHEN ra.avg_occupancy_rate &gt; 85 AND ra.avg_hourly_rate &lt; ra.avg_competitor_rate THEN
ra.avg_hourly_rate * 1.15  -- Increase price if high demand and underpriced
WHEN ra.avg_occupancy_rate &lt; 50 AND ra.avg_hourly_rate &gt; ra.avg_competitor_rate THEN
ra.avg_hourly_rate * 0.90  -- Decrease price if low demand and overpriced
WHEN ra.avg_hourly_rate &lt; ra.median_competitor_rate * 0.9 THEN
ra.median_competitor_rate * 0.95  -- Price slightly below median if significantly underpriced
ELSE ra.avg_hourly_rate  -- Keep current price
END AS recommended_rate,
-- Revenue impact estimate
(
CASE
WHEN ra.avg_occupancy_rate &gt; 85 AND ra.avg_hourly_rate &lt; ra.avg_competitor_rate THEN
ra.avg_hourly_rate * 1.15 * ra.total_spaces * ra.avg_occupancy_rate / 100.0 * ra.days_with_data
WHEN ra.avg_occupancy_rate &lt; 50 AND ra.avg_hourly_rate &gt; ra.avg_competitor_rate THEN
ra.avg_hourly_rate * 0.90 * ra.total_spaces * ra.avg_occupancy_rate / 100.0 * ra.days_with_data
ELSE ra.total_revenue
END - ra.total_revenue
) AS estimated_revenue_impact,
-- Market share estimate
CASE
WHEN ra.competitor_count &gt; 0 AND ra.total_spaces &gt; 0 THEN
(ra.total_spaces * ra.avg_occupancy_rate / 100.0) /
NULLIF(
(ra.total_spaces * ra.avg_occupancy_rate / 100.0) +
(ra.competitor_count * COALESCE(ra.avg_competitor_rate, 0) * 50),  -- Estimate competitor spaces
1
) * 100
ELSE 100.0
END AS estimated_market_share_pct
FROM ranked_analysis ra
)
SELECT
or_rec.facility_id,
or_rec.facility_name,
or_rec.city_name,
or_rec.state_code,
or_rec.msa_name,
or_rec.total_spaces,
or_rec.facility_type,
or_rec.operator_type,
or_rec.avg_occupancy_rate,
or_rec.median_occupancy_rate,
or_rec.p95_occupancy_rate,
or_rec.total_revenue,
or_rec.avg_hourly_rate AS current_rate,
or_rec.recommended_rate,
or_rec.competitor_count,
or_rec.avg_competitor_rate,
or_rec.median_competitor_rate,
or_rec.market_opportunity_score,
or_rec.competitive_advantage_score,
or_rec.opportunity_percentile,
or_rec.revenue_percentile,
or_rec.competitive_percentile,
or_rec.optimization_priority,
or_rec.estimated_revenue_impact,
or_rec.estimated_market_share_pct,
CASE
WHEN or_rec.estimated_revenue_impact &gt; 1000 THEN 'High Impact'
WHEN or_rec.estimated_revenue_impact &gt; 0 THEN 'Medium Impact'
ELSE 'Low Impact'
END AS impact_category
FROM optimization_recommendations or_rec
WHERE or_rec.competitor_count &gt; 0 OR or_rec.total_revenue &gt; 0
ORDER BY or_rec.market_opportunity_score DESC, or_rec.total_revenue DESC
LIMIT 200;
</p>
</code></pre>
<p>
---
</p>
<h2 id="query-15-reservation-vs-walk-in-analysis-with-revenue-optimization-and-capacity-planning-query-15-"></h2>
<strong>Use Case:</strong> <strong>Optimize reservation vs walk-in mix to maximize revenue and capacity utilization.</strong>
<strong>Description:</strong> Compares reservation and walk-in patterns using CTEs for pattern analysis, revenue comparison, capacity optimization, and booking strategy recommendations.
<strong>Use Case:</strong> Optimize reservation vs walk-in mix to maximize revenue and capacity utilization.
<strong>Business Value:</strong> Reservation analysis report with revenue optimization and capacity planning recommendations.
<strong>Purpose:</strong> Enables data-driven decision making through advanced analytics and business intelligence.
<strong>Complexity:</strong> Pattern analysis CTEs (6+ levels), revenue comparison, capacity optimization, booking strategies
<strong>Expected Output:</strong> Query results with analysis and recommendations.
<pre><code class="language-sql">WITH facility_base_data AS (
<p>
SELECT
pf.facility_id,
pf.facility_name,
pf.city_id,
pf.total_spaces,
pf.facility_type,
pf.operator_type,
pf.latitude,
pf.longitude,
pf.is_event_parking,
pf.is_monthly_parking,
pf.accepts_reservations,
c.city_name,
c.state_code,
c.population,
c.population_density,
c.median_household_income,
c.employment_total,
ma.msa_name,
ma.gdp_billions,
ma.population_estimate AS msa_population
FROM parking_facilities pf
INNER JOIN cities c ON pf.city_id = c.city_id
INNER JOIN metropolitan_areas ma ON c.msa_id = ma.msa_id
WHERE pf.is_hourly_parking = TRUE
),
utilization_aggregations AS (
SELECT
pu.facility_id,
pu.utilization_date,
pu.utilization_hour,
AVG(pu.occupancy_rate) AS avg_occupancy_rate,
PERCENTILE_CONT(0.5) WITHIN GROUP (ORDER BY pu.occupancy_rate) AS median_occupancy_rate,
PERCENTILE_CONT(0.75) WITHIN GROUP (ORDER BY pu.occupancy_rate) AS p75_occupancy_rate,
PERCENTILE_CONT(0.95) WITHIN GROUP (ORDER BY pu.occupancy_rate) AS p95_occupancy_rate,
SUM(pu.revenue_generated) AS total_revenue,
AVG(pu.revenue_generated) AS avg_revenue_per_record,
COUNT(*) AS utilization_records,
COUNT(DISTINCT pu.utilization_date) AS days_with_data,
DATE_PART('dow', pu.utilization_date) AS day_of_week
FROM parking_utilization pu
WHERE pu.utilization_date &gt;= CURRENT_DATE - INTERVAL '90 days'
GROUP BY pu.facility_id, pu.utilization_date, pu.utilization_hour, DATE_PART('dow', pu.utilization_date)
),
pricing_analysis AS (
SELECT
pp.facility_id,
AVG(pp.base_rate_hourly) AS avg_hourly_rate,
AVG(pp.base_rate_daily) AS avg_daily_rate,
AVG(pp.base_rate_monthly) AS avg_monthly_rate,
MIN(pp.base_rate_hourly) AS min_hourly_rate,
MAX(pp.base_rate_hourly) AS max_hourly_rate,
PERCENTILE_CONT(0.5) WITHIN GROUP (ORDER BY pp.base_rate_hourly) AS median_hourly_rate,
PERCENTILE_CONT(0.75) WITHIN GROUP (ORDER BY pp.base_rate_hourly) AS p75_hourly_rate,
COUNT(*) AS pricing_records
FROM parking_pricing pp
WHERE pp.is_active = TRUE
AND pp.pricing_type IN ('Hourly', 'Daily', 'Monthly')
GROUP BY pp.facility_id
),
competitive_landscape AS (
SELECT
fbd1.facility_id,
fbd1.city_id,
COUNT(DISTINCT fbd2.facility_id) AS competitor_count,
AVG(fbd2.total_spaces) AS avg_competitor_spaces,
SUM(fbd2.total_spaces) AS total_competitor_spaces,
AVG(pa2.avg_hourly_rate) AS avg_competitor_rate,
MIN(pa2.avg_hourly_rate) AS min_competitor_rate,
MAX(pa2.avg_hourly_rate) AS max_competitor_rate,
PERCENTILE_CONT(0.5) WITHIN GROUP (ORDER BY pa2.avg_hourly_rate) AS median_competitor_rate,
AVG(
CASE
WHEN ST_DISTANCE(
ST_POINT(fbd1.longitude, fbd1.latitude),
ST_POINT(fbd2.longitude, fbd2.latitude)
) &lt; 500 THEN ST_DISTANCE(
ST_POINT(fbd1.longitude, fbd1.latitude),
ST_POINT(fbd2.longitude, fbd2.latitude)
)
ELSE NULL
END
) AS avg_distance_to_competitors
FROM facility_base_data fbd1
LEFT JOIN facility_base_data fbd2 ON fbd1.city_id = fbd2.city_id
AND fbd2.facility_id != fbd1.facility_id
AND ST_DISTANCE(
ST_POINT(fbd1.longitude, fbd1.latitude),
ST_POINT(fbd2.longitude, fbd2.latitude)
) &lt; 1000
LEFT JOIN pricing_analysis pa2 ON fbd2.facility_id = pa2.facility_id
GROUP BY fbd1.facility_id, fbd1.city_id, fbd1.latitude, fbd1.longitude
),
market_intelligence AS (
SELECT
fbd.facility_id,
fbd.facility_name,
fbd.city_id,
fbd.city_name,
fbd.state_code,
fbd.msa_name,
fbd.total_spaces,
fbd.facility_type,
fbd.operator_type,
fbd.population,
fbd.population_density,
fbd.median_household_income,
fbd.msa_population,
COALESCE(ua.avg_occupancy_rate, 0) AS avg_occupancy_rate,
COALESCE(ua.median_occupancy_rate, 0) AS median_occupancy_rate,
COALESCE(ua.p95_occupancy_rate, 0) AS p95_occupancy_rate,
COALESCE(ua.total_revenue, 0) AS total_revenue,
COALESCE(ua.avg_revenue_per_record, 0) AS avg_revenue_per_record,
COALESCE(ua.days_with_data, 0) AS days_with_data,
COALESCE(pa.avg_hourly_rate, 0) AS avg_hourly_rate,
COALESCE(pa.median_hourly_rate, 0) AS median_hourly_rate,
COALESCE(pa.p75_hourly_rate, 0) AS p75_hourly_rate,
COALESCE(cl.competitor_count, 0) AS competitor_count,
COALESCE(cl.avg_competitor_rate, 0) AS avg_competitor_rate,
COALESCE(cl.median_competitor_rate, 0) AS median_competitor_rate,
COALESCE(cl.avg_distance_to_competitors, 0) AS avg_distance_to_competitors,
-- Market opportunity score
(
LEAST(fbd.population_density / 10000.0, 1.0) * 25 +
LEAST(COALESCE(ua.avg_occupancy_rate, 0) / 100.0, 1.0) * 25 +
LEAST(fbd.median_household_income / 100000.0, 1.0) * 20 +
LEAST(COALESCE(cl.competitor_count, 0) / 10.0, 1.0) * 15 +
LEAST(fbd.total_spaces / 500.0, 1.0) * 15
) AS market_opportunity_score,
-- Competitive advantage score
(
CASE WHEN COALESCE(pa.avg_hourly_rate, 0) &lt; COALESCE(cl.avg_competitor_rate, 999) THEN 30 ELSE 0 END +
CASE WHEN COALESCE(ua.avg_occupancy_rate, 0) &gt; 80 THEN 25 ELSE COALESCE(ua.avg_occupancy_rate, 0) * 0.3125 END +
CASE WHEN COALESCE(cl.competitor_count, 0) &lt; 3 THEN 25 ELSE GREATEST(25 - COALESCE(cl.competitor_count, 0) * 2, 0) END +
CASE WHEN fbd.accepts_reservations THEN 20 ELSE 0 END
) AS competitive_advantage_score
FROM facility_base_data fbd
LEFT JOIN utilization_aggregations ua ON fbd.facility_id = ua.facility_id
LEFT JOIN pricing_analysis pa ON fbd.facility_id = pa.facility_id
LEFT JOIN competitive_landscape cl ON fbd.facility_id = cl.facility_id
),
ranked_analysis AS (
SELECT
mi.*,
ROW_NUMBER() OVER (PARTITION BY mi.city_id ORDER BY mi.market_opportunity_score DESC) AS city_rank,
ROW_NUMBER() OVER (ORDER BY mi.total_revenue DESC) AS revenue_rank,
ROW_NUMBER() OVER (ORDER BY mi.competitive_advantage_score DESC) AS competitive_rank,
PERCENT_RANK() OVER (ORDER BY mi.market_opportunity_score) AS opportunity_percentile,
PERCENT_RANK() OVER (ORDER BY mi.total_revenue) AS revenue_percentile,
PERCENT_RANK() OVER (ORDER BY mi.competitive_advantage_score) AS competitive_percentile,
LAG(mi.market_opportunity_score) OVER (ORDER BY mi.market_opportunity_score DESC) AS prev_opportunity_score,
LEAD(mi.market_opportunity_score) OVER (ORDER BY mi.market_opportunity_score DESC) AS next_opportunity_score,
AVG(mi.market_opportunity_score) OVER (PARTITION BY mi.city_id) AS city_avg_opportunity_score,
STDDEV(mi.market_opportunity_score) OVER (PARTITION BY mi.city_id) AS city_stddev_opportunity_score,
AVG(mi.total_revenue) OVER (PARTITION BY mi.city_id) AS city_avg_revenue,
AVG(mi.avg_occupancy_rate) OVER (PARTITION BY mi.city_id) AS city_avg_occupancy_rate
FROM market_intelligence mi
),
optimization_recommendations AS (
SELECT
ra.*,
CASE
WHEN ra.market_opportunity_score &gt;= ra.city_avg_opportunity_score + ra.city_stddev_opportunity_score THEN 'High Priority'
WHEN ra.market_opportunity_score &gt;= ra.city_avg_opportunity_score THEN 'Medium Priority'
ELSE 'Low Priority'
END AS optimization_priority,
CASE
WHEN ra.avg_occupancy_rate &gt; 85 AND ra.avg_hourly_rate &lt; ra.avg_competitor_rate THEN
ra.avg_hourly_rate * 1.15  -- Increase price if high demand and underpriced
WHEN ra.avg_occupancy_rate &lt; 50 AND ra.avg_hourly_rate &gt; ra.avg_competitor_rate THEN
ra.avg_hourly_rate * 0.90  -- Decrease price if low demand and overpriced
WHEN ra.avg_hourly_rate &lt; ra.median_competitor_rate * 0.9 THEN
ra.median_competitor_rate * 0.95  -- Price slightly below median if significantly underpriced
ELSE ra.avg_hourly_rate  -- Keep current price
END AS recommended_rate,
-- Revenue impact estimate
(
CASE
WHEN ra.avg_occupancy_rate &gt; 85 AND ra.avg_hourly_rate &lt; ra.avg_competitor_rate THEN
ra.avg_hourly_rate * 1.15 * ra.total_spaces * ra.avg_occupancy_rate / 100.0 * ra.days_with_data
WHEN ra.avg_occupancy_rate &lt; 50 AND ra.avg_hourly_rate &gt; ra.avg_competitor_rate THEN
ra.avg_hourly_rate * 0.90 * ra.total_spaces * ra.avg_occupancy_rate / 100.0 * ra.days_with_data
ELSE ra.total_revenue
END - ra.total_revenue
) AS estimated_revenue_impact,
-- Market share estimate
CASE
WHEN ra.competitor_count &gt; 0 AND ra.total_spaces &gt; 0 THEN
(ra.total_spaces * ra.avg_occupancy_rate / 100.0) /
NULLIF(
(ra.total_spaces * ra.avg_occupancy_rate / 100.0) +
(ra.competitor_count * COALESCE(ra.avg_competitor_rate, 0) * 50),  -- Estimate competitor spaces
1
) * 100
ELSE 100.0
END AS estimated_market_share_pct
FROM ranked_analysis ra
)
SELECT
or_rec.facility_id,
or_rec.facility_name,
or_rec.city_name,
or_rec.state_code,
or_rec.msa_name,
or_rec.total_spaces,
or_rec.facility_type,
or_rec.operator_type,
or_rec.avg_occupancy_rate,
or_rec.median_occupancy_rate,
or_rec.p95_occupancy_rate,
or_rec.total_revenue,
or_rec.avg_hourly_rate AS current_rate,
or_rec.recommended_rate,
or_rec.competitor_count,
or_rec.avg_competitor_rate,
or_rec.median_competitor_rate,
or_rec.market_opportunity_score,
or_rec.competitive_advantage_score,
or_rec.opportunity_percentile,
or_rec.revenue_percentile,
or_rec.competitive_percentile,
or_rec.optimization_priority,
or_rec.estimated_revenue_impact,
or_rec.estimated_market_share_pct,
CASE
WHEN or_rec.estimated_revenue_impact &gt; 1000 THEN 'High Impact'
WHEN or_rec.estimated_revenue_impact &gt; 0 THEN 'Medium Impact'
ELSE 'Low Impact'
END AS impact_category
FROM optimization_recommendations or_rec
WHERE or_rec.competitor_count &gt; 0 OR or_rec.total_revenue &gt; 0
ORDER BY or_rec.market_opportunity_score DESC, or_rec.total_revenue DESC
LIMIT 200;
</p>
</code></pre>
<p>
---
</p>
<h2 id="query-16-peak-hour-analysis-with-dynamic-pricing-optimization-and-capacity-management-query-16-"></h2>
<strong>Use Case:</strong> <strong>Implement dynamic pricing and capacity management for peak hours to maximize revenue.</strong>
<strong>Description:</strong> Analyzes peak hour patterns using temporal CTEs, dynamic pricing models, capacity management algorithms, and revenue maximization strategies.
<strong>Use Case:</strong> Implement dynamic pricing and capacity management for peak hours to maximize revenue.
<strong>Business Value:</strong> Peak hour analysis report with dynamic pricing recommendations and capacity management strategies.
<strong>Purpose:</strong> Enables data-driven decision making through advanced analytics and business intelligence.
<strong>Complexity:</strong> Temporal CTEs (7+ levels), dynamic pricing models, capacity management, revenue optimization
<strong>Expected Output:</strong> Query results with analysis and recommendations.
<pre><code class="language-sql">WITH facility_base_data AS (
<p>
SELECT
pf.facility_id,
pf.facility_name,
pf.city_id,
pf.total_spaces,
pf.facility_type,
pf.operator_type,
pf.latitude,
pf.longitude,
pf.is_event_parking,
pf.is_monthly_parking,
pf.accepts_reservations,
c.city_name,
c.state_code,
c.population,
c.population_density,
c.median_household_income,
c.employment_total,
ma.msa_name,
ma.gdp_billions,
ma.population_estimate AS msa_population
FROM parking_facilities pf
INNER JOIN cities c ON pf.city_id = c.city_id
INNER JOIN metropolitan_areas ma ON c.msa_id = ma.msa_id
WHERE pf.is_hourly_parking = TRUE
),
utilization_aggregations AS (
SELECT
pu.facility_id,
pu.utilization_date,
pu.utilization_hour,
AVG(pu.occupancy_rate) AS avg_occupancy_rate,
PERCENTILE_CONT(0.5) WITHIN GROUP (ORDER BY pu.occupancy_rate) AS median_occupancy_rate,
PERCENTILE_CONT(0.75) WITHIN GROUP (ORDER BY pu.occupancy_rate) AS p75_occupancy_rate,
PERCENTILE_CONT(0.95) WITHIN GROUP (ORDER BY pu.occupancy_rate) AS p95_occupancy_rate,
SUM(pu.revenue_generated) AS total_revenue,
AVG(pu.revenue_generated) AS avg_revenue_per_record,
COUNT(*) AS utilization_records,
COUNT(DISTINCT pu.utilization_date) AS days_with_data,
DATE_PART('dow', pu.utilization_date) AS day_of_week
FROM parking_utilization pu
WHERE pu.utilization_date &gt;= CURRENT_DATE - INTERVAL '90 days'
GROUP BY pu.facility_id, pu.utilization_date, pu.utilization_hour, DATE_PART('dow', pu.utilization_date)
),
pricing_analysis AS (
SELECT
pp.facility_id,
AVG(pp.base_rate_hourly) AS avg_hourly_rate,
AVG(pp.base_rate_daily) AS avg_daily_rate,
AVG(pp.base_rate_monthly) AS avg_monthly_rate,
MIN(pp.base_rate_hourly) AS min_hourly_rate,
MAX(pp.base_rate_hourly) AS max_hourly_rate,
PERCENTILE_CONT(0.5) WITHIN GROUP (ORDER BY pp.base_rate_hourly) AS median_hourly_rate,
PERCENTILE_CONT(0.75) WITHIN GROUP (ORDER BY pp.base_rate_hourly) AS p75_hourly_rate,
COUNT(*) AS pricing_records
FROM parking_pricing pp
WHERE pp.is_active = TRUE
AND pp.pricing_type IN ('Hourly', 'Daily', 'Monthly')
GROUP BY pp.facility_id
),
competitive_landscape AS (
SELECT
fbd1.facility_id,
fbd1.city_id,
COUNT(DISTINCT fbd2.facility_id) AS competitor_count,
AVG(fbd2.total_spaces) AS avg_competitor_spaces,
SUM(fbd2.total_spaces) AS total_competitor_spaces,
AVG(pa2.avg_hourly_rate) AS avg_competitor_rate,
MIN(pa2.avg_hourly_rate) AS min_competitor_rate,
MAX(pa2.avg_hourly_rate) AS max_competitor_rate,
PERCENTILE_CONT(0.5) WITHIN GROUP (ORDER BY pa2.avg_hourly_rate) AS median_competitor_rate,
AVG(
CASE
WHEN ST_DISTANCE(
ST_POINT(fbd1.longitude, fbd1.latitude),
ST_POINT(fbd2.longitude, fbd2.latitude)
) &lt; 500 THEN ST_DISTANCE(
ST_POINT(fbd1.longitude, fbd1.latitude),
ST_POINT(fbd2.longitude, fbd2.latitude)
)
ELSE NULL
END
) AS avg_distance_to_competitors
FROM facility_base_data fbd1
LEFT JOIN facility_base_data fbd2 ON fbd1.city_id = fbd2.city_id
AND fbd2.facility_id != fbd1.facility_id
AND ST_DISTANCE(
ST_POINT(fbd1.longitude, fbd1.latitude),
ST_POINT(fbd2.longitude, fbd2.latitude)
) &lt; 1000
LEFT JOIN pricing_analysis pa2 ON fbd2.facility_id = pa2.facility_id
GROUP BY fbd1.facility_id, fbd1.city_id, fbd1.latitude, fbd1.longitude
),
market_intelligence AS (
SELECT
fbd.facility_id,
fbd.facility_name,
fbd.city_id,
fbd.city_name,
fbd.state_code,
fbd.msa_name,
fbd.total_spaces,
fbd.facility_type,
fbd.operator_type,
fbd.population,
fbd.population_density,
fbd.median_household_income,
fbd.msa_population,
COALESCE(ua.avg_occupancy_rate, 0) AS avg_occupancy_rate,
COALESCE(ua.median_occupancy_rate, 0) AS median_occupancy_rate,
COALESCE(ua.p95_occupancy_rate, 0) AS p95_occupancy_rate,
COALESCE(ua.total_revenue, 0) AS total_revenue,
COALESCE(ua.avg_revenue_per_record, 0) AS avg_revenue_per_record,
COALESCE(ua.days_with_data, 0) AS days_with_data,
COALESCE(pa.avg_hourly_rate, 0) AS avg_hourly_rate,
COALESCE(pa.median_hourly_rate, 0) AS median_hourly_rate,
COALESCE(pa.p75_hourly_rate, 0) AS p75_hourly_rate,
COALESCE(cl.competitor_count, 0) AS competitor_count,
COALESCE(cl.avg_competitor_rate, 0) AS avg_competitor_rate,
COALESCE(cl.median_competitor_rate, 0) AS median_competitor_rate,
COALESCE(cl.avg_distance_to_competitors, 0) AS avg_distance_to_competitors,
-- Market opportunity score
(
LEAST(fbd.population_density / 10000.0, 1.0) * 25 +
LEAST(COALESCE(ua.avg_occupancy_rate, 0) / 100.0, 1.0) * 25 +
LEAST(fbd.median_household_income / 100000.0, 1.0) * 20 +
LEAST(COALESCE(cl.competitor_count, 0) / 10.0, 1.0) * 15 +
LEAST(fbd.total_spaces / 500.0, 1.0) * 15
) AS market_opportunity_score,
-- Competitive advantage score
(
CASE WHEN COALESCE(pa.avg_hourly_rate, 0) &lt; COALESCE(cl.avg_competitor_rate, 999) THEN 30 ELSE 0 END +
CASE WHEN COALESCE(ua.avg_occupancy_rate, 0) &gt; 80 THEN 25 ELSE COALESCE(ua.avg_occupancy_rate, 0) * 0.3125 END +
CASE WHEN COALESCE(cl.competitor_count, 0) &lt; 3 THEN 25 ELSE GREATEST(25 - COALESCE(cl.competitor_count, 0) * 2, 0) END +
CASE WHEN fbd.accepts_reservations THEN 20 ELSE 0 END
) AS competitive_advantage_score
FROM facility_base_data fbd
LEFT JOIN utilization_aggregations ua ON fbd.facility_id = ua.facility_id
LEFT JOIN pricing_analysis pa ON fbd.facility_id = pa.facility_id
LEFT JOIN competitive_landscape cl ON fbd.facility_id = cl.facility_id
),
ranked_analysis AS (
SELECT
mi.*,
ROW_NUMBER() OVER (PARTITION BY mi.city_id ORDER BY mi.market_opportunity_score DESC) AS city_rank,
ROW_NUMBER() OVER (ORDER BY mi.total_revenue DESC) AS revenue_rank,
ROW_NUMBER() OVER (ORDER BY mi.competitive_advantage_score DESC) AS competitive_rank,
PERCENT_RANK() OVER (ORDER BY mi.market_opportunity_score) AS opportunity_percentile,
PERCENT_RANK() OVER (ORDER BY mi.total_revenue) AS revenue_percentile,
PERCENT_RANK() OVER (ORDER BY mi.competitive_advantage_score) AS competitive_percentile,
LAG(mi.market_opportunity_score) OVER (ORDER BY mi.market_opportunity_score DESC) AS prev_opportunity_score,
LEAD(mi.market_opportunity_score) OVER (ORDER BY mi.market_opportunity_score DESC) AS next_opportunity_score,
AVG(mi.market_opportunity_score) OVER (PARTITION BY mi.city_id) AS city_avg_opportunity_score,
STDDEV(mi.market_opportunity_score) OVER (PARTITION BY mi.city_id) AS city_stddev_opportunity_score,
AVG(mi.total_revenue) OVER (PARTITION BY mi.city_id) AS city_avg_revenue,
AVG(mi.avg_occupancy_rate) OVER (PARTITION BY mi.city_id) AS city_avg_occupancy_rate
FROM market_intelligence mi
),
optimization_recommendations AS (
SELECT
ra.*,
CASE
WHEN ra.market_opportunity_score &gt;= ra.city_avg_opportunity_score + ra.city_stddev_opportunity_score THEN 'High Priority'
WHEN ra.market_opportunity_score &gt;= ra.city_avg_opportunity_score THEN 'Medium Priority'
ELSE 'Low Priority'
END AS optimization_priority,
CASE
WHEN ra.avg_occupancy_rate &gt; 85 AND ra.avg_hourly_rate &lt; ra.avg_competitor_rate THEN
ra.avg_hourly_rate * 1.15  -- Increase price if high demand and underpriced
WHEN ra.avg_occupancy_rate &lt; 50 AND ra.avg_hourly_rate &gt; ra.avg_competitor_rate THEN
ra.avg_hourly_rate * 0.90  -- Decrease price if low demand and overpriced
WHEN ra.avg_hourly_rate &lt; ra.median_competitor_rate * 0.9 THEN
ra.median_competitor_rate * 0.95  -- Price slightly below median if significantly underpriced
ELSE ra.avg_hourly_rate  -- Keep current price
END AS recommended_rate,
-- Revenue impact estimate
(
CASE
WHEN ra.avg_occupancy_rate &gt; 85 AND ra.avg_hourly_rate &lt; ra.avg_competitor_rate THEN
ra.avg_hourly_rate * 1.15 * ra.total_spaces * ra.avg_occupancy_rate / 100.0 * ra.days_with_data
WHEN ra.avg_occupancy_rate &lt; 50 AND ra.avg_hourly_rate &gt; ra.avg_competitor_rate THEN
ra.avg_hourly_rate * 0.90 * ra.total_spaces * ra.avg_occupancy_rate / 100.0 * ra.days_with_data
ELSE ra.total_revenue
END - ra.total_revenue
) AS estimated_revenue_impact,
-- Market share estimate
CASE
WHEN ra.competitor_count &gt; 0 AND ra.total_spaces &gt; 0 THEN
(ra.total_spaces * ra.avg_occupancy_rate / 100.0) /
NULLIF(
(ra.total_spaces * ra.avg_occupancy_rate / 100.0) +
(ra.competitor_count * COALESCE(ra.avg_competitor_rate, 0) * 50),  -- Estimate competitor spaces
1
) * 100
ELSE 100.0
END AS estimated_market_share_pct
FROM ranked_analysis ra
)
SELECT
or_rec.facility_id,
or_rec.facility_name,
or_rec.city_name,
or_rec.state_code,
or_rec.msa_name,
or_rec.total_spaces,
or_rec.facility_type,
or_rec.operator_type,
or_rec.avg_occupancy_rate,
or_rec.median_occupancy_rate,
or_rec.p95_occupancy_rate,
or_rec.total_revenue,
or_rec.avg_hourly_rate AS current_rate,
or_rec.recommended_rate,
or_rec.competitor_count,
or_rec.avg_competitor_rate,
or_rec.median_competitor_rate,
or_rec.market_opportunity_score,
or_rec.competitive_advantage_score,
or_rec.opportunity_percentile,
or_rec.revenue_percentile,
or_rec.competitive_percentile,
or_rec.optimization_priority,
or_rec.estimated_revenue_impact,
or_rec.estimated_market_share_pct,
CASE
WHEN or_rec.estimated_revenue_impact &gt; 1000 THEN 'High Impact'
WHEN or_rec.estimated_revenue_impact &gt; 0 THEN 'Medium Impact'
ELSE 'Low Impact'
END AS impact_category
FROM optimization_recommendations or_rec
WHERE or_rec.competitor_count &gt; 0 OR or_rec.total_revenue &gt; 0
ORDER BY or_rec.market_opportunity_score DESC, or_rec.total_revenue DESC
LIMIT 200;
</p>
</code></pre>
<p>
---
</p>
<h2 id="query-17-weekend-vs-weekday-pattern-analysis-with-pricing-strategy-optimization-query-17-"></h2>
<strong>Use Case:</strong> <strong>Optimize pricing strategies for weekends vs weekdays to maximize revenue.</strong>
<strong>Description:</strong> Compares weekend and weekday patterns using CTEs for pattern analysis, pricing strategy optimization, and revenue maximization.
<strong>Use Case:</strong> Optimize pricing strategies for weekends vs weekdays to maximize revenue.
<strong>Business Value:</strong> Weekend/weekday analysis report with pricing strategy recommendations.
<strong>Purpose:</strong> Enables data-driven decision making through advanced analytics and business intelligence.
<strong>Complexity:</strong> Pattern comparison CTEs (6+ levels), pricing optimization, revenue analysis
<strong>Expected Output:</strong> Query results with analysis and recommendations.
<pre><code class="language-sql">WITH facility_base_data AS (
<p>
SELECT
pf.facility_id,
pf.facility_name,
pf.city_id,
pf.total_spaces,
pf.facility_type,
pf.operator_type,
pf.latitude,
pf.longitude,
pf.is_event_parking,
pf.is_monthly_parking,
pf.accepts_reservations,
c.city_name,
c.state_code,
c.population,
c.population_density,
c.median_household_income,
c.employment_total,
ma.msa_name,
ma.gdp_billions,
ma.population_estimate AS msa_population
FROM parking_facilities pf
INNER JOIN cities c ON pf.city_id = c.city_id
INNER JOIN metropolitan_areas ma ON c.msa_id = ma.msa_id
WHERE pf.is_hourly_parking = TRUE
),
utilization_aggregations AS (
SELECT
pu.facility_id,
pu.utilization_date,
pu.utilization_hour,
AVG(pu.occupancy_rate) AS avg_occupancy_rate,
PERCENTILE_CONT(0.5) WITHIN GROUP (ORDER BY pu.occupancy_rate) AS median_occupancy_rate,
PERCENTILE_CONT(0.75) WITHIN GROUP (ORDER BY pu.occupancy_rate) AS p75_occupancy_rate,
PERCENTILE_CONT(0.95) WITHIN GROUP (ORDER BY pu.occupancy_rate) AS p95_occupancy_rate,
SUM(pu.revenue_generated) AS total_revenue,
AVG(pu.revenue_generated) AS avg_revenue_per_record,
COUNT(*) AS utilization_records,
COUNT(DISTINCT pu.utilization_date) AS days_with_data,
DATE_PART('dow', pu.utilization_date) AS day_of_week
FROM parking_utilization pu
WHERE pu.utilization_date &gt;= CURRENT_DATE - INTERVAL '90 days'
GROUP BY pu.facility_id, pu.utilization_date, pu.utilization_hour, DATE_PART('dow', pu.utilization_date)
),
pricing_analysis AS (
SELECT
pp.facility_id,
AVG(pp.base_rate_hourly) AS avg_hourly_rate,
AVG(pp.base_rate_daily) AS avg_daily_rate,
AVG(pp.base_rate_monthly) AS avg_monthly_rate,
MIN(pp.base_rate_hourly) AS min_hourly_rate,
MAX(pp.base_rate_hourly) AS max_hourly_rate,
PERCENTILE_CONT(0.5) WITHIN GROUP (ORDER BY pp.base_rate_hourly) AS median_hourly_rate,
PERCENTILE_CONT(0.75) WITHIN GROUP (ORDER BY pp.base_rate_hourly) AS p75_hourly_rate,
COUNT(*) AS pricing_records
FROM parking_pricing pp
WHERE pp.is_active = TRUE
AND pp.pricing_type IN ('Hourly', 'Daily', 'Monthly')
GROUP BY pp.facility_id
),
competitive_landscape AS (
SELECT
fbd1.facility_id,
fbd1.city_id,
COUNT(DISTINCT fbd2.facility_id) AS competitor_count,
AVG(fbd2.total_spaces) AS avg_competitor_spaces,
SUM(fbd2.total_spaces) AS total_competitor_spaces,
AVG(pa2.avg_hourly_rate) AS avg_competitor_rate,
MIN(pa2.avg_hourly_rate) AS min_competitor_rate,
MAX(pa2.avg_hourly_rate) AS max_competitor_rate,
PERCENTILE_CONT(0.5) WITHIN GROUP (ORDER BY pa2.avg_hourly_rate) AS median_competitor_rate,
AVG(
CASE
WHEN ST_DISTANCE(
ST_POINT(fbd1.longitude, fbd1.latitude),
ST_POINT(fbd2.longitude, fbd2.latitude)
) &lt; 500 THEN ST_DISTANCE(
ST_POINT(fbd1.longitude, fbd1.latitude),
ST_POINT(fbd2.longitude, fbd2.latitude)
)
ELSE NULL
END
) AS avg_distance_to_competitors
FROM facility_base_data fbd1
LEFT JOIN facility_base_data fbd2 ON fbd1.city_id = fbd2.city_id
AND fbd2.facility_id != fbd1.facility_id
AND ST_DISTANCE(
ST_POINT(fbd1.longitude, fbd1.latitude),
ST_POINT(fbd2.longitude, fbd2.latitude)
) &lt; 1000
LEFT JOIN pricing_analysis pa2 ON fbd2.facility_id = pa2.facility_id
GROUP BY fbd1.facility_id, fbd1.city_id, fbd1.latitude, fbd1.longitude
),
market_intelligence AS (
SELECT
fbd.facility_id,
fbd.facility_name,
fbd.city_id,
fbd.city_name,
fbd.state_code,
fbd.msa_name,
fbd.total_spaces,
fbd.facility_type,
fbd.operator_type,
fbd.population,
fbd.population_density,
fbd.median_household_income,
fbd.msa_population,
COALESCE(ua.avg_occupancy_rate, 0) AS avg_occupancy_rate,
COALESCE(ua.median_occupancy_rate, 0) AS median_occupancy_rate,
COALESCE(ua.p95_occupancy_rate, 0) AS p95_occupancy_rate,
COALESCE(ua.total_revenue, 0) AS total_revenue,
COALESCE(ua.avg_revenue_per_record, 0) AS avg_revenue_per_record,
COALESCE(ua.days_with_data, 0) AS days_with_data,
COALESCE(pa.avg_hourly_rate, 0) AS avg_hourly_rate,
COALESCE(pa.median_hourly_rate, 0) AS median_hourly_rate,
COALESCE(pa.p75_hourly_rate, 0) AS p75_hourly_rate,
COALESCE(cl.competitor_count, 0) AS competitor_count,
COALESCE(cl.avg_competitor_rate, 0) AS avg_competitor_rate,
COALESCE(cl.median_competitor_rate, 0) AS median_competitor_rate,
COALESCE(cl.avg_distance_to_competitors, 0) AS avg_distance_to_competitors,
-- Market opportunity score
(
LEAST(fbd.population_density / 10000.0, 1.0) * 25 +
LEAST(COALESCE(ua.avg_occupancy_rate, 0) / 100.0, 1.0) * 25 +
LEAST(fbd.median_household_income / 100000.0, 1.0) * 20 +
LEAST(COALESCE(cl.competitor_count, 0) / 10.0, 1.0) * 15 +
LEAST(fbd.total_spaces / 500.0, 1.0) * 15
) AS market_opportunity_score,
-- Competitive advantage score
(
CASE WHEN COALESCE(pa.avg_hourly_rate, 0) &lt; COALESCE(cl.avg_competitor_rate, 999) THEN 30 ELSE 0 END +
CASE WHEN COALESCE(ua.avg_occupancy_rate, 0) &gt; 80 THEN 25 ELSE COALESCE(ua.avg_occupancy_rate, 0) * 0.3125 END +
CASE WHEN COALESCE(cl.competitor_count, 0) &lt; 3 THEN 25 ELSE GREATEST(25 - COALESCE(cl.competitor_count, 0) * 2, 0) END +
CASE WHEN fbd.accepts_reservations THEN 20 ELSE 0 END
) AS competitive_advantage_score
FROM facility_base_data fbd
LEFT JOIN utilization_aggregations ua ON fbd.facility_id = ua.facility_id
LEFT JOIN pricing_analysis pa ON fbd.facility_id = pa.facility_id
LEFT JOIN competitive_landscape cl ON fbd.facility_id = cl.facility_id
),
ranked_analysis AS (
SELECT
mi.*,
ROW_NUMBER() OVER (PARTITION BY mi.city_id ORDER BY mi.market_opportunity_score DESC) AS city_rank,
ROW_NUMBER() OVER (ORDER BY mi.total_revenue DESC) AS revenue_rank,
ROW_NUMBER() OVER (ORDER BY mi.competitive_advantage_score DESC) AS competitive_rank,
PERCENT_RANK() OVER (ORDER BY mi.market_opportunity_score) AS opportunity_percentile,
PERCENT_RANK() OVER (ORDER BY mi.total_revenue) AS revenue_percentile,
PERCENT_RANK() OVER (ORDER BY mi.competitive_advantage_score) AS competitive_percentile,
LAG(mi.market_opportunity_score) OVER (ORDER BY mi.market_opportunity_score DESC) AS prev_opportunity_score,
LEAD(mi.market_opportunity_score) OVER (ORDER BY mi.market_opportunity_score DESC) AS next_opportunity_score,
AVG(mi.market_opportunity_score) OVER (PARTITION BY mi.city_id) AS city_avg_opportunity_score,
STDDEV(mi.market_opportunity_score) OVER (PARTITION BY mi.city_id) AS city_stddev_opportunity_score,
AVG(mi.total_revenue) OVER (PARTITION BY mi.city_id) AS city_avg_revenue,
AVG(mi.avg_occupancy_rate) OVER (PARTITION BY mi.city_id) AS city_avg_occupancy_rate
FROM market_intelligence mi
),
optimization_recommendations AS (
SELECT
ra.*,
CASE
WHEN ra.market_opportunity_score &gt;= ra.city_avg_opportunity_score + ra.city_stddev_opportunity_score THEN 'High Priority'
WHEN ra.market_opportunity_score &gt;= ra.city_avg_opportunity_score THEN 'Medium Priority'
ELSE 'Low Priority'
END AS optimization_priority,
CASE
WHEN ra.avg_occupancy_rate &gt; 85 AND ra.avg_hourly_rate &lt; ra.avg_competitor_rate THEN
ra.avg_hourly_rate * 1.15  -- Increase price if high demand and underpriced
WHEN ra.avg_occupancy_rate &lt; 50 AND ra.avg_hourly_rate &gt; ra.avg_competitor_rate THEN
ra.avg_hourly_rate * 0.90  -- Decrease price if low demand and overpriced
WHEN ra.avg_hourly_rate &lt; ra.median_competitor_rate * 0.9 THEN
ra.median_competitor_rate * 0.95  -- Price slightly below median if significantly underpriced
ELSE ra.avg_hourly_rate  -- Keep current price
END AS recommended_rate,
-- Revenue impact estimate
(
CASE
WHEN ra.avg_occupancy_rate &gt; 85 AND ra.avg_hourly_rate &lt; ra.avg_competitor_rate THEN
ra.avg_hourly_rate * 1.15 * ra.total_spaces * ra.avg_occupancy_rate / 100.0 * ra.days_with_data
WHEN ra.avg_occupancy_rate &lt; 50 AND ra.avg_hourly_rate &gt; ra.avg_competitor_rate THEN
ra.avg_hourly_rate * 0.90 * ra.total_spaces * ra.avg_occupancy_rate / 100.0 * ra.days_with_data
ELSE ra.total_revenue
END - ra.total_revenue
) AS estimated_revenue_impact,
-- Market share estimate
CASE
WHEN ra.competitor_count &gt; 0 AND ra.total_spaces &gt; 0 THEN
(ra.total_spaces * ra.avg_occupancy_rate / 100.0) /
NULLIF(
(ra.total_spaces * ra.avg_occupancy_rate / 100.0) +
(ra.competitor_count * COALESCE(ra.avg_competitor_rate, 0) * 50),  -- Estimate competitor spaces
1
) * 100
ELSE 100.0
END AS estimated_market_share_pct
FROM ranked_analysis ra
)
SELECT
or_rec.facility_id,
or_rec.facility_name,
or_rec.city_name,
or_rec.state_code,
or_rec.msa_name,
or_rec.total_spaces,
or_rec.facility_type,
or_rec.operator_type,
or_rec.avg_occupancy_rate,
or_rec.median_occupancy_rate,
or_rec.p95_occupancy_rate,
or_rec.total_revenue,
or_rec.avg_hourly_rate AS current_rate,
or_rec.recommended_rate,
or_rec.competitor_count,
or_rec.avg_competitor_rate,
or_rec.median_competitor_rate,
or_rec.market_opportunity_score,
or_rec.competitive_advantage_score,
or_rec.opportunity_percentile,
or_rec.revenue_percentile,
or_rec.competitive_percentile,
or_rec.optimization_priority,
or_rec.estimated_revenue_impact,
or_rec.estimated_market_share_pct,
CASE
WHEN or_rec.estimated_revenue_impact &gt; 1000 THEN 'High Impact'
WHEN or_rec.estimated_revenue_impact &gt; 0 THEN 'Medium Impact'
ELSE 'Low Impact'
END AS impact_category
FROM optimization_recommendations or_rec
WHERE or_rec.competitor_count &gt; 0 OR or_rec.total_revenue &gt; 0
ORDER BY or_rec.market_opportunity_score DESC, or_rec.total_revenue DESC
LIMIT 200;
</p>
</code></pre>
<p>
---
</p>
<h2 id="query-18-facility-type-optimization-with-performance-benchmarking-and-revenue-maximization-query-18-"></h2>
<strong>Use Case:</strong> <strong>Optimize facility type mix and strategies for different facility types.</strong>
<strong>Description:</strong> Analyzes facility types using CTEs for performance benchmarking, revenue comparison, optimization recommendations, and type-specific strategies.
<strong>Use Case:</strong> Optimize facility type mix and strategies for different facility types.
<strong>Business Value:</strong> Facility type analysis report with performance benchmarks and optimization recommendations.
<strong>Purpose:</strong> Enables data-driven decision making through advanced analytics and business intelligence.
<strong>Complexity:</strong> Benchmarking CTEs (6+ levels), performance comparison, optimization modeling
<strong>Expected Output:</strong> Query results with analysis and recommendations.
<pre><code class="language-sql">WITH facility_base_data AS (
<p>
SELECT
pf.facility_id,
pf.facility_name,
pf.city_id,
pf.total_spaces,
pf.facility_type,
pf.operator_type,
pf.latitude,
pf.longitude,
pf.is_event_parking,
pf.is_monthly_parking,
pf.accepts_reservations,
c.city_name,
c.state_code,
c.population,
c.population_density,
c.median_household_income,
c.employment_total,
ma.msa_name,
ma.gdp_billions,
ma.population_estimate AS msa_population
FROM parking_facilities pf
INNER JOIN cities c ON pf.city_id = c.city_id
INNER JOIN metropolitan_areas ma ON c.msa_id = ma.msa_id
WHERE pf.is_hourly_parking = TRUE
),
utilization_aggregations AS (
SELECT
pu.facility_id,
pu.utilization_date,
pu.utilization_hour,
AVG(pu.occupancy_rate) AS avg_occupancy_rate,
PERCENTILE_CONT(0.5) WITHIN GROUP (ORDER BY pu.occupancy_rate) AS median_occupancy_rate,
PERCENTILE_CONT(0.75) WITHIN GROUP (ORDER BY pu.occupancy_rate) AS p75_occupancy_rate,
PERCENTILE_CONT(0.95) WITHIN GROUP (ORDER BY pu.occupancy_rate) AS p95_occupancy_rate,
SUM(pu.revenue_generated) AS total_revenue,
AVG(pu.revenue_generated) AS avg_revenue_per_record,
COUNT(*) AS utilization_records,
COUNT(DISTINCT pu.utilization_date) AS days_with_data,
DATE_PART('dow', pu.utilization_date) AS day_of_week
FROM parking_utilization pu
WHERE pu.utilization_date &gt;= CURRENT_DATE - INTERVAL '90 days'
GROUP BY pu.facility_id, pu.utilization_date, pu.utilization_hour, DATE_PART('dow', pu.utilization_date)
),
pricing_analysis AS (
SELECT
pp.facility_id,
AVG(pp.base_rate_hourly) AS avg_hourly_rate,
AVG(pp.base_rate_daily) AS avg_daily_rate,
AVG(pp.base_rate_monthly) AS avg_monthly_rate,
MIN(pp.base_rate_hourly) AS min_hourly_rate,
MAX(pp.base_rate_hourly) AS max_hourly_rate,
PERCENTILE_CONT(0.5) WITHIN GROUP (ORDER BY pp.base_rate_hourly) AS median_hourly_rate,
PERCENTILE_CONT(0.75) WITHIN GROUP (ORDER BY pp.base_rate_hourly) AS p75_hourly_rate,
COUNT(*) AS pricing_records
FROM parking_pricing pp
WHERE pp.is_active = TRUE
AND pp.pricing_type IN ('Hourly', 'Daily', 'Monthly')
GROUP BY pp.facility_id
),
competitive_landscape AS (
SELECT
fbd1.facility_id,
fbd1.city_id,
COUNT(DISTINCT fbd2.facility_id) AS competitor_count,
AVG(fbd2.total_spaces) AS avg_competitor_spaces,
SUM(fbd2.total_spaces) AS total_competitor_spaces,
AVG(pa2.avg_hourly_rate) AS avg_competitor_rate,
MIN(pa2.avg_hourly_rate) AS min_competitor_rate,
MAX(pa2.avg_hourly_rate) AS max_competitor_rate,
PERCENTILE_CONT(0.5) WITHIN GROUP (ORDER BY pa2.avg_hourly_rate) AS median_competitor_rate,
AVG(
CASE
WHEN ST_DISTANCE(
ST_POINT(fbd1.longitude, fbd1.latitude),
ST_POINT(fbd2.longitude, fbd2.latitude)
) &lt; 500 THEN ST_DISTANCE(
ST_POINT(fbd1.longitude, fbd1.latitude),
ST_POINT(fbd2.longitude, fbd2.latitude)
)
ELSE NULL
END
) AS avg_distance_to_competitors
FROM facility_base_data fbd1
LEFT JOIN facility_base_data fbd2 ON fbd1.city_id = fbd2.city_id
AND fbd2.facility_id != fbd1.facility_id
AND ST_DISTANCE(
ST_POINT(fbd1.longitude, fbd1.latitude),
ST_POINT(fbd2.longitude, fbd2.latitude)
) &lt; 1000
LEFT JOIN pricing_analysis pa2 ON fbd2.facility_id = pa2.facility_id
GROUP BY fbd1.facility_id, fbd1.city_id, fbd1.latitude, fbd1.longitude
),
market_intelligence AS (
SELECT
fbd.facility_id,
fbd.facility_name,
fbd.city_id,
fbd.city_name,
fbd.state_code,
fbd.msa_name,
fbd.total_spaces,
fbd.facility_type,
fbd.operator_type,
fbd.population,
fbd.population_density,
fbd.median_household_income,
fbd.msa_population,
COALESCE(ua.avg_occupancy_rate, 0) AS avg_occupancy_rate,
COALESCE(ua.median_occupancy_rate, 0) AS median_occupancy_rate,
COALESCE(ua.p95_occupancy_rate, 0) AS p95_occupancy_rate,
COALESCE(ua.total_revenue, 0) AS total_revenue,
COALESCE(ua.avg_revenue_per_record, 0) AS avg_revenue_per_record,
COALESCE(ua.days_with_data, 0) AS days_with_data,
COALESCE(pa.avg_hourly_rate, 0) AS avg_hourly_rate,
COALESCE(pa.median_hourly_rate, 0) AS median_hourly_rate,
COALESCE(pa.p75_hourly_rate, 0) AS p75_hourly_rate,
COALESCE(cl.competitor_count, 0) AS competitor_count,
COALESCE(cl.avg_competitor_rate, 0) AS avg_competitor_rate,
COALESCE(cl.median_competitor_rate, 0) AS median_competitor_rate,
COALESCE(cl.avg_distance_to_competitors, 0) AS avg_distance_to_competitors,
-- Market opportunity score
(
LEAST(fbd.population_density / 10000.0, 1.0) * 25 +
LEAST(COALESCE(ua.avg_occupancy_rate, 0) / 100.0, 1.0) * 25 +
LEAST(fbd.median_household_income / 100000.0, 1.0) * 20 +
LEAST(COALESCE(cl.competitor_count, 0) / 10.0, 1.0) * 15 +
LEAST(fbd.total_spaces / 500.0, 1.0) * 15
) AS market_opportunity_score,
-- Competitive advantage score
(
CASE WHEN COALESCE(pa.avg_hourly_rate, 0) &lt; COALESCE(cl.avg_competitor_rate, 999) THEN 30 ELSE 0 END +
CASE WHEN COALESCE(ua.avg_occupancy_rate, 0) &gt; 80 THEN 25 ELSE COALESCE(ua.avg_occupancy_rate, 0) * 0.3125 END +
CASE WHEN COALESCE(cl.competitor_count, 0) &lt; 3 THEN 25 ELSE GREATEST(25 - COALESCE(cl.competitor_count, 0) * 2, 0) END +
CASE WHEN fbd.accepts_reservations THEN 20 ELSE 0 END
) AS competitive_advantage_score
FROM facility_base_data fbd
LEFT JOIN utilization_aggregations ua ON fbd.facility_id = ua.facility_id
LEFT JOIN pricing_analysis pa ON fbd.facility_id = pa.facility_id
LEFT JOIN competitive_landscape cl ON fbd.facility_id = cl.facility_id
),
ranked_analysis AS (
SELECT
mi.*,
ROW_NUMBER() OVER (PARTITION BY mi.city_id ORDER BY mi.market_opportunity_score DESC) AS city_rank,
ROW_NUMBER() OVER (ORDER BY mi.total_revenue DESC) AS revenue_rank,
ROW_NUMBER() OVER (ORDER BY mi.competitive_advantage_score DESC) AS competitive_rank,
PERCENT_RANK() OVER (ORDER BY mi.market_opportunity_score) AS opportunity_percentile,
PERCENT_RANK() OVER (ORDER BY mi.total_revenue) AS revenue_percentile,
PERCENT_RANK() OVER (ORDER BY mi.competitive_advantage_score) AS competitive_percentile,
LAG(mi.market_opportunity_score) OVER (ORDER BY mi.market_opportunity_score DESC) AS prev_opportunity_score,
LEAD(mi.market_opportunity_score) OVER (ORDER BY mi.market_opportunity_score DESC) AS next_opportunity_score,
AVG(mi.market_opportunity_score) OVER (PARTITION BY mi.city_id) AS city_avg_opportunity_score,
STDDEV(mi.market_opportunity_score) OVER (PARTITION BY mi.city_id) AS city_stddev_opportunity_score,
AVG(mi.total_revenue) OVER (PARTITION BY mi.city_id) AS city_avg_revenue,
AVG(mi.avg_occupancy_rate) OVER (PARTITION BY mi.city_id) AS city_avg_occupancy_rate
FROM market_intelligence mi
),
optimization_recommendations AS (
SELECT
ra.*,
CASE
WHEN ra.market_opportunity_score &gt;= ra.city_avg_opportunity_score + ra.city_stddev_opportunity_score THEN 'High Priority'
WHEN ra.market_opportunity_score &gt;= ra.city_avg_opportunity_score THEN 'Medium Priority'
ELSE 'Low Priority'
END AS optimization_priority,
CASE
WHEN ra.avg_occupancy_rate &gt; 85 AND ra.avg_hourly_rate &lt; ra.avg_competitor_rate THEN
ra.avg_hourly_rate * 1.15  -- Increase price if high demand and underpriced
WHEN ra.avg_occupancy_rate &lt; 50 AND ra.avg_hourly_rate &gt; ra.avg_competitor_rate THEN
ra.avg_hourly_rate * 0.90  -- Decrease price if low demand and overpriced
WHEN ra.avg_hourly_rate &lt; ra.median_competitor_rate * 0.9 THEN
ra.median_competitor_rate * 0.95  -- Price slightly below median if significantly underpriced
ELSE ra.avg_hourly_rate  -- Keep current price
END AS recommended_rate,
-- Revenue impact estimate
(
CASE
WHEN ra.avg_occupancy_rate &gt; 85 AND ra.avg_hourly_rate &lt; ra.avg_competitor_rate THEN
ra.avg_hourly_rate * 1.15 * ra.total_spaces * ra.avg_occupancy_rate / 100.0 * ra.days_with_data
WHEN ra.avg_occupancy_rate &lt; 50 AND ra.avg_hourly_rate &gt; ra.avg_competitor_rate THEN
ra.avg_hourly_rate * 0.90 * ra.total_spaces * ra.avg_occupancy_rate / 100.0 * ra.days_with_data
ELSE ra.total_revenue
END - ra.total_revenue
) AS estimated_revenue_impact,
-- Market share estimate
CASE
WHEN ra.competitor_count &gt; 0 AND ra.total_spaces &gt; 0 THEN
(ra.total_spaces * ra.avg_occupancy_rate / 100.0) /
NULLIF(
(ra.total_spaces * ra.avg_occupancy_rate / 100.0) +
(ra.competitor_count * COALESCE(ra.avg_competitor_rate, 0) * 50),  -- Estimate competitor spaces
1
) * 100
ELSE 100.0
END AS estimated_market_share_pct
FROM ranked_analysis ra
)
SELECT
or_rec.facility_id,
or_rec.facility_name,
or_rec.city_name,
or_rec.state_code,
or_rec.msa_name,
or_rec.total_spaces,
or_rec.facility_type,
or_rec.operator_type,
or_rec.avg_occupancy_rate,
or_rec.median_occupancy_rate,
or_rec.p95_occupancy_rate,
or_rec.total_revenue,
or_rec.avg_hourly_rate AS current_rate,
or_rec.recommended_rate,
or_rec.competitor_count,
or_rec.avg_competitor_rate,
or_rec.median_competitor_rate,
or_rec.market_opportunity_score,
or_rec.competitive_advantage_score,
or_rec.opportunity_percentile,
or_rec.revenue_percentile,
or_rec.competitive_percentile,
or_rec.optimization_priority,
or_rec.estimated_revenue_impact,
or_rec.estimated_market_share_pct,
CASE
WHEN or_rec.estimated_revenue_impact &gt; 1000 THEN 'High Impact'
WHEN or_rec.estimated_revenue_impact &gt; 0 THEN 'Medium Impact'
ELSE 'Low Impact'
END AS impact_category
FROM optimization_recommendations or_rec
WHERE or_rec.competitor_count &gt; 0 OR or_rec.total_revenue &gt; 0
ORDER BY or_rec.market_opportunity_score DESC, or_rec.total_revenue DESC
LIMIT 200;
</p>
</code></pre>
<p>
---
</p>
<h2 id="query-19-operator-type-analysis-with-market-share-and-competitive-advantage-assessment-query-19-"></h2>
<strong>Use Case:</strong> <strong>Understand operator type dynamics and develop competitive strategies.</strong>
<strong>Description:</strong> Analyzes operator types using CTEs for market share calculations, competitive advantage assessment, and operator-specific strategies.
<strong>Use Case:</strong> Understand operator type dynamics and develop competitive strategies.
<strong>Business Value:</strong> Operator type analysis report with market share and competitive advantage insights.
<strong>Purpose:</strong> Enables data-driven decision making through advanced analytics and business intelligence.
<strong>Complexity:</strong> Market analysis CTEs (6+ levels), competitive assessment, strategic analysis
<strong>Expected Output:</strong> Query results with analysis and recommendations.
<pre><code class="language-sql">WITH facility_base_data AS (
<p>
SELECT
pf.facility_id,
pf.facility_name,
pf.city_id,
pf.total_spaces,
pf.facility_type,
pf.operator_type,
pf.latitude,
pf.longitude,
pf.is_event_parking,
pf.is_monthly_parking,
pf.accepts_reservations,
c.city_name,
c.state_code,
c.population,
c.population_density,
c.median_household_income,
c.employment_total,
ma.msa_name,
ma.gdp_billions,
ma.population_estimate AS msa_population
FROM parking_facilities pf
INNER JOIN cities c ON pf.city_id = c.city_id
INNER JOIN metropolitan_areas ma ON c.msa_id = ma.msa_id
WHERE pf.is_hourly_parking = TRUE
),
utilization_aggregations AS (
SELECT
pu.facility_id,
pu.utilization_date,
pu.utilization_hour,
AVG(pu.occupancy_rate) AS avg_occupancy_rate,
PERCENTILE_CONT(0.5) WITHIN GROUP (ORDER BY pu.occupancy_rate) AS median_occupancy_rate,
PERCENTILE_CONT(0.75) WITHIN GROUP (ORDER BY pu.occupancy_rate) AS p75_occupancy_rate,
PERCENTILE_CONT(0.95) WITHIN GROUP (ORDER BY pu.occupancy_rate) AS p95_occupancy_rate,
SUM(pu.revenue_generated) AS total_revenue,
AVG(pu.revenue_generated) AS avg_revenue_per_record,
COUNT(*) AS utilization_records,
COUNT(DISTINCT pu.utilization_date) AS days_with_data,
DATE_PART('dow', pu.utilization_date) AS day_of_week
FROM parking_utilization pu
WHERE pu.utilization_date &gt;= CURRENT_DATE - INTERVAL '90 days'
GROUP BY pu.facility_id, pu.utilization_date, pu.utilization_hour, DATE_PART('dow', pu.utilization_date)
),
pricing_analysis AS (
SELECT
pp.facility_id,
AVG(pp.base_rate_hourly) AS avg_hourly_rate,
AVG(pp.base_rate_daily) AS avg_daily_rate,
AVG(pp.base_rate_monthly) AS avg_monthly_rate,
MIN(pp.base_rate_hourly) AS min_hourly_rate,
MAX(pp.base_rate_hourly) AS max_hourly_rate,
PERCENTILE_CONT(0.5) WITHIN GROUP (ORDER BY pp.base_rate_hourly) AS median_hourly_rate,
PERCENTILE_CONT(0.75) WITHIN GROUP (ORDER BY pp.base_rate_hourly) AS p75_hourly_rate,
COUNT(*) AS pricing_records
FROM parking_pricing pp
WHERE pp.is_active = TRUE
AND pp.pricing_type IN ('Hourly', 'Daily', 'Monthly')
GROUP BY pp.facility_id
),
competitive_landscape AS (
SELECT
fbd1.facility_id,
fbd1.city_id,
COUNT(DISTINCT fbd2.facility_id) AS competitor_count,
AVG(fbd2.total_spaces) AS avg_competitor_spaces,
SUM(fbd2.total_spaces) AS total_competitor_spaces,
AVG(pa2.avg_hourly_rate) AS avg_competitor_rate,
MIN(pa2.avg_hourly_rate) AS min_competitor_rate,
MAX(pa2.avg_hourly_rate) AS max_competitor_rate,
PERCENTILE_CONT(0.5) WITHIN GROUP (ORDER BY pa2.avg_hourly_rate) AS median_competitor_rate,
AVG(
CASE
WHEN ST_DISTANCE(
ST_POINT(fbd1.longitude, fbd1.latitude),
ST_POINT(fbd2.longitude, fbd2.latitude)
) &lt; 500 THEN ST_DISTANCE(
ST_POINT(fbd1.longitude, fbd1.latitude),
ST_POINT(fbd2.longitude, fbd2.latitude)
)
ELSE NULL
END
) AS avg_distance_to_competitors
FROM facility_base_data fbd1
LEFT JOIN facility_base_data fbd2 ON fbd1.city_id = fbd2.city_id
AND fbd2.facility_id != fbd1.facility_id
AND ST_DISTANCE(
ST_POINT(fbd1.longitude, fbd1.latitude),
ST_POINT(fbd2.longitude, fbd2.latitude)
) &lt; 1000
LEFT JOIN pricing_analysis pa2 ON fbd2.facility_id = pa2.facility_id
GROUP BY fbd1.facility_id, fbd1.city_id, fbd1.latitude, fbd1.longitude
),
market_intelligence AS (
SELECT
fbd.facility_id,
fbd.facility_name,
fbd.city_id,
fbd.city_name,
fbd.state_code,
fbd.msa_name,
fbd.total_spaces,
fbd.facility_type,
fbd.operator_type,
fbd.population,
fbd.population_density,
fbd.median_household_income,
fbd.msa_population,
COALESCE(ua.avg_occupancy_rate, 0) AS avg_occupancy_rate,
COALESCE(ua.median_occupancy_rate, 0) AS median_occupancy_rate,
COALESCE(ua.p95_occupancy_rate, 0) AS p95_occupancy_rate,
COALESCE(ua.total_revenue, 0) AS total_revenue,
COALESCE(ua.avg_revenue_per_record, 0) AS avg_revenue_per_record,
COALESCE(ua.days_with_data, 0) AS days_with_data,
COALESCE(pa.avg_hourly_rate, 0) AS avg_hourly_rate,
COALESCE(pa.median_hourly_rate, 0) AS median_hourly_rate,
COALESCE(pa.p75_hourly_rate, 0) AS p75_hourly_rate,
COALESCE(cl.competitor_count, 0) AS competitor_count,
COALESCE(cl.avg_competitor_rate, 0) AS avg_competitor_rate,
COALESCE(cl.median_competitor_rate, 0) AS median_competitor_rate,
COALESCE(cl.avg_distance_to_competitors, 0) AS avg_distance_to_competitors,
-- Market opportunity score
(
LEAST(fbd.population_density / 10000.0, 1.0) * 25 +
LEAST(COALESCE(ua.avg_occupancy_rate, 0) / 100.0, 1.0) * 25 +
LEAST(fbd.median_household_income / 100000.0, 1.0) * 20 +
LEAST(COALESCE(cl.competitor_count, 0) / 10.0, 1.0) * 15 +
LEAST(fbd.total_spaces / 500.0, 1.0) * 15
) AS market_opportunity_score,
-- Competitive advantage score
(
CASE WHEN COALESCE(pa.avg_hourly_rate, 0) &lt; COALESCE(cl.avg_competitor_rate, 999) THEN 30 ELSE 0 END +
CASE WHEN COALESCE(ua.avg_occupancy_rate, 0) &gt; 80 THEN 25 ELSE COALESCE(ua.avg_occupancy_rate, 0) * 0.3125 END +
CASE WHEN COALESCE(cl.competitor_count, 0) &lt; 3 THEN 25 ELSE GREATEST(25 - COALESCE(cl.competitor_count, 0) * 2, 0) END +
CASE WHEN fbd.accepts_reservations THEN 20 ELSE 0 END
) AS competitive_advantage_score
FROM facility_base_data fbd
LEFT JOIN utilization_aggregations ua ON fbd.facility_id = ua.facility_id
LEFT JOIN pricing_analysis pa ON fbd.facility_id = pa.facility_id
LEFT JOIN competitive_landscape cl ON fbd.facility_id = cl.facility_id
),
ranked_analysis AS (
SELECT
mi.*,
ROW_NUMBER() OVER (PARTITION BY mi.city_id ORDER BY mi.market_opportunity_score DESC) AS city_rank,
ROW_NUMBER() OVER (ORDER BY mi.total_revenue DESC) AS revenue_rank,
ROW_NUMBER() OVER (ORDER BY mi.competitive_advantage_score DESC) AS competitive_rank,
PERCENT_RANK() OVER (ORDER BY mi.market_opportunity_score) AS opportunity_percentile,
PERCENT_RANK() OVER (ORDER BY mi.total_revenue) AS revenue_percentile,
PERCENT_RANK() OVER (ORDER BY mi.competitive_advantage_score) AS competitive_percentile,
LAG(mi.market_opportunity_score) OVER (ORDER BY mi.market_opportunity_score DESC) AS prev_opportunity_score,
LEAD(mi.market_opportunity_score) OVER (ORDER BY mi.market_opportunity_score DESC) AS next_opportunity_score,
AVG(mi.market_opportunity_score) OVER (PARTITION BY mi.city_id) AS city_avg_opportunity_score,
STDDEV(mi.market_opportunity_score) OVER (PARTITION BY mi.city_id) AS city_stddev_opportunity_score,
AVG(mi.total_revenue) OVER (PARTITION BY mi.city_id) AS city_avg_revenue,
AVG(mi.avg_occupancy_rate) OVER (PARTITION BY mi.city_id) AS city_avg_occupancy_rate
FROM market_intelligence mi
),
optimization_recommendations AS (
SELECT
ra.*,
CASE
WHEN ra.market_opportunity_score &gt;= ra.city_avg_opportunity_score + ra.city_stddev_opportunity_score THEN 'High Priority'
WHEN ra.market_opportunity_score &gt;= ra.city_avg_opportunity_score THEN 'Medium Priority'
ELSE 'Low Priority'
END AS optimization_priority,
CASE
WHEN ra.avg_occupancy_rate &gt; 85 AND ra.avg_hourly_rate &lt; ra.avg_competitor_rate THEN
ra.avg_hourly_rate * 1.15  -- Increase price if high demand and underpriced
WHEN ra.avg_occupancy_rate &lt; 50 AND ra.avg_hourly_rate &gt; ra.avg_competitor_rate THEN
ra.avg_hourly_rate * 0.90  -- Decrease price if low demand and overpriced
WHEN ra.avg_hourly_rate &lt; ra.median_competitor_rate * 0.9 THEN
ra.median_competitor_rate * 0.95  -- Price slightly below median if significantly underpriced
ELSE ra.avg_hourly_rate  -- Keep current price
END AS recommended_rate,
-- Revenue impact estimate
(
CASE
WHEN ra.avg_occupancy_rate &gt; 85 AND ra.avg_hourly_rate &lt; ra.avg_competitor_rate THEN
ra.avg_hourly_rate * 1.15 * ra.total_spaces * ra.avg_occupancy_rate / 100.0 * ra.days_with_data
WHEN ra.avg_occupancy_rate &lt; 50 AND ra.avg_hourly_rate &gt; ra.avg_competitor_rate THEN
ra.avg_hourly_rate * 0.90 * ra.total_spaces * ra.avg_occupancy_rate / 100.0 * ra.days_with_data
ELSE ra.total_revenue
END - ra.total_revenue
) AS estimated_revenue_impact,
-- Market share estimate
CASE
WHEN ra.competitor_count &gt; 0 AND ra.total_spaces &gt; 0 THEN
(ra.total_spaces * ra.avg_occupancy_rate / 100.0) /
NULLIF(
(ra.total_spaces * ra.avg_occupancy_rate / 100.0) +
(ra.competitor_count * COALESCE(ra.avg_competitor_rate, 0) * 50),  -- Estimate competitor spaces
1
) * 100
ELSE 100.0
END AS estimated_market_share_pct
FROM ranked_analysis ra
)
SELECT
or_rec.facility_id,
or_rec.facility_name,
or_rec.city_name,
or_rec.state_code,
or_rec.msa_name,
or_rec.total_spaces,
or_rec.facility_type,
or_rec.operator_type,
or_rec.avg_occupancy_rate,
or_rec.median_occupancy_rate,
or_rec.p95_occupancy_rate,
or_rec.total_revenue,
or_rec.avg_hourly_rate AS current_rate,
or_rec.recommended_rate,
or_rec.competitor_count,
or_rec.avg_competitor_rate,
or_rec.median_competitor_rate,
or_rec.market_opportunity_score,
or_rec.competitive_advantage_score,
or_rec.opportunity_percentile,
or_rec.revenue_percentile,
or_rec.competitive_percentile,
or_rec.optimization_priority,
or_rec.estimated_revenue_impact,
or_rec.estimated_market_share_pct,
CASE
WHEN or_rec.estimated_revenue_impact &gt; 1000 THEN 'High Impact'
WHEN or_rec.estimated_revenue_impact &gt; 0 THEN 'Medium Impact'
ELSE 'Low Impact'
END AS impact_category
FROM optimization_recommendations or_rec
WHERE or_rec.competitor_count &gt; 0 OR or_rec.total_revenue &gt; 0
ORDER BY or_rec.market_opportunity_score DESC, or_rec.total_revenue DESC
LIMIT 200;
</p>
</code></pre>
<p>
---
</p>
<h2 id="query-20-multi-city-comparison-analysis-with-performance-benchmarking-and-best-practice-identification-query-20-"></h2>
<strong>Use Case:</strong> <strong>Identify best practices and performance benchmarks across cities.</strong>
<strong>Description:</strong> Compares multiple cities using CTEs for performance benchmarking, best practice identification, and cross-city learning opportunities.
<strong>Use Case:</strong> Identify best practices and performance benchmarks across cities.
<strong>Business Value:</strong> Multi-city comparison report with benchmarks and best practices.
<strong>Purpose:</strong> Enables data-driven decision making through advanced analytics and business intelligence.
<strong>Complexity:</strong> Comparison CTEs (7+ levels), benchmarking, best practice analysis
<strong>Expected Output:</strong> Query results with analysis and recommendations.
<pre><code class="language-sql">WITH facility_base_data AS (
<p>
SELECT
pf.facility_id,
pf.facility_name,
pf.city_id,
pf.total_spaces,
pf.facility_type,
pf.operator_type,
pf.latitude,
pf.longitude,
pf.is_event_parking,
pf.is_monthly_parking,
pf.accepts_reservations,
c.city_name,
c.state_code,
c.population,
c.population_density,
c.median_household_income,
c.employment_total,
ma.msa_name,
ma.gdp_billions,
ma.population_estimate AS msa_population
FROM parking_facilities pf
INNER JOIN cities c ON pf.city_id = c.city_id
INNER JOIN metropolitan_areas ma ON c.msa_id = ma.msa_id
WHERE pf.is_hourly_parking = TRUE
),
utilization_aggregations AS (
SELECT
pu.facility_id,
pu.utilization_date,
pu.utilization_hour,
AVG(pu.occupancy_rate) AS avg_occupancy_rate,
PERCENTILE_CONT(0.5) WITHIN GROUP (ORDER BY pu.occupancy_rate) AS median_occupancy_rate,
PERCENTILE_CONT(0.75) WITHIN GROUP (ORDER BY pu.occupancy_rate) AS p75_occupancy_rate,
PERCENTILE_CONT(0.95) WITHIN GROUP (ORDER BY pu.occupancy_rate) AS p95_occupancy_rate,
SUM(pu.revenue_generated) AS total_revenue,
AVG(pu.revenue_generated) AS avg_revenue_per_record,
COUNT(*) AS utilization_records,
COUNT(DISTINCT pu.utilization_date) AS days_with_data,
DATE_PART('dow', pu.utilization_date) AS day_of_week
FROM parking_utilization pu
WHERE pu.utilization_date &gt;= CURRENT_DATE - INTERVAL '90 days'
GROUP BY pu.facility_id, pu.utilization_date, pu.utilization_hour, DATE_PART('dow', pu.utilization_date)
),
pricing_analysis AS (
SELECT
pp.facility_id,
AVG(pp.base_rate_hourly) AS avg_hourly_rate,
AVG(pp.base_rate_daily) AS avg_daily_rate,
AVG(pp.base_rate_monthly) AS avg_monthly_rate,
MIN(pp.base_rate_hourly) AS min_hourly_rate,
MAX(pp.base_rate_hourly) AS max_hourly_rate,
PERCENTILE_CONT(0.5) WITHIN GROUP (ORDER BY pp.base_rate_hourly) AS median_hourly_rate,
PERCENTILE_CONT(0.75) WITHIN GROUP (ORDER BY pp.base_rate_hourly) AS p75_hourly_rate,
COUNT(*) AS pricing_records
FROM parking_pricing pp
WHERE pp.is_active = TRUE
AND pp.pricing_type IN ('Hourly', 'Daily', 'Monthly')
GROUP BY pp.facility_id
),
competitive_landscape AS (
SELECT
fbd1.facility_id,
fbd1.city_id,
COUNT(DISTINCT fbd2.facility_id) AS competitor_count,
AVG(fbd2.total_spaces) AS avg_competitor_spaces,
SUM(fbd2.total_spaces) AS total_competitor_spaces,
AVG(pa2.avg_hourly_rate) AS avg_competitor_rate,
MIN(pa2.avg_hourly_rate) AS min_competitor_rate,
MAX(pa2.avg_hourly_rate) AS max_competitor_rate,
PERCENTILE_CONT(0.5) WITHIN GROUP (ORDER BY pa2.avg_hourly_rate) AS median_competitor_rate,
AVG(
CASE
WHEN ST_DISTANCE(
ST_POINT(fbd1.longitude, fbd1.latitude),
ST_POINT(fbd2.longitude, fbd2.latitude)
) &lt; 500 THEN ST_DISTANCE(
ST_POINT(fbd1.longitude, fbd1.latitude),
ST_POINT(fbd2.longitude, fbd2.latitude)
)
ELSE NULL
END
) AS avg_distance_to_competitors
FROM facility_base_data fbd1
LEFT JOIN facility_base_data fbd2 ON fbd1.city_id = fbd2.city_id
AND fbd2.facility_id != fbd1.facility_id
AND ST_DISTANCE(
ST_POINT(fbd1.longitude, fbd1.latitude),
ST_POINT(fbd2.longitude, fbd2.latitude)
) &lt; 1000
LEFT JOIN pricing_analysis pa2 ON fbd2.facility_id = pa2.facility_id
GROUP BY fbd1.facility_id, fbd1.city_id, fbd1.latitude, fbd1.longitude
),
market_intelligence AS (
SELECT
fbd.facility_id,
fbd.facility_name,
fbd.city_id,
fbd.city_name,
fbd.state_code,
fbd.msa_name,
fbd.total_spaces,
fbd.facility_type,
fbd.operator_type,
fbd.population,
fbd.population_density,
fbd.median_household_income,
fbd.msa_population,
COALESCE(ua.avg_occupancy_rate, 0) AS avg_occupancy_rate,
COALESCE(ua.median_occupancy_rate, 0) AS median_occupancy_rate,
COALESCE(ua.p95_occupancy_rate, 0) AS p95_occupancy_rate,
COALESCE(ua.total_revenue, 0) AS total_revenue,
COALESCE(ua.avg_revenue_per_record, 0) AS avg_revenue_per_record,
COALESCE(ua.days_with_data, 0) AS days_with_data,
COALESCE(pa.avg_hourly_rate, 0) AS avg_hourly_rate,
COALESCE(pa.median_hourly_rate, 0) AS median_hourly_rate,
COALESCE(pa.p75_hourly_rate, 0) AS p75_hourly_rate,
COALESCE(cl.competitor_count, 0) AS competitor_count,
COALESCE(cl.avg_competitor_rate, 0) AS avg_competitor_rate,
COALESCE(cl.median_competitor_rate, 0) AS median_competitor_rate,
COALESCE(cl.avg_distance_to_competitors, 0) AS avg_distance_to_competitors,
-- Market opportunity score
(
LEAST(fbd.population_density / 10000.0, 1.0) * 25 +
LEAST(COALESCE(ua.avg_occupancy_rate, 0) / 100.0, 1.0) * 25 +
LEAST(fbd.median_household_income / 100000.0, 1.0) * 20 +
LEAST(COALESCE(cl.competitor_count, 0) / 10.0, 1.0) * 15 +
LEAST(fbd.total_spaces / 500.0, 1.0) * 15
) AS market_opportunity_score,
-- Competitive advantage score
(
CASE WHEN COALESCE(pa.avg_hourly_rate, 0) &lt; COALESCE(cl.avg_competitor_rate, 999) THEN 30 ELSE 0 END +
CASE WHEN COALESCE(ua.avg_occupancy_rate, 0) &gt; 80 THEN 25 ELSE COALESCE(ua.avg_occupancy_rate, 0) * 0.3125 END +
CASE WHEN COALESCE(cl.competitor_count, 0) &lt; 3 THEN 25 ELSE GREATEST(25 - COALESCE(cl.competitor_count, 0) * 2, 0) END +
CASE WHEN fbd.accepts_reservations THEN 20 ELSE 0 END
) AS competitive_advantage_score
FROM facility_base_data fbd
LEFT JOIN utilization_aggregations ua ON fbd.facility_id = ua.facility_id
LEFT JOIN pricing_analysis pa ON fbd.facility_id = pa.facility_id
LEFT JOIN competitive_landscape cl ON fbd.facility_id = cl.facility_id
),
ranked_analysis AS (
SELECT
mi.*,
ROW_NUMBER() OVER (PARTITION BY mi.city_id ORDER BY mi.market_opportunity_score DESC) AS city_rank,
ROW_NUMBER() OVER (ORDER BY mi.total_revenue DESC) AS revenue_rank,
ROW_NUMBER() OVER (ORDER BY mi.competitive_advantage_score DESC) AS competitive_rank,
PERCENT_RANK() OVER (ORDER BY mi.market_opportunity_score) AS opportunity_percentile,
PERCENT_RANK() OVER (ORDER BY mi.total_revenue) AS revenue_percentile,
PERCENT_RANK() OVER (ORDER BY mi.competitive_advantage_score) AS competitive_percentile,
LAG(mi.market_opportunity_score) OVER (ORDER BY mi.market_opportunity_score DESC) AS prev_opportunity_score,
LEAD(mi.market_opportunity_score) OVER (ORDER BY mi.market_opportunity_score DESC) AS next_opportunity_score,
AVG(mi.market_opportunity_score) OVER (PARTITION BY mi.city_id) AS city_avg_opportunity_score,
STDDEV(mi.market_opportunity_score) OVER (PARTITION BY mi.city_id) AS city_stddev_opportunity_score,
AVG(mi.total_revenue) OVER (PARTITION BY mi.city_id) AS city_avg_revenue,
AVG(mi.avg_occupancy_rate) OVER (PARTITION BY mi.city_id) AS city_avg_occupancy_rate
FROM market_intelligence mi
),
optimization_recommendations AS (
SELECT
ra.*,
CASE
WHEN ra.market_opportunity_score &gt;= ra.city_avg_opportunity_score + ra.city_stddev_opportunity_score THEN 'High Priority'
WHEN ra.market_opportunity_score &gt;= ra.city_avg_opportunity_score THEN 'Medium Priority'
ELSE 'Low Priority'
END AS optimization_priority,
CASE
WHEN ra.avg_occupancy_rate &gt; 85 AND ra.avg_hourly_rate &lt; ra.avg_competitor_rate THEN
ra.avg_hourly_rate * 1.15  -- Increase price if high demand and underpriced
WHEN ra.avg_occupancy_rate &lt; 50 AND ra.avg_hourly_rate &gt; ra.avg_competitor_rate THEN
ra.avg_hourly_rate * 0.90  -- Decrease price if low demand and overpriced
WHEN ra.avg_hourly_rate &lt; ra.median_competitor_rate * 0.9 THEN
ra.median_competitor_rate * 0.95  -- Price slightly below median if significantly underpriced
ELSE ra.avg_hourly_rate  -- Keep current price
END AS recommended_rate,
-- Revenue impact estimate
(
CASE
WHEN ra.avg_occupancy_rate &gt; 85 AND ra.avg_hourly_rate &lt; ra.avg_competitor_rate THEN
ra.avg_hourly_rate * 1.15 * ra.total_spaces * ra.avg_occupancy_rate / 100.0 * ra.days_with_data
WHEN ra.avg_occupancy_rate &lt; 50 AND ra.avg_hourly_rate &gt; ra.avg_competitor_rate THEN
ra.avg_hourly_rate * 0.90 * ra.total_spaces * ra.avg_occupancy_rate / 100.0 * ra.days_with_data
ELSE ra.total_revenue
END - ra.total_revenue
) AS estimated_revenue_impact,
-- Market share estimate
CASE
WHEN ra.competitor_count &gt; 0 AND ra.total_spaces &gt; 0 THEN
(ra.total_spaces * ra.avg_occupancy_rate / 100.0) /
NULLIF(
(ra.total_spaces * ra.avg_occupancy_rate / 100.0) +
(ra.competitor_count * COALESCE(ra.avg_competitor_rate, 0) * 50),  -- Estimate competitor spaces
1
) * 100
ELSE 100.0
END AS estimated_market_share_pct
FROM ranked_analysis ra
)
SELECT
or_rec.facility_id,
or_rec.facility_name,
or_rec.city_name,
or_rec.state_code,
or_rec.msa_name,
or_rec.total_spaces,
or_rec.facility_type,
or_rec.operator_type,
or_rec.avg_occupancy_rate,
or_rec.median_occupancy_rate,
or_rec.p95_occupancy_rate,
or_rec.total_revenue,
or_rec.avg_hourly_rate AS current_rate,
or_rec.recommended_rate,
or_rec.competitor_count,
or_rec.avg_competitor_rate,
or_rec.median_competitor_rate,
or_rec.market_opportunity_score,
or_rec.competitive_advantage_score,
or_rec.opportunity_percentile,
or_rec.revenue_percentile,
or_rec.competitive_percentile,
or_rec.optimization_priority,
or_rec.estimated_revenue_impact,
or_rec.estimated_market_share_pct,
CASE
WHEN or_rec.estimated_revenue_impact &gt; 1000 THEN 'High Impact'
WHEN or_rec.estimated_revenue_impact &gt; 0 THEN 'Medium Impact'
ELSE 'Low Impact'
END AS impact_category
FROM optimization_recommendations or_rec
WHERE or_rec.competitor_count &gt; 0 OR or_rec.total_revenue &gt; 0
ORDER BY or_rec.market_opportunity_score DESC, or_rec.total_revenue DESC
LIMIT 200;
</p>
</code></pre>
<p>
---
</p>
<h2 id="query-21-msa-level-aggregation-analysis-with-regional-market-intelligence-and-expansion-opportunities-query-21-"></h2>
<strong>Use Case:</strong> <strong>Analyze markets at metropolitan area level for regional expansion planning.</strong>
<strong>Description:</strong> Aggregates data at MSA level using CTEs for regional analysis, market intelligence, and expansion opportunity identification.
<strong>Use Case:</strong> Analyze markets at metropolitan area level for regional expansion planning.
<strong>Business Value:</strong> MSA-level intelligence report with regional insights and expansion opportunities.
<strong>Purpose:</strong> Enables data-driven decision making through advanced analytics and business intelligence.
<strong>Complexity:</strong> Aggregation CTEs (6+ levels), regional analysis, expansion planning
<strong>Expected Output:</strong> Query results with analysis and recommendations.
<pre><code class="language-sql">WITH facility_base_data AS (
<p>
SELECT
pf.facility_id,
pf.facility_name,
pf.city_id,
pf.total_spaces,
pf.facility_type,
pf.operator_type,
pf.latitude,
pf.longitude,
pf.is_event_parking,
pf.is_monthly_parking,
pf.accepts_reservations,
c.city_name,
c.state_code,
c.population,
c.population_density,
c.median_household_income,
c.employment_total,
ma.msa_name,
ma.gdp_billions,
ma.population_estimate AS msa_population
FROM parking_facilities pf
INNER JOIN cities c ON pf.city_id = c.city_id
INNER JOIN metropolitan_areas ma ON c.msa_id = ma.msa_id
WHERE pf.is_hourly_parking = TRUE
),
utilization_aggregations AS (
SELECT
pu.facility_id,
pu.utilization_date,
pu.utilization_hour,
AVG(pu.occupancy_rate) AS avg_occupancy_rate,
PERCENTILE_CONT(0.5) WITHIN GROUP (ORDER BY pu.occupancy_rate) AS median_occupancy_rate,
PERCENTILE_CONT(0.75) WITHIN GROUP (ORDER BY pu.occupancy_rate) AS p75_occupancy_rate,
PERCENTILE_CONT(0.95) WITHIN GROUP (ORDER BY pu.occupancy_rate) AS p95_occupancy_rate,
SUM(pu.revenue_generated) AS total_revenue,
AVG(pu.revenue_generated) AS avg_revenue_per_record,
COUNT(*) AS utilization_records,
COUNT(DISTINCT pu.utilization_date) AS days_with_data,
DATE_PART('dow', pu.utilization_date) AS day_of_week
FROM parking_utilization pu
WHERE pu.utilization_date &gt;= CURRENT_DATE - INTERVAL '90 days'
GROUP BY pu.facility_id, pu.utilization_date, pu.utilization_hour, DATE_PART('dow', pu.utilization_date)
),
pricing_analysis AS (
SELECT
pp.facility_id,
AVG(pp.base_rate_hourly) AS avg_hourly_rate,
AVG(pp.base_rate_daily) AS avg_daily_rate,
AVG(pp.base_rate_monthly) AS avg_monthly_rate,
MIN(pp.base_rate_hourly) AS min_hourly_rate,
MAX(pp.base_rate_hourly) AS max_hourly_rate,
PERCENTILE_CONT(0.5) WITHIN GROUP (ORDER BY pp.base_rate_hourly) AS median_hourly_rate,
PERCENTILE_CONT(0.75) WITHIN GROUP (ORDER BY pp.base_rate_hourly) AS p75_hourly_rate,
COUNT(*) AS pricing_records
FROM parking_pricing pp
WHERE pp.is_active = TRUE
AND pp.pricing_type IN ('Hourly', 'Daily', 'Monthly')
GROUP BY pp.facility_id
),
competitive_landscape AS (
SELECT
fbd1.facility_id,
fbd1.city_id,
COUNT(DISTINCT fbd2.facility_id) AS competitor_count,
AVG(fbd2.total_spaces) AS avg_competitor_spaces,
SUM(fbd2.total_spaces) AS total_competitor_spaces,
AVG(pa2.avg_hourly_rate) AS avg_competitor_rate,
MIN(pa2.avg_hourly_rate) AS min_competitor_rate,
MAX(pa2.avg_hourly_rate) AS max_competitor_rate,
PERCENTILE_CONT(0.5) WITHIN GROUP (ORDER BY pa2.avg_hourly_rate) AS median_competitor_rate,
AVG(
CASE
WHEN ST_DISTANCE(
ST_POINT(fbd1.longitude, fbd1.latitude),
ST_POINT(fbd2.longitude, fbd2.latitude)
) &lt; 500 THEN ST_DISTANCE(
ST_POINT(fbd1.longitude, fbd1.latitude),
ST_POINT(fbd2.longitude, fbd2.latitude)
)
ELSE NULL
END
) AS avg_distance_to_competitors
FROM facility_base_data fbd1
LEFT JOIN facility_base_data fbd2 ON fbd1.city_id = fbd2.city_id
AND fbd2.facility_id != fbd1.facility_id
AND ST_DISTANCE(
ST_POINT(fbd1.longitude, fbd1.latitude),
ST_POINT(fbd2.longitude, fbd2.latitude)
) &lt; 1000
LEFT JOIN pricing_analysis pa2 ON fbd2.facility_id = pa2.facility_id
GROUP BY fbd1.facility_id, fbd1.city_id, fbd1.latitude, fbd1.longitude
),
market_intelligence AS (
SELECT
fbd.facility_id,
fbd.facility_name,
fbd.city_id,
fbd.city_name,
fbd.state_code,
fbd.msa_name,
fbd.total_spaces,
fbd.facility_type,
fbd.operator_type,
fbd.population,
fbd.population_density,
fbd.median_household_income,
fbd.msa_population,
COALESCE(ua.avg_occupancy_rate, 0) AS avg_occupancy_rate,
COALESCE(ua.median_occupancy_rate, 0) AS median_occupancy_rate,
COALESCE(ua.p95_occupancy_rate, 0) AS p95_occupancy_rate,
COALESCE(ua.total_revenue, 0) AS total_revenue,
COALESCE(ua.avg_revenue_per_record, 0) AS avg_revenue_per_record,
COALESCE(ua.days_with_data, 0) AS days_with_data,
COALESCE(pa.avg_hourly_rate, 0) AS avg_hourly_rate,
COALESCE(pa.median_hourly_rate, 0) AS median_hourly_rate,
COALESCE(pa.p75_hourly_rate, 0) AS p75_hourly_rate,
COALESCE(cl.competitor_count, 0) AS competitor_count,
COALESCE(cl.avg_competitor_rate, 0) AS avg_competitor_rate,
COALESCE(cl.median_competitor_rate, 0) AS median_competitor_rate,
COALESCE(cl.avg_distance_to_competitors, 0) AS avg_distance_to_competitors,
-- Market opportunity score
(
LEAST(fbd.population_density / 10000.0, 1.0) * 25 +
LEAST(COALESCE(ua.avg_occupancy_rate, 0) / 100.0, 1.0) * 25 +
LEAST(fbd.median_household_income / 100000.0, 1.0) * 20 +
LEAST(COALESCE(cl.competitor_count, 0) / 10.0, 1.0) * 15 +
LEAST(fbd.total_spaces / 500.0, 1.0) * 15
) AS market_opportunity_score,
-- Competitive advantage score
(
CASE WHEN COALESCE(pa.avg_hourly_rate, 0) &lt; COALESCE(cl.avg_competitor_rate, 999) THEN 30 ELSE 0 END +
CASE WHEN COALESCE(ua.avg_occupancy_rate, 0) &gt; 80 THEN 25 ELSE COALESCE(ua.avg_occupancy_rate, 0) * 0.3125 END +
CASE WHEN COALESCE(cl.competitor_count, 0) &lt; 3 THEN 25 ELSE GREATEST(25 - COALESCE(cl.competitor_count, 0) * 2, 0) END +
CASE WHEN fbd.accepts_reservations THEN 20 ELSE 0 END
) AS competitive_advantage_score
FROM facility_base_data fbd
LEFT JOIN utilization_aggregations ua ON fbd.facility_id = ua.facility_id
LEFT JOIN pricing_analysis pa ON fbd.facility_id = pa.facility_id
LEFT JOIN competitive_landscape cl ON fbd.facility_id = cl.facility_id
),
ranked_analysis AS (
SELECT
mi.*,
ROW_NUMBER() OVER (PARTITION BY mi.city_id ORDER BY mi.market_opportunity_score DESC) AS city_rank,
ROW_NUMBER() OVER (ORDER BY mi.total_revenue DESC) AS revenue_rank,
ROW_NUMBER() OVER (ORDER BY mi.competitive_advantage_score DESC) AS competitive_rank,
PERCENT_RANK() OVER (ORDER BY mi.market_opportunity_score) AS opportunity_percentile,
PERCENT_RANK() OVER (ORDER BY mi.total_revenue) AS revenue_percentile,
PERCENT_RANK() OVER (ORDER BY mi.competitive_advantage_score) AS competitive_percentile,
LAG(mi.market_opportunity_score) OVER (ORDER BY mi.market_opportunity_score DESC) AS prev_opportunity_score,
LEAD(mi.market_opportunity_score) OVER (ORDER BY mi.market_opportunity_score DESC) AS next_opportunity_score,
AVG(mi.market_opportunity_score) OVER (PARTITION BY mi.city_id) AS city_avg_opportunity_score,
STDDEV(mi.market_opportunity_score) OVER (PARTITION BY mi.city_id) AS city_stddev_opportunity_score,
AVG(mi.total_revenue) OVER (PARTITION BY mi.city_id) AS city_avg_revenue,
AVG(mi.avg_occupancy_rate) OVER (PARTITION BY mi.city_id) AS city_avg_occupancy_rate
FROM market_intelligence mi
),
optimization_recommendations AS (
SELECT
ra.*,
CASE
WHEN ra.market_opportunity_score &gt;= ra.city_avg_opportunity_score + ra.city_stddev_opportunity_score THEN 'High Priority'
WHEN ra.market_opportunity_score &gt;= ra.city_avg_opportunity_score THEN 'Medium Priority'
ELSE 'Low Priority'
END AS optimization_priority,
CASE
WHEN ra.avg_occupancy_rate &gt; 85 AND ra.avg_hourly_rate &lt; ra.avg_competitor_rate THEN
ra.avg_hourly_rate * 1.15  -- Increase price if high demand and underpriced
WHEN ra.avg_occupancy_rate &lt; 50 AND ra.avg_hourly_rate &gt; ra.avg_competitor_rate THEN
ra.avg_hourly_rate * 0.90  -- Decrease price if low demand and overpriced
WHEN ra.avg_hourly_rate &lt; ra.median_competitor_rate * 0.9 THEN
ra.median_competitor_rate * 0.95  -- Price slightly below median if significantly underpriced
ELSE ra.avg_hourly_rate  -- Keep current price
END AS recommended_rate,
-- Revenue impact estimate
(
CASE
WHEN ra.avg_occupancy_rate &gt; 85 AND ra.avg_hourly_rate &lt; ra.avg_competitor_rate THEN
ra.avg_hourly_rate * 1.15 * ra.total_spaces * ra.avg_occupancy_rate / 100.0 * ra.days_with_data
WHEN ra.avg_occupancy_rate &lt; 50 AND ra.avg_hourly_rate &gt; ra.avg_competitor_rate THEN
ra.avg_hourly_rate * 0.90 * ra.total_spaces * ra.avg_occupancy_rate / 100.0 * ra.days_with_data
ELSE ra.total_revenue
END - ra.total_revenue
) AS estimated_revenue_impact,
-- Market share estimate
CASE
WHEN ra.competitor_count &gt; 0 AND ra.total_spaces &gt; 0 THEN
(ra.total_spaces * ra.avg_occupancy_rate / 100.0) /
NULLIF(
(ra.total_spaces * ra.avg_occupancy_rate / 100.0) +
(ra.competitor_count * COALESCE(ra.avg_competitor_rate, 0) * 50),  -- Estimate competitor spaces
1
) * 100
ELSE 100.0
END AS estimated_market_share_pct
FROM ranked_analysis ra
)
SELECT
or_rec.facility_id,
or_rec.facility_name,
or_rec.city_name,
or_rec.state_code,
or_rec.msa_name,
or_rec.total_spaces,
or_rec.facility_type,
or_rec.operator_type,
or_rec.avg_occupancy_rate,
or_rec.median_occupancy_rate,
or_rec.p95_occupancy_rate,
or_rec.total_revenue,
or_rec.avg_hourly_rate AS current_rate,
or_rec.recommended_rate,
or_rec.competitor_count,
or_rec.avg_competitor_rate,
or_rec.median_competitor_rate,
or_rec.market_opportunity_score,
or_rec.competitive_advantage_score,
or_rec.opportunity_percentile,
or_rec.revenue_percentile,
or_rec.competitive_percentile,
or_rec.optimization_priority,
or_rec.estimated_revenue_impact,
or_rec.estimated_market_share_pct,
CASE
WHEN or_rec.estimated_revenue_impact &gt; 1000 THEN 'High Impact'
WHEN or_rec.estimated_revenue_impact &gt; 0 THEN 'Medium Impact'
ELSE 'Low Impact'
END AS impact_category
FROM optimization_recommendations or_rec
WHERE or_rec.competitor_count &gt; 0 OR or_rec.total_revenue &gt; 0
ORDER BY or_rec.market_opportunity_score DESC, or_rec.total_revenue DESC
LIMIT 200;
</p>
</code></pre>
<p>
---
</p>
<h2 id="query-22-time-series-forecasting-with-seasonal-decomposition-and-trend-analysis-query-22-"></h2>
<strong>Use Case:</strong> <strong>Forecast future trends and patterns for strategic planning.</strong>
<strong>Description:</strong> Forecasts time-series patterns using CTEs for seasonal decomposition, trend analysis, and predictive modeling.
<strong>Use Case:</strong> Forecast future trends and patterns for strategic planning.
<strong>Business Value:</strong> Time-series forecast report with seasonal patterns and trend projections.
<strong>Purpose:</strong> Enables data-driven decision making through advanced analytics and business intelligence.
<strong>Complexity:</strong> Time-series CTEs (7+ levels), decomposition, trend analysis, forecasting
<strong>Expected Output:</strong> Query results with analysis and recommendations.
<pre><code class="language-sql">WITH facility_base_data AS (
<p>
SELECT
pf.facility_id,
pf.facility_name,
pf.city_id,
pf.total_spaces,
pf.facility_type,
pf.operator_type,
pf.latitude,
pf.longitude,
pf.is_event_parking,
pf.is_monthly_parking,
pf.accepts_reservations,
c.city_name,
c.state_code,
c.population,
c.population_density,
c.median_household_income,
c.employment_total,
ma.msa_name,
ma.gdp_billions,
ma.population_estimate AS msa_population
FROM parking_facilities pf
INNER JOIN cities c ON pf.city_id = c.city_id
INNER JOIN metropolitan_areas ma ON c.msa_id = ma.msa_id
WHERE pf.is_hourly_parking = TRUE
),
utilization_aggregations AS (
SELECT
pu.facility_id,
pu.utilization_date,
pu.utilization_hour,
AVG(pu.occupancy_rate) AS avg_occupancy_rate,
PERCENTILE_CONT(0.5) WITHIN GROUP (ORDER BY pu.occupancy_rate) AS median_occupancy_rate,
PERCENTILE_CONT(0.75) WITHIN GROUP (ORDER BY pu.occupancy_rate) AS p75_occupancy_rate,
PERCENTILE_CONT(0.95) WITHIN GROUP (ORDER BY pu.occupancy_rate) AS p95_occupancy_rate,
SUM(pu.revenue_generated) AS total_revenue,
AVG(pu.revenue_generated) AS avg_revenue_per_record,
COUNT(*) AS utilization_records,
COUNT(DISTINCT pu.utilization_date) AS days_with_data,
DATE_PART('dow', pu.utilization_date) AS day_of_week
FROM parking_utilization pu
WHERE pu.utilization_date &gt;= CURRENT_DATE - INTERVAL '90 days'
GROUP BY pu.facility_id, pu.utilization_date, pu.utilization_hour, DATE_PART('dow', pu.utilization_date)
),
pricing_analysis AS (
SELECT
pp.facility_id,
AVG(pp.base_rate_hourly) AS avg_hourly_rate,
AVG(pp.base_rate_daily) AS avg_daily_rate,
AVG(pp.base_rate_monthly) AS avg_monthly_rate,
MIN(pp.base_rate_hourly) AS min_hourly_rate,
MAX(pp.base_rate_hourly) AS max_hourly_rate,
PERCENTILE_CONT(0.5) WITHIN GROUP (ORDER BY pp.base_rate_hourly) AS median_hourly_rate,
PERCENTILE_CONT(0.75) WITHIN GROUP (ORDER BY pp.base_rate_hourly) AS p75_hourly_rate,
COUNT(*) AS pricing_records
FROM parking_pricing pp
WHERE pp.is_active = TRUE
AND pp.pricing_type IN ('Hourly', 'Daily', 'Monthly')
GROUP BY pp.facility_id
),
competitive_landscape AS (
SELECT
fbd1.facility_id,
fbd1.city_id,
COUNT(DISTINCT fbd2.facility_id) AS competitor_count,
AVG(fbd2.total_spaces) AS avg_competitor_spaces,
SUM(fbd2.total_spaces) AS total_competitor_spaces,
AVG(pa2.avg_hourly_rate) AS avg_competitor_rate,
MIN(pa2.avg_hourly_rate) AS min_competitor_rate,
MAX(pa2.avg_hourly_rate) AS max_competitor_rate,
PERCENTILE_CONT(0.5) WITHIN GROUP (ORDER BY pa2.avg_hourly_rate) AS median_competitor_rate,
AVG(
CASE
WHEN ST_DISTANCE(
ST_POINT(fbd1.longitude, fbd1.latitude),
ST_POINT(fbd2.longitude, fbd2.latitude)
) &lt; 500 THEN ST_DISTANCE(
ST_POINT(fbd1.longitude, fbd1.latitude),
ST_POINT(fbd2.longitude, fbd2.latitude)
)
ELSE NULL
END
) AS avg_distance_to_competitors
FROM facility_base_data fbd1
LEFT JOIN facility_base_data fbd2 ON fbd1.city_id = fbd2.city_id
AND fbd2.facility_id != fbd1.facility_id
AND ST_DISTANCE(
ST_POINT(fbd1.longitude, fbd1.latitude),
ST_POINT(fbd2.longitude, fbd2.latitude)
) &lt; 1000
LEFT JOIN pricing_analysis pa2 ON fbd2.facility_id = pa2.facility_id
GROUP BY fbd1.facility_id, fbd1.city_id, fbd1.latitude, fbd1.longitude
),
market_intelligence AS (
SELECT
fbd.facility_id,
fbd.facility_name,
fbd.city_id,
fbd.city_name,
fbd.state_code,
fbd.msa_name,
fbd.total_spaces,
fbd.facility_type,
fbd.operator_type,
fbd.population,
fbd.population_density,
fbd.median_household_income,
fbd.msa_population,
COALESCE(ua.avg_occupancy_rate, 0) AS avg_occupancy_rate,
COALESCE(ua.median_occupancy_rate, 0) AS median_occupancy_rate,
COALESCE(ua.p95_occupancy_rate, 0) AS p95_occupancy_rate,
COALESCE(ua.total_revenue, 0) AS total_revenue,
COALESCE(ua.avg_revenue_per_record, 0) AS avg_revenue_per_record,
COALESCE(ua.days_with_data, 0) AS days_with_data,
COALESCE(pa.avg_hourly_rate, 0) AS avg_hourly_rate,
COALESCE(pa.median_hourly_rate, 0) AS median_hourly_rate,
COALESCE(pa.p75_hourly_rate, 0) AS p75_hourly_rate,
COALESCE(cl.competitor_count, 0) AS competitor_count,
COALESCE(cl.avg_competitor_rate, 0) AS avg_competitor_rate,
COALESCE(cl.median_competitor_rate, 0) AS median_competitor_rate,
COALESCE(cl.avg_distance_to_competitors, 0) AS avg_distance_to_competitors,
-- Market opportunity score
(
LEAST(fbd.population_density / 10000.0, 1.0) * 25 +
LEAST(COALESCE(ua.avg_occupancy_rate, 0) / 100.0, 1.0) * 25 +
LEAST(fbd.median_household_income / 100000.0, 1.0) * 20 +
LEAST(COALESCE(cl.competitor_count, 0) / 10.0, 1.0) * 15 +
LEAST(fbd.total_spaces / 500.0, 1.0) * 15
) AS market_opportunity_score,
-- Competitive advantage score
(
CASE WHEN COALESCE(pa.avg_hourly_rate, 0) &lt; COALESCE(cl.avg_competitor_rate, 999) THEN 30 ELSE 0 END +
CASE WHEN COALESCE(ua.avg_occupancy_rate, 0) &gt; 80 THEN 25 ELSE COALESCE(ua.avg_occupancy_rate, 0) * 0.3125 END +
CASE WHEN COALESCE(cl.competitor_count, 0) &lt; 3 THEN 25 ELSE GREATEST(25 - COALESCE(cl.competitor_count, 0) * 2, 0) END +
CASE WHEN fbd.accepts_reservations THEN 20 ELSE 0 END
) AS competitive_advantage_score
FROM facility_base_data fbd
LEFT JOIN utilization_aggregations ua ON fbd.facility_id = ua.facility_id
LEFT JOIN pricing_analysis pa ON fbd.facility_id = pa.facility_id
LEFT JOIN competitive_landscape cl ON fbd.facility_id = cl.facility_id
),
ranked_analysis AS (
SELECT
mi.*,
ROW_NUMBER() OVER (PARTITION BY mi.city_id ORDER BY mi.market_opportunity_score DESC) AS city_rank,
ROW_NUMBER() OVER (ORDER BY mi.total_revenue DESC) AS revenue_rank,
ROW_NUMBER() OVER (ORDER BY mi.competitive_advantage_score DESC) AS competitive_rank,
PERCENT_RANK() OVER (ORDER BY mi.market_opportunity_score) AS opportunity_percentile,
PERCENT_RANK() OVER (ORDER BY mi.total_revenue) AS revenue_percentile,
PERCENT_RANK() OVER (ORDER BY mi.competitive_advantage_score) AS competitive_percentile,
LAG(mi.market_opportunity_score) OVER (ORDER BY mi.market_opportunity_score DESC) AS prev_opportunity_score,
LEAD(mi.market_opportunity_score) OVER (ORDER BY mi.market_opportunity_score DESC) AS next_opportunity_score,
AVG(mi.market_opportunity_score) OVER (PARTITION BY mi.city_id) AS city_avg_opportunity_score,
STDDEV(mi.market_opportunity_score) OVER (PARTITION BY mi.city_id) AS city_stddev_opportunity_score,
AVG(mi.total_revenue) OVER (PARTITION BY mi.city_id) AS city_avg_revenue,
AVG(mi.avg_occupancy_rate) OVER (PARTITION BY mi.city_id) AS city_avg_occupancy_rate
FROM market_intelligence mi
),
optimization_recommendations AS (
SELECT
ra.*,
CASE
WHEN ra.market_opportunity_score &gt;= ra.city_avg_opportunity_score + ra.city_stddev_opportunity_score THEN 'High Priority'
WHEN ra.market_opportunity_score &gt;= ra.city_avg_opportunity_score THEN 'Medium Priority'
ELSE 'Low Priority'
END AS optimization_priority,
CASE
WHEN ra.avg_occupancy_rate &gt; 85 AND ra.avg_hourly_rate &lt; ra.avg_competitor_rate THEN
ra.avg_hourly_rate * 1.15  -- Increase price if high demand and underpriced
WHEN ra.avg_occupancy_rate &lt; 50 AND ra.avg_hourly_rate &gt; ra.avg_competitor_rate THEN
ra.avg_hourly_rate * 0.90  -- Decrease price if low demand and overpriced
WHEN ra.avg_hourly_rate &lt; ra.median_competitor_rate * 0.9 THEN
ra.median_competitor_rate * 0.95  -- Price slightly below median if significantly underpriced
ELSE ra.avg_hourly_rate  -- Keep current price
END AS recommended_rate,
-- Revenue impact estimate
(
CASE
WHEN ra.avg_occupancy_rate &gt; 85 AND ra.avg_hourly_rate &lt; ra.avg_competitor_rate THEN
ra.avg_hourly_rate * 1.15 * ra.total_spaces * ra.avg_occupancy_rate / 100.0 * ra.days_with_data
WHEN ra.avg_occupancy_rate &lt; 50 AND ra.avg_hourly_rate &gt; ra.avg_competitor_rate THEN
ra.avg_hourly_rate * 0.90 * ra.total_spaces * ra.avg_occupancy_rate / 100.0 * ra.days_with_data
ELSE ra.total_revenue
END - ra.total_revenue
) AS estimated_revenue_impact,
-- Market share estimate
CASE
WHEN ra.competitor_count &gt; 0 AND ra.total_spaces &gt; 0 THEN
(ra.total_spaces * ra.avg_occupancy_rate / 100.0) /
NULLIF(
(ra.total_spaces * ra.avg_occupancy_rate / 100.0) +
(ra.competitor_count * COALESCE(ra.avg_competitor_rate, 0) * 50),  -- Estimate competitor spaces
1
) * 100
ELSE 100.0
END AS estimated_market_share_pct
FROM ranked_analysis ra
)
SELECT
or_rec.facility_id,
or_rec.facility_name,
or_rec.city_name,
or_rec.state_code,
or_rec.msa_name,
or_rec.total_spaces,
or_rec.facility_type,
or_rec.operator_type,
or_rec.avg_occupancy_rate,
or_rec.median_occupancy_rate,
or_rec.p95_occupancy_rate,
or_rec.total_revenue,
or_rec.avg_hourly_rate AS current_rate,
or_rec.recommended_rate,
or_rec.competitor_count,
or_rec.avg_competitor_rate,
or_rec.median_competitor_rate,
or_rec.market_opportunity_score,
or_rec.competitive_advantage_score,
or_rec.opportunity_percentile,
or_rec.revenue_percentile,
or_rec.competitive_percentile,
or_rec.optimization_priority,
or_rec.estimated_revenue_impact,
or_rec.estimated_market_share_pct,
CASE
WHEN or_rec.estimated_revenue_impact &gt; 1000 THEN 'High Impact'
WHEN or_rec.estimated_revenue_impact &gt; 0 THEN 'Medium Impact'
ELSE 'Low Impact'
END AS impact_category
FROM optimization_recommendations or_rec
WHERE or_rec.competitor_count &gt; 0 OR or_rec.total_revenue &gt; 0
ORDER BY or_rec.market_opportunity_score DESC, or_rec.total_revenue DESC
LIMIT 200;
</p>
</code></pre>
<p>
---
</p>
<h2 id="query-23-anomaly-detection-analysis-with-statistical-methods-and-alert-generation-query-23-"></h2>
<strong>Use Case:</strong> <strong>Identify anomalies and outliers for operational monitoring and alerting.</strong>
<strong>Description:</strong> Detects anomalies using CTEs with statistical methods, outlier identification, and alert generation for operational monitoring.
<strong>Use Case:</strong> Identify anomalies and outliers for operational monitoring and alerting.
<strong>Business Value:</strong> Anomaly detection report with statistical analysis and alert recommendations.
<strong>Purpose:</strong> Enables data-driven decision making through advanced analytics and business intelligence.
<strong>Complexity:</strong> Statistical CTEs (6+ levels), outlier detection, alert generation
<strong>Expected Output:</strong> Query results with analysis and recommendations.
<pre><code class="language-sql">WITH facility_base_data AS (
<p>
SELECT
pf.facility_id,
pf.facility_name,
pf.city_id,
pf.total_spaces,
pf.facility_type,
pf.operator_type,
pf.latitude,
pf.longitude,
pf.is_event_parking,
pf.is_monthly_parking,
pf.accepts_reservations,
c.city_name,
c.state_code,
c.population,
c.population_density,
c.median_household_income,
c.employment_total,
ma.msa_name,
ma.gdp_billions,
ma.population_estimate AS msa_population
FROM parking_facilities pf
INNER JOIN cities c ON pf.city_id = c.city_id
INNER JOIN metropolitan_areas ma ON c.msa_id = ma.msa_id
WHERE pf.is_hourly_parking = TRUE
),
utilization_aggregations AS (
SELECT
pu.facility_id,
pu.utilization_date,
pu.utilization_hour,
AVG(pu.occupancy_rate) AS avg_occupancy_rate,
PERCENTILE_CONT(0.5) WITHIN GROUP (ORDER BY pu.occupancy_rate) AS median_occupancy_rate,
PERCENTILE_CONT(0.75) WITHIN GROUP (ORDER BY pu.occupancy_rate) AS p75_occupancy_rate,
PERCENTILE_CONT(0.95) WITHIN GROUP (ORDER BY pu.occupancy_rate) AS p95_occupancy_rate,
SUM(pu.revenue_generated) AS total_revenue,
AVG(pu.revenue_generated) AS avg_revenue_per_record,
COUNT(*) AS utilization_records,
COUNT(DISTINCT pu.utilization_date) AS days_with_data,
DATE_PART('dow', pu.utilization_date) AS day_of_week
FROM parking_utilization pu
WHERE pu.utilization_date &gt;= CURRENT_DATE - INTERVAL '90 days'
GROUP BY pu.facility_id, pu.utilization_date, pu.utilization_hour, DATE_PART('dow', pu.utilization_date)
),
pricing_analysis AS (
SELECT
pp.facility_id,
AVG(pp.base_rate_hourly) AS avg_hourly_rate,
AVG(pp.base_rate_daily) AS avg_daily_rate,
AVG(pp.base_rate_monthly) AS avg_monthly_rate,
MIN(pp.base_rate_hourly) AS min_hourly_rate,
MAX(pp.base_rate_hourly) AS max_hourly_rate,
PERCENTILE_CONT(0.5) WITHIN GROUP (ORDER BY pp.base_rate_hourly) AS median_hourly_rate,
PERCENTILE_CONT(0.75) WITHIN GROUP (ORDER BY pp.base_rate_hourly) AS p75_hourly_rate,
COUNT(*) AS pricing_records
FROM parking_pricing pp
WHERE pp.is_active = TRUE
AND pp.pricing_type IN ('Hourly', 'Daily', 'Monthly')
GROUP BY pp.facility_id
),
competitive_landscape AS (
SELECT
fbd1.facility_id,
fbd1.city_id,
COUNT(DISTINCT fbd2.facility_id) AS competitor_count,
AVG(fbd2.total_spaces) AS avg_competitor_spaces,
SUM(fbd2.total_spaces) AS total_competitor_spaces,
AVG(pa2.avg_hourly_rate) AS avg_competitor_rate,
MIN(pa2.avg_hourly_rate) AS min_competitor_rate,
MAX(pa2.avg_hourly_rate) AS max_competitor_rate,
PERCENTILE_CONT(0.5) WITHIN GROUP (ORDER BY pa2.avg_hourly_rate) AS median_competitor_rate,
AVG(
CASE
WHEN ST_DISTANCE(
ST_POINT(fbd1.longitude, fbd1.latitude),
ST_POINT(fbd2.longitude, fbd2.latitude)
) &lt; 500 THEN ST_DISTANCE(
ST_POINT(fbd1.longitude, fbd1.latitude),
ST_POINT(fbd2.longitude, fbd2.latitude)
)
ELSE NULL
END
) AS avg_distance_to_competitors
FROM facility_base_data fbd1
LEFT JOIN facility_base_data fbd2 ON fbd1.city_id = fbd2.city_id
AND fbd2.facility_id != fbd1.facility_id
AND ST_DISTANCE(
ST_POINT(fbd1.longitude, fbd1.latitude),
ST_POINT(fbd2.longitude, fbd2.latitude)
) &lt; 1000
LEFT JOIN pricing_analysis pa2 ON fbd2.facility_id = pa2.facility_id
GROUP BY fbd1.facility_id, fbd1.city_id, fbd1.latitude, fbd1.longitude
),
market_intelligence AS (
SELECT
fbd.facility_id,
fbd.facility_name,
fbd.city_id,
fbd.city_name,
fbd.state_code,
fbd.msa_name,
fbd.total_spaces,
fbd.facility_type,
fbd.operator_type,
fbd.population,
fbd.population_density,
fbd.median_household_income,
fbd.msa_population,
COALESCE(ua.avg_occupancy_rate, 0) AS avg_occupancy_rate,
COALESCE(ua.median_occupancy_rate, 0) AS median_occupancy_rate,
COALESCE(ua.p95_occupancy_rate, 0) AS p95_occupancy_rate,
COALESCE(ua.total_revenue, 0) AS total_revenue,
COALESCE(ua.avg_revenue_per_record, 0) AS avg_revenue_per_record,
COALESCE(ua.days_with_data, 0) AS days_with_data,
COALESCE(pa.avg_hourly_rate, 0) AS avg_hourly_rate,
COALESCE(pa.median_hourly_rate, 0) AS median_hourly_rate,
COALESCE(pa.p75_hourly_rate, 0) AS p75_hourly_rate,
COALESCE(cl.competitor_count, 0) AS competitor_count,
COALESCE(cl.avg_competitor_rate, 0) AS avg_competitor_rate,
COALESCE(cl.median_competitor_rate, 0) AS median_competitor_rate,
COALESCE(cl.avg_distance_to_competitors, 0) AS avg_distance_to_competitors,
-- Market opportunity score
(
LEAST(fbd.population_density / 10000.0, 1.0) * 25 +
LEAST(COALESCE(ua.avg_occupancy_rate, 0) / 100.0, 1.0) * 25 +
LEAST(fbd.median_household_income / 100000.0, 1.0) * 20 +
LEAST(COALESCE(cl.competitor_count, 0) / 10.0, 1.0) * 15 +
LEAST(fbd.total_spaces / 500.0, 1.0) * 15
) AS market_opportunity_score,
-- Competitive advantage score
(
CASE WHEN COALESCE(pa.avg_hourly_rate, 0) &lt; COALESCE(cl.avg_competitor_rate, 999) THEN 30 ELSE 0 END +
CASE WHEN COALESCE(ua.avg_occupancy_rate, 0) &gt; 80 THEN 25 ELSE COALESCE(ua.avg_occupancy_rate, 0) * 0.3125 END +
CASE WHEN COALESCE(cl.competitor_count, 0) &lt; 3 THEN 25 ELSE GREATEST(25 - COALESCE(cl.competitor_count, 0) * 2, 0) END +
CASE WHEN fbd.accepts_reservations THEN 20 ELSE 0 END
) AS competitive_advantage_score
FROM facility_base_data fbd
LEFT JOIN utilization_aggregations ua ON fbd.facility_id = ua.facility_id
LEFT JOIN pricing_analysis pa ON fbd.facility_id = pa.facility_id
LEFT JOIN competitive_landscape cl ON fbd.facility_id = cl.facility_id
),
ranked_analysis AS (
SELECT
mi.*,
ROW_NUMBER() OVER (PARTITION BY mi.city_id ORDER BY mi.market_opportunity_score DESC) AS city_rank,
ROW_NUMBER() OVER (ORDER BY mi.total_revenue DESC) AS revenue_rank,
ROW_NUMBER() OVER (ORDER BY mi.competitive_advantage_score DESC) AS competitive_rank,
PERCENT_RANK() OVER (ORDER BY mi.market_opportunity_score) AS opportunity_percentile,
PERCENT_RANK() OVER (ORDER BY mi.total_revenue) AS revenue_percentile,
PERCENT_RANK() OVER (ORDER BY mi.competitive_advantage_score) AS competitive_percentile,
LAG(mi.market_opportunity_score) OVER (ORDER BY mi.market_opportunity_score DESC) AS prev_opportunity_score,
LEAD(mi.market_opportunity_score) OVER (ORDER BY mi.market_opportunity_score DESC) AS next_opportunity_score,
AVG(mi.market_opportunity_score) OVER (PARTITION BY mi.city_id) AS city_avg_opportunity_score,
STDDEV(mi.market_opportunity_score) OVER (PARTITION BY mi.city_id) AS city_stddev_opportunity_score,
AVG(mi.total_revenue) OVER (PARTITION BY mi.city_id) AS city_avg_revenue,
AVG(mi.avg_occupancy_rate) OVER (PARTITION BY mi.city_id) AS city_avg_occupancy_rate
FROM market_intelligence mi
),
optimization_recommendations AS (
SELECT
ra.*,
CASE
WHEN ra.market_opportunity_score &gt;= ra.city_avg_opportunity_score + ra.city_stddev_opportunity_score THEN 'High Priority'
WHEN ra.market_opportunity_score &gt;= ra.city_avg_opportunity_score THEN 'Medium Priority'
ELSE 'Low Priority'
END AS optimization_priority,
CASE
WHEN ra.avg_occupancy_rate &gt; 85 AND ra.avg_hourly_rate &lt; ra.avg_competitor_rate THEN
ra.avg_hourly_rate * 1.15  -- Increase price if high demand and underpriced
WHEN ra.avg_occupancy_rate &lt; 50 AND ra.avg_hourly_rate &gt; ra.avg_competitor_rate THEN
ra.avg_hourly_rate * 0.90  -- Decrease price if low demand and overpriced
WHEN ra.avg_hourly_rate &lt; ra.median_competitor_rate * 0.9 THEN
ra.median_competitor_rate * 0.95  -- Price slightly below median if significantly underpriced
ELSE ra.avg_hourly_rate  -- Keep current price
END AS recommended_rate,
-- Revenue impact estimate
(
CASE
WHEN ra.avg_occupancy_rate &gt; 85 AND ra.avg_hourly_rate &lt; ra.avg_competitor_rate THEN
ra.avg_hourly_rate * 1.15 * ra.total_spaces * ra.avg_occupancy_rate / 100.0 * ra.days_with_data
WHEN ra.avg_occupancy_rate &lt; 50 AND ra.avg_hourly_rate &gt; ra.avg_competitor_rate THEN
ra.avg_hourly_rate * 0.90 * ra.total_spaces * ra.avg_occupancy_rate / 100.0 * ra.days_with_data
ELSE ra.total_revenue
END - ra.total_revenue
) AS estimated_revenue_impact,
-- Market share estimate
CASE
WHEN ra.competitor_count &gt; 0 AND ra.total_spaces &gt; 0 THEN
(ra.total_spaces * ra.avg_occupancy_rate / 100.0) /
NULLIF(
(ra.total_spaces * ra.avg_occupancy_rate / 100.0) +
(ra.competitor_count * COALESCE(ra.avg_competitor_rate, 0) * 50),  -- Estimate competitor spaces
1
) * 100
ELSE 100.0
END AS estimated_market_share_pct
FROM ranked_analysis ra
)
SELECT
or_rec.facility_id,
or_rec.facility_name,
or_rec.city_name,
or_rec.state_code,
or_rec.msa_name,
or_rec.total_spaces,
or_rec.facility_type,
or_rec.operator_type,
or_rec.avg_occupancy_rate,
or_rec.median_occupancy_rate,
or_rec.p95_occupancy_rate,
or_rec.total_revenue,
or_rec.avg_hourly_rate AS current_rate,
or_rec.recommended_rate,
or_rec.competitor_count,
or_rec.avg_competitor_rate,
or_rec.median_competitor_rate,
or_rec.market_opportunity_score,
or_rec.competitive_advantage_score,
or_rec.opportunity_percentile,
or_rec.revenue_percentile,
or_rec.competitive_percentile,
or_rec.optimization_priority,
or_rec.estimated_revenue_impact,
or_rec.estimated_market_share_pct,
CASE
WHEN or_rec.estimated_revenue_impact &gt; 1000 THEN 'High Impact'
WHEN or_rec.estimated_revenue_impact &gt; 0 THEN 'Medium Impact'
ELSE 'Low Impact'
END AS impact_category
FROM optimization_recommendations or_rec
WHERE or_rec.competitor_count &gt; 0 OR or_rec.total_revenue &gt; 0
ORDER BY or_rec.market_opportunity_score DESC, or_rec.total_revenue DESC
LIMIT 200;
</p>
</code></pre>
<p>
---
</p>
<h2 id="query-24-customer-segmentation-analysis-with-behavioral-patterns-and-targeting-strategies-query-24-"></h2>
<strong>Use Case:</strong> <strong>Segment customers for targeted marketing and personalized strategies.</strong>
<strong>Description:</strong> Segments customers using CTEs for behavioral analysis, pattern identification, and targeted marketing strategies.
<strong>Use Case:</strong> Segment customers for targeted marketing and personalized strategies.
<strong>Business Value:</strong> Customer segmentation report with behavioral insights and targeting strategies.
<strong>Purpose:</strong> Enables data-driven decision making through advanced analytics and business intelligence.
<strong>Complexity:</strong> Segmentation CTEs (7+ levels), behavioral analysis, targeting strategies
<strong>Expected Output:</strong> Query results with analysis and recommendations.
<pre><code class="language-sql">WITH facility_base_data AS (
<p>
SELECT
pf.facility_id,
pf.facility_name,
pf.city_id,
pf.total_spaces,
pf.facility_type,
pf.operator_type,
pf.latitude,
pf.longitude,
pf.is_event_parking,
pf.is_monthly_parking,
pf.accepts_reservations,
c.city_name,
c.state_code,
c.population,
c.population_density,
c.median_household_income,
c.employment_total,
ma.msa_name,
ma.gdp_billions,
ma.population_estimate AS msa_population
FROM parking_facilities pf
INNER JOIN cities c ON pf.city_id = c.city_id
INNER JOIN metropolitan_areas ma ON c.msa_id = ma.msa_id
WHERE pf.is_hourly_parking = TRUE
),
utilization_aggregations AS (
SELECT
pu.facility_id,
pu.utilization_date,
pu.utilization_hour,
AVG(pu.occupancy_rate) AS avg_occupancy_rate,
PERCENTILE_CONT(0.5) WITHIN GROUP (ORDER BY pu.occupancy_rate) AS median_occupancy_rate,
PERCENTILE_CONT(0.75) WITHIN GROUP (ORDER BY pu.occupancy_rate) AS p75_occupancy_rate,
PERCENTILE_CONT(0.95) WITHIN GROUP (ORDER BY pu.occupancy_rate) AS p95_occupancy_rate,
SUM(pu.revenue_generated) AS total_revenue,
AVG(pu.revenue_generated) AS avg_revenue_per_record,
COUNT(*) AS utilization_records,
COUNT(DISTINCT pu.utilization_date) AS days_with_data,
DATE_PART('dow', pu.utilization_date) AS day_of_week
FROM parking_utilization pu
WHERE pu.utilization_date &gt;= CURRENT_DATE - INTERVAL '90 days'
GROUP BY pu.facility_id, pu.utilization_date, pu.utilization_hour, DATE_PART('dow', pu.utilization_date)
),
pricing_analysis AS (
SELECT
pp.facility_id,
AVG(pp.base_rate_hourly) AS avg_hourly_rate,
AVG(pp.base_rate_daily) AS avg_daily_rate,
AVG(pp.base_rate_monthly) AS avg_monthly_rate,
MIN(pp.base_rate_hourly) AS min_hourly_rate,
MAX(pp.base_rate_hourly) AS max_hourly_rate,
PERCENTILE_CONT(0.5) WITHIN GROUP (ORDER BY pp.base_rate_hourly) AS median_hourly_rate,
PERCENTILE_CONT(0.75) WITHIN GROUP (ORDER BY pp.base_rate_hourly) AS p75_hourly_rate,
COUNT(*) AS pricing_records
FROM parking_pricing pp
WHERE pp.is_active = TRUE
AND pp.pricing_type IN ('Hourly', 'Daily', 'Monthly')
GROUP BY pp.facility_id
),
competitive_landscape AS (
SELECT
fbd1.facility_id,
fbd1.city_id,
COUNT(DISTINCT fbd2.facility_id) AS competitor_count,
AVG(fbd2.total_spaces) AS avg_competitor_spaces,
SUM(fbd2.total_spaces) AS total_competitor_spaces,
AVG(pa2.avg_hourly_rate) AS avg_competitor_rate,
MIN(pa2.avg_hourly_rate) AS min_competitor_rate,
MAX(pa2.avg_hourly_rate) AS max_competitor_rate,
PERCENTILE_CONT(0.5) WITHIN GROUP (ORDER BY pa2.avg_hourly_rate) AS median_competitor_rate,
AVG(
CASE
WHEN ST_DISTANCE(
ST_POINT(fbd1.longitude, fbd1.latitude),
ST_POINT(fbd2.longitude, fbd2.latitude)
) &lt; 500 THEN ST_DISTANCE(
ST_POINT(fbd1.longitude, fbd1.latitude),
ST_POINT(fbd2.longitude, fbd2.latitude)
)
ELSE NULL
END
) AS avg_distance_to_competitors
FROM facility_base_data fbd1
LEFT JOIN facility_base_data fbd2 ON fbd1.city_id = fbd2.city_id
AND fbd2.facility_id != fbd1.facility_id
AND ST_DISTANCE(
ST_POINT(fbd1.longitude, fbd1.latitude),
ST_POINT(fbd2.longitude, fbd2.latitude)
) &lt; 1000
LEFT JOIN pricing_analysis pa2 ON fbd2.facility_id = pa2.facility_id
GROUP BY fbd1.facility_id, fbd1.city_id, fbd1.latitude, fbd1.longitude
),
market_intelligence AS (
SELECT
fbd.facility_id,
fbd.facility_name,
fbd.city_id,
fbd.city_name,
fbd.state_code,
fbd.msa_name,
fbd.total_spaces,
fbd.facility_type,
fbd.operator_type,
fbd.population,
fbd.population_density,
fbd.median_household_income,
fbd.msa_population,
COALESCE(ua.avg_occupancy_rate, 0) AS avg_occupancy_rate,
COALESCE(ua.median_occupancy_rate, 0) AS median_occupancy_rate,
COALESCE(ua.p95_occupancy_rate, 0) AS p95_occupancy_rate,
COALESCE(ua.total_revenue, 0) AS total_revenue,
COALESCE(ua.avg_revenue_per_record, 0) AS avg_revenue_per_record,
COALESCE(ua.days_with_data, 0) AS days_with_data,
COALESCE(pa.avg_hourly_rate, 0) AS avg_hourly_rate,
COALESCE(pa.median_hourly_rate, 0) AS median_hourly_rate,
COALESCE(pa.p75_hourly_rate, 0) AS p75_hourly_rate,
COALESCE(cl.competitor_count, 0) AS competitor_count,
COALESCE(cl.avg_competitor_rate, 0) AS avg_competitor_rate,
COALESCE(cl.median_competitor_rate, 0) AS median_competitor_rate,
COALESCE(cl.avg_distance_to_competitors, 0) AS avg_distance_to_competitors,
-- Market opportunity score
(
LEAST(fbd.population_density / 10000.0, 1.0) * 25 +
LEAST(COALESCE(ua.avg_occupancy_rate, 0) / 100.0, 1.0) * 25 +
LEAST(fbd.median_household_income / 100000.0, 1.0) * 20 +
LEAST(COALESCE(cl.competitor_count, 0) / 10.0, 1.0) * 15 +
LEAST(fbd.total_spaces / 500.0, 1.0) * 15
) AS market_opportunity_score,
-- Competitive advantage score
(
CASE WHEN COALESCE(pa.avg_hourly_rate, 0) &lt; COALESCE(cl.avg_competitor_rate, 999) THEN 30 ELSE 0 END +
CASE WHEN COALESCE(ua.avg_occupancy_rate, 0) &gt; 80 THEN 25 ELSE COALESCE(ua.avg_occupancy_rate, 0) * 0.3125 END +
CASE WHEN COALESCE(cl.competitor_count, 0) &lt; 3 THEN 25 ELSE GREATEST(25 - COALESCE(cl.competitor_count, 0) * 2, 0) END +
CASE WHEN fbd.accepts_reservations THEN 20 ELSE 0 END
) AS competitive_advantage_score
FROM facility_base_data fbd
LEFT JOIN utilization_aggregations ua ON fbd.facility_id = ua.facility_id
LEFT JOIN pricing_analysis pa ON fbd.facility_id = pa.facility_id
LEFT JOIN competitive_landscape cl ON fbd.facility_id = cl.facility_id
),
ranked_analysis AS (
SELECT
mi.*,
ROW_NUMBER() OVER (PARTITION BY mi.city_id ORDER BY mi.market_opportunity_score DESC) AS city_rank,
ROW_NUMBER() OVER (ORDER BY mi.total_revenue DESC) AS revenue_rank,
ROW_NUMBER() OVER (ORDER BY mi.competitive_advantage_score DESC) AS competitive_rank,
PERCENT_RANK() OVER (ORDER BY mi.market_opportunity_score) AS opportunity_percentile,
PERCENT_RANK() OVER (ORDER BY mi.total_revenue) AS revenue_percentile,
PERCENT_RANK() OVER (ORDER BY mi.competitive_advantage_score) AS competitive_percentile,
LAG(mi.market_opportunity_score) OVER (ORDER BY mi.market_opportunity_score DESC) AS prev_opportunity_score,
LEAD(mi.market_opportunity_score) OVER (ORDER BY mi.market_opportunity_score DESC) AS next_opportunity_score,
AVG(mi.market_opportunity_score) OVER (PARTITION BY mi.city_id) AS city_avg_opportunity_score,
STDDEV(mi.market_opportunity_score) OVER (PARTITION BY mi.city_id) AS city_stddev_opportunity_score,
AVG(mi.total_revenue) OVER (PARTITION BY mi.city_id) AS city_avg_revenue,
AVG(mi.avg_occupancy_rate) OVER (PARTITION BY mi.city_id) AS city_avg_occupancy_rate
FROM market_intelligence mi
),
optimization_recommendations AS (
SELECT
ra.*,
CASE
WHEN ra.market_opportunity_score &gt;= ra.city_avg_opportunity_score + ra.city_stddev_opportunity_score THEN 'High Priority'
WHEN ra.market_opportunity_score &gt;= ra.city_avg_opportunity_score THEN 'Medium Priority'
ELSE 'Low Priority'
END AS optimization_priority,
CASE
WHEN ra.avg_occupancy_rate &gt; 85 AND ra.avg_hourly_rate &lt; ra.avg_competitor_rate THEN
ra.avg_hourly_rate * 1.15  -- Increase price if high demand and underpriced
WHEN ra.avg_occupancy_rate &lt; 50 AND ra.avg_hourly_rate &gt; ra.avg_competitor_rate THEN
ra.avg_hourly_rate * 0.90  -- Decrease price if low demand and overpriced
WHEN ra.avg_hourly_rate &lt; ra.median_competitor_rate * 0.9 THEN
ra.median_competitor_rate * 0.95  -- Price slightly below median if significantly underpriced
ELSE ra.avg_hourly_rate  -- Keep current price
END AS recommended_rate,
-- Revenue impact estimate
(
CASE
WHEN ra.avg_occupancy_rate &gt; 85 AND ra.avg_hourly_rate &lt; ra.avg_competitor_rate THEN
ra.avg_hourly_rate * 1.15 * ra.total_spaces * ra.avg_occupancy_rate / 100.0 * ra.days_with_data
WHEN ra.avg_occupancy_rate &lt; 50 AND ra.avg_hourly_rate &gt; ra.avg_competitor_rate THEN
ra.avg_hourly_rate * 0.90 * ra.total_spaces * ra.avg_occupancy_rate / 100.0 * ra.days_with_data
ELSE ra.total_revenue
END - ra.total_revenue
) AS estimated_revenue_impact,
-- Market share estimate
CASE
WHEN ra.competitor_count &gt; 0 AND ra.total_spaces &gt; 0 THEN
(ra.total_spaces * ra.avg_occupancy_rate / 100.0) /
NULLIF(
(ra.total_spaces * ra.avg_occupancy_rate / 100.0) +
(ra.competitor_count * COALESCE(ra.avg_competitor_rate, 0) * 50),  -- Estimate competitor spaces
1
) * 100
ELSE 100.0
END AS estimated_market_share_pct
FROM ranked_analysis ra
)
SELECT
or_rec.facility_id,
or_rec.facility_name,
or_rec.city_name,
or_rec.state_code,
or_rec.msa_name,
or_rec.total_spaces,
or_rec.facility_type,
or_rec.operator_type,
or_rec.avg_occupancy_rate,
or_rec.median_occupancy_rate,
or_rec.p95_occupancy_rate,
or_rec.total_revenue,
or_rec.avg_hourly_rate AS current_rate,
or_rec.recommended_rate,
or_rec.competitor_count,
or_rec.avg_competitor_rate,
or_rec.median_competitor_rate,
or_rec.market_opportunity_score,
or_rec.competitive_advantage_score,
or_rec.opportunity_percentile,
or_rec.revenue_percentile,
or_rec.competitive_percentile,
or_rec.optimization_priority,
or_rec.estimated_revenue_impact,
or_rec.estimated_market_share_pct,
CASE
WHEN or_rec.estimated_revenue_impact &gt; 1000 THEN 'High Impact'
WHEN or_rec.estimated_revenue_impact &gt; 0 THEN 'Medium Impact'
ELSE 'Low Impact'
END AS impact_category
FROM optimization_recommendations or_rec
WHERE or_rec.competitor_count &gt; 0 OR or_rec.total_revenue &gt; 0
ORDER BY or_rec.market_opportunity_score DESC, or_rec.total_revenue DESC
LIMIT 200;
</p>
</code></pre>
<p>
---
</p>
<h2 id="query-25-price-elasticity-analysis-with-demand-response-modeling-and-revenue-optimization-query-25-"></h2>
<strong>Use Case:</strong> <strong>Understand price sensitivity and optimize pricing for revenue maximization.</strong>
<strong>Description:</strong> Analyzes price elasticity using CTEs for demand response modeling, elasticity calculations, and revenue optimization.
<strong>Use Case:</strong> Understand price sensitivity and optimize pricing for revenue maximization.
<strong>Business Value:</strong> Price elasticity report with demand response analysis and pricing recommendations.
<strong>Purpose:</strong> Enables data-driven decision making through advanced analytics and business intelligence.
<strong>Complexity:</strong> Elasticity CTEs (6+ levels), demand modeling, revenue optimization
<strong>Expected Output:</strong> Query results with analysis and recommendations.
<pre><code class="language-sql">WITH facility_base_data AS (
<p>
SELECT
pf.facility_id,
pf.facility_name,
pf.city_id,
pf.total_spaces,
pf.facility_type,
pf.operator_type,
pf.latitude,
pf.longitude,
pf.is_event_parking,
pf.is_monthly_parking,
pf.accepts_reservations,
c.city_name,
c.state_code,
c.population,
c.population_density,
c.median_household_income,
c.employment_total,
ma.msa_name,
ma.gdp_billions,
ma.population_estimate AS msa_population
FROM parking_facilities pf
INNER JOIN cities c ON pf.city_id = c.city_id
INNER JOIN metropolitan_areas ma ON c.msa_id = ma.msa_id
WHERE pf.is_hourly_parking = TRUE
),
utilization_aggregations AS (
SELECT
pu.facility_id,
pu.utilization_date,
pu.utilization_hour,
AVG(pu.occupancy_rate) AS avg_occupancy_rate,
PERCENTILE_CONT(0.5) WITHIN GROUP (ORDER BY pu.occupancy_rate) AS median_occupancy_rate,
PERCENTILE_CONT(0.75) WITHIN GROUP (ORDER BY pu.occupancy_rate) AS p75_occupancy_rate,
PERCENTILE_CONT(0.95) WITHIN GROUP (ORDER BY pu.occupancy_rate) AS p95_occupancy_rate,
SUM(pu.revenue_generated) AS total_revenue,
AVG(pu.revenue_generated) AS avg_revenue_per_record,
COUNT(*) AS utilization_records,
COUNT(DISTINCT pu.utilization_date) AS days_with_data,
DATE_PART('dow', pu.utilization_date) AS day_of_week
FROM parking_utilization pu
WHERE pu.utilization_date &gt;= CURRENT_DATE - INTERVAL '90 days'
GROUP BY pu.facility_id, pu.utilization_date, pu.utilization_hour, DATE_PART('dow', pu.utilization_date)
),
pricing_analysis AS (
SELECT
pp.facility_id,
AVG(pp.base_rate_hourly) AS avg_hourly_rate,
AVG(pp.base_rate_daily) AS avg_daily_rate,
AVG(pp.base_rate_monthly) AS avg_monthly_rate,
MIN(pp.base_rate_hourly) AS min_hourly_rate,
MAX(pp.base_rate_hourly) AS max_hourly_rate,
PERCENTILE_CONT(0.5) WITHIN GROUP (ORDER BY pp.base_rate_hourly) AS median_hourly_rate,
PERCENTILE_CONT(0.75) WITHIN GROUP (ORDER BY pp.base_rate_hourly) AS p75_hourly_rate,
COUNT(*) AS pricing_records
FROM parking_pricing pp
WHERE pp.is_active = TRUE
AND pp.pricing_type IN ('Hourly', 'Daily', 'Monthly')
GROUP BY pp.facility_id
),
competitive_landscape AS (
SELECT
fbd1.facility_id,
fbd1.city_id,
COUNT(DISTINCT fbd2.facility_id) AS competitor_count,
AVG(fbd2.total_spaces) AS avg_competitor_spaces,
SUM(fbd2.total_spaces) AS total_competitor_spaces,
AVG(pa2.avg_hourly_rate) AS avg_competitor_rate,
MIN(pa2.avg_hourly_rate) AS min_competitor_rate,
MAX(pa2.avg_hourly_rate) AS max_competitor_rate,
PERCENTILE_CONT(0.5) WITHIN GROUP (ORDER BY pa2.avg_hourly_rate) AS median_competitor_rate,
AVG(
CASE
WHEN ST_DISTANCE(
ST_POINT(fbd1.longitude, fbd1.latitude),
ST_POINT(fbd2.longitude, fbd2.latitude)
) &lt; 500 THEN ST_DISTANCE(
ST_POINT(fbd1.longitude, fbd1.latitude),
ST_POINT(fbd2.longitude, fbd2.latitude)
)
ELSE NULL
END
) AS avg_distance_to_competitors
FROM facility_base_data fbd1
LEFT JOIN facility_base_data fbd2 ON fbd1.city_id = fbd2.city_id
AND fbd2.facility_id != fbd1.facility_id
AND ST_DISTANCE(
ST_POINT(fbd1.longitude, fbd1.latitude),
ST_POINT(fbd2.longitude, fbd2.latitude)
) &lt; 1000
LEFT JOIN pricing_analysis pa2 ON fbd2.facility_id = pa2.facility_id
GROUP BY fbd1.facility_id, fbd1.city_id, fbd1.latitude, fbd1.longitude
),
market_intelligence AS (
SELECT
fbd.facility_id,
fbd.facility_name,
fbd.city_id,
fbd.city_name,
fbd.state_code,
fbd.msa_name,
fbd.total_spaces,
fbd.facility_type,
fbd.operator_type,
fbd.population,
fbd.population_density,
fbd.median_household_income,
fbd.msa_population,
COALESCE(ua.avg_occupancy_rate, 0) AS avg_occupancy_rate,
COALESCE(ua.median_occupancy_rate, 0) AS median_occupancy_rate,
COALESCE(ua.p95_occupancy_rate, 0) AS p95_occupancy_rate,
COALESCE(ua.total_revenue, 0) AS total_revenue,
COALESCE(ua.avg_revenue_per_record, 0) AS avg_revenue_per_record,
COALESCE(ua.days_with_data, 0) AS days_with_data,
COALESCE(pa.avg_hourly_rate, 0) AS avg_hourly_rate,
COALESCE(pa.median_hourly_rate, 0) AS median_hourly_rate,
COALESCE(pa.p75_hourly_rate, 0) AS p75_hourly_rate,
COALESCE(cl.competitor_count, 0) AS competitor_count,
COALESCE(cl.avg_competitor_rate, 0) AS avg_competitor_rate,
COALESCE(cl.median_competitor_rate, 0) AS median_competitor_rate,
COALESCE(cl.avg_distance_to_competitors, 0) AS avg_distance_to_competitors,
-- Market opportunity score
(
LEAST(fbd.population_density / 10000.0, 1.0) * 25 +
LEAST(COALESCE(ua.avg_occupancy_rate, 0) / 100.0, 1.0) * 25 +
LEAST(fbd.median_household_income / 100000.0, 1.0) * 20 +
LEAST(COALESCE(cl.competitor_count, 0) / 10.0, 1.0) * 15 +
LEAST(fbd.total_spaces / 500.0, 1.0) * 15
) AS market_opportunity_score,
-- Competitive advantage score
(
CASE WHEN COALESCE(pa.avg_hourly_rate, 0) &lt; COALESCE(cl.avg_competitor_rate, 999) THEN 30 ELSE 0 END +
CASE WHEN COALESCE(ua.avg_occupancy_rate, 0) &gt; 80 THEN 25 ELSE COALESCE(ua.avg_occupancy_rate, 0) * 0.3125 END +
CASE WHEN COALESCE(cl.competitor_count, 0) &lt; 3 THEN 25 ELSE GREATEST(25 - COALESCE(cl.competitor_count, 0) * 2, 0) END +
CASE WHEN fbd.accepts_reservations THEN 20 ELSE 0 END
) AS competitive_advantage_score
FROM facility_base_data fbd
LEFT JOIN utilization_aggregations ua ON fbd.facility_id = ua.facility_id
LEFT JOIN pricing_analysis pa ON fbd.facility_id = pa.facility_id
LEFT JOIN competitive_landscape cl ON fbd.facility_id = cl.facility_id
),
ranked_analysis AS (
SELECT
mi.*,
ROW_NUMBER() OVER (PARTITION BY mi.city_id ORDER BY mi.market_opportunity_score DESC) AS city_rank,
ROW_NUMBER() OVER (ORDER BY mi.total_revenue DESC) AS revenue_rank,
ROW_NUMBER() OVER (ORDER BY mi.competitive_advantage_score DESC) AS competitive_rank,
PERCENT_RANK() OVER (ORDER BY mi.market_opportunity_score) AS opportunity_percentile,
PERCENT_RANK() OVER (ORDER BY mi.total_revenue) AS revenue_percentile,
PERCENT_RANK() OVER (ORDER BY mi.competitive_advantage_score) AS competitive_percentile,
LAG(mi.market_opportunity_score) OVER (ORDER BY mi.market_opportunity_score DESC) AS prev_opportunity_score,
LEAD(mi.market_opportunity_score) OVER (ORDER BY mi.market_opportunity_score DESC) AS next_opportunity_score,
AVG(mi.market_opportunity_score) OVER (PARTITION BY mi.city_id) AS city_avg_opportunity_score,
STDDEV(mi.market_opportunity_score) OVER (PARTITION BY mi.city_id) AS city_stddev_opportunity_score,
AVG(mi.total_revenue) OVER (PARTITION BY mi.city_id) AS city_avg_revenue,
AVG(mi.avg_occupancy_rate) OVER (PARTITION BY mi.city_id) AS city_avg_occupancy_rate
FROM market_intelligence mi
),
optimization_recommendations AS (
SELECT
ra.*,
CASE
WHEN ra.market_opportunity_score &gt;= ra.city_avg_opportunity_score + ra.city_stddev_opportunity_score THEN 'High Priority'
WHEN ra.market_opportunity_score &gt;= ra.city_avg_opportunity_score THEN 'Medium Priority'
ELSE 'Low Priority'
END AS optimization_priority,
CASE
WHEN ra.avg_occupancy_rate &gt; 85 AND ra.avg_hourly_rate &lt; ra.avg_competitor_rate THEN
ra.avg_hourly_rate * 1.15  -- Increase price if high demand and underpriced
WHEN ra.avg_occupancy_rate &lt; 50 AND ra.avg_hourly_rate &gt; ra.avg_competitor_rate THEN
ra.avg_hourly_rate * 0.90  -- Decrease price if low demand and overpriced
WHEN ra.avg_hourly_rate &lt; ra.median_competitor_rate * 0.9 THEN
ra.median_competitor_rate * 0.95  -- Price slightly below median if significantly underpriced
ELSE ra.avg_hourly_rate  -- Keep current price
END AS recommended_rate,
-- Revenue impact estimate
(
CASE
WHEN ra.avg_occupancy_rate &gt; 85 AND ra.avg_hourly_rate &lt; ra.avg_competitor_rate THEN
ra.avg_hourly_rate * 1.15 * ra.total_spaces * ra.avg_occupancy_rate / 100.0 * ra.days_with_data
WHEN ra.avg_occupancy_rate &lt; 50 AND ra.avg_hourly_rate &gt; ra.avg_competitor_rate THEN
ra.avg_hourly_rate * 0.90 * ra.total_spaces * ra.avg_occupancy_rate / 100.0 * ra.days_with_data
ELSE ra.total_revenue
END - ra.total_revenue
) AS estimated_revenue_impact,
-- Market share estimate
CASE
WHEN ra.competitor_count &gt; 0 AND ra.total_spaces &gt; 0 THEN
(ra.total_spaces * ra.avg_occupancy_rate / 100.0) /
NULLIF(
(ra.total_spaces * ra.avg_occupancy_rate / 100.0) +
(ra.competitor_count * COALESCE(ra.avg_competitor_rate, 0) * 50),  -- Estimate competitor spaces
1
) * 100
ELSE 100.0
END AS estimated_market_share_pct
FROM ranked_analysis ra
)
SELECT
or_rec.facility_id,
or_rec.facility_name,
or_rec.city_name,
or_rec.state_code,
or_rec.msa_name,
or_rec.total_spaces,
or_rec.facility_type,
or_rec.operator_type,
or_rec.avg_occupancy_rate,
or_rec.median_occupancy_rate,
or_rec.p95_occupancy_rate,
or_rec.total_revenue,
or_rec.avg_hourly_rate AS current_rate,
or_rec.recommended_rate,
or_rec.competitor_count,
or_rec.avg_competitor_rate,
or_rec.median_competitor_rate,
or_rec.market_opportunity_score,
or_rec.competitive_advantage_score,
or_rec.opportunity_percentile,
or_rec.revenue_percentile,
or_rec.competitive_percentile,
or_rec.optimization_priority,
or_rec.estimated_revenue_impact,
or_rec.estimated_market_share_pct,
CASE
WHEN or_rec.estimated_revenue_impact &gt; 1000 THEN 'High Impact'
WHEN or_rec.estimated_revenue_impact &gt; 0 THEN 'Medium Impact'
ELSE 'Low Impact'
END AS impact_category
FROM optimization_recommendations or_rec
WHERE or_rec.competitor_count &gt; 0 OR or_rec.total_revenue &gt; 0
ORDER BY or_rec.market_opportunity_score DESC, or_rec.total_revenue DESC
LIMIT 200;
</p>
</code></pre>
<p>
---
</p>
<h2 id="query-26-supply-demand-gap-analysis-with-capacity-planning-and-facility-expansion-recommendations-query-26-"></h2>
<strong>Use Case:</strong> <strong>Identify supply-demand gaps and plan facility expansion.</strong>
<strong>Description:</strong> Analyzes supply-demand gaps using CTEs for gap identification, capacity planning, and expansion recommendations.
<strong>Use Case:</strong> Identify supply-demand gaps and plan facility expansion.
<strong>Business Value:</strong> Supply-demand gap report with capacity planning and expansion recommendations.
<strong>Purpose:</strong> Enables data-driven decision making through advanced analytics and business intelligence.
<strong>Complexity:</strong> Gap analysis CTEs (6+ levels), capacity planning, expansion modeling
<strong>Expected Output:</strong> Query results with analysis and recommendations.
<pre><code class="language-sql">WITH facility_base_data AS (
<p>
SELECT
pf.facility_id,
pf.facility_name,
pf.city_id,
pf.total_spaces,
pf.facility_type,
pf.operator_type,
pf.latitude,
pf.longitude,
pf.is_event_parking,
pf.is_monthly_parking,
pf.accepts_reservations,
c.city_name,
c.state_code,
c.population,
c.population_density,
c.median_household_income,
c.employment_total,
ma.msa_name,
ma.gdp_billions,
ma.population_estimate AS msa_population
FROM parking_facilities pf
INNER JOIN cities c ON pf.city_id = c.city_id
INNER JOIN metropolitan_areas ma ON c.msa_id = ma.msa_id
WHERE pf.is_hourly_parking = TRUE
),
utilization_aggregations AS (
SELECT
pu.facility_id,
pu.utilization_date,
pu.utilization_hour,
AVG(pu.occupancy_rate) AS avg_occupancy_rate,
PERCENTILE_CONT(0.5) WITHIN GROUP (ORDER BY pu.occupancy_rate) AS median_occupancy_rate,
PERCENTILE_CONT(0.75) WITHIN GROUP (ORDER BY pu.occupancy_rate) AS p75_occupancy_rate,
PERCENTILE_CONT(0.95) WITHIN GROUP (ORDER BY pu.occupancy_rate) AS p95_occupancy_rate,
SUM(pu.revenue_generated) AS total_revenue,
AVG(pu.revenue_generated) AS avg_revenue_per_record,
COUNT(*) AS utilization_records,
COUNT(DISTINCT pu.utilization_date) AS days_with_data,
DATE_PART('dow', pu.utilization_date) AS day_of_week
FROM parking_utilization pu
WHERE pu.utilization_date &gt;= CURRENT_DATE - INTERVAL '90 days'
GROUP BY pu.facility_id, pu.utilization_date, pu.utilization_hour, DATE_PART('dow', pu.utilization_date)
),
pricing_analysis AS (
SELECT
pp.facility_id,
AVG(pp.base_rate_hourly) AS avg_hourly_rate,
AVG(pp.base_rate_daily) AS avg_daily_rate,
AVG(pp.base_rate_monthly) AS avg_monthly_rate,
MIN(pp.base_rate_hourly) AS min_hourly_rate,
MAX(pp.base_rate_hourly) AS max_hourly_rate,
PERCENTILE_CONT(0.5) WITHIN GROUP (ORDER BY pp.base_rate_hourly) AS median_hourly_rate,
PERCENTILE_CONT(0.75) WITHIN GROUP (ORDER BY pp.base_rate_hourly) AS p75_hourly_rate,
COUNT(*) AS pricing_records
FROM parking_pricing pp
WHERE pp.is_active = TRUE
AND pp.pricing_type IN ('Hourly', 'Daily', 'Monthly')
GROUP BY pp.facility_id
),
competitive_landscape AS (
SELECT
fbd1.facility_id,
fbd1.city_id,
COUNT(DISTINCT fbd2.facility_id) AS competitor_count,
AVG(fbd2.total_spaces) AS avg_competitor_spaces,
SUM(fbd2.total_spaces) AS total_competitor_spaces,
AVG(pa2.avg_hourly_rate) AS avg_competitor_rate,
MIN(pa2.avg_hourly_rate) AS min_competitor_rate,
MAX(pa2.avg_hourly_rate) AS max_competitor_rate,
PERCENTILE_CONT(0.5) WITHIN GROUP (ORDER BY pa2.avg_hourly_rate) AS median_competitor_rate,
AVG(
CASE
WHEN ST_DISTANCE(
ST_POINT(fbd1.longitude, fbd1.latitude),
ST_POINT(fbd2.longitude, fbd2.latitude)
) &lt; 500 THEN ST_DISTANCE(
ST_POINT(fbd1.longitude, fbd1.latitude),
ST_POINT(fbd2.longitude, fbd2.latitude)
)
ELSE NULL
END
) AS avg_distance_to_competitors
FROM facility_base_data fbd1
LEFT JOIN facility_base_data fbd2 ON fbd1.city_id = fbd2.city_id
AND fbd2.facility_id != fbd1.facility_id
AND ST_DISTANCE(
ST_POINT(fbd1.longitude, fbd1.latitude),
ST_POINT(fbd2.longitude, fbd2.latitude)
) &lt; 1000
LEFT JOIN pricing_analysis pa2 ON fbd2.facility_id = pa2.facility_id
GROUP BY fbd1.facility_id, fbd1.city_id, fbd1.latitude, fbd1.longitude
),
market_intelligence AS (
SELECT
fbd.facility_id,
fbd.facility_name,
fbd.city_id,
fbd.city_name,
fbd.state_code,
fbd.msa_name,
fbd.total_spaces,
fbd.facility_type,
fbd.operator_type,
fbd.population,
fbd.population_density,
fbd.median_household_income,
fbd.msa_population,
COALESCE(ua.avg_occupancy_rate, 0) AS avg_occupancy_rate,
COALESCE(ua.median_occupancy_rate, 0) AS median_occupancy_rate,
COALESCE(ua.p95_occupancy_rate, 0) AS p95_occupancy_rate,
COALESCE(ua.total_revenue, 0) AS total_revenue,
COALESCE(ua.avg_revenue_per_record, 0) AS avg_revenue_per_record,
COALESCE(ua.days_with_data, 0) AS days_with_data,
COALESCE(pa.avg_hourly_rate, 0) AS avg_hourly_rate,
COALESCE(pa.median_hourly_rate, 0) AS median_hourly_rate,
COALESCE(pa.p75_hourly_rate, 0) AS p75_hourly_rate,
COALESCE(cl.competitor_count, 0) AS competitor_count,
COALESCE(cl.avg_competitor_rate, 0) AS avg_competitor_rate,
COALESCE(cl.median_competitor_rate, 0) AS median_competitor_rate,
COALESCE(cl.avg_distance_to_competitors, 0) AS avg_distance_to_competitors,
-- Market opportunity score
(
LEAST(fbd.population_density / 10000.0, 1.0) * 25 +
LEAST(COALESCE(ua.avg_occupancy_rate, 0) / 100.0, 1.0) * 25 +
LEAST(fbd.median_household_income / 100000.0, 1.0) * 20 +
LEAST(COALESCE(cl.competitor_count, 0) / 10.0, 1.0) * 15 +
LEAST(fbd.total_spaces / 500.0, 1.0) * 15
) AS market_opportunity_score,
-- Competitive advantage score
(
CASE WHEN COALESCE(pa.avg_hourly_rate, 0) &lt; COALESCE(cl.avg_competitor_rate, 999) THEN 30 ELSE 0 END +
CASE WHEN COALESCE(ua.avg_occupancy_rate, 0) &gt; 80 THEN 25 ELSE COALESCE(ua.avg_occupancy_rate, 0) * 0.3125 END +
CASE WHEN COALESCE(cl.competitor_count, 0) &lt; 3 THEN 25 ELSE GREATEST(25 - COALESCE(cl.competitor_count, 0) * 2, 0) END +
CASE WHEN fbd.accepts_reservations THEN 20 ELSE 0 END
) AS competitive_advantage_score
FROM facility_base_data fbd
LEFT JOIN utilization_aggregations ua ON fbd.facility_id = ua.facility_id
LEFT JOIN pricing_analysis pa ON fbd.facility_id = pa.facility_id
LEFT JOIN competitive_landscape cl ON fbd.facility_id = cl.facility_id
),
ranked_analysis AS (
SELECT
mi.*,
ROW_NUMBER() OVER (PARTITION BY mi.city_id ORDER BY mi.market_opportunity_score DESC) AS city_rank,
ROW_NUMBER() OVER (ORDER BY mi.total_revenue DESC) AS revenue_rank,
ROW_NUMBER() OVER (ORDER BY mi.competitive_advantage_score DESC) AS competitive_rank,
PERCENT_RANK() OVER (ORDER BY mi.market_opportunity_score) AS opportunity_percentile,
PERCENT_RANK() OVER (ORDER BY mi.total_revenue) AS revenue_percentile,
PERCENT_RANK() OVER (ORDER BY mi.competitive_advantage_score) AS competitive_percentile,
LAG(mi.market_opportunity_score) OVER (ORDER BY mi.market_opportunity_score DESC) AS prev_opportunity_score,
LEAD(mi.market_opportunity_score) OVER (ORDER BY mi.market_opportunity_score DESC) AS next_opportunity_score,
AVG(mi.market_opportunity_score) OVER (PARTITION BY mi.city_id) AS city_avg_opportunity_score,
STDDEV(mi.market_opportunity_score) OVER (PARTITION BY mi.city_id) AS city_stddev_opportunity_score,
AVG(mi.total_revenue) OVER (PARTITION BY mi.city_id) AS city_avg_revenue,
AVG(mi.avg_occupancy_rate) OVER (PARTITION BY mi.city_id) AS city_avg_occupancy_rate
FROM market_intelligence mi
),
optimization_recommendations AS (
SELECT
ra.*,
CASE
WHEN ra.market_opportunity_score &gt;= ra.city_avg_opportunity_score + ra.city_stddev_opportunity_score THEN 'High Priority'
WHEN ra.market_opportunity_score &gt;= ra.city_avg_opportunity_score THEN 'Medium Priority'
ELSE 'Low Priority'
END AS optimization_priority,
CASE
WHEN ra.avg_occupancy_rate &gt; 85 AND ra.avg_hourly_rate &lt; ra.avg_competitor_rate THEN
ra.avg_hourly_rate * 1.15  -- Increase price if high demand and underpriced
WHEN ra.avg_occupancy_rate &lt; 50 AND ra.avg_hourly_rate &gt; ra.avg_competitor_rate THEN
ra.avg_hourly_rate * 0.90  -- Decrease price if low demand and overpriced
WHEN ra.avg_hourly_rate &lt; ra.median_competitor_rate * 0.9 THEN
ra.median_competitor_rate * 0.95  -- Price slightly below median if significantly underpriced
ELSE ra.avg_hourly_rate  -- Keep current price
END AS recommended_rate,
-- Revenue impact estimate
(
CASE
WHEN ra.avg_occupancy_rate &gt; 85 AND ra.avg_hourly_rate &lt; ra.avg_competitor_rate THEN
ra.avg_hourly_rate * 1.15 * ra.total_spaces * ra.avg_occupancy_rate / 100.0 * ra.days_with_data
WHEN ra.avg_occupancy_rate &lt; 50 AND ra.avg_hourly_rate &gt; ra.avg_competitor_rate THEN
ra.avg_hourly_rate * 0.90 * ra.total_spaces * ra.avg_occupancy_rate / 100.0 * ra.days_with_data
ELSE ra.total_revenue
END - ra.total_revenue
) AS estimated_revenue_impact,
-- Market share estimate
CASE
WHEN ra.competitor_count &gt; 0 AND ra.total_spaces &gt; 0 THEN
(ra.total_spaces * ra.avg_occupancy_rate / 100.0) /
NULLIF(
(ra.total_spaces * ra.avg_occupancy_rate / 100.0) +
(ra.competitor_count * COALESCE(ra.avg_competitor_rate, 0) * 50),  -- Estimate competitor spaces
1
) * 100
ELSE 100.0
END AS estimated_market_share_pct
FROM ranked_analysis ra
)
SELECT
or_rec.facility_id,
or_rec.facility_name,
or_rec.city_name,
or_rec.state_code,
or_rec.msa_name,
or_rec.total_spaces,
or_rec.facility_type,
or_rec.operator_type,
or_rec.avg_occupancy_rate,
or_rec.median_occupancy_rate,
or_rec.p95_occupancy_rate,
or_rec.total_revenue,
or_rec.avg_hourly_rate AS current_rate,
or_rec.recommended_rate,
or_rec.competitor_count,
or_rec.avg_competitor_rate,
or_rec.median_competitor_rate,
or_rec.market_opportunity_score,
or_rec.competitive_advantage_score,
or_rec.opportunity_percentile,
or_rec.revenue_percentile,
or_rec.competitive_percentile,
or_rec.optimization_priority,
or_rec.estimated_revenue_impact,
or_rec.estimated_market_share_pct,
CASE
WHEN or_rec.estimated_revenue_impact &gt; 1000 THEN 'High Impact'
WHEN or_rec.estimated_revenue_impact &gt; 0 THEN 'Medium Impact'
ELSE 'Low Impact'
END AS impact_category
FROM optimization_recommendations or_rec
WHERE or_rec.competitor_count &gt; 0 OR or_rec.total_revenue &gt; 0
ORDER BY or_rec.market_opportunity_score DESC, or_rec.total_revenue DESC
LIMIT 200;
</p>
</code></pre>
<p>
---
</p>
<h2 id="query-27-market-penetration-analysis-with-growth-metrics-and-expansion-strategies-query-27-"></h2>
<strong>Use Case:</strong> <strong>Measure market penetration and develop expansion strategies.</strong>
<strong>Description:</strong> Analyzes market penetration using CTEs for penetration calculations, growth metrics, and expansion strategy development.
<strong>Use Case:</strong> Measure market penetration and develop expansion strategies.
<strong>Business Value:</strong> Market penetration report with growth metrics and expansion strategies.
<strong>Purpose:</strong> Enables data-driven decision making through advanced analytics and business intelligence.
<strong>Complexity:</strong> Penetration CTEs (6+ levels), growth metrics, expansion strategies
<strong>Expected Output:</strong> Query results with analysis and recommendations.
<pre><code class="language-sql">WITH facility_base_data AS (
<p>
SELECT
pf.facility_id,
pf.facility_name,
pf.city_id,
pf.total_spaces,
pf.facility_type,
pf.operator_type,
pf.latitude,
pf.longitude,
pf.is_event_parking,
pf.is_monthly_parking,
pf.accepts_reservations,
c.city_name,
c.state_code,
c.population,
c.population_density,
c.median_household_income,
c.employment_total,
ma.msa_name,
ma.gdp_billions,
ma.population_estimate AS msa_population
FROM parking_facilities pf
INNER JOIN cities c ON pf.city_id = c.city_id
INNER JOIN metropolitan_areas ma ON c.msa_id = ma.msa_id
WHERE pf.is_hourly_parking = TRUE
),
utilization_aggregations AS (
SELECT
pu.facility_id,
pu.utilization_date,
pu.utilization_hour,
AVG(pu.occupancy_rate) AS avg_occupancy_rate,
PERCENTILE_CONT(0.5) WITHIN GROUP (ORDER BY pu.occupancy_rate) AS median_occupancy_rate,
PERCENTILE_CONT(0.75) WITHIN GROUP (ORDER BY pu.occupancy_rate) AS p75_occupancy_rate,
PERCENTILE_CONT(0.95) WITHIN GROUP (ORDER BY pu.occupancy_rate) AS p95_occupancy_rate,
SUM(pu.revenue_generated) AS total_revenue,
AVG(pu.revenue_generated) AS avg_revenue_per_record,
COUNT(*) AS utilization_records,
COUNT(DISTINCT pu.utilization_date) AS days_with_data,
DATE_PART('dow', pu.utilization_date) AS day_of_week
FROM parking_utilization pu
WHERE pu.utilization_date &gt;= CURRENT_DATE - INTERVAL '90 days'
GROUP BY pu.facility_id, pu.utilization_date, pu.utilization_hour, DATE_PART('dow', pu.utilization_date)
),
pricing_analysis AS (
SELECT
pp.facility_id,
AVG(pp.base_rate_hourly) AS avg_hourly_rate,
AVG(pp.base_rate_daily) AS avg_daily_rate,
AVG(pp.base_rate_monthly) AS avg_monthly_rate,
MIN(pp.base_rate_hourly) AS min_hourly_rate,
MAX(pp.base_rate_hourly) AS max_hourly_rate,
PERCENTILE_CONT(0.5) WITHIN GROUP (ORDER BY pp.base_rate_hourly) AS median_hourly_rate,
PERCENTILE_CONT(0.75) WITHIN GROUP (ORDER BY pp.base_rate_hourly) AS p75_hourly_rate,
COUNT(*) AS pricing_records
FROM parking_pricing pp
WHERE pp.is_active = TRUE
AND pp.pricing_type IN ('Hourly', 'Daily', 'Monthly')
GROUP BY pp.facility_id
),
competitive_landscape AS (
SELECT
fbd1.facility_id,
fbd1.city_id,
COUNT(DISTINCT fbd2.facility_id) AS competitor_count,
AVG(fbd2.total_spaces) AS avg_competitor_spaces,
SUM(fbd2.total_spaces) AS total_competitor_spaces,
AVG(pa2.avg_hourly_rate) AS avg_competitor_rate,
MIN(pa2.avg_hourly_rate) AS min_competitor_rate,
MAX(pa2.avg_hourly_rate) AS max_competitor_rate,
PERCENTILE_CONT(0.5) WITHIN GROUP (ORDER BY pa2.avg_hourly_rate) AS median_competitor_rate,
AVG(
CASE
WHEN ST_DISTANCE(
ST_POINT(fbd1.longitude, fbd1.latitude),
ST_POINT(fbd2.longitude, fbd2.latitude)
) &lt; 500 THEN ST_DISTANCE(
ST_POINT(fbd1.longitude, fbd1.latitude),
ST_POINT(fbd2.longitude, fbd2.latitude)
)
ELSE NULL
END
) AS avg_distance_to_competitors
FROM facility_base_data fbd1
LEFT JOIN facility_base_data fbd2 ON fbd1.city_id = fbd2.city_id
AND fbd2.facility_id != fbd1.facility_id
AND ST_DISTANCE(
ST_POINT(fbd1.longitude, fbd1.latitude),
ST_POINT(fbd2.longitude, fbd2.latitude)
) &lt; 1000
LEFT JOIN pricing_analysis pa2 ON fbd2.facility_id = pa2.facility_id
GROUP BY fbd1.facility_id, fbd1.city_id, fbd1.latitude, fbd1.longitude
),
market_intelligence AS (
SELECT
fbd.facility_id,
fbd.facility_name,
fbd.city_id,
fbd.city_name,
fbd.state_code,
fbd.msa_name,
fbd.total_spaces,
fbd.facility_type,
fbd.operator_type,
fbd.population,
fbd.population_density,
fbd.median_household_income,
fbd.msa_population,
COALESCE(ua.avg_occupancy_rate, 0) AS avg_occupancy_rate,
COALESCE(ua.median_occupancy_rate, 0) AS median_occupancy_rate,
COALESCE(ua.p95_occupancy_rate, 0) AS p95_occupancy_rate,
COALESCE(ua.total_revenue, 0) AS total_revenue,
COALESCE(ua.avg_revenue_per_record, 0) AS avg_revenue_per_record,
COALESCE(ua.days_with_data, 0) AS days_with_data,
COALESCE(pa.avg_hourly_rate, 0) AS avg_hourly_rate,
COALESCE(pa.median_hourly_rate, 0) AS median_hourly_rate,
COALESCE(pa.p75_hourly_rate, 0) AS p75_hourly_rate,
COALESCE(cl.competitor_count, 0) AS competitor_count,
COALESCE(cl.avg_competitor_rate, 0) AS avg_competitor_rate,
COALESCE(cl.median_competitor_rate, 0) AS median_competitor_rate,
COALESCE(cl.avg_distance_to_competitors, 0) AS avg_distance_to_competitors,
-- Market opportunity score
(
LEAST(fbd.population_density / 10000.0, 1.0) * 25 +
LEAST(COALESCE(ua.avg_occupancy_rate, 0) / 100.0, 1.0) * 25 +
LEAST(fbd.median_household_income / 100000.0, 1.0) * 20 +
LEAST(COALESCE(cl.competitor_count, 0) / 10.0, 1.0) * 15 +
LEAST(fbd.total_spaces / 500.0, 1.0) * 15
) AS market_opportunity_score,
-- Competitive advantage score
(
CASE WHEN COALESCE(pa.avg_hourly_rate, 0) &lt; COALESCE(cl.avg_competitor_rate, 999) THEN 30 ELSE 0 END +
CASE WHEN COALESCE(ua.avg_occupancy_rate, 0) &gt; 80 THEN 25 ELSE COALESCE(ua.avg_occupancy_rate, 0) * 0.3125 END +
CASE WHEN COALESCE(cl.competitor_count, 0) &lt; 3 THEN 25 ELSE GREATEST(25 - COALESCE(cl.competitor_count, 0) * 2, 0) END +
CASE WHEN fbd.accepts_reservations THEN 20 ELSE 0 END
) AS competitive_advantage_score
FROM facility_base_data fbd
LEFT JOIN utilization_aggregations ua ON fbd.facility_id = ua.facility_id
LEFT JOIN pricing_analysis pa ON fbd.facility_id = pa.facility_id
LEFT JOIN competitive_landscape cl ON fbd.facility_id = cl.facility_id
),
ranked_analysis AS (
SELECT
mi.*,
ROW_NUMBER() OVER (PARTITION BY mi.city_id ORDER BY mi.market_opportunity_score DESC) AS city_rank,
ROW_NUMBER() OVER (ORDER BY mi.total_revenue DESC) AS revenue_rank,
ROW_NUMBER() OVER (ORDER BY mi.competitive_advantage_score DESC) AS competitive_rank,
PERCENT_RANK() OVER (ORDER BY mi.market_opportunity_score) AS opportunity_percentile,
PERCENT_RANK() OVER (ORDER BY mi.total_revenue) AS revenue_percentile,
PERCENT_RANK() OVER (ORDER BY mi.competitive_advantage_score) AS competitive_percentile,
LAG(mi.market_opportunity_score) OVER (ORDER BY mi.market_opportunity_score DESC) AS prev_opportunity_score,
LEAD(mi.market_opportunity_score) OVER (ORDER BY mi.market_opportunity_score DESC) AS next_opportunity_score,
AVG(mi.market_opportunity_score) OVER (PARTITION BY mi.city_id) AS city_avg_opportunity_score,
STDDEV(mi.market_opportunity_score) OVER (PARTITION BY mi.city_id) AS city_stddev_opportunity_score,
AVG(mi.total_revenue) OVER (PARTITION BY mi.city_id) AS city_avg_revenue,
AVG(mi.avg_occupancy_rate) OVER (PARTITION BY mi.city_id) AS city_avg_occupancy_rate
FROM market_intelligence mi
),
optimization_recommendations AS (
SELECT
ra.*,
CASE
WHEN ra.market_opportunity_score &gt;= ra.city_avg_opportunity_score + ra.city_stddev_opportunity_score THEN 'High Priority'
WHEN ra.market_opportunity_score &gt;= ra.city_avg_opportunity_score THEN 'Medium Priority'
ELSE 'Low Priority'
END AS optimization_priority,
CASE
WHEN ra.avg_occupancy_rate &gt; 85 AND ra.avg_hourly_rate &lt; ra.avg_competitor_rate THEN
ra.avg_hourly_rate * 1.15  -- Increase price if high demand and underpriced
WHEN ra.avg_occupancy_rate &lt; 50 AND ra.avg_hourly_rate &gt; ra.avg_competitor_rate THEN
ra.avg_hourly_rate * 0.90  -- Decrease price if low demand and overpriced
WHEN ra.avg_hourly_rate &lt; ra.median_competitor_rate * 0.9 THEN
ra.median_competitor_rate * 0.95  -- Price slightly below median if significantly underpriced
ELSE ra.avg_hourly_rate  -- Keep current price
END AS recommended_rate,
-- Revenue impact estimate
(
CASE
WHEN ra.avg_occupancy_rate &gt; 85 AND ra.avg_hourly_rate &lt; ra.avg_competitor_rate THEN
ra.avg_hourly_rate * 1.15 * ra.total_spaces * ra.avg_occupancy_rate / 100.0 * ra.days_with_data
WHEN ra.avg_occupancy_rate &lt; 50 AND ra.avg_hourly_rate &gt; ra.avg_competitor_rate THEN
ra.avg_hourly_rate * 0.90 * ra.total_spaces * ra.avg_occupancy_rate / 100.0 * ra.days_with_data
ELSE ra.total_revenue
END - ra.total_revenue
) AS estimated_revenue_impact,
-- Market share estimate
CASE
WHEN ra.competitor_count &gt; 0 AND ra.total_spaces &gt; 0 THEN
(ra.total_spaces * ra.avg_occupancy_rate / 100.0) /
NULLIF(
(ra.total_spaces * ra.avg_occupancy_rate / 100.0) +
(ra.competitor_count * COALESCE(ra.avg_competitor_rate, 0) * 50),  -- Estimate competitor spaces
1
) * 100
ELSE 100.0
END AS estimated_market_share_pct
FROM ranked_analysis ra
)
SELECT
or_rec.facility_id,
or_rec.facility_name,
or_rec.city_name,
or_rec.state_code,
or_rec.msa_name,
or_rec.total_spaces,
or_rec.facility_type,
or_rec.operator_type,
or_rec.avg_occupancy_rate,
or_rec.median_occupancy_rate,
or_rec.p95_occupancy_rate,
or_rec.total_revenue,
or_rec.avg_hourly_rate AS current_rate,
or_rec.recommended_rate,
or_rec.competitor_count,
or_rec.avg_competitor_rate,
or_rec.median_competitor_rate,
or_rec.market_opportunity_score,
or_rec.competitive_advantage_score,
or_rec.opportunity_percentile,
or_rec.revenue_percentile,
or_rec.competitive_percentile,
or_rec.optimization_priority,
or_rec.estimated_revenue_impact,
or_rec.estimated_market_share_pct,
CASE
WHEN or_rec.estimated_revenue_impact &gt; 1000 THEN 'High Impact'
WHEN or_rec.estimated_revenue_impact &gt; 0 THEN 'Medium Impact'
ELSE 'Low Impact'
END AS impact_category
FROM optimization_recommendations or_rec
WHERE or_rec.competitor_count &gt; 0 OR or_rec.total_revenue &gt; 0
ORDER BY or_rec.market_opportunity_score DESC, or_rec.total_revenue DESC
LIMIT 200;
</p>
</code></pre>
<p>
---
</p>
<h2 id="query-28-revenue-per-square-foot-analysis-with-facility-efficiency-optimization-query-28-"></h2>
<strong>Use Case:</strong> <strong>Optimize facility efficiency and space utilization for revenue maximization.</strong>
<strong>Description:</strong> Analyzes revenue per square foot using CTEs for efficiency calculations, facility optimization, and space utilization analysis.
<strong>Use Case:</strong> Optimize facility efficiency and space utilization for revenue maximization.
<strong>Business Value:</strong> Revenue efficiency report with facility optimization recommendations.
<strong>Purpose:</strong> Enables data-driven decision making through advanced analytics and business intelligence.
<strong>Complexity:</strong> Efficiency CTEs (6+ levels), space utilization, optimization modeling
<strong>Expected Output:</strong> Query results with analysis and recommendations.
<pre><code class="language-sql">WITH facility_base_data AS (
<p>
SELECT
pf.facility_id,
pf.facility_name,
pf.city_id,
pf.total_spaces,
pf.facility_type,
pf.operator_type,
pf.latitude,
pf.longitude,
pf.is_event_parking,
pf.is_monthly_parking,
pf.accepts_reservations,
c.city_name,
c.state_code,
c.population,
c.population_density,
c.median_household_income,
c.employment_total,
ma.msa_name,
ma.gdp_billions,
ma.population_estimate AS msa_population
FROM parking_facilities pf
INNER JOIN cities c ON pf.city_id = c.city_id
INNER JOIN metropolitan_areas ma ON c.msa_id = ma.msa_id
WHERE pf.is_hourly_parking = TRUE
),
utilization_aggregations AS (
SELECT
pu.facility_id,
pu.utilization_date,
pu.utilization_hour,
AVG(pu.occupancy_rate) AS avg_occupancy_rate,
PERCENTILE_CONT(0.5) WITHIN GROUP (ORDER BY pu.occupancy_rate) AS median_occupancy_rate,
PERCENTILE_CONT(0.75) WITHIN GROUP (ORDER BY pu.occupancy_rate) AS p75_occupancy_rate,
PERCENTILE_CONT(0.95) WITHIN GROUP (ORDER BY pu.occupancy_rate) AS p95_occupancy_rate,
SUM(pu.revenue_generated) AS total_revenue,
AVG(pu.revenue_generated) AS avg_revenue_per_record,
COUNT(*) AS utilization_records,
COUNT(DISTINCT pu.utilization_date) AS days_with_data,
DATE_PART('dow', pu.utilization_date) AS day_of_week
FROM parking_utilization pu
WHERE pu.utilization_date &gt;= CURRENT_DATE - INTERVAL '90 days'
GROUP BY pu.facility_id, pu.utilization_date, pu.utilization_hour, DATE_PART('dow', pu.utilization_date)
),
pricing_analysis AS (
SELECT
pp.facility_id,
AVG(pp.base_rate_hourly) AS avg_hourly_rate,
AVG(pp.base_rate_daily) AS avg_daily_rate,
AVG(pp.base_rate_monthly) AS avg_monthly_rate,
MIN(pp.base_rate_hourly) AS min_hourly_rate,
MAX(pp.base_rate_hourly) AS max_hourly_rate,
PERCENTILE_CONT(0.5) WITHIN GROUP (ORDER BY pp.base_rate_hourly) AS median_hourly_rate,
PERCENTILE_CONT(0.75) WITHIN GROUP (ORDER BY pp.base_rate_hourly) AS p75_hourly_rate,
COUNT(*) AS pricing_records
FROM parking_pricing pp
WHERE pp.is_active = TRUE
AND pp.pricing_type IN ('Hourly', 'Daily', 'Monthly')
GROUP BY pp.facility_id
),
competitive_landscape AS (
SELECT
fbd1.facility_id,
fbd1.city_id,
COUNT(DISTINCT fbd2.facility_id) AS competitor_count,
AVG(fbd2.total_spaces) AS avg_competitor_spaces,
SUM(fbd2.total_spaces) AS total_competitor_spaces,
AVG(pa2.avg_hourly_rate) AS avg_competitor_rate,
MIN(pa2.avg_hourly_rate) AS min_competitor_rate,
MAX(pa2.avg_hourly_rate) AS max_competitor_rate,
PERCENTILE_CONT(0.5) WITHIN GROUP (ORDER BY pa2.avg_hourly_rate) AS median_competitor_rate,
AVG(
CASE
WHEN ST_DISTANCE(
ST_POINT(fbd1.longitude, fbd1.latitude),
ST_POINT(fbd2.longitude, fbd2.latitude)
) &lt; 500 THEN ST_DISTANCE(
ST_POINT(fbd1.longitude, fbd1.latitude),
ST_POINT(fbd2.longitude, fbd2.latitude)
)
ELSE NULL
END
) AS avg_distance_to_competitors
FROM facility_base_data fbd1
LEFT JOIN facility_base_data fbd2 ON fbd1.city_id = fbd2.city_id
AND fbd2.facility_id != fbd1.facility_id
AND ST_DISTANCE(
ST_POINT(fbd1.longitude, fbd1.latitude),
ST_POINT(fbd2.longitude, fbd2.latitude)
) &lt; 1000
LEFT JOIN pricing_analysis pa2 ON fbd2.facility_id = pa2.facility_id
GROUP BY fbd1.facility_id, fbd1.city_id, fbd1.latitude, fbd1.longitude
),
market_intelligence AS (
SELECT
fbd.facility_id,
fbd.facility_name,
fbd.city_id,
fbd.city_name,
fbd.state_code,
fbd.msa_name,
fbd.total_spaces,
fbd.facility_type,
fbd.operator_type,
fbd.population,
fbd.population_density,
fbd.median_household_income,
fbd.msa_population,
COALESCE(ua.avg_occupancy_rate, 0) AS avg_occupancy_rate,
COALESCE(ua.median_occupancy_rate, 0) AS median_occupancy_rate,
COALESCE(ua.p95_occupancy_rate, 0) AS p95_occupancy_rate,
COALESCE(ua.total_revenue, 0) AS total_revenue,
COALESCE(ua.avg_revenue_per_record, 0) AS avg_revenue_per_record,
COALESCE(ua.days_with_data, 0) AS days_with_data,
COALESCE(pa.avg_hourly_rate, 0) AS avg_hourly_rate,
COALESCE(pa.median_hourly_rate, 0) AS median_hourly_rate,
COALESCE(pa.p75_hourly_rate, 0) AS p75_hourly_rate,
COALESCE(cl.competitor_count, 0) AS competitor_count,
COALESCE(cl.avg_competitor_rate, 0) AS avg_competitor_rate,
COALESCE(cl.median_competitor_rate, 0) AS median_competitor_rate,
COALESCE(cl.avg_distance_to_competitors, 0) AS avg_distance_to_competitors,
-- Market opportunity score
(
LEAST(fbd.population_density / 10000.0, 1.0) * 25 +
LEAST(COALESCE(ua.avg_occupancy_rate, 0) / 100.0, 1.0) * 25 +
LEAST(fbd.median_household_income / 100000.0, 1.0) * 20 +
LEAST(COALESCE(cl.competitor_count, 0) / 10.0, 1.0) * 15 +
LEAST(fbd.total_spaces / 500.0, 1.0) * 15
) AS market_opportunity_score,
-- Competitive advantage score
(
CASE WHEN COALESCE(pa.avg_hourly_rate, 0) &lt; COALESCE(cl.avg_competitor_rate, 999) THEN 30 ELSE 0 END +
CASE WHEN COALESCE(ua.avg_occupancy_rate, 0) &gt; 80 THEN 25 ELSE COALESCE(ua.avg_occupancy_rate, 0) * 0.3125 END +
CASE WHEN COALESCE(cl.competitor_count, 0) &lt; 3 THEN 25 ELSE GREATEST(25 - COALESCE(cl.competitor_count, 0) * 2, 0) END +
CASE WHEN fbd.accepts_reservations THEN 20 ELSE 0 END
) AS competitive_advantage_score
FROM facility_base_data fbd
LEFT JOIN utilization_aggregations ua ON fbd.facility_id = ua.facility_id
LEFT JOIN pricing_analysis pa ON fbd.facility_id = pa.facility_id
LEFT JOIN competitive_landscape cl ON fbd.facility_id = cl.facility_id
),
ranked_analysis AS (
SELECT
mi.*,
ROW_NUMBER() OVER (PARTITION BY mi.city_id ORDER BY mi.market_opportunity_score DESC) AS city_rank,
ROW_NUMBER() OVER (ORDER BY mi.total_revenue DESC) AS revenue_rank,
ROW_NUMBER() OVER (ORDER BY mi.competitive_advantage_score DESC) AS competitive_rank,
PERCENT_RANK() OVER (ORDER BY mi.market_opportunity_score) AS opportunity_percentile,
PERCENT_RANK() OVER (ORDER BY mi.total_revenue) AS revenue_percentile,
PERCENT_RANK() OVER (ORDER BY mi.competitive_advantage_score) AS competitive_percentile,
LAG(mi.market_opportunity_score) OVER (ORDER BY mi.market_opportunity_score DESC) AS prev_opportunity_score,
LEAD(mi.market_opportunity_score) OVER (ORDER BY mi.market_opportunity_score DESC) AS next_opportunity_score,
AVG(mi.market_opportunity_score) OVER (PARTITION BY mi.city_id) AS city_avg_opportunity_score,
STDDEV(mi.market_opportunity_score) OVER (PARTITION BY mi.city_id) AS city_stddev_opportunity_score,
AVG(mi.total_revenue) OVER (PARTITION BY mi.city_id) AS city_avg_revenue,
AVG(mi.avg_occupancy_rate) OVER (PARTITION BY mi.city_id) AS city_avg_occupancy_rate
FROM market_intelligence mi
),
optimization_recommendations AS (
SELECT
ra.*,
CASE
WHEN ra.market_opportunity_score &gt;= ra.city_avg_opportunity_score + ra.city_stddev_opportunity_score THEN 'High Priority'
WHEN ra.market_opportunity_score &gt;= ra.city_avg_opportunity_score THEN 'Medium Priority'
ELSE 'Low Priority'
END AS optimization_priority,
CASE
WHEN ra.avg_occupancy_rate &gt; 85 AND ra.avg_hourly_rate &lt; ra.avg_competitor_rate THEN
ra.avg_hourly_rate * 1.15  -- Increase price if high demand and underpriced
WHEN ra.avg_occupancy_rate &lt; 50 AND ra.avg_hourly_rate &gt; ra.avg_competitor_rate THEN
ra.avg_hourly_rate * 0.90  -- Decrease price if low demand and overpriced
WHEN ra.avg_hourly_rate &lt; ra.median_competitor_rate * 0.9 THEN
ra.median_competitor_rate * 0.95  -- Price slightly below median if significantly underpriced
ELSE ra.avg_hourly_rate  -- Keep current price
END AS recommended_rate,
-- Revenue impact estimate
(
CASE
WHEN ra.avg_occupancy_rate &gt; 85 AND ra.avg_hourly_rate &lt; ra.avg_competitor_rate THEN
ra.avg_hourly_rate * 1.15 * ra.total_spaces * ra.avg_occupancy_rate / 100.0 * ra.days_with_data
WHEN ra.avg_occupancy_rate &lt; 50 AND ra.avg_hourly_rate &gt; ra.avg_competitor_rate THEN
ra.avg_hourly_rate * 0.90 * ra.total_spaces * ra.avg_occupancy_rate / 100.0 * ra.days_with_data
ELSE ra.total_revenue
END - ra.total_revenue
) AS estimated_revenue_impact,
-- Market share estimate
CASE
WHEN ra.competitor_count &gt; 0 AND ra.total_spaces &gt; 0 THEN
(ra.total_spaces * ra.avg_occupancy_rate / 100.0) /
NULLIF(
(ra.total_spaces * ra.avg_occupancy_rate / 100.0) +
(ra.competitor_count * COALESCE(ra.avg_competitor_rate, 0) * 50),  -- Estimate competitor spaces
1
) * 100
ELSE 100.0
END AS estimated_market_share_pct
FROM ranked_analysis ra
)
SELECT
or_rec.facility_id,
or_rec.facility_name,
or_rec.city_name,
or_rec.state_code,
or_rec.msa_name,
or_rec.total_spaces,
or_rec.facility_type,
or_rec.operator_type,
or_rec.avg_occupancy_rate,
or_rec.median_occupancy_rate,
or_rec.p95_occupancy_rate,
or_rec.total_revenue,
or_rec.avg_hourly_rate AS current_rate,
or_rec.recommended_rate,
or_rec.competitor_count,
or_rec.avg_competitor_rate,
or_rec.median_competitor_rate,
or_rec.market_opportunity_score,
or_rec.competitive_advantage_score,
or_rec.opportunity_percentile,
or_rec.revenue_percentile,
or_rec.competitive_percentile,
or_rec.optimization_priority,
or_rec.estimated_revenue_impact,
or_rec.estimated_market_share_pct,
CASE
WHEN or_rec.estimated_revenue_impact &gt; 1000 THEN 'High Impact'
WHEN or_rec.estimated_revenue_impact &gt; 0 THEN 'Medium Impact'
ELSE 'Low Impact'
END AS impact_category
FROM optimization_recommendations or_rec
WHERE or_rec.competitor_count &gt; 0 OR or_rec.total_revenue &gt; 0
ORDER BY or_rec.market_opportunity_score DESC, or_rec.total_revenue DESC
LIMIT 200;
</p>
</code></pre>
<p>
---
</p>
<h2 id="query-29-comprehensive-market-intelligence-dashboard-with-multi-dimensional-analytics-query-29-"></h2>
<strong>Use Case:</strong> <strong>Provide executive dashboard with comprehensive market intelligence metrics.</strong>
<strong>Description:</strong> Creates comprehensive dashboard using CTEs for multi-dimensional analytics, KPI calculations, and executive reporting.
<strong>Use Case:</strong> Provide executive dashboard with comprehensive market intelligence metrics.
<strong>Business Value:</strong> Executive dashboard with comprehensive market intelligence and KPIs.
<strong>Purpose:</strong> Enables data-driven decision making through advanced analytics and business intelligence.
<strong>Complexity:</strong> Dashboard CTEs (8+ levels), multi-dimensional analytics, KPI calculations
<strong>Expected Output:</strong> Query results with analysis and recommendations.
<pre><code class="language-sql">WITH facility_base_data AS (
<p>
SELECT
pf.facility_id,
pf.facility_name,
pf.city_id,
pf.total_spaces,
pf.facility_type,
pf.operator_type,
pf.latitude,
pf.longitude,
pf.is_event_parking,
pf.is_monthly_parking,
pf.accepts_reservations,
c.city_name,
c.state_code,
c.population,
c.population_density,
c.median_household_income,
c.employment_total,
ma.msa_name,
ma.gdp_billions,
ma.population_estimate AS msa_population
FROM parking_facilities pf
INNER JOIN cities c ON pf.city_id = c.city_id
INNER JOIN metropolitan_areas ma ON c.msa_id = ma.msa_id
WHERE pf.is_hourly_parking = TRUE
),
utilization_aggregations AS (
SELECT
pu.facility_id,
pu.utilization_date,
pu.utilization_hour,
AVG(pu.occupancy_rate) AS avg_occupancy_rate,
PERCENTILE_CONT(0.5) WITHIN GROUP (ORDER BY pu.occupancy_rate) AS median_occupancy_rate,
PERCENTILE_CONT(0.75) WITHIN GROUP (ORDER BY pu.occupancy_rate) AS p75_occupancy_rate,
PERCENTILE_CONT(0.95) WITHIN GROUP (ORDER BY pu.occupancy_rate) AS p95_occupancy_rate,
SUM(pu.revenue_generated) AS total_revenue,
AVG(pu.revenue_generated) AS avg_revenue_per_record,
COUNT(*) AS utilization_records,
COUNT(DISTINCT pu.utilization_date) AS days_with_data,
DATE_PART('dow', pu.utilization_date) AS day_of_week
FROM parking_utilization pu
WHERE pu.utilization_date &gt;= CURRENT_DATE - INTERVAL '90 days'
GROUP BY pu.facility_id, pu.utilization_date, pu.utilization_hour, DATE_PART('dow', pu.utilization_date)
),
pricing_analysis AS (
SELECT
pp.facility_id,
AVG(pp.base_rate_hourly) AS avg_hourly_rate,
AVG(pp.base_rate_daily) AS avg_daily_rate,
AVG(pp.base_rate_monthly) AS avg_monthly_rate,
MIN(pp.base_rate_hourly) AS min_hourly_rate,
MAX(pp.base_rate_hourly) AS max_hourly_rate,
PERCENTILE_CONT(0.5) WITHIN GROUP (ORDER BY pp.base_rate_hourly) AS median_hourly_rate,
PERCENTILE_CONT(0.75) WITHIN GROUP (ORDER BY pp.base_rate_hourly) AS p75_hourly_rate,
COUNT(*) AS pricing_records
FROM parking_pricing pp
WHERE pp.is_active = TRUE
AND pp.pricing_type IN ('Hourly', 'Daily', 'Monthly')
GROUP BY pp.facility_id
),
competitive_landscape AS (
SELECT
fbd1.facility_id,
fbd1.city_id,
COUNT(DISTINCT fbd2.facility_id) AS competitor_count,
AVG(fbd2.total_spaces) AS avg_competitor_spaces,
SUM(fbd2.total_spaces) AS total_competitor_spaces,
AVG(pa2.avg_hourly_rate) AS avg_competitor_rate,
MIN(pa2.avg_hourly_rate) AS min_competitor_rate,
MAX(pa2.avg_hourly_rate) AS max_competitor_rate,
PERCENTILE_CONT(0.5) WITHIN GROUP (ORDER BY pa2.avg_hourly_rate) AS median_competitor_rate,
AVG(
CASE
WHEN ST_DISTANCE(
ST_POINT(fbd1.longitude, fbd1.latitude),
ST_POINT(fbd2.longitude, fbd2.latitude)
) &lt; 500 THEN ST_DISTANCE(
ST_POINT(fbd1.longitude, fbd1.latitude),
ST_POINT(fbd2.longitude, fbd2.latitude)
)
ELSE NULL
END
) AS avg_distance_to_competitors
FROM facility_base_data fbd1
LEFT JOIN facility_base_data fbd2 ON fbd1.city_id = fbd2.city_id
AND fbd2.facility_id != fbd1.facility_id
AND ST_DISTANCE(
ST_POINT(fbd1.longitude, fbd1.latitude),
ST_POINT(fbd2.longitude, fbd2.latitude)
) &lt; 1000
LEFT JOIN pricing_analysis pa2 ON fbd2.facility_id = pa2.facility_id
GROUP BY fbd1.facility_id, fbd1.city_id, fbd1.latitude, fbd1.longitude
),
market_intelligence AS (
SELECT
fbd.facility_id,
fbd.facility_name,
fbd.city_id,
fbd.city_name,
fbd.state_code,
fbd.msa_name,
fbd.total_spaces,
fbd.facility_type,
fbd.operator_type,
fbd.population,
fbd.population_density,
fbd.median_household_income,
fbd.msa_population,
COALESCE(ua.avg_occupancy_rate, 0) AS avg_occupancy_rate,
COALESCE(ua.median_occupancy_rate, 0) AS median_occupancy_rate,
COALESCE(ua.p95_occupancy_rate, 0) AS p95_occupancy_rate,
COALESCE(ua.total_revenue, 0) AS total_revenue,
COALESCE(ua.avg_revenue_per_record, 0) AS avg_revenue_per_record,
COALESCE(ua.days_with_data, 0) AS days_with_data,
COALESCE(pa.avg_hourly_rate, 0) AS avg_hourly_rate,
COALESCE(pa.median_hourly_rate, 0) AS median_hourly_rate,
COALESCE(pa.p75_hourly_rate, 0) AS p75_hourly_rate,
COALESCE(cl.competitor_count, 0) AS competitor_count,
COALESCE(cl.avg_competitor_rate, 0) AS avg_competitor_rate,
COALESCE(cl.median_competitor_rate, 0) AS median_competitor_rate,
COALESCE(cl.avg_distance_to_competitors, 0) AS avg_distance_to_competitors,
-- Market opportunity score
(
LEAST(fbd.population_density / 10000.0, 1.0) * 25 +
LEAST(COALESCE(ua.avg_occupancy_rate, 0) / 100.0, 1.0) * 25 +
LEAST(fbd.median_household_income / 100000.0, 1.0) * 20 +
LEAST(COALESCE(cl.competitor_count, 0) / 10.0, 1.0) * 15 +
LEAST(fbd.total_spaces / 500.0, 1.0) * 15
) AS market_opportunity_score,
-- Competitive advantage score
(
CASE WHEN COALESCE(pa.avg_hourly_rate, 0) &lt; COALESCE(cl.avg_competitor_rate, 999) THEN 30 ELSE 0 END +
CASE WHEN COALESCE(ua.avg_occupancy_rate, 0) &gt; 80 THEN 25 ELSE COALESCE(ua.avg_occupancy_rate, 0) * 0.3125 END +
CASE WHEN COALESCE(cl.competitor_count, 0) &lt; 3 THEN 25 ELSE GREATEST(25 - COALESCE(cl.competitor_count, 0) * 2, 0) END +
CASE WHEN fbd.accepts_reservations THEN 20 ELSE 0 END
) AS competitive_advantage_score
FROM facility_base_data fbd
LEFT JOIN utilization_aggregations ua ON fbd.facility_id = ua.facility_id
LEFT JOIN pricing_analysis pa ON fbd.facility_id = pa.facility_id
LEFT JOIN competitive_landscape cl ON fbd.facility_id = cl.facility_id
),
ranked_analysis AS (
SELECT
mi.*,
ROW_NUMBER() OVER (PARTITION BY mi.city_id ORDER BY mi.market_opportunity_score DESC) AS city_rank,
ROW_NUMBER() OVER (ORDER BY mi.total_revenue DESC) AS revenue_rank,
ROW_NUMBER() OVER (ORDER BY mi.competitive_advantage_score DESC) AS competitive_rank,
PERCENT_RANK() OVER (ORDER BY mi.market_opportunity_score) AS opportunity_percentile,
PERCENT_RANK() OVER (ORDER BY mi.total_revenue) AS revenue_percentile,
PERCENT_RANK() OVER (ORDER BY mi.competitive_advantage_score) AS competitive_percentile,
LAG(mi.market_opportunity_score) OVER (ORDER BY mi.market_opportunity_score DESC) AS prev_opportunity_score,
LEAD(mi.market_opportunity_score) OVER (ORDER BY mi.market_opportunity_score DESC) AS next_opportunity_score,
AVG(mi.market_opportunity_score) OVER (PARTITION BY mi.city_id) AS city_avg_opportunity_score,
STDDEV(mi.market_opportunity_score) OVER (PARTITION BY mi.city_id) AS city_stddev_opportunity_score,
AVG(mi.total_revenue) OVER (PARTITION BY mi.city_id) AS city_avg_revenue,
AVG(mi.avg_occupancy_rate) OVER (PARTITION BY mi.city_id) AS city_avg_occupancy_rate
FROM market_intelligence mi
),
optimization_recommendations AS (
SELECT
ra.*,
CASE
WHEN ra.market_opportunity_score &gt;= ra.city_avg_opportunity_score + ra.city_stddev_opportunity_score THEN 'High Priority'
WHEN ra.market_opportunity_score &gt;= ra.city_avg_opportunity_score THEN 'Medium Priority'
ELSE 'Low Priority'
END AS optimization_priority,
CASE
WHEN ra.avg_occupancy_rate &gt; 85 AND ra.avg_hourly_rate &lt; ra.avg_competitor_rate THEN
ra.avg_hourly_rate * 1.15  -- Increase price if high demand and underpriced
WHEN ra.avg_occupancy_rate &lt; 50 AND ra.avg_hourly_rate &gt; ra.avg_competitor_rate THEN
ra.avg_hourly_rate * 0.90  -- Decrease price if low demand and overpriced
WHEN ra.avg_hourly_rate &lt; ra.median_competitor_rate * 0.9 THEN
ra.median_competitor_rate * 0.95  -- Price slightly below median if significantly underpriced
ELSE ra.avg_hourly_rate  -- Keep current price
END AS recommended_rate,
-- Revenue impact estimate
(
CASE
WHEN ra.avg_occupancy_rate &gt; 85 AND ra.avg_hourly_rate &lt; ra.avg_competitor_rate THEN
ra.avg_hourly_rate * 1.15 * ra.total_spaces * ra.avg_occupancy_rate / 100.0 * ra.days_with_data
WHEN ra.avg_occupancy_rate &lt; 50 AND ra.avg_hourly_rate &gt; ra.avg_competitor_rate THEN
ra.avg_hourly_rate * 0.90 * ra.total_spaces * ra.avg_occupancy_rate / 100.0 * ra.days_with_data
ELSE ra.total_revenue
END - ra.total_revenue
) AS estimated_revenue_impact,
-- Market share estimate
CASE
WHEN ra.competitor_count &gt; 0 AND ra.total_spaces &gt; 0 THEN
(ra.total_spaces * ra.avg_occupancy_rate / 100.0) /
NULLIF(
(ra.total_spaces * ra.avg_occupancy_rate / 100.0) +
(ra.competitor_count * COALESCE(ra.avg_competitor_rate, 0) * 50),  -- Estimate competitor spaces
1
) * 100
ELSE 100.0
END AS estimated_market_share_pct
FROM ranked_analysis ra
)
SELECT
or_rec.facility_id,
or_rec.facility_name,
or_rec.city_name,
or_rec.state_code,
or_rec.msa_name,
or_rec.total_spaces,
or_rec.facility_type,
or_rec.operator_type,
or_rec.avg_occupancy_rate,
or_rec.median_occupancy_rate,
or_rec.p95_occupancy_rate,
or_rec.total_revenue,
or_rec.avg_hourly_rate AS current_rate,
or_rec.recommended_rate,
or_rec.competitor_count,
or_rec.avg_competitor_rate,
or_rec.median_competitor_rate,
or_rec.market_opportunity_score,
or_rec.competitive_advantage_score,
or_rec.opportunity_percentile,
or_rec.revenue_percentile,
or_rec.competitive_percentile,
or_rec.optimization_priority,
or_rec.estimated_revenue_impact,
or_rec.estimated_market_share_pct,
CASE
WHEN or_rec.estimated_revenue_impact &gt; 1000 THEN 'High Impact'
WHEN or_rec.estimated_revenue_impact &gt; 0 THEN 'Medium Impact'
ELSE 'Low Impact'
END AS impact_category
FROM optimization_recommendations or_rec
WHERE or_rec.competitor_count &gt; 0 OR or_rec.total_revenue &gt; 0
ORDER BY or_rec.market_opportunity_score DESC, or_rec.total_revenue DESC
LIMIT 200;
</p>
</code></pre>
<p>
---
</p>
<h2 id="query-30-cross-database-performance-optimization-analysis-with-query-efficiency-metrics-query-30-"></h2>
<strong>Use Case:</strong> <strong>Optimize query performance across PostgreSQL, Databricks, and Snowflake.</strong>
<strong>Description:</strong> Analyzes cross-database performance using CTEs for query efficiency metrics, optimization recommendations, and performance benchmarking.
<strong>Use Case:</strong> Optimize query performance across PostgreSQL, Databricks, and Snowflake.
<strong>Business Value:</strong> Performance optimization report with efficiency metrics and optimization recommendations.
<strong>Purpose:</strong> Enables data-driven decision making through advanced analytics and business intelligence.
<strong>Complexity:</strong> Performance CTEs (7+ levels), efficiency metrics, optimization analysis
<strong>Expected Output:</strong> Query results with analysis and recommendations.
<pre><code class="language-sql">WITH facility_base_data AS (
<p>
SELECT
pf.facility_id,
pf.facility_name,
pf.city_id,
pf.total_spaces,
pf.facility_type,
pf.operator_type,
pf.latitude,
pf.longitude,
pf.is_event_parking,
pf.is_monthly_parking,
pf.accepts_reservations,
c.city_name,
c.state_code,
c.population,
c.population_density,
c.median_household_income,
c.employment_total,
ma.msa_name,
ma.gdp_billions,
ma.population_estimate AS msa_population
FROM parking_facilities pf
INNER JOIN cities c ON pf.city_id = c.city_id
INNER JOIN metropolitan_areas ma ON c.msa_id = ma.msa_id
WHERE pf.is_hourly_parking = TRUE
),
utilization_aggregations AS (
SELECT
pu.facility_id,
pu.utilization_date,
pu.utilization_hour,
AVG(pu.occupancy_rate) AS avg_occupancy_rate,
PERCENTILE_CONT(0.5) WITHIN GROUP (ORDER BY pu.occupancy_rate) AS median_occupancy_rate,
PERCENTILE_CONT(0.75) WITHIN GROUP (ORDER BY pu.occupancy_rate) AS p75_occupancy_rate,
PERCENTILE_CONT(0.95) WITHIN GROUP (ORDER BY pu.occupancy_rate) AS p95_occupancy_rate,
SUM(pu.revenue_generated) AS total_revenue,
AVG(pu.revenue_generated) AS avg_revenue_per_record,
COUNT(*) AS utilization_records,
COUNT(DISTINCT pu.utilization_date) AS days_with_data,
DATE_PART('dow', pu.utilization_date) AS day_of_week
FROM parking_utilization pu
WHERE pu.utilization_date &gt;= CURRENT_DATE - INTERVAL '90 days'
GROUP BY pu.facility_id, pu.utilization_date, pu.utilization_hour, DATE_PART('dow', pu.utilization_date)
),
pricing_analysis AS (
SELECT
pp.facility_id,
AVG(pp.base_rate_hourly) AS avg_hourly_rate,
AVG(pp.base_rate_daily) AS avg_daily_rate,
AVG(pp.base_rate_monthly) AS avg_monthly_rate,
MIN(pp.base_rate_hourly) AS min_hourly_rate,
MAX(pp.base_rate_hourly) AS max_hourly_rate,
PERCENTILE_CONT(0.5) WITHIN GROUP (ORDER BY pp.base_rate_hourly) AS median_hourly_rate,
PERCENTILE_CONT(0.75) WITHIN GROUP (ORDER BY pp.base_rate_hourly) AS p75_hourly_rate,
COUNT(*) AS pricing_records
FROM parking_pricing pp
WHERE pp.is_active = TRUE
AND pp.pricing_type IN ('Hourly', 'Daily', 'Monthly')
GROUP BY pp.facility_id
),
competitive_landscape AS (
SELECT
fbd1.facility_id,
fbd1.city_id,
COUNT(DISTINCT fbd2.facility_id) AS competitor_count,
AVG(fbd2.total_spaces) AS avg_competitor_spaces,
SUM(fbd2.total_spaces) AS total_competitor_spaces,
AVG(pa2.avg_hourly_rate) AS avg_competitor_rate,
MIN(pa2.avg_hourly_rate) AS min_competitor_rate,
MAX(pa2.avg_hourly_rate) AS max_competitor_rate,
PERCENTILE_CONT(0.5) WITHIN GROUP (ORDER BY pa2.avg_hourly_rate) AS median_competitor_rate,
AVG(
CASE
WHEN ST_DISTANCE(
ST_POINT(fbd1.longitude, fbd1.latitude),
ST_POINT(fbd2.longitude, fbd2.latitude)
) &lt; 500 THEN ST_DISTANCE(
ST_POINT(fbd1.longitude, fbd1.latitude),
ST_POINT(fbd2.longitude, fbd2.latitude)
)
ELSE NULL
END
) AS avg_distance_to_competitors
FROM facility_base_data fbd1
LEFT JOIN facility_base_data fbd2 ON fbd1.city_id = fbd2.city_id
AND fbd2.facility_id != fbd1.facility_id
AND ST_DISTANCE(
ST_POINT(fbd1.longitude, fbd1.latitude),
ST_POINT(fbd2.longitude, fbd2.latitude)
) &lt; 1000
LEFT JOIN pricing_analysis pa2 ON fbd2.facility_id = pa2.facility_id
GROUP BY fbd1.facility_id, fbd1.city_id, fbd1.latitude, fbd1.longitude
),
market_intelligence AS (
SELECT
fbd.facility_id,
fbd.facility_name,
fbd.city_id,
fbd.city_name,
fbd.state_code,
fbd.msa_name,
fbd.total_spaces,
fbd.facility_type,
fbd.operator_type,
fbd.population,
fbd.population_density,
fbd.median_household_income,
fbd.msa_population,
COALESCE(ua.avg_occupancy_rate, 0) AS avg_occupancy_rate,
COALESCE(ua.median_occupancy_rate, 0) AS median_occupancy_rate,
COALESCE(ua.p95_occupancy_rate, 0) AS p95_occupancy_rate,
COALESCE(ua.total_revenue, 0) AS total_revenue,
COALESCE(ua.avg_revenue_per_record, 0) AS avg_revenue_per_record,
COALESCE(ua.days_with_data, 0) AS days_with_data,
COALESCE(pa.avg_hourly_rate, 0) AS avg_hourly_rate,
COALESCE(pa.median_hourly_rate, 0) AS median_hourly_rate,
COALESCE(pa.p75_hourly_rate, 0) AS p75_hourly_rate,
COALESCE(cl.competitor_count, 0) AS competitor_count,
COALESCE(cl.avg_competitor_rate, 0) AS avg_competitor_rate,
COALESCE(cl.median_competitor_rate, 0) AS median_competitor_rate,
COALESCE(cl.avg_distance_to_competitors, 0) AS avg_distance_to_competitors,
-- Market opportunity score
(
LEAST(fbd.population_density / 10000.0, 1.0) * 25 +
LEAST(COALESCE(ua.avg_occupancy_rate, 0) / 100.0, 1.0) * 25 +
LEAST(fbd.median_household_income / 100000.0, 1.0) * 20 +
LEAST(COALESCE(cl.competitor_count, 0) / 10.0, 1.0) * 15 +
LEAST(fbd.total_spaces / 500.0, 1.0) * 15
) AS market_opportunity_score,
-- Competitive advantage score
(
CASE WHEN COALESCE(pa.avg_hourly_rate, 0) &lt; COALESCE(cl.avg_competitor_rate, 999) THEN 30 ELSE 0 END +
CASE WHEN COALESCE(ua.avg_occupancy_rate, 0) &gt; 80 THEN 25 ELSE COALESCE(ua.avg_occupancy_rate, 0) * 0.3125 END +
CASE WHEN COALESCE(cl.competitor_count, 0) &lt; 3 THEN 25 ELSE GREATEST(25 - COALESCE(cl.competitor_count, 0) * 2, 0) END +
CASE WHEN fbd.accepts_reservations THEN 20 ELSE 0 END
) AS competitive_advantage_score
FROM facility_base_data fbd
LEFT JOIN utilization_aggregations ua ON fbd.facility_id = ua.facility_id
LEFT JOIN pricing_analysis pa ON fbd.facility_id = pa.facility_id
LEFT JOIN competitive_landscape cl ON fbd.facility_id = cl.facility_id
),
ranked_analysis AS (
SELECT
mi.*,
ROW_NUMBER() OVER (PARTITION BY mi.city_id ORDER BY mi.market_opportunity_score DESC) AS city_rank,
ROW_NUMBER() OVER (ORDER BY mi.total_revenue DESC) AS revenue_rank,
ROW_NUMBER() OVER (ORDER BY mi.competitive_advantage_score DESC) AS competitive_rank,
PERCENT_RANK() OVER (ORDER BY mi.market_opportunity_score) AS opportunity_percentile,
PERCENT_RANK() OVER (ORDER BY mi.total_revenue) AS revenue_percentile,
PERCENT_RANK() OVER (ORDER BY mi.competitive_advantage_score) AS competitive_percentile,
LAG(mi.market_opportunity_score) OVER (ORDER BY mi.market_opportunity_score DESC) AS prev_opportunity_score,
LEAD(mi.market_opportunity_score) OVER (ORDER BY mi.market_opportunity_score DESC) AS next_opportunity_score,
AVG(mi.market_opportunity_score) OVER (PARTITION BY mi.city_id) AS city_avg_opportunity_score,
STDDEV(mi.market_opportunity_score) OVER (PARTITION BY mi.city_id) AS city_stddev_opportunity_score,
AVG(mi.total_revenue) OVER (PARTITION BY mi.city_id) AS city_avg_revenue,
AVG(mi.avg_occupancy_rate) OVER (PARTITION BY mi.city_id) AS city_avg_occupancy_rate
FROM market_intelligence mi
),
optimization_recommendations AS (
SELECT
ra.*,
CASE
WHEN ra.market_opportunity_score &gt;= ra.city_avg_opportunity_score + ra.city_stddev_opportunity_score THEN 'High Priority'
WHEN ra.market_opportunity_score &gt;= ra.city_avg_opportunity_score THEN 'Medium Priority'
ELSE 'Low Priority'
END AS optimization_priority,
CASE
WHEN ra.avg_occupancy_rate &gt; 85 AND ra.avg_hourly_rate &lt; ra.avg_competitor_rate THEN
ra.avg_hourly_rate * 1.15  -- Increase price if high demand and underpriced
WHEN ra.avg_occupancy_rate &lt; 50 AND ra.avg_hourly_rate &gt; ra.avg_competitor_rate THEN
ra.avg_hourly_rate * 0.90  -- Decrease price if low demand and overpriced
WHEN ra.avg_hourly_rate &lt; ra.median_competitor_rate * 0.9 THEN
ra.median_competitor_rate * 0.95  -- Price slightly below median if significantly underpriced
ELSE ra.avg_hourly_rate  -- Keep current price
END AS recommended_rate,
-- Revenue impact estimate
(
CASE
WHEN ra.avg_occupancy_rate &gt; 85 AND ra.avg_hourly_rate &lt; ra.avg_competitor_rate THEN
ra.avg_hourly_rate * 1.15 * ra.total_spaces * ra.avg_occupancy_rate / 100.0 * ra.days_with_data
WHEN ra.avg_occupancy_rate &lt; 50 AND ra.avg_hourly_rate &gt; ra.avg_competitor_rate THEN
ra.avg_hourly_rate * 0.90 * ra.total_spaces * ra.avg_occupancy_rate / 100.0 * ra.days_with_data
ELSE ra.total_revenue
END - ra.total_revenue
) AS estimated_revenue_impact,
-- Market share estimate
CASE
WHEN ra.competitor_count &gt; 0 AND ra.total_spaces &gt; 0 THEN
(ra.total_spaces * ra.avg_occupancy_rate / 100.0) /
NULLIF(
(ra.total_spaces * ra.avg_occupancy_rate / 100.0) +
(ra.competitor_count * COALESCE(ra.avg_competitor_rate, 0) * 50),  -- Estimate competitor spaces
1
) * 100
ELSE 100.0
END AS estimated_market_share_pct
FROM ranked_analysis ra
)
SELECT
or_rec.facility_id,
or_rec.facility_name,
or_rec.city_name,
or_rec.state_code,
or_rec.msa_name,
or_rec.total_spaces,
or_rec.facility_type,
or_rec.operator_type,
or_rec.avg_occupancy_rate,
or_rec.median_occupancy_rate,
or_rec.p95_occupancy_rate,
or_rec.total_revenue,
or_rec.avg_hourly_rate AS current_rate,
or_rec.recommended_rate,
or_rec.competitor_count,
or_rec.avg_competitor_rate,
or_rec.median_competitor_rate,
or_rec.market_opportunity_score,
or_rec.competitive_advantage_score,
or_rec.opportunity_percentile,
or_rec.revenue_percentile,
or_rec.competitive_percentile,
or_rec.optimization_priority,
or_rec.estimated_revenue_impact,
or_rec.estimated_market_share_pct,
CASE
WHEN or_rec.estimated_revenue_impact &gt; 1000 THEN 'High Impact'
WHEN or_rec.estimated_revenue_impact &gt; 0 THEN 'Medium Impact'
ELSE 'Low Impact'
END AS impact_category
FROM optimization_recommendations or_rec
WHERE or_rec.competitor_count &gt; 0 OR or_rec.total_revenue &gt; 0
ORDER BY or_rec.market_opportunity_score DESC, or_rec.total_revenue DESC
LIMIT 200;
</p>
</code></pre>
<p>
---
</p>
<h2 id="usage-instructions"></h2>
<p>
1. <strong>Create Database Schema</strong>:
``<code>bash
psql -U postgres -d db_11 -f data/schema.sql
</p>
<pre><code>
<p>
2. <strong>Load Sample Data</strong> (optional):
</p>
</code></pre>bash
<p>
psql -U postgres -d db_11 -f data/data.sql
</p>
<pre><code>
<p>
Run the ETL pipeline to extract data from government sources:
</p>
</code></pre>bash
<p>
cd db-11
python3 scripts/extract_and_transform_data.py
python3 scripts/transform_and_load_data.py
</p>
<pre><code>
<p>
Execute queries from </code>queries/queries.md<code> using your preferred database client or application.
</p>
<p>
Run the validation suite to verify queries:
</p>
</code></pre>bash
<p>
cd db-11
python3 scripts/extract_queries_to_json.py  # Phase 0
python3 scripts/verify_fixes.py              # Phase 1
python3 scripts/comprehensive_validator.py   # Phase 2 &amp; 4
python3 scripts/execution_tester.py          # Phase 3
python3 scripts/generate_final_report.py     # Phase 5
</p>
</code>``
<p>
---
</p>
<strong>Last Updated:</strong> 2026-02-04
<p>
---
</p>
<h2 id="platform-compatibility"></h2>
<p>
All queries in this database are designed to work across multiple database platforms:
</p>
<p>
- <strong>PostgreSQL</strong>: Full support with standard SQL features
- <strong>Databricks</strong>: Compatible with Delta Lake and Spark SQL
- <strong>Snowflake</strong>: Full support with Snowflake SQL syntax
</p>
<p>
Queries use standard SQL syntax and avoid platform-specific features to ensure cross-platform compatibility.
</p>
<p>
---
</p>
<strong>Document Information:</strong>
<p>
- <strong>Generated</strong>: 20260204-2125
- <strong>Database</strong>: db-11
- <strong>Type</strong>: Parking Intelligence Database
- <strong>Queries</strong>: 30 production queries
- <strong>Status</strong>: âœ… Complete Comprehensive Deliverable
</p>
    </div>
    <!-- Vercel Analytics -->
    <script>
        // For Next.js: import { Analytics } from "@vercel/analytics/next"
        // For static HTML: Use script tag approach
        (function() {
            var script = document.createElement('script');
            script.src = 'https://va.vercel-scripts.com/v1/script.js';
            script.defer = true;
            script.setAttribute('data-api', '/api/event');
            document.head.appendChild(script);
        })();
    </script>
</body>
</html>