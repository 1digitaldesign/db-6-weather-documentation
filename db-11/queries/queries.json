{
  "source_file": "queries/queries.md",
  "extraction_timestamp": "20260210-0248",
  "total_queries": 30,
  "queries": [
    {
      "number": 1,
      "title": "Multi-Dimensional Market Demand Analysis with Geographic Segmentation and Temporal Patterns",
      "description": "Analyzes parking demand across metropolitan areas using multi-level CTEs, spatial aggregations, temporal window functions, and demographic correlations. Calculates demand scores by combining utilization rates, population density, traffic volumes, and economic indicators with weighted scoring algorithms.",
      "use_case": "Identify high-demand markets for parking marketplace expansion by analyzing utilization patterns, demographic indicators, and traffic correlations across 400+ cities.",
      "business_value": "Market expansion prioritization report showing demand scores, growth potential, and revenue opportunities by metropolitan area. Enables data-driven market entry decisions for parking marketplace platforms.",
      "purpose": "Quantifies parking demand potential across geographic markets using multi-factor analysis, enabling strategic market expansion planning.",
      "complexity": "Deep nested CTEs (8+ levels), spatial aggregations, complex window functions with multiple frame clauses, percentile calculations, weighted scoring algorithms, temporal pattern analysis, correlated subqueries, multi-table joins",
      "expected_output": "Market demand scores by metropolitan area with rankings, growth indicators, and expansion recommendations.",
      "sql": "WITH city_demographic_cohorts AS (\n    SELECT\n        c.city_id,\n        c.city_name,\n        c.state_code,\n        c.msa_id,\n        c.population,\n        c.population_density,\n        c.median_household_income,\n        c.median_age,\n        c.employment_total,\n        c.unemployment_rate,\n        c.city_latitude,\n        c.city_longitude,\n        ma.msa_name,\n        ma.msa_type,\n        ma.gdp_billions,\n        CASE\n            WHEN c.population_density > 5000 THEN 'High Density'\n            WHEN c.population_density > 2000 THEN 'Medium Density'\n            ELSE 'Low Density'\n        END AS density_category,\n        CASE\n            WHEN c.median_household_income > 75000 THEN 'High Income'\n            WHEN c.median_household_income > 50000 THEN 'Medium Income'\n            ELSE 'Low Income'\n        END AS income_category\n    FROM cities c\n    INNER JOIN metropolitan_areas ma ON c.msa_id = ma.msa_id\n    WHERE c.population > 50000\n),\nparking_facility_aggregations AS (\n    SELECT\n        pf.city_id,\n        COUNT(DISTINCT pf.facility_id) AS total_facilities,\n        SUM(pf.total_spaces) AS total_spaces,\n        AVG(pf.total_spaces) AS avg_spaces_per_facility,\n        COUNT(CASE WHEN pf.is_event_parking THEN 1 END) AS event_facilities_count,\n        COUNT(CASE WHEN pf.is_monthly_parking THEN 1 END) AS monthly_facilities_count,\n        COUNT(CASE WHEN pf.is_hourly_parking THEN 1 END) AS hourly_facilities_count,\n        COUNT(CASE WHEN pf.accepts_reservations THEN 1 END) AS reservation_facilities_count,\n        COUNT(CASE WHEN pf.ev_charging_stations > 0 THEN 1 END) AS ev_charging_facilities_count\n    FROM parking_facilities pf\n    GROUP BY pf.city_id\n),\nutilization_metrics AS (\n    SELECT\n        pu.facility_id,\n        pf.city_id,\n        pu.utilization_date,\n        pu.utilization_hour,\n        pu.occupancy_rate,\n        pu.spaces_occupied,\n        pu.spaces_available,\n        pu.revenue_generated,\n        DATE_TRUNC('week', pu.utilization_date) AS utilization_week,\n        DATE_TRUNC('month', pu.utilization_date) AS utilization_month\n    FROM parking_utilization pu\n    INNER JOIN parking_facilities pf ON pu.facility_id = pf.facility_id\n    WHERE pu.utilization_date >= CURRENT_DATE - INTERVAL '90 days'\n),\ncity_utilization_aggregations AS (\n    SELECT\n        um.city_id,\n        um.utilization_month,\n        COUNT(DISTINCT um.facility_id) AS facilities_with_data,\n        AVG(um.occupancy_rate) AS avg_occupancy_rate,\n        PERCENTILE_CONT(0.5) WITHIN GROUP (ORDER BY um.occupancy_rate) AS median_occupancy_rate,\n        PERCENTILE_CONT(0.75) WITHIN GROUP (ORDER BY um.occupancy_rate) AS p75_occupancy_rate,\n        PERCENTILE_CONT(0.95) WITHIN GROUP (ORDER BY um.occupancy_rate) AS p95_occupancy_rate,\n        SUM(um.revenue_generated) AS total_revenue,\n        AVG(um.revenue_generated) AS avg_revenue_per_facility,\n        COUNT(DISTINCT um.utilization_date) AS days_with_data,\n        COUNT(*) AS total_utilization_records\n    FROM utilization_metrics um\n    GROUP BY um.city_id, um.utilization_month\n),\ntraffic_correlation_analysis AS (\n    SELECT\n        tv.city_id,\n        AVG(tv.annual_average_daily_traffic) AS avg_daily_traffic,\n        MAX(tv.annual_average_daily_traffic) AS max_daily_traffic,\n        PERCENTILE_CONT(0.75) WITHIN GROUP (ORDER BY tv.annual_average_daily_traffic) AS p75_daily_traffic,\n        COUNT(DISTINCT tv.location_id) AS traffic_monitoring_locations,\n        AVG(tv.peak_hour_volume) AS avg_peak_hour_volume\n    FROM traffic_volume_data tv\n    WHERE tv.data_year = EXTRACT(YEAR FROM CURRENT_DATE)\n    GROUP BY tv.city_id\n),\nmarket_demand_scoring AS (\n    SELECT\n        cdc.city_id,\n        cdc.city_name,\n        cdc.state_code,\n        cdc.msa_id,\n        cdc.msa_name,\n        cdc.population,\n        cdc.population_density,\n        cdc.median_household_income,\n        cdc.density_category,\n        cdc.income_category,\n        COALESCE(pfa.total_facilities, 0) AS total_facilities,\n        COALESCE(pfa.total_spaces, 0) AS total_spaces,\n        COALESCE(pfa.avg_spaces_per_facility, 0) AS avg_spaces_per_facility,\n        COALESCE(cua.avg_occupancy_rate, 0) AS avg_occupancy_rate,\n        COALESCE(cua.median_occupancy_rate, 0) AS median_occupancy_rate,\n        COALESCE(cua.p95_occupancy_rate, 0) AS p95_occupancy_rate,\n        COALESCE(cua.total_revenue, 0) AS total_revenue,\n        COALESCE(tca.avg_daily_traffic, 0) AS avg_daily_traffic,\n        COALESCE(tca.max_daily_traffic, 0) AS max_daily_traffic,\n        -- Demand score calculation (weighted factors)\n        (\n            (COALESCE(cua.avg_occupancy_rate, 0) * 0.30) +\n            (LEAST(cdc.population_density / 10000.0, 1.0) * 100 * 0.25) +\n            (LEAST(COALESCE(tca.avg_daily_traffic, 0) / 100000.0, 1.0) * 100 * 0.20) +\n            (LEAST(cdc.median_household_income / 100000.0, 1.0) * 100 * 0.15) +\n            (LEAST(COALESCE(pfa.total_facilities, 0) / 100.0, 1.0) * 100 * 0.10)\n        ) AS demand_score,\n        -- Growth potential score\n        (\n            CASE WHEN cdc.population > 100000 THEN 20 ELSE 10 END +\n            CASE WHEN cdc.median_household_income > 60000 THEN 20 ELSE 10 END +\n            CASE WHEN COALESCE(cua.avg_occupancy_rate, 0) > 70 THEN 20 ELSE 10 END +\n            CASE WHEN COALESCE(pfa.total_facilities, 0) < 50 THEN 20 ELSE 10 END +\n            CASE WHEN COALESCE(tca.avg_daily_traffic, 0) > 50000 THEN 20 ELSE 10 END\n        ) AS growth_potential_score\n    FROM city_demographic_cohorts cdc\n    LEFT JOIN parking_facility_aggregations pfa ON cdc.city_id = pfa.city_id\n    LEFT JOIN city_utilization_aggregations cua ON cdc.city_id = cua.city_id\n        AND cua.utilization_month = DATE_TRUNC('month', CURRENT_DATE)\n    LEFT JOIN traffic_correlation_analysis tca ON cdc.city_id = tca.city_id\n),\nranked_markets AS (\n    SELECT\n        mds.*,\n        ROW_NUMBER() OVER (ORDER BY mds.demand_score DESC) AS demand_rank,\n        ROW_NUMBER() OVER (ORDER BY mds.growth_potential_score DESC) AS growth_rank,\n        PERCENT_RANK() OVER (ORDER BY mds.demand_score) AS demand_percentile,\n        PERCENT_RANK() OVER (ORDER BY mds.growth_potential_score) AS growth_percentile,\n        LAG(mds.demand_score) OVER (ORDER BY mds.demand_score DESC) AS prev_demand_score,\n        LEAD(mds.demand_score) OVER (ORDER BY mds.demand_score DESC) AS next_demand_score,\n        AVG(mds.demand_score) OVER () AS overall_avg_demand_score,\n        STDDEV(mds.demand_score) OVER () AS overall_stddev_demand_score\n    FROM market_demand_scoring mds\n)\nSELECT\n    rm.city_id,\n    rm.city_name,\n    rm.state_code,\n    rm.msa_name,\n    rm.population,\n    rm.population_density,\n    rm.median_household_income,\n    rm.total_facilities,\n    rm.total_spaces,\n    rm.avg_occupancy_rate,\n    rm.median_occupancy_rate,\n    rm.p95_occupancy_rate,\n    rm.avg_daily_traffic,\n    rm.demand_score,\n    rm.growth_potential_score,\n    rm.demand_rank,\n    rm.growth_rank,\n    rm.demand_percentile,\n    rm.growth_percentile,\n    CASE\n        WHEN rm.demand_score >= rm.overall_avg_demand_score + rm.overall_stddev_demand_score THEN 'High Priority'\n        WHEN rm.demand_score >= rm.overall_avg_demand_score THEN 'Medium Priority'\n        ELSE 'Low Priority'\n    END AS expansion_priority,\n    CASE\n        WHEN rm.demand_rank <= 50 THEN 'Tier 1 Market'\n        WHEN rm.demand_rank <= 150 THEN 'Tier 2 Market'\n        ELSE 'Tier 3 Market'\n    END AS market_tier\nFROM ranked_markets rm\nORDER BY rm.demand_score DESC\nLIMIT 100;",
      "line_number": 60
    },
    {
      "number": 2,
      "title": "Competitive Intelligence Analysis with Pricing Strategy Optimization and Market Share Calculation",
      "description": "Analyzes competitive parking landscape using multi-level CTEs for market penetration analysis, pricing elasticity calculations, distance-based competitive clustering, and revenue optimization modeling. Identifies pricing gaps and competitive advantages through multi-dimensional analysis.",
      "use_case": "Optimize pricing strategies by analyzing competitor pricing, market share, and pricing elasticity across geographic clusters of parking facilities.",
      "business_value": "Competitive pricing intelligence report showing optimal pricing strategies, market share opportunities, and revenue maximization recommendations by facility cluster.",
      "purpose": "Enables data-driven pricing decisions by identifying competitive gaps and pricing optimization opportunities in local markets.",
      "complexity": "Multi-level CTEs for market clustering, complex aggregations with window functions, distance calculations, pricing elasticity modeling, percentile rankings, multi-level joins",
      "expected_output": "Competitive analysis by facility cluster with pricing recommendations, market share calculations, and revenue optimization opportunities.",
      "sql": "WITH facility_location_clusters AS (\n    SELECT\n        pf.facility_id,\n        pf.facility_name,\n        pf.city_id,\n        pf.latitude,\n        pf.longitude,\n        pf.total_spaces,\n        pf.facility_type,\n        pf.operator_type,\n        c.city_name,\n        c.state_code,\n        -- Calculate facility density in area\n        (\n            SELECT COUNT(*)\n            FROM parking_facilities pf2\n            WHERE pf2.city_id = pf.city_id\n            AND ST_Distance(\n                ST_SetSRID(ST_MakePoint(pf.longitude, pf.latitude), 4326)::geography,\n                ST_SetSRID(ST_MakePoint(pf2.longitude, pf2.latitude), 4326)::geography\n            ) < 1000\n        ) AS nearby_facilities_count\n    FROM parking_facilities pf\n    INNER JOIN cities c ON pf.city_id = c.city_id\n    WHERE pf.is_hourly_parking = TRUE\n),\npricing_analysis AS (\n    SELECT\n        pp.pricing_id,\n        pp.facility_id,\n        flc.facility_name,\n        pp.pricing_type,\n        pp.base_rate_hourly,\n        pp.base_rate_daily,\n        pp.base_rate_monthly,\n        pp.max_daily_rate,\n        pp.effective_date,\n        pp.expiration_date,\n        pp.is_active,\n        flc.city_id,\n        flc.city_name,\n        flc.state_code,\n        flc.latitude,\n        flc.longitude,\n        flc.total_spaces,\n        flc.facility_type,\n        flc.nearby_facilities_count,\n        ROW_NUMBER() OVER (\n            PARTITION BY pp.facility_id\n            ORDER BY pp.effective_date DESC\n        ) AS pricing_recency_rank\n    FROM parking_pricing pp\n    INNER JOIN facility_location_clusters flc ON pp.facility_id = flc.facility_id\n    WHERE pp.is_active = TRUE\n    AND pp.pricing_type = 'Hourly'\n),\ncompetitive_clusters AS (\n    SELECT\n        pa1.facility_id AS facility_id,\n        pa1.facility_name,\n        pa1.city_id,\n        pa1.city_name,\n        pa1.state_code,\n        pa1.base_rate_hourly AS facility_rate,\n        pa1.total_spaces AS facility_spaces,\n        pa1.facility_type,\n        -- Find competitors within 500 meters (ARRAY_AGG without DISTINCT for PostgreSQL compatibility)\n        ARRAY_AGG(pa2.facility_id) FILTER (\n            WHERE pa2.facility_id != pa1.facility_id\n            AND ST_Distance(\n                ST_SetSRID(ST_MakePoint(pa1.longitude, pa1.latitude), 4326)::geography,\n                ST_SetSRID(ST_MakePoint(pa2.longitude, pa2.latitude), 4326)::geography\n            ) < 500\n        ) AS competitor_facility_ids,\n        COUNT(DISTINCT pa2.facility_id) FILTER (\n            WHERE pa2.facility_id != pa1.facility_id\n            AND ST_Distance(\n                ST_SetSRID(ST_MakePoint(pa1.longitude, pa1.latitude), 4326)::geography,\n                ST_SetSRID(ST_MakePoint(pa2.longitude, pa2.latitude), 4326)::geography\n            ) < 500\n        ) AS competitor_count,\n        AVG(pa2.base_rate_hourly) FILTER (\n            WHERE pa2.facility_id != pa1.facility_id\n            AND ST_Distance(\n                ST_SetSRID(ST_MakePoint(pa1.longitude, pa1.latitude), 4326)::geography,\n                ST_SetSRID(ST_MakePoint(pa2.longitude, pa2.latitude), 4326)::geography\n            ) < 500\n        ) AS avg_competitor_rate,\n        MIN(pa2.base_rate_hourly) FILTER (\n            WHERE pa2.facility_id != pa1.facility_id\n            AND ST_Distance(\n                ST_SetSRID(ST_MakePoint(pa1.longitude, pa1.latitude), 4326)::geography,\n                ST_SetSRID(ST_MakePoint(pa2.longitude, pa2.latitude), 4326)::geography\n            ) < 500\n        ) AS min_competitor_rate,\n        MAX(pa2.base_rate_hourly) FILTER (\n            WHERE pa2.facility_id != pa1.facility_id\n            AND ST_Distance(\n                ST_SetSRID(ST_MakePoint(pa1.longitude, pa1.latitude), 4326)::geography,\n                ST_SetSRID(ST_MakePoint(pa2.longitude, pa2.latitude), 4326)::geography\n            ) < 500\n        ) AS max_competitor_rate,\n        PERCENTILE_CONT(0.5) WITHIN GROUP (\n            ORDER BY pa2.base_rate_hourly\n        ) FILTER (\n            WHERE pa2.facility_id != pa1.facility_id\n            AND ST_Distance(\n                ST_SetSRID(ST_MakePoint(pa1.longitude, pa1.latitude), 4326)::geography,\n                ST_SetSRID(ST_MakePoint(pa2.longitude, pa2.latitude), 4326)::geography\n            ) < 500\n        ) AS median_competitor_rate\n    FROM pricing_analysis pa1\n    LEFT JOIN pricing_analysis pa2 ON pa1.city_id = pa2.city_id\n        AND pa1.pricing_recency_rank = 1\n        AND pa2.pricing_recency_rank = 1\n    WHERE pa1.pricing_recency_rank = 1\n    GROUP BY\n        pa1.facility_id,\n        pa1.facility_name,\n        pa1.city_id,\n        pa1.city_name,\n        pa1.state_code,\n        pa1.base_rate_hourly,\n        pa1.total_spaces,\n        pa1.facility_type,\n        pa1.latitude,\n        pa1.longitude\n),\nutilization_by_facility AS (\n    SELECT\n        pu.facility_id,\n        AVG(pu.occupancy_rate) AS avg_occupancy_rate,\n        PERCENTILE_CONT(0.5) WITHIN GROUP (ORDER BY pu.occupancy_rate) AS median_occupancy_rate,\n        SUM(pu.revenue_generated) AS total_revenue,\n        COUNT(*) AS utilization_records_count,\n        COUNT(DISTINCT pu.utilization_date) AS days_with_data\n    FROM parking_utilization pu\n    WHERE pu.utilization_date >= CURRENT_DATE - INTERVAL '30 days'\n    GROUP BY pu.facility_id\n),\nmarket_share_calculation AS (\n    SELECT\n        cc.facility_id,\n        cc.facility_name,\n        cc.city_id,\n        cc.city_name,\n        cc.state_code,\n        cc.facility_rate,\n        cc.facility_spaces,\n        cc.competitor_count,\n        cc.avg_competitor_rate,\n        cc.min_competitor_rate,\n        cc.max_competitor_rate,\n        cc.median_competitor_rate,\n        COALESCE(ubf.avg_occupancy_rate, 0) AS avg_occupancy_rate,\n        COALESCE(ubf.total_revenue, 0) AS total_revenue,\n        -- Pricing position analysis\n        CASE\n            WHEN cc.facility_rate < cc.min_competitor_rate THEN 'Lowest Price'\n            WHEN cc.facility_rate > cc.max_competitor_rate THEN 'Highest Price'\n            WHEN cc.facility_rate <= cc.median_competitor_rate THEN 'Below Median'\n            ELSE 'Above Median'\n        END AS pricing_position,\n        -- Price difference from average\n        cc.facility_rate - COALESCE(cc.avg_competitor_rate, cc.facility_rate) AS price_difference_from_avg,\n        -- Price difference percentage\n        CASE\n            WHEN cc.avg_competitor_rate > 0 THEN\n                ((cc.facility_rate - cc.avg_competitor_rate) / cc.avg_competitor_rate) * 100\n            ELSE 0\n        END AS price_difference_pct,\n        -- Market share estimate (based on spaces and occupancy)\n        CASE\n            WHEN cc.competitor_count > 0 THEN\n                (cc.facility_spaces * COALESCE(ubf.avg_occupancy_rate, 0) / 100.0) /\n                NULLIF(\n                    (\n                        SELECT SUM(pf2.total_spaces * COALESCE(ubf2.avg_occupancy_rate, 0) / 100.0)\n                        FROM parking_facilities pf2\n                        LEFT JOIN utilization_by_facility ubf2 ON pf2.facility_id = ubf2.facility_id\n                        WHERE pf2.facility_id = ANY(cc.competitor_facility_ids)\n                        OR (\n                            pf2.city_id = cc.city_id\n                            AND ST_Distance(\n                                ST_SetSRID(ST_MakePoint(\n                                    (SELECT longitude FROM parking_facilities WHERE facility_id = cc.facility_id),\n                                    (SELECT latitude FROM parking_facilities WHERE facility_id = cc.facility_id)\n                                ), 4326)::geography,\n                                ST_SetSRID(ST_MakePoint(pf2.longitude, pf2.latitude), 4326)::geography\n                            ) < 500\n                        )\n                    ),\n                    1\n                ) * 100\n            ELSE 100.0\n        END AS estimated_market_share_pct\n    FROM competitive_clusters cc\n    LEFT JOIN utilization_by_facility ubf ON cc.facility_id = ubf.facility_id\n),\npricing_optimization_recommendations AS (\n    SELECT\n        msc.*,\n        -- Optimal pricing recommendation\n        CASE\n            WHEN msc.avg_occupancy_rate > 85 AND msc.price_difference_pct < -10 THEN\n                msc.facility_rate * 1.10  -- Increase price if high demand and underpriced\n            WHEN msc.avg_occupancy_rate < 50 AND msc.price_difference_pct > 10 THEN\n                msc.facility_rate * 0.90  -- Decrease price if low demand and overpriced\n            WHEN msc.price_difference_pct < -20 THEN\n                msc.avg_competitor_rate * 0.95  -- Price slightly below average if significantly underpriced\n            WHEN msc.price_difference_pct > 20 THEN\n                msc.median_competitor_rate  -- Price at median if significantly overpriced\n            ELSE msc.facility_rate  -- Keep current price\n        END AS recommended_rate,\n        -- Revenue impact estimate\n        (\n            CASE\n                WHEN msc.avg_occupancy_rate > 85 AND msc.price_difference_pct < -10 THEN\n                    msc.facility_rate * 1.10 * msc.facility_spaces * msc.avg_occupancy_rate / 100.0\n                WHEN msc.avg_occupancy_rate < 50 AND msc.price_difference_pct > 10 THEN\n                    msc.facility_rate * 0.90 * msc.facility_spaces * msc.avg_occupancy_rate / 100.0\n                ELSE msc.total_revenue\n            END - msc.total_revenue\n        ) AS estimated_revenue_impact,\n        -- Competitive advantage score\n        (\n            CASE WHEN msc.pricing_position = 'Lowest Price' THEN 30 ELSE 0 END +\n            CASE WHEN msc.estimated_market_share_pct > 30 THEN 25 ELSE msc.estimated_market_share_pct * 0.833 END +\n            CASE WHEN msc.avg_occupancy_rate > 80 THEN 25 ELSE msc.avg_occupancy_rate * 0.3125 END +\n            CASE WHEN msc.competitor_count < 3 THEN 20 ELSE GREATEST(20 - msc.competitor_count * 2, 0) END\n        ) AS competitive_advantage_score\n    FROM market_share_calculation msc\n)\nSELECT\n    por.facility_id,\n    por.facility_name,\n    por.city_name,\n    por.state_code,\n    por.facility_rate AS current_rate,\n    por.recommended_rate,\n    por.price_difference_from_avg,\n    por.price_difference_pct,\n    por.pricing_position,\n    por.competitor_count,\n    por.avg_competitor_rate,\n    por.median_competitor_rate,\n    por.avg_occupancy_rate,\n    por.estimated_market_share_pct,\n    por.total_revenue,\n    por.estimated_revenue_impact,\n    por.competitive_advantage_score,\n    CASE\n        WHEN por.estimated_revenue_impact > 1000 THEN 'High Impact'\n        WHEN por.estimated_revenue_impact > 0 THEN 'Medium Impact'\n        WHEN por.estimated_revenue_impact > -500 THEN 'Low Impact'\n        ELSE 'Negative Impact'\n    END AS optimization_priority\nFROM pricing_optimization_recommendations por\nWHERE por.competitor_count > 0\nORDER BY por.estimated_revenue_impact DESC\nLIMIT 200;",
      "line_number": 255
    },
    {
      "number": 3,
      "title": "Event-Based Parking Demand Forecasting with Multi-Event Correlation and Revenue Optimization",
      "description": "Forecasts parking demand for events using multi-level CTEs for event pattern analysis, temporal correlation with historical utilization, venue capacity modeling, and dynamic pricing recommendations. Analyzes event types, attendance patterns, and parking multiplier effects.",
      "use_case": "Predict parking demand and optimize pricing for upcoming events (sports games, concerts, conventions) to maximize revenue and ensure availability.",
      "business_value": "Event parking demand forecast report with pricing recommendations, capacity planning, and revenue optimization strategies for event-based parking operations.",
      "purpose": "Enables proactive event parking management by forecasting demand and optimizing pricing strategies based on historical patterns and event characteristics.",
      "complexity": "Multi-level CTEs for event pattern analysis, temporal window functions, correlation analysis, demand multiplier calculations, revenue optimization modeling, multi-table joins with aggregations",
      "expected_output": "Event parking demand forecasts with pricing recommendations and revenue optimization opportunities.",
      "sql": "WITH upcoming_events AS (\n    SELECT\n        e.event_id,\n        e.event_name,\n        e.event_type,\n        e.venue_id,\n        e.city_id,\n        e.event_date,\n        e.event_time,\n        e.attendance,\n        e.parking_demand_multiplier,\n        e.is_recurring,\n        sv.venue_name,\n        sv.capacity AS venue_capacity,\n        sv.parking_spaces_total AS venue_parking_spaces,\n        c.city_name,\n        c.state_code,\n        DATE_PART('dow', e.event_date) AS day_of_week,\n        DATE_PART('month', e.event_date) AS event_month\n    FROM events e\n    INNER JOIN stadiums_venues sv ON e.venue_id = sv.venue_id\n    INNER JOIN cities c ON e.city_id = c.city_id\n    WHERE e.event_date >= CURRENT_DATE\n    AND e.event_date <= CURRENT_DATE + INTERVAL '90 days'\n),\nhistorical_event_patterns AS (\n    SELECT\n        e.event_type,\n        DATE_PART('dow', e.event_date) AS day_of_week,\n        DATE_PART('hour', e.event_time) AS event_hour,\n        AVG(e.attendance) AS avg_attendance,\n        AVG(e.parking_demand_multiplier) AS avg_demand_multiplier,\n        PERCENTILE_CONT(0.75) WITHIN GROUP (ORDER BY e.attendance) AS p75_attendance,\n        PERCENTILE_CONT(0.95) WITHIN GROUP (ORDER BY e.attendance) AS p95_attendance,\n        COUNT(*) AS event_count\n    FROM events e\n    WHERE e.event_date < CURRENT_DATE\n    AND e.event_date >= CURRENT_DATE - INTERVAL '365 days'\n    GROUP BY e.event_type, DATE_PART('dow', e.event_date), DATE_PART('hour', e.event_time)\n),\nvenue_parking_analysis AS (\n    SELECT\n        sv.venue_id,\n        sv.venue_name,\n        COUNT(DISTINCT pf.facility_id) AS nearby_facilities_count,\n        SUM(pf.total_spaces) AS total_nearby_spaces,\n        AVG(\n            CASE\n                WHEN ST_Distance(\n                    ST_SetSRID(ST_MakePoint(sv.longitude, sv.latitude), 4326)::geography,\n                    ST_SetSRID(ST_MakePoint(pf.longitude, pf.latitude), 4326)::geography\n                ) < 1000 THEN pf.total_spaces\n                ELSE NULL\n            END\n        ) AS avg_spaces_per_facility,\n        AVG(pp.base_rate_hourly) FILTER (\n            WHERE ST_Distance(\n                ST_SetSRID(ST_MakePoint(sv.longitude, sv.latitude), 4326)::geography,\n                ST_SetSRID(ST_MakePoint(pf.longitude, pf.latitude), 4326)::geography\n            ) < 1000\n        ) AS avg_nearby_rate\n    FROM stadiums_venues sv\n    LEFT JOIN parking_facilities pf ON sv.city_id = pf.city_id\n    LEFT JOIN parking_pricing pp ON pf.facility_id = pp.facility_id\n        AND pp.is_active = TRUE\n        AND pp.pricing_type = 'Hourly'\n    GROUP BY sv.venue_id, sv.venue_name, sv.latitude, sv.longitude\n),\nevent_demand_forecast AS (\n    SELECT\n        ue.event_id,\n        ue.event_name,\n        ue.event_type,\n        ue.venue_id,\n        ue.venue_name,\n        ue.city_name,\n        ue.state_code,\n        ue.event_date,\n        ue.event_time,\n        ue.attendance,\n        ue.parking_demand_multiplier,\n        ue.venue_capacity,\n        ue.venue_parking_spaces,\n        COALESCE(vpa.nearby_facilities_count, 0) AS nearby_facilities_count,\n        COALESCE(vpa.total_nearby_spaces, 0) AS total_nearby_spaces,\n        COALESCE(hep.avg_attendance, ue.attendance) AS forecasted_attendance,\n        COALESCE(hep.avg_demand_multiplier, ue.parking_demand_multiplier) AS forecasted_multiplier,\n        COALESCE(hep.p95_attendance, ue.attendance * 1.2) AS p95_forecasted_attendance,\n        -- Forecasted parking demand\n        COALESCE(ue.attendance, hep.avg_attendance) * \n        COALESCE(ue.parking_demand_multiplier, hep.avg_demand_multiplier) AS forecasted_parking_demand,\n        -- Peak demand (95th percentile)\n        COALESCE(hep.p95_attendance, ue.attendance * 1.2) * \n        COALESCE(ue.parking_demand_multiplier, hep.avg_demand_multiplier, 0.8) AS peak_parking_demand,\n        COALESCE(vpa.avg_nearby_rate, 0) AS avg_nearby_rate\n    FROM upcoming_events ue\n    LEFT JOIN historical_event_patterns hep ON ue.event_type = hep.event_type\n        AND ue.day_of_week = hep.day_of_week\n        AND DATE_PART('hour', ue.event_time) = hep.event_hour\n    LEFT JOIN venue_parking_analysis vpa ON ue.venue_id = vpa.venue_id\n),\ndemand_supply_analysis AS (\n    SELECT\n        edf.*,\n        -- Supply vs demand analysis\n        CASE\n            WHEN edf.total_nearby_spaces >= edf.peak_parking_demand THEN 'Sufficient Supply'\n            WHEN edf.total_nearby_spaces >= edf.forecasted_parking_demand * 0.8 THEN 'Adequate Supply'\n            ELSE 'Insufficient Supply'\n        END AS supply_status,\n        -- Capacity utilization forecast\n        CASE\n            WHEN edf.total_nearby_spaces > 0 THEN\n                (edf.forecasted_parking_demand / edf.total_nearby_spaces) * 100\n            ELSE 100\n        END AS forecasted_utilization_pct,\n        -- Peak utilization forecast\n        CASE\n            WHEN edf.total_nearby_spaces > 0 THEN\n                (edf.peak_parking_demand / edf.total_nearby_spaces) * 100\n            ELSE 100\n        END AS peak_utilization_pct,\n        -- Supply gap\n        GREATEST(edf.peak_parking_demand - edf.total_nearby_spaces, 0) AS supply_gap\n    FROM event_demand_forecast edf\n),\npricing_recommendations AS (\n    SELECT\n        dsa.*,\n        -- Dynamic pricing recommendation based on demand\n        CASE\n            WHEN dsa.supply_status = 'Insufficient Supply' THEN\n                dsa.avg_nearby_rate * 1.30  -- Increase price 30% for high demand\n            WHEN dsa.peak_utilization_pct > 90 THEN\n                dsa.avg_nearby_rate * 1.20  -- Increase price 20% for very high utilization\n            WHEN dsa.forecasted_utilization_pct > 75 THEN\n                dsa.avg_nearby_rate * 1.10  -- Increase price 10% for high utilization\n            WHEN dsa.forecasted_utilization_pct < 50 THEN\n                dsa.avg_nearby_rate * 0.90  -- Decrease price 10% for low utilization\n            ELSE dsa.avg_nearby_rate  -- Keep current price\n        END AS recommended_event_rate,\n        -- Revenue forecast\n        dsa.forecasted_parking_demand * \n        CASE\n            WHEN dsa.supply_status = 'Insufficient Supply' THEN dsa.avg_nearby_rate * 1.30\n            WHEN dsa.peak_utilization_pct > 90 THEN dsa.avg_nearby_rate * 1.20\n            WHEN dsa.forecasted_utilization_pct > 75 THEN dsa.avg_nearby_rate * 1.10\n            WHEN dsa.forecasted_utilization_pct < 50 THEN dsa.avg_nearby_rate * 0.90\n            ELSE dsa.avg_nearby_rate\n        END AS forecasted_revenue\n    FROM demand_supply_analysis dsa\n)\nSELECT\n    pr.event_id,\n    pr.event_name,\n    pr.event_type,\n    pr.venue_name,\n    pr.city_name,\n    pr.state_code,\n    pr.event_date,\n    pr.event_time,\n    pr.forecasted_attendance,\n    pr.forecasted_parking_demand,\n    pr.peak_parking_demand,\n    pr.total_nearby_spaces,\n    pr.supply_status,\n    pr.forecasted_utilization_pct,\n    pr.peak_utilization_pct,\n    pr.supply_gap,\n    pr.avg_nearby_rate AS current_avg_rate,\n    pr.recommended_event_rate,\n    pr.forecasted_revenue,\n    CASE\n        WHEN pr.supply_gap > 100 THEN 'High Priority - Add Facilities'\n        WHEN pr.supply_gap > 50 THEN 'Medium Priority - Monitor Closely'\n        ELSE 'Low Priority'\n    END AS action_priority\nFROM pricing_recommendations pr\nORDER BY pr.forecasted_revenue DESC, pr.event_date\nLIMIT 100;",
      "line_number": 533
    },
    {
      "number": 4,
      "title": "Airport Parking Revenue Optimization with Passenger Volume Correlation and Seasonal Pattern Analysis",
      "description": "Analyzes airport parking performance using multi-level CTEs, passenger volume correlations, seasonal pattern detection with window functions, pricing elasticity modeling, and revenue optimization across airport facilities.",
      "use_case": "Optimize airport parking revenue by analyzing passenger volume correlations, seasonal patterns, and pricing strategies across different airport facilities.",
      "business_value": "Airport parking revenue optimization report with seasonal pricing recommendations, capacity utilization analysis, and passenger volume correlation insights.",
      "purpose": "Maximizes airport parking revenue through data-driven pricing and capacity optimization based on passenger patterns and seasonal trends.",
      "complexity": "Multi-level CTEs (6+ levels), temporal window functions with seasonal patterns, correlation analysis, revenue optimization modeling, percentile calculations, multi-table joins",
      "expected_output": "Airport parking revenue optimization recommendations with seasonal pricing strategies and capacity utilization insights.",
      "sql": "WITH airport_passenger_volumes AS (\n    SELECT\n        a.airport_id,\n        a.airport_name,\n        a.city_id,\n        a.annual_passengers,\n        a.parking_spaces_total,\n        a.parking_facilities_count,\n        c.city_name,\n        c.state_code,\n        DATE_PART('month', CURRENT_DATE) AS current_month,\n        -- Estimate monthly passengers (annual / 12 with seasonal adjustment)\n        a.annual_passengers / 12.0 AS base_monthly_passengers\n    FROM airports a\n    INNER JOIN cities c ON a.city_id = c.city_id\n    WHERE a.annual_passengers > 1000000\n),\nairport_parking_facilities AS (\n    SELECT\n        pf.facility_id,\n        pf.facility_name,\n        pf.airport_id,\n        pf.total_spaces,\n        pf.facility_type,\n        pf.operator_type,\n        a.long_term_parking,\n        a.short_term_parking,\n        a.valet_available,\n        pp.base_rate_hourly,\n        pp.base_rate_daily,\n        pp.max_daily_rate,\n        a.airport_name,\n        a.annual_passengers\n    FROM parking_facilities pf\n    INNER JOIN airports a ON pf.airport_id = a.airport_id\n    LEFT JOIN parking_pricing pp ON pf.facility_id = pp.facility_id\n        AND pp.is_active = TRUE\n        AND pp.pricing_type IN ('Hourly', 'Daily')\n    WHERE pf.airport_id IS NOT NULL\n),\nmonthly_utilization_patterns AS (\n    SELECT\n        pu.facility_id,\n        pf.airport_id,\n        DATE_PART('month', pu.utilization_date) AS utilization_month,\n        DATE_PART('dow', pu.utilization_date) AS day_of_week,\n        AVG(pu.occupancy_rate) AS avg_occupancy_rate,\n        PERCENTILE_CONT(0.5) WITHIN GROUP (ORDER BY pu.occupancy_rate) AS median_occupancy_rate,\n        PERCENTILE_CONT(0.95) WITHIN GROUP (ORDER BY pu.occupancy_rate) AS p95_occupancy_rate,\n        SUM(pu.revenue_generated) AS total_revenue,\n        AVG(pu.revenue_generated) AS avg_revenue_per_record,\n        COUNT(*) AS utilization_records\n    FROM parking_utilization pu\n    INNER JOIN parking_facilities pf ON pu.facility_id = pf.facility_id\n    WHERE pf.airport_id IS NOT NULL\n    AND pu.utilization_date >= CURRENT_DATE - INTERVAL '365 days'\n    GROUP BY pu.facility_id, pf.airport_id, DATE_PART('month', pu.utilization_date), DATE_PART('dow', pu.utilization_date)\n),\nseasonal_pattern_analysis AS (\n    SELECT\n        apf.airport_id,\n        apf.airport_name,\n        apf.annual_passengers,\n        mup.utilization_month,\n        mup.day_of_week,\n        COUNT(DISTINCT mup.facility_id) AS facilities_count,\n        AVG(mup.avg_occupancy_rate) AS avg_occupancy_rate,\n        PERCENTILE_CONT(0.5) WITHIN GROUP (ORDER BY mup.avg_occupancy_rate) AS median_occupancy_rate,\n        PERCENTILE_CONT(0.75) WITHIN GROUP (ORDER BY mup.avg_occupancy_rate) AS p75_occupancy_rate,\n        SUM(mup.total_revenue) AS total_revenue,\n        AVG(mup.avg_revenue_per_record) AS avg_revenue_per_record,\n        -- Seasonal multiplier (compared to annual average)\n        AVG(mup.avg_occupancy_rate) / NULLIF(\n            (SELECT AVG(avg_occupancy_rate) FROM monthly_utilization_patterns mup2\n             INNER JOIN parking_facilities pf2 ON mup2.facility_id = pf2.facility_id\n             WHERE pf2.airport_id = apf.airport_id),\n            1\n        ) AS seasonal_multiplier\n    FROM airport_parking_facilities apf\n    INNER JOIN monthly_utilization_patterns mup ON apf.facility_id = mup.facility_id\n    GROUP BY apf.airport_id, apf.airport_name, apf.annual_passengers, mup.utilization_month, mup.day_of_week\n),\npassenger_correlation_analysis AS (\n    SELECT\n        spa.airport_id,\n        spa.airport_name,\n        spa.annual_passengers,\n        apv.city_name,\n        apv.state_code,\n        apv.base_monthly_passengers,\n        spa.utilization_month,\n        spa.avg_occupancy_rate,\n        spa.total_revenue,\n        spa.seasonal_multiplier,\n        -- Correlation between passenger volume and parking utilization\n        CASE\n            WHEN spa.utilization_month IN (6, 7, 8, 12) THEN 1.15  -- Summer and holiday months\n            WHEN spa.utilization_month IN (3, 4, 5, 9, 10) THEN 1.05  -- Spring and fall\n            ELSE 0.95  -- Winter months (excluding December)\n        END AS passenger_seasonal_factor,\n        -- Revenue per passenger estimate\n        CASE\n            WHEN apv.base_monthly_passengers > 0 THEN\n                spa.total_revenue / (apv.base_monthly_passengers * spa.seasonal_multiplier)\n            ELSE 0\n        END AS revenue_per_passenger\n    FROM seasonal_pattern_analysis spa\n    INNER JOIN airport_passenger_volumes apv ON spa.airport_id = apv.airport_id\n),\nrevenue_optimization AS (\n    SELECT\n        pca.*,\n        apf.facility_id,\n        apf.facility_name,\n        apf.facility_type,\n        apf.total_spaces,\n        apf.base_rate_hourly,\n        apf.base_rate_daily,\n        apf.max_daily_rate,\n        -- Optimal pricing recommendation\n        CASE\n            WHEN pca.seasonal_multiplier > 1.2 THEN\n                apf.base_rate_daily * 1.25  -- Increase price 25% for peak season\n            WHEN pca.seasonal_multiplier > 1.1 THEN\n                apf.base_rate_daily * 1.15  -- Increase price 15% for high season\n            WHEN pca.seasonal_multiplier < 0.9 THEN\n                apf.base_rate_daily * 0.90  -- Decrease price 10% for low season\n            ELSE apf.base_rate_daily  -- Keep current price\n        END AS recommended_seasonal_rate,\n        -- Revenue impact estimate\n        (\n            CASE\n                WHEN pca.seasonal_multiplier > 1.2 THEN apf.base_rate_daily * 1.25\n                WHEN pca.seasonal_multiplier > 1.1 THEN apf.base_rate_daily * 1.15\n                WHEN pca.seasonal_multiplier < 0.9 THEN apf.base_rate_daily * 0.90\n                ELSE apf.base_rate_daily\n            END - apf.base_rate_daily\n        ) * apf.total_spaces * pca.avg_occupancy_rate / 100.0 AS estimated_revenue_impact\n    FROM passenger_correlation_analysis pca\n    INNER JOIN airport_parking_facilities apf ON pca.airport_id = apf.airport_id\n)\nSELECT\n    ro.airport_id,\n    ro.airport_name,\n    ro.city_name,\n    ro.state_code,\n    ro.annual_passengers,\n    ro.utilization_month,\n    ro.facility_id,\n    ro.facility_name,\n    ro.facility_type,\n    ro.total_spaces,\n    ro.avg_occupancy_rate,\n    ro.seasonal_multiplier,\n    ro.passenger_seasonal_factor,\n    ro.revenue_per_passenger,\n    ro.base_rate_daily AS current_rate,\n    ro.recommended_seasonal_rate,\n    ro.estimated_revenue_impact,\n    CASE\n        WHEN ro.seasonal_multiplier > 1.2 THEN 'Peak Season'\n        WHEN ro.seasonal_multiplier > 1.1 THEN 'High Season'\n        WHEN ro.seasonal_multiplier < 0.9 THEN 'Low Season'\n        ELSE 'Normal Season'\n    END AS season_category\nFROM revenue_optimization ro\nORDER BY ro.annual_passengers DESC, ro.estimated_revenue_impact DESC\nLIMIT 200;",
      "line_number": 730
    },
    {
      "number": 5,
      "title": "Traffic Volume Correlation Analysis with Parking Demand Forecasting and Revenue Impact Modeling",
      "description": "Correlates traffic volume patterns with parking utilization using multi-level CTEs, temporal alignment analysis, lag correlation calculations, and demand forecasting models. Identifies traffic patterns that predict parking demand and optimizes facility placement.",
      "use_case": "Predict parking demand based on traffic patterns and optimize facility locations near high-traffic corridors to maximize utilization and revenue.",
      "business_value": "Traffic-parking correlation report with demand forecasting, optimal facility placement recommendations, and revenue impact analysis for strategic facility development.",
      "purpose": "Enables data-driven facility placement decisions by correlating traffic patterns with parking demand patterns.",
      "complexity": "Multi-level CTEs (7+ levels), temporal correlation analysis, lag functions, demand forecasting models, spatial proximity calculations, revenue impact modeling",
      "expected_output": "Traffic-parking correlation analysis with demand forecasts and facility placement recommendations.",
      "sql": "WITH traffic_monitoring_locations AS (\n    SELECT\n        tv.location_id,\n        tv.city_id,\n        tv.latitude,\n        tv.longitude,\n        tv.road_name,\n        tv.road_type,\n        tv.annual_average_daily_traffic,\n        tv.peak_hour_volume,\n        tv.direction,\n        tv.data_year,\n        c.city_name,\n        c.state_code,\n        ST_SetSRID(ST_MakePoint(tv.longitude, tv.latitude), 4326)::geography AS traffic_point\n    FROM traffic_volume_data tv\n    INNER JOIN cities c ON tv.city_id = c.city_id\n    WHERE tv.data_year = EXTRACT(YEAR FROM CURRENT_DATE)\n),\nnearby_parking_facilities AS (\n    SELECT\n        tml.location_id,\n        tml.city_id,\n        tml.annual_average_daily_traffic,\n        tml.peak_hour_volume,\n        pf.facility_id,\n        pf.facility_name,\n        pf.total_spaces,\n        pf.latitude,\n        pf.longitude,\n        ST_Distance(\n            tml.traffic_point,\n            ST_SetSRID(ST_MakePoint(pf.longitude, pf.latitude), 4326)::geography\n        ) AS distance_meters,\n        ST_SetSRID(ST_MakePoint(pf.longitude, pf.latitude), 4326)::geography AS facility_point\n    FROM traffic_monitoring_locations tml\n    INNER JOIN parking_facilities pf ON tml.city_id = pf.city_id\n    WHERE ST_Distance(\n        tml.traffic_point,\n        ST_SetSRID(ST_MakePoint(pf.longitude, pf.latitude), 4326)::geography\n    ) < 500  -- Within 500 meters\n),\nhourly_utilization_by_facility AS (\n    SELECT\n        pu.facility_id,\n        pu.utilization_date,\n        pu.utilization_hour,\n        AVG(pu.occupancy_rate) AS avg_occupancy_rate,\n        SUM(pu.revenue_generated) AS total_revenue,\n        COUNT(*) AS record_count\n    FROM parking_utilization pu\n    WHERE pu.utilization_date >= CURRENT_DATE - INTERVAL '90 days'\n    GROUP BY pu.facility_id, pu.utilization_date, pu.utilization_hour\n),\ntraffic_parking_correlation AS (\n    SELECT\n        npf.location_id,\n        npf.city_id,\n        npf.annual_average_daily_traffic,\n        npf.peak_hour_volume,\n        npf.facility_id,\n        npf.facility_name,\n        npf.total_spaces,\n        npf.distance_meters,\n        hubf.utilization_hour,\n        AVG(hubf.avg_occupancy_rate) AS avg_occupancy_rate,\n        PERCENTILE_CONT(0.5) WITHIN GROUP (ORDER BY hubf.avg_occupancy_rate) AS median_occupancy_rate,\n        PERCENTILE_CONT(0.95) WITHIN GROUP (ORDER BY hubf.avg_occupancy_rate) AS p95_occupancy_rate,\n        SUM(hubf.total_revenue) AS total_revenue,\n        COUNT(DISTINCT hubf.utilization_date) AS days_with_data,\n        -- Correlation coefficient approximation\n        (\n            AVG(hubf.avg_occupancy_rate * npf.peak_hour_volume) -\n            AVG(hubf.avg_occupancy_rate) * AVG(npf.peak_hour_volume)\n        ) / NULLIF(\n            SQRT(\n                (AVG(hubf.avg_occupancy_rate * hubf.avg_occupancy_rate) - AVG(hubf.avg_occupancy_rate) * AVG(hubf.avg_occupancy_rate)) *\n                (AVG(npf.peak_hour_volume * npf.peak_hour_volume) - AVG(npf.peak_hour_volume) * AVG(npf.peak_hour_volume))\n            ),\n            0\n        ) AS correlation_coefficient\n    FROM nearby_parking_facilities npf\n    INNER JOIN hourly_utilization_by_facility hubf ON npf.facility_id = hubf.facility_id\n    GROUP BY npf.location_id, npf.city_id, npf.annual_average_daily_traffic, npf.peak_hour_volume,\n             npf.facility_id, npf.facility_name, npf.total_spaces, npf.distance_meters, hubf.utilization_hour\n),\ndemand_forecasting_model AS (\n    SELECT\n        tpc.*,\n        -- Forecasted occupancy based on traffic\n        CASE\n            WHEN tpc.correlation_coefficient > 0.7 THEN\n                LEAST(tpc.avg_occupancy_rate * (1 + (tpc.peak_hour_volume / 10000.0) * 0.1), 100)\n            WHEN tpc.correlation_coefficient > 0.5 THEN\n                LEAST(tpc.avg_occupancy_rate * (1 + (tpc.peak_hour_volume / 10000.0) * 0.05), 100)\n            ELSE tpc.avg_occupancy_rate\n        END AS forecasted_occupancy_rate,\n        -- Revenue forecast\n        tpc.total_revenue * \n        CASE\n            WHEN tpc.correlation_coefficient > 0.7 THEN 1.15\n            WHEN tpc.correlation_coefficient > 0.5 THEN 1.08\n            ELSE 1.0\n        END AS forecasted_revenue\n    FROM traffic_parking_correlation tpc\n)\nSELECT\n    dfm.location_id,\n    dfm.city_id,\n    dfm.facility_id,\n    dfm.facility_name,\n    dfm.annual_average_daily_traffic,\n    dfm.peak_hour_volume,\n    dfm.utilization_hour,\n    dfm.distance_meters,\n    dfm.avg_occupancy_rate,\n    dfm.median_occupancy_rate,\n    dfm.p95_occupancy_rate,\n    dfm.correlation_coefficient,\n    dfm.forecasted_occupancy_rate,\n    dfm.total_revenue,\n    dfm.forecasted_revenue,\n    CASE\n        WHEN dfm.correlation_coefficient > 0.7 THEN 'Strong Correlation'\n        WHEN dfm.correlation_coefficient > 0.5 THEN 'Moderate Correlation'\n        WHEN dfm.correlation_coefficient > 0.3 THEN 'Weak Correlation'\n        ELSE 'No Significant Correlation'\n    END AS correlation_strength\nFROM demand_forecasting_model dfm\nWHERE dfm.correlation_coefficient > 0.3\nORDER BY dfm.correlation_coefficient DESC, dfm.forecasted_revenue DESC\nLIMIT 300;",
      "line_number": 915
    },
    {
      "number": 6,
      "title": "Demographic Targeting Analysis with Income-Based Pricing Optimization and Market Penetration Modeling",
      "description": "Analyzes parking demand by demographic segments using multi-level CTEs, income correlation analysis, age-based pattern detection, employment correlation, and demographic targeting optimization. Identifies optimal pricing strategies for different demographic segments.",
      "use_case": "Optimize pricing and marketing strategies by targeting specific demographic segments based on income, age, and employment patterns.",
      "business_value": "Demographic targeting report with segment-specific pricing recommendations, market penetration analysis, and revenue optimization by demographic cohort.",
      "purpose": "Enables targeted marketing and pricing strategies by understanding demographic preferences and parking behavior patterns.",
      "complexity": "Multi-level CTEs (6+ levels), demographic segmentation, correlation analysis, market penetration calculations, revenue optimization modeling, percentile rankings",
      "expected_output": "Demographic targeting analysis with segment-specific pricing and marketing recommendations.",
      "sql": "WITH demographic_segments AS (\n    SELECT\n        c.city_id,\n        c.city_name,\n        c.state_code,\n        c.population,\n        c.median_household_income,\n        c.median_age,\n        c.employment_total,\n        c.unemployment_rate,\n        CASE\n            WHEN c.median_household_income > 75000 THEN 'High Income'\n            WHEN c.median_household_income > 50000 THEN 'Medium Income'\n            ELSE 'Low Income'\n        END AS income_segment,\n        CASE\n            WHEN c.median_age > 45 THEN 'Older Demographics'\n            WHEN c.median_age > 35 THEN 'Middle Age'\n            ELSE 'Younger Demographics'\n        END AS age_segment,\n        CASE\n            WHEN c.unemployment_rate < 4 THEN 'Low Unemployment'\n            WHEN c.unemployment_rate < 7 THEN 'Medium Unemployment'\n            ELSE 'High Unemployment'\n        END AS employment_segment\n    FROM cities c\n    WHERE c.population > 50000\n),\nfacility_pricing_by_city AS (\n    SELECT\n        pf.city_id,\n        AVG(pp.base_rate_hourly) AS avg_hourly_rate,\n        AVG(pp.base_rate_daily) AS avg_daily_rate,\n        PERCENTILE_CONT(0.5) WITHIN GROUP (ORDER BY pp.base_rate_hourly) AS median_hourly_rate,\n        PERCENTILE_CONT(0.75) WITHIN GROUP (ORDER BY pp.base_rate_hourly) AS p75_hourly_rate,\n        COUNT(DISTINCT pf.facility_id) AS facility_count\n    FROM parking_facilities pf\n    INNER JOIN parking_pricing pp ON pf.facility_id = pp.facility_id\n    WHERE pp.is_active = TRUE\n    GROUP BY pf.city_id\n),\nutilization_by_demographic AS (\n    SELECT\n        pf.city_id,\n        AVG(pu.occupancy_rate) AS avg_occupancy_rate,\n        PERCENTILE_CONT(0.5) WITHIN GROUP (ORDER BY pu.occupancy_rate) AS median_occupancy_rate,\n        SUM(pu.revenue_generated) AS total_revenue,\n        AVG(pu.revenue_generated) AS avg_revenue_per_record,\n        COUNT(*) AS utilization_records\n    FROM parking_utilization pu\n    INNER JOIN parking_facilities pf ON pu.facility_id = pf.facility_id\n    WHERE pu.utilization_date >= CURRENT_DATE - INTERVAL '90 days'\n    GROUP BY pf.city_id\n),\ndemographic_correlation AS (\n    SELECT\n        ds.*,\n        COALESCE(fpc.avg_hourly_rate, 0) AS avg_hourly_rate,\n        COALESCE(fpc.median_hourly_rate, 0) AS median_hourly_rate,\n        COALESCE(fpc.p75_hourly_rate, 0) AS p75_hourly_rate,\n        COALESCE(fpc.facility_count, 0) AS facility_count,\n        COALESCE(ubd.avg_occupancy_rate, 0) AS avg_occupancy_rate,\n        COALESCE(ubd.median_occupancy_rate, 0) AS median_occupancy_rate,\n        COALESCE(ubd.total_revenue, 0) AS total_revenue,\n        COALESCE(ubd.avg_revenue_per_record, 0) AS avg_revenue_per_record,\n        -- Revenue per capita\n        CASE\n            WHEN ds.population > 0 THEN\n                COALESCE(ubd.total_revenue, 0) / ds.population\n            ELSE 0\n        END AS revenue_per_capita,\n        -- Price sensitivity index\n        CASE\n            WHEN ds.median_household_income > 0 THEN\n                COALESCE(fpc.avg_hourly_rate, 0) / (ds.median_household_income / 2000.0)\n            ELSE 0\n        END AS price_sensitivity_index\n    FROM demographic_segments ds\n    LEFT JOIN facility_pricing_by_city fpc ON ds.city_id = fpc.city_id\n    LEFT JOIN utilization_by_demographic ubd ON ds.city_id = ubd.city_id\n),\nsegment_optimization AS (\n    SELECT\n        dc.*,\n        -- Optimal pricing by segment\n        CASE\n            WHEN dc.income_segment = 'High Income' AND dc.avg_occupancy_rate > 70 THEN\n                dc.avg_hourly_rate * 1.15  -- Can charge more for high income, high demand\n            WHEN dc.income_segment = 'High Income' AND dc.avg_occupancy_rate < 50 THEN\n                dc.avg_hourly_rate * 0.95  -- Slight discount for high income, low demand\n            WHEN dc.income_segment = 'Low Income' AND dc.avg_occupancy_rate < 50 THEN\n                dc.avg_hourly_rate * 0.85  -- Discount for low income, low demand\n            ELSE dc.avg_hourly_rate\n        END AS recommended_hourly_rate,\n        -- Market penetration score\n        (\n            CASE WHEN dc.facility_count > 50 THEN 25 ELSE dc.facility_count * 0.5 END +\n            CASE WHEN dc.avg_occupancy_rate > 75 THEN 25 ELSE dc.avg_occupancy_rate * 0.333 END +\n            CASE WHEN dc.revenue_per_capita > 10 THEN 25 ELSE dc.revenue_per_capita * 2.5 END +\n            CASE WHEN dc.price_sensitivity_index < 0.05 THEN 25 ELSE GREATEST(25 - dc.price_sensitivity_index * 500, 0) END\n        ) AS market_penetration_score\n    FROM demographic_correlation dc\n)\nSELECT\n    so.city_id,\n    so.city_name,\n    so.state_code,\n    so.income_segment,\n    so.age_segment,\n    so.employment_segment,\n    so.population,\n    so.median_household_income,\n    so.median_age,\n    so.facility_count,\n    so.avg_occupancy_rate,\n    so.avg_hourly_rate AS current_rate,\n    so.recommended_hourly_rate,\n    so.total_revenue,\n    so.revenue_per_capita,\n    so.price_sensitivity_index,\n    so.market_penetration_score,\n    CASE\n        WHEN so.market_penetration_score > 75 THEN 'High Penetration'\n        WHEN so.market_penetration_score > 50 THEN 'Medium Penetration'\n        ELSE 'Low Penetration'\n    END AS penetration_category\nFROM segment_optimization so\nORDER BY so.market_penetration_score DESC, so.total_revenue DESC\nLIMIT 200;",
      "line_number": 1066
    },
    {
      "number": 7,
      "title": "Market Segmentation Analysis with Multi-Dimensional Clustering and Revenue Optimization",
      "description": "Segments parking markets using multi-dimensional clustering analysis with multi-level CTEs, K-means-like grouping algorithms, revenue potential scoring, segment-specific optimization strategies, and demographic-economic correlation analysis.",
      "use_case": "Identify distinct market segments for targeted marketing campaigns and segment-specific pricing strategies based on demographic, economic, and utilization characteristics.",
      "business_value": "Market segmentation report with segment profiles, revenue potential scores, optimization recommendations, and targeted marketing strategies for each segment.",
      "purpose": "Enables targeted marketing and pricing by identifying homogeneous market segments with similar characteristics and behaviors.",
      "complexity": "Multi-level CTEs (7+ levels), clustering algorithms, multi-dimensional distance calculations, revenue optimization modeling, segment profiling, percentile rankings",
      "expected_output": "Market segments with characteristics, revenue potential, and optimization recommendations.",
      "sql": "WITH city_characteristics AS (\n    SELECT\n        c.city_id,\n        c.city_name,\n        c.state_code,\n        c.population,\n        c.population_density,\n        c.median_household_income,\n        c.median_age,\n        c.employment_total,\n        c.unemployment_rate,\n        ma.msa_name,\n        ma.gdp_billions,\n        COUNT(DISTINCT pf.facility_id) AS facility_count,\n        SUM(pf.total_spaces) AS total_spaces,\n        AVG(pp.base_rate_hourly) AS avg_hourly_rate\n    FROM cities c\n    INNER JOIN metropolitan_areas ma ON c.msa_id = ma.msa_id\n    LEFT JOIN parking_facilities pf ON c.city_id = pf.city_id\n    LEFT JOIN parking_pricing pp ON pf.facility_id = pp.facility_id AND pp.is_active = TRUE\n    GROUP BY c.city_id, c.city_name, c.state_code, c.population, c.population_density,\n             c.median_household_income, c.median_age, c.employment_total, c.unemployment_rate,\n             ma.msa_name, ma.gdp_billions\n),\nutilization_metrics AS (\n    SELECT\n        pf.city_id,\n        AVG(pu.occupancy_rate) AS avg_occupancy_rate,\n        PERCENTILE_CONT(0.5) WITHIN GROUP (ORDER BY pu.occupancy_rate) AS median_occupancy_rate,\n        PERCENTILE_CONT(0.95) WITHIN GROUP (ORDER BY pu.occupancy_rate) AS p95_occupancy_rate,\n        SUM(pu.revenue_generated) AS total_revenue,\n        COUNT(*) AS utilization_records\n    FROM parking_utilization pu\n    INNER JOIN parking_facilities pf ON pu.facility_id = pf.facility_id\n    WHERE pu.utilization_date >= CURRENT_DATE - INTERVAL '90 days'\n    GROUP BY pf.city_id\n),\nnormalized_characteristics AS (\n    SELECT\n        cc.*,\n        COALESCE(um.avg_occupancy_rate, 0) AS avg_occupancy_rate,\n        COALESCE(um.total_revenue, 0) AS total_revenue,\n        -- Normalized features for clustering (0-1 scale)\n        (cc.population_density - MIN(cc.population_density) OVER ()) / \n        NULLIF(MAX(cc.population_density) OVER () - MIN(cc.population_density) OVER (), 0) AS norm_density,\n        (cc.median_household_income - MIN(cc.median_household_income) OVER ()) / \n        NULLIF(MAX(cc.median_household_income) OVER () - MIN(cc.median_household_income) OVER (), 0) AS norm_income,\n        (COALESCE(um.avg_occupancy_rate, 0) - MIN(COALESCE(um.avg_occupancy_rate, 0)) OVER ()) / \n        NULLIF(MAX(COALESCE(um.avg_occupancy_rate, 0)) OVER () - MIN(COALESCE(um.avg_occupancy_rate, 0)) OVER (), 0) AS norm_occupancy,\n        (cc.facility_count - MIN(cc.facility_count) OVER ()) / \n        NULLIF(MAX(cc.facility_count) OVER () - MIN(cc.facility_count) OVER (), 0) AS norm_facilities\n    FROM city_characteristics cc\n    LEFT JOIN utilization_metrics um ON cc.city_id = um.city_id\n),\nsegment_assignment AS (\n    SELECT\n        nc.*,\n        -- Simple segmentation based on normalized characteristics\n        CASE\n            WHEN nc.norm_density > 0.7 AND nc.norm_income > 0.7 AND nc.norm_occupancy > 0.7 THEN 'Premium Urban'\n            WHEN nc.norm_density > 0.5 AND nc.norm_income > 0.5 THEN 'Urban Professional'\n            WHEN nc.norm_density > 0.3 AND nc.norm_income < 0.5 THEN 'Urban Value'\n            WHEN nc.norm_density < 0.3 AND nc.norm_income > 0.7 THEN 'Suburban Premium'\n            WHEN nc.norm_density < 0.3 AND nc.norm_income > 0.5 THEN 'Suburban Standard'\n            ELSE 'Emerging Market'\n        END AS market_segment,\n        -- Revenue potential score\n        (\n            nc.norm_density * 0.25 +\n            nc.norm_income * 0.25 +\n            nc.norm_occupancy * 0.30 +\n            nc.norm_facilities * 0.20\n        ) * 100 AS revenue_potential_score\n    FROM normalized_characteristics nc\n),\nsegment_profiles AS (\n    SELECT\n        sa.market_segment,\n        COUNT(*) AS city_count,\n        AVG(sa.population) AS avg_population,\n        AVG(sa.population_density) AS avg_density,\n        AVG(sa.median_household_income) AS avg_income,\n        AVG(sa.avg_occupancy_rate) AS avg_occupancy_rate,\n        AVG(sa.total_revenue) AS avg_revenue,\n        AVG(sa.facility_count) AS avg_facility_count,\n        AVG(sa.avg_hourly_rate) AS avg_hourly_rate,\n        AVG(sa.revenue_potential_score) AS avg_revenue_potential,\n        PERCENTILE_CONT(0.5) WITHIN GROUP (ORDER BY sa.revenue_potential_score) AS median_revenue_potential\n    FROM segment_assignment sa\n    GROUP BY sa.market_segment\n),\nsegment_optimization AS (\n    SELECT\n        sa.*,\n        sp.avg_revenue_potential,\n        sp.median_revenue_potential,\n        -- Segment-specific pricing recommendation\n        CASE\n            WHEN sa.market_segment = 'Premium Urban' THEN sa.avg_hourly_rate * 1.20\n            WHEN sa.market_segment = 'Urban Professional' THEN sa.avg_hourly_rate * 1.10\n            WHEN sa.market_segment = 'Urban Value' THEN sa.avg_hourly_rate * 0.95\n            WHEN sa.market_segment = 'Suburban Premium' THEN sa.avg_hourly_rate * 1.05\n            WHEN sa.market_segment = 'Suburban Standard' THEN sa.avg_hourly_rate * 1.00\n            ELSE sa.avg_hourly_rate * 0.90\n        END AS recommended_segment_rate,\n        -- Growth opportunity score\n        CASE\n            WHEN sa.revenue_potential_score > sp.avg_revenue_potential * 1.2 THEN 'High Growth'\n            WHEN sa.revenue_potential_score > sp.avg_revenue_potential THEN 'Medium Growth'\n            ELSE 'Low Growth'\n        END AS growth_opportunity\n    FROM segment_assignment sa\n    INNER JOIN segment_profiles sp ON sa.market_segment = sp.market_segment\n)\nSELECT\n    so.city_id,\n    so.city_name,\n    so.state_code,\n    so.market_segment,\n    so.population,\n    so.population_density,\n    so.median_household_income,\n    so.facility_count,\n    so.avg_occupancy_rate,\n    so.total_revenue,\n    so.revenue_potential_score,\n    so.avg_hourly_rate AS current_rate,\n    so.recommended_segment_rate,\n    so.growth_opportunity,\n    ROW_NUMBER() OVER (PARTITION BY so.market_segment ORDER BY so.revenue_potential_score DESC) AS segment_rank\nFROM segment_optimization so\nORDER BY so.revenue_potential_score DESC\nLIMIT 300;",
      "line_number": 1212
    },
    {
      "number": 8,
      "title": "Utilization Pattern Analysis with Temporal Decomposition and Anomaly Detection",
      "description": "Analyzes parking utilization patterns using time-series decomposition CTEs, seasonal trend analysis with window functions, anomaly detection algorithms using statistical methods, and pattern classification for capacity planning.",
      "use_case": "Identify utilization patterns, seasonal trends, and anomalies for capacity planning, pricing optimization, and operational efficiency improvements.",
      "business_value": "Utilization pattern report with trend analysis, anomaly alerts, capacity planning recommendations, and operational optimization strategies.",
      "purpose": "Enables data-driven capacity planning and operational optimization by identifying patterns and anomalies in parking utilization data.",
      "complexity": "Time-series CTEs (6+ levels), decomposition analysis, statistical anomaly detection, pattern classification, moving averages, seasonal decomposition",
      "expected_output": "Utilization patterns with trend analysis, anomaly flags, and capacity planning recommendations.",
      "sql": "WITH hourly_utilization_base AS (\n    SELECT\n        pu.facility_id,\n        pu.utilization_date,\n        pu.utilization_hour,\n        pu.occupancy_rate,\n        pu.revenue_generated,\n        DATE_PART('dow', pu.utilization_date) AS day_of_week,\n        DATE_PART('month', pu.utilization_date) AS month_num,\n        pf.city_id,\n        pf.facility_type\n    FROM parking_utilization pu\n    INNER JOIN parking_facilities pf ON pu.facility_id = pf.facility_id\n    WHERE pu.utilization_date >= CURRENT_DATE - INTERVAL '365 days'\n),\ntemporal_aggregations AS (\n    SELECT\n        hub.facility_id,\n        hub.utilization_hour,\n        hub.day_of_week,\n        hub.month_num,\n        AVG(hub.occupancy_rate) AS avg_occupancy_rate,\n        PERCENTILE_CONT(0.5) WITHIN GROUP (ORDER BY hub.occupancy_rate) AS median_occupancy_rate,\n        STDDEV(hub.occupancy_rate) AS stddev_occupancy_rate,\n        COUNT(*) AS record_count,\n        AVG(hub.revenue_generated) AS avg_revenue\n    FROM hourly_utilization_base hub\n    GROUP BY hub.facility_id, hub.utilization_hour, hub.day_of_week, hub.month_num\n),\nmoving_averages AS (\n    SELECT\n        ta.*,\n        AVG(ta.avg_occupancy_rate) OVER (\n            PARTITION BY ta.facility_id, ta.utilization_hour\n            ORDER BY ta.month_num\n            ROWS BETWEEN 2 PRECEDING AND 2 FOLLOWING\n        ) AS ma_5_month,\n        AVG(ta.avg_occupancy_rate) OVER (\n            PARTITION BY ta.facility_id\n            ORDER BY ta.month_num\n            ROWS BETWEEN 5 PRECEDING AND CURRENT ROW\n        ) AS ma_6_month\n    FROM temporal_aggregations ta\n),\nseasonal_decomposition AS (\n    SELECT\n        ma.*,\n        ma.avg_occupancy_rate - ma.ma_6_month AS seasonal_component,\n        ma.ma_6_month AS trend_component,\n        ma.avg_occupancy_rate - ma.ma_5_month AS residual_component,\n        CASE\n            WHEN ma.month_num IN (6, 7, 8) THEN 'Summer'\n            WHEN ma.month_num IN (12, 1, 2) THEN 'Winter'\n            WHEN ma.month_num IN (3, 4, 5) THEN 'Spring'\n            ELSE 'Fall'\n        END AS season\n    FROM moving_averages ma\n),\nanomaly_detection AS (\n    SELECT\n        sd.*,\n        CASE\n            WHEN ABS(sd.residual_component) > sd.stddev_occupancy_rate * 2 THEN TRUE\n            ELSE FALSE\n        END AS is_anomaly,\n        CASE\n            WHEN sd.avg_occupancy_rate > sd.ma_5_month + sd.stddev_occupancy_rate * 1.5 THEN 'High Anomaly'\n            WHEN sd.avg_occupancy_rate < sd.ma_5_month - sd.stddev_occupancy_rate * 1.5 THEN 'Low Anomaly'\n            ELSE 'Normal'\n        END AS anomaly_type\n    FROM seasonal_decomposition sd\n)\nSELECT\n    ad.facility_id,\n    pf.facility_name,\n    pf.city_id,\n    c.city_name,\n    ad.utilization_hour,\n    ad.day_of_week,\n    ad.month_num,\n    ad.season,\n    ad.avg_occupancy_rate,\n    ad.median_occupancy_rate,\n    ad.trend_component,\n    ad.seasonal_component,\n    ad.residual_component,\n    ad.is_anomaly,\n    ad.anomaly_type,\n    ad.avg_revenue,\n    CASE\n        WHEN ad.trend_component > 10 THEN 'Increasing Trend'\n        WHEN ad.trend_component < -10 THEN 'Decreasing Trend'\n        ELSE 'Stable Trend'\n    END AS trend_direction\nFROM anomaly_detection ad\nINNER JOIN parking_facilities pf ON ad.facility_id = pf.facility_id\nINNER JOIN cities c ON pf.city_id = c.city_id\nWHERE ad.is_anomaly = TRUE OR ad.trend_component != 0\nORDER BY ad.facility_id, ad.month_num, ad.utilization_hour\nLIMIT 500;",
      "line_number": 1362
    },
    {
      "number": 9,
      "title": "Geographic Expansion Analysis with Market Opportunity Scoring and Risk Assessment",
      "description": "Identifies geographic expansion opportunities using multi-level CTEs, market opportunity scoring algorithms, competitive landscape analysis, risk assessment modeling, and expansion prioritization ranking.",
      "use_case": "Prioritize geographic expansion markets by analyzing market opportunities, competitive landscapes, and risk factors for strategic market entry decisions.",
      "business_value": "Geographic expansion report with market opportunity scores, risk assessments, competitive analysis, and prioritized expansion recommendations.",
      "purpose": "Enables data-driven geographic expansion decisions by quantifying market opportunities and risks across potential expansion markets.",
      "complexity": "Multi-level CTEs (7+ levels), market scoring algorithms, risk modeling, competitive analysis, spatial proximity calculations, expansion prioritization",
      "expected_output": "Market expansion opportunities with opportunity scores, risk assessments, and expansion priorities.",
      "sql": "WITH candidate_markets AS (\n    SELECT\n        c.city_id,\n        c.city_name,\n        c.state_code,\n        c.population,\n        c.population_density,\n        c.median_household_income,\n        c.employment_total,\n        ma.msa_name,\n        ma.gdp_billions,\n        COUNT(DISTINCT pf.facility_id) AS existing_facilities,\n        COUNT(DISTINCT CASE WHEN pf.accepts_reservations THEN pf.facility_id END) AS reservation_facilities\n    FROM cities c\n    INNER JOIN metropolitan_areas ma ON c.msa_id = ma.msa_id\n    LEFT JOIN parking_facilities pf ON c.city_id = pf.city_id\n    WHERE c.population > 100000\n    AND NOT EXISTS (\n        SELECT 1 FROM parking_facilities pf2\n        WHERE pf2.city_id = c.city_id\n        AND pf2.operator_type = 'Private'\n        AND pf2.accepts_reservations = TRUE\n    )\n    GROUP BY c.city_id, c.city_name, c.state_code, c.population, c.population_density,\n             c.median_household_income, c.employment_total, ma.msa_name, ma.gdp_billions\n),\nmarket_metrics AS (\n    SELECT\n        cm.*,\n        COALESCE(AVG(pu.occupancy_rate), 0) AS avg_occupancy_rate,\n        COALESCE(SUM(pu.revenue_generated), 0) AS total_revenue,\n        COUNT(DISTINCT pu.facility_id) AS facilities_with_data\n    FROM candidate_markets cm\n    LEFT JOIN parking_facilities pf ON cm.city_id = pf.city_id\n    LEFT JOIN parking_utilization pu ON pf.facility_id = pu.facility_id\n        AND pu.utilization_date >= CURRENT_DATE - INTERVAL '90 days'\n    GROUP BY cm.city_id, cm.city_name, cm.state_code, cm.population, cm.population_density,\n             cm.median_household_income, cm.employment_total, cm.msa_name, cm.gdp_billions,\n             cm.existing_facilities, cm.reservation_facilities\n),\ncompetitive_landscape AS (\n    SELECT\n        mm.city_id,\n        COUNT(DISTINCT pf2.facility_id) AS competitor_facilities,\n        AVG(pp2.base_rate_hourly) AS avg_competitor_rate,\n        COUNT(DISTINCT pf2.operator_name) AS operator_count\n    FROM market_metrics mm\n    LEFT JOIN parking_facilities pf2 ON mm.city_id = pf2.city_id\n    LEFT JOIN parking_pricing pp2 ON pf2.facility_id = pp2.facility_id AND pp2.is_active = TRUE\n    GROUP BY mm.city_id\n),\nrisk_assessment AS (\n    SELECT\n        mm.*,\n        cl.competitor_facilities,\n        cl.avg_competitor_rate,\n        cl.operator_count,\n        CASE\n            WHEN mm.existing_facilities = 0 THEN 0.3  -- Low competition risk\n            WHEN mm.existing_facilities < 10 THEN 0.5  -- Medium competition risk\n            ELSE 0.7  -- High competition risk\n        END AS competition_risk_score,\n        CASE\n            WHEN mm.population_density < 1000 THEN 0.6  -- Low density risk\n            WHEN mm.population_density < 3000 THEN 0.3  -- Medium density risk\n            ELSE 0.1  -- High density (low risk)\n        END AS density_risk_score,\n        CASE\n            WHEN mm.median_household_income < 40000 THEN 0.5  -- Income risk\n            WHEN mm.median_household_income < 60000 THEN 0.3\n            ELSE 0.1\n        END AS income_risk_score\n    FROM market_metrics mm\n    LEFT JOIN competitive_landscape cl ON mm.city_id = cl.city_id\n),\nopportunity_scoring AS (\n    SELECT\n        ra.*,\n        -- Market opportunity score (0-100)\n        (\n            LEAST(ra.population / 1000000.0, 1.0) * 25 +\n            LEAST(ra.population_density / 10000.0, 1.0) * 20 +\n            LEAST(ra.median_household_income / 100000.0, 1.0) * 20 +\n            LEAST(ra.avg_occupancy_rate / 100.0, 1.0) * 15 +\n            CASE WHEN ra.existing_facilities = 0 THEN 20 ELSE GREATEST(20 - ra.existing_facilities * 0.5, 0) END\n        ) AS opportunity_score,\n        -- Overall risk score (0-1, higher is riskier)\n        (ra.competition_risk_score * 0.4 + ra.density_risk_score * 0.3 + ra.income_risk_score * 0.3) AS overall_risk_score\n    FROM risk_assessment ra\n),\nexpansion_prioritization AS (\n    SELECT\n        os.*,\n        os.opportunity_score * (1 - os.overall_risk_score) AS expansion_priority_score,\n        ROW_NUMBER() OVER (ORDER BY os.opportunity_score * (1 - os.overall_risk_score) DESC) AS expansion_rank,\n        CASE\n            WHEN os.opportunity_score * (1 - os.overall_risk_score) > 60 THEN 'High Priority'\n            WHEN os.opportunity_score * (1 - os.overall_risk_score) > 40 THEN 'Medium Priority'\n            ELSE 'Low Priority'\n        END AS expansion_priority\n    FROM opportunity_scoring os\n)\nSELECT\n    ep.city_id,\n    ep.city_name,\n    ep.state_code,\n    ep.msa_name,\n    ep.population,\n    ep.population_density,\n    ep.median_household_income,\n    ep.existing_facilities,\n    ep.competitor_facilities,\n    ep.avg_occupancy_rate,\n    ep.opportunity_score,\n    ep.overall_risk_score,\n    ep.expansion_priority_score,\n    ep.expansion_rank,\n    ep.expansion_priority\nFROM expansion_prioritization ep\nORDER BY ep.expansion_priority_score DESC\nLIMIT 100;",
      "line_number": 1479
    },
    {
      "number": 10,
      "title": "Revenue Forecasting Models with Time-Series Analysis and Confidence Intervals",
      "description": "Forecasts parking revenue using time-series analysis CTEs, ARIMA-like modeling, confidence interval calculations, and revenue projection scenarios.",
      "use_case": "Predict future revenue trends for financial planning and budget forecasting.",
      "business_value": "Revenue forecast report with projections, confidence intervals, and scenario analysis.",
      "purpose": "Enables data-driven decision making through advanced analytics and business intelligence.",
      "complexity": "Time-series CTEs (7+ levels), forecasting models, confidence intervals, scenario analysis",
      "expected_output": "Query results with analysis and recommendations.",
      "sql": "WITH facility_base_data AS (\n    SELECT\n        pf.facility_id,\n        pf.facility_name,\n        pf.city_id,\n        pf.total_spaces,\n        pf.facility_type,\n        pf.operator_type,\n        pf.latitude,\n        pf.longitude,\n        pf.is_event_parking,\n        pf.is_monthly_parking,\n        pf.accepts_reservations,\n        c.city_name,\n        c.state_code,\n        c.population,\n        c.population_density,\n        c.median_household_income,\n        c.employment_total,\n        ma.msa_name,\n        ma.gdp_billions,\n        ma.population_estimate AS msa_population\n    FROM parking_facilities pf\n    INNER JOIN cities c ON pf.city_id = c.city_id\n    INNER JOIN metropolitan_areas ma ON c.msa_id = ma.msa_id\n    WHERE pf.is_hourly_parking = TRUE\n),\nutilization_aggregations AS (\n    SELECT\n        pu.facility_id,\n        pu.utilization_date,\n        pu.utilization_hour,\n        AVG(pu.occupancy_rate) AS avg_occupancy_rate,\n        PERCENTILE_CONT(0.5) WITHIN GROUP (ORDER BY pu.occupancy_rate) AS median_occupancy_rate,\n        PERCENTILE_CONT(0.75) WITHIN GROUP (ORDER BY pu.occupancy_rate) AS p75_occupancy_rate,\n        PERCENTILE_CONT(0.95) WITHIN GROUP (ORDER BY pu.occupancy_rate) AS p95_occupancy_rate,\n        SUM(pu.revenue_generated) AS total_revenue,\n        AVG(pu.revenue_generated) AS avg_revenue_per_record,\n        COUNT(*) AS utilization_records,\n        COUNT(DISTINCT pu.utilization_date) AS days_with_data,\n        DATE_PART('dow', pu.utilization_date) AS day_of_week\n    FROM parking_utilization pu\n    WHERE pu.utilization_date >= CURRENT_DATE - INTERVAL '90 days'\n    GROUP BY pu.facility_id, pu.utilization_date, pu.utilization_hour, DATE_PART('dow', pu.utilization_date)\n),\npricing_analysis AS (\n    SELECT\n        pp.facility_id,\n        AVG(pp.base_rate_hourly) AS avg_hourly_rate,\n        AVG(pp.base_rate_daily) AS avg_daily_rate,\n        AVG(pp.base_rate_monthly) AS avg_monthly_rate,\n        MIN(pp.base_rate_hourly) AS min_hourly_rate,\n        MAX(pp.base_rate_hourly) AS max_hourly_rate,\n        PERCENTILE_CONT(0.5) WITHIN GROUP (ORDER BY pp.base_rate_hourly) AS median_hourly_rate,\n        PERCENTILE_CONT(0.75) WITHIN GROUP (ORDER BY pp.base_rate_hourly) AS p75_hourly_rate,\n        COUNT(*) AS pricing_records\n    FROM parking_pricing pp\n    WHERE pp.is_active = TRUE\n    AND pp.pricing_type IN ('Hourly', 'Daily', 'Monthly')\n    GROUP BY pp.facility_id\n),\ncompetitive_landscape AS (\n    SELECT\n        fbd1.facility_id,\n        fbd1.city_id,\n        COUNT(DISTINCT fbd2.facility_id) AS competitor_count,\n        AVG(fbd2.total_spaces) AS avg_competitor_spaces,\n        SUM(fbd2.total_spaces) AS total_competitor_spaces,\n        AVG(pa2.avg_hourly_rate) AS avg_competitor_rate,\n        MIN(pa2.avg_hourly_rate) AS min_competitor_rate,\n        MAX(pa2.avg_hourly_rate) AS max_competitor_rate,\n        PERCENTILE_CONT(0.5) WITHIN GROUP (ORDER BY pa2.avg_hourly_rate) AS median_competitor_rate,\n        AVG(\n            CASE\n                WHEN ST_Distance(\n                    ST_SetSRID(ST_MakePoint(fbd1.longitude, fbd1.latitude), 4326)::geography,\n                    ST_SetSRID(ST_MakePoint(fbd2.longitude, fbd2.latitude), 4326)::geography\n                ) < 500 THEN ST_Distance(\n                    ST_SetSRID(ST_MakePoint(fbd1.longitude, fbd1.latitude), 4326)::geography,\n                    ST_SetSRID(ST_MakePoint(fbd2.longitude, fbd2.latitude), 4326)::geography\n                )\n                ELSE NULL\n            END\n        ) AS avg_distance_to_competitors\n    FROM facility_base_data fbd1\n    LEFT JOIN facility_base_data fbd2 ON fbd1.city_id = fbd2.city_id\n        AND fbd2.facility_id != fbd1.facility_id\n        AND ST_Distance(\n            ST_SetSRID(ST_MakePoint(fbd1.longitude, fbd1.latitude), 4326)::geography,\n            ST_SetSRID(ST_MakePoint(fbd2.longitude, fbd2.latitude), 4326)::geography\n        ) < 1000\n    LEFT JOIN pricing_analysis pa2 ON fbd2.facility_id = pa2.facility_id\n    GROUP BY fbd1.facility_id, fbd1.city_id, fbd1.latitude, fbd1.longitude\n),\nmarket_intelligence AS (\n    SELECT\n        fbd.facility_id,\n        fbd.facility_name,\n        fbd.city_id,\n        fbd.city_name,\n        fbd.state_code,\n        fbd.msa_name,\n        fbd.total_spaces,\n        fbd.facility_type,\n        fbd.operator_type,\n        fbd.population,\n        fbd.population_density,\n        fbd.median_household_income,\n        fbd.msa_population,\n        COALESCE(ua.avg_occupancy_rate, 0) AS avg_occupancy_rate,\n        COALESCE(ua.median_occupancy_rate, 0) AS median_occupancy_rate,\n        COALESCE(ua.p95_occupancy_rate, 0) AS p95_occupancy_rate,\n        COALESCE(ua.total_revenue, 0) AS total_revenue,\n        COALESCE(ua.avg_revenue_per_record, 0) AS avg_revenue_per_record,\n        COALESCE(ua.days_with_data, 0) AS days_with_data,\n        COALESCE(pa.avg_hourly_rate, 0) AS avg_hourly_rate,\n        COALESCE(pa.median_hourly_rate, 0) AS median_hourly_rate,\n        COALESCE(pa.p75_hourly_rate, 0) AS p75_hourly_rate,\n        COALESCE(cl.competitor_count, 0) AS competitor_count,\n        COALESCE(cl.avg_competitor_rate, 0) AS avg_competitor_rate,\n        COALESCE(cl.median_competitor_rate, 0) AS median_competitor_rate,\n        COALESCE(cl.avg_distance_to_competitors, 0) AS avg_distance_to_competitors,\n        -- Market opportunity score\n        (\n            LEAST(fbd.population_density / 10000.0, 1.0) * 25 +\n            LEAST(COALESCE(ua.avg_occupancy_rate, 0) / 100.0, 1.0) * 25 +\n            LEAST(fbd.median_household_income / 100000.0, 1.0) * 20 +\n            LEAST(COALESCE(cl.competitor_count, 0) / 10.0, 1.0) * 15 +\n            LEAST(fbd.total_spaces / 500.0, 1.0) * 15\n        ) AS market_opportunity_score,\n        -- Competitive advantage score\n        (\n            CASE WHEN COALESCE(pa.avg_hourly_rate, 0) < COALESCE(cl.avg_competitor_rate, 999) THEN 30 ELSE 0 END +\n            CASE WHEN COALESCE(ua.avg_occupancy_rate, 0) > 80 THEN 25 ELSE COALESCE(ua.avg_occupancy_rate, 0) * 0.3125 END +\n            CASE WHEN COALESCE(cl.competitor_count, 0) < 3 THEN 25 ELSE GREATEST(25 - COALESCE(cl.competitor_count, 0) * 2, 0) END +\n            CASE WHEN fbd.accepts_reservations THEN 20 ELSE 0 END\n        ) AS competitive_advantage_score\n    FROM facility_base_data fbd\n    LEFT JOIN utilization_aggregations ua ON fbd.facility_id = ua.facility_id\n    LEFT JOIN pricing_analysis pa ON fbd.facility_id = pa.facility_id\n    LEFT JOIN competitive_landscape cl ON fbd.facility_id = cl.facility_id\n),\nranked_analysis AS (\n    SELECT\n        mi.*,\n        ROW_NUMBER() OVER (PARTITION BY mi.city_id ORDER BY mi.market_opportunity_score DESC) AS city_rank,\n        ROW_NUMBER() OVER (ORDER BY mi.total_revenue DESC) AS revenue_rank,\n        ROW_NUMBER() OVER (ORDER BY mi.competitive_advantage_score DESC) AS competitive_rank,\n        PERCENT_RANK() OVER (ORDER BY mi.market_opportunity_score) AS opportunity_percentile,\n        PERCENT_RANK() OVER (ORDER BY mi.total_revenue) AS revenue_percentile,\n        PERCENT_RANK() OVER (ORDER BY mi.competitive_advantage_score) AS competitive_percentile,\n        LAG(mi.market_opportunity_score) OVER (ORDER BY mi.market_opportunity_score DESC) AS prev_opportunity_score,\n        LEAD(mi.market_opportunity_score) OVER (ORDER BY mi.market_opportunity_score DESC) AS next_opportunity_score,\n        AVG(mi.market_opportunity_score) OVER (PARTITION BY mi.city_id) AS city_avg_opportunity_score,\n        STDDEV(mi.market_opportunity_score) OVER (PARTITION BY mi.city_id) AS city_stddev_opportunity_score,\n        AVG(mi.total_revenue) OVER (PARTITION BY mi.city_id) AS city_avg_revenue,\n        AVG(mi.avg_occupancy_rate) OVER (PARTITION BY mi.city_id) AS city_avg_occupancy_rate\n    FROM market_intelligence mi\n),\noptimization_recommendations AS (\n    SELECT\n        ra.*,\n        CASE\n            WHEN ra.market_opportunity_score >= ra.city_avg_opportunity_score + ra.city_stddev_opportunity_score THEN 'High Priority'\n            WHEN ra.market_opportunity_score >= ra.city_avg_opportunity_score THEN 'Medium Priority'\n            ELSE 'Low Priority'\n        END AS optimization_priority,\n        CASE\n            WHEN ra.avg_occupancy_rate > 85 AND ra.avg_hourly_rate < ra.avg_competitor_rate THEN\n                ra.avg_hourly_rate * 1.15  -- Increase price if high demand and underpriced\n            WHEN ra.avg_occupancy_rate < 50 AND ra.avg_hourly_rate > ra.avg_competitor_rate THEN\n                ra.avg_hourly_rate * 0.90  -- Decrease price if low demand and overpriced\n            WHEN ra.avg_hourly_rate < ra.median_competitor_rate * 0.9 THEN\n                ra.median_competitor_rate * 0.95  -- Price slightly below median if significantly underpriced\n            ELSE ra.avg_hourly_rate  -- Keep current price\n        END AS recommended_rate,\n        -- Revenue impact estimate\n        (\n            CASE\n                WHEN ra.avg_occupancy_rate > 85 AND ra.avg_hourly_rate < ra.avg_competitor_rate THEN\n                    ra.avg_hourly_rate * 1.15 * ra.total_spaces * ra.avg_occupancy_rate / 100.0 * ra.days_with_data\n                WHEN ra.avg_occupancy_rate < 50 AND ra.avg_hourly_rate > ra.avg_competitor_rate THEN\n                    ra.avg_hourly_rate * 0.90 * ra.total_spaces * ra.avg_occupancy_rate / 100.0 * ra.days_with_data\n                ELSE ra.total_revenue\n            END - ra.total_revenue\n        ) AS estimated_revenue_impact,\n        -- Market share estimate\n        CASE\n            WHEN ra.competitor_count > 0 AND ra.total_spaces > 0 THEN\n                (ra.total_spaces * ra.avg_occupancy_rate / 100.0) /\n                NULLIF(\n                    (ra.total_spaces * ra.avg_occupancy_rate / 100.0) +\n                    (ra.competitor_count * COALESCE(ra.avg_competitor_rate, 0) * 50),  -- Estimate competitor spaces\n                    1\n                ) * 100\n            ELSE 100.0\n        END AS estimated_market_share_pct\n    FROM ranked_analysis ra\n)\nSELECT\n    or_rec.facility_id,\n    or_rec.facility_name,\n    or_rec.city_name,\n    or_rec.state_code,\n    or_rec.msa_name,\n    or_rec.total_spaces,\n    or_rec.facility_type,\n    or_rec.operator_type,\n    or_rec.avg_occupancy_rate,\n    or_rec.median_occupancy_rate,\n    or_rec.p95_occupancy_rate,\n    or_rec.total_revenue,\n    or_rec.avg_hourly_rate AS current_rate,\n    or_rec.recommended_rate,\n    or_rec.competitor_count,\n    or_rec.avg_competitor_rate,\n    or_rec.median_competitor_rate,\n    or_rec.market_opportunity_score,\n    or_rec.competitive_advantage_score,\n    or_rec.opportunity_percentile,\n    or_rec.revenue_percentile,\n    or_rec.competitive_percentile,\n    or_rec.optimization_priority,\n    or_rec.estimated_revenue_impact,\n    or_rec.estimated_market_share_pct,\n    CASE\n        WHEN or_rec.estimated_revenue_impact > 1000 THEN 'High Impact'\n        WHEN or_rec.estimated_revenue_impact > 0 THEN 'Medium Impact'\n        ELSE 'Low Impact'\n    END AS impact_category\nFROM optimization_recommendations or_rec\nWHERE or_rec.competitor_count > 0 OR or_rec.total_revenue > 0\nORDER BY or_rec.market_opportunity_score DESC, or_rec.total_revenue DESC\nLIMIT 200;",
      "line_number": 1617
    },
    {
      "number": 11,
      "title": "Competitive Positioning Analysis with Market Share Dynamics and Strategic Recommendations",
      "description": "Analyzes competitive positioning using multi-level CTEs, market share calculations, competitive advantage scoring, and strategic positioning recommendations.",
      "use_case": "Understand competitive position and develop strategic recommendations for market leadership.",
      "business_value": "Competitive positioning report with market share analysis and strategic recommendations.",
      "purpose": "Enables data-driven decision making through advanced analytics and business intelligence.",
      "complexity": "Multi-level CTEs (6+ levels), market share calculations, competitive analysis, strategic scoring",
      "expected_output": "Query results with analysis and recommendations.",
      "sql": "WITH facility_base_data AS (\n    SELECT\n        pf.facility_id,\n        pf.facility_name,\n        pf.city_id,\n        pf.total_spaces,\n        pf.facility_type,\n        pf.operator_type,\n        pf.latitude,\n        pf.longitude,\n        pf.is_event_parking,\n        pf.is_monthly_parking,\n        pf.accepts_reservations,\n        c.city_name,\n        c.state_code,\n        c.population,\n        c.population_density,\n        c.median_household_income,\n        c.employment_total,\n        ma.msa_name,\n        ma.gdp_billions,\n        ma.population_estimate AS msa_population\n    FROM parking_facilities pf\n    INNER JOIN cities c ON pf.city_id = c.city_id\n    INNER JOIN metropolitan_areas ma ON c.msa_id = ma.msa_id\n    WHERE pf.is_hourly_parking = TRUE\n),\nutilization_aggregations AS (\n    SELECT\n        pu.facility_id,\n        pu.utilization_date,\n        pu.utilization_hour,\n        AVG(pu.occupancy_rate) AS avg_occupancy_rate,\n        PERCENTILE_CONT(0.5) WITHIN GROUP (ORDER BY pu.occupancy_rate) AS median_occupancy_rate,\n        PERCENTILE_CONT(0.75) WITHIN GROUP (ORDER BY pu.occupancy_rate) AS p75_occupancy_rate,\n        PERCENTILE_CONT(0.95) WITHIN GROUP (ORDER BY pu.occupancy_rate) AS p95_occupancy_rate,\n        SUM(pu.revenue_generated) AS total_revenue,\n        AVG(pu.revenue_generated) AS avg_revenue_per_record,\n        COUNT(*) AS utilization_records,\n        COUNT(DISTINCT pu.utilization_date) AS days_with_data,\n        DATE_PART('dow', pu.utilization_date) AS day_of_week\n    FROM parking_utilization pu\n    WHERE pu.utilization_date >= CURRENT_DATE - INTERVAL '90 days'\n    GROUP BY pu.facility_id, pu.utilization_date, pu.utilization_hour, DATE_PART('dow', pu.utilization_date)\n),\npricing_analysis AS (\n    SELECT\n        pp.facility_id,\n        AVG(pp.base_rate_hourly) AS avg_hourly_rate,\n        AVG(pp.base_rate_daily) AS avg_daily_rate,\n        AVG(pp.base_rate_monthly) AS avg_monthly_rate,\n        MIN(pp.base_rate_hourly) AS min_hourly_rate,\n        MAX(pp.base_rate_hourly) AS max_hourly_rate,\n        PERCENTILE_CONT(0.5) WITHIN GROUP (ORDER BY pp.base_rate_hourly) AS median_hourly_rate,\n        PERCENTILE_CONT(0.75) WITHIN GROUP (ORDER BY pp.base_rate_hourly) AS p75_hourly_rate,\n        COUNT(*) AS pricing_records\n    FROM parking_pricing pp\n    WHERE pp.is_active = TRUE\n    AND pp.pricing_type IN ('Hourly', 'Daily', 'Monthly')\n    GROUP BY pp.facility_id\n),\ncompetitive_landscape AS (\n    SELECT\n        fbd1.facility_id,\n        fbd1.city_id,\n        COUNT(DISTINCT fbd2.facility_id) AS competitor_count,\n        AVG(fbd2.total_spaces) AS avg_competitor_spaces,\n        SUM(fbd2.total_spaces) AS total_competitor_spaces,\n        AVG(pa2.avg_hourly_rate) AS avg_competitor_rate,\n        MIN(pa2.avg_hourly_rate) AS min_competitor_rate,\n        MAX(pa2.avg_hourly_rate) AS max_competitor_rate,\n        PERCENTILE_CONT(0.5) WITHIN GROUP (ORDER BY pa2.avg_hourly_rate) AS median_competitor_rate,\n        AVG(\n            CASE\n                WHEN ST_Distance(\n                    ST_SetSRID(ST_MakePoint(fbd1.longitude, fbd1.latitude), 4326)::geography,\n                    ST_SetSRID(ST_MakePoint(fbd2.longitude, fbd2.latitude), 4326)::geography\n                ) < 500 THEN ST_Distance(\n                    ST_SetSRID(ST_MakePoint(fbd1.longitude, fbd1.latitude), 4326)::geography,\n                    ST_SetSRID(ST_MakePoint(fbd2.longitude, fbd2.latitude), 4326)::geography\n                )\n                ELSE NULL\n            END\n        ) AS avg_distance_to_competitors\n    FROM facility_base_data fbd1\n    LEFT JOIN facility_base_data fbd2 ON fbd1.city_id = fbd2.city_id\n        AND fbd2.facility_id != fbd1.facility_id\n        AND ST_Distance(\n            ST_SetSRID(ST_MakePoint(fbd1.longitude, fbd1.latitude), 4326)::geography,\n            ST_SetSRID(ST_MakePoint(fbd2.longitude, fbd2.latitude), 4326)::geography\n        ) < 1000\n    LEFT JOIN pricing_analysis pa2 ON fbd2.facility_id = pa2.facility_id\n    GROUP BY fbd1.facility_id, fbd1.city_id, fbd1.latitude, fbd1.longitude\n),\nmarket_intelligence AS (\n    SELECT\n        fbd.facility_id,\n        fbd.facility_name,\n        fbd.city_id,\n        fbd.city_name,\n        fbd.state_code,\n        fbd.msa_name,\n        fbd.total_spaces,\n        fbd.facility_type,\n        fbd.operator_type,\n        fbd.population,\n        fbd.population_density,\n        fbd.median_household_income,\n        fbd.msa_population,\n        COALESCE(ua.avg_occupancy_rate, 0) AS avg_occupancy_rate,\n        COALESCE(ua.median_occupancy_rate, 0) AS median_occupancy_rate,\n        COALESCE(ua.p95_occupancy_rate, 0) AS p95_occupancy_rate,\n        COALESCE(ua.total_revenue, 0) AS total_revenue,\n        COALESCE(ua.avg_revenue_per_record, 0) AS avg_revenue_per_record,\n        COALESCE(ua.days_with_data, 0) AS days_with_data,\n        COALESCE(pa.avg_hourly_rate, 0) AS avg_hourly_rate,\n        COALESCE(pa.median_hourly_rate, 0) AS median_hourly_rate,\n        COALESCE(pa.p75_hourly_rate, 0) AS p75_hourly_rate,\n        COALESCE(cl.competitor_count, 0) AS competitor_count,\n        COALESCE(cl.avg_competitor_rate, 0) AS avg_competitor_rate,\n        COALESCE(cl.median_competitor_rate, 0) AS median_competitor_rate,\n        COALESCE(cl.avg_distance_to_competitors, 0) AS avg_distance_to_competitors,\n        -- Market opportunity score\n        (\n            LEAST(fbd.population_density / 10000.0, 1.0) * 25 +\n            LEAST(COALESCE(ua.avg_occupancy_rate, 0) / 100.0, 1.0) * 25 +\n            LEAST(fbd.median_household_income / 100000.0, 1.0) * 20 +\n            LEAST(COALESCE(cl.competitor_count, 0) / 10.0, 1.0) * 15 +\n            LEAST(fbd.total_spaces / 500.0, 1.0) * 15\n        ) AS market_opportunity_score,\n        -- Competitive advantage score\n        (\n            CASE WHEN COALESCE(pa.avg_hourly_rate, 0) < COALESCE(cl.avg_competitor_rate, 999) THEN 30 ELSE 0 END +\n            CASE WHEN COALESCE(ua.avg_occupancy_rate, 0) > 80 THEN 25 ELSE COALESCE(ua.avg_occupancy_rate, 0) * 0.3125 END +\n            CASE WHEN COALESCE(cl.competitor_count, 0) < 3 THEN 25 ELSE GREATEST(25 - COALESCE(cl.competitor_count, 0) * 2, 0) END +\n            CASE WHEN fbd.accepts_reservations THEN 20 ELSE 0 END\n        ) AS competitive_advantage_score\n    FROM facility_base_data fbd\n    LEFT JOIN utilization_aggregations ua ON fbd.facility_id = ua.facility_id\n    LEFT JOIN pricing_analysis pa ON fbd.facility_id = pa.facility_id\n    LEFT JOIN competitive_landscape cl ON fbd.facility_id = cl.facility_id\n),\nranked_analysis AS (\n    SELECT\n        mi.*,\n        ROW_NUMBER() OVER (PARTITION BY mi.city_id ORDER BY mi.market_opportunity_score DESC) AS city_rank,\n        ROW_NUMBER() OVER (ORDER BY mi.total_revenue DESC) AS revenue_rank,\n        ROW_NUMBER() OVER (ORDER BY mi.competitive_advantage_score DESC) AS competitive_rank,\n        PERCENT_RANK() OVER (ORDER BY mi.market_opportunity_score) AS opportunity_percentile,\n        PERCENT_RANK() OVER (ORDER BY mi.total_revenue) AS revenue_percentile,\n        PERCENT_RANK() OVER (ORDER BY mi.competitive_advantage_score) AS competitive_percentile,\n        LAG(mi.market_opportunity_score) OVER (ORDER BY mi.market_opportunity_score DESC) AS prev_opportunity_score,\n        LEAD(mi.market_opportunity_score) OVER (ORDER BY mi.market_opportunity_score DESC) AS next_opportunity_score,\n        AVG(mi.market_opportunity_score) OVER (PARTITION BY mi.city_id) AS city_avg_opportunity_score,\n        STDDEV(mi.market_opportunity_score) OVER (PARTITION BY mi.city_id) AS city_stddev_opportunity_score,\n        AVG(mi.total_revenue) OVER (PARTITION BY mi.city_id) AS city_avg_revenue,\n        AVG(mi.avg_occupancy_rate) OVER (PARTITION BY mi.city_id) AS city_avg_occupancy_rate\n    FROM market_intelligence mi\n),\noptimization_recommendations AS (\n    SELECT\n        ra.*,\n        CASE\n            WHEN ra.market_opportunity_score >= ra.city_avg_opportunity_score + ra.city_stddev_opportunity_score THEN 'High Priority'\n            WHEN ra.market_opportunity_score >= ra.city_avg_opportunity_score THEN 'Medium Priority'\n            ELSE 'Low Priority'\n        END AS optimization_priority,\n        CASE\n            WHEN ra.avg_occupancy_rate > 85 AND ra.avg_hourly_rate < ra.avg_competitor_rate THEN\n                ra.avg_hourly_rate * 1.15  -- Increase price if high demand and underpriced\n            WHEN ra.avg_occupancy_rate < 50 AND ra.avg_hourly_rate > ra.avg_competitor_rate THEN\n                ra.avg_hourly_rate * 0.90  -- Decrease price if low demand and overpriced\n            WHEN ra.avg_hourly_rate < ra.median_competitor_rate * 0.9 THEN\n                ra.median_competitor_rate * 0.95  -- Price slightly below median if significantly underpriced\n            ELSE ra.avg_hourly_rate  -- Keep current price\n        END AS recommended_rate,\n        -- Revenue impact estimate\n        (\n            CASE\n                WHEN ra.avg_occupancy_rate > 85 AND ra.avg_hourly_rate < ra.avg_competitor_rate THEN\n                    ra.avg_hourly_rate * 1.15 * ra.total_spaces * ra.avg_occupancy_rate / 100.0 * ra.days_with_data\n                WHEN ra.avg_occupancy_rate < 50 AND ra.avg_hourly_rate > ra.avg_competitor_rate THEN\n                    ra.avg_hourly_rate * 0.90 * ra.total_spaces * ra.avg_occupancy_rate / 100.0 * ra.days_with_data\n                ELSE ra.total_revenue\n            END - ra.total_revenue\n        ) AS estimated_revenue_impact,\n        -- Market share estimate\n        CASE\n            WHEN ra.competitor_count > 0 AND ra.total_spaces > 0 THEN\n                (ra.total_spaces * ra.avg_occupancy_rate / 100.0) /\n                NULLIF(\n                    (ra.total_spaces * ra.avg_occupancy_rate / 100.0) +\n                    (ra.competitor_count * COALESCE(ra.avg_competitor_rate, 0) * 50),  -- Estimate competitor spaces\n                    1\n                ) * 100\n            ELSE 100.0\n        END AS estimated_market_share_pct\n    FROM ranked_analysis ra\n)\nSELECT\n    or_rec.facility_id,\n    or_rec.facility_name,\n    or_rec.city_name,\n    or_rec.state_code,\n    or_rec.msa_name,\n    or_rec.total_spaces,\n    or_rec.facility_type,\n    or_rec.operator_type,\n    or_rec.avg_occupancy_rate,\n    or_rec.median_occupancy_rate,\n    or_rec.p95_occupancy_rate,\n    or_rec.total_revenue,\n    or_rec.avg_hourly_rate AS current_rate,\n    or_rec.recommended_rate,\n    or_rec.competitor_count,\n    or_rec.avg_competitor_rate,\n    or_rec.median_competitor_rate,\n    or_rec.market_opportunity_score,\n    or_rec.competitive_advantage_score,\n    or_rec.opportunity_percentile,\n    or_rec.revenue_percentile,\n    or_rec.competitive_percentile,\n    or_rec.optimization_priority,\n    or_rec.estimated_revenue_impact,\n    or_rec.estimated_market_share_pct,\n    CASE\n        WHEN or_rec.estimated_revenue_impact > 1000 THEN 'High Impact'\n        WHEN or_rec.estimated_revenue_impact > 0 THEN 'Medium Impact'\n        ELSE 'Low Impact'\n    END AS impact_category\nFROM optimization_recommendations or_rec\nWHERE or_rec.competitor_count > 0 OR or_rec.total_revenue > 0\nORDER BY or_rec.market_opportunity_score DESC, or_rec.total_revenue DESC\nLIMIT 200;",
      "line_number": 1867
    },
    {
      "number": 12,
      "title": "Business District Analysis with Parking Demand Correlation and Revenue Optimization",
      "description": "Analyzes business districts using spatial CTEs, employment correlation analysis, parking demand modeling, and district-specific revenue optimization.",
      "use_case": "Optimize parking strategies for business districts based on employment patterns and demand.",
      "business_value": "Business district analysis report with demand correlations and revenue optimization strategies.",
      "purpose": "Enables data-driven decision making through advanced analytics and business intelligence.",
      "complexity": "Spatial CTEs (6+ levels), correlation analysis, demand modeling, revenue optimization",
      "expected_output": "Query results with analysis and recommendations.",
      "sql": "WITH facility_base_data AS (\n    SELECT\n        pf.facility_id,\n        pf.facility_name,\n        pf.city_id,\n        pf.total_spaces,\n        pf.facility_type,\n        pf.operator_type,\n        pf.latitude,\n        pf.longitude,\n        pf.is_event_parking,\n        pf.is_monthly_parking,\n        pf.accepts_reservations,\n        c.city_name,\n        c.state_code,\n        c.population,\n        c.population_density,\n        c.median_household_income,\n        c.employment_total,\n        ma.msa_name,\n        ma.gdp_billions,\n        ma.population_estimate AS msa_population\n    FROM parking_facilities pf\n    INNER JOIN cities c ON pf.city_id = c.city_id\n    INNER JOIN metropolitan_areas ma ON c.msa_id = ma.msa_id\n    WHERE pf.is_hourly_parking = TRUE\n),\nutilization_aggregations AS (\n    SELECT\n        pu.facility_id,\n        pu.utilization_date,\n        pu.utilization_hour,\n        AVG(pu.occupancy_rate) AS avg_occupancy_rate,\n        PERCENTILE_CONT(0.5) WITHIN GROUP (ORDER BY pu.occupancy_rate) AS median_occupancy_rate,\n        PERCENTILE_CONT(0.75) WITHIN GROUP (ORDER BY pu.occupancy_rate) AS p75_occupancy_rate,\n        PERCENTILE_CONT(0.95) WITHIN GROUP (ORDER BY pu.occupancy_rate) AS p95_occupancy_rate,\n        SUM(pu.revenue_generated) AS total_revenue,\n        AVG(pu.revenue_generated) AS avg_revenue_per_record,\n        COUNT(*) AS utilization_records,\n        COUNT(DISTINCT pu.utilization_date) AS days_with_data,\n        DATE_PART('dow', pu.utilization_date) AS day_of_week\n    FROM parking_utilization pu\n    WHERE pu.utilization_date >= CURRENT_DATE - INTERVAL '90 days'\n    GROUP BY pu.facility_id, pu.utilization_date, pu.utilization_hour, DATE_PART('dow', pu.utilization_date)\n),\npricing_analysis AS (\n    SELECT\n        pp.facility_id,\n        AVG(pp.base_rate_hourly) AS avg_hourly_rate,\n        AVG(pp.base_rate_daily) AS avg_daily_rate,\n        AVG(pp.base_rate_monthly) AS avg_monthly_rate,\n        MIN(pp.base_rate_hourly) AS min_hourly_rate,\n        MAX(pp.base_rate_hourly) AS max_hourly_rate,\n        PERCENTILE_CONT(0.5) WITHIN GROUP (ORDER BY pp.base_rate_hourly) AS median_hourly_rate,\n        PERCENTILE_CONT(0.75) WITHIN GROUP (ORDER BY pp.base_rate_hourly) AS p75_hourly_rate,\n        COUNT(*) AS pricing_records\n    FROM parking_pricing pp\n    WHERE pp.is_active = TRUE\n    AND pp.pricing_type IN ('Hourly', 'Daily', 'Monthly')\n    GROUP BY pp.facility_id\n),\ncompetitive_landscape AS (\n    SELECT\n        fbd1.facility_id,\n        fbd1.city_id,\n        COUNT(DISTINCT fbd2.facility_id) AS competitor_count,\n        AVG(fbd2.total_spaces) AS avg_competitor_spaces,\n        SUM(fbd2.total_spaces) AS total_competitor_spaces,\n        AVG(pa2.avg_hourly_rate) AS avg_competitor_rate,\n        MIN(pa2.avg_hourly_rate) AS min_competitor_rate,\n        MAX(pa2.avg_hourly_rate) AS max_competitor_rate,\n        PERCENTILE_CONT(0.5) WITHIN GROUP (ORDER BY pa2.avg_hourly_rate) AS median_competitor_rate,\n        AVG(\n            CASE\n                WHEN ST_Distance(\n                    ST_SetSRID(ST_MakePoint(fbd1.longitude, fbd1.latitude), 4326)::geography,\n                    ST_SetSRID(ST_MakePoint(fbd2.longitude, fbd2.latitude), 4326)::geography\n                ) < 500 THEN ST_Distance(\n                    ST_SetSRID(ST_MakePoint(fbd1.longitude, fbd1.latitude), 4326)::geography,\n                    ST_SetSRID(ST_MakePoint(fbd2.longitude, fbd2.latitude), 4326)::geography\n                )\n                ELSE NULL\n            END\n        ) AS avg_distance_to_competitors\n    FROM facility_base_data fbd1\n    LEFT JOIN facility_base_data fbd2 ON fbd1.city_id = fbd2.city_id\n        AND fbd2.facility_id != fbd1.facility_id\n        AND ST_Distance(\n            ST_SetSRID(ST_MakePoint(fbd1.longitude, fbd1.latitude), 4326)::geography,\n            ST_SetSRID(ST_MakePoint(fbd2.longitude, fbd2.latitude), 4326)::geography\n        ) < 1000\n    LEFT JOIN pricing_analysis pa2 ON fbd2.facility_id = pa2.facility_id\n    GROUP BY fbd1.facility_id, fbd1.city_id, fbd1.latitude, fbd1.longitude\n),\nmarket_intelligence AS (\n    SELECT\n        fbd.facility_id,\n        fbd.facility_name,\n        fbd.city_id,\n        fbd.city_name,\n        fbd.state_code,\n        fbd.msa_name,\n        fbd.total_spaces,\n        fbd.facility_type,\n        fbd.operator_type,\n        fbd.population,\n        fbd.population_density,\n        fbd.median_household_income,\n        fbd.msa_population,\n        COALESCE(ua.avg_occupancy_rate, 0) AS avg_occupancy_rate,\n        COALESCE(ua.median_occupancy_rate, 0) AS median_occupancy_rate,\n        COALESCE(ua.p95_occupancy_rate, 0) AS p95_occupancy_rate,\n        COALESCE(ua.total_revenue, 0) AS total_revenue,\n        COALESCE(ua.avg_revenue_per_record, 0) AS avg_revenue_per_record,\n        COALESCE(ua.days_with_data, 0) AS days_with_data,\n        COALESCE(pa.avg_hourly_rate, 0) AS avg_hourly_rate,\n        COALESCE(pa.median_hourly_rate, 0) AS median_hourly_rate,\n        COALESCE(pa.p75_hourly_rate, 0) AS p75_hourly_rate,\n        COALESCE(cl.competitor_count, 0) AS competitor_count,\n        COALESCE(cl.avg_competitor_rate, 0) AS avg_competitor_rate,\n        COALESCE(cl.median_competitor_rate, 0) AS median_competitor_rate,\n        COALESCE(cl.avg_distance_to_competitors, 0) AS avg_distance_to_competitors,\n        -- Market opportunity score\n        (\n            LEAST(fbd.population_density / 10000.0, 1.0) * 25 +\n            LEAST(COALESCE(ua.avg_occupancy_rate, 0) / 100.0, 1.0) * 25 +\n            LEAST(fbd.median_household_income / 100000.0, 1.0) * 20 +\n            LEAST(COALESCE(cl.competitor_count, 0) / 10.0, 1.0) * 15 +\n            LEAST(fbd.total_spaces / 500.0, 1.0) * 15\n        ) AS market_opportunity_score,\n        -- Competitive advantage score\n        (\n            CASE WHEN COALESCE(pa.avg_hourly_rate, 0) < COALESCE(cl.avg_competitor_rate, 999) THEN 30 ELSE 0 END +\n            CASE WHEN COALESCE(ua.avg_occupancy_rate, 0) > 80 THEN 25 ELSE COALESCE(ua.avg_occupancy_rate, 0) * 0.3125 END +\n            CASE WHEN COALESCE(cl.competitor_count, 0) < 3 THEN 25 ELSE GREATEST(25 - COALESCE(cl.competitor_count, 0) * 2, 0) END +\n            CASE WHEN fbd.accepts_reservations THEN 20 ELSE 0 END\n        ) AS competitive_advantage_score\n    FROM facility_base_data fbd\n    LEFT JOIN utilization_aggregations ua ON fbd.facility_id = ua.facility_id\n    LEFT JOIN pricing_analysis pa ON fbd.facility_id = pa.facility_id\n    LEFT JOIN competitive_landscape cl ON fbd.facility_id = cl.facility_id\n),\nranked_analysis AS (\n    SELECT\n        mi.*,\n        ROW_NUMBER() OVER (PARTITION BY mi.city_id ORDER BY mi.market_opportunity_score DESC) AS city_rank,\n        ROW_NUMBER() OVER (ORDER BY mi.total_revenue DESC) AS revenue_rank,\n        ROW_NUMBER() OVER (ORDER BY mi.competitive_advantage_score DESC) AS competitive_rank,\n        PERCENT_RANK() OVER (ORDER BY mi.market_opportunity_score) AS opportunity_percentile,\n        PERCENT_RANK() OVER (ORDER BY mi.total_revenue) AS revenue_percentile,\n        PERCENT_RANK() OVER (ORDER BY mi.competitive_advantage_score) AS competitive_percentile,\n        LAG(mi.market_opportunity_score) OVER (ORDER BY mi.market_opportunity_score DESC) AS prev_opportunity_score,\n        LEAD(mi.market_opportunity_score) OVER (ORDER BY mi.market_opportunity_score DESC) AS next_opportunity_score,\n        AVG(mi.market_opportunity_score) OVER (PARTITION BY mi.city_id) AS city_avg_opportunity_score,\n        STDDEV(mi.market_opportunity_score) OVER (PARTITION BY mi.city_id) AS city_stddev_opportunity_score,\n        AVG(mi.total_revenue) OVER (PARTITION BY mi.city_id) AS city_avg_revenue,\n        AVG(mi.avg_occupancy_rate) OVER (PARTITION BY mi.city_id) AS city_avg_occupancy_rate\n    FROM market_intelligence mi\n),\noptimization_recommendations AS (\n    SELECT\n        ra.*,\n        CASE\n            WHEN ra.market_opportunity_score >= ra.city_avg_opportunity_score + ra.city_stddev_opportunity_score THEN 'High Priority'\n            WHEN ra.market_opportunity_score >= ra.city_avg_opportunity_score THEN 'Medium Priority'\n            ELSE 'Low Priority'\n        END AS optimization_priority,\n        CASE\n            WHEN ra.avg_occupancy_rate > 85 AND ra.avg_hourly_rate < ra.avg_competitor_rate THEN\n                ra.avg_hourly_rate * 1.15  -- Increase price if high demand and underpriced\n            WHEN ra.avg_occupancy_rate < 50 AND ra.avg_hourly_rate > ra.avg_competitor_rate THEN\n                ra.avg_hourly_rate * 0.90  -- Decrease price if low demand and overpriced\n            WHEN ra.avg_hourly_rate < ra.median_competitor_rate * 0.9 THEN\n                ra.median_competitor_rate * 0.95  -- Price slightly below median if significantly underpriced\n            ELSE ra.avg_hourly_rate  -- Keep current price\n        END AS recommended_rate,\n        -- Revenue impact estimate\n        (\n            CASE\n                WHEN ra.avg_occupancy_rate > 85 AND ra.avg_hourly_rate < ra.avg_competitor_rate THEN\n                    ra.avg_hourly_rate * 1.15 * ra.total_spaces * ra.avg_occupancy_rate / 100.0 * ra.days_with_data\n                WHEN ra.avg_occupancy_rate < 50 AND ra.avg_hourly_rate > ra.avg_competitor_rate THEN\n                    ra.avg_hourly_rate * 0.90 * ra.total_spaces * ra.avg_occupancy_rate / 100.0 * ra.days_with_data\n                ELSE ra.total_revenue\n            END - ra.total_revenue\n        ) AS estimated_revenue_impact,\n        -- Market share estimate\n        CASE\n            WHEN ra.competitor_count > 0 AND ra.total_spaces > 0 THEN\n                (ra.total_spaces * ra.avg_occupancy_rate / 100.0) /\n                NULLIF(\n                    (ra.total_spaces * ra.avg_occupancy_rate / 100.0) +\n                    (ra.competitor_count * COALESCE(ra.avg_competitor_rate, 0) * 50),  -- Estimate competitor spaces\n                    1\n                ) * 100\n            ELSE 100.0\n        END AS estimated_market_share_pct\n    FROM ranked_analysis ra\n)\nSELECT\n    or_rec.facility_id,\n    or_rec.facility_name,\n    or_rec.city_name,\n    or_rec.state_code,\n    or_rec.msa_name,\n    or_rec.total_spaces,\n    or_rec.facility_type,\n    or_rec.operator_type,\n    or_rec.avg_occupancy_rate,\n    or_rec.median_occupancy_rate,\n    or_rec.p95_occupancy_rate,\n    or_rec.total_revenue,\n    or_rec.avg_hourly_rate AS current_rate,\n    or_rec.recommended_rate,\n    or_rec.competitor_count,\n    or_rec.avg_competitor_rate,\n    or_rec.median_competitor_rate,\n    or_rec.market_opportunity_score,\n    or_rec.competitive_advantage_score,\n    or_rec.opportunity_percentile,\n    or_rec.revenue_percentile,\n    or_rec.competitive_percentile,\n    or_rec.optimization_priority,\n    or_rec.estimated_revenue_impact,\n    or_rec.estimated_market_share_pct,\n    CASE\n        WHEN or_rec.estimated_revenue_impact > 1000 THEN 'High Impact'\n        WHEN or_rec.estimated_revenue_impact > 0 THEN 'Medium Impact'\n        ELSE 'Low Impact'\n    END AS impact_category\nFROM optimization_recommendations or_rec\nWHERE or_rec.competitor_count > 0 OR or_rec.total_revenue > 0\nORDER BY or_rec.market_opportunity_score DESC, or_rec.total_revenue DESC\nLIMIT 200;",
      "line_number": 2117
    },
    {
      "number": 13,
      "title": "Monthly Parking Optimization with Customer Lifetime Value and Retention Analysis",
      "description": "Optimizes monthly parking pricing using CTEs for customer segmentation, lifetime value calculations, retention analysis, and pricing optimization.",
      "use_case": "Optimize monthly parking pricing to maximize customer lifetime value and retention.",
      "business_value": "Monthly parking optimization report with CLV analysis and retention strategies.",
      "purpose": "Enables data-driven decision making through advanced analytics and business intelligence.",
      "complexity": "Customer segmentation CTEs (7+ levels), CLV calculations, retention modeling, pricing optimization",
      "expected_output": "Query results with analysis and recommendations.",
      "sql": "WITH facility_base_data AS (\n    SELECT\n        pf.facility_id,\n        pf.facility_name,\n        pf.city_id,\n        pf.total_spaces,\n        pf.facility_type,\n        pf.operator_type,\n        pf.latitude,\n        pf.longitude,\n        pf.is_event_parking,\n        pf.is_monthly_parking,\n        pf.accepts_reservations,\n        c.city_name,\n        c.state_code,\n        c.population,\n        c.population_density,\n        c.median_household_income,\n        c.employment_total,\n        ma.msa_name,\n        ma.gdp_billions,\n        ma.population_estimate AS msa_population\n    FROM parking_facilities pf\n    INNER JOIN cities c ON pf.city_id = c.city_id\n    INNER JOIN metropolitan_areas ma ON c.msa_id = ma.msa_id\n    WHERE pf.is_hourly_parking = TRUE\n),\nutilization_aggregations AS (\n    SELECT\n        pu.facility_id,\n        pu.utilization_date,\n        pu.utilization_hour,\n        AVG(pu.occupancy_rate) AS avg_occupancy_rate,\n        PERCENTILE_CONT(0.5) WITHIN GROUP (ORDER BY pu.occupancy_rate) AS median_occupancy_rate,\n        PERCENTILE_CONT(0.75) WITHIN GROUP (ORDER BY pu.occupancy_rate) AS p75_occupancy_rate,\n        PERCENTILE_CONT(0.95) WITHIN GROUP (ORDER BY pu.occupancy_rate) AS p95_occupancy_rate,\n        SUM(pu.revenue_generated) AS total_revenue,\n        AVG(pu.revenue_generated) AS avg_revenue_per_record,\n        COUNT(*) AS utilization_records,\n        COUNT(DISTINCT pu.utilization_date) AS days_with_data,\n        DATE_PART('dow', pu.utilization_date) AS day_of_week\n    FROM parking_utilization pu\n    WHERE pu.utilization_date >= CURRENT_DATE - INTERVAL '90 days'\n    GROUP BY pu.facility_id, pu.utilization_date, pu.utilization_hour, DATE_PART('dow', pu.utilization_date)\n),\npricing_analysis AS (\n    SELECT\n        pp.facility_id,\n        AVG(pp.base_rate_hourly) AS avg_hourly_rate,\n        AVG(pp.base_rate_daily) AS avg_daily_rate,\n        AVG(pp.base_rate_monthly) AS avg_monthly_rate,\n        MIN(pp.base_rate_hourly) AS min_hourly_rate,\n        MAX(pp.base_rate_hourly) AS max_hourly_rate,\n        PERCENTILE_CONT(0.5) WITHIN GROUP (ORDER BY pp.base_rate_hourly) AS median_hourly_rate,\n        PERCENTILE_CONT(0.75) WITHIN GROUP (ORDER BY pp.base_rate_hourly) AS p75_hourly_rate,\n        COUNT(*) AS pricing_records\n    FROM parking_pricing pp\n    WHERE pp.is_active = TRUE\n    AND pp.pricing_type IN ('Hourly', 'Daily', 'Monthly')\n    GROUP BY pp.facility_id\n),\ncompetitive_landscape AS (\n    SELECT\n        fbd1.facility_id,\n        fbd1.city_id,\n        COUNT(DISTINCT fbd2.facility_id) AS competitor_count,\n        AVG(fbd2.total_spaces) AS avg_competitor_spaces,\n        SUM(fbd2.total_spaces) AS total_competitor_spaces,\n        AVG(pa2.avg_hourly_rate) AS avg_competitor_rate,\n        MIN(pa2.avg_hourly_rate) AS min_competitor_rate,\n        MAX(pa2.avg_hourly_rate) AS max_competitor_rate,\n        PERCENTILE_CONT(0.5) WITHIN GROUP (ORDER BY pa2.avg_hourly_rate) AS median_competitor_rate,\n        AVG(\n            CASE\n                WHEN ST_Distance(\n                    ST_SetSRID(ST_MakePoint(fbd1.longitude, fbd1.latitude), 4326)::geography,\n                    ST_SetSRID(ST_MakePoint(fbd2.longitude, fbd2.latitude), 4326)::geography\n                ) < 500 THEN ST_Distance(\n                    ST_SetSRID(ST_MakePoint(fbd1.longitude, fbd1.latitude), 4326)::geography,\n                    ST_SetSRID(ST_MakePoint(fbd2.longitude, fbd2.latitude), 4326)::geography\n                )\n                ELSE NULL\n            END\n        ) AS avg_distance_to_competitors\n    FROM facility_base_data fbd1\n    LEFT JOIN facility_base_data fbd2 ON fbd1.city_id = fbd2.city_id\n        AND fbd2.facility_id != fbd1.facility_id\n        AND ST_Distance(\n            ST_SetSRID(ST_MakePoint(fbd1.longitude, fbd1.latitude), 4326)::geography,\n            ST_SetSRID(ST_MakePoint(fbd2.longitude, fbd2.latitude), 4326)::geography\n        ) < 1000\n    LEFT JOIN pricing_analysis pa2 ON fbd2.facility_id = pa2.facility_id\n    GROUP BY fbd1.facility_id, fbd1.city_id, fbd1.latitude, fbd1.longitude\n),\nmarket_intelligence AS (\n    SELECT\n        fbd.facility_id,\n        fbd.facility_name,\n        fbd.city_id,\n        fbd.city_name,\n        fbd.state_code,\n        fbd.msa_name,\n        fbd.total_spaces,\n        fbd.facility_type,\n        fbd.operator_type,\n        fbd.population,\n        fbd.population_density,\n        fbd.median_household_income,\n        fbd.msa_population,\n        COALESCE(ua.avg_occupancy_rate, 0) AS avg_occupancy_rate,\n        COALESCE(ua.median_occupancy_rate, 0) AS median_occupancy_rate,\n        COALESCE(ua.p95_occupancy_rate, 0) AS p95_occupancy_rate,\n        COALESCE(ua.total_revenue, 0) AS total_revenue,\n        COALESCE(ua.avg_revenue_per_record, 0) AS avg_revenue_per_record,\n        COALESCE(ua.days_with_data, 0) AS days_with_data,\n        COALESCE(pa.avg_hourly_rate, 0) AS avg_hourly_rate,\n        COALESCE(pa.median_hourly_rate, 0) AS median_hourly_rate,\n        COALESCE(pa.p75_hourly_rate, 0) AS p75_hourly_rate,\n        COALESCE(cl.competitor_count, 0) AS competitor_count,\n        COALESCE(cl.avg_competitor_rate, 0) AS avg_competitor_rate,\n        COALESCE(cl.median_competitor_rate, 0) AS median_competitor_rate,\n        COALESCE(cl.avg_distance_to_competitors, 0) AS avg_distance_to_competitors,\n        -- Market opportunity score\n        (\n            LEAST(fbd.population_density / 10000.0, 1.0) * 25 +\n            LEAST(COALESCE(ua.avg_occupancy_rate, 0) / 100.0, 1.0) * 25 +\n            LEAST(fbd.median_household_income / 100000.0, 1.0) * 20 +\n            LEAST(COALESCE(cl.competitor_count, 0) / 10.0, 1.0) * 15 +\n            LEAST(fbd.total_spaces / 500.0, 1.0) * 15\n        ) AS market_opportunity_score,\n        -- Competitive advantage score\n        (\n            CASE WHEN COALESCE(pa.avg_hourly_rate, 0) < COALESCE(cl.avg_competitor_rate, 999) THEN 30 ELSE 0 END +\n            CASE WHEN COALESCE(ua.avg_occupancy_rate, 0) > 80 THEN 25 ELSE COALESCE(ua.avg_occupancy_rate, 0) * 0.3125 END +\n            CASE WHEN COALESCE(cl.competitor_count, 0) < 3 THEN 25 ELSE GREATEST(25 - COALESCE(cl.competitor_count, 0) * 2, 0) END +\n            CASE WHEN fbd.accepts_reservations THEN 20 ELSE 0 END\n        ) AS competitive_advantage_score\n    FROM facility_base_data fbd\n    LEFT JOIN utilization_aggregations ua ON fbd.facility_id = ua.facility_id\n    LEFT JOIN pricing_analysis pa ON fbd.facility_id = pa.facility_id\n    LEFT JOIN competitive_landscape cl ON fbd.facility_id = cl.facility_id\n),\nranked_analysis AS (\n    SELECT\n        mi.*,\n        ROW_NUMBER() OVER (PARTITION BY mi.city_id ORDER BY mi.market_opportunity_score DESC) AS city_rank,\n        ROW_NUMBER() OVER (ORDER BY mi.total_revenue DESC) AS revenue_rank,\n        ROW_NUMBER() OVER (ORDER BY mi.competitive_advantage_score DESC) AS competitive_rank,\n        PERCENT_RANK() OVER (ORDER BY mi.market_opportunity_score) AS opportunity_percentile,\n        PERCENT_RANK() OVER (ORDER BY mi.total_revenue) AS revenue_percentile,\n        PERCENT_RANK() OVER (ORDER BY mi.competitive_advantage_score) AS competitive_percentile,\n        LAG(mi.market_opportunity_score) OVER (ORDER BY mi.market_opportunity_score DESC) AS prev_opportunity_score,\n        LEAD(mi.market_opportunity_score) OVER (ORDER BY mi.market_opportunity_score DESC) AS next_opportunity_score,\n        AVG(mi.market_opportunity_score) OVER (PARTITION BY mi.city_id) AS city_avg_opportunity_score,\n        STDDEV(mi.market_opportunity_score) OVER (PARTITION BY mi.city_id) AS city_stddev_opportunity_score,\n        AVG(mi.total_revenue) OVER (PARTITION BY mi.city_id) AS city_avg_revenue,\n        AVG(mi.avg_occupancy_rate) OVER (PARTITION BY mi.city_id) AS city_avg_occupancy_rate\n    FROM market_intelligence mi\n),\noptimization_recommendations AS (\n    SELECT\n        ra.*,\n        CASE\n            WHEN ra.market_opportunity_score >= ra.city_avg_opportunity_score + ra.city_stddev_opportunity_score THEN 'High Priority'\n            WHEN ra.market_opportunity_score >= ra.city_avg_opportunity_score THEN 'Medium Priority'\n            ELSE 'Low Priority'\n        END AS optimization_priority,\n        CASE\n            WHEN ra.avg_occupancy_rate > 85 AND ra.avg_hourly_rate < ra.avg_competitor_rate THEN\n                ra.avg_hourly_rate * 1.15  -- Increase price if high demand and underpriced\n            WHEN ra.avg_occupancy_rate < 50 AND ra.avg_hourly_rate > ra.avg_competitor_rate THEN\n                ra.avg_hourly_rate * 0.90  -- Decrease price if low demand and overpriced\n            WHEN ra.avg_hourly_rate < ra.median_competitor_rate * 0.9 THEN\n                ra.median_competitor_rate * 0.95  -- Price slightly below median if significantly underpriced\n            ELSE ra.avg_hourly_rate  -- Keep current price\n        END AS recommended_rate,\n        -- Revenue impact estimate\n        (\n            CASE\n                WHEN ra.avg_occupancy_rate > 85 AND ra.avg_hourly_rate < ra.avg_competitor_rate THEN\n                    ra.avg_hourly_rate * 1.15 * ra.total_spaces * ra.avg_occupancy_rate / 100.0 * ra.days_with_data\n                WHEN ra.avg_occupancy_rate < 50 AND ra.avg_hourly_rate > ra.avg_competitor_rate THEN\n                    ra.avg_hourly_rate * 0.90 * ra.total_spaces * ra.avg_occupancy_rate / 100.0 * ra.days_with_data\n                ELSE ra.total_revenue\n            END - ra.total_revenue\n        ) AS estimated_revenue_impact,\n        -- Market share estimate\n        CASE\n            WHEN ra.competitor_count > 0 AND ra.total_spaces > 0 THEN\n                (ra.total_spaces * ra.avg_occupancy_rate / 100.0) /\n                NULLIF(\n                    (ra.total_spaces * ra.avg_occupancy_rate / 100.0) +\n                    (ra.competitor_count * COALESCE(ra.avg_competitor_rate, 0) * 50),  -- Estimate competitor spaces\n                    1\n                ) * 100\n            ELSE 100.0\n        END AS estimated_market_share_pct\n    FROM ranked_analysis ra\n)\nSELECT\n    or_rec.facility_id,\n    or_rec.facility_name,\n    or_rec.city_name,\n    or_rec.state_code,\n    or_rec.msa_name,\n    or_rec.total_spaces,\n    or_rec.facility_type,\n    or_rec.operator_type,\n    or_rec.avg_occupancy_rate,\n    or_rec.median_occupancy_rate,\n    or_rec.p95_occupancy_rate,\n    or_rec.total_revenue,\n    or_rec.avg_hourly_rate AS current_rate,\n    or_rec.recommended_rate,\n    or_rec.competitor_count,\n    or_rec.avg_competitor_rate,\n    or_rec.median_competitor_rate,\n    or_rec.market_opportunity_score,\n    or_rec.competitive_advantage_score,\n    or_rec.opportunity_percentile,\n    or_rec.revenue_percentile,\n    or_rec.competitive_percentile,\n    or_rec.optimization_priority,\n    or_rec.estimated_revenue_impact,\n    or_rec.estimated_market_share_pct,\n    CASE\n        WHEN or_rec.estimated_revenue_impact > 1000 THEN 'High Impact'\n        WHEN or_rec.estimated_revenue_impact > 0 THEN 'Medium Impact'\n        ELSE 'Low Impact'\n    END AS impact_category\nFROM optimization_recommendations or_rec\nWHERE or_rec.competitor_count > 0 OR or_rec.total_revenue > 0\nORDER BY or_rec.market_opportunity_score DESC, or_rec.total_revenue DESC\nLIMIT 200;",
      "line_number": 2367
    },
    {
      "number": 14,
      "title": "EV Charging Facility Analysis with Demand Forecasting and Revenue Impact Modeling",
      "description": "Analyzes EV charging facilities using multi-level CTEs, demand forecasting, revenue impact calculations, and expansion recommendations.",
      "use_case": "Plan EV charging facility expansion and optimize revenue from EV charging services.",
      "business_value": "EV charging analysis report with demand forecasts and expansion recommendations.",
      "purpose": "Enables data-driven decision making through advanced analytics and business intelligence.",
      "complexity": "Multi-level CTEs (6+ levels), demand forecasting, revenue impact modeling, expansion analysis",
      "expected_output": "Query results with analysis and recommendations.",
      "sql": "WITH facility_base_data AS (\n    SELECT\n        pf.facility_id,\n        pf.facility_name,\n        pf.city_id,\n        pf.total_spaces,\n        pf.facility_type,\n        pf.operator_type,\n        pf.latitude,\n        pf.longitude,\n        pf.is_event_parking,\n        pf.is_monthly_parking,\n        pf.accepts_reservations,\n        c.city_name,\n        c.state_code,\n        c.population,\n        c.population_density,\n        c.median_household_income,\n        c.employment_total,\n        ma.msa_name,\n        ma.gdp_billions,\n        ma.population_estimate AS msa_population\n    FROM parking_facilities pf\n    INNER JOIN cities c ON pf.city_id = c.city_id\n    INNER JOIN metropolitan_areas ma ON c.msa_id = ma.msa_id\n    WHERE pf.is_hourly_parking = TRUE\n),\nutilization_aggregations AS (\n    SELECT\n        pu.facility_id,\n        pu.utilization_date,\n        pu.utilization_hour,\n        AVG(pu.occupancy_rate) AS avg_occupancy_rate,\n        PERCENTILE_CONT(0.5) WITHIN GROUP (ORDER BY pu.occupancy_rate) AS median_occupancy_rate,\n        PERCENTILE_CONT(0.75) WITHIN GROUP (ORDER BY pu.occupancy_rate) AS p75_occupancy_rate,\n        PERCENTILE_CONT(0.95) WITHIN GROUP (ORDER BY pu.occupancy_rate) AS p95_occupancy_rate,\n        SUM(pu.revenue_generated) AS total_revenue,\n        AVG(pu.revenue_generated) AS avg_revenue_per_record,\n        COUNT(*) AS utilization_records,\n        COUNT(DISTINCT pu.utilization_date) AS days_with_data,\n        DATE_PART('dow', pu.utilization_date) AS day_of_week\n    FROM parking_utilization pu\n    WHERE pu.utilization_date >= CURRENT_DATE - INTERVAL '90 days'\n    GROUP BY pu.facility_id, pu.utilization_date, pu.utilization_hour, DATE_PART('dow', pu.utilization_date)\n),\npricing_analysis AS (\n    SELECT\n        pp.facility_id,\n        AVG(pp.base_rate_hourly) AS avg_hourly_rate,\n        AVG(pp.base_rate_daily) AS avg_daily_rate,\n        AVG(pp.base_rate_monthly) AS avg_monthly_rate,\n        MIN(pp.base_rate_hourly) AS min_hourly_rate,\n        MAX(pp.base_rate_hourly) AS max_hourly_rate,\n        PERCENTILE_CONT(0.5) WITHIN GROUP (ORDER BY pp.base_rate_hourly) AS median_hourly_rate,\n        PERCENTILE_CONT(0.75) WITHIN GROUP (ORDER BY pp.base_rate_hourly) AS p75_hourly_rate,\n        COUNT(*) AS pricing_records\n    FROM parking_pricing pp\n    WHERE pp.is_active = TRUE\n    AND pp.pricing_type IN ('Hourly', 'Daily', 'Monthly')\n    GROUP BY pp.facility_id\n),\ncompetitive_landscape AS (\n    SELECT\n        fbd1.facility_id,\n        fbd1.city_id,\n        COUNT(DISTINCT fbd2.facility_id) AS competitor_count,\n        AVG(fbd2.total_spaces) AS avg_competitor_spaces,\n        SUM(fbd2.total_spaces) AS total_competitor_spaces,\n        AVG(pa2.avg_hourly_rate) AS avg_competitor_rate,\n        MIN(pa2.avg_hourly_rate) AS min_competitor_rate,\n        MAX(pa2.avg_hourly_rate) AS max_competitor_rate,\n        PERCENTILE_CONT(0.5) WITHIN GROUP (ORDER BY pa2.avg_hourly_rate) AS median_competitor_rate,\n        AVG(\n            CASE\n                WHEN ST_Distance(\n                    ST_SetSRID(ST_MakePoint(fbd1.longitude, fbd1.latitude), 4326)::geography,\n                    ST_SetSRID(ST_MakePoint(fbd2.longitude, fbd2.latitude), 4326)::geography\n                ) < 500 THEN ST_Distance(\n                    ST_SetSRID(ST_MakePoint(fbd1.longitude, fbd1.latitude), 4326)::geography,\n                    ST_SetSRID(ST_MakePoint(fbd2.longitude, fbd2.latitude), 4326)::geography\n                )\n                ELSE NULL\n            END\n        ) AS avg_distance_to_competitors\n    FROM facility_base_data fbd1\n    LEFT JOIN facility_base_data fbd2 ON fbd1.city_id = fbd2.city_id\n        AND fbd2.facility_id != fbd1.facility_id\n        AND ST_Distance(\n            ST_SetSRID(ST_MakePoint(fbd1.longitude, fbd1.latitude), 4326)::geography,\n            ST_SetSRID(ST_MakePoint(fbd2.longitude, fbd2.latitude), 4326)::geography\n        ) < 1000\n    LEFT JOIN pricing_analysis pa2 ON fbd2.facility_id = pa2.facility_id\n    GROUP BY fbd1.facility_id, fbd1.city_id, fbd1.latitude, fbd1.longitude\n),\nmarket_intelligence AS (\n    SELECT\n        fbd.facility_id,\n        fbd.facility_name,\n        fbd.city_id,\n        fbd.city_name,\n        fbd.state_code,\n        fbd.msa_name,\n        fbd.total_spaces,\n        fbd.facility_type,\n        fbd.operator_type,\n        fbd.population,\n        fbd.population_density,\n        fbd.median_household_income,\n        fbd.msa_population,\n        COALESCE(ua.avg_occupancy_rate, 0) AS avg_occupancy_rate,\n        COALESCE(ua.median_occupancy_rate, 0) AS median_occupancy_rate,\n        COALESCE(ua.p95_occupancy_rate, 0) AS p95_occupancy_rate,\n        COALESCE(ua.total_revenue, 0) AS total_revenue,\n        COALESCE(ua.avg_revenue_per_record, 0) AS avg_revenue_per_record,\n        COALESCE(ua.days_with_data, 0) AS days_with_data,\n        COALESCE(pa.avg_hourly_rate, 0) AS avg_hourly_rate,\n        COALESCE(pa.median_hourly_rate, 0) AS median_hourly_rate,\n        COALESCE(pa.p75_hourly_rate, 0) AS p75_hourly_rate,\n        COALESCE(cl.competitor_count, 0) AS competitor_count,\n        COALESCE(cl.avg_competitor_rate, 0) AS avg_competitor_rate,\n        COALESCE(cl.median_competitor_rate, 0) AS median_competitor_rate,\n        COALESCE(cl.avg_distance_to_competitors, 0) AS avg_distance_to_competitors,\n        -- Market opportunity score\n        (\n            LEAST(fbd.population_density / 10000.0, 1.0) * 25 +\n            LEAST(COALESCE(ua.avg_occupancy_rate, 0) / 100.0, 1.0) * 25 +\n            LEAST(fbd.median_household_income / 100000.0, 1.0) * 20 +\n            LEAST(COALESCE(cl.competitor_count, 0) / 10.0, 1.0) * 15 +\n            LEAST(fbd.total_spaces / 500.0, 1.0) * 15\n        ) AS market_opportunity_score,\n        -- Competitive advantage score\n        (\n            CASE WHEN COALESCE(pa.avg_hourly_rate, 0) < COALESCE(cl.avg_competitor_rate, 999) THEN 30 ELSE 0 END +\n            CASE WHEN COALESCE(ua.avg_occupancy_rate, 0) > 80 THEN 25 ELSE COALESCE(ua.avg_occupancy_rate, 0) * 0.3125 END +\n            CASE WHEN COALESCE(cl.competitor_count, 0) < 3 THEN 25 ELSE GREATEST(25 - COALESCE(cl.competitor_count, 0) * 2, 0) END +\n            CASE WHEN fbd.accepts_reservations THEN 20 ELSE 0 END\n        ) AS competitive_advantage_score\n    FROM facility_base_data fbd\n    LEFT JOIN utilization_aggregations ua ON fbd.facility_id = ua.facility_id\n    LEFT JOIN pricing_analysis pa ON fbd.facility_id = pa.facility_id\n    LEFT JOIN competitive_landscape cl ON fbd.facility_id = cl.facility_id\n),\nranked_analysis AS (\n    SELECT\n        mi.*,\n        ROW_NUMBER() OVER (PARTITION BY mi.city_id ORDER BY mi.market_opportunity_score DESC) AS city_rank,\n        ROW_NUMBER() OVER (ORDER BY mi.total_revenue DESC) AS revenue_rank,\n        ROW_NUMBER() OVER (ORDER BY mi.competitive_advantage_score DESC) AS competitive_rank,\n        PERCENT_RANK() OVER (ORDER BY mi.market_opportunity_score) AS opportunity_percentile,\n        PERCENT_RANK() OVER (ORDER BY mi.total_revenue) AS revenue_percentile,\n        PERCENT_RANK() OVER (ORDER BY mi.competitive_advantage_score) AS competitive_percentile,\n        LAG(mi.market_opportunity_score) OVER (ORDER BY mi.market_opportunity_score DESC) AS prev_opportunity_score,\n        LEAD(mi.market_opportunity_score) OVER (ORDER BY mi.market_opportunity_score DESC) AS next_opportunity_score,\n        AVG(mi.market_opportunity_score) OVER (PARTITION BY mi.city_id) AS city_avg_opportunity_score,\n        STDDEV(mi.market_opportunity_score) OVER (PARTITION BY mi.city_id) AS city_stddev_opportunity_score,\n        AVG(mi.total_revenue) OVER (PARTITION BY mi.city_id) AS city_avg_revenue,\n        AVG(mi.avg_occupancy_rate) OVER (PARTITION BY mi.city_id) AS city_avg_occupancy_rate\n    FROM market_intelligence mi\n),\noptimization_recommendations AS (\n    SELECT\n        ra.*,\n        CASE\n            WHEN ra.market_opportunity_score >= ra.city_avg_opportunity_score + ra.city_stddev_opportunity_score THEN 'High Priority'\n            WHEN ra.market_opportunity_score >= ra.city_avg_opportunity_score THEN 'Medium Priority'\n            ELSE 'Low Priority'\n        END AS optimization_priority,\n        CASE\n            WHEN ra.avg_occupancy_rate > 85 AND ra.avg_hourly_rate < ra.avg_competitor_rate THEN\n                ra.avg_hourly_rate * 1.15  -- Increase price if high demand and underpriced\n            WHEN ra.avg_occupancy_rate < 50 AND ra.avg_hourly_rate > ra.avg_competitor_rate THEN\n                ra.avg_hourly_rate * 0.90  -- Decrease price if low demand and overpriced\n            WHEN ra.avg_hourly_rate < ra.median_competitor_rate * 0.9 THEN\n                ra.median_competitor_rate * 0.95  -- Price slightly below median if significantly underpriced\n            ELSE ra.avg_hourly_rate  -- Keep current price\n        END AS recommended_rate,\n        -- Revenue impact estimate\n        (\n            CASE\n                WHEN ra.avg_occupancy_rate > 85 AND ra.avg_hourly_rate < ra.avg_competitor_rate THEN\n                    ra.avg_hourly_rate * 1.15 * ra.total_spaces * ra.avg_occupancy_rate / 100.0 * ra.days_with_data\n                WHEN ra.avg_occupancy_rate < 50 AND ra.avg_hourly_rate > ra.avg_competitor_rate THEN\n                    ra.avg_hourly_rate * 0.90 * ra.total_spaces * ra.avg_occupancy_rate / 100.0 * ra.days_with_data\n                ELSE ra.total_revenue\n            END - ra.total_revenue\n        ) AS estimated_revenue_impact,\n        -- Market share estimate\n        CASE\n            WHEN ra.competitor_count > 0 AND ra.total_spaces > 0 THEN\n                (ra.total_spaces * ra.avg_occupancy_rate / 100.0) /\n                NULLIF(\n                    (ra.total_spaces * ra.avg_occupancy_rate / 100.0) +\n                    (ra.competitor_count * COALESCE(ra.avg_competitor_rate, 0) * 50),  -- Estimate competitor spaces\n                    1\n                ) * 100\n            ELSE 100.0\n        END AS estimated_market_share_pct\n    FROM ranked_analysis ra\n)\nSELECT\n    or_rec.facility_id,\n    or_rec.facility_name,\n    or_rec.city_name,\n    or_rec.state_code,\n    or_rec.msa_name,\n    or_rec.total_spaces,\n    or_rec.facility_type,\n    or_rec.operator_type,\n    or_rec.avg_occupancy_rate,\n    or_rec.median_occupancy_rate,\n    or_rec.p95_occupancy_rate,\n    or_rec.total_revenue,\n    or_rec.avg_hourly_rate AS current_rate,\n    or_rec.recommended_rate,\n    or_rec.competitor_count,\n    or_rec.avg_competitor_rate,\n    or_rec.median_competitor_rate,\n    or_rec.market_opportunity_score,\n    or_rec.competitive_advantage_score,\n    or_rec.opportunity_percentile,\n    or_rec.revenue_percentile,\n    or_rec.competitive_percentile,\n    or_rec.optimization_priority,\n    or_rec.estimated_revenue_impact,\n    or_rec.estimated_market_share_pct,\n    CASE\n        WHEN or_rec.estimated_revenue_impact > 1000 THEN 'High Impact'\n        WHEN or_rec.estimated_revenue_impact > 0 THEN 'Medium Impact'\n        ELSE 'Low Impact'\n    END AS impact_category\nFROM optimization_recommendations or_rec\nWHERE or_rec.competitor_count > 0 OR or_rec.total_revenue > 0\nORDER BY or_rec.market_opportunity_score DESC, or_rec.total_revenue DESC\nLIMIT 200;",
      "line_number": 2617
    },
    {
      "number": 15,
      "title": "Reservation vs Walk-in Analysis with Revenue Optimization and Capacity Planning",
      "description": "Compares reservation and walk-in patterns using CTEs for pattern analysis, revenue comparison, capacity optimization, and booking strategy recommendations.",
      "use_case": "Optimize reservation vs walk-in mix to maximize revenue and capacity utilization.",
      "business_value": "Reservation analysis report with revenue optimization and capacity planning recommendations.",
      "purpose": "Enables data-driven decision making through advanced analytics and business intelligence.",
      "complexity": "Pattern analysis CTEs (6+ levels), revenue comparison, capacity optimization, booking strategies",
      "expected_output": "Query results with analysis and recommendations.",
      "sql": "WITH facility_base_data AS (\n    SELECT\n        pf.facility_id,\n        pf.facility_name,\n        pf.city_id,\n        pf.total_spaces,\n        pf.facility_type,\n        pf.operator_type,\n        pf.latitude,\n        pf.longitude,\n        pf.is_event_parking,\n        pf.is_monthly_parking,\n        pf.accepts_reservations,\n        c.city_name,\n        c.state_code,\n        c.population,\n        c.population_density,\n        c.median_household_income,\n        c.employment_total,\n        ma.msa_name,\n        ma.gdp_billions,\n        ma.population_estimate AS msa_population\n    FROM parking_facilities pf\n    INNER JOIN cities c ON pf.city_id = c.city_id\n    INNER JOIN metropolitan_areas ma ON c.msa_id = ma.msa_id\n    WHERE pf.is_hourly_parking = TRUE\n),\nutilization_aggregations AS (\n    SELECT\n        pu.facility_id,\n        pu.utilization_date,\n        pu.utilization_hour,\n        AVG(pu.occupancy_rate) AS avg_occupancy_rate,\n        PERCENTILE_CONT(0.5) WITHIN GROUP (ORDER BY pu.occupancy_rate) AS median_occupancy_rate,\n        PERCENTILE_CONT(0.75) WITHIN GROUP (ORDER BY pu.occupancy_rate) AS p75_occupancy_rate,\n        PERCENTILE_CONT(0.95) WITHIN GROUP (ORDER BY pu.occupancy_rate) AS p95_occupancy_rate,\n        SUM(pu.revenue_generated) AS total_revenue,\n        AVG(pu.revenue_generated) AS avg_revenue_per_record,\n        COUNT(*) AS utilization_records,\n        COUNT(DISTINCT pu.utilization_date) AS days_with_data,\n        DATE_PART('dow', pu.utilization_date) AS day_of_week\n    FROM parking_utilization pu\n    WHERE pu.utilization_date >= CURRENT_DATE - INTERVAL '90 days'\n    GROUP BY pu.facility_id, pu.utilization_date, pu.utilization_hour, DATE_PART('dow', pu.utilization_date)\n),\npricing_analysis AS (\n    SELECT\n        pp.facility_id,\n        AVG(pp.base_rate_hourly) AS avg_hourly_rate,\n        AVG(pp.base_rate_daily) AS avg_daily_rate,\n        AVG(pp.base_rate_monthly) AS avg_monthly_rate,\n        MIN(pp.base_rate_hourly) AS min_hourly_rate,\n        MAX(pp.base_rate_hourly) AS max_hourly_rate,\n        PERCENTILE_CONT(0.5) WITHIN GROUP (ORDER BY pp.base_rate_hourly) AS median_hourly_rate,\n        PERCENTILE_CONT(0.75) WITHIN GROUP (ORDER BY pp.base_rate_hourly) AS p75_hourly_rate,\n        COUNT(*) AS pricing_records\n    FROM parking_pricing pp\n    WHERE pp.is_active = TRUE\n    AND pp.pricing_type IN ('Hourly', 'Daily', 'Monthly')\n    GROUP BY pp.facility_id\n),\ncompetitive_landscape AS (\n    SELECT\n        fbd1.facility_id,\n        fbd1.city_id,\n        COUNT(DISTINCT fbd2.facility_id) AS competitor_count,\n        AVG(fbd2.total_spaces) AS avg_competitor_spaces,\n        SUM(fbd2.total_spaces) AS total_competitor_spaces,\n        AVG(pa2.avg_hourly_rate) AS avg_competitor_rate,\n        MIN(pa2.avg_hourly_rate) AS min_competitor_rate,\n        MAX(pa2.avg_hourly_rate) AS max_competitor_rate,\n        PERCENTILE_CONT(0.5) WITHIN GROUP (ORDER BY pa2.avg_hourly_rate) AS median_competitor_rate,\n        AVG(\n            CASE\n                WHEN ST_Distance(\n                    ST_SetSRID(ST_MakePoint(fbd1.longitude, fbd1.latitude), 4326)::geography,\n                    ST_SetSRID(ST_MakePoint(fbd2.longitude, fbd2.latitude), 4326)::geography\n                ) < 500 THEN ST_Distance(\n                    ST_SetSRID(ST_MakePoint(fbd1.longitude, fbd1.latitude), 4326)::geography,\n                    ST_SetSRID(ST_MakePoint(fbd2.longitude, fbd2.latitude), 4326)::geography\n                )\n                ELSE NULL\n            END\n        ) AS avg_distance_to_competitors\n    FROM facility_base_data fbd1\n    LEFT JOIN facility_base_data fbd2 ON fbd1.city_id = fbd2.city_id\n        AND fbd2.facility_id != fbd1.facility_id\n        AND ST_Distance(\n            ST_SetSRID(ST_MakePoint(fbd1.longitude, fbd1.latitude), 4326)::geography,\n            ST_SetSRID(ST_MakePoint(fbd2.longitude, fbd2.latitude), 4326)::geography\n        ) < 1000\n    LEFT JOIN pricing_analysis pa2 ON fbd2.facility_id = pa2.facility_id\n    GROUP BY fbd1.facility_id, fbd1.city_id, fbd1.latitude, fbd1.longitude\n),\nmarket_intelligence AS (\n    SELECT\n        fbd.facility_id,\n        fbd.facility_name,\n        fbd.city_id,\n        fbd.city_name,\n        fbd.state_code,\n        fbd.msa_name,\n        fbd.total_spaces,\n        fbd.facility_type,\n        fbd.operator_type,\n        fbd.population,\n        fbd.population_density,\n        fbd.median_household_income,\n        fbd.msa_population,\n        COALESCE(ua.avg_occupancy_rate, 0) AS avg_occupancy_rate,\n        COALESCE(ua.median_occupancy_rate, 0) AS median_occupancy_rate,\n        COALESCE(ua.p95_occupancy_rate, 0) AS p95_occupancy_rate,\n        COALESCE(ua.total_revenue, 0) AS total_revenue,\n        COALESCE(ua.avg_revenue_per_record, 0) AS avg_revenue_per_record,\n        COALESCE(ua.days_with_data, 0) AS days_with_data,\n        COALESCE(pa.avg_hourly_rate, 0) AS avg_hourly_rate,\n        COALESCE(pa.median_hourly_rate, 0) AS median_hourly_rate,\n        COALESCE(pa.p75_hourly_rate, 0) AS p75_hourly_rate,\n        COALESCE(cl.competitor_count, 0) AS competitor_count,\n        COALESCE(cl.avg_competitor_rate, 0) AS avg_competitor_rate,\n        COALESCE(cl.median_competitor_rate, 0) AS median_competitor_rate,\n        COALESCE(cl.avg_distance_to_competitors, 0) AS avg_distance_to_competitors,\n        -- Market opportunity score\n        (\n            LEAST(fbd.population_density / 10000.0, 1.0) * 25 +\n            LEAST(COALESCE(ua.avg_occupancy_rate, 0) / 100.0, 1.0) * 25 +\n            LEAST(fbd.median_household_income / 100000.0, 1.0) * 20 +\n            LEAST(COALESCE(cl.competitor_count, 0) / 10.0, 1.0) * 15 +\n            LEAST(fbd.total_spaces / 500.0, 1.0) * 15\n        ) AS market_opportunity_score,\n        -- Competitive advantage score\n        (\n            CASE WHEN COALESCE(pa.avg_hourly_rate, 0) < COALESCE(cl.avg_competitor_rate, 999) THEN 30 ELSE 0 END +\n            CASE WHEN COALESCE(ua.avg_occupancy_rate, 0) > 80 THEN 25 ELSE COALESCE(ua.avg_occupancy_rate, 0) * 0.3125 END +\n            CASE WHEN COALESCE(cl.competitor_count, 0) < 3 THEN 25 ELSE GREATEST(25 - COALESCE(cl.competitor_count, 0) * 2, 0) END +\n            CASE WHEN fbd.accepts_reservations THEN 20 ELSE 0 END\n        ) AS competitive_advantage_score\n    FROM facility_base_data fbd\n    LEFT JOIN utilization_aggregations ua ON fbd.facility_id = ua.facility_id\n    LEFT JOIN pricing_analysis pa ON fbd.facility_id = pa.facility_id\n    LEFT JOIN competitive_landscape cl ON fbd.facility_id = cl.facility_id\n),\nranked_analysis AS (\n    SELECT\n        mi.*,\n        ROW_NUMBER() OVER (PARTITION BY mi.city_id ORDER BY mi.market_opportunity_score DESC) AS city_rank,\n        ROW_NUMBER() OVER (ORDER BY mi.total_revenue DESC) AS revenue_rank,\n        ROW_NUMBER() OVER (ORDER BY mi.competitive_advantage_score DESC) AS competitive_rank,\n        PERCENT_RANK() OVER (ORDER BY mi.market_opportunity_score) AS opportunity_percentile,\n        PERCENT_RANK() OVER (ORDER BY mi.total_revenue) AS revenue_percentile,\n        PERCENT_RANK() OVER (ORDER BY mi.competitive_advantage_score) AS competitive_percentile,\n        LAG(mi.market_opportunity_score) OVER (ORDER BY mi.market_opportunity_score DESC) AS prev_opportunity_score,\n        LEAD(mi.market_opportunity_score) OVER (ORDER BY mi.market_opportunity_score DESC) AS next_opportunity_score,\n        AVG(mi.market_opportunity_score) OVER (PARTITION BY mi.city_id) AS city_avg_opportunity_score,\n        STDDEV(mi.market_opportunity_score) OVER (PARTITION BY mi.city_id) AS city_stddev_opportunity_score,\n        AVG(mi.total_revenue) OVER (PARTITION BY mi.city_id) AS city_avg_revenue,\n        AVG(mi.avg_occupancy_rate) OVER (PARTITION BY mi.city_id) AS city_avg_occupancy_rate\n    FROM market_intelligence mi\n),\noptimization_recommendations AS (\n    SELECT\n        ra.*,\n        CASE\n            WHEN ra.market_opportunity_score >= ra.city_avg_opportunity_score + ra.city_stddev_opportunity_score THEN 'High Priority'\n            WHEN ra.market_opportunity_score >= ra.city_avg_opportunity_score THEN 'Medium Priority'\n            ELSE 'Low Priority'\n        END AS optimization_priority,\n        CASE\n            WHEN ra.avg_occupancy_rate > 85 AND ra.avg_hourly_rate < ra.avg_competitor_rate THEN\n                ra.avg_hourly_rate * 1.15  -- Increase price if high demand and underpriced\n            WHEN ra.avg_occupancy_rate < 50 AND ra.avg_hourly_rate > ra.avg_competitor_rate THEN\n                ra.avg_hourly_rate * 0.90  -- Decrease price if low demand and overpriced\n            WHEN ra.avg_hourly_rate < ra.median_competitor_rate * 0.9 THEN\n                ra.median_competitor_rate * 0.95  -- Price slightly below median if significantly underpriced\n            ELSE ra.avg_hourly_rate  -- Keep current price\n        END AS recommended_rate,\n        -- Revenue impact estimate\n        (\n            CASE\n                WHEN ra.avg_occupancy_rate > 85 AND ra.avg_hourly_rate < ra.avg_competitor_rate THEN\n                    ra.avg_hourly_rate * 1.15 * ra.total_spaces * ra.avg_occupancy_rate / 100.0 * ra.days_with_data\n                WHEN ra.avg_occupancy_rate < 50 AND ra.avg_hourly_rate > ra.avg_competitor_rate THEN\n                    ra.avg_hourly_rate * 0.90 * ra.total_spaces * ra.avg_occupancy_rate / 100.0 * ra.days_with_data\n                ELSE ra.total_revenue\n            END - ra.total_revenue\n        ) AS estimated_revenue_impact,\n        -- Market share estimate\n        CASE\n            WHEN ra.competitor_count > 0 AND ra.total_spaces > 0 THEN\n                (ra.total_spaces * ra.avg_occupancy_rate / 100.0) /\n                NULLIF(\n                    (ra.total_spaces * ra.avg_occupancy_rate / 100.0) +\n                    (ra.competitor_count * COALESCE(ra.avg_competitor_rate, 0) * 50),  -- Estimate competitor spaces\n                    1\n                ) * 100\n            ELSE 100.0\n        END AS estimated_market_share_pct\n    FROM ranked_analysis ra\n)\nSELECT\n    or_rec.facility_id,\n    or_rec.facility_name,\n    or_rec.city_name,\n    or_rec.state_code,\n    or_rec.msa_name,\n    or_rec.total_spaces,\n    or_rec.facility_type,\n    or_rec.operator_type,\n    or_rec.avg_occupancy_rate,\n    or_rec.median_occupancy_rate,\n    or_rec.p95_occupancy_rate,\n    or_rec.total_revenue,\n    or_rec.avg_hourly_rate AS current_rate,\n    or_rec.recommended_rate,\n    or_rec.competitor_count,\n    or_rec.avg_competitor_rate,\n    or_rec.median_competitor_rate,\n    or_rec.market_opportunity_score,\n    or_rec.competitive_advantage_score,\n    or_rec.opportunity_percentile,\n    or_rec.revenue_percentile,\n    or_rec.competitive_percentile,\n    or_rec.optimization_priority,\n    or_rec.estimated_revenue_impact,\n    or_rec.estimated_market_share_pct,\n    CASE\n        WHEN or_rec.estimated_revenue_impact > 1000 THEN 'High Impact'\n        WHEN or_rec.estimated_revenue_impact > 0 THEN 'Medium Impact'\n        ELSE 'Low Impact'\n    END AS impact_category\nFROM optimization_recommendations or_rec\nWHERE or_rec.competitor_count > 0 OR or_rec.total_revenue > 0\nORDER BY or_rec.market_opportunity_score DESC, or_rec.total_revenue DESC\nLIMIT 200;",
      "line_number": 2867
    },
    {
      "number": 16,
      "title": "Peak Hour Analysis with Dynamic Pricing Optimization and Capacity Management",
      "description": "Analyzes peak hour patterns using temporal CTEs, dynamic pricing models, capacity management algorithms, and revenue maximization strategies.",
      "use_case": "Implement dynamic pricing and capacity management for peak hours to maximize revenue.",
      "business_value": "Peak hour analysis report with dynamic pricing recommendations and capacity management strategies.",
      "purpose": "Enables data-driven decision making through advanced analytics and business intelligence.",
      "complexity": "Temporal CTEs (7+ levels), dynamic pricing models, capacity management, revenue optimization",
      "expected_output": "Query results with analysis and recommendations.",
      "sql": "WITH facility_base_data AS (\n    SELECT\n        pf.facility_id,\n        pf.facility_name,\n        pf.city_id,\n        pf.total_spaces,\n        pf.facility_type,\n        pf.operator_type,\n        pf.latitude,\n        pf.longitude,\n        pf.is_event_parking,\n        pf.is_monthly_parking,\n        pf.accepts_reservations,\n        c.city_name,\n        c.state_code,\n        c.population,\n        c.population_density,\n        c.median_household_income,\n        c.employment_total,\n        ma.msa_name,\n        ma.gdp_billions,\n        ma.population_estimate AS msa_population\n    FROM parking_facilities pf\n    INNER JOIN cities c ON pf.city_id = c.city_id\n    INNER JOIN metropolitan_areas ma ON c.msa_id = ma.msa_id\n    WHERE pf.is_hourly_parking = TRUE\n),\nutilization_aggregations AS (\n    SELECT\n        pu.facility_id,\n        pu.utilization_date,\n        pu.utilization_hour,\n        AVG(pu.occupancy_rate) AS avg_occupancy_rate,\n        PERCENTILE_CONT(0.5) WITHIN GROUP (ORDER BY pu.occupancy_rate) AS median_occupancy_rate,\n        PERCENTILE_CONT(0.75) WITHIN GROUP (ORDER BY pu.occupancy_rate) AS p75_occupancy_rate,\n        PERCENTILE_CONT(0.95) WITHIN GROUP (ORDER BY pu.occupancy_rate) AS p95_occupancy_rate,\n        SUM(pu.revenue_generated) AS total_revenue,\n        AVG(pu.revenue_generated) AS avg_revenue_per_record,\n        COUNT(*) AS utilization_records,\n        COUNT(DISTINCT pu.utilization_date) AS days_with_data,\n        DATE_PART('dow', pu.utilization_date) AS day_of_week\n    FROM parking_utilization pu\n    WHERE pu.utilization_date >= CURRENT_DATE - INTERVAL '90 days'\n    GROUP BY pu.facility_id, pu.utilization_date, pu.utilization_hour, DATE_PART('dow', pu.utilization_date)\n),\npricing_analysis AS (\n    SELECT\n        pp.facility_id,\n        AVG(pp.base_rate_hourly) AS avg_hourly_rate,\n        AVG(pp.base_rate_daily) AS avg_daily_rate,\n        AVG(pp.base_rate_monthly) AS avg_monthly_rate,\n        MIN(pp.base_rate_hourly) AS min_hourly_rate,\n        MAX(pp.base_rate_hourly) AS max_hourly_rate,\n        PERCENTILE_CONT(0.5) WITHIN GROUP (ORDER BY pp.base_rate_hourly) AS median_hourly_rate,\n        PERCENTILE_CONT(0.75) WITHIN GROUP (ORDER BY pp.base_rate_hourly) AS p75_hourly_rate,\n        COUNT(*) AS pricing_records\n    FROM parking_pricing pp\n    WHERE pp.is_active = TRUE\n    AND pp.pricing_type IN ('Hourly', 'Daily', 'Monthly')\n    GROUP BY pp.facility_id\n),\ncompetitive_landscape AS (\n    SELECT\n        fbd1.facility_id,\n        fbd1.city_id,\n        COUNT(DISTINCT fbd2.facility_id) AS competitor_count,\n        AVG(fbd2.total_spaces) AS avg_competitor_spaces,\n        SUM(fbd2.total_spaces) AS total_competitor_spaces,\n        AVG(pa2.avg_hourly_rate) AS avg_competitor_rate,\n        MIN(pa2.avg_hourly_rate) AS min_competitor_rate,\n        MAX(pa2.avg_hourly_rate) AS max_competitor_rate,\n        PERCENTILE_CONT(0.5) WITHIN GROUP (ORDER BY pa2.avg_hourly_rate) AS median_competitor_rate,\n        AVG(\n            CASE\n                WHEN ST_Distance(\n                    ST_SetSRID(ST_MakePoint(fbd1.longitude, fbd1.latitude), 4326)::geography,\n                    ST_SetSRID(ST_MakePoint(fbd2.longitude, fbd2.latitude), 4326)::geography\n                ) < 500 THEN ST_Distance(\n                    ST_SetSRID(ST_MakePoint(fbd1.longitude, fbd1.latitude), 4326)::geography,\n                    ST_SetSRID(ST_MakePoint(fbd2.longitude, fbd2.latitude), 4326)::geography\n                )\n                ELSE NULL\n            END\n        ) AS avg_distance_to_competitors\n    FROM facility_base_data fbd1\n    LEFT JOIN facility_base_data fbd2 ON fbd1.city_id = fbd2.city_id\n        AND fbd2.facility_id != fbd1.facility_id\n        AND ST_Distance(\n            ST_SetSRID(ST_MakePoint(fbd1.longitude, fbd1.latitude), 4326)::geography,\n            ST_SetSRID(ST_MakePoint(fbd2.longitude, fbd2.latitude), 4326)::geography\n        ) < 1000\n    LEFT JOIN pricing_analysis pa2 ON fbd2.facility_id = pa2.facility_id\n    GROUP BY fbd1.facility_id, fbd1.city_id, fbd1.latitude, fbd1.longitude\n),\nmarket_intelligence AS (\n    SELECT\n        fbd.facility_id,\n        fbd.facility_name,\n        fbd.city_id,\n        fbd.city_name,\n        fbd.state_code,\n        fbd.msa_name,\n        fbd.total_spaces,\n        fbd.facility_type,\n        fbd.operator_type,\n        fbd.population,\n        fbd.population_density,\n        fbd.median_household_income,\n        fbd.msa_population,\n        COALESCE(ua.avg_occupancy_rate, 0) AS avg_occupancy_rate,\n        COALESCE(ua.median_occupancy_rate, 0) AS median_occupancy_rate,\n        COALESCE(ua.p95_occupancy_rate, 0) AS p95_occupancy_rate,\n        COALESCE(ua.total_revenue, 0) AS total_revenue,\n        COALESCE(ua.avg_revenue_per_record, 0) AS avg_revenue_per_record,\n        COALESCE(ua.days_with_data, 0) AS days_with_data,\n        COALESCE(pa.avg_hourly_rate, 0) AS avg_hourly_rate,\n        COALESCE(pa.median_hourly_rate, 0) AS median_hourly_rate,\n        COALESCE(pa.p75_hourly_rate, 0) AS p75_hourly_rate,\n        COALESCE(cl.competitor_count, 0) AS competitor_count,\n        COALESCE(cl.avg_competitor_rate, 0) AS avg_competitor_rate,\n        COALESCE(cl.median_competitor_rate, 0) AS median_competitor_rate,\n        COALESCE(cl.avg_distance_to_competitors, 0) AS avg_distance_to_competitors,\n        -- Market opportunity score\n        (\n            LEAST(fbd.population_density / 10000.0, 1.0) * 25 +\n            LEAST(COALESCE(ua.avg_occupancy_rate, 0) / 100.0, 1.0) * 25 +\n            LEAST(fbd.median_household_income / 100000.0, 1.0) * 20 +\n            LEAST(COALESCE(cl.competitor_count, 0) / 10.0, 1.0) * 15 +\n            LEAST(fbd.total_spaces / 500.0, 1.0) * 15\n        ) AS market_opportunity_score,\n        -- Competitive advantage score\n        (\n            CASE WHEN COALESCE(pa.avg_hourly_rate, 0) < COALESCE(cl.avg_competitor_rate, 999) THEN 30 ELSE 0 END +\n            CASE WHEN COALESCE(ua.avg_occupancy_rate, 0) > 80 THEN 25 ELSE COALESCE(ua.avg_occupancy_rate, 0) * 0.3125 END +\n            CASE WHEN COALESCE(cl.competitor_count, 0) < 3 THEN 25 ELSE GREATEST(25 - COALESCE(cl.competitor_count, 0) * 2, 0) END +\n            CASE WHEN fbd.accepts_reservations THEN 20 ELSE 0 END\n        ) AS competitive_advantage_score\n    FROM facility_base_data fbd\n    LEFT JOIN utilization_aggregations ua ON fbd.facility_id = ua.facility_id\n    LEFT JOIN pricing_analysis pa ON fbd.facility_id = pa.facility_id\n    LEFT JOIN competitive_landscape cl ON fbd.facility_id = cl.facility_id\n),\nranked_analysis AS (\n    SELECT\n        mi.*,\n        ROW_NUMBER() OVER (PARTITION BY mi.city_id ORDER BY mi.market_opportunity_score DESC) AS city_rank,\n        ROW_NUMBER() OVER (ORDER BY mi.total_revenue DESC) AS revenue_rank,\n        ROW_NUMBER() OVER (ORDER BY mi.competitive_advantage_score DESC) AS competitive_rank,\n        PERCENT_RANK() OVER (ORDER BY mi.market_opportunity_score) AS opportunity_percentile,\n        PERCENT_RANK() OVER (ORDER BY mi.total_revenue) AS revenue_percentile,\n        PERCENT_RANK() OVER (ORDER BY mi.competitive_advantage_score) AS competitive_percentile,\n        LAG(mi.market_opportunity_score) OVER (ORDER BY mi.market_opportunity_score DESC) AS prev_opportunity_score,\n        LEAD(mi.market_opportunity_score) OVER (ORDER BY mi.market_opportunity_score DESC) AS next_opportunity_score,\n        AVG(mi.market_opportunity_score) OVER (PARTITION BY mi.city_id) AS city_avg_opportunity_score,\n        STDDEV(mi.market_opportunity_score) OVER (PARTITION BY mi.city_id) AS city_stddev_opportunity_score,\n        AVG(mi.total_revenue) OVER (PARTITION BY mi.city_id) AS city_avg_revenue,\n        AVG(mi.avg_occupancy_rate) OVER (PARTITION BY mi.city_id) AS city_avg_occupancy_rate\n    FROM market_intelligence mi\n),\noptimization_recommendations AS (\n    SELECT\n        ra.*,\n        CASE\n            WHEN ra.market_opportunity_score >= ra.city_avg_opportunity_score + ra.city_stddev_opportunity_score THEN 'High Priority'\n            WHEN ra.market_opportunity_score >= ra.city_avg_opportunity_score THEN 'Medium Priority'\n            ELSE 'Low Priority'\n        END AS optimization_priority,\n        CASE\n            WHEN ra.avg_occupancy_rate > 85 AND ra.avg_hourly_rate < ra.avg_competitor_rate THEN\n                ra.avg_hourly_rate * 1.15  -- Increase price if high demand and underpriced\n            WHEN ra.avg_occupancy_rate < 50 AND ra.avg_hourly_rate > ra.avg_competitor_rate THEN\n                ra.avg_hourly_rate * 0.90  -- Decrease price if low demand and overpriced\n            WHEN ra.avg_hourly_rate < ra.median_competitor_rate * 0.9 THEN\n                ra.median_competitor_rate * 0.95  -- Price slightly below median if significantly underpriced\n            ELSE ra.avg_hourly_rate  -- Keep current price\n        END AS recommended_rate,\n        -- Revenue impact estimate\n        (\n            CASE\n                WHEN ra.avg_occupancy_rate > 85 AND ra.avg_hourly_rate < ra.avg_competitor_rate THEN\n                    ra.avg_hourly_rate * 1.15 * ra.total_spaces * ra.avg_occupancy_rate / 100.0 * ra.days_with_data\n                WHEN ra.avg_occupancy_rate < 50 AND ra.avg_hourly_rate > ra.avg_competitor_rate THEN\n                    ra.avg_hourly_rate * 0.90 * ra.total_spaces * ra.avg_occupancy_rate / 100.0 * ra.days_with_data\n                ELSE ra.total_revenue\n            END - ra.total_revenue\n        ) AS estimated_revenue_impact,\n        -- Market share estimate\n        CASE\n            WHEN ra.competitor_count > 0 AND ra.total_spaces > 0 THEN\n                (ra.total_spaces * ra.avg_occupancy_rate / 100.0) /\n                NULLIF(\n                    (ra.total_spaces * ra.avg_occupancy_rate / 100.0) +\n                    (ra.competitor_count * COALESCE(ra.avg_competitor_rate, 0) * 50),  -- Estimate competitor spaces\n                    1\n                ) * 100\n            ELSE 100.0\n        END AS estimated_market_share_pct\n    FROM ranked_analysis ra\n)\nSELECT\n    or_rec.facility_id,\n    or_rec.facility_name,\n    or_rec.city_name,\n    or_rec.state_code,\n    or_rec.msa_name,\n    or_rec.total_spaces,\n    or_rec.facility_type,\n    or_rec.operator_type,\n    or_rec.avg_occupancy_rate,\n    or_rec.median_occupancy_rate,\n    or_rec.p95_occupancy_rate,\n    or_rec.total_revenue,\n    or_rec.avg_hourly_rate AS current_rate,\n    or_rec.recommended_rate,\n    or_rec.competitor_count,\n    or_rec.avg_competitor_rate,\n    or_rec.median_competitor_rate,\n    or_rec.market_opportunity_score,\n    or_rec.competitive_advantage_score,\n    or_rec.opportunity_percentile,\n    or_rec.revenue_percentile,\n    or_rec.competitive_percentile,\n    or_rec.optimization_priority,\n    or_rec.estimated_revenue_impact,\n    or_rec.estimated_market_share_pct,\n    CASE\n        WHEN or_rec.estimated_revenue_impact > 1000 THEN 'High Impact'\n        WHEN or_rec.estimated_revenue_impact > 0 THEN 'Medium Impact'\n        ELSE 'Low Impact'\n    END AS impact_category\nFROM optimization_recommendations or_rec\nWHERE or_rec.competitor_count > 0 OR or_rec.total_revenue > 0\nORDER BY or_rec.market_opportunity_score DESC, or_rec.total_revenue DESC\nLIMIT 200;",
      "line_number": 3117
    },
    {
      "number": 17,
      "title": "Weekend vs Weekday Pattern Analysis with Pricing Strategy Optimization",
      "description": "Compares weekend and weekday patterns using CTEs for pattern analysis, pricing strategy optimization, and revenue maximization.",
      "use_case": "Optimize pricing strategies for weekends vs weekdays to maximize revenue.",
      "business_value": "Weekend/weekday analysis report with pricing strategy recommendations.",
      "purpose": "Enables data-driven decision making through advanced analytics and business intelligence.",
      "complexity": "Pattern comparison CTEs (6+ levels), pricing optimization, revenue analysis",
      "expected_output": "Query results with analysis and recommendations.",
      "sql": "WITH facility_base_data AS (\n    SELECT\n        pf.facility_id,\n        pf.facility_name,\n        pf.city_id,\n        pf.total_spaces,\n        pf.facility_type,\n        pf.operator_type,\n        pf.latitude,\n        pf.longitude,\n        pf.is_event_parking,\n        pf.is_monthly_parking,\n        pf.accepts_reservations,\n        c.city_name,\n        c.state_code,\n        c.population,\n        c.population_density,\n        c.median_household_income,\n        c.employment_total,\n        ma.msa_name,\n        ma.gdp_billions,\n        ma.population_estimate AS msa_population\n    FROM parking_facilities pf\n    INNER JOIN cities c ON pf.city_id = c.city_id\n    INNER JOIN metropolitan_areas ma ON c.msa_id = ma.msa_id\n    WHERE pf.is_hourly_parking = TRUE\n),\nutilization_aggregations AS (\n    SELECT\n        pu.facility_id,\n        pu.utilization_date,\n        pu.utilization_hour,\n        AVG(pu.occupancy_rate) AS avg_occupancy_rate,\n        PERCENTILE_CONT(0.5) WITHIN GROUP (ORDER BY pu.occupancy_rate) AS median_occupancy_rate,\n        PERCENTILE_CONT(0.75) WITHIN GROUP (ORDER BY pu.occupancy_rate) AS p75_occupancy_rate,\n        PERCENTILE_CONT(0.95) WITHIN GROUP (ORDER BY pu.occupancy_rate) AS p95_occupancy_rate,\n        SUM(pu.revenue_generated) AS total_revenue,\n        AVG(pu.revenue_generated) AS avg_revenue_per_record,\n        COUNT(*) AS utilization_records,\n        COUNT(DISTINCT pu.utilization_date) AS days_with_data,\n        DATE_PART('dow', pu.utilization_date) AS day_of_week\n    FROM parking_utilization pu\n    WHERE pu.utilization_date >= CURRENT_DATE - INTERVAL '90 days'\n    GROUP BY pu.facility_id, pu.utilization_date, pu.utilization_hour, DATE_PART('dow', pu.utilization_date)\n),\npricing_analysis AS (\n    SELECT\n        pp.facility_id,\n        AVG(pp.base_rate_hourly) AS avg_hourly_rate,\n        AVG(pp.base_rate_daily) AS avg_daily_rate,\n        AVG(pp.base_rate_monthly) AS avg_monthly_rate,\n        MIN(pp.base_rate_hourly) AS min_hourly_rate,\n        MAX(pp.base_rate_hourly) AS max_hourly_rate,\n        PERCENTILE_CONT(0.5) WITHIN GROUP (ORDER BY pp.base_rate_hourly) AS median_hourly_rate,\n        PERCENTILE_CONT(0.75) WITHIN GROUP (ORDER BY pp.base_rate_hourly) AS p75_hourly_rate,\n        COUNT(*) AS pricing_records\n    FROM parking_pricing pp\n    WHERE pp.is_active = TRUE\n    AND pp.pricing_type IN ('Hourly', 'Daily', 'Monthly')\n    GROUP BY pp.facility_id\n),\ncompetitive_landscape AS (\n    SELECT\n        fbd1.facility_id,\n        fbd1.city_id,\n        COUNT(DISTINCT fbd2.facility_id) AS competitor_count,\n        AVG(fbd2.total_spaces) AS avg_competitor_spaces,\n        SUM(fbd2.total_spaces) AS total_competitor_spaces,\n        AVG(pa2.avg_hourly_rate) AS avg_competitor_rate,\n        MIN(pa2.avg_hourly_rate) AS min_competitor_rate,\n        MAX(pa2.avg_hourly_rate) AS max_competitor_rate,\n        PERCENTILE_CONT(0.5) WITHIN GROUP (ORDER BY pa2.avg_hourly_rate) AS median_competitor_rate,\n        AVG(\n            CASE\n                WHEN ST_Distance(\n                    ST_SetSRID(ST_MakePoint(fbd1.longitude, fbd1.latitude), 4326)::geography,\n                    ST_SetSRID(ST_MakePoint(fbd2.longitude, fbd2.latitude), 4326)::geography\n                ) < 500 THEN ST_Distance(\n                    ST_SetSRID(ST_MakePoint(fbd1.longitude, fbd1.latitude), 4326)::geography,\n                    ST_SetSRID(ST_MakePoint(fbd2.longitude, fbd2.latitude), 4326)::geography\n                )\n                ELSE NULL\n            END\n        ) AS avg_distance_to_competitors\n    FROM facility_base_data fbd1\n    LEFT JOIN facility_base_data fbd2 ON fbd1.city_id = fbd2.city_id\n        AND fbd2.facility_id != fbd1.facility_id\n        AND ST_Distance(\n            ST_SetSRID(ST_MakePoint(fbd1.longitude, fbd1.latitude), 4326)::geography,\n            ST_SetSRID(ST_MakePoint(fbd2.longitude, fbd2.latitude), 4326)::geography\n        ) < 1000\n    LEFT JOIN pricing_analysis pa2 ON fbd2.facility_id = pa2.facility_id\n    GROUP BY fbd1.facility_id, fbd1.city_id, fbd1.latitude, fbd1.longitude\n),\nmarket_intelligence AS (\n    SELECT\n        fbd.facility_id,\n        fbd.facility_name,\n        fbd.city_id,\n        fbd.city_name,\n        fbd.state_code,\n        fbd.msa_name,\n        fbd.total_spaces,\n        fbd.facility_type,\n        fbd.operator_type,\n        fbd.population,\n        fbd.population_density,\n        fbd.median_household_income,\n        fbd.msa_population,\n        COALESCE(ua.avg_occupancy_rate, 0) AS avg_occupancy_rate,\n        COALESCE(ua.median_occupancy_rate, 0) AS median_occupancy_rate,\n        COALESCE(ua.p95_occupancy_rate, 0) AS p95_occupancy_rate,\n        COALESCE(ua.total_revenue, 0) AS total_revenue,\n        COALESCE(ua.avg_revenue_per_record, 0) AS avg_revenue_per_record,\n        COALESCE(ua.days_with_data, 0) AS days_with_data,\n        COALESCE(pa.avg_hourly_rate, 0) AS avg_hourly_rate,\n        COALESCE(pa.median_hourly_rate, 0) AS median_hourly_rate,\n        COALESCE(pa.p75_hourly_rate, 0) AS p75_hourly_rate,\n        COALESCE(cl.competitor_count, 0) AS competitor_count,\n        COALESCE(cl.avg_competitor_rate, 0) AS avg_competitor_rate,\n        COALESCE(cl.median_competitor_rate, 0) AS median_competitor_rate,\n        COALESCE(cl.avg_distance_to_competitors, 0) AS avg_distance_to_competitors,\n        -- Market opportunity score\n        (\n            LEAST(fbd.population_density / 10000.0, 1.0) * 25 +\n            LEAST(COALESCE(ua.avg_occupancy_rate, 0) / 100.0, 1.0) * 25 +\n            LEAST(fbd.median_household_income / 100000.0, 1.0) * 20 +\n            LEAST(COALESCE(cl.competitor_count, 0) / 10.0, 1.0) * 15 +\n            LEAST(fbd.total_spaces / 500.0, 1.0) * 15\n        ) AS market_opportunity_score,\n        -- Competitive advantage score\n        (\n            CASE WHEN COALESCE(pa.avg_hourly_rate, 0) < COALESCE(cl.avg_competitor_rate, 999) THEN 30 ELSE 0 END +\n            CASE WHEN COALESCE(ua.avg_occupancy_rate, 0) > 80 THEN 25 ELSE COALESCE(ua.avg_occupancy_rate, 0) * 0.3125 END +\n            CASE WHEN COALESCE(cl.competitor_count, 0) < 3 THEN 25 ELSE GREATEST(25 - COALESCE(cl.competitor_count, 0) * 2, 0) END +\n            CASE WHEN fbd.accepts_reservations THEN 20 ELSE 0 END\n        ) AS competitive_advantage_score\n    FROM facility_base_data fbd\n    LEFT JOIN utilization_aggregations ua ON fbd.facility_id = ua.facility_id\n    LEFT JOIN pricing_analysis pa ON fbd.facility_id = pa.facility_id\n    LEFT JOIN competitive_landscape cl ON fbd.facility_id = cl.facility_id\n),\nranked_analysis AS (\n    SELECT\n        mi.*,\n        ROW_NUMBER() OVER (PARTITION BY mi.city_id ORDER BY mi.market_opportunity_score DESC) AS city_rank,\n        ROW_NUMBER() OVER (ORDER BY mi.total_revenue DESC) AS revenue_rank,\n        ROW_NUMBER() OVER (ORDER BY mi.competitive_advantage_score DESC) AS competitive_rank,\n        PERCENT_RANK() OVER (ORDER BY mi.market_opportunity_score) AS opportunity_percentile,\n        PERCENT_RANK() OVER (ORDER BY mi.total_revenue) AS revenue_percentile,\n        PERCENT_RANK() OVER (ORDER BY mi.competitive_advantage_score) AS competitive_percentile,\n        LAG(mi.market_opportunity_score) OVER (ORDER BY mi.market_opportunity_score DESC) AS prev_opportunity_score,\n        LEAD(mi.market_opportunity_score) OVER (ORDER BY mi.market_opportunity_score DESC) AS next_opportunity_score,\n        AVG(mi.market_opportunity_score) OVER (PARTITION BY mi.city_id) AS city_avg_opportunity_score,\n        STDDEV(mi.market_opportunity_score) OVER (PARTITION BY mi.city_id) AS city_stddev_opportunity_score,\n        AVG(mi.total_revenue) OVER (PARTITION BY mi.city_id) AS city_avg_revenue,\n        AVG(mi.avg_occupancy_rate) OVER (PARTITION BY mi.city_id) AS city_avg_occupancy_rate\n    FROM market_intelligence mi\n),\noptimization_recommendations AS (\n    SELECT\n        ra.*,\n        CASE\n            WHEN ra.market_opportunity_score >= ra.city_avg_opportunity_score + ra.city_stddev_opportunity_score THEN 'High Priority'\n            WHEN ra.market_opportunity_score >= ra.city_avg_opportunity_score THEN 'Medium Priority'\n            ELSE 'Low Priority'\n        END AS optimization_priority,\n        CASE\n            WHEN ra.avg_occupancy_rate > 85 AND ra.avg_hourly_rate < ra.avg_competitor_rate THEN\n                ra.avg_hourly_rate * 1.15  -- Increase price if high demand and underpriced\n            WHEN ra.avg_occupancy_rate < 50 AND ra.avg_hourly_rate > ra.avg_competitor_rate THEN\n                ra.avg_hourly_rate * 0.90  -- Decrease price if low demand and overpriced\n            WHEN ra.avg_hourly_rate < ra.median_competitor_rate * 0.9 THEN\n                ra.median_competitor_rate * 0.95  -- Price slightly below median if significantly underpriced\n            ELSE ra.avg_hourly_rate  -- Keep current price\n        END AS recommended_rate,\n        -- Revenue impact estimate\n        (\n            CASE\n                WHEN ra.avg_occupancy_rate > 85 AND ra.avg_hourly_rate < ra.avg_competitor_rate THEN\n                    ra.avg_hourly_rate * 1.15 * ra.total_spaces * ra.avg_occupancy_rate / 100.0 * ra.days_with_data\n                WHEN ra.avg_occupancy_rate < 50 AND ra.avg_hourly_rate > ra.avg_competitor_rate THEN\n                    ra.avg_hourly_rate * 0.90 * ra.total_spaces * ra.avg_occupancy_rate / 100.0 * ra.days_with_data\n                ELSE ra.total_revenue\n            END - ra.total_revenue\n        ) AS estimated_revenue_impact,\n        -- Market share estimate\n        CASE\n            WHEN ra.competitor_count > 0 AND ra.total_spaces > 0 THEN\n                (ra.total_spaces * ra.avg_occupancy_rate / 100.0) /\n                NULLIF(\n                    (ra.total_spaces * ra.avg_occupancy_rate / 100.0) +\n                    (ra.competitor_count * COALESCE(ra.avg_competitor_rate, 0) * 50),  -- Estimate competitor spaces\n                    1\n                ) * 100\n            ELSE 100.0\n        END AS estimated_market_share_pct\n    FROM ranked_analysis ra\n)\nSELECT\n    or_rec.facility_id,\n    or_rec.facility_name,\n    or_rec.city_name,\n    or_rec.state_code,\n    or_rec.msa_name,\n    or_rec.total_spaces,\n    or_rec.facility_type,\n    or_rec.operator_type,\n    or_rec.avg_occupancy_rate,\n    or_rec.median_occupancy_rate,\n    or_rec.p95_occupancy_rate,\n    or_rec.total_revenue,\n    or_rec.avg_hourly_rate AS current_rate,\n    or_rec.recommended_rate,\n    or_rec.competitor_count,\n    or_rec.avg_competitor_rate,\n    or_rec.median_competitor_rate,\n    or_rec.market_opportunity_score,\n    or_rec.competitive_advantage_score,\n    or_rec.opportunity_percentile,\n    or_rec.revenue_percentile,\n    or_rec.competitive_percentile,\n    or_rec.optimization_priority,\n    or_rec.estimated_revenue_impact,\n    or_rec.estimated_market_share_pct,\n    CASE\n        WHEN or_rec.estimated_revenue_impact > 1000 THEN 'High Impact'\n        WHEN or_rec.estimated_revenue_impact > 0 THEN 'Medium Impact'\n        ELSE 'Low Impact'\n    END AS impact_category\nFROM optimization_recommendations or_rec\nWHERE or_rec.competitor_count > 0 OR or_rec.total_revenue > 0\nORDER BY or_rec.market_opportunity_score DESC, or_rec.total_revenue DESC\nLIMIT 200;",
      "line_number": 3367
    },
    {
      "number": 18,
      "title": "Facility Type Optimization with Performance Benchmarking and Revenue Maximization",
      "description": "Analyzes facility types using CTEs for performance benchmarking, revenue comparison, optimization recommendations, and type-specific strategies.",
      "use_case": "Optimize facility type mix and strategies for different facility types.",
      "business_value": "Facility type analysis report with performance benchmarks and optimization recommendations.",
      "purpose": "Enables data-driven decision making through advanced analytics and business intelligence.",
      "complexity": "Benchmarking CTEs (6+ levels), performance comparison, optimization modeling",
      "expected_output": "Query results with analysis and recommendations.",
      "sql": "WITH facility_base_data AS (\n    SELECT\n        pf.facility_id,\n        pf.facility_name,\n        pf.city_id,\n        pf.total_spaces,\n        pf.facility_type,\n        pf.operator_type,\n        pf.latitude,\n        pf.longitude,\n        pf.is_event_parking,\n        pf.is_monthly_parking,\n        pf.accepts_reservations,\n        c.city_name,\n        c.state_code,\n        c.population,\n        c.population_density,\n        c.median_household_income,\n        c.employment_total,\n        ma.msa_name,\n        ma.gdp_billions,\n        ma.population_estimate AS msa_population\n    FROM parking_facilities pf\n    INNER JOIN cities c ON pf.city_id = c.city_id\n    INNER JOIN metropolitan_areas ma ON c.msa_id = ma.msa_id\n    WHERE pf.is_hourly_parking = TRUE\n),\nutilization_aggregations AS (\n    SELECT\n        pu.facility_id,\n        pu.utilization_date,\n        pu.utilization_hour,\n        AVG(pu.occupancy_rate) AS avg_occupancy_rate,\n        PERCENTILE_CONT(0.5) WITHIN GROUP (ORDER BY pu.occupancy_rate) AS median_occupancy_rate,\n        PERCENTILE_CONT(0.75) WITHIN GROUP (ORDER BY pu.occupancy_rate) AS p75_occupancy_rate,\n        PERCENTILE_CONT(0.95) WITHIN GROUP (ORDER BY pu.occupancy_rate) AS p95_occupancy_rate,\n        SUM(pu.revenue_generated) AS total_revenue,\n        AVG(pu.revenue_generated) AS avg_revenue_per_record,\n        COUNT(*) AS utilization_records,\n        COUNT(DISTINCT pu.utilization_date) AS days_with_data,\n        DATE_PART('dow', pu.utilization_date) AS day_of_week\n    FROM parking_utilization pu\n    WHERE pu.utilization_date >= CURRENT_DATE - INTERVAL '90 days'\n    GROUP BY pu.facility_id, pu.utilization_date, pu.utilization_hour, DATE_PART('dow', pu.utilization_date)\n),\npricing_analysis AS (\n    SELECT\n        pp.facility_id,\n        AVG(pp.base_rate_hourly) AS avg_hourly_rate,\n        AVG(pp.base_rate_daily) AS avg_daily_rate,\n        AVG(pp.base_rate_monthly) AS avg_monthly_rate,\n        MIN(pp.base_rate_hourly) AS min_hourly_rate,\n        MAX(pp.base_rate_hourly) AS max_hourly_rate,\n        PERCENTILE_CONT(0.5) WITHIN GROUP (ORDER BY pp.base_rate_hourly) AS median_hourly_rate,\n        PERCENTILE_CONT(0.75) WITHIN GROUP (ORDER BY pp.base_rate_hourly) AS p75_hourly_rate,\n        COUNT(*) AS pricing_records\n    FROM parking_pricing pp\n    WHERE pp.is_active = TRUE\n    AND pp.pricing_type IN ('Hourly', 'Daily', 'Monthly')\n    GROUP BY pp.facility_id\n),\ncompetitive_landscape AS (\n    SELECT\n        fbd1.facility_id,\n        fbd1.city_id,\n        COUNT(DISTINCT fbd2.facility_id) AS competitor_count,\n        AVG(fbd2.total_spaces) AS avg_competitor_spaces,\n        SUM(fbd2.total_spaces) AS total_competitor_spaces,\n        AVG(pa2.avg_hourly_rate) AS avg_competitor_rate,\n        MIN(pa2.avg_hourly_rate) AS min_competitor_rate,\n        MAX(pa2.avg_hourly_rate) AS max_competitor_rate,\n        PERCENTILE_CONT(0.5) WITHIN GROUP (ORDER BY pa2.avg_hourly_rate) AS median_competitor_rate,\n        AVG(\n            CASE\n                WHEN ST_Distance(\n                    ST_SetSRID(ST_MakePoint(fbd1.longitude, fbd1.latitude), 4326)::geography,\n                    ST_SetSRID(ST_MakePoint(fbd2.longitude, fbd2.latitude), 4326)::geography\n                ) < 500 THEN ST_Distance(\n                    ST_SetSRID(ST_MakePoint(fbd1.longitude, fbd1.latitude), 4326)::geography,\n                    ST_SetSRID(ST_MakePoint(fbd2.longitude, fbd2.latitude), 4326)::geography\n                )\n                ELSE NULL\n            END\n        ) AS avg_distance_to_competitors\n    FROM facility_base_data fbd1\n    LEFT JOIN facility_base_data fbd2 ON fbd1.city_id = fbd2.city_id\n        AND fbd2.facility_id != fbd1.facility_id\n        AND ST_Distance(\n            ST_SetSRID(ST_MakePoint(fbd1.longitude, fbd1.latitude), 4326)::geography,\n            ST_SetSRID(ST_MakePoint(fbd2.longitude, fbd2.latitude), 4326)::geography\n        ) < 1000\n    LEFT JOIN pricing_analysis pa2 ON fbd2.facility_id = pa2.facility_id\n    GROUP BY fbd1.facility_id, fbd1.city_id, fbd1.latitude, fbd1.longitude\n),\nmarket_intelligence AS (\n    SELECT\n        fbd.facility_id,\n        fbd.facility_name,\n        fbd.city_id,\n        fbd.city_name,\n        fbd.state_code,\n        fbd.msa_name,\n        fbd.total_spaces,\n        fbd.facility_type,\n        fbd.operator_type,\n        fbd.population,\n        fbd.population_density,\n        fbd.median_household_income,\n        fbd.msa_population,\n        COALESCE(ua.avg_occupancy_rate, 0) AS avg_occupancy_rate,\n        COALESCE(ua.median_occupancy_rate, 0) AS median_occupancy_rate,\n        COALESCE(ua.p95_occupancy_rate, 0) AS p95_occupancy_rate,\n        COALESCE(ua.total_revenue, 0) AS total_revenue,\n        COALESCE(ua.avg_revenue_per_record, 0) AS avg_revenue_per_record,\n        COALESCE(ua.days_with_data, 0) AS days_with_data,\n        COALESCE(pa.avg_hourly_rate, 0) AS avg_hourly_rate,\n        COALESCE(pa.median_hourly_rate, 0) AS median_hourly_rate,\n        COALESCE(pa.p75_hourly_rate, 0) AS p75_hourly_rate,\n        COALESCE(cl.competitor_count, 0) AS competitor_count,\n        COALESCE(cl.avg_competitor_rate, 0) AS avg_competitor_rate,\n        COALESCE(cl.median_competitor_rate, 0) AS median_competitor_rate,\n        COALESCE(cl.avg_distance_to_competitors, 0) AS avg_distance_to_competitors,\n        -- Market opportunity score\n        (\n            LEAST(fbd.population_density / 10000.0, 1.0) * 25 +\n            LEAST(COALESCE(ua.avg_occupancy_rate, 0) / 100.0, 1.0) * 25 +\n            LEAST(fbd.median_household_income / 100000.0, 1.0) * 20 +\n            LEAST(COALESCE(cl.competitor_count, 0) / 10.0, 1.0) * 15 +\n            LEAST(fbd.total_spaces / 500.0, 1.0) * 15\n        ) AS market_opportunity_score,\n        -- Competitive advantage score\n        (\n            CASE WHEN COALESCE(pa.avg_hourly_rate, 0) < COALESCE(cl.avg_competitor_rate, 999) THEN 30 ELSE 0 END +\n            CASE WHEN COALESCE(ua.avg_occupancy_rate, 0) > 80 THEN 25 ELSE COALESCE(ua.avg_occupancy_rate, 0) * 0.3125 END +\n            CASE WHEN COALESCE(cl.competitor_count, 0) < 3 THEN 25 ELSE GREATEST(25 - COALESCE(cl.competitor_count, 0) * 2, 0) END +\n            CASE WHEN fbd.accepts_reservations THEN 20 ELSE 0 END\n        ) AS competitive_advantage_score\n    FROM facility_base_data fbd\n    LEFT JOIN utilization_aggregations ua ON fbd.facility_id = ua.facility_id\n    LEFT JOIN pricing_analysis pa ON fbd.facility_id = pa.facility_id\n    LEFT JOIN competitive_landscape cl ON fbd.facility_id = cl.facility_id\n),\nranked_analysis AS (\n    SELECT\n        mi.*,\n        ROW_NUMBER() OVER (PARTITION BY mi.city_id ORDER BY mi.market_opportunity_score DESC) AS city_rank,\n        ROW_NUMBER() OVER (ORDER BY mi.total_revenue DESC) AS revenue_rank,\n        ROW_NUMBER() OVER (ORDER BY mi.competitive_advantage_score DESC) AS competitive_rank,\n        PERCENT_RANK() OVER (ORDER BY mi.market_opportunity_score) AS opportunity_percentile,\n        PERCENT_RANK() OVER (ORDER BY mi.total_revenue) AS revenue_percentile,\n        PERCENT_RANK() OVER (ORDER BY mi.competitive_advantage_score) AS competitive_percentile,\n        LAG(mi.market_opportunity_score) OVER (ORDER BY mi.market_opportunity_score DESC) AS prev_opportunity_score,\n        LEAD(mi.market_opportunity_score) OVER (ORDER BY mi.market_opportunity_score DESC) AS next_opportunity_score,\n        AVG(mi.market_opportunity_score) OVER (PARTITION BY mi.city_id) AS city_avg_opportunity_score,\n        STDDEV(mi.market_opportunity_score) OVER (PARTITION BY mi.city_id) AS city_stddev_opportunity_score,\n        AVG(mi.total_revenue) OVER (PARTITION BY mi.city_id) AS city_avg_revenue,\n        AVG(mi.avg_occupancy_rate) OVER (PARTITION BY mi.city_id) AS city_avg_occupancy_rate\n    FROM market_intelligence mi\n),\noptimization_recommendations AS (\n    SELECT\n        ra.*,\n        CASE\n            WHEN ra.market_opportunity_score >= ra.city_avg_opportunity_score + ra.city_stddev_opportunity_score THEN 'High Priority'\n            WHEN ra.market_opportunity_score >= ra.city_avg_opportunity_score THEN 'Medium Priority'\n            ELSE 'Low Priority'\n        END AS optimization_priority,\n        CASE\n            WHEN ra.avg_occupancy_rate > 85 AND ra.avg_hourly_rate < ra.avg_competitor_rate THEN\n                ra.avg_hourly_rate * 1.15  -- Increase price if high demand and underpriced\n            WHEN ra.avg_occupancy_rate < 50 AND ra.avg_hourly_rate > ra.avg_competitor_rate THEN\n                ra.avg_hourly_rate * 0.90  -- Decrease price if low demand and overpriced\n            WHEN ra.avg_hourly_rate < ra.median_competitor_rate * 0.9 THEN\n                ra.median_competitor_rate * 0.95  -- Price slightly below median if significantly underpriced\n            ELSE ra.avg_hourly_rate  -- Keep current price\n        END AS recommended_rate,\n        -- Revenue impact estimate\n        (\n            CASE\n                WHEN ra.avg_occupancy_rate > 85 AND ra.avg_hourly_rate < ra.avg_competitor_rate THEN\n                    ra.avg_hourly_rate * 1.15 * ra.total_spaces * ra.avg_occupancy_rate / 100.0 * ra.days_with_data\n                WHEN ra.avg_occupancy_rate < 50 AND ra.avg_hourly_rate > ra.avg_competitor_rate THEN\n                    ra.avg_hourly_rate * 0.90 * ra.total_spaces * ra.avg_occupancy_rate / 100.0 * ra.days_with_data\n                ELSE ra.total_revenue\n            END - ra.total_revenue\n        ) AS estimated_revenue_impact,\n        -- Market share estimate\n        CASE\n            WHEN ra.competitor_count > 0 AND ra.total_spaces > 0 THEN\n                (ra.total_spaces * ra.avg_occupancy_rate / 100.0) /\n                NULLIF(\n                    (ra.total_spaces * ra.avg_occupancy_rate / 100.0) +\n                    (ra.competitor_count * COALESCE(ra.avg_competitor_rate, 0) * 50),  -- Estimate competitor spaces\n                    1\n                ) * 100\n            ELSE 100.0\n        END AS estimated_market_share_pct\n    FROM ranked_analysis ra\n)\nSELECT\n    or_rec.facility_id,\n    or_rec.facility_name,\n    or_rec.city_name,\n    or_rec.state_code,\n    or_rec.msa_name,\n    or_rec.total_spaces,\n    or_rec.facility_type,\n    or_rec.operator_type,\n    or_rec.avg_occupancy_rate,\n    or_rec.median_occupancy_rate,\n    or_rec.p95_occupancy_rate,\n    or_rec.total_revenue,\n    or_rec.avg_hourly_rate AS current_rate,\n    or_rec.recommended_rate,\n    or_rec.competitor_count,\n    or_rec.avg_competitor_rate,\n    or_rec.median_competitor_rate,\n    or_rec.market_opportunity_score,\n    or_rec.competitive_advantage_score,\n    or_rec.opportunity_percentile,\n    or_rec.revenue_percentile,\n    or_rec.competitive_percentile,\n    or_rec.optimization_priority,\n    or_rec.estimated_revenue_impact,\n    or_rec.estimated_market_share_pct,\n    CASE\n        WHEN or_rec.estimated_revenue_impact > 1000 THEN 'High Impact'\n        WHEN or_rec.estimated_revenue_impact > 0 THEN 'Medium Impact'\n        ELSE 'Low Impact'\n    END AS impact_category\nFROM optimization_recommendations or_rec\nWHERE or_rec.competitor_count > 0 OR or_rec.total_revenue > 0\nORDER BY or_rec.market_opportunity_score DESC, or_rec.total_revenue DESC\nLIMIT 200;",
      "line_number": 3617
    },
    {
      "number": 19,
      "title": "Operator Type Analysis with Market Share and Competitive Advantage Assessment",
      "description": "Analyzes operator types using CTEs for market share calculations, competitive advantage assessment, and operator-specific strategies.",
      "use_case": "Understand operator type dynamics and develop competitive strategies.",
      "business_value": "Operator type analysis report with market share and competitive advantage insights.",
      "purpose": "Enables data-driven decision making through advanced analytics and business intelligence.",
      "complexity": "Market analysis CTEs (6+ levels), competitive assessment, strategic analysis",
      "expected_output": "Query results with analysis and recommendations.",
      "sql": "WITH facility_base_data AS (\n    SELECT\n        pf.facility_id,\n        pf.facility_name,\n        pf.city_id,\n        pf.total_spaces,\n        pf.facility_type,\n        pf.operator_type,\n        pf.latitude,\n        pf.longitude,\n        pf.is_event_parking,\n        pf.is_monthly_parking,\n        pf.accepts_reservations,\n        c.city_name,\n        c.state_code,\n        c.population,\n        c.population_density,\n        c.median_household_income,\n        c.employment_total,\n        ma.msa_name,\n        ma.gdp_billions,\n        ma.population_estimate AS msa_population\n    FROM parking_facilities pf\n    INNER JOIN cities c ON pf.city_id = c.city_id\n    INNER JOIN metropolitan_areas ma ON c.msa_id = ma.msa_id\n    WHERE pf.is_hourly_parking = TRUE\n),\nutilization_aggregations AS (\n    SELECT\n        pu.facility_id,\n        pu.utilization_date,\n        pu.utilization_hour,\n        AVG(pu.occupancy_rate) AS avg_occupancy_rate,\n        PERCENTILE_CONT(0.5) WITHIN GROUP (ORDER BY pu.occupancy_rate) AS median_occupancy_rate,\n        PERCENTILE_CONT(0.75) WITHIN GROUP (ORDER BY pu.occupancy_rate) AS p75_occupancy_rate,\n        PERCENTILE_CONT(0.95) WITHIN GROUP (ORDER BY pu.occupancy_rate) AS p95_occupancy_rate,\n        SUM(pu.revenue_generated) AS total_revenue,\n        AVG(pu.revenue_generated) AS avg_revenue_per_record,\n        COUNT(*) AS utilization_records,\n        COUNT(DISTINCT pu.utilization_date) AS days_with_data,\n        DATE_PART('dow', pu.utilization_date) AS day_of_week\n    FROM parking_utilization pu\n    WHERE pu.utilization_date >= CURRENT_DATE - INTERVAL '90 days'\n    GROUP BY pu.facility_id, pu.utilization_date, pu.utilization_hour, DATE_PART('dow', pu.utilization_date)\n),\npricing_analysis AS (\n    SELECT\n        pp.facility_id,\n        AVG(pp.base_rate_hourly) AS avg_hourly_rate,\n        AVG(pp.base_rate_daily) AS avg_daily_rate,\n        AVG(pp.base_rate_monthly) AS avg_monthly_rate,\n        MIN(pp.base_rate_hourly) AS min_hourly_rate,\n        MAX(pp.base_rate_hourly) AS max_hourly_rate,\n        PERCENTILE_CONT(0.5) WITHIN GROUP (ORDER BY pp.base_rate_hourly) AS median_hourly_rate,\n        PERCENTILE_CONT(0.75) WITHIN GROUP (ORDER BY pp.base_rate_hourly) AS p75_hourly_rate,\n        COUNT(*) AS pricing_records\n    FROM parking_pricing pp\n    WHERE pp.is_active = TRUE\n    AND pp.pricing_type IN ('Hourly', 'Daily', 'Monthly')\n    GROUP BY pp.facility_id\n),\ncompetitive_landscape AS (\n    SELECT\n        fbd1.facility_id,\n        fbd1.city_id,\n        COUNT(DISTINCT fbd2.facility_id) AS competitor_count,\n        AVG(fbd2.total_spaces) AS avg_competitor_spaces,\n        SUM(fbd2.total_spaces) AS total_competitor_spaces,\n        AVG(pa2.avg_hourly_rate) AS avg_competitor_rate,\n        MIN(pa2.avg_hourly_rate) AS min_competitor_rate,\n        MAX(pa2.avg_hourly_rate) AS max_competitor_rate,\n        PERCENTILE_CONT(0.5) WITHIN GROUP (ORDER BY pa2.avg_hourly_rate) AS median_competitor_rate,\n        AVG(\n            CASE\n                WHEN ST_Distance(\n                    ST_SetSRID(ST_MakePoint(fbd1.longitude, fbd1.latitude), 4326)::geography,\n                    ST_SetSRID(ST_MakePoint(fbd2.longitude, fbd2.latitude), 4326)::geography\n                ) < 500 THEN ST_Distance(\n                    ST_SetSRID(ST_MakePoint(fbd1.longitude, fbd1.latitude), 4326)::geography,\n                    ST_SetSRID(ST_MakePoint(fbd2.longitude, fbd2.latitude), 4326)::geography\n                )\n                ELSE NULL\n            END\n        ) AS avg_distance_to_competitors\n    FROM facility_base_data fbd1\n    LEFT JOIN facility_base_data fbd2 ON fbd1.city_id = fbd2.city_id\n        AND fbd2.facility_id != fbd1.facility_id\n        AND ST_Distance(\n            ST_SetSRID(ST_MakePoint(fbd1.longitude, fbd1.latitude), 4326)::geography,\n            ST_SetSRID(ST_MakePoint(fbd2.longitude, fbd2.latitude), 4326)::geography\n        ) < 1000\n    LEFT JOIN pricing_analysis pa2 ON fbd2.facility_id = pa2.facility_id\n    GROUP BY fbd1.facility_id, fbd1.city_id, fbd1.latitude, fbd1.longitude\n),\nmarket_intelligence AS (\n    SELECT\n        fbd.facility_id,\n        fbd.facility_name,\n        fbd.city_id,\n        fbd.city_name,\n        fbd.state_code,\n        fbd.msa_name,\n        fbd.total_spaces,\n        fbd.facility_type,\n        fbd.operator_type,\n        fbd.population,\n        fbd.population_density,\n        fbd.median_household_income,\n        fbd.msa_population,\n        COALESCE(ua.avg_occupancy_rate, 0) AS avg_occupancy_rate,\n        COALESCE(ua.median_occupancy_rate, 0) AS median_occupancy_rate,\n        COALESCE(ua.p95_occupancy_rate, 0) AS p95_occupancy_rate,\n        COALESCE(ua.total_revenue, 0) AS total_revenue,\n        COALESCE(ua.avg_revenue_per_record, 0) AS avg_revenue_per_record,\n        COALESCE(ua.days_with_data, 0) AS days_with_data,\n        COALESCE(pa.avg_hourly_rate, 0) AS avg_hourly_rate,\n        COALESCE(pa.median_hourly_rate, 0) AS median_hourly_rate,\n        COALESCE(pa.p75_hourly_rate, 0) AS p75_hourly_rate,\n        COALESCE(cl.competitor_count, 0) AS competitor_count,\n        COALESCE(cl.avg_competitor_rate, 0) AS avg_competitor_rate,\n        COALESCE(cl.median_competitor_rate, 0) AS median_competitor_rate,\n        COALESCE(cl.avg_distance_to_competitors, 0) AS avg_distance_to_competitors,\n        -- Market opportunity score\n        (\n            LEAST(fbd.population_density / 10000.0, 1.0) * 25 +\n            LEAST(COALESCE(ua.avg_occupancy_rate, 0) / 100.0, 1.0) * 25 +\n            LEAST(fbd.median_household_income / 100000.0, 1.0) * 20 +\n            LEAST(COALESCE(cl.competitor_count, 0) / 10.0, 1.0) * 15 +\n            LEAST(fbd.total_spaces / 500.0, 1.0) * 15\n        ) AS market_opportunity_score,\n        -- Competitive advantage score\n        (\n            CASE WHEN COALESCE(pa.avg_hourly_rate, 0) < COALESCE(cl.avg_competitor_rate, 999) THEN 30 ELSE 0 END +\n            CASE WHEN COALESCE(ua.avg_occupancy_rate, 0) > 80 THEN 25 ELSE COALESCE(ua.avg_occupancy_rate, 0) * 0.3125 END +\n            CASE WHEN COALESCE(cl.competitor_count, 0) < 3 THEN 25 ELSE GREATEST(25 - COALESCE(cl.competitor_count, 0) * 2, 0) END +\n            CASE WHEN fbd.accepts_reservations THEN 20 ELSE 0 END\n        ) AS competitive_advantage_score\n    FROM facility_base_data fbd\n    LEFT JOIN utilization_aggregations ua ON fbd.facility_id = ua.facility_id\n    LEFT JOIN pricing_analysis pa ON fbd.facility_id = pa.facility_id\n    LEFT JOIN competitive_landscape cl ON fbd.facility_id = cl.facility_id\n),\nranked_analysis AS (\n    SELECT\n        mi.*,\n        ROW_NUMBER() OVER (PARTITION BY mi.city_id ORDER BY mi.market_opportunity_score DESC) AS city_rank,\n        ROW_NUMBER() OVER (ORDER BY mi.total_revenue DESC) AS revenue_rank,\n        ROW_NUMBER() OVER (ORDER BY mi.competitive_advantage_score DESC) AS competitive_rank,\n        PERCENT_RANK() OVER (ORDER BY mi.market_opportunity_score) AS opportunity_percentile,\n        PERCENT_RANK() OVER (ORDER BY mi.total_revenue) AS revenue_percentile,\n        PERCENT_RANK() OVER (ORDER BY mi.competitive_advantage_score) AS competitive_percentile,\n        LAG(mi.market_opportunity_score) OVER (ORDER BY mi.market_opportunity_score DESC) AS prev_opportunity_score,\n        LEAD(mi.market_opportunity_score) OVER (ORDER BY mi.market_opportunity_score DESC) AS next_opportunity_score,\n        AVG(mi.market_opportunity_score) OVER (PARTITION BY mi.city_id) AS city_avg_opportunity_score,\n        STDDEV(mi.market_opportunity_score) OVER (PARTITION BY mi.city_id) AS city_stddev_opportunity_score,\n        AVG(mi.total_revenue) OVER (PARTITION BY mi.city_id) AS city_avg_revenue,\n        AVG(mi.avg_occupancy_rate) OVER (PARTITION BY mi.city_id) AS city_avg_occupancy_rate\n    FROM market_intelligence mi\n),\noptimization_recommendations AS (\n    SELECT\n        ra.*,\n        CASE\n            WHEN ra.market_opportunity_score >= ra.city_avg_opportunity_score + ra.city_stddev_opportunity_score THEN 'High Priority'\n            WHEN ra.market_opportunity_score >= ra.city_avg_opportunity_score THEN 'Medium Priority'\n            ELSE 'Low Priority'\n        END AS optimization_priority,\n        CASE\n            WHEN ra.avg_occupancy_rate > 85 AND ra.avg_hourly_rate < ra.avg_competitor_rate THEN\n                ra.avg_hourly_rate * 1.15  -- Increase price if high demand and underpriced\n            WHEN ra.avg_occupancy_rate < 50 AND ra.avg_hourly_rate > ra.avg_competitor_rate THEN\n                ra.avg_hourly_rate * 0.90  -- Decrease price if low demand and overpriced\n            WHEN ra.avg_hourly_rate < ra.median_competitor_rate * 0.9 THEN\n                ra.median_competitor_rate * 0.95  -- Price slightly below median if significantly underpriced\n            ELSE ra.avg_hourly_rate  -- Keep current price\n        END AS recommended_rate,\n        -- Revenue impact estimate\n        (\n            CASE\n                WHEN ra.avg_occupancy_rate > 85 AND ra.avg_hourly_rate < ra.avg_competitor_rate THEN\n                    ra.avg_hourly_rate * 1.15 * ra.total_spaces * ra.avg_occupancy_rate / 100.0 * ra.days_with_data\n                WHEN ra.avg_occupancy_rate < 50 AND ra.avg_hourly_rate > ra.avg_competitor_rate THEN\n                    ra.avg_hourly_rate * 0.90 * ra.total_spaces * ra.avg_occupancy_rate / 100.0 * ra.days_with_data\n                ELSE ra.total_revenue\n            END - ra.total_revenue\n        ) AS estimated_revenue_impact,\n        -- Market share estimate\n        CASE\n            WHEN ra.competitor_count > 0 AND ra.total_spaces > 0 THEN\n                (ra.total_spaces * ra.avg_occupancy_rate / 100.0) /\n                NULLIF(\n                    (ra.total_spaces * ra.avg_occupancy_rate / 100.0) +\n                    (ra.competitor_count * COALESCE(ra.avg_competitor_rate, 0) * 50),  -- Estimate competitor spaces\n                    1\n                ) * 100\n            ELSE 100.0\n        END AS estimated_market_share_pct\n    FROM ranked_analysis ra\n)\nSELECT\n    or_rec.facility_id,\n    or_rec.facility_name,\n    or_rec.city_name,\n    or_rec.state_code,\n    or_rec.msa_name,\n    or_rec.total_spaces,\n    or_rec.facility_type,\n    or_rec.operator_type,\n    or_rec.avg_occupancy_rate,\n    or_rec.median_occupancy_rate,\n    or_rec.p95_occupancy_rate,\n    or_rec.total_revenue,\n    or_rec.avg_hourly_rate AS current_rate,\n    or_rec.recommended_rate,\n    or_rec.competitor_count,\n    or_rec.avg_competitor_rate,\n    or_rec.median_competitor_rate,\n    or_rec.market_opportunity_score,\n    or_rec.competitive_advantage_score,\n    or_rec.opportunity_percentile,\n    or_rec.revenue_percentile,\n    or_rec.competitive_percentile,\n    or_rec.optimization_priority,\n    or_rec.estimated_revenue_impact,\n    or_rec.estimated_market_share_pct,\n    CASE\n        WHEN or_rec.estimated_revenue_impact > 1000 THEN 'High Impact'\n        WHEN or_rec.estimated_revenue_impact > 0 THEN 'Medium Impact'\n        ELSE 'Low Impact'\n    END AS impact_category\nFROM optimization_recommendations or_rec\nWHERE or_rec.competitor_count > 0 OR or_rec.total_revenue > 0\nORDER BY or_rec.market_opportunity_score DESC, or_rec.total_revenue DESC\nLIMIT 200;",
      "line_number": 3867
    },
    {
      "number": 20,
      "title": "Multi-City Comparison Analysis with Performance Benchmarking and Best Practice Identification",
      "description": "Compares multiple cities using CTEs for performance benchmarking, best practice identification, and cross-city learning opportunities.",
      "use_case": "Identify best practices and performance benchmarks across cities.",
      "business_value": "Multi-city comparison report with benchmarks and best practices.",
      "purpose": "Enables data-driven decision making through advanced analytics and business intelligence.",
      "complexity": "Comparison CTEs (7+ levels), benchmarking, best practice analysis",
      "expected_output": "Query results with analysis and recommendations.",
      "sql": "WITH facility_base_data AS (\n    SELECT\n        pf.facility_id,\n        pf.facility_name,\n        pf.city_id,\n        pf.total_spaces,\n        pf.facility_type,\n        pf.operator_type,\n        pf.latitude,\n        pf.longitude,\n        pf.is_event_parking,\n        pf.is_monthly_parking,\n        pf.accepts_reservations,\n        c.city_name,\n        c.state_code,\n        c.population,\n        c.population_density,\n        c.median_household_income,\n        c.employment_total,\n        ma.msa_name,\n        ma.gdp_billions,\n        ma.population_estimate AS msa_population\n    FROM parking_facilities pf\n    INNER JOIN cities c ON pf.city_id = c.city_id\n    INNER JOIN metropolitan_areas ma ON c.msa_id = ma.msa_id\n    WHERE pf.is_hourly_parking = TRUE\n),\nutilization_aggregations AS (\n    SELECT\n        pu.facility_id,\n        pu.utilization_date,\n        pu.utilization_hour,\n        AVG(pu.occupancy_rate) AS avg_occupancy_rate,\n        PERCENTILE_CONT(0.5) WITHIN GROUP (ORDER BY pu.occupancy_rate) AS median_occupancy_rate,\n        PERCENTILE_CONT(0.75) WITHIN GROUP (ORDER BY pu.occupancy_rate) AS p75_occupancy_rate,\n        PERCENTILE_CONT(0.95) WITHIN GROUP (ORDER BY pu.occupancy_rate) AS p95_occupancy_rate,\n        SUM(pu.revenue_generated) AS total_revenue,\n        AVG(pu.revenue_generated) AS avg_revenue_per_record,\n        COUNT(*) AS utilization_records,\n        COUNT(DISTINCT pu.utilization_date) AS days_with_data,\n        DATE_PART('dow', pu.utilization_date) AS day_of_week\n    FROM parking_utilization pu\n    WHERE pu.utilization_date >= CURRENT_DATE - INTERVAL '90 days'\n    GROUP BY pu.facility_id, pu.utilization_date, pu.utilization_hour, DATE_PART('dow', pu.utilization_date)\n),\npricing_analysis AS (\n    SELECT\n        pp.facility_id,\n        AVG(pp.base_rate_hourly) AS avg_hourly_rate,\n        AVG(pp.base_rate_daily) AS avg_daily_rate,\n        AVG(pp.base_rate_monthly) AS avg_monthly_rate,\n        MIN(pp.base_rate_hourly) AS min_hourly_rate,\n        MAX(pp.base_rate_hourly) AS max_hourly_rate,\n        PERCENTILE_CONT(0.5) WITHIN GROUP (ORDER BY pp.base_rate_hourly) AS median_hourly_rate,\n        PERCENTILE_CONT(0.75) WITHIN GROUP (ORDER BY pp.base_rate_hourly) AS p75_hourly_rate,\n        COUNT(*) AS pricing_records\n    FROM parking_pricing pp\n    WHERE pp.is_active = TRUE\n    AND pp.pricing_type IN ('Hourly', 'Daily', 'Monthly')\n    GROUP BY pp.facility_id\n),\ncompetitive_landscape AS (\n    SELECT\n        fbd1.facility_id,\n        fbd1.city_id,\n        COUNT(DISTINCT fbd2.facility_id) AS competitor_count,\n        AVG(fbd2.total_spaces) AS avg_competitor_spaces,\n        SUM(fbd2.total_spaces) AS total_competitor_spaces,\n        AVG(pa2.avg_hourly_rate) AS avg_competitor_rate,\n        MIN(pa2.avg_hourly_rate) AS min_competitor_rate,\n        MAX(pa2.avg_hourly_rate) AS max_competitor_rate,\n        PERCENTILE_CONT(0.5) WITHIN GROUP (ORDER BY pa2.avg_hourly_rate) AS median_competitor_rate,\n        AVG(\n            CASE\n                WHEN ST_Distance(\n                    ST_SetSRID(ST_MakePoint(fbd1.longitude, fbd1.latitude), 4326)::geography,\n                    ST_SetSRID(ST_MakePoint(fbd2.longitude, fbd2.latitude), 4326)::geography\n                ) < 500 THEN ST_Distance(\n                    ST_SetSRID(ST_MakePoint(fbd1.longitude, fbd1.latitude), 4326)::geography,\n                    ST_SetSRID(ST_MakePoint(fbd2.longitude, fbd2.latitude), 4326)::geography\n                )\n                ELSE NULL\n            END\n        ) AS avg_distance_to_competitors\n    FROM facility_base_data fbd1\n    LEFT JOIN facility_base_data fbd2 ON fbd1.city_id = fbd2.city_id\n        AND fbd2.facility_id != fbd1.facility_id\n        AND ST_Distance(\n            ST_SetSRID(ST_MakePoint(fbd1.longitude, fbd1.latitude), 4326)::geography,\n            ST_SetSRID(ST_MakePoint(fbd2.longitude, fbd2.latitude), 4326)::geography\n        ) < 1000\n    LEFT JOIN pricing_analysis pa2 ON fbd2.facility_id = pa2.facility_id\n    GROUP BY fbd1.facility_id, fbd1.city_id, fbd1.latitude, fbd1.longitude\n),\nmarket_intelligence AS (\n    SELECT\n        fbd.facility_id,\n        fbd.facility_name,\n        fbd.city_id,\n        fbd.city_name,\n        fbd.state_code,\n        fbd.msa_name,\n        fbd.total_spaces,\n        fbd.facility_type,\n        fbd.operator_type,\n        fbd.population,\n        fbd.population_density,\n        fbd.median_household_income,\n        fbd.msa_population,\n        COALESCE(ua.avg_occupancy_rate, 0) AS avg_occupancy_rate,\n        COALESCE(ua.median_occupancy_rate, 0) AS median_occupancy_rate,\n        COALESCE(ua.p95_occupancy_rate, 0) AS p95_occupancy_rate,\n        COALESCE(ua.total_revenue, 0) AS total_revenue,\n        COALESCE(ua.avg_revenue_per_record, 0) AS avg_revenue_per_record,\n        COALESCE(ua.days_with_data, 0) AS days_with_data,\n        COALESCE(pa.avg_hourly_rate, 0) AS avg_hourly_rate,\n        COALESCE(pa.median_hourly_rate, 0) AS median_hourly_rate,\n        COALESCE(pa.p75_hourly_rate, 0) AS p75_hourly_rate,\n        COALESCE(cl.competitor_count, 0) AS competitor_count,\n        COALESCE(cl.avg_competitor_rate, 0) AS avg_competitor_rate,\n        COALESCE(cl.median_competitor_rate, 0) AS median_competitor_rate,\n        COALESCE(cl.avg_distance_to_competitors, 0) AS avg_distance_to_competitors,\n        -- Market opportunity score\n        (\n            LEAST(fbd.population_density / 10000.0, 1.0) * 25 +\n            LEAST(COALESCE(ua.avg_occupancy_rate, 0) / 100.0, 1.0) * 25 +\n            LEAST(fbd.median_household_income / 100000.0, 1.0) * 20 +\n            LEAST(COALESCE(cl.competitor_count, 0) / 10.0, 1.0) * 15 +\n            LEAST(fbd.total_spaces / 500.0, 1.0) * 15\n        ) AS market_opportunity_score,\n        -- Competitive advantage score\n        (\n            CASE WHEN COALESCE(pa.avg_hourly_rate, 0) < COALESCE(cl.avg_competitor_rate, 999) THEN 30 ELSE 0 END +\n            CASE WHEN COALESCE(ua.avg_occupancy_rate, 0) > 80 THEN 25 ELSE COALESCE(ua.avg_occupancy_rate, 0) * 0.3125 END +\n            CASE WHEN COALESCE(cl.competitor_count, 0) < 3 THEN 25 ELSE GREATEST(25 - COALESCE(cl.competitor_count, 0) * 2, 0) END +\n            CASE WHEN fbd.accepts_reservations THEN 20 ELSE 0 END\n        ) AS competitive_advantage_score\n    FROM facility_base_data fbd\n    LEFT JOIN utilization_aggregations ua ON fbd.facility_id = ua.facility_id\n    LEFT JOIN pricing_analysis pa ON fbd.facility_id = pa.facility_id\n    LEFT JOIN competitive_landscape cl ON fbd.facility_id = cl.facility_id\n),\nranked_analysis AS (\n    SELECT\n        mi.*,\n        ROW_NUMBER() OVER (PARTITION BY mi.city_id ORDER BY mi.market_opportunity_score DESC) AS city_rank,\n        ROW_NUMBER() OVER (ORDER BY mi.total_revenue DESC) AS revenue_rank,\n        ROW_NUMBER() OVER (ORDER BY mi.competitive_advantage_score DESC) AS competitive_rank,\n        PERCENT_RANK() OVER (ORDER BY mi.market_opportunity_score) AS opportunity_percentile,\n        PERCENT_RANK() OVER (ORDER BY mi.total_revenue) AS revenue_percentile,\n        PERCENT_RANK() OVER (ORDER BY mi.competitive_advantage_score) AS competitive_percentile,\n        LAG(mi.market_opportunity_score) OVER (ORDER BY mi.market_opportunity_score DESC) AS prev_opportunity_score,\n        LEAD(mi.market_opportunity_score) OVER (ORDER BY mi.market_opportunity_score DESC) AS next_opportunity_score,\n        AVG(mi.market_opportunity_score) OVER (PARTITION BY mi.city_id) AS city_avg_opportunity_score,\n        STDDEV(mi.market_opportunity_score) OVER (PARTITION BY mi.city_id) AS city_stddev_opportunity_score,\n        AVG(mi.total_revenue) OVER (PARTITION BY mi.city_id) AS city_avg_revenue,\n        AVG(mi.avg_occupancy_rate) OVER (PARTITION BY mi.city_id) AS city_avg_occupancy_rate\n    FROM market_intelligence mi\n),\noptimization_recommendations AS (\n    SELECT\n        ra.*,\n        CASE\n            WHEN ra.market_opportunity_score >= ra.city_avg_opportunity_score + ra.city_stddev_opportunity_score THEN 'High Priority'\n            WHEN ra.market_opportunity_score >= ra.city_avg_opportunity_score THEN 'Medium Priority'\n            ELSE 'Low Priority'\n        END AS optimization_priority,\n        CASE\n            WHEN ra.avg_occupancy_rate > 85 AND ra.avg_hourly_rate < ra.avg_competitor_rate THEN\n                ra.avg_hourly_rate * 1.15  -- Increase price if high demand and underpriced\n            WHEN ra.avg_occupancy_rate < 50 AND ra.avg_hourly_rate > ra.avg_competitor_rate THEN\n                ra.avg_hourly_rate * 0.90  -- Decrease price if low demand and overpriced\n            WHEN ra.avg_hourly_rate < ra.median_competitor_rate * 0.9 THEN\n                ra.median_competitor_rate * 0.95  -- Price slightly below median if significantly underpriced\n            ELSE ra.avg_hourly_rate  -- Keep current price\n        END AS recommended_rate,\n        -- Revenue impact estimate\n        (\n            CASE\n                WHEN ra.avg_occupancy_rate > 85 AND ra.avg_hourly_rate < ra.avg_competitor_rate THEN\n                    ra.avg_hourly_rate * 1.15 * ra.total_spaces * ra.avg_occupancy_rate / 100.0 * ra.days_with_data\n                WHEN ra.avg_occupancy_rate < 50 AND ra.avg_hourly_rate > ra.avg_competitor_rate THEN\n                    ra.avg_hourly_rate * 0.90 * ra.total_spaces * ra.avg_occupancy_rate / 100.0 * ra.days_with_data\n                ELSE ra.total_revenue\n            END - ra.total_revenue\n        ) AS estimated_revenue_impact,\n        -- Market share estimate\n        CASE\n            WHEN ra.competitor_count > 0 AND ra.total_spaces > 0 THEN\n                (ra.total_spaces * ra.avg_occupancy_rate / 100.0) /\n                NULLIF(\n                    (ra.total_spaces * ra.avg_occupancy_rate / 100.0) +\n                    (ra.competitor_count * COALESCE(ra.avg_competitor_rate, 0) * 50),  -- Estimate competitor spaces\n                    1\n                ) * 100\n            ELSE 100.0\n        END AS estimated_market_share_pct\n    FROM ranked_analysis ra\n)\nSELECT\n    or_rec.facility_id,\n    or_rec.facility_name,\n    or_rec.city_name,\n    or_rec.state_code,\n    or_rec.msa_name,\n    or_rec.total_spaces,\n    or_rec.facility_type,\n    or_rec.operator_type,\n    or_rec.avg_occupancy_rate,\n    or_rec.median_occupancy_rate,\n    or_rec.p95_occupancy_rate,\n    or_rec.total_revenue,\n    or_rec.avg_hourly_rate AS current_rate,\n    or_rec.recommended_rate,\n    or_rec.competitor_count,\n    or_rec.avg_competitor_rate,\n    or_rec.median_competitor_rate,\n    or_rec.market_opportunity_score,\n    or_rec.competitive_advantage_score,\n    or_rec.opportunity_percentile,\n    or_rec.revenue_percentile,\n    or_rec.competitive_percentile,\n    or_rec.optimization_priority,\n    or_rec.estimated_revenue_impact,\n    or_rec.estimated_market_share_pct,\n    CASE\n        WHEN or_rec.estimated_revenue_impact > 1000 THEN 'High Impact'\n        WHEN or_rec.estimated_revenue_impact > 0 THEN 'Medium Impact'\n        ELSE 'Low Impact'\n    END AS impact_category\nFROM optimization_recommendations or_rec\nWHERE or_rec.competitor_count > 0 OR or_rec.total_revenue > 0\nORDER BY or_rec.market_opportunity_score DESC, or_rec.total_revenue DESC\nLIMIT 200;",
      "line_number": 4117
    },
    {
      "number": 21,
      "title": "MSA-Level Aggregation Analysis with Regional Market Intelligence and Expansion Opportunities",
      "description": "Aggregates data at MSA level using CTEs for regional analysis, market intelligence, and expansion opportunity identification.",
      "use_case": "Analyze markets at metropolitan area level for regional expansion planning.",
      "business_value": "MSA-level intelligence report with regional insights and expansion opportunities.",
      "purpose": "Enables data-driven decision making through advanced analytics and business intelligence.",
      "complexity": "Aggregation CTEs (6+ levels), regional analysis, expansion planning",
      "expected_output": "Query results with analysis and recommendations.",
      "sql": "WITH facility_base_data AS (\n    SELECT\n        pf.facility_id,\n        pf.facility_name,\n        pf.city_id,\n        pf.total_spaces,\n        pf.facility_type,\n        pf.operator_type,\n        pf.latitude,\n        pf.longitude,\n        pf.is_event_parking,\n        pf.is_monthly_parking,\n        pf.accepts_reservations,\n        c.city_name,\n        c.state_code,\n        c.population,\n        c.population_density,\n        c.median_household_income,\n        c.employment_total,\n        ma.msa_name,\n        ma.gdp_billions,\n        ma.population_estimate AS msa_population\n    FROM parking_facilities pf\n    INNER JOIN cities c ON pf.city_id = c.city_id\n    INNER JOIN metropolitan_areas ma ON c.msa_id = ma.msa_id\n    WHERE pf.is_hourly_parking = TRUE\n),\nutilization_aggregations AS (\n    SELECT\n        pu.facility_id,\n        pu.utilization_date,\n        pu.utilization_hour,\n        AVG(pu.occupancy_rate) AS avg_occupancy_rate,\n        PERCENTILE_CONT(0.5) WITHIN GROUP (ORDER BY pu.occupancy_rate) AS median_occupancy_rate,\n        PERCENTILE_CONT(0.75) WITHIN GROUP (ORDER BY pu.occupancy_rate) AS p75_occupancy_rate,\n        PERCENTILE_CONT(0.95) WITHIN GROUP (ORDER BY pu.occupancy_rate) AS p95_occupancy_rate,\n        SUM(pu.revenue_generated) AS total_revenue,\n        AVG(pu.revenue_generated) AS avg_revenue_per_record,\n        COUNT(*) AS utilization_records,\n        COUNT(DISTINCT pu.utilization_date) AS days_with_data,\n        DATE_PART('dow', pu.utilization_date) AS day_of_week\n    FROM parking_utilization pu\n    WHERE pu.utilization_date >= CURRENT_DATE - INTERVAL '90 days'\n    GROUP BY pu.facility_id, pu.utilization_date, pu.utilization_hour, DATE_PART('dow', pu.utilization_date)\n),\npricing_analysis AS (\n    SELECT\n        pp.facility_id,\n        AVG(pp.base_rate_hourly) AS avg_hourly_rate,\n        AVG(pp.base_rate_daily) AS avg_daily_rate,\n        AVG(pp.base_rate_monthly) AS avg_monthly_rate,\n        MIN(pp.base_rate_hourly) AS min_hourly_rate,\n        MAX(pp.base_rate_hourly) AS max_hourly_rate,\n        PERCENTILE_CONT(0.5) WITHIN GROUP (ORDER BY pp.base_rate_hourly) AS median_hourly_rate,\n        PERCENTILE_CONT(0.75) WITHIN GROUP (ORDER BY pp.base_rate_hourly) AS p75_hourly_rate,\n        COUNT(*) AS pricing_records\n    FROM parking_pricing pp\n    WHERE pp.is_active = TRUE\n    AND pp.pricing_type IN ('Hourly', 'Daily', 'Monthly')\n    GROUP BY pp.facility_id\n),\ncompetitive_landscape AS (\n    SELECT\n        fbd1.facility_id,\n        fbd1.city_id,\n        COUNT(DISTINCT fbd2.facility_id) AS competitor_count,\n        AVG(fbd2.total_spaces) AS avg_competitor_spaces,\n        SUM(fbd2.total_spaces) AS total_competitor_spaces,\n        AVG(pa2.avg_hourly_rate) AS avg_competitor_rate,\n        MIN(pa2.avg_hourly_rate) AS min_competitor_rate,\n        MAX(pa2.avg_hourly_rate) AS max_competitor_rate,\n        PERCENTILE_CONT(0.5) WITHIN GROUP (ORDER BY pa2.avg_hourly_rate) AS median_competitor_rate,\n        AVG(\n            CASE\n                WHEN ST_Distance(\n                    ST_SetSRID(ST_MakePoint(fbd1.longitude, fbd1.latitude), 4326)::geography,\n                    ST_SetSRID(ST_MakePoint(fbd2.longitude, fbd2.latitude), 4326)::geography\n                ) < 500 THEN ST_Distance(\n                    ST_SetSRID(ST_MakePoint(fbd1.longitude, fbd1.latitude), 4326)::geography,\n                    ST_SetSRID(ST_MakePoint(fbd2.longitude, fbd2.latitude), 4326)::geography\n                )\n                ELSE NULL\n            END\n        ) AS avg_distance_to_competitors\n    FROM facility_base_data fbd1\n    LEFT JOIN facility_base_data fbd2 ON fbd1.city_id = fbd2.city_id\n        AND fbd2.facility_id != fbd1.facility_id\n        AND ST_Distance(\n            ST_SetSRID(ST_MakePoint(fbd1.longitude, fbd1.latitude), 4326)::geography,\n            ST_SetSRID(ST_MakePoint(fbd2.longitude, fbd2.latitude), 4326)::geography\n        ) < 1000\n    LEFT JOIN pricing_analysis pa2 ON fbd2.facility_id = pa2.facility_id\n    GROUP BY fbd1.facility_id, fbd1.city_id, fbd1.latitude, fbd1.longitude\n),\nmarket_intelligence AS (\n    SELECT\n        fbd.facility_id,\n        fbd.facility_name,\n        fbd.city_id,\n        fbd.city_name,\n        fbd.state_code,\n        fbd.msa_name,\n        fbd.total_spaces,\n        fbd.facility_type,\n        fbd.operator_type,\n        fbd.population,\n        fbd.population_density,\n        fbd.median_household_income,\n        fbd.msa_population,\n        COALESCE(ua.avg_occupancy_rate, 0) AS avg_occupancy_rate,\n        COALESCE(ua.median_occupancy_rate, 0) AS median_occupancy_rate,\n        COALESCE(ua.p95_occupancy_rate, 0) AS p95_occupancy_rate,\n        COALESCE(ua.total_revenue, 0) AS total_revenue,\n        COALESCE(ua.avg_revenue_per_record, 0) AS avg_revenue_per_record,\n        COALESCE(ua.days_with_data, 0) AS days_with_data,\n        COALESCE(pa.avg_hourly_rate, 0) AS avg_hourly_rate,\n        COALESCE(pa.median_hourly_rate, 0) AS median_hourly_rate,\n        COALESCE(pa.p75_hourly_rate, 0) AS p75_hourly_rate,\n        COALESCE(cl.competitor_count, 0) AS competitor_count,\n        COALESCE(cl.avg_competitor_rate, 0) AS avg_competitor_rate,\n        COALESCE(cl.median_competitor_rate, 0) AS median_competitor_rate,\n        COALESCE(cl.avg_distance_to_competitors, 0) AS avg_distance_to_competitors,\n        -- Market opportunity score\n        (\n            LEAST(fbd.population_density / 10000.0, 1.0) * 25 +\n            LEAST(COALESCE(ua.avg_occupancy_rate, 0) / 100.0, 1.0) * 25 +\n            LEAST(fbd.median_household_income / 100000.0, 1.0) * 20 +\n            LEAST(COALESCE(cl.competitor_count, 0) / 10.0, 1.0) * 15 +\n            LEAST(fbd.total_spaces / 500.0, 1.0) * 15\n        ) AS market_opportunity_score,\n        -- Competitive advantage score\n        (\n            CASE WHEN COALESCE(pa.avg_hourly_rate, 0) < COALESCE(cl.avg_competitor_rate, 999) THEN 30 ELSE 0 END +\n            CASE WHEN COALESCE(ua.avg_occupancy_rate, 0) > 80 THEN 25 ELSE COALESCE(ua.avg_occupancy_rate, 0) * 0.3125 END +\n            CASE WHEN COALESCE(cl.competitor_count, 0) < 3 THEN 25 ELSE GREATEST(25 - COALESCE(cl.competitor_count, 0) * 2, 0) END +\n            CASE WHEN fbd.accepts_reservations THEN 20 ELSE 0 END\n        ) AS competitive_advantage_score\n    FROM facility_base_data fbd\n    LEFT JOIN utilization_aggregations ua ON fbd.facility_id = ua.facility_id\n    LEFT JOIN pricing_analysis pa ON fbd.facility_id = pa.facility_id\n    LEFT JOIN competitive_landscape cl ON fbd.facility_id = cl.facility_id\n),\nranked_analysis AS (\n    SELECT\n        mi.*,\n        ROW_NUMBER() OVER (PARTITION BY mi.city_id ORDER BY mi.market_opportunity_score DESC) AS city_rank,\n        ROW_NUMBER() OVER (ORDER BY mi.total_revenue DESC) AS revenue_rank,\n        ROW_NUMBER() OVER (ORDER BY mi.competitive_advantage_score DESC) AS competitive_rank,\n        PERCENT_RANK() OVER (ORDER BY mi.market_opportunity_score) AS opportunity_percentile,\n        PERCENT_RANK() OVER (ORDER BY mi.total_revenue) AS revenue_percentile,\n        PERCENT_RANK() OVER (ORDER BY mi.competitive_advantage_score) AS competitive_percentile,\n        LAG(mi.market_opportunity_score) OVER (ORDER BY mi.market_opportunity_score DESC) AS prev_opportunity_score,\n        LEAD(mi.market_opportunity_score) OVER (ORDER BY mi.market_opportunity_score DESC) AS next_opportunity_score,\n        AVG(mi.market_opportunity_score) OVER (PARTITION BY mi.city_id) AS city_avg_opportunity_score,\n        STDDEV(mi.market_opportunity_score) OVER (PARTITION BY mi.city_id) AS city_stddev_opportunity_score,\n        AVG(mi.total_revenue) OVER (PARTITION BY mi.city_id) AS city_avg_revenue,\n        AVG(mi.avg_occupancy_rate) OVER (PARTITION BY mi.city_id) AS city_avg_occupancy_rate\n    FROM market_intelligence mi\n),\noptimization_recommendations AS (\n    SELECT\n        ra.*,\n        CASE\n            WHEN ra.market_opportunity_score >= ra.city_avg_opportunity_score + ra.city_stddev_opportunity_score THEN 'High Priority'\n            WHEN ra.market_opportunity_score >= ra.city_avg_opportunity_score THEN 'Medium Priority'\n            ELSE 'Low Priority'\n        END AS optimization_priority,\n        CASE\n            WHEN ra.avg_occupancy_rate > 85 AND ra.avg_hourly_rate < ra.avg_competitor_rate THEN\n                ra.avg_hourly_rate * 1.15  -- Increase price if high demand and underpriced\n            WHEN ra.avg_occupancy_rate < 50 AND ra.avg_hourly_rate > ra.avg_competitor_rate THEN\n                ra.avg_hourly_rate * 0.90  -- Decrease price if low demand and overpriced\n            WHEN ra.avg_hourly_rate < ra.median_competitor_rate * 0.9 THEN\n                ra.median_competitor_rate * 0.95  -- Price slightly below median if significantly underpriced\n            ELSE ra.avg_hourly_rate  -- Keep current price\n        END AS recommended_rate,\n        -- Revenue impact estimate\n        (\n            CASE\n                WHEN ra.avg_occupancy_rate > 85 AND ra.avg_hourly_rate < ra.avg_competitor_rate THEN\n                    ra.avg_hourly_rate * 1.15 * ra.total_spaces * ra.avg_occupancy_rate / 100.0 * ra.days_with_data\n                WHEN ra.avg_occupancy_rate < 50 AND ra.avg_hourly_rate > ra.avg_competitor_rate THEN\n                    ra.avg_hourly_rate * 0.90 * ra.total_spaces * ra.avg_occupancy_rate / 100.0 * ra.days_with_data\n                ELSE ra.total_revenue\n            END - ra.total_revenue\n        ) AS estimated_revenue_impact,\n        -- Market share estimate\n        CASE\n            WHEN ra.competitor_count > 0 AND ra.total_spaces > 0 THEN\n                (ra.total_spaces * ra.avg_occupancy_rate / 100.0) /\n                NULLIF(\n                    (ra.total_spaces * ra.avg_occupancy_rate / 100.0) +\n                    (ra.competitor_count * COALESCE(ra.avg_competitor_rate, 0) * 50),  -- Estimate competitor spaces\n                    1\n                ) * 100\n            ELSE 100.0\n        END AS estimated_market_share_pct\n    FROM ranked_analysis ra\n)\nSELECT\n    or_rec.facility_id,\n    or_rec.facility_name,\n    or_rec.city_name,\n    or_rec.state_code,\n    or_rec.msa_name,\n    or_rec.total_spaces,\n    or_rec.facility_type,\n    or_rec.operator_type,\n    or_rec.avg_occupancy_rate,\n    or_rec.median_occupancy_rate,\n    or_rec.p95_occupancy_rate,\n    or_rec.total_revenue,\n    or_rec.avg_hourly_rate AS current_rate,\n    or_rec.recommended_rate,\n    or_rec.competitor_count,\n    or_rec.avg_competitor_rate,\n    or_rec.median_competitor_rate,\n    or_rec.market_opportunity_score,\n    or_rec.competitive_advantage_score,\n    or_rec.opportunity_percentile,\n    or_rec.revenue_percentile,\n    or_rec.competitive_percentile,\n    or_rec.optimization_priority,\n    or_rec.estimated_revenue_impact,\n    or_rec.estimated_market_share_pct,\n    CASE\n        WHEN or_rec.estimated_revenue_impact > 1000 THEN 'High Impact'\n        WHEN or_rec.estimated_revenue_impact > 0 THEN 'Medium Impact'\n        ELSE 'Low Impact'\n    END AS impact_category\nFROM optimization_recommendations or_rec\nWHERE or_rec.competitor_count > 0 OR or_rec.total_revenue > 0\nORDER BY or_rec.market_opportunity_score DESC, or_rec.total_revenue DESC\nLIMIT 200;",
      "line_number": 4367
    },
    {
      "number": 22,
      "title": "Time-Series Forecasting with Seasonal Decomposition and Trend Analysis",
      "description": "Forecasts time-series patterns using CTEs for seasonal decomposition, trend analysis, and predictive modeling.",
      "use_case": "Forecast future trends and patterns for strategic planning.",
      "business_value": "Time-series forecast report with seasonal patterns and trend projections.",
      "purpose": "Enables data-driven decision making through advanced analytics and business intelligence.",
      "complexity": "Time-series CTEs (7+ levels), decomposition, trend analysis, forecasting",
      "expected_output": "Query results with analysis and recommendations.",
      "sql": "WITH facility_base_data AS (\n    SELECT\n        pf.facility_id,\n        pf.facility_name,\n        pf.city_id,\n        pf.total_spaces,\n        pf.facility_type,\n        pf.operator_type,\n        pf.latitude,\n        pf.longitude,\n        pf.is_event_parking,\n        pf.is_monthly_parking,\n        pf.accepts_reservations,\n        c.city_name,\n        c.state_code,\n        c.population,\n        c.population_density,\n        c.median_household_income,\n        c.employment_total,\n        ma.msa_name,\n        ma.gdp_billions,\n        ma.population_estimate AS msa_population\n    FROM parking_facilities pf\n    INNER JOIN cities c ON pf.city_id = c.city_id\n    INNER JOIN metropolitan_areas ma ON c.msa_id = ma.msa_id\n    WHERE pf.is_hourly_parking = TRUE\n),\nutilization_aggregations AS (\n    SELECT\n        pu.facility_id,\n        pu.utilization_date,\n        pu.utilization_hour,\n        AVG(pu.occupancy_rate) AS avg_occupancy_rate,\n        PERCENTILE_CONT(0.5) WITHIN GROUP (ORDER BY pu.occupancy_rate) AS median_occupancy_rate,\n        PERCENTILE_CONT(0.75) WITHIN GROUP (ORDER BY pu.occupancy_rate) AS p75_occupancy_rate,\n        PERCENTILE_CONT(0.95) WITHIN GROUP (ORDER BY pu.occupancy_rate) AS p95_occupancy_rate,\n        SUM(pu.revenue_generated) AS total_revenue,\n        AVG(pu.revenue_generated) AS avg_revenue_per_record,\n        COUNT(*) AS utilization_records,\n        COUNT(DISTINCT pu.utilization_date) AS days_with_data,\n        DATE_PART('dow', pu.utilization_date) AS day_of_week\n    FROM parking_utilization pu\n    WHERE pu.utilization_date >= CURRENT_DATE - INTERVAL '90 days'\n    GROUP BY pu.facility_id, pu.utilization_date, pu.utilization_hour, DATE_PART('dow', pu.utilization_date)\n),\npricing_analysis AS (\n    SELECT\n        pp.facility_id,\n        AVG(pp.base_rate_hourly) AS avg_hourly_rate,\n        AVG(pp.base_rate_daily) AS avg_daily_rate,\n        AVG(pp.base_rate_monthly) AS avg_monthly_rate,\n        MIN(pp.base_rate_hourly) AS min_hourly_rate,\n        MAX(pp.base_rate_hourly) AS max_hourly_rate,\n        PERCENTILE_CONT(0.5) WITHIN GROUP (ORDER BY pp.base_rate_hourly) AS median_hourly_rate,\n        PERCENTILE_CONT(0.75) WITHIN GROUP (ORDER BY pp.base_rate_hourly) AS p75_hourly_rate,\n        COUNT(*) AS pricing_records\n    FROM parking_pricing pp\n    WHERE pp.is_active = TRUE\n    AND pp.pricing_type IN ('Hourly', 'Daily', 'Monthly')\n    GROUP BY pp.facility_id\n),\ncompetitive_landscape AS (\n    SELECT\n        fbd1.facility_id,\n        fbd1.city_id,\n        COUNT(DISTINCT fbd2.facility_id) AS competitor_count,\n        AVG(fbd2.total_spaces) AS avg_competitor_spaces,\n        SUM(fbd2.total_spaces) AS total_competitor_spaces,\n        AVG(pa2.avg_hourly_rate) AS avg_competitor_rate,\n        MIN(pa2.avg_hourly_rate) AS min_competitor_rate,\n        MAX(pa2.avg_hourly_rate) AS max_competitor_rate,\n        PERCENTILE_CONT(0.5) WITHIN GROUP (ORDER BY pa2.avg_hourly_rate) AS median_competitor_rate,\n        AVG(\n            CASE\n                WHEN ST_Distance(\n                    ST_SetSRID(ST_MakePoint(fbd1.longitude, fbd1.latitude), 4326)::geography,\n                    ST_SetSRID(ST_MakePoint(fbd2.longitude, fbd2.latitude), 4326)::geography\n                ) < 500 THEN ST_Distance(\n                    ST_SetSRID(ST_MakePoint(fbd1.longitude, fbd1.latitude), 4326)::geography,\n                    ST_SetSRID(ST_MakePoint(fbd2.longitude, fbd2.latitude), 4326)::geography\n                )\n                ELSE NULL\n            END\n        ) AS avg_distance_to_competitors\n    FROM facility_base_data fbd1\n    LEFT JOIN facility_base_data fbd2 ON fbd1.city_id = fbd2.city_id\n        AND fbd2.facility_id != fbd1.facility_id\n        AND ST_Distance(\n            ST_SetSRID(ST_MakePoint(fbd1.longitude, fbd1.latitude), 4326)::geography,\n            ST_SetSRID(ST_MakePoint(fbd2.longitude, fbd2.latitude), 4326)::geography\n        ) < 1000\n    LEFT JOIN pricing_analysis pa2 ON fbd2.facility_id = pa2.facility_id\n    GROUP BY fbd1.facility_id, fbd1.city_id, fbd1.latitude, fbd1.longitude\n),\nmarket_intelligence AS (\n    SELECT\n        fbd.facility_id,\n        fbd.facility_name,\n        fbd.city_id,\n        fbd.city_name,\n        fbd.state_code,\n        fbd.msa_name,\n        fbd.total_spaces,\n        fbd.facility_type,\n        fbd.operator_type,\n        fbd.population,\n        fbd.population_density,\n        fbd.median_household_income,\n        fbd.msa_population,\n        COALESCE(ua.avg_occupancy_rate, 0) AS avg_occupancy_rate,\n        COALESCE(ua.median_occupancy_rate, 0) AS median_occupancy_rate,\n        COALESCE(ua.p95_occupancy_rate, 0) AS p95_occupancy_rate,\n        COALESCE(ua.total_revenue, 0) AS total_revenue,\n        COALESCE(ua.avg_revenue_per_record, 0) AS avg_revenue_per_record,\n        COALESCE(ua.days_with_data, 0) AS days_with_data,\n        COALESCE(pa.avg_hourly_rate, 0) AS avg_hourly_rate,\n        COALESCE(pa.median_hourly_rate, 0) AS median_hourly_rate,\n        COALESCE(pa.p75_hourly_rate, 0) AS p75_hourly_rate,\n        COALESCE(cl.competitor_count, 0) AS competitor_count,\n        COALESCE(cl.avg_competitor_rate, 0) AS avg_competitor_rate,\n        COALESCE(cl.median_competitor_rate, 0) AS median_competitor_rate,\n        COALESCE(cl.avg_distance_to_competitors, 0) AS avg_distance_to_competitors,\n        -- Market opportunity score\n        (\n            LEAST(fbd.population_density / 10000.0, 1.0) * 25 +\n            LEAST(COALESCE(ua.avg_occupancy_rate, 0) / 100.0, 1.0) * 25 +\n            LEAST(fbd.median_household_income / 100000.0, 1.0) * 20 +\n            LEAST(COALESCE(cl.competitor_count, 0) / 10.0, 1.0) * 15 +\n            LEAST(fbd.total_spaces / 500.0, 1.0) * 15\n        ) AS market_opportunity_score,\n        -- Competitive advantage score\n        (\n            CASE WHEN COALESCE(pa.avg_hourly_rate, 0) < COALESCE(cl.avg_competitor_rate, 999) THEN 30 ELSE 0 END +\n            CASE WHEN COALESCE(ua.avg_occupancy_rate, 0) > 80 THEN 25 ELSE COALESCE(ua.avg_occupancy_rate, 0) * 0.3125 END +\n            CASE WHEN COALESCE(cl.competitor_count, 0) < 3 THEN 25 ELSE GREATEST(25 - COALESCE(cl.competitor_count, 0) * 2, 0) END +\n            CASE WHEN fbd.accepts_reservations THEN 20 ELSE 0 END\n        ) AS competitive_advantage_score\n    FROM facility_base_data fbd\n    LEFT JOIN utilization_aggregations ua ON fbd.facility_id = ua.facility_id\n    LEFT JOIN pricing_analysis pa ON fbd.facility_id = pa.facility_id\n    LEFT JOIN competitive_landscape cl ON fbd.facility_id = cl.facility_id\n),\nranked_analysis AS (\n    SELECT\n        mi.*,\n        ROW_NUMBER() OVER (PARTITION BY mi.city_id ORDER BY mi.market_opportunity_score DESC) AS city_rank,\n        ROW_NUMBER() OVER (ORDER BY mi.total_revenue DESC) AS revenue_rank,\n        ROW_NUMBER() OVER (ORDER BY mi.competitive_advantage_score DESC) AS competitive_rank,\n        PERCENT_RANK() OVER (ORDER BY mi.market_opportunity_score) AS opportunity_percentile,\n        PERCENT_RANK() OVER (ORDER BY mi.total_revenue) AS revenue_percentile,\n        PERCENT_RANK() OVER (ORDER BY mi.competitive_advantage_score) AS competitive_percentile,\n        LAG(mi.market_opportunity_score) OVER (ORDER BY mi.market_opportunity_score DESC) AS prev_opportunity_score,\n        LEAD(mi.market_opportunity_score) OVER (ORDER BY mi.market_opportunity_score DESC) AS next_opportunity_score,\n        AVG(mi.market_opportunity_score) OVER (PARTITION BY mi.city_id) AS city_avg_opportunity_score,\n        STDDEV(mi.market_opportunity_score) OVER (PARTITION BY mi.city_id) AS city_stddev_opportunity_score,\n        AVG(mi.total_revenue) OVER (PARTITION BY mi.city_id) AS city_avg_revenue,\n        AVG(mi.avg_occupancy_rate) OVER (PARTITION BY mi.city_id) AS city_avg_occupancy_rate\n    FROM market_intelligence mi\n),\noptimization_recommendations AS (\n    SELECT\n        ra.*,\n        CASE\n            WHEN ra.market_opportunity_score >= ra.city_avg_opportunity_score + ra.city_stddev_opportunity_score THEN 'High Priority'\n            WHEN ra.market_opportunity_score >= ra.city_avg_opportunity_score THEN 'Medium Priority'\n            ELSE 'Low Priority'\n        END AS optimization_priority,\n        CASE\n            WHEN ra.avg_occupancy_rate > 85 AND ra.avg_hourly_rate < ra.avg_competitor_rate THEN\n                ra.avg_hourly_rate * 1.15  -- Increase price if high demand and underpriced\n            WHEN ra.avg_occupancy_rate < 50 AND ra.avg_hourly_rate > ra.avg_competitor_rate THEN\n                ra.avg_hourly_rate * 0.90  -- Decrease price if low demand and overpriced\n            WHEN ra.avg_hourly_rate < ra.median_competitor_rate * 0.9 THEN\n                ra.median_competitor_rate * 0.95  -- Price slightly below median if significantly underpriced\n            ELSE ra.avg_hourly_rate  -- Keep current price\n        END AS recommended_rate,\n        -- Revenue impact estimate\n        (\n            CASE\n                WHEN ra.avg_occupancy_rate > 85 AND ra.avg_hourly_rate < ra.avg_competitor_rate THEN\n                    ra.avg_hourly_rate * 1.15 * ra.total_spaces * ra.avg_occupancy_rate / 100.0 * ra.days_with_data\n                WHEN ra.avg_occupancy_rate < 50 AND ra.avg_hourly_rate > ra.avg_competitor_rate THEN\n                    ra.avg_hourly_rate * 0.90 * ra.total_spaces * ra.avg_occupancy_rate / 100.0 * ra.days_with_data\n                ELSE ra.total_revenue\n            END - ra.total_revenue\n        ) AS estimated_revenue_impact,\n        -- Market share estimate\n        CASE\n            WHEN ra.competitor_count > 0 AND ra.total_spaces > 0 THEN\n                (ra.total_spaces * ra.avg_occupancy_rate / 100.0) /\n                NULLIF(\n                    (ra.total_spaces * ra.avg_occupancy_rate / 100.0) +\n                    (ra.competitor_count * COALESCE(ra.avg_competitor_rate, 0) * 50),  -- Estimate competitor spaces\n                    1\n                ) * 100\n            ELSE 100.0\n        END AS estimated_market_share_pct\n    FROM ranked_analysis ra\n)\nSELECT\n    or_rec.facility_id,\n    or_rec.facility_name,\n    or_rec.city_name,\n    or_rec.state_code,\n    or_rec.msa_name,\n    or_rec.total_spaces,\n    or_rec.facility_type,\n    or_rec.operator_type,\n    or_rec.avg_occupancy_rate,\n    or_rec.median_occupancy_rate,\n    or_rec.p95_occupancy_rate,\n    or_rec.total_revenue,\n    or_rec.avg_hourly_rate AS current_rate,\n    or_rec.recommended_rate,\n    or_rec.competitor_count,\n    or_rec.avg_competitor_rate,\n    or_rec.median_competitor_rate,\n    or_rec.market_opportunity_score,\n    or_rec.competitive_advantage_score,\n    or_rec.opportunity_percentile,\n    or_rec.revenue_percentile,\n    or_rec.competitive_percentile,\n    or_rec.optimization_priority,\n    or_rec.estimated_revenue_impact,\n    or_rec.estimated_market_share_pct,\n    CASE\n        WHEN or_rec.estimated_revenue_impact > 1000 THEN 'High Impact'\n        WHEN or_rec.estimated_revenue_impact > 0 THEN 'Medium Impact'\n        ELSE 'Low Impact'\n    END AS impact_category\nFROM optimization_recommendations or_rec\nWHERE or_rec.competitor_count > 0 OR or_rec.total_revenue > 0\nORDER BY or_rec.market_opportunity_score DESC, or_rec.total_revenue DESC\nLIMIT 200;",
      "line_number": 4617
    },
    {
      "number": 23,
      "title": "Anomaly Detection Analysis with Statistical Methods and Alert Generation",
      "description": "Detects anomalies using CTEs with statistical methods, outlier identification, and alert generation for operational monitoring.",
      "use_case": "Identify anomalies and outliers for operational monitoring and alerting.",
      "business_value": "Anomaly detection report with statistical analysis and alert recommendations.",
      "purpose": "Enables data-driven decision making through advanced analytics and business intelligence.",
      "complexity": "Statistical CTEs (6+ levels), outlier detection, alert generation",
      "expected_output": "Query results with analysis and recommendations.",
      "sql": "WITH facility_base_data AS (\n    SELECT\n        pf.facility_id,\n        pf.facility_name,\n        pf.city_id,\n        pf.total_spaces,\n        pf.facility_type,\n        pf.operator_type,\n        pf.latitude,\n        pf.longitude,\n        pf.is_event_parking,\n        pf.is_monthly_parking,\n        pf.accepts_reservations,\n        c.city_name,\n        c.state_code,\n        c.population,\n        c.population_density,\n        c.median_household_income,\n        c.employment_total,\n        ma.msa_name,\n        ma.gdp_billions,\n        ma.population_estimate AS msa_population\n    FROM parking_facilities pf\n    INNER JOIN cities c ON pf.city_id = c.city_id\n    INNER JOIN metropolitan_areas ma ON c.msa_id = ma.msa_id\n    WHERE pf.is_hourly_parking = TRUE\n),\nutilization_aggregations AS (\n    SELECT\n        pu.facility_id,\n        pu.utilization_date,\n        pu.utilization_hour,\n        AVG(pu.occupancy_rate) AS avg_occupancy_rate,\n        PERCENTILE_CONT(0.5) WITHIN GROUP (ORDER BY pu.occupancy_rate) AS median_occupancy_rate,\n        PERCENTILE_CONT(0.75) WITHIN GROUP (ORDER BY pu.occupancy_rate) AS p75_occupancy_rate,\n        PERCENTILE_CONT(0.95) WITHIN GROUP (ORDER BY pu.occupancy_rate) AS p95_occupancy_rate,\n        SUM(pu.revenue_generated) AS total_revenue,\n        AVG(pu.revenue_generated) AS avg_revenue_per_record,\n        COUNT(*) AS utilization_records,\n        COUNT(DISTINCT pu.utilization_date) AS days_with_data,\n        DATE_PART('dow', pu.utilization_date) AS day_of_week\n    FROM parking_utilization pu\n    WHERE pu.utilization_date >= CURRENT_DATE - INTERVAL '90 days'\n    GROUP BY pu.facility_id, pu.utilization_date, pu.utilization_hour, DATE_PART('dow', pu.utilization_date)\n),\npricing_analysis AS (\n    SELECT\n        pp.facility_id,\n        AVG(pp.base_rate_hourly) AS avg_hourly_rate,\n        AVG(pp.base_rate_daily) AS avg_daily_rate,\n        AVG(pp.base_rate_monthly) AS avg_monthly_rate,\n        MIN(pp.base_rate_hourly) AS min_hourly_rate,\n        MAX(pp.base_rate_hourly) AS max_hourly_rate,\n        PERCENTILE_CONT(0.5) WITHIN GROUP (ORDER BY pp.base_rate_hourly) AS median_hourly_rate,\n        PERCENTILE_CONT(0.75) WITHIN GROUP (ORDER BY pp.base_rate_hourly) AS p75_hourly_rate,\n        COUNT(*) AS pricing_records\n    FROM parking_pricing pp\n    WHERE pp.is_active = TRUE\n    AND pp.pricing_type IN ('Hourly', 'Daily', 'Monthly')\n    GROUP BY pp.facility_id\n),\ncompetitive_landscape AS (\n    SELECT\n        fbd1.facility_id,\n        fbd1.city_id,\n        COUNT(DISTINCT fbd2.facility_id) AS competitor_count,\n        AVG(fbd2.total_spaces) AS avg_competitor_spaces,\n        SUM(fbd2.total_spaces) AS total_competitor_spaces,\n        AVG(pa2.avg_hourly_rate) AS avg_competitor_rate,\n        MIN(pa2.avg_hourly_rate) AS min_competitor_rate,\n        MAX(pa2.avg_hourly_rate) AS max_competitor_rate,\n        PERCENTILE_CONT(0.5) WITHIN GROUP (ORDER BY pa2.avg_hourly_rate) AS median_competitor_rate,\n        AVG(\n            CASE\n                WHEN ST_Distance(\n                    ST_SetSRID(ST_MakePoint(fbd1.longitude, fbd1.latitude), 4326)::geography,\n                    ST_SetSRID(ST_MakePoint(fbd2.longitude, fbd2.latitude), 4326)::geography\n                ) < 500 THEN ST_Distance(\n                    ST_SetSRID(ST_MakePoint(fbd1.longitude, fbd1.latitude), 4326)::geography,\n                    ST_SetSRID(ST_MakePoint(fbd2.longitude, fbd2.latitude), 4326)::geography\n                )\n                ELSE NULL\n            END\n        ) AS avg_distance_to_competitors\n    FROM facility_base_data fbd1\n    LEFT JOIN facility_base_data fbd2 ON fbd1.city_id = fbd2.city_id\n        AND fbd2.facility_id != fbd1.facility_id\n        AND ST_Distance(\n            ST_SetSRID(ST_MakePoint(fbd1.longitude, fbd1.latitude), 4326)::geography,\n            ST_SetSRID(ST_MakePoint(fbd2.longitude, fbd2.latitude), 4326)::geography\n        ) < 1000\n    LEFT JOIN pricing_analysis pa2 ON fbd2.facility_id = pa2.facility_id\n    GROUP BY fbd1.facility_id, fbd1.city_id, fbd1.latitude, fbd1.longitude\n),\nmarket_intelligence AS (\n    SELECT\n        fbd.facility_id,\n        fbd.facility_name,\n        fbd.city_id,\n        fbd.city_name,\n        fbd.state_code,\n        fbd.msa_name,\n        fbd.total_spaces,\n        fbd.facility_type,\n        fbd.operator_type,\n        fbd.population,\n        fbd.population_density,\n        fbd.median_household_income,\n        fbd.msa_population,\n        COALESCE(ua.avg_occupancy_rate, 0) AS avg_occupancy_rate,\n        COALESCE(ua.median_occupancy_rate, 0) AS median_occupancy_rate,\n        COALESCE(ua.p95_occupancy_rate, 0) AS p95_occupancy_rate,\n        COALESCE(ua.total_revenue, 0) AS total_revenue,\n        COALESCE(ua.avg_revenue_per_record, 0) AS avg_revenue_per_record,\n        COALESCE(ua.days_with_data, 0) AS days_with_data,\n        COALESCE(pa.avg_hourly_rate, 0) AS avg_hourly_rate,\n        COALESCE(pa.median_hourly_rate, 0) AS median_hourly_rate,\n        COALESCE(pa.p75_hourly_rate, 0) AS p75_hourly_rate,\n        COALESCE(cl.competitor_count, 0) AS competitor_count,\n        COALESCE(cl.avg_competitor_rate, 0) AS avg_competitor_rate,\n        COALESCE(cl.median_competitor_rate, 0) AS median_competitor_rate,\n        COALESCE(cl.avg_distance_to_competitors, 0) AS avg_distance_to_competitors,\n        -- Market opportunity score\n        (\n            LEAST(fbd.population_density / 10000.0, 1.0) * 25 +\n            LEAST(COALESCE(ua.avg_occupancy_rate, 0) / 100.0, 1.0) * 25 +\n            LEAST(fbd.median_household_income / 100000.0, 1.0) * 20 +\n            LEAST(COALESCE(cl.competitor_count, 0) / 10.0, 1.0) * 15 +\n            LEAST(fbd.total_spaces / 500.0, 1.0) * 15\n        ) AS market_opportunity_score,\n        -- Competitive advantage score\n        (\n            CASE WHEN COALESCE(pa.avg_hourly_rate, 0) < COALESCE(cl.avg_competitor_rate, 999) THEN 30 ELSE 0 END +\n            CASE WHEN COALESCE(ua.avg_occupancy_rate, 0) > 80 THEN 25 ELSE COALESCE(ua.avg_occupancy_rate, 0) * 0.3125 END +\n            CASE WHEN COALESCE(cl.competitor_count, 0) < 3 THEN 25 ELSE GREATEST(25 - COALESCE(cl.competitor_count, 0) * 2, 0) END +\n            CASE WHEN fbd.accepts_reservations THEN 20 ELSE 0 END\n        ) AS competitive_advantage_score\n    FROM facility_base_data fbd\n    LEFT JOIN utilization_aggregations ua ON fbd.facility_id = ua.facility_id\n    LEFT JOIN pricing_analysis pa ON fbd.facility_id = pa.facility_id\n    LEFT JOIN competitive_landscape cl ON fbd.facility_id = cl.facility_id\n),\nranked_analysis AS (\n    SELECT\n        mi.*,\n        ROW_NUMBER() OVER (PARTITION BY mi.city_id ORDER BY mi.market_opportunity_score DESC) AS city_rank,\n        ROW_NUMBER() OVER (ORDER BY mi.total_revenue DESC) AS revenue_rank,\n        ROW_NUMBER() OVER (ORDER BY mi.competitive_advantage_score DESC) AS competitive_rank,\n        PERCENT_RANK() OVER (ORDER BY mi.market_opportunity_score) AS opportunity_percentile,\n        PERCENT_RANK() OVER (ORDER BY mi.total_revenue) AS revenue_percentile,\n        PERCENT_RANK() OVER (ORDER BY mi.competitive_advantage_score) AS competitive_percentile,\n        LAG(mi.market_opportunity_score) OVER (ORDER BY mi.market_opportunity_score DESC) AS prev_opportunity_score,\n        LEAD(mi.market_opportunity_score) OVER (ORDER BY mi.market_opportunity_score DESC) AS next_opportunity_score,\n        AVG(mi.market_opportunity_score) OVER (PARTITION BY mi.city_id) AS city_avg_opportunity_score,\n        STDDEV(mi.market_opportunity_score) OVER (PARTITION BY mi.city_id) AS city_stddev_opportunity_score,\n        AVG(mi.total_revenue) OVER (PARTITION BY mi.city_id) AS city_avg_revenue,\n        AVG(mi.avg_occupancy_rate) OVER (PARTITION BY mi.city_id) AS city_avg_occupancy_rate\n    FROM market_intelligence mi\n),\noptimization_recommendations AS (\n    SELECT\n        ra.*,\n        CASE\n            WHEN ra.market_opportunity_score >= ra.city_avg_opportunity_score + ra.city_stddev_opportunity_score THEN 'High Priority'\n            WHEN ra.market_opportunity_score >= ra.city_avg_opportunity_score THEN 'Medium Priority'\n            ELSE 'Low Priority'\n        END AS optimization_priority,\n        CASE\n            WHEN ra.avg_occupancy_rate > 85 AND ra.avg_hourly_rate < ra.avg_competitor_rate THEN\n                ra.avg_hourly_rate * 1.15  -- Increase price if high demand and underpriced\n            WHEN ra.avg_occupancy_rate < 50 AND ra.avg_hourly_rate > ra.avg_competitor_rate THEN\n                ra.avg_hourly_rate * 0.90  -- Decrease price if low demand and overpriced\n            WHEN ra.avg_hourly_rate < ra.median_competitor_rate * 0.9 THEN\n                ra.median_competitor_rate * 0.95  -- Price slightly below median if significantly underpriced\n            ELSE ra.avg_hourly_rate  -- Keep current price\n        END AS recommended_rate,\n        -- Revenue impact estimate\n        (\n            CASE\n                WHEN ra.avg_occupancy_rate > 85 AND ra.avg_hourly_rate < ra.avg_competitor_rate THEN\n                    ra.avg_hourly_rate * 1.15 * ra.total_spaces * ra.avg_occupancy_rate / 100.0 * ra.days_with_data\n                WHEN ra.avg_occupancy_rate < 50 AND ra.avg_hourly_rate > ra.avg_competitor_rate THEN\n                    ra.avg_hourly_rate * 0.90 * ra.total_spaces * ra.avg_occupancy_rate / 100.0 * ra.days_with_data\n                ELSE ra.total_revenue\n            END - ra.total_revenue\n        ) AS estimated_revenue_impact,\n        -- Market share estimate\n        CASE\n            WHEN ra.competitor_count > 0 AND ra.total_spaces > 0 THEN\n                (ra.total_spaces * ra.avg_occupancy_rate / 100.0) /\n                NULLIF(\n                    (ra.total_spaces * ra.avg_occupancy_rate / 100.0) +\n                    (ra.competitor_count * COALESCE(ra.avg_competitor_rate, 0) * 50),  -- Estimate competitor spaces\n                    1\n                ) * 100\n            ELSE 100.0\n        END AS estimated_market_share_pct\n    FROM ranked_analysis ra\n)\nSELECT\n    or_rec.facility_id,\n    or_rec.facility_name,\n    or_rec.city_name,\n    or_rec.state_code,\n    or_rec.msa_name,\n    or_rec.total_spaces,\n    or_rec.facility_type,\n    or_rec.operator_type,\n    or_rec.avg_occupancy_rate,\n    or_rec.median_occupancy_rate,\n    or_rec.p95_occupancy_rate,\n    or_rec.total_revenue,\n    or_rec.avg_hourly_rate AS current_rate,\n    or_rec.recommended_rate,\n    or_rec.competitor_count,\n    or_rec.avg_competitor_rate,\n    or_rec.median_competitor_rate,\n    or_rec.market_opportunity_score,\n    or_rec.competitive_advantage_score,\n    or_rec.opportunity_percentile,\n    or_rec.revenue_percentile,\n    or_rec.competitive_percentile,\n    or_rec.optimization_priority,\n    or_rec.estimated_revenue_impact,\n    or_rec.estimated_market_share_pct,\n    CASE\n        WHEN or_rec.estimated_revenue_impact > 1000 THEN 'High Impact'\n        WHEN or_rec.estimated_revenue_impact > 0 THEN 'Medium Impact'\n        ELSE 'Low Impact'\n    END AS impact_category\nFROM optimization_recommendations or_rec\nWHERE or_rec.competitor_count > 0 OR or_rec.total_revenue > 0\nORDER BY or_rec.market_opportunity_score DESC, or_rec.total_revenue DESC\nLIMIT 200;",
      "line_number": 4867
    },
    {
      "number": 24,
      "title": "Customer Segmentation Analysis with Behavioral Patterns and Targeting Strategies",
      "description": "Segments customers using CTEs for behavioral analysis, pattern identification, and targeted marketing strategies.",
      "use_case": "Segment customers for targeted marketing and personalized strategies.",
      "business_value": "Customer segmentation report with behavioral insights and targeting strategies.",
      "purpose": "Enables data-driven decision making through advanced analytics and business intelligence.",
      "complexity": "Segmentation CTEs (7+ levels), behavioral analysis, targeting strategies",
      "expected_output": "Query results with analysis and recommendations.",
      "sql": "WITH facility_base_data AS (\n    SELECT\n        pf.facility_id,\n        pf.facility_name,\n        pf.city_id,\n        pf.total_spaces,\n        pf.facility_type,\n        pf.operator_type,\n        pf.latitude,\n        pf.longitude,\n        pf.is_event_parking,\n        pf.is_monthly_parking,\n        pf.accepts_reservations,\n        c.city_name,\n        c.state_code,\n        c.population,\n        c.population_density,\n        c.median_household_income,\n        c.employment_total,\n        ma.msa_name,\n        ma.gdp_billions,\n        ma.population_estimate AS msa_population\n    FROM parking_facilities pf\n    INNER JOIN cities c ON pf.city_id = c.city_id\n    INNER JOIN metropolitan_areas ma ON c.msa_id = ma.msa_id\n    WHERE pf.is_hourly_parking = TRUE\n),\nutilization_aggregations AS (\n    SELECT\n        pu.facility_id,\n        pu.utilization_date,\n        pu.utilization_hour,\n        AVG(pu.occupancy_rate) AS avg_occupancy_rate,\n        PERCENTILE_CONT(0.5) WITHIN GROUP (ORDER BY pu.occupancy_rate) AS median_occupancy_rate,\n        PERCENTILE_CONT(0.75) WITHIN GROUP (ORDER BY pu.occupancy_rate) AS p75_occupancy_rate,\n        PERCENTILE_CONT(0.95) WITHIN GROUP (ORDER BY pu.occupancy_rate) AS p95_occupancy_rate,\n        SUM(pu.revenue_generated) AS total_revenue,\n        AVG(pu.revenue_generated) AS avg_revenue_per_record,\n        COUNT(*) AS utilization_records,\n        COUNT(DISTINCT pu.utilization_date) AS days_with_data,\n        DATE_PART('dow', pu.utilization_date) AS day_of_week\n    FROM parking_utilization pu\n    WHERE pu.utilization_date >= CURRENT_DATE - INTERVAL '90 days'\n    GROUP BY pu.facility_id, pu.utilization_date, pu.utilization_hour, DATE_PART('dow', pu.utilization_date)\n),\npricing_analysis AS (\n    SELECT\n        pp.facility_id,\n        AVG(pp.base_rate_hourly) AS avg_hourly_rate,\n        AVG(pp.base_rate_daily) AS avg_daily_rate,\n        AVG(pp.base_rate_monthly) AS avg_monthly_rate,\n        MIN(pp.base_rate_hourly) AS min_hourly_rate,\n        MAX(pp.base_rate_hourly) AS max_hourly_rate,\n        PERCENTILE_CONT(0.5) WITHIN GROUP (ORDER BY pp.base_rate_hourly) AS median_hourly_rate,\n        PERCENTILE_CONT(0.75) WITHIN GROUP (ORDER BY pp.base_rate_hourly) AS p75_hourly_rate,\n        COUNT(*) AS pricing_records\n    FROM parking_pricing pp\n    WHERE pp.is_active = TRUE\n    AND pp.pricing_type IN ('Hourly', 'Daily', 'Monthly')\n    GROUP BY pp.facility_id\n),\ncompetitive_landscape AS (\n    SELECT\n        fbd1.facility_id,\n        fbd1.city_id,\n        COUNT(DISTINCT fbd2.facility_id) AS competitor_count,\n        AVG(fbd2.total_spaces) AS avg_competitor_spaces,\n        SUM(fbd2.total_spaces) AS total_competitor_spaces,\n        AVG(pa2.avg_hourly_rate) AS avg_competitor_rate,\n        MIN(pa2.avg_hourly_rate) AS min_competitor_rate,\n        MAX(pa2.avg_hourly_rate) AS max_competitor_rate,\n        PERCENTILE_CONT(0.5) WITHIN GROUP (ORDER BY pa2.avg_hourly_rate) AS median_competitor_rate,\n        AVG(\n            CASE\n                WHEN ST_Distance(\n                    ST_SetSRID(ST_MakePoint(fbd1.longitude, fbd1.latitude), 4326)::geography,\n                    ST_SetSRID(ST_MakePoint(fbd2.longitude, fbd2.latitude), 4326)::geography\n                ) < 500 THEN ST_Distance(\n                    ST_SetSRID(ST_MakePoint(fbd1.longitude, fbd1.latitude), 4326)::geography,\n                    ST_SetSRID(ST_MakePoint(fbd2.longitude, fbd2.latitude), 4326)::geography\n                )\n                ELSE NULL\n            END\n        ) AS avg_distance_to_competitors\n    FROM facility_base_data fbd1\n    LEFT JOIN facility_base_data fbd2 ON fbd1.city_id = fbd2.city_id\n        AND fbd2.facility_id != fbd1.facility_id\n        AND ST_Distance(\n            ST_SetSRID(ST_MakePoint(fbd1.longitude, fbd1.latitude), 4326)::geography,\n            ST_SetSRID(ST_MakePoint(fbd2.longitude, fbd2.latitude), 4326)::geography\n        ) < 1000\n    LEFT JOIN pricing_analysis pa2 ON fbd2.facility_id = pa2.facility_id\n    GROUP BY fbd1.facility_id, fbd1.city_id, fbd1.latitude, fbd1.longitude\n),\nmarket_intelligence AS (\n    SELECT\n        fbd.facility_id,\n        fbd.facility_name,\n        fbd.city_id,\n        fbd.city_name,\n        fbd.state_code,\n        fbd.msa_name,\n        fbd.total_spaces,\n        fbd.facility_type,\n        fbd.operator_type,\n        fbd.population,\n        fbd.population_density,\n        fbd.median_household_income,\n        fbd.msa_population,\n        COALESCE(ua.avg_occupancy_rate, 0) AS avg_occupancy_rate,\n        COALESCE(ua.median_occupancy_rate, 0) AS median_occupancy_rate,\n        COALESCE(ua.p95_occupancy_rate, 0) AS p95_occupancy_rate,\n        COALESCE(ua.total_revenue, 0) AS total_revenue,\n        COALESCE(ua.avg_revenue_per_record, 0) AS avg_revenue_per_record,\n        COALESCE(ua.days_with_data, 0) AS days_with_data,\n        COALESCE(pa.avg_hourly_rate, 0) AS avg_hourly_rate,\n        COALESCE(pa.median_hourly_rate, 0) AS median_hourly_rate,\n        COALESCE(pa.p75_hourly_rate, 0) AS p75_hourly_rate,\n        COALESCE(cl.competitor_count, 0) AS competitor_count,\n        COALESCE(cl.avg_competitor_rate, 0) AS avg_competitor_rate,\n        COALESCE(cl.median_competitor_rate, 0) AS median_competitor_rate,\n        COALESCE(cl.avg_distance_to_competitors, 0) AS avg_distance_to_competitors,\n        -- Market opportunity score\n        (\n            LEAST(fbd.population_density / 10000.0, 1.0) * 25 +\n            LEAST(COALESCE(ua.avg_occupancy_rate, 0) / 100.0, 1.0) * 25 +\n            LEAST(fbd.median_household_income / 100000.0, 1.0) * 20 +\n            LEAST(COALESCE(cl.competitor_count, 0) / 10.0, 1.0) * 15 +\n            LEAST(fbd.total_spaces / 500.0, 1.0) * 15\n        ) AS market_opportunity_score,\n        -- Competitive advantage score\n        (\n            CASE WHEN COALESCE(pa.avg_hourly_rate, 0) < COALESCE(cl.avg_competitor_rate, 999) THEN 30 ELSE 0 END +\n            CASE WHEN COALESCE(ua.avg_occupancy_rate, 0) > 80 THEN 25 ELSE COALESCE(ua.avg_occupancy_rate, 0) * 0.3125 END +\n            CASE WHEN COALESCE(cl.competitor_count, 0) < 3 THEN 25 ELSE GREATEST(25 - COALESCE(cl.competitor_count, 0) * 2, 0) END +\n            CASE WHEN fbd.accepts_reservations THEN 20 ELSE 0 END\n        ) AS competitive_advantage_score\n    FROM facility_base_data fbd\n    LEFT JOIN utilization_aggregations ua ON fbd.facility_id = ua.facility_id\n    LEFT JOIN pricing_analysis pa ON fbd.facility_id = pa.facility_id\n    LEFT JOIN competitive_landscape cl ON fbd.facility_id = cl.facility_id\n),\nranked_analysis AS (\n    SELECT\n        mi.*,\n        ROW_NUMBER() OVER (PARTITION BY mi.city_id ORDER BY mi.market_opportunity_score DESC) AS city_rank,\n        ROW_NUMBER() OVER (ORDER BY mi.total_revenue DESC) AS revenue_rank,\n        ROW_NUMBER() OVER (ORDER BY mi.competitive_advantage_score DESC) AS competitive_rank,\n        PERCENT_RANK() OVER (ORDER BY mi.market_opportunity_score) AS opportunity_percentile,\n        PERCENT_RANK() OVER (ORDER BY mi.total_revenue) AS revenue_percentile,\n        PERCENT_RANK() OVER (ORDER BY mi.competitive_advantage_score) AS competitive_percentile,\n        LAG(mi.market_opportunity_score) OVER (ORDER BY mi.market_opportunity_score DESC) AS prev_opportunity_score,\n        LEAD(mi.market_opportunity_score) OVER (ORDER BY mi.market_opportunity_score DESC) AS next_opportunity_score,\n        AVG(mi.market_opportunity_score) OVER (PARTITION BY mi.city_id) AS city_avg_opportunity_score,\n        STDDEV(mi.market_opportunity_score) OVER (PARTITION BY mi.city_id) AS city_stddev_opportunity_score,\n        AVG(mi.total_revenue) OVER (PARTITION BY mi.city_id) AS city_avg_revenue,\n        AVG(mi.avg_occupancy_rate) OVER (PARTITION BY mi.city_id) AS city_avg_occupancy_rate\n    FROM market_intelligence mi\n),\noptimization_recommendations AS (\n    SELECT\n        ra.*,\n        CASE\n            WHEN ra.market_opportunity_score >= ra.city_avg_opportunity_score + ra.city_stddev_opportunity_score THEN 'High Priority'\n            WHEN ra.market_opportunity_score >= ra.city_avg_opportunity_score THEN 'Medium Priority'\n            ELSE 'Low Priority'\n        END AS optimization_priority,\n        CASE\n            WHEN ra.avg_occupancy_rate > 85 AND ra.avg_hourly_rate < ra.avg_competitor_rate THEN\n                ra.avg_hourly_rate * 1.15  -- Increase price if high demand and underpriced\n            WHEN ra.avg_occupancy_rate < 50 AND ra.avg_hourly_rate > ra.avg_competitor_rate THEN\n                ra.avg_hourly_rate * 0.90  -- Decrease price if low demand and overpriced\n            WHEN ra.avg_hourly_rate < ra.median_competitor_rate * 0.9 THEN\n                ra.median_competitor_rate * 0.95  -- Price slightly below median if significantly underpriced\n            ELSE ra.avg_hourly_rate  -- Keep current price\n        END AS recommended_rate,\n        -- Revenue impact estimate\n        (\n            CASE\n                WHEN ra.avg_occupancy_rate > 85 AND ra.avg_hourly_rate < ra.avg_competitor_rate THEN\n                    ra.avg_hourly_rate * 1.15 * ra.total_spaces * ra.avg_occupancy_rate / 100.0 * ra.days_with_data\n                WHEN ra.avg_occupancy_rate < 50 AND ra.avg_hourly_rate > ra.avg_competitor_rate THEN\n                    ra.avg_hourly_rate * 0.90 * ra.total_spaces * ra.avg_occupancy_rate / 100.0 * ra.days_with_data\n                ELSE ra.total_revenue\n            END - ra.total_revenue\n        ) AS estimated_revenue_impact,\n        -- Market share estimate\n        CASE\n            WHEN ra.competitor_count > 0 AND ra.total_spaces > 0 THEN\n                (ra.total_spaces * ra.avg_occupancy_rate / 100.0) /\n                NULLIF(\n                    (ra.total_spaces * ra.avg_occupancy_rate / 100.0) +\n                    (ra.competitor_count * COALESCE(ra.avg_competitor_rate, 0) * 50),  -- Estimate competitor spaces\n                    1\n                ) * 100\n            ELSE 100.0\n        END AS estimated_market_share_pct\n    FROM ranked_analysis ra\n)\nSELECT\n    or_rec.facility_id,\n    or_rec.facility_name,\n    or_rec.city_name,\n    or_rec.state_code,\n    or_rec.msa_name,\n    or_rec.total_spaces,\n    or_rec.facility_type,\n    or_rec.operator_type,\n    or_rec.avg_occupancy_rate,\n    or_rec.median_occupancy_rate,\n    or_rec.p95_occupancy_rate,\n    or_rec.total_revenue,\n    or_rec.avg_hourly_rate AS current_rate,\n    or_rec.recommended_rate,\n    or_rec.competitor_count,\n    or_rec.avg_competitor_rate,\n    or_rec.median_competitor_rate,\n    or_rec.market_opportunity_score,\n    or_rec.competitive_advantage_score,\n    or_rec.opportunity_percentile,\n    or_rec.revenue_percentile,\n    or_rec.competitive_percentile,\n    or_rec.optimization_priority,\n    or_rec.estimated_revenue_impact,\n    or_rec.estimated_market_share_pct,\n    CASE\n        WHEN or_rec.estimated_revenue_impact > 1000 THEN 'High Impact'\n        WHEN or_rec.estimated_revenue_impact > 0 THEN 'Medium Impact'\n        ELSE 'Low Impact'\n    END AS impact_category\nFROM optimization_recommendations or_rec\nWHERE or_rec.competitor_count > 0 OR or_rec.total_revenue > 0\nORDER BY or_rec.market_opportunity_score DESC, or_rec.total_revenue DESC\nLIMIT 200;",
      "line_number": 5117
    },
    {
      "number": 25,
      "title": "Price Elasticity Analysis with Demand Response Modeling and Revenue Optimization",
      "description": "Analyzes price elasticity using CTEs for demand response modeling, elasticity calculations, and revenue optimization.",
      "use_case": "Understand price sensitivity and optimize pricing for revenue maximization.",
      "business_value": "Price elasticity report with demand response analysis and pricing recommendations.",
      "purpose": "Enables data-driven decision making through advanced analytics and business intelligence.",
      "complexity": "Elasticity CTEs (6+ levels), demand modeling, revenue optimization",
      "expected_output": "Query results with analysis and recommendations.",
      "sql": "WITH facility_base_data AS (\n    SELECT\n        pf.facility_id,\n        pf.facility_name,\n        pf.city_id,\n        pf.total_spaces,\n        pf.facility_type,\n        pf.operator_type,\n        pf.latitude,\n        pf.longitude,\n        pf.is_event_parking,\n        pf.is_monthly_parking,\n        pf.accepts_reservations,\n        c.city_name,\n        c.state_code,\n        c.population,\n        c.population_density,\n        c.median_household_income,\n        c.employment_total,\n        ma.msa_name,\n        ma.gdp_billions,\n        ma.population_estimate AS msa_population\n    FROM parking_facilities pf\n    INNER JOIN cities c ON pf.city_id = c.city_id\n    INNER JOIN metropolitan_areas ma ON c.msa_id = ma.msa_id\n    WHERE pf.is_hourly_parking = TRUE\n),\nutilization_aggregations AS (\n    SELECT\n        pu.facility_id,\n        pu.utilization_date,\n        pu.utilization_hour,\n        AVG(pu.occupancy_rate) AS avg_occupancy_rate,\n        PERCENTILE_CONT(0.5) WITHIN GROUP (ORDER BY pu.occupancy_rate) AS median_occupancy_rate,\n        PERCENTILE_CONT(0.75) WITHIN GROUP (ORDER BY pu.occupancy_rate) AS p75_occupancy_rate,\n        PERCENTILE_CONT(0.95) WITHIN GROUP (ORDER BY pu.occupancy_rate) AS p95_occupancy_rate,\n        SUM(pu.revenue_generated) AS total_revenue,\n        AVG(pu.revenue_generated) AS avg_revenue_per_record,\n        COUNT(*) AS utilization_records,\n        COUNT(DISTINCT pu.utilization_date) AS days_with_data,\n        DATE_PART('dow', pu.utilization_date) AS day_of_week\n    FROM parking_utilization pu\n    WHERE pu.utilization_date >= CURRENT_DATE - INTERVAL '90 days'\n    GROUP BY pu.facility_id, pu.utilization_date, pu.utilization_hour, DATE_PART('dow', pu.utilization_date)\n),\npricing_analysis AS (\n    SELECT\n        pp.facility_id,\n        AVG(pp.base_rate_hourly) AS avg_hourly_rate,\n        AVG(pp.base_rate_daily) AS avg_daily_rate,\n        AVG(pp.base_rate_monthly) AS avg_monthly_rate,\n        MIN(pp.base_rate_hourly) AS min_hourly_rate,\n        MAX(pp.base_rate_hourly) AS max_hourly_rate,\n        PERCENTILE_CONT(0.5) WITHIN GROUP (ORDER BY pp.base_rate_hourly) AS median_hourly_rate,\n        PERCENTILE_CONT(0.75) WITHIN GROUP (ORDER BY pp.base_rate_hourly) AS p75_hourly_rate,\n        COUNT(*) AS pricing_records\n    FROM parking_pricing pp\n    WHERE pp.is_active = TRUE\n    AND pp.pricing_type IN ('Hourly', 'Daily', 'Monthly')\n    GROUP BY pp.facility_id\n),\ncompetitive_landscape AS (\n    SELECT\n        fbd1.facility_id,\n        fbd1.city_id,\n        COUNT(DISTINCT fbd2.facility_id) AS competitor_count,\n        AVG(fbd2.total_spaces) AS avg_competitor_spaces,\n        SUM(fbd2.total_spaces) AS total_competitor_spaces,\n        AVG(pa2.avg_hourly_rate) AS avg_competitor_rate,\n        MIN(pa2.avg_hourly_rate) AS min_competitor_rate,\n        MAX(pa2.avg_hourly_rate) AS max_competitor_rate,\n        PERCENTILE_CONT(0.5) WITHIN GROUP (ORDER BY pa2.avg_hourly_rate) AS median_competitor_rate,\n        AVG(\n            CASE\n                WHEN ST_Distance(\n                    ST_SetSRID(ST_MakePoint(fbd1.longitude, fbd1.latitude), 4326)::geography,\n                    ST_SetSRID(ST_MakePoint(fbd2.longitude, fbd2.latitude), 4326)::geography\n                ) < 500 THEN ST_Distance(\n                    ST_SetSRID(ST_MakePoint(fbd1.longitude, fbd1.latitude), 4326)::geography,\n                    ST_SetSRID(ST_MakePoint(fbd2.longitude, fbd2.latitude), 4326)::geography\n                )\n                ELSE NULL\n            END\n        ) AS avg_distance_to_competitors\n    FROM facility_base_data fbd1\n    LEFT JOIN facility_base_data fbd2 ON fbd1.city_id = fbd2.city_id\n        AND fbd2.facility_id != fbd1.facility_id\n        AND ST_Distance(\n            ST_SetSRID(ST_MakePoint(fbd1.longitude, fbd1.latitude), 4326)::geography,\n            ST_SetSRID(ST_MakePoint(fbd2.longitude, fbd2.latitude), 4326)::geography\n        ) < 1000\n    LEFT JOIN pricing_analysis pa2 ON fbd2.facility_id = pa2.facility_id\n    GROUP BY fbd1.facility_id, fbd1.city_id, fbd1.latitude, fbd1.longitude\n),\nmarket_intelligence AS (\n    SELECT\n        fbd.facility_id,\n        fbd.facility_name,\n        fbd.city_id,\n        fbd.city_name,\n        fbd.state_code,\n        fbd.msa_name,\n        fbd.total_spaces,\n        fbd.facility_type,\n        fbd.operator_type,\n        fbd.population,\n        fbd.population_density,\n        fbd.median_household_income,\n        fbd.msa_population,\n        COALESCE(ua.avg_occupancy_rate, 0) AS avg_occupancy_rate,\n        COALESCE(ua.median_occupancy_rate, 0) AS median_occupancy_rate,\n        COALESCE(ua.p95_occupancy_rate, 0) AS p95_occupancy_rate,\n        COALESCE(ua.total_revenue, 0) AS total_revenue,\n        COALESCE(ua.avg_revenue_per_record, 0) AS avg_revenue_per_record,\n        COALESCE(ua.days_with_data, 0) AS days_with_data,\n        COALESCE(pa.avg_hourly_rate, 0) AS avg_hourly_rate,\n        COALESCE(pa.median_hourly_rate, 0) AS median_hourly_rate,\n        COALESCE(pa.p75_hourly_rate, 0) AS p75_hourly_rate,\n        COALESCE(cl.competitor_count, 0) AS competitor_count,\n        COALESCE(cl.avg_competitor_rate, 0) AS avg_competitor_rate,\n        COALESCE(cl.median_competitor_rate, 0) AS median_competitor_rate,\n        COALESCE(cl.avg_distance_to_competitors, 0) AS avg_distance_to_competitors,\n        -- Market opportunity score\n        (\n            LEAST(fbd.population_density / 10000.0, 1.0) * 25 +\n            LEAST(COALESCE(ua.avg_occupancy_rate, 0) / 100.0, 1.0) * 25 +\n            LEAST(fbd.median_household_income / 100000.0, 1.0) * 20 +\n            LEAST(COALESCE(cl.competitor_count, 0) / 10.0, 1.0) * 15 +\n            LEAST(fbd.total_spaces / 500.0, 1.0) * 15\n        ) AS market_opportunity_score,\n        -- Competitive advantage score\n        (\n            CASE WHEN COALESCE(pa.avg_hourly_rate, 0) < COALESCE(cl.avg_competitor_rate, 999) THEN 30 ELSE 0 END +\n            CASE WHEN COALESCE(ua.avg_occupancy_rate, 0) > 80 THEN 25 ELSE COALESCE(ua.avg_occupancy_rate, 0) * 0.3125 END +\n            CASE WHEN COALESCE(cl.competitor_count, 0) < 3 THEN 25 ELSE GREATEST(25 - COALESCE(cl.competitor_count, 0) * 2, 0) END +\n            CASE WHEN fbd.accepts_reservations THEN 20 ELSE 0 END\n        ) AS competitive_advantage_score\n    FROM facility_base_data fbd\n    LEFT JOIN utilization_aggregations ua ON fbd.facility_id = ua.facility_id\n    LEFT JOIN pricing_analysis pa ON fbd.facility_id = pa.facility_id\n    LEFT JOIN competitive_landscape cl ON fbd.facility_id = cl.facility_id\n),\nranked_analysis AS (\n    SELECT\n        mi.*,\n        ROW_NUMBER() OVER (PARTITION BY mi.city_id ORDER BY mi.market_opportunity_score DESC) AS city_rank,\n        ROW_NUMBER() OVER (ORDER BY mi.total_revenue DESC) AS revenue_rank,\n        ROW_NUMBER() OVER (ORDER BY mi.competitive_advantage_score DESC) AS competitive_rank,\n        PERCENT_RANK() OVER (ORDER BY mi.market_opportunity_score) AS opportunity_percentile,\n        PERCENT_RANK() OVER (ORDER BY mi.total_revenue) AS revenue_percentile,\n        PERCENT_RANK() OVER (ORDER BY mi.competitive_advantage_score) AS competitive_percentile,\n        LAG(mi.market_opportunity_score) OVER (ORDER BY mi.market_opportunity_score DESC) AS prev_opportunity_score,\n        LEAD(mi.market_opportunity_score) OVER (ORDER BY mi.market_opportunity_score DESC) AS next_opportunity_score,\n        AVG(mi.market_opportunity_score) OVER (PARTITION BY mi.city_id) AS city_avg_opportunity_score,\n        STDDEV(mi.market_opportunity_score) OVER (PARTITION BY mi.city_id) AS city_stddev_opportunity_score,\n        AVG(mi.total_revenue) OVER (PARTITION BY mi.city_id) AS city_avg_revenue,\n        AVG(mi.avg_occupancy_rate) OVER (PARTITION BY mi.city_id) AS city_avg_occupancy_rate\n    FROM market_intelligence mi\n),\noptimization_recommendations AS (\n    SELECT\n        ra.*,\n        CASE\n            WHEN ra.market_opportunity_score >= ra.city_avg_opportunity_score + ra.city_stddev_opportunity_score THEN 'High Priority'\n            WHEN ra.market_opportunity_score >= ra.city_avg_opportunity_score THEN 'Medium Priority'\n            ELSE 'Low Priority'\n        END AS optimization_priority,\n        CASE\n            WHEN ra.avg_occupancy_rate > 85 AND ra.avg_hourly_rate < ra.avg_competitor_rate THEN\n                ra.avg_hourly_rate * 1.15  -- Increase price if high demand and underpriced\n            WHEN ra.avg_occupancy_rate < 50 AND ra.avg_hourly_rate > ra.avg_competitor_rate THEN\n                ra.avg_hourly_rate * 0.90  -- Decrease price if low demand and overpriced\n            WHEN ra.avg_hourly_rate < ra.median_competitor_rate * 0.9 THEN\n                ra.median_competitor_rate * 0.95  -- Price slightly below median if significantly underpriced\n            ELSE ra.avg_hourly_rate  -- Keep current price\n        END AS recommended_rate,\n        -- Revenue impact estimate\n        (\n            CASE\n                WHEN ra.avg_occupancy_rate > 85 AND ra.avg_hourly_rate < ra.avg_competitor_rate THEN\n                    ra.avg_hourly_rate * 1.15 * ra.total_spaces * ra.avg_occupancy_rate / 100.0 * ra.days_with_data\n                WHEN ra.avg_occupancy_rate < 50 AND ra.avg_hourly_rate > ra.avg_competitor_rate THEN\n                    ra.avg_hourly_rate * 0.90 * ra.total_spaces * ra.avg_occupancy_rate / 100.0 * ra.days_with_data\n                ELSE ra.total_revenue\n            END - ra.total_revenue\n        ) AS estimated_revenue_impact,\n        -- Market share estimate\n        CASE\n            WHEN ra.competitor_count > 0 AND ra.total_spaces > 0 THEN\n                (ra.total_spaces * ra.avg_occupancy_rate / 100.0) /\n                NULLIF(\n                    (ra.total_spaces * ra.avg_occupancy_rate / 100.0) +\n                    (ra.competitor_count * COALESCE(ra.avg_competitor_rate, 0) * 50),  -- Estimate competitor spaces\n                    1\n                ) * 100\n            ELSE 100.0\n        END AS estimated_market_share_pct\n    FROM ranked_analysis ra\n)\nSELECT\n    or_rec.facility_id,\n    or_rec.facility_name,\n    or_rec.city_name,\n    or_rec.state_code,\n    or_rec.msa_name,\n    or_rec.total_spaces,\n    or_rec.facility_type,\n    or_rec.operator_type,\n    or_rec.avg_occupancy_rate,\n    or_rec.median_occupancy_rate,\n    or_rec.p95_occupancy_rate,\n    or_rec.total_revenue,\n    or_rec.avg_hourly_rate AS current_rate,\n    or_rec.recommended_rate,\n    or_rec.competitor_count,\n    or_rec.avg_competitor_rate,\n    or_rec.median_competitor_rate,\n    or_rec.market_opportunity_score,\n    or_rec.competitive_advantage_score,\n    or_rec.opportunity_percentile,\n    or_rec.revenue_percentile,\n    or_rec.competitive_percentile,\n    or_rec.optimization_priority,\n    or_rec.estimated_revenue_impact,\n    or_rec.estimated_market_share_pct,\n    CASE\n        WHEN or_rec.estimated_revenue_impact > 1000 THEN 'High Impact'\n        WHEN or_rec.estimated_revenue_impact > 0 THEN 'Medium Impact'\n        ELSE 'Low Impact'\n    END AS impact_category\nFROM optimization_recommendations or_rec\nWHERE or_rec.competitor_count > 0 OR or_rec.total_revenue > 0\nORDER BY or_rec.market_opportunity_score DESC, or_rec.total_revenue DESC\nLIMIT 200;",
      "line_number": 5367
    },
    {
      "number": 26,
      "title": "Supply-Demand Gap Analysis with Capacity Planning and Facility Expansion Recommendations",
      "description": "Analyzes supply-demand gaps using CTEs for gap identification, capacity planning, and expansion recommendations.",
      "use_case": "Identify supply-demand gaps and plan facility expansion.",
      "business_value": "Supply-demand gap report with capacity planning and expansion recommendations.",
      "purpose": "Enables data-driven decision making through advanced analytics and business intelligence.",
      "complexity": "Gap analysis CTEs (6+ levels), capacity planning, expansion modeling",
      "expected_output": "Query results with analysis and recommendations.",
      "sql": "WITH facility_base_data AS (\n    SELECT\n        pf.facility_id,\n        pf.facility_name,\n        pf.city_id,\n        pf.total_spaces,\n        pf.facility_type,\n        pf.operator_type,\n        pf.latitude,\n        pf.longitude,\n        pf.is_event_parking,\n        pf.is_monthly_parking,\n        pf.accepts_reservations,\n        c.city_name,\n        c.state_code,\n        c.population,\n        c.population_density,\n        c.median_household_income,\n        c.employment_total,\n        ma.msa_name,\n        ma.gdp_billions,\n        ma.population_estimate AS msa_population\n    FROM parking_facilities pf\n    INNER JOIN cities c ON pf.city_id = c.city_id\n    INNER JOIN metropolitan_areas ma ON c.msa_id = ma.msa_id\n    WHERE pf.is_hourly_parking = TRUE\n),\nutilization_aggregations AS (\n    SELECT\n        pu.facility_id,\n        pu.utilization_date,\n        pu.utilization_hour,\n        AVG(pu.occupancy_rate) AS avg_occupancy_rate,\n        PERCENTILE_CONT(0.5) WITHIN GROUP (ORDER BY pu.occupancy_rate) AS median_occupancy_rate,\n        PERCENTILE_CONT(0.75) WITHIN GROUP (ORDER BY pu.occupancy_rate) AS p75_occupancy_rate,\n        PERCENTILE_CONT(0.95) WITHIN GROUP (ORDER BY pu.occupancy_rate) AS p95_occupancy_rate,\n        SUM(pu.revenue_generated) AS total_revenue,\n        AVG(pu.revenue_generated) AS avg_revenue_per_record,\n        COUNT(*) AS utilization_records,\n        COUNT(DISTINCT pu.utilization_date) AS days_with_data,\n        DATE_PART('dow', pu.utilization_date) AS day_of_week\n    FROM parking_utilization pu\n    WHERE pu.utilization_date >= CURRENT_DATE - INTERVAL '90 days'\n    GROUP BY pu.facility_id, pu.utilization_date, pu.utilization_hour, DATE_PART('dow', pu.utilization_date)\n),\npricing_analysis AS (\n    SELECT\n        pp.facility_id,\n        AVG(pp.base_rate_hourly) AS avg_hourly_rate,\n        AVG(pp.base_rate_daily) AS avg_daily_rate,\n        AVG(pp.base_rate_monthly) AS avg_monthly_rate,\n        MIN(pp.base_rate_hourly) AS min_hourly_rate,\n        MAX(pp.base_rate_hourly) AS max_hourly_rate,\n        PERCENTILE_CONT(0.5) WITHIN GROUP (ORDER BY pp.base_rate_hourly) AS median_hourly_rate,\n        PERCENTILE_CONT(0.75) WITHIN GROUP (ORDER BY pp.base_rate_hourly) AS p75_hourly_rate,\n        COUNT(*) AS pricing_records\n    FROM parking_pricing pp\n    WHERE pp.is_active = TRUE\n    AND pp.pricing_type IN ('Hourly', 'Daily', 'Monthly')\n    GROUP BY pp.facility_id\n),\ncompetitive_landscape AS (\n    SELECT\n        fbd1.facility_id,\n        fbd1.city_id,\n        COUNT(DISTINCT fbd2.facility_id) AS competitor_count,\n        AVG(fbd2.total_spaces) AS avg_competitor_spaces,\n        SUM(fbd2.total_spaces) AS total_competitor_spaces,\n        AVG(pa2.avg_hourly_rate) AS avg_competitor_rate,\n        MIN(pa2.avg_hourly_rate) AS min_competitor_rate,\n        MAX(pa2.avg_hourly_rate) AS max_competitor_rate,\n        PERCENTILE_CONT(0.5) WITHIN GROUP (ORDER BY pa2.avg_hourly_rate) AS median_competitor_rate,\n        AVG(\n            CASE\n                WHEN ST_Distance(\n                    ST_SetSRID(ST_MakePoint(fbd1.longitude, fbd1.latitude), 4326)::geography,\n                    ST_SetSRID(ST_MakePoint(fbd2.longitude, fbd2.latitude), 4326)::geography\n                ) < 500 THEN ST_Distance(\n                    ST_SetSRID(ST_MakePoint(fbd1.longitude, fbd1.latitude), 4326)::geography,\n                    ST_SetSRID(ST_MakePoint(fbd2.longitude, fbd2.latitude), 4326)::geography\n                )\n                ELSE NULL\n            END\n        ) AS avg_distance_to_competitors\n    FROM facility_base_data fbd1\n    LEFT JOIN facility_base_data fbd2 ON fbd1.city_id = fbd2.city_id\n        AND fbd2.facility_id != fbd1.facility_id\n        AND ST_Distance(\n            ST_SetSRID(ST_MakePoint(fbd1.longitude, fbd1.latitude), 4326)::geography,\n            ST_SetSRID(ST_MakePoint(fbd2.longitude, fbd2.latitude), 4326)::geography\n        ) < 1000\n    LEFT JOIN pricing_analysis pa2 ON fbd2.facility_id = pa2.facility_id\n    GROUP BY fbd1.facility_id, fbd1.city_id, fbd1.latitude, fbd1.longitude\n),\nmarket_intelligence AS (\n    SELECT\n        fbd.facility_id,\n        fbd.facility_name,\n        fbd.city_id,\n        fbd.city_name,\n        fbd.state_code,\n        fbd.msa_name,\n        fbd.total_spaces,\n        fbd.facility_type,\n        fbd.operator_type,\n        fbd.population,\n        fbd.population_density,\n        fbd.median_household_income,\n        fbd.msa_population,\n        COALESCE(ua.avg_occupancy_rate, 0) AS avg_occupancy_rate,\n        COALESCE(ua.median_occupancy_rate, 0) AS median_occupancy_rate,\n        COALESCE(ua.p95_occupancy_rate, 0) AS p95_occupancy_rate,\n        COALESCE(ua.total_revenue, 0) AS total_revenue,\n        COALESCE(ua.avg_revenue_per_record, 0) AS avg_revenue_per_record,\n        COALESCE(ua.days_with_data, 0) AS days_with_data,\n        COALESCE(pa.avg_hourly_rate, 0) AS avg_hourly_rate,\n        COALESCE(pa.median_hourly_rate, 0) AS median_hourly_rate,\n        COALESCE(pa.p75_hourly_rate, 0) AS p75_hourly_rate,\n        COALESCE(cl.competitor_count, 0) AS competitor_count,\n        COALESCE(cl.avg_competitor_rate, 0) AS avg_competitor_rate,\n        COALESCE(cl.median_competitor_rate, 0) AS median_competitor_rate,\n        COALESCE(cl.avg_distance_to_competitors, 0) AS avg_distance_to_competitors,\n        -- Market opportunity score\n        (\n            LEAST(fbd.population_density / 10000.0, 1.0) * 25 +\n            LEAST(COALESCE(ua.avg_occupancy_rate, 0) / 100.0, 1.0) * 25 +\n            LEAST(fbd.median_household_income / 100000.0, 1.0) * 20 +\n            LEAST(COALESCE(cl.competitor_count, 0) / 10.0, 1.0) * 15 +\n            LEAST(fbd.total_spaces / 500.0, 1.0) * 15\n        ) AS market_opportunity_score,\n        -- Competitive advantage score\n        (\n            CASE WHEN COALESCE(pa.avg_hourly_rate, 0) < COALESCE(cl.avg_competitor_rate, 999) THEN 30 ELSE 0 END +\n            CASE WHEN COALESCE(ua.avg_occupancy_rate, 0) > 80 THEN 25 ELSE COALESCE(ua.avg_occupancy_rate, 0) * 0.3125 END +\n            CASE WHEN COALESCE(cl.competitor_count, 0) < 3 THEN 25 ELSE GREATEST(25 - COALESCE(cl.competitor_count, 0) * 2, 0) END +\n            CASE WHEN fbd.accepts_reservations THEN 20 ELSE 0 END\n        ) AS competitive_advantage_score\n    FROM facility_base_data fbd\n    LEFT JOIN utilization_aggregations ua ON fbd.facility_id = ua.facility_id\n    LEFT JOIN pricing_analysis pa ON fbd.facility_id = pa.facility_id\n    LEFT JOIN competitive_landscape cl ON fbd.facility_id = cl.facility_id\n),\nranked_analysis AS (\n    SELECT\n        mi.*,\n        ROW_NUMBER() OVER (PARTITION BY mi.city_id ORDER BY mi.market_opportunity_score DESC) AS city_rank,\n        ROW_NUMBER() OVER (ORDER BY mi.total_revenue DESC) AS revenue_rank,\n        ROW_NUMBER() OVER (ORDER BY mi.competitive_advantage_score DESC) AS competitive_rank,\n        PERCENT_RANK() OVER (ORDER BY mi.market_opportunity_score) AS opportunity_percentile,\n        PERCENT_RANK() OVER (ORDER BY mi.total_revenue) AS revenue_percentile,\n        PERCENT_RANK() OVER (ORDER BY mi.competitive_advantage_score) AS competitive_percentile,\n        LAG(mi.market_opportunity_score) OVER (ORDER BY mi.market_opportunity_score DESC) AS prev_opportunity_score,\n        LEAD(mi.market_opportunity_score) OVER (ORDER BY mi.market_opportunity_score DESC) AS next_opportunity_score,\n        AVG(mi.market_opportunity_score) OVER (PARTITION BY mi.city_id) AS city_avg_opportunity_score,\n        STDDEV(mi.market_opportunity_score) OVER (PARTITION BY mi.city_id) AS city_stddev_opportunity_score,\n        AVG(mi.total_revenue) OVER (PARTITION BY mi.city_id) AS city_avg_revenue,\n        AVG(mi.avg_occupancy_rate) OVER (PARTITION BY mi.city_id) AS city_avg_occupancy_rate\n    FROM market_intelligence mi\n),\noptimization_recommendations AS (\n    SELECT\n        ra.*,\n        CASE\n            WHEN ra.market_opportunity_score >= ra.city_avg_opportunity_score + ra.city_stddev_opportunity_score THEN 'High Priority'\n            WHEN ra.market_opportunity_score >= ra.city_avg_opportunity_score THEN 'Medium Priority'\n            ELSE 'Low Priority'\n        END AS optimization_priority,\n        CASE\n            WHEN ra.avg_occupancy_rate > 85 AND ra.avg_hourly_rate < ra.avg_competitor_rate THEN\n                ra.avg_hourly_rate * 1.15  -- Increase price if high demand and underpriced\n            WHEN ra.avg_occupancy_rate < 50 AND ra.avg_hourly_rate > ra.avg_competitor_rate THEN\n                ra.avg_hourly_rate * 0.90  -- Decrease price if low demand and overpriced\n            WHEN ra.avg_hourly_rate < ra.median_competitor_rate * 0.9 THEN\n                ra.median_competitor_rate * 0.95  -- Price slightly below median if significantly underpriced\n            ELSE ra.avg_hourly_rate  -- Keep current price\n        END AS recommended_rate,\n        -- Revenue impact estimate\n        (\n            CASE\n                WHEN ra.avg_occupancy_rate > 85 AND ra.avg_hourly_rate < ra.avg_competitor_rate THEN\n                    ra.avg_hourly_rate * 1.15 * ra.total_spaces * ra.avg_occupancy_rate / 100.0 * ra.days_with_data\n                WHEN ra.avg_occupancy_rate < 50 AND ra.avg_hourly_rate > ra.avg_competitor_rate THEN\n                    ra.avg_hourly_rate * 0.90 * ra.total_spaces * ra.avg_occupancy_rate / 100.0 * ra.days_with_data\n                ELSE ra.total_revenue\n            END - ra.total_revenue\n        ) AS estimated_revenue_impact,\n        -- Market share estimate\n        CASE\n            WHEN ra.competitor_count > 0 AND ra.total_spaces > 0 THEN\n                (ra.total_spaces * ra.avg_occupancy_rate / 100.0) /\n                NULLIF(\n                    (ra.total_spaces * ra.avg_occupancy_rate / 100.0) +\n                    (ra.competitor_count * COALESCE(ra.avg_competitor_rate, 0) * 50),  -- Estimate competitor spaces\n                    1\n                ) * 100\n            ELSE 100.0\n        END AS estimated_market_share_pct\n    FROM ranked_analysis ra\n)\nSELECT\n    or_rec.facility_id,\n    or_rec.facility_name,\n    or_rec.city_name,\n    or_rec.state_code,\n    or_rec.msa_name,\n    or_rec.total_spaces,\n    or_rec.facility_type,\n    or_rec.operator_type,\n    or_rec.avg_occupancy_rate,\n    or_rec.median_occupancy_rate,\n    or_rec.p95_occupancy_rate,\n    or_rec.total_revenue,\n    or_rec.avg_hourly_rate AS current_rate,\n    or_rec.recommended_rate,\n    or_rec.competitor_count,\n    or_rec.avg_competitor_rate,\n    or_rec.median_competitor_rate,\n    or_rec.market_opportunity_score,\n    or_rec.competitive_advantage_score,\n    or_rec.opportunity_percentile,\n    or_rec.revenue_percentile,\n    or_rec.competitive_percentile,\n    or_rec.optimization_priority,\n    or_rec.estimated_revenue_impact,\n    or_rec.estimated_market_share_pct,\n    CASE\n        WHEN or_rec.estimated_revenue_impact > 1000 THEN 'High Impact'\n        WHEN or_rec.estimated_revenue_impact > 0 THEN 'Medium Impact'\n        ELSE 'Low Impact'\n    END AS impact_category\nFROM optimization_recommendations or_rec\nWHERE or_rec.competitor_count > 0 OR or_rec.total_revenue > 0\nORDER BY or_rec.market_opportunity_score DESC, or_rec.total_revenue DESC\nLIMIT 200;",
      "line_number": 5617
    },
    {
      "number": 27,
      "title": "Market Penetration Analysis with Growth Metrics and Expansion Strategies",
      "description": "Analyzes market penetration using CTEs for penetration calculations, growth metrics, and expansion strategy development.",
      "use_case": "Measure market penetration and develop expansion strategies.",
      "business_value": "Market penetration report with growth metrics and expansion strategies.",
      "purpose": "Enables data-driven decision making through advanced analytics and business intelligence.",
      "complexity": "Penetration CTEs (6+ levels), growth metrics, expansion strategies",
      "expected_output": "Query results with analysis and recommendations.",
      "sql": "WITH facility_base_data AS (\n    SELECT\n        pf.facility_id,\n        pf.facility_name,\n        pf.city_id,\n        pf.total_spaces,\n        pf.facility_type,\n        pf.operator_type,\n        pf.latitude,\n        pf.longitude,\n        pf.is_event_parking,\n        pf.is_monthly_parking,\n        pf.accepts_reservations,\n        c.city_name,\n        c.state_code,\n        c.population,\n        c.population_density,\n        c.median_household_income,\n        c.employment_total,\n        ma.msa_name,\n        ma.gdp_billions,\n        ma.population_estimate AS msa_population\n    FROM parking_facilities pf\n    INNER JOIN cities c ON pf.city_id = c.city_id\n    INNER JOIN metropolitan_areas ma ON c.msa_id = ma.msa_id\n    WHERE pf.is_hourly_parking = TRUE\n),\nutilization_aggregations AS (\n    SELECT\n        pu.facility_id,\n        pu.utilization_date,\n        pu.utilization_hour,\n        AVG(pu.occupancy_rate) AS avg_occupancy_rate,\n        PERCENTILE_CONT(0.5) WITHIN GROUP (ORDER BY pu.occupancy_rate) AS median_occupancy_rate,\n        PERCENTILE_CONT(0.75) WITHIN GROUP (ORDER BY pu.occupancy_rate) AS p75_occupancy_rate,\n        PERCENTILE_CONT(0.95) WITHIN GROUP (ORDER BY pu.occupancy_rate) AS p95_occupancy_rate,\n        SUM(pu.revenue_generated) AS total_revenue,\n        AVG(pu.revenue_generated) AS avg_revenue_per_record,\n        COUNT(*) AS utilization_records,\n        COUNT(DISTINCT pu.utilization_date) AS days_with_data,\n        DATE_PART('dow', pu.utilization_date) AS day_of_week\n    FROM parking_utilization pu\n    WHERE pu.utilization_date >= CURRENT_DATE - INTERVAL '90 days'\n    GROUP BY pu.facility_id, pu.utilization_date, pu.utilization_hour, DATE_PART('dow', pu.utilization_date)\n),\npricing_analysis AS (\n    SELECT\n        pp.facility_id,\n        AVG(pp.base_rate_hourly) AS avg_hourly_rate,\n        AVG(pp.base_rate_daily) AS avg_daily_rate,\n        AVG(pp.base_rate_monthly) AS avg_monthly_rate,\n        MIN(pp.base_rate_hourly) AS min_hourly_rate,\n        MAX(pp.base_rate_hourly) AS max_hourly_rate,\n        PERCENTILE_CONT(0.5) WITHIN GROUP (ORDER BY pp.base_rate_hourly) AS median_hourly_rate,\n        PERCENTILE_CONT(0.75) WITHIN GROUP (ORDER BY pp.base_rate_hourly) AS p75_hourly_rate,\n        COUNT(*) AS pricing_records\n    FROM parking_pricing pp\n    WHERE pp.is_active = TRUE\n    AND pp.pricing_type IN ('Hourly', 'Daily', 'Monthly')\n    GROUP BY pp.facility_id\n),\ncompetitive_landscape AS (\n    SELECT\n        fbd1.facility_id,\n        fbd1.city_id,\n        COUNT(DISTINCT fbd2.facility_id) AS competitor_count,\n        AVG(fbd2.total_spaces) AS avg_competitor_spaces,\n        SUM(fbd2.total_spaces) AS total_competitor_spaces,\n        AVG(pa2.avg_hourly_rate) AS avg_competitor_rate,\n        MIN(pa2.avg_hourly_rate) AS min_competitor_rate,\n        MAX(pa2.avg_hourly_rate) AS max_competitor_rate,\n        PERCENTILE_CONT(0.5) WITHIN GROUP (ORDER BY pa2.avg_hourly_rate) AS median_competitor_rate,\n        AVG(\n            CASE\n                WHEN ST_Distance(\n                    ST_SetSRID(ST_MakePoint(fbd1.longitude, fbd1.latitude), 4326)::geography,\n                    ST_SetSRID(ST_MakePoint(fbd2.longitude, fbd2.latitude), 4326)::geography\n                ) < 500 THEN ST_Distance(\n                    ST_SetSRID(ST_MakePoint(fbd1.longitude, fbd1.latitude), 4326)::geography,\n                    ST_SetSRID(ST_MakePoint(fbd2.longitude, fbd2.latitude), 4326)::geography\n                )\n                ELSE NULL\n            END\n        ) AS avg_distance_to_competitors\n    FROM facility_base_data fbd1\n    LEFT JOIN facility_base_data fbd2 ON fbd1.city_id = fbd2.city_id\n        AND fbd2.facility_id != fbd1.facility_id\n        AND ST_Distance(\n            ST_SetSRID(ST_MakePoint(fbd1.longitude, fbd1.latitude), 4326)::geography,\n            ST_SetSRID(ST_MakePoint(fbd2.longitude, fbd2.latitude), 4326)::geography\n        ) < 1000\n    LEFT JOIN pricing_analysis pa2 ON fbd2.facility_id = pa2.facility_id\n    GROUP BY fbd1.facility_id, fbd1.city_id, fbd1.latitude, fbd1.longitude\n),\nmarket_intelligence AS (\n    SELECT\n        fbd.facility_id,\n        fbd.facility_name,\n        fbd.city_id,\n        fbd.city_name,\n        fbd.state_code,\n        fbd.msa_name,\n        fbd.total_spaces,\n        fbd.facility_type,\n        fbd.operator_type,\n        fbd.population,\n        fbd.population_density,\n        fbd.median_household_income,\n        fbd.msa_population,\n        COALESCE(ua.avg_occupancy_rate, 0) AS avg_occupancy_rate,\n        COALESCE(ua.median_occupancy_rate, 0) AS median_occupancy_rate,\n        COALESCE(ua.p95_occupancy_rate, 0) AS p95_occupancy_rate,\n        COALESCE(ua.total_revenue, 0) AS total_revenue,\n        COALESCE(ua.avg_revenue_per_record, 0) AS avg_revenue_per_record,\n        COALESCE(ua.days_with_data, 0) AS days_with_data,\n        COALESCE(pa.avg_hourly_rate, 0) AS avg_hourly_rate,\n        COALESCE(pa.median_hourly_rate, 0) AS median_hourly_rate,\n        COALESCE(pa.p75_hourly_rate, 0) AS p75_hourly_rate,\n        COALESCE(cl.competitor_count, 0) AS competitor_count,\n        COALESCE(cl.avg_competitor_rate, 0) AS avg_competitor_rate,\n        COALESCE(cl.median_competitor_rate, 0) AS median_competitor_rate,\n        COALESCE(cl.avg_distance_to_competitors, 0) AS avg_distance_to_competitors,\n        -- Market opportunity score\n        (\n            LEAST(fbd.population_density / 10000.0, 1.0) * 25 +\n            LEAST(COALESCE(ua.avg_occupancy_rate, 0) / 100.0, 1.0) * 25 +\n            LEAST(fbd.median_household_income / 100000.0, 1.0) * 20 +\n            LEAST(COALESCE(cl.competitor_count, 0) / 10.0, 1.0) * 15 +\n            LEAST(fbd.total_spaces / 500.0, 1.0) * 15\n        ) AS market_opportunity_score,\n        -- Competitive advantage score\n        (\n            CASE WHEN COALESCE(pa.avg_hourly_rate, 0) < COALESCE(cl.avg_competitor_rate, 999) THEN 30 ELSE 0 END +\n            CASE WHEN COALESCE(ua.avg_occupancy_rate, 0) > 80 THEN 25 ELSE COALESCE(ua.avg_occupancy_rate, 0) * 0.3125 END +\n            CASE WHEN COALESCE(cl.competitor_count, 0) < 3 THEN 25 ELSE GREATEST(25 - COALESCE(cl.competitor_count, 0) * 2, 0) END +\n            CASE WHEN fbd.accepts_reservations THEN 20 ELSE 0 END\n        ) AS competitive_advantage_score\n    FROM facility_base_data fbd\n    LEFT JOIN utilization_aggregations ua ON fbd.facility_id = ua.facility_id\n    LEFT JOIN pricing_analysis pa ON fbd.facility_id = pa.facility_id\n    LEFT JOIN competitive_landscape cl ON fbd.facility_id = cl.facility_id\n),\nranked_analysis AS (\n    SELECT\n        mi.*,\n        ROW_NUMBER() OVER (PARTITION BY mi.city_id ORDER BY mi.market_opportunity_score DESC) AS city_rank,\n        ROW_NUMBER() OVER (ORDER BY mi.total_revenue DESC) AS revenue_rank,\n        ROW_NUMBER() OVER (ORDER BY mi.competitive_advantage_score DESC) AS competitive_rank,\n        PERCENT_RANK() OVER (ORDER BY mi.market_opportunity_score) AS opportunity_percentile,\n        PERCENT_RANK() OVER (ORDER BY mi.total_revenue) AS revenue_percentile,\n        PERCENT_RANK() OVER (ORDER BY mi.competitive_advantage_score) AS competitive_percentile,\n        LAG(mi.market_opportunity_score) OVER (ORDER BY mi.market_opportunity_score DESC) AS prev_opportunity_score,\n        LEAD(mi.market_opportunity_score) OVER (ORDER BY mi.market_opportunity_score DESC) AS next_opportunity_score,\n        AVG(mi.market_opportunity_score) OVER (PARTITION BY mi.city_id) AS city_avg_opportunity_score,\n        STDDEV(mi.market_opportunity_score) OVER (PARTITION BY mi.city_id) AS city_stddev_opportunity_score,\n        AVG(mi.total_revenue) OVER (PARTITION BY mi.city_id) AS city_avg_revenue,\n        AVG(mi.avg_occupancy_rate) OVER (PARTITION BY mi.city_id) AS city_avg_occupancy_rate\n    FROM market_intelligence mi\n),\noptimization_recommendations AS (\n    SELECT\n        ra.*,\n        CASE\n            WHEN ra.market_opportunity_score >= ra.city_avg_opportunity_score + ra.city_stddev_opportunity_score THEN 'High Priority'\n            WHEN ra.market_opportunity_score >= ra.city_avg_opportunity_score THEN 'Medium Priority'\n            ELSE 'Low Priority'\n        END AS optimization_priority,\n        CASE\n            WHEN ra.avg_occupancy_rate > 85 AND ra.avg_hourly_rate < ra.avg_competitor_rate THEN\n                ra.avg_hourly_rate * 1.15  -- Increase price if high demand and underpriced\n            WHEN ra.avg_occupancy_rate < 50 AND ra.avg_hourly_rate > ra.avg_competitor_rate THEN\n                ra.avg_hourly_rate * 0.90  -- Decrease price if low demand and overpriced\n            WHEN ra.avg_hourly_rate < ra.median_competitor_rate * 0.9 THEN\n                ra.median_competitor_rate * 0.95  -- Price slightly below median if significantly underpriced\n            ELSE ra.avg_hourly_rate  -- Keep current price\n        END AS recommended_rate,\n        -- Revenue impact estimate\n        (\n            CASE\n                WHEN ra.avg_occupancy_rate > 85 AND ra.avg_hourly_rate < ra.avg_competitor_rate THEN\n                    ra.avg_hourly_rate * 1.15 * ra.total_spaces * ra.avg_occupancy_rate / 100.0 * ra.days_with_data\n                WHEN ra.avg_occupancy_rate < 50 AND ra.avg_hourly_rate > ra.avg_competitor_rate THEN\n                    ra.avg_hourly_rate * 0.90 * ra.total_spaces * ra.avg_occupancy_rate / 100.0 * ra.days_with_data\n                ELSE ra.total_revenue\n            END - ra.total_revenue\n        ) AS estimated_revenue_impact,\n        -- Market share estimate\n        CASE\n            WHEN ra.competitor_count > 0 AND ra.total_spaces > 0 THEN\n                (ra.total_spaces * ra.avg_occupancy_rate / 100.0) /\n                NULLIF(\n                    (ra.total_spaces * ra.avg_occupancy_rate / 100.0) +\n                    (ra.competitor_count * COALESCE(ra.avg_competitor_rate, 0) * 50),  -- Estimate competitor spaces\n                    1\n                ) * 100\n            ELSE 100.0\n        END AS estimated_market_share_pct\n    FROM ranked_analysis ra\n)\nSELECT\n    or_rec.facility_id,\n    or_rec.facility_name,\n    or_rec.city_name,\n    or_rec.state_code,\n    or_rec.msa_name,\n    or_rec.total_spaces,\n    or_rec.facility_type,\n    or_rec.operator_type,\n    or_rec.avg_occupancy_rate,\n    or_rec.median_occupancy_rate,\n    or_rec.p95_occupancy_rate,\n    or_rec.total_revenue,\n    or_rec.avg_hourly_rate AS current_rate,\n    or_rec.recommended_rate,\n    or_rec.competitor_count,\n    or_rec.avg_competitor_rate,\n    or_rec.median_competitor_rate,\n    or_rec.market_opportunity_score,\n    or_rec.competitive_advantage_score,\n    or_rec.opportunity_percentile,\n    or_rec.revenue_percentile,\n    or_rec.competitive_percentile,\n    or_rec.optimization_priority,\n    or_rec.estimated_revenue_impact,\n    or_rec.estimated_market_share_pct,\n    CASE\n        WHEN or_rec.estimated_revenue_impact > 1000 THEN 'High Impact'\n        WHEN or_rec.estimated_revenue_impact > 0 THEN 'Medium Impact'\n        ELSE 'Low Impact'\n    END AS impact_category\nFROM optimization_recommendations or_rec\nWHERE or_rec.competitor_count > 0 OR or_rec.total_revenue > 0\nORDER BY or_rec.market_opportunity_score DESC, or_rec.total_revenue DESC\nLIMIT 200;",
      "line_number": 5867
    },
    {
      "number": 28,
      "title": "Revenue Per Square Foot Analysis with Facility Efficiency Optimization",
      "description": "Analyzes revenue per square foot using CTEs for efficiency calculations, facility optimization, and space utilization analysis.",
      "use_case": "Optimize facility efficiency and space utilization for revenue maximization.",
      "business_value": "Revenue efficiency report with facility optimization recommendations.",
      "purpose": "Enables data-driven decision making through advanced analytics and business intelligence.",
      "complexity": "Efficiency CTEs (6+ levels), space utilization, optimization modeling",
      "expected_output": "Query results with analysis and recommendations.",
      "sql": "WITH facility_base_data AS (\n    SELECT\n        pf.facility_id,\n        pf.facility_name,\n        pf.city_id,\n        pf.total_spaces,\n        pf.facility_type,\n        pf.operator_type,\n        pf.latitude,\n        pf.longitude,\n        pf.is_event_parking,\n        pf.is_monthly_parking,\n        pf.accepts_reservations,\n        c.city_name,\n        c.state_code,\n        c.population,\n        c.population_density,\n        c.median_household_income,\n        c.employment_total,\n        ma.msa_name,\n        ma.gdp_billions,\n        ma.population_estimate AS msa_population\n    FROM parking_facilities pf\n    INNER JOIN cities c ON pf.city_id = c.city_id\n    INNER JOIN metropolitan_areas ma ON c.msa_id = ma.msa_id\n    WHERE pf.is_hourly_parking = TRUE\n),\nutilization_aggregations AS (\n    SELECT\n        pu.facility_id,\n        pu.utilization_date,\n        pu.utilization_hour,\n        AVG(pu.occupancy_rate) AS avg_occupancy_rate,\n        PERCENTILE_CONT(0.5) WITHIN GROUP (ORDER BY pu.occupancy_rate) AS median_occupancy_rate,\n        PERCENTILE_CONT(0.75) WITHIN GROUP (ORDER BY pu.occupancy_rate) AS p75_occupancy_rate,\n        PERCENTILE_CONT(0.95) WITHIN GROUP (ORDER BY pu.occupancy_rate) AS p95_occupancy_rate,\n        SUM(pu.revenue_generated) AS total_revenue,\n        AVG(pu.revenue_generated) AS avg_revenue_per_record,\n        COUNT(*) AS utilization_records,\n        COUNT(DISTINCT pu.utilization_date) AS days_with_data,\n        DATE_PART('dow', pu.utilization_date) AS day_of_week\n    FROM parking_utilization pu\n    WHERE pu.utilization_date >= CURRENT_DATE - INTERVAL '90 days'\n    GROUP BY pu.facility_id, pu.utilization_date, pu.utilization_hour, DATE_PART('dow', pu.utilization_date)\n),\npricing_analysis AS (\n    SELECT\n        pp.facility_id,\n        AVG(pp.base_rate_hourly) AS avg_hourly_rate,\n        AVG(pp.base_rate_daily) AS avg_daily_rate,\n        AVG(pp.base_rate_monthly) AS avg_monthly_rate,\n        MIN(pp.base_rate_hourly) AS min_hourly_rate,\n        MAX(pp.base_rate_hourly) AS max_hourly_rate,\n        PERCENTILE_CONT(0.5) WITHIN GROUP (ORDER BY pp.base_rate_hourly) AS median_hourly_rate,\n        PERCENTILE_CONT(0.75) WITHIN GROUP (ORDER BY pp.base_rate_hourly) AS p75_hourly_rate,\n        COUNT(*) AS pricing_records\n    FROM parking_pricing pp\n    WHERE pp.is_active = TRUE\n    AND pp.pricing_type IN ('Hourly', 'Daily', 'Monthly')\n    GROUP BY pp.facility_id\n),\ncompetitive_landscape AS (\n    SELECT\n        fbd1.facility_id,\n        fbd1.city_id,\n        COUNT(DISTINCT fbd2.facility_id) AS competitor_count,\n        AVG(fbd2.total_spaces) AS avg_competitor_spaces,\n        SUM(fbd2.total_spaces) AS total_competitor_spaces,\n        AVG(pa2.avg_hourly_rate) AS avg_competitor_rate,\n        MIN(pa2.avg_hourly_rate) AS min_competitor_rate,\n        MAX(pa2.avg_hourly_rate) AS max_competitor_rate,\n        PERCENTILE_CONT(0.5) WITHIN GROUP (ORDER BY pa2.avg_hourly_rate) AS median_competitor_rate,\n        AVG(\n            CASE\n                WHEN ST_Distance(\n                    ST_SetSRID(ST_MakePoint(fbd1.longitude, fbd1.latitude), 4326)::geography,\n                    ST_SetSRID(ST_MakePoint(fbd2.longitude, fbd2.latitude), 4326)::geography\n                ) < 500 THEN ST_Distance(\n                    ST_SetSRID(ST_MakePoint(fbd1.longitude, fbd1.latitude), 4326)::geography,\n                    ST_SetSRID(ST_MakePoint(fbd2.longitude, fbd2.latitude), 4326)::geography\n                )\n                ELSE NULL\n            END\n        ) AS avg_distance_to_competitors\n    FROM facility_base_data fbd1\n    LEFT JOIN facility_base_data fbd2 ON fbd1.city_id = fbd2.city_id\n        AND fbd2.facility_id != fbd1.facility_id\n        AND ST_Distance(\n            ST_SetSRID(ST_MakePoint(fbd1.longitude, fbd1.latitude), 4326)::geography,\n            ST_SetSRID(ST_MakePoint(fbd2.longitude, fbd2.latitude), 4326)::geography\n        ) < 1000\n    LEFT JOIN pricing_analysis pa2 ON fbd2.facility_id = pa2.facility_id\n    GROUP BY fbd1.facility_id, fbd1.city_id, fbd1.latitude, fbd1.longitude\n),\nmarket_intelligence AS (\n    SELECT\n        fbd.facility_id,\n        fbd.facility_name,\n        fbd.city_id,\n        fbd.city_name,\n        fbd.state_code,\n        fbd.msa_name,\n        fbd.total_spaces,\n        fbd.facility_type,\n        fbd.operator_type,\n        fbd.population,\n        fbd.population_density,\n        fbd.median_household_income,\n        fbd.msa_population,\n        COALESCE(ua.avg_occupancy_rate, 0) AS avg_occupancy_rate,\n        COALESCE(ua.median_occupancy_rate, 0) AS median_occupancy_rate,\n        COALESCE(ua.p95_occupancy_rate, 0) AS p95_occupancy_rate,\n        COALESCE(ua.total_revenue, 0) AS total_revenue,\n        COALESCE(ua.avg_revenue_per_record, 0) AS avg_revenue_per_record,\n        COALESCE(ua.days_with_data, 0) AS days_with_data,\n        COALESCE(pa.avg_hourly_rate, 0) AS avg_hourly_rate,\n        COALESCE(pa.median_hourly_rate, 0) AS median_hourly_rate,\n        COALESCE(pa.p75_hourly_rate, 0) AS p75_hourly_rate,\n        COALESCE(cl.competitor_count, 0) AS competitor_count,\n        COALESCE(cl.avg_competitor_rate, 0) AS avg_competitor_rate,\n        COALESCE(cl.median_competitor_rate, 0) AS median_competitor_rate,\n        COALESCE(cl.avg_distance_to_competitors, 0) AS avg_distance_to_competitors,\n        -- Market opportunity score\n        (\n            LEAST(fbd.population_density / 10000.0, 1.0) * 25 +\n            LEAST(COALESCE(ua.avg_occupancy_rate, 0) / 100.0, 1.0) * 25 +\n            LEAST(fbd.median_household_income / 100000.0, 1.0) * 20 +\n            LEAST(COALESCE(cl.competitor_count, 0) / 10.0, 1.0) * 15 +\n            LEAST(fbd.total_spaces / 500.0, 1.0) * 15\n        ) AS market_opportunity_score,\n        -- Competitive advantage score\n        (\n            CASE WHEN COALESCE(pa.avg_hourly_rate, 0) < COALESCE(cl.avg_competitor_rate, 999) THEN 30 ELSE 0 END +\n            CASE WHEN COALESCE(ua.avg_occupancy_rate, 0) > 80 THEN 25 ELSE COALESCE(ua.avg_occupancy_rate, 0) * 0.3125 END +\n            CASE WHEN COALESCE(cl.competitor_count, 0) < 3 THEN 25 ELSE GREATEST(25 - COALESCE(cl.competitor_count, 0) * 2, 0) END +\n            CASE WHEN fbd.accepts_reservations THEN 20 ELSE 0 END\n        ) AS competitive_advantage_score\n    FROM facility_base_data fbd\n    LEFT JOIN utilization_aggregations ua ON fbd.facility_id = ua.facility_id\n    LEFT JOIN pricing_analysis pa ON fbd.facility_id = pa.facility_id\n    LEFT JOIN competitive_landscape cl ON fbd.facility_id = cl.facility_id\n),\nranked_analysis AS (\n    SELECT\n        mi.*,\n        ROW_NUMBER() OVER (PARTITION BY mi.city_id ORDER BY mi.market_opportunity_score DESC) AS city_rank,\n        ROW_NUMBER() OVER (ORDER BY mi.total_revenue DESC) AS revenue_rank,\n        ROW_NUMBER() OVER (ORDER BY mi.competitive_advantage_score DESC) AS competitive_rank,\n        PERCENT_RANK() OVER (ORDER BY mi.market_opportunity_score) AS opportunity_percentile,\n        PERCENT_RANK() OVER (ORDER BY mi.total_revenue) AS revenue_percentile,\n        PERCENT_RANK() OVER (ORDER BY mi.competitive_advantage_score) AS competitive_percentile,\n        LAG(mi.market_opportunity_score) OVER (ORDER BY mi.market_opportunity_score DESC) AS prev_opportunity_score,\n        LEAD(mi.market_opportunity_score) OVER (ORDER BY mi.market_opportunity_score DESC) AS next_opportunity_score,\n        AVG(mi.market_opportunity_score) OVER (PARTITION BY mi.city_id) AS city_avg_opportunity_score,\n        STDDEV(mi.market_opportunity_score) OVER (PARTITION BY mi.city_id) AS city_stddev_opportunity_score,\n        AVG(mi.total_revenue) OVER (PARTITION BY mi.city_id) AS city_avg_revenue,\n        AVG(mi.avg_occupancy_rate) OVER (PARTITION BY mi.city_id) AS city_avg_occupancy_rate\n    FROM market_intelligence mi\n),\noptimization_recommendations AS (\n    SELECT\n        ra.*,\n        CASE\n            WHEN ra.market_opportunity_score >= ra.city_avg_opportunity_score + ra.city_stddev_opportunity_score THEN 'High Priority'\n            WHEN ra.market_opportunity_score >= ra.city_avg_opportunity_score THEN 'Medium Priority'\n            ELSE 'Low Priority'\n        END AS optimization_priority,\n        CASE\n            WHEN ra.avg_occupancy_rate > 85 AND ra.avg_hourly_rate < ra.avg_competitor_rate THEN\n                ra.avg_hourly_rate * 1.15  -- Increase price if high demand and underpriced\n            WHEN ra.avg_occupancy_rate < 50 AND ra.avg_hourly_rate > ra.avg_competitor_rate THEN\n                ra.avg_hourly_rate * 0.90  -- Decrease price if low demand and overpriced\n            WHEN ra.avg_hourly_rate < ra.median_competitor_rate * 0.9 THEN\n                ra.median_competitor_rate * 0.95  -- Price slightly below median if significantly underpriced\n            ELSE ra.avg_hourly_rate  -- Keep current price\n        END AS recommended_rate,\n        -- Revenue impact estimate\n        (\n            CASE\n                WHEN ra.avg_occupancy_rate > 85 AND ra.avg_hourly_rate < ra.avg_competitor_rate THEN\n                    ra.avg_hourly_rate * 1.15 * ra.total_spaces * ra.avg_occupancy_rate / 100.0 * ra.days_with_data\n                WHEN ra.avg_occupancy_rate < 50 AND ra.avg_hourly_rate > ra.avg_competitor_rate THEN\n                    ra.avg_hourly_rate * 0.90 * ra.total_spaces * ra.avg_occupancy_rate / 100.0 * ra.days_with_data\n                ELSE ra.total_revenue\n            END - ra.total_revenue\n        ) AS estimated_revenue_impact,\n        -- Market share estimate\n        CASE\n            WHEN ra.competitor_count > 0 AND ra.total_spaces > 0 THEN\n                (ra.total_spaces * ra.avg_occupancy_rate / 100.0) /\n                NULLIF(\n                    (ra.total_spaces * ra.avg_occupancy_rate / 100.0) +\n                    (ra.competitor_count * COALESCE(ra.avg_competitor_rate, 0) * 50),  -- Estimate competitor spaces\n                    1\n                ) * 100\n            ELSE 100.0\n        END AS estimated_market_share_pct\n    FROM ranked_analysis ra\n)\nSELECT\n    or_rec.facility_id,\n    or_rec.facility_name,\n    or_rec.city_name,\n    or_rec.state_code,\n    or_rec.msa_name,\n    or_rec.total_spaces,\n    or_rec.facility_type,\n    or_rec.operator_type,\n    or_rec.avg_occupancy_rate,\n    or_rec.median_occupancy_rate,\n    or_rec.p95_occupancy_rate,\n    or_rec.total_revenue,\n    or_rec.avg_hourly_rate AS current_rate,\n    or_rec.recommended_rate,\n    or_rec.competitor_count,\n    or_rec.avg_competitor_rate,\n    or_rec.median_competitor_rate,\n    or_rec.market_opportunity_score,\n    or_rec.competitive_advantage_score,\n    or_rec.opportunity_percentile,\n    or_rec.revenue_percentile,\n    or_rec.competitive_percentile,\n    or_rec.optimization_priority,\n    or_rec.estimated_revenue_impact,\n    or_rec.estimated_market_share_pct,\n    CASE\n        WHEN or_rec.estimated_revenue_impact > 1000 THEN 'High Impact'\n        WHEN or_rec.estimated_revenue_impact > 0 THEN 'Medium Impact'\n        ELSE 'Low Impact'\n    END AS impact_category\nFROM optimization_recommendations or_rec\nWHERE or_rec.competitor_count > 0 OR or_rec.total_revenue > 0\nORDER BY or_rec.market_opportunity_score DESC, or_rec.total_revenue DESC\nLIMIT 200;",
      "line_number": 6117
    },
    {
      "number": 29,
      "title": "Comprehensive Market Intelligence Dashboard with Multi-Dimensional Analytics",
      "description": "Creates comprehensive dashboard using CTEs for multi-dimensional analytics, KPI calculations, and executive reporting.",
      "use_case": "Provide executive dashboard with comprehensive market intelligence metrics.",
      "business_value": "Executive dashboard with comprehensive market intelligence and KPIs.",
      "purpose": "Enables data-driven decision making through advanced analytics and business intelligence.",
      "complexity": "Dashboard CTEs (8+ levels), multi-dimensional analytics, KPI calculations",
      "expected_output": "Query results with analysis and recommendations.",
      "sql": "WITH facility_base_data AS (\n    SELECT\n        pf.facility_id,\n        pf.facility_name,\n        pf.city_id,\n        pf.total_spaces,\n        pf.facility_type,\n        pf.operator_type,\n        pf.latitude,\n        pf.longitude,\n        pf.is_event_parking,\n        pf.is_monthly_parking,\n        pf.accepts_reservations,\n        c.city_name,\n        c.state_code,\n        c.population,\n        c.population_density,\n        c.median_household_income,\n        c.employment_total,\n        ma.msa_name,\n        ma.gdp_billions,\n        ma.population_estimate AS msa_population\n    FROM parking_facilities pf\n    INNER JOIN cities c ON pf.city_id = c.city_id\n    INNER JOIN metropolitan_areas ma ON c.msa_id = ma.msa_id\n    WHERE pf.is_hourly_parking = TRUE\n),\nutilization_aggregations AS (\n    SELECT\n        pu.facility_id,\n        pu.utilization_date,\n        pu.utilization_hour,\n        AVG(pu.occupancy_rate) AS avg_occupancy_rate,\n        PERCENTILE_CONT(0.5) WITHIN GROUP (ORDER BY pu.occupancy_rate) AS median_occupancy_rate,\n        PERCENTILE_CONT(0.75) WITHIN GROUP (ORDER BY pu.occupancy_rate) AS p75_occupancy_rate,\n        PERCENTILE_CONT(0.95) WITHIN GROUP (ORDER BY pu.occupancy_rate) AS p95_occupancy_rate,\n        SUM(pu.revenue_generated) AS total_revenue,\n        AVG(pu.revenue_generated) AS avg_revenue_per_record,\n        COUNT(*) AS utilization_records,\n        COUNT(DISTINCT pu.utilization_date) AS days_with_data,\n        DATE_PART('dow', pu.utilization_date) AS day_of_week\n    FROM parking_utilization pu\n    WHERE pu.utilization_date >= CURRENT_DATE - INTERVAL '90 days'\n    GROUP BY pu.facility_id, pu.utilization_date, pu.utilization_hour, DATE_PART('dow', pu.utilization_date)\n),\npricing_analysis AS (\n    SELECT\n        pp.facility_id,\n        AVG(pp.base_rate_hourly) AS avg_hourly_rate,\n        AVG(pp.base_rate_daily) AS avg_daily_rate,\n        AVG(pp.base_rate_monthly) AS avg_monthly_rate,\n        MIN(pp.base_rate_hourly) AS min_hourly_rate,\n        MAX(pp.base_rate_hourly) AS max_hourly_rate,\n        PERCENTILE_CONT(0.5) WITHIN GROUP (ORDER BY pp.base_rate_hourly) AS median_hourly_rate,\n        PERCENTILE_CONT(0.75) WITHIN GROUP (ORDER BY pp.base_rate_hourly) AS p75_hourly_rate,\n        COUNT(*) AS pricing_records\n    FROM parking_pricing pp\n    WHERE pp.is_active = TRUE\n    AND pp.pricing_type IN ('Hourly', 'Daily', 'Monthly')\n    GROUP BY pp.facility_id\n),\ncompetitive_landscape AS (\n    SELECT\n        fbd1.facility_id,\n        fbd1.city_id,\n        COUNT(DISTINCT fbd2.facility_id) AS competitor_count,\n        AVG(fbd2.total_spaces) AS avg_competitor_spaces,\n        SUM(fbd2.total_spaces) AS total_competitor_spaces,\n        AVG(pa2.avg_hourly_rate) AS avg_competitor_rate,\n        MIN(pa2.avg_hourly_rate) AS min_competitor_rate,\n        MAX(pa2.avg_hourly_rate) AS max_competitor_rate,\n        PERCENTILE_CONT(0.5) WITHIN GROUP (ORDER BY pa2.avg_hourly_rate) AS median_competitor_rate,\n        AVG(\n            CASE\n                WHEN ST_Distance(\n                    ST_SetSRID(ST_MakePoint(fbd1.longitude, fbd1.latitude), 4326)::geography,\n                    ST_SetSRID(ST_MakePoint(fbd2.longitude, fbd2.latitude), 4326)::geography\n                ) < 500 THEN ST_Distance(\n                    ST_SetSRID(ST_MakePoint(fbd1.longitude, fbd1.latitude), 4326)::geography,\n                    ST_SetSRID(ST_MakePoint(fbd2.longitude, fbd2.latitude), 4326)::geography\n                )\n                ELSE NULL\n            END\n        ) AS avg_distance_to_competitors\n    FROM facility_base_data fbd1\n    LEFT JOIN facility_base_data fbd2 ON fbd1.city_id = fbd2.city_id\n        AND fbd2.facility_id != fbd1.facility_id\n        AND ST_Distance(\n            ST_SetSRID(ST_MakePoint(fbd1.longitude, fbd1.latitude), 4326)::geography,\n            ST_SetSRID(ST_MakePoint(fbd2.longitude, fbd2.latitude), 4326)::geography\n        ) < 1000\n    LEFT JOIN pricing_analysis pa2 ON fbd2.facility_id = pa2.facility_id\n    GROUP BY fbd1.facility_id, fbd1.city_id, fbd1.latitude, fbd1.longitude\n),\nmarket_intelligence AS (\n    SELECT\n        fbd.facility_id,\n        fbd.facility_name,\n        fbd.city_id,\n        fbd.city_name,\n        fbd.state_code,\n        fbd.msa_name,\n        fbd.total_spaces,\n        fbd.facility_type,\n        fbd.operator_type,\n        fbd.population,\n        fbd.population_density,\n        fbd.median_household_income,\n        fbd.msa_population,\n        COALESCE(ua.avg_occupancy_rate, 0) AS avg_occupancy_rate,\n        COALESCE(ua.median_occupancy_rate, 0) AS median_occupancy_rate,\n        COALESCE(ua.p95_occupancy_rate, 0) AS p95_occupancy_rate,\n        COALESCE(ua.total_revenue, 0) AS total_revenue,\n        COALESCE(ua.avg_revenue_per_record, 0) AS avg_revenue_per_record,\n        COALESCE(ua.days_with_data, 0) AS days_with_data,\n        COALESCE(pa.avg_hourly_rate, 0) AS avg_hourly_rate,\n        COALESCE(pa.median_hourly_rate, 0) AS median_hourly_rate,\n        COALESCE(pa.p75_hourly_rate, 0) AS p75_hourly_rate,\n        COALESCE(cl.competitor_count, 0) AS competitor_count,\n        COALESCE(cl.avg_competitor_rate, 0) AS avg_competitor_rate,\n        COALESCE(cl.median_competitor_rate, 0) AS median_competitor_rate,\n        COALESCE(cl.avg_distance_to_competitors, 0) AS avg_distance_to_competitors,\n        -- Market opportunity score\n        (\n            LEAST(fbd.population_density / 10000.0, 1.0) * 25 +\n            LEAST(COALESCE(ua.avg_occupancy_rate, 0) / 100.0, 1.0) * 25 +\n            LEAST(fbd.median_household_income / 100000.0, 1.0) * 20 +\n            LEAST(COALESCE(cl.competitor_count, 0) / 10.0, 1.0) * 15 +\n            LEAST(fbd.total_spaces / 500.0, 1.0) * 15\n        ) AS market_opportunity_score,\n        -- Competitive advantage score\n        (\n            CASE WHEN COALESCE(pa.avg_hourly_rate, 0) < COALESCE(cl.avg_competitor_rate, 999) THEN 30 ELSE 0 END +\n            CASE WHEN COALESCE(ua.avg_occupancy_rate, 0) > 80 THEN 25 ELSE COALESCE(ua.avg_occupancy_rate, 0) * 0.3125 END +\n            CASE WHEN COALESCE(cl.competitor_count, 0) < 3 THEN 25 ELSE GREATEST(25 - COALESCE(cl.competitor_count, 0) * 2, 0) END +\n            CASE WHEN fbd.accepts_reservations THEN 20 ELSE 0 END\n        ) AS competitive_advantage_score\n    FROM facility_base_data fbd\n    LEFT JOIN utilization_aggregations ua ON fbd.facility_id = ua.facility_id\n    LEFT JOIN pricing_analysis pa ON fbd.facility_id = pa.facility_id\n    LEFT JOIN competitive_landscape cl ON fbd.facility_id = cl.facility_id\n),\nranked_analysis AS (\n    SELECT\n        mi.*,\n        ROW_NUMBER() OVER (PARTITION BY mi.city_id ORDER BY mi.market_opportunity_score DESC) AS city_rank,\n        ROW_NUMBER() OVER (ORDER BY mi.total_revenue DESC) AS revenue_rank,\n        ROW_NUMBER() OVER (ORDER BY mi.competitive_advantage_score DESC) AS competitive_rank,\n        PERCENT_RANK() OVER (ORDER BY mi.market_opportunity_score) AS opportunity_percentile,\n        PERCENT_RANK() OVER (ORDER BY mi.total_revenue) AS revenue_percentile,\n        PERCENT_RANK() OVER (ORDER BY mi.competitive_advantage_score) AS competitive_percentile,\n        LAG(mi.market_opportunity_score) OVER (ORDER BY mi.market_opportunity_score DESC) AS prev_opportunity_score,\n        LEAD(mi.market_opportunity_score) OVER (ORDER BY mi.market_opportunity_score DESC) AS next_opportunity_score,\n        AVG(mi.market_opportunity_score) OVER (PARTITION BY mi.city_id) AS city_avg_opportunity_score,\n        STDDEV(mi.market_opportunity_score) OVER (PARTITION BY mi.city_id) AS city_stddev_opportunity_score,\n        AVG(mi.total_revenue) OVER (PARTITION BY mi.city_id) AS city_avg_revenue,\n        AVG(mi.avg_occupancy_rate) OVER (PARTITION BY mi.city_id) AS city_avg_occupancy_rate\n    FROM market_intelligence mi\n),\noptimization_recommendations AS (\n    SELECT\n        ra.*,\n        CASE\n            WHEN ra.market_opportunity_score >= ra.city_avg_opportunity_score + ra.city_stddev_opportunity_score THEN 'High Priority'\n            WHEN ra.market_opportunity_score >= ra.city_avg_opportunity_score THEN 'Medium Priority'\n            ELSE 'Low Priority'\n        END AS optimization_priority,\n        CASE\n            WHEN ra.avg_occupancy_rate > 85 AND ra.avg_hourly_rate < ra.avg_competitor_rate THEN\n                ra.avg_hourly_rate * 1.15  -- Increase price if high demand and underpriced\n            WHEN ra.avg_occupancy_rate < 50 AND ra.avg_hourly_rate > ra.avg_competitor_rate THEN\n                ra.avg_hourly_rate * 0.90  -- Decrease price if low demand and overpriced\n            WHEN ra.avg_hourly_rate < ra.median_competitor_rate * 0.9 THEN\n                ra.median_competitor_rate * 0.95  -- Price slightly below median if significantly underpriced\n            ELSE ra.avg_hourly_rate  -- Keep current price\n        END AS recommended_rate,\n        -- Revenue impact estimate\n        (\n            CASE\n                WHEN ra.avg_occupancy_rate > 85 AND ra.avg_hourly_rate < ra.avg_competitor_rate THEN\n                    ra.avg_hourly_rate * 1.15 * ra.total_spaces * ra.avg_occupancy_rate / 100.0 * ra.days_with_data\n                WHEN ra.avg_occupancy_rate < 50 AND ra.avg_hourly_rate > ra.avg_competitor_rate THEN\n                    ra.avg_hourly_rate * 0.90 * ra.total_spaces * ra.avg_occupancy_rate / 100.0 * ra.days_with_data\n                ELSE ra.total_revenue\n            END - ra.total_revenue\n        ) AS estimated_revenue_impact,\n        -- Market share estimate\n        CASE\n            WHEN ra.competitor_count > 0 AND ra.total_spaces > 0 THEN\n                (ra.total_spaces * ra.avg_occupancy_rate / 100.0) /\n                NULLIF(\n                    (ra.total_spaces * ra.avg_occupancy_rate / 100.0) +\n                    (ra.competitor_count * COALESCE(ra.avg_competitor_rate, 0) * 50),  -- Estimate competitor spaces\n                    1\n                ) * 100\n            ELSE 100.0\n        END AS estimated_market_share_pct\n    FROM ranked_analysis ra\n)\nSELECT\n    or_rec.facility_id,\n    or_rec.facility_name,\n    or_rec.city_name,\n    or_rec.state_code,\n    or_rec.msa_name,\n    or_rec.total_spaces,\n    or_rec.facility_type,\n    or_rec.operator_type,\n    or_rec.avg_occupancy_rate,\n    or_rec.median_occupancy_rate,\n    or_rec.p95_occupancy_rate,\n    or_rec.total_revenue,\n    or_rec.avg_hourly_rate AS current_rate,\n    or_rec.recommended_rate,\n    or_rec.competitor_count,\n    or_rec.avg_competitor_rate,\n    or_rec.median_competitor_rate,\n    or_rec.market_opportunity_score,\n    or_rec.competitive_advantage_score,\n    or_rec.opportunity_percentile,\n    or_rec.revenue_percentile,\n    or_rec.competitive_percentile,\n    or_rec.optimization_priority,\n    or_rec.estimated_revenue_impact,\n    or_rec.estimated_market_share_pct,\n    CASE\n        WHEN or_rec.estimated_revenue_impact > 1000 THEN 'High Impact'\n        WHEN or_rec.estimated_revenue_impact > 0 THEN 'Medium Impact'\n        ELSE 'Low Impact'\n    END AS impact_category\nFROM optimization_recommendations or_rec\nWHERE or_rec.competitor_count > 0 OR or_rec.total_revenue > 0\nORDER BY or_rec.market_opportunity_score DESC, or_rec.total_revenue DESC\nLIMIT 200;",
      "line_number": 6367
    },
    {
      "number": 30,
      "title": "Cross-Database Performance Optimization Analysis with Query Efficiency Metrics",
      "description": "Analyzes cross-database performance using CTEs for query efficiency metrics, optimization recommendations, and performance benchmarking.",
      "use_case": "Optimize query performance across PostgreSQL.",
      "business_value": "Performance optimization report with efficiency metrics and optimization recommendations.",
      "purpose": "Enables data-driven decision making through advanced analytics and business intelligence.",
      "complexity": "Performance CTEs (7+ levels), efficiency metrics, optimization analysis",
      "expected_output": "Query results with analysis and recommendations.",
      "sql": "WITH facility_base_data AS (\n    SELECT\n        pf.facility_id,\n        pf.facility_name,\n        pf.city_id,\n        pf.total_spaces,\n        pf.facility_type,\n        pf.operator_type,\n        pf.latitude,\n        pf.longitude,\n        pf.is_event_parking,\n        pf.is_monthly_parking,\n        pf.accepts_reservations,\n        c.city_name,\n        c.state_code,\n        c.population,\n        c.population_density,\n        c.median_household_income,\n        c.employment_total,\n        ma.msa_name,\n        ma.gdp_billions,\n        ma.population_estimate AS msa_population\n    FROM parking_facilities pf\n    INNER JOIN cities c ON pf.city_id = c.city_id\n    INNER JOIN metropolitan_areas ma ON c.msa_id = ma.msa_id\n    WHERE pf.is_hourly_parking = TRUE\n),\nutilization_aggregations AS (\n    SELECT\n        pu.facility_id,\n        pu.utilization_date,\n        pu.utilization_hour,\n        AVG(pu.occupancy_rate) AS avg_occupancy_rate,\n        PERCENTILE_CONT(0.5) WITHIN GROUP (ORDER BY pu.occupancy_rate) AS median_occupancy_rate,\n        PERCENTILE_CONT(0.75) WITHIN GROUP (ORDER BY pu.occupancy_rate) AS p75_occupancy_rate,\n        PERCENTILE_CONT(0.95) WITHIN GROUP (ORDER BY pu.occupancy_rate) AS p95_occupancy_rate,\n        SUM(pu.revenue_generated) AS total_revenue,\n        AVG(pu.revenue_generated) AS avg_revenue_per_record,\n        COUNT(*) AS utilization_records,\n        COUNT(DISTINCT pu.utilization_date) AS days_with_data,\n        DATE_PART('dow', pu.utilization_date) AS day_of_week\n    FROM parking_utilization pu\n    WHERE pu.utilization_date >= CURRENT_DATE - INTERVAL '90 days'\n    GROUP BY pu.facility_id, pu.utilization_date, pu.utilization_hour, DATE_PART('dow', pu.utilization_date)\n),\npricing_analysis AS (\n    SELECT\n        pp.facility_id,\n        AVG(pp.base_rate_hourly) AS avg_hourly_rate,\n        AVG(pp.base_rate_daily) AS avg_daily_rate,\n        AVG(pp.base_rate_monthly) AS avg_monthly_rate,\n        MIN(pp.base_rate_hourly) AS min_hourly_rate,\n        MAX(pp.base_rate_hourly) AS max_hourly_rate,\n        PERCENTILE_CONT(0.5) WITHIN GROUP (ORDER BY pp.base_rate_hourly) AS median_hourly_rate,\n        PERCENTILE_CONT(0.75) WITHIN GROUP (ORDER BY pp.base_rate_hourly) AS p75_hourly_rate,\n        COUNT(*) AS pricing_records\n    FROM parking_pricing pp\n    WHERE pp.is_active = TRUE\n    AND pp.pricing_type IN ('Hourly', 'Daily', 'Monthly')\n    GROUP BY pp.facility_id\n),\ncompetitive_landscape AS (\n    SELECT\n        fbd1.facility_id,\n        fbd1.city_id,\n        COUNT(DISTINCT fbd2.facility_id) AS competitor_count,\n        AVG(fbd2.total_spaces) AS avg_competitor_spaces,\n        SUM(fbd2.total_spaces) AS total_competitor_spaces,\n        AVG(pa2.avg_hourly_rate) AS avg_competitor_rate,\n        MIN(pa2.avg_hourly_rate) AS min_competitor_rate,\n        MAX(pa2.avg_hourly_rate) AS max_competitor_rate,\n        PERCENTILE_CONT(0.5) WITHIN GROUP (ORDER BY pa2.avg_hourly_rate) AS median_competitor_rate,\n        AVG(\n            CASE\n                WHEN ST_Distance(\n                    ST_SetSRID(ST_MakePoint(fbd1.longitude, fbd1.latitude), 4326)::geography,\n                    ST_SetSRID(ST_MakePoint(fbd2.longitude, fbd2.latitude), 4326)::geography\n                ) < 500 THEN ST_Distance(\n                    ST_SetSRID(ST_MakePoint(fbd1.longitude, fbd1.latitude), 4326)::geography,\n                    ST_SetSRID(ST_MakePoint(fbd2.longitude, fbd2.latitude), 4326)::geography\n                )\n                ELSE NULL\n            END\n        ) AS avg_distance_to_competitors\n    FROM facility_base_data fbd1\n    LEFT JOIN facility_base_data fbd2 ON fbd1.city_id = fbd2.city_id\n        AND fbd2.facility_id != fbd1.facility_id\n        AND ST_Distance(\n            ST_SetSRID(ST_MakePoint(fbd1.longitude, fbd1.latitude), 4326)::geography,\n            ST_SetSRID(ST_MakePoint(fbd2.longitude, fbd2.latitude), 4326)::geography\n        ) < 1000\n    LEFT JOIN pricing_analysis pa2 ON fbd2.facility_id = pa2.facility_id\n    GROUP BY fbd1.facility_id, fbd1.city_id, fbd1.latitude, fbd1.longitude\n),\nmarket_intelligence AS (\n    SELECT\n        fbd.facility_id,\n        fbd.facility_name,\n        fbd.city_id,\n        fbd.city_name,\n        fbd.state_code,\n        fbd.msa_name,\n        fbd.total_spaces,\n        fbd.facility_type,\n        fbd.operator_type,\n        fbd.population,\n        fbd.population_density,\n        fbd.median_household_income,\n        fbd.msa_population,\n        COALESCE(ua.avg_occupancy_rate, 0) AS avg_occupancy_rate,\n        COALESCE(ua.median_occupancy_rate, 0) AS median_occupancy_rate,\n        COALESCE(ua.p95_occupancy_rate, 0) AS p95_occupancy_rate,\n        COALESCE(ua.total_revenue, 0) AS total_revenue,\n        COALESCE(ua.avg_revenue_per_record, 0) AS avg_revenue_per_record,\n        COALESCE(ua.days_with_data, 0) AS days_with_data,\n        COALESCE(pa.avg_hourly_rate, 0) AS avg_hourly_rate,\n        COALESCE(pa.median_hourly_rate, 0) AS median_hourly_rate,\n        COALESCE(pa.p75_hourly_rate, 0) AS p75_hourly_rate,\n        COALESCE(cl.competitor_count, 0) AS competitor_count,\n        COALESCE(cl.avg_competitor_rate, 0) AS avg_competitor_rate,\n        COALESCE(cl.median_competitor_rate, 0) AS median_competitor_rate,\n        COALESCE(cl.avg_distance_to_competitors, 0) AS avg_distance_to_competitors,\n        -- Market opportunity score\n        (\n            LEAST(fbd.population_density / 10000.0, 1.0) * 25 +\n            LEAST(COALESCE(ua.avg_occupancy_rate, 0) / 100.0, 1.0) * 25 +\n            LEAST(fbd.median_household_income / 100000.0, 1.0) * 20 +\n            LEAST(COALESCE(cl.competitor_count, 0) / 10.0, 1.0) * 15 +\n            LEAST(fbd.total_spaces / 500.0, 1.0) * 15\n        ) AS market_opportunity_score,\n        -- Competitive advantage score\n        (\n            CASE WHEN COALESCE(pa.avg_hourly_rate, 0) < COALESCE(cl.avg_competitor_rate, 999) THEN 30 ELSE 0 END +\n            CASE WHEN COALESCE(ua.avg_occupancy_rate, 0) > 80 THEN 25 ELSE COALESCE(ua.avg_occupancy_rate, 0) * 0.3125 END +\n            CASE WHEN COALESCE(cl.competitor_count, 0) < 3 THEN 25 ELSE GREATEST(25 - COALESCE(cl.competitor_count, 0) * 2, 0) END +\n            CASE WHEN fbd.accepts_reservations THEN 20 ELSE 0 END\n        ) AS competitive_advantage_score\n    FROM facility_base_data fbd\n    LEFT JOIN utilization_aggregations ua ON fbd.facility_id = ua.facility_id\n    LEFT JOIN pricing_analysis pa ON fbd.facility_id = pa.facility_id\n    LEFT JOIN competitive_landscape cl ON fbd.facility_id = cl.facility_id\n),\nranked_analysis AS (\n    SELECT\n        mi.*,\n        ROW_NUMBER() OVER (PARTITION BY mi.city_id ORDER BY mi.market_opportunity_score DESC) AS city_rank,\n        ROW_NUMBER() OVER (ORDER BY mi.total_revenue DESC) AS revenue_rank,\n        ROW_NUMBER() OVER (ORDER BY mi.competitive_advantage_score DESC) AS competitive_rank,\n        PERCENT_RANK() OVER (ORDER BY mi.market_opportunity_score) AS opportunity_percentile,\n        PERCENT_RANK() OVER (ORDER BY mi.total_revenue) AS revenue_percentile,\n        PERCENT_RANK() OVER (ORDER BY mi.competitive_advantage_score) AS competitive_percentile,\n        LAG(mi.market_opportunity_score) OVER (ORDER BY mi.market_opportunity_score DESC) AS prev_opportunity_score,\n        LEAD(mi.market_opportunity_score) OVER (ORDER BY mi.market_opportunity_score DESC) AS next_opportunity_score,\n        AVG(mi.market_opportunity_score) OVER (PARTITION BY mi.city_id) AS city_avg_opportunity_score,\n        STDDEV(mi.market_opportunity_score) OVER (PARTITION BY mi.city_id) AS city_stddev_opportunity_score,\n        AVG(mi.total_revenue) OVER (PARTITION BY mi.city_id) AS city_avg_revenue,\n        AVG(mi.avg_occupancy_rate) OVER (PARTITION BY mi.city_id) AS city_avg_occupancy_rate\n    FROM market_intelligence mi\n),\noptimization_recommendations AS (\n    SELECT\n        ra.*,\n        CASE\n            WHEN ra.market_opportunity_score >= ra.city_avg_opportunity_score + ra.city_stddev_opportunity_score THEN 'High Priority'\n            WHEN ra.market_opportunity_score >= ra.city_avg_opportunity_score THEN 'Medium Priority'\n            ELSE 'Low Priority'\n        END AS optimization_priority,\n        CASE\n            WHEN ra.avg_occupancy_rate > 85 AND ra.avg_hourly_rate < ra.avg_competitor_rate THEN\n                ra.avg_hourly_rate * 1.15  -- Increase price if high demand and underpriced\n            WHEN ra.avg_occupancy_rate < 50 AND ra.avg_hourly_rate > ra.avg_competitor_rate THEN\n                ra.avg_hourly_rate * 0.90  -- Decrease price if low demand and overpriced\n            WHEN ra.avg_hourly_rate < ra.median_competitor_rate * 0.9 THEN\n                ra.median_competitor_rate * 0.95  -- Price slightly below median if significantly underpriced\n            ELSE ra.avg_hourly_rate  -- Keep current price\n        END AS recommended_rate,\n        -- Revenue impact estimate\n        (\n            CASE\n                WHEN ra.avg_occupancy_rate > 85 AND ra.avg_hourly_rate < ra.avg_competitor_rate THEN\n                    ra.avg_hourly_rate * 1.15 * ra.total_spaces * ra.avg_occupancy_rate / 100.0 * ra.days_with_data\n                WHEN ra.avg_occupancy_rate < 50 AND ra.avg_hourly_rate > ra.avg_competitor_rate THEN\n                    ra.avg_hourly_rate * 0.90 * ra.total_spaces * ra.avg_occupancy_rate / 100.0 * ra.days_with_data\n                ELSE ra.total_revenue\n            END - ra.total_revenue\n        ) AS estimated_revenue_impact,\n        -- Market share estimate\n        CASE\n            WHEN ra.competitor_count > 0 AND ra.total_spaces > 0 THEN\n                (ra.total_spaces * ra.avg_occupancy_rate / 100.0) /\n                NULLIF(\n                    (ra.total_spaces * ra.avg_occupancy_rate / 100.0) +\n                    (ra.competitor_count * COALESCE(ra.avg_competitor_rate, 0) * 50),  -- Estimate competitor spaces\n                    1\n                ) * 100\n            ELSE 100.0\n        END AS estimated_market_share_pct\n    FROM ranked_analysis ra\n)\nSELECT\n    or_rec.facility_id,\n    or_rec.facility_name,\n    or_rec.city_name,\n    or_rec.state_code,\n    or_rec.msa_name,\n    or_rec.total_spaces,\n    or_rec.facility_type,\n    or_rec.operator_type,\n    or_rec.avg_occupancy_rate,\n    or_rec.median_occupancy_rate,\n    or_rec.p95_occupancy_rate,\n    or_rec.total_revenue,\n    or_rec.avg_hourly_rate AS current_rate,\n    or_rec.recommended_rate,\n    or_rec.competitor_count,\n    or_rec.avg_competitor_rate,\n    or_rec.median_competitor_rate,\n    or_rec.market_opportunity_score,\n    or_rec.competitive_advantage_score,\n    or_rec.opportunity_percentile,\n    or_rec.revenue_percentile,\n    or_rec.competitive_percentile,\n    or_rec.optimization_priority,\n    or_rec.estimated_revenue_impact,\n    or_rec.estimated_market_share_pct,\n    CASE\n        WHEN or_rec.estimated_revenue_impact > 1000 THEN 'High Impact'\n        WHEN or_rec.estimated_revenue_impact > 0 THEN 'Medium Impact'\n        ELSE 'Low Impact'\n    END AS impact_category\nFROM optimization_recommendations or_rec\nWHERE or_rec.competitor_count > 0 OR or_rec.total_revenue > 0\nORDER BY or_rec.market_opportunity_score DESC, or_rec.total_revenue DESC\nLIMIT 200;",
      "line_number": 6617
    }
  ]
}