{
  "database": {
    "id": "db-7",
    "name": "Database db-7",
    "description": "Database db-7",
    "created_date": "2026-02-09",
    "version": "1.0"
  },
  "schema": {
    "total_tables": 14,
    "tables": [
      {
        "name": "carriers",
        "description": "",
        "columns": [
          {
            "name": "carrier_id",
            "data_type": "VARCHAR(255)",
            "constraints": "PRIMARY KEY",
            "description": ""
          },
          {
            "name": "carrier_name",
            "data_type": "VARCHAR(255)",
            "constraints": "NOT NULL",
            "description": ""
          },
          {
            "name": "scac_code",
            "data_type": "VARCHAR(10)",
            "constraints": "UNIQUE",
            "description": "Standard Carrier Alpha Code"
          },
          {
            "name": "carrier_type",
            "data_type": "VARCHAR(50)",
            "constraints": "",
            "description": "'Container', 'Bulk', 'RoRo', 'Tanker', 'General'"
          },
          {
            "name": "country",
            "data_type": "VARCHAR(100)",
            "constraints": "",
            "description": ""
          },
          {
            "name": "website",
            "data_type": "VARCHAR(500)",
            "constraints": "",
            "description": ""
          },
          {
            "name": "contact_email",
            "data_type": "VARCHAR(255)",
            "constraints": "",
            "description": ""
          },
          {
            "name": "contact_phone",
            "data_type": "VARCHAR(50)",
            "constraints": "",
            "description": ""
          },
          {
            "name": "status",
            "data_type": "VARCHAR(50)",
            "constraints": "",
            "description": ""
          },
          {
            "name": "fleet_size",
            "data_type": "INTEGER",
            "constraints": "",
            "description": ""
          },
          {
            "name": "total_capacity_teu",
            "data_type": "INTEGER",
            "constraints": "",
            "description": ""
          },
          {
            "name": "established_year",
            "data_type": "INTEGER",
            "constraints": "",
            "description": ""
          },
          {
            "name": "created_at",
            "data_type": "TIMESTAMP",
            "constraints": "",
            "description": ""
          },
          {
            "name": "updated_at",
            "data_type": "TIMESTAMP",
            "constraints": "",
            "description": ""
          }
        ]
      },
      {
        "name": "locations",
        "description": "",
        "columns": [
          {
            "name": "location_id",
            "data_type": "VARCHAR(255)",
            "constraints": "PRIMARY KEY",
            "description": ""
          },
          {
            "name": "location_name",
            "data_type": "VARCHAR(255)",
            "constraints": "NOT NULL",
            "description": ""
          },
          {
            "name": "location_type",
            "data_type": "VARCHAR(50)",
            "constraints": "NOT NULL",
            "description": "'Country', 'Region', 'State', 'Province'"
          },
          {
            "name": "parent_location_id",
            "data_type": "VARCHAR(255)",
            "constraints": "",
            "description": ""
          },
          {
            "name": "country_code",
            "data_type": "VARCHAR(3)",
            "constraints": "",
            "description": "ISO 3166-1 alpha-3"
          },
          {
            "name": "region_code",
            "data_type": "VARCHAR(10)",
            "constraints": "",
            "description": ""
          },
          {
            "name": "latitude",
            "data_type": "NUMERIC(10",
            "constraints": "",
            "description": ""
          },
          {
            "name": "longitude",
            "data_type": "NUMERIC(10",
            "constraints": "",
            "description": ""
          },
          {
            "name": "location_geom",
            "data_type": "GEOGRAPHY",
            "constraints": "",
            "description": "Point geometry for location center"
          },
          {
            "name": "spatial_extent_west",
            "data_type": "NUMERIC(10",
            "constraints": "",
            "description": ""
          },
          {
            "name": "spatial_extent_south",
            "data_type": "NUMERIC(10",
            "constraints": "",
            "description": ""
          },
          {
            "name": "spatial_extent_east",
            "data_type": "NUMERIC(10",
            "constraints": "",
            "description": ""
          },
          {
            "name": "spatial_extent_north",
            "data_type": "NUMERIC(10",
            "constraints": "",
            "description": ""
          },
          {
            "name": "created_at",
            "data_type": "TIMESTAMP",
            "constraints": "",
            "description": ""
          }
        ]
      },
      {
        "name": "ports",
        "description": "",
        "columns": [
          {
            "name": "port_id",
            "data_type": "VARCHAR(255)",
            "constraints": "PRIMARY KEY",
            "description": ""
          },
          {
            "name": "port_name",
            "data_type": "VARCHAR(255)",
            "constraints": "NOT NULL",
            "description": ""
          },
          {
            "name": "port_code",
            "data_type": "VARCHAR(20)",
            "constraints": "UNIQUE",
            "description": "UN/LOCODE or port code"
          },
          {
            "name": "locode",
            "data_type": "VARCHAR(10)",
            "constraints": "",
            "description": "UN/LOCODE (5 characters: 2 country + 3 location)"
          },
          {
            "name": "location_id",
            "data_type": "VARCHAR(255)",
            "constraints": "",
            "description": ""
          },
          {
            "name": "country",
            "data_type": "VARCHAR(100)",
            "constraints": "",
            "description": ""
          },
          {
            "name": "country_code",
            "data_type": "VARCHAR(3)",
            "constraints": "",
            "description": ""
          },
          {
            "name": "latitude",
            "data_type": "NUMERIC(10",
            "constraints": "NOT NULL",
            "description": ""
          },
          {
            "name": "longitude",
            "data_type": "NUMERIC(10",
            "constraints": "NOT NULL",
            "description": ""
          },
          {
            "name": "port_geom",
            "data_type": "GEOGRAPHY",
            "constraints": "",
            "description": "Point geometry for port location"
          },
          {
            "name": "port_type",
            "data_type": "VARCHAR(50)",
            "constraints": "",
            "description": "'Container', 'Bulk', 'RoRo', 'Tanker', 'General', 'Multi-purpose'"
          },
          {
            "name": "timezone",
            "data_type": "VARCHAR(50)",
            "constraints": "",
            "description": ""
          },
          {
            "name": "depth_meters",
            "data_type": "NUMERIC(8",
            "constraints": "",
            "description": ""
          },
          {
            "name": "max_vessel_length_meters",
            "data_type": "NUMERIC(8",
            "constraints": "",
            "description": ""
          },
          {
            "name": "max_vessel_draft_meters",
            "data_type": "NUMERIC(8",
            "constraints": "",
            "description": ""
          },
          {
            "name": "container_capacity_teu",
            "data_type": "INTEGER",
            "constraints": "",
            "description": ""
          },
          {
            "name": "berth_count",
            "data_type": "INTEGER",
            "constraints": "",
            "description": ""
          },
          {
            "name": "crane_count",
            "data_type": "INTEGER",
            "constraints": "",
            "description": ""
          },
          {
            "name": "status",
            "data_type": "VARCHAR(50)",
            "constraints": "",
            "description": ""
          },
          {
            "name": "data_source",
            "data_type": "VARCHAR(100)",
            "constraints": "",
            "description": "'MARAD', 'NOAA', 'USCG', 'Linescape', etc."
          },
          {
            "name": "created_at",
            "data_type": "TIMESTAMP",
            "constraints": "",
            "description": ""
          },
          {
            "name": "updated_at",
            "data_type": "TIMESTAMP",
            "constraints": "",
            "description": ""
          }
        ]
      },
      {
        "name": "vessels",
        "description": "",
        "columns": [
          {
            "name": "vessel_id",
            "data_type": "VARCHAR(255)",
            "constraints": "PRIMARY KEY",
            "description": ""
          },
          {
            "name": "vessel_name",
            "data_type": "VARCHAR(255)",
            "constraints": "NOT NULL",
            "description": ""
          },
          {
            "name": "imo_number",
            "data_type": "VARCHAR(10)",
            "constraints": "UNIQUE",
            "description": "International Maritime Organization number"
          },
          {
            "name": "mmsi",
            "data_type": "VARCHAR(9)",
            "constraints": "",
            "description": "Maritime Mobile Service Identity"
          },
          {
            "name": "call_sign",
            "data_type": "VARCHAR(20)",
            "constraints": "",
            "description": ""
          },
          {
            "name": "carrier_id",
            "data_type": "VARCHAR(255)",
            "constraints": "",
            "description": ""
          },
          {
            "name": "vessel_type",
            "data_type": "VARCHAR(50)",
            "constraints": "",
            "description": "'Container', 'Bulk', 'RoRo', 'Tanker', 'General Cargo'"
          },
          {
            "name": "flag_country",
            "data_type": "VARCHAR(100)",
            "constraints": "",
            "description": ""
          },
          {
            "name": "flag_country_code",
            "data_type": "VARCHAR(3)",
            "constraints": "",
            "description": ""
          },
          {
            "name": "year_built",
            "data_type": "INTEGER",
            "constraints": "",
            "description": ""
          },
          {
            "name": "gross_tonnage",
            "data_type": "INTEGER",
            "constraints": "",
            "description": ""
          },
          {
            "name": "net_tonnage",
            "data_type": "INTEGER",
            "constraints": "",
            "description": ""
          },
          {
            "name": "deadweight_tonnage",
            "data_type": "INTEGER",
            "constraints": "",
            "description": ""
          },
          {
            "name": "length_meters",
            "data_type": "NUMERIC(8",
            "constraints": "",
            "description": ""
          },
          {
            "name": "beam_meters",
            "data_type": "NUMERIC(8",
            "constraints": "",
            "description": ""
          },
          {
            "name": "draft_meters",
            "data_type": "NUMERIC(8",
            "constraints": "",
            "description": ""
          },
          {
            "name": "max_speed_knots",
            "data_type": "NUMERIC(6",
            "constraints": "",
            "description": ""
          },
          {
            "name": "container_capacity_teu",
            "data_type": "INTEGER",
            "constraints": "",
            "description": ""
          },
          {
            "name": "container_capacity_twenty_foot",
            "data_type": "INTEGER",
            "constraints": "",
            "description": ""
          },
          {
            "name": "container_capacity_forty_foot",
            "data_type": "INTEGER",
            "constraints": "",
            "description": ""
          },
          {
            "name": "status",
            "data_type": "VARCHAR(50)",
            "constraints": "",
            "description": ""
          },
          {
            "name": "data_source",
            "data_type": "VARCHAR(100)",
            "constraints": "",
            "description": "'USCG', 'NOAA', 'MARAD', 'Linescape', etc."
          },
          {
            "name": "created_at",
            "data_type": "TIMESTAMP",
            "constraints": "",
            "description": ""
          },
          {
            "name": "updated_at",
            "data_type": "TIMESTAMP",
            "constraints": "",
            "description": ""
          }
        ]
      },
      {
        "name": "routes",
        "description": "",
        "columns": [
          {
            "name": "route_id",
            "data_type": "VARCHAR(255)",
            "constraints": "PRIMARY KEY",
            "description": ""
          },
          {
            "name": "route_name",
            "data_type": "VARCHAR(255)",
            "constraints": "NOT NULL",
            "description": ""
          },
          {
            "name": "route_code",
            "data_type": "VARCHAR(100)",
            "constraints": "",
            "description": ""
          },
          {
            "name": "carrier_id",
            "data_type": "VARCHAR(255)",
            "constraints": "NOT NULL",
            "description": ""
          },
          {
            "name": "service_type",
            "data_type": "VARCHAR(50)",
            "constraints": "",
            "description": "'Direct', 'Feeder', 'Express', 'Regular'"
          },
          {
            "name": "route_type",
            "data_type": "VARCHAR(50)",
            "constraints": "",
            "description": "'Trans-Pacific', 'Trans-Atlantic', 'Asia-Europe', etc."
          },
          {
            "name": "frequency_weeks",
            "data_type": "INTEGER",
            "constraints": "",
            "description": "Service frequency in weeks"
          },
          {
            "name": "transit_time_days",
            "data_type": "INTEGER",
            "constraints": "",
            "description": "Average transit time"
          },
          {
            "name": "status",
            "data_type": "VARCHAR(50)",
            "constraints": "",
            "description": ""
          },
          {
            "name": "start_date",
            "data_type": "DATE",
            "constraints": "",
            "description": ""
          },
          {
            "name": "end_date",
            "data_type": "DATE",
            "constraints": "",
            "description": ""
          },
          {
            "name": "created_at",
            "data_type": "TIMESTAMP",
            "constraints": "",
            "description": ""
          },
          {
            "name": "updated_at",
            "data_type": "TIMESTAMP",
            "constraints": "",
            "description": ""
          }
        ]
      },
      {
        "name": "route_ports",
        "description": "",
        "columns": [
          {
            "name": "route_port_id",
            "data_type": "VARCHAR(255)",
            "constraints": "PRIMARY KEY",
            "description": ""
          },
          {
            "name": "route_id",
            "data_type": "VARCHAR(255)",
            "constraints": "NOT NULL",
            "description": ""
          },
          {
            "name": "port_id",
            "data_type": "VARCHAR(255)",
            "constraints": "NOT NULL",
            "description": ""
          },
          {
            "name": "port_sequence",
            "data_type": "INTEGER",
            "constraints": "NOT NULL",
            "description": "Order of port call in route"
          },
          {
            "name": "port_role",
            "data_type": "VARCHAR(50)",
            "constraints": "",
            "description": "'Origin', 'Destination', 'Transshipment', 'Intermediate'"
          },
          {
            "name": "estimated_days_from_start",
            "data_type": "INTEGER",
            "constraints": "",
            "description": "Days from route start"
          },
          {
            "name": "created_at",
            "data_type": "TIMESTAMP",
            "constraints": "",
            "description": ""
          }
        ]
      },
      {
        "name": "port_pairs",
        "description": "",
        "columns": [
          {
            "name": "port_pair_id",
            "data_type": "VARCHAR(255)",
            "constraints": "PRIMARY KEY",
            "description": ""
          },
          {
            "name": "origin_port_id",
            "data_type": "VARCHAR(255)",
            "constraints": "NOT NULL",
            "description": ""
          },
          {
            "name": "destination_port_id",
            "data_type": "VARCHAR(255)",
            "constraints": "NOT NULL",
            "description": ""
          },
          {
            "name": "carrier_id",
            "data_type": "VARCHAR(255)",
            "constraints": "NOT NULL",
            "description": ""
          },
          {
            "name": "route_id",
            "data_type": "VARCHAR(255)",
            "constraints": "",
            "description": ""
          },
          {
            "name": "direct_service",
            "data_type": "BOOLEAN",
            "constraints": "",
            "description": "True if direct service exists"
          },
          {
            "name": "transshipment_required",
            "data_type": "BOOLEAN",
            "constraints": "",
            "description": ""
          },
          {
            "name": "average_transit_days",
            "data_type": "INTEGER",
            "constraints": "",
            "description": ""
          },
          {
            "name": "service_frequency_weeks",
            "data_type": "INTEGER",
            "constraints": "",
            "description": ""
          },
          {
            "name": "last_sailing_date",
            "data_type": "DATE",
            "constraints": "",
            "description": ""
          },
          {
            "name": "status",
            "data_type": "VARCHAR(50)",
            "constraints": "",
            "description": ""
          },
          {
            "name": "created_at",
            "data_type": "TIMESTAMP",
            "constraints": "",
            "description": ""
          },
          {
            "name": "updated_at",
            "data_type": "TIMESTAMP",
            "constraints": "",
            "description": ""
          }
        ]
      },
      {
        "name": "port_calls",
        "description": "",
        "columns": [
          {
            "name": "port_call_id",
            "data_type": "VARCHAR(255)",
            "constraints": "PRIMARY KEY",
            "description": ""
          },
          {
            "name": "vessel_id",
            "data_type": "VARCHAR(255)",
            "constraints": "NOT NULL",
            "description": ""
          },
          {
            "name": "port_id",
            "data_type": "VARCHAR(255)",
            "constraints": "NOT NULL",
            "description": ""
          },
          {
            "name": "voyage_number",
            "data_type": "VARCHAR(100)",
            "constraints": "",
            "description": ""
          },
          {
            "name": "route_id",
            "data_type": "VARCHAR(255)",
            "constraints": "",
            "description": ""
          },
          {
            "name": "scheduled_arrival",
            "data_type": "TIMESTAMP",
            "constraints": "",
            "description": ""
          },
          {
            "name": "actual_arrival",
            "data_type": "TIMESTAMP",
            "constraints": "",
            "description": ""
          },
          {
            "name": "scheduled_departure",
            "data_type": "TIMESTAMP",
            "constraints": "",
            "description": ""
          },
          {
            "name": "actual_departure",
            "data_type": "TIMESTAMP",
            "constraints": "",
            "description": ""
          },
          {
            "name": "port_call_type",
            "data_type": "VARCHAR(50)",
            "constraints": "",
            "description": "'Loading', 'Discharging', 'Transshipment', 'Bunkering', 'Repair'"
          },
          {
            "name": "berth_number",
            "data_type": "VARCHAR(50)",
            "constraints": "",
            "description": ""
          },
          {
            "name": "terminal_name",
            "data_type": "VARCHAR(255)",
            "constraints": "",
            "description": ""
          },
          {
            "name": "cargo_type",
            "data_type": "VARCHAR(100)",
            "constraints": "",
            "description": ""
          },
          {
            "name": "containers_loaded",
            "data_type": "INTEGER",
            "constraints": "",
            "description": ""
          },
          {
            "name": "containers_discharged",
            "data_type": "INTEGER",
            "constraints": "",
            "description": ""
          },
          {
            "name": "containers_transshipped",
            "data_type": "INTEGER",
            "constraints": "",
            "description": ""
          },
          {
            "name": "status",
            "data_type": "VARCHAR(50)",
            "constraints": "",
            "description": "'Scheduled', 'In Progress', 'Completed', 'Cancelled'"
          },
          {
            "name": "delay_hours",
            "data_type": "NUMERIC(8",
            "constraints": "",
            "description": ""
          },
          {
            "name": "data_source",
            "data_type": "VARCHAR(100)",
            "constraints": "",
            "description": "'AIS', 'NOAD', 'MARAD', 'Linescape', etc."
          },
          {
            "name": "created_at",
            "data_type": "TIMESTAMP",
            "constraints": "",
            "description": ""
          },
          {
            "name": "updated_at",
            "data_type": "TIMESTAMP",
            "constraints": "",
            "description": ""
          }
        ]
      },
      {
        "name": "sailings",
        "description": "",
        "columns": [
          {
            "name": "sailing_id",
            "data_type": "VARCHAR(255)",
            "constraints": "PRIMARY KEY",
            "description": ""
          },
          {
            "name": "vessel_id",
            "data_type": "VARCHAR(255)",
            "constraints": "NOT NULL",
            "description": ""
          },
          {
            "name": "voyage_number",
            "data_type": "VARCHAR(100)",
            "constraints": "",
            "description": ""
          },
          {
            "name": "route_id",
            "data_type": "VARCHAR(255)",
            "constraints": "",
            "description": ""
          },
          {
            "name": "origin_port_id",
            "data_type": "VARCHAR(255)",
            "constraints": "NOT NULL",
            "description": ""
          },
          {
            "name": "destination_port_id",
            "data_type": "VARCHAR(255)",
            "constraints": "NOT NULL",
            "description": ""
          },
          {
            "name": "scheduled_departure",
            "data_type": "TIMESTAMP",
            "constraints": "",
            "description": ""
          },
          {
            "name": "actual_departure",
            "data_type": "TIMESTAMP",
            "constraints": "",
            "description": ""
          },
          {
            "name": "scheduled_arrival",
            "data_type": "TIMESTAMP",
            "constraints": "",
            "description": ""
          },
          {
            "name": "actual_arrival",
            "data_type": "TIMESTAMP",
            "constraints": "",
            "description": ""
          },
          {
            "name": "transit_days",
            "data_type": "INTEGER",
            "constraints": "",
            "description": ""
          },
          {
            "name": "distance_nautical_miles",
            "data_type": "NUMERIC(10",
            "constraints": "",
            "description": ""
          },
          {
            "name": "average_speed_knots",
            "data_type": "NUMERIC(6",
            "constraints": "",
            "description": ""
          },
          {
            "name": "cargo_type",
            "data_type": "VARCHAR(100)",
            "constraints": "",
            "description": ""
          },
          {
            "name": "total_containers",
            "data_type": "INTEGER",
            "constraints": "",
            "description": ""
          },
          {
            "name": "total_teu",
            "data_type": "NUMERIC(10",
            "constraints": "",
            "description": ""
          },
          {
            "name": "capacity_utilization_percent",
            "data_type": "NUMERIC(5",
            "constraints": "",
            "description": ""
          },
          {
            "name": "transshipment_count",
            "data_type": "INTEGER",
            "constraints": "",
            "description": ""
          },
          {
            "name": "status",
            "data_type": "VARCHAR(50)",
            "constraints": "",
            "description": "'Scheduled', 'In Transit', 'Completed', 'Cancelled'"
          },
          {
            "name": "data_source",
            "data_type": "VARCHAR(100)",
            "constraints": "",
            "description": ""
          },
          {
            "name": "created_at",
            "data_type": "TIMESTAMP",
            "constraints": "",
            "description": ""
          },
          {
            "name": "updated_at",
            "data_type": "TIMESTAMP",
            "constraints": "",
            "description": ""
          }
        ]
      },
      {
        "name": "voyages",
        "description": "",
        "columns": [
          {
            "name": "voyage_id",
            "data_type": "VARCHAR(255)",
            "constraints": "PRIMARY KEY",
            "description": ""
          },
          {
            "name": "vessel_id",
            "data_type": "VARCHAR(255)",
            "constraints": "NOT NULL",
            "description": ""
          },
          {
            "name": "voyage_number",
            "data_type": "VARCHAR(100)",
            "constraints": "NOT NULL",
            "description": ""
          },
          {
            "name": "route_id",
            "data_type": "VARCHAR(255)",
            "constraints": "",
            "description": ""
          },
          {
            "name": "start_port_id",
            "data_type": "VARCHAR(255)",
            "constraints": "NOT NULL",
            "description": ""
          },
          {
            "name": "end_port_id",
            "data_type": "VARCHAR(255)",
            "constraints": "NOT NULL",
            "description": ""
          },
          {
            "name": "start_date",
            "data_type": "TIMESTAMP",
            "constraints": "NOT NULL",
            "description": ""
          },
          {
            "name": "end_date",
            "data_type": "TIMESTAMP",
            "constraints": "",
            "description": ""
          },
          {
            "name": "total_distance_nautical_miles",
            "data_type": "NUMERIC(10",
            "constraints": "",
            "description": ""
          },
          {
            "name": "total_transit_days",
            "data_type": "INTEGER",
            "constraints": "",
            "description": ""
          },
          {
            "name": "port_call_count",
            "data_type": "INTEGER",
            "constraints": "",
            "description": ""
          },
          {
            "name": "transshipment_count",
            "data_type": "INTEGER",
            "constraints": "",
            "description": ""
          },
          {
            "name": "total_containers",
            "data_type": "INTEGER",
            "constraints": "",
            "description": ""
          },
          {
            "name": "total_teu",
            "data_type": "NUMERIC(10",
            "constraints": "",
            "description": ""
          },
          {
            "name": "status",
            "data_type": "VARCHAR(50)",
            "constraints": "",
            "description": "'Scheduled', 'In Progress', 'Completed', 'Cancelled'"
          },
          {
            "name": "created_at",
            "data_type": "TIMESTAMP",
            "constraints": "",
            "description": ""
          },
          {
            "name": "updated_at",
            "data_type": "TIMESTAMP",
            "constraints": "",
            "description": ""
          }
        ]
      },
      {
        "name": "voyage_port_calls",
        "description": "",
        "columns": [
          {
            "name": "voyage_port_call_id",
            "data_type": "VARCHAR(255)",
            "constraints": "PRIMARY KEY",
            "description": ""
          },
          {
            "name": "voyage_id",
            "data_type": "VARCHAR(255)",
            "constraints": "NOT NULL",
            "description": ""
          },
          {
            "name": "port_call_id",
            "data_type": "VARCHAR(255)",
            "constraints": "NOT NULL",
            "description": ""
          },
          {
            "name": "port_sequence",
            "data_type": "INTEGER",
            "constraints": "NOT NULL",
            "description": "Order of port call in voyage"
          },
          {
            "name": "created_at",
            "data_type": "TIMESTAMP",
            "constraints": "",
            "description": ""
          }
        ]
      },
      {
        "name": "vessel_tracking",
        "description": "",
        "columns": [
          {
            "name": "tracking_id",
            "data_type": "VARCHAR(255)",
            "constraints": "PRIMARY KEY",
            "description": ""
          },
          {
            "name": "vessel_id",
            "data_type": "VARCHAR(255)",
            "constraints": "NOT NULL",
            "description": ""
          },
          {
            "name": "mmsi",
            "data_type": "VARCHAR(9)",
            "constraints": "",
            "description": ""
          },
          {
            "name": "timestamp",
            "data_type": "TIMESTAMP",
            "constraints": "NOT NULL",
            "description": ""
          },
          {
            "name": "latitude",
            "data_type": "NUMERIC(10",
            "constraints": "NOT NULL",
            "description": ""
          },
          {
            "name": "longitude",
            "data_type": "NUMERIC(10",
            "constraints": "NOT NULL",
            "description": ""
          },
          {
            "name": "position_geom",
            "data_type": "GEOGRAPHY",
            "constraints": "",
            "description": "Point geometry for vessel position"
          },
          {
            "name": "speed_knots",
            "data_type": "NUMERIC(6",
            "constraints": "",
            "description": ""
          },
          {
            "name": "course_degrees",
            "data_type": "NUMERIC(6",
            "constraints": "",
            "description": ""
          },
          {
            "name": "heading_degrees",
            "data_type": "NUMERIC(6",
            "constraints": "",
            "description": ""
          },
          {
            "name": "navigation_status",
            "data_type": "VARCHAR(50)",
            "constraints": "",
            "description": "'Under way', 'At anchor', 'Moored', etc."
          },
          {
            "name": "destination",
            "data_type": "VARCHAR(255)",
            "constraints": "",
            "description": ""
          },
          {
            "name": "eta",
            "data_type": "TIMESTAMP",
            "constraints": "",
            "description": "Estimated time of arrival"
          },
          {
            "name": "draught_meters",
            "data_type": "NUMERIC(6",
            "constraints": "",
            "description": ""
          },
          {
            "name": "cargo_type",
            "data_type": "VARCHAR(100)",
            "constraints": "",
            "description": ""
          },
          {
            "name": "data_source",
            "data_type": "VARCHAR(100)",
            "constraints": "",
            "description": "'AIS', 'USCG', 'NOAA', etc."
          },
          {
            "name": "data_quality",
            "data_type": "VARCHAR(50)",
            "constraints": "",
            "description": "'High', 'Medium', 'Low'"
          },
          {
            "name": "created_at",
            "data_type": "TIMESTAMP",
            "constraints": "",
            "description": ""
          }
        ]
      },
      {
        "name": "port_statistics",
        "description": "",
        "columns": [
          {
            "name": "statistic_id",
            "data_type": "VARCHAR(255)",
            "constraints": "PRIMARY KEY",
            "description": ""
          },
          {
            "name": "port_id",
            "data_type": "VARCHAR(255)",
            "constraints": "NOT NULL",
            "description": ""
          },
          {
            "name": "statistic_date",
            "data_type": "DATE",
            "constraints": "NOT NULL",
            "description": ""
          },
          {
            "name": "statistic_period",
            "data_type": "VARCHAR(50)",
            "constraints": "",
            "description": "'Daily', 'Weekly', 'Monthly', 'Yearly'"
          },
          {
            "name": "total_vessel_calls",
            "data_type": "INTEGER",
            "constraints": "",
            "description": ""
          },
          {
            "name": "total_container_teu",
            "data_type": "NUMERIC(12",
            "constraints": "",
            "description": ""
          },
          {
            "name": "containers_loaded",
            "data_type": "INTEGER",
            "constraints": "",
            "description": ""
          },
          {
            "name": "containers_discharged",
            "data_type": "INTEGER",
            "constraints": "",
            "description": ""
          },
          {
            "name": "containers_transshipped",
            "data_type": "INTEGER",
            "constraints": "",
            "description": ""
          },
          {
            "name": "average_vessel_size_teu",
            "data_type": "NUMERIC(10",
            "constraints": "",
            "description": ""
          },
          {
            "name": "average_dwell_time_hours",
            "data_type": "NUMERIC(8",
            "constraints": "",
            "description": ""
          },
          {
            "name": "berth_utilization_percent",
            "data_type": "NUMERIC(5",
            "constraints": "",
            "description": ""
          },
          {
            "name": "crane_utilization_percent",
            "data_type": "NUMERIC(5",
            "constraints": "",
            "description": ""
          },
          {
            "name": "data_source",
            "data_type": "VARCHAR(100)",
            "constraints": "",
            "description": "'MARAD', 'Port Authority', 'Linescape', etc."
          },
          {
            "name": "created_at",
            "data_type": "TIMESTAMP",
            "constraints": "",
            "description": ""
          },
          {
            "name": "updated_at",
            "data_type": "TIMESTAMP",
            "constraints": "",
            "description": ""
          }
        ]
      },
      {
        "name": "carrier_performance",
        "description": "",
        "columns": [
          {
            "name": "performance_id",
            "data_type": "VARCHAR(255)",
            "constraints": "PRIMARY KEY",
            "description": ""
          },
          {
            "name": "carrier_id",
            "data_type": "VARCHAR(255)",
            "constraints": "NOT NULL",
            "description": ""
          },
          {
            "name": "evaluation_period_start",
            "data_type": "DATE",
            "constraints": "NOT NULL",
            "description": ""
          },
          {
            "name": "evaluation_period_end",
            "data_type": "DATE",
            "constraints": "NOT NULL",
            "description": ""
          },
          {
            "name": "total_voyages",
            "data_type": "INTEGER",
            "constraints": "",
            "description": ""
          },
          {
            "name": "on_time_departures",
            "data_type": "INTEGER",
            "constraints": "",
            "description": ""
          },
          {
            "name": "on_time_arrivals",
            "data_type": "INTEGER",
            "constraints": "",
            "description": ""
          },
          {
            "name": "on_time_performance_percent",
            "data_type": "NUMERIC(5",
            "constraints": "",
            "description": ""
          },
          {
            "name": "average_transit_time_days",
            "data_type": "NUMERIC(8",
            "constraints": "",
            "description": ""
          },
          {
            "name": "vessel_utilization_percent",
            "data_type": "NUMERIC(5",
            "constraints": "",
            "description": ""
          },
          {
            "name": "capacity_utilization_percent",
            "data_type": "NUMERIC(5",
            "constraints": "",
            "description": ""
          },
          {
            "name": "total_teu_carried",
            "data_type": "NUMERIC(12",
            "constraints": "",
            "description": ""
          },
          {
            "name": "port_calls_count",
            "data_type": "INTEGER",
            "constraints": "",
            "description": ""
          },
          {
            "name": "route_coverage_count",
            "data_type": "INTEGER",
            "constraints": "",
            "description": ""
          },
          {
            "name": "customer_satisfaction_score",
            "data_type": "NUMERIC(5",
            "constraints": "",
            "description": ""
          },
          {
            "name": "created_at",
            "data_type": "TIMESTAMP",
            "constraints": "",
            "description": ""
          },
          {
            "name": "CREATE",
            "data_type": "INDEX",
            "constraints": "",
            "description": ""
          },
          {
            "name": "CREATE",
            "data_type": "INDEX",
            "constraints": "",
            "description": ""
          },
          {
            "name": "CREATE",
            "data_type": "INDEX",
            "constraints": "",
            "description": ""
          },
          {
            "name": "CREATE",
            "data_type": "INDEX",
            "constraints": "",
            "description": ""
          },
          {
            "name": "CREATE",
            "data_type": "INDEX",
            "constraints": "",
            "description": ""
          },
          {
            "name": "CREATE",
            "data_type": "INDEX",
            "constraints": "",
            "description": ""
          },
          {
            "name": "CREATE",
            "data_type": "INDEX",
            "constraints": "",
            "description": ""
          },
          {
            "name": "CREATE",
            "data_type": "INDEX",
            "constraints": "",
            "description": ""
          },
          {
            "name": "CREATE",
            "data_type": "INDEX",
            "constraints": "",
            "description": ""
          },
          {
            "name": "CREATE",
            "data_type": "INDEX",
            "constraints": "",
            "description": ""
          },
          {
            "name": "CREATE",
            "data_type": "INDEX",
            "constraints": "",
            "description": ""
          },
          {
            "name": "CREATE",
            "data_type": "INDEX",
            "constraints": "",
            "description": ""
          },
          {
            "name": "CREATE",
            "data_type": "INDEX",
            "constraints": "",
            "description": ""
          },
          {
            "name": "CREATE",
            "data_type": "INDEX",
            "constraints": "",
            "description": ""
          },
          {
            "name": "CREATE",
            "data_type": "INDEX",
            "constraints": "",
            "description": ""
          },
          {
            "name": "CREATE",
            "data_type": "INDEX",
            "constraints": "",
            "description": ""
          },
          {
            "name": "CREATE",
            "data_type": "INDEX",
            "constraints": "",
            "description": ""
          },
          {
            "name": "CREATE",
            "data_type": "INDEX",
            "constraints": "",
            "description": ""
          },
          {
            "name": "CREATE",
            "data_type": "INDEX",
            "constraints": "",
            "description": ""
          },
          {
            "name": "CREATE",
            "data_type": "INDEX",
            "constraints": "",
            "description": ""
          },
          {
            "name": "CREATE",
            "data_type": "INDEX",
            "constraints": "",
            "description": ""
          },
          {
            "name": "CREATE",
            "data_type": "INDEX",
            "constraints": "",
            "description": ""
          },
          {
            "name": "CREATE",
            "data_type": "INDEX",
            "constraints": "",
            "description": ""
          },
          {
            "name": "CREATE",
            "data_type": "INDEX",
            "constraints": "",
            "description": ""
          },
          {
            "name": "CREATE",
            "data_type": "INDEX",
            "constraints": "",
            "description": ""
          },
          {
            "name": "CREATE",
            "data_type": "INDEX",
            "constraints": "",
            "description": ""
          },
          {
            "name": "CREATE",
            "data_type": "INDEX",
            "constraints": "",
            "description": ""
          },
          {
            "name": "CREATE",
            "data_type": "INDEX",
            "constraints": "",
            "description": ""
          },
          {
            "name": "CREATE",
            "data_type": "INDEX",
            "constraints": "",
            "description": ""
          },
          {
            "name": "CREATE",
            "data_type": "INDEX",
            "constraints": "",
            "description": ""
          },
          {
            "name": "CREATE",
            "data_type": "INDEX",
            "constraints": "",
            "description": ""
          },
          {
            "name": "CREATE",
            "data_type": "INDEX",
            "constraints": "",
            "description": ""
          }
        ]
      }
    ]
  },
  "queries": [
    {
      "number": 1,
      "title": "Production-Grade Vessel Position Tracking Analysis with Multi-Level CTE Nesting and Temporal Analytics",
      "description": "Use Case: Real-Time Vessel Monitoring - Comprehensive Vessel Position Tracking and Route Deviation Analysis for Maritime Operations Description: Enterprise-level vessel position tracking analysis with multi-level CTE nesting, temporal analysis, route deviation detection, speed analysis, and advanced window functions. Demonstrates production patterns used by maritime intelligence platforms like Linescape, MarineTraffic, and VesselFinder. Business Value: Real-time vessel position report showing cu",
      "complexity": "Deep nested CTEs (7+ levels), temporal analysis, spatial operations (ST_DISTANCE, ST_BEARING), complex aggregations, window functions with multiple frame clauses, route deviation algorithms, speed calculations, navigation status analysis",
      "expected_output": "Vessel position tracking report with current positions, speeds, courses, route deviations, and navigation status for active vessels.",
      "sql": "WITH vessel_tracking_cohorts AS (\n    -- First CTE: Identify vessel tracking cohorts and time windows\n    SELECT\n        vt.tracking_id,\n        vt.vessel_id,\n        vt.mmsi,\n        vt.timestamp,\n        vt.latitude,\n        vt.longitude,\n        vt.position_geom,\n        vt.speed_knots,\n        vt.course_degrees,\n        vt.heading_degrees,\n        vt.navigation_status,\n        vt.destination,\n        vt.eta,\n        v.vessel_name,\n        v.imo_number,\n        v.carrier_id,\n        c.carrier_name,\n        DATE_TRUNC('hour', vt.timestamp) AS tracking_hour,\n        DATE_TRUNC('day', vt.timestamp) AS tracking_date,\n        EXTRACT(HOUR FROM vt.timestamp) AS tracking_hour_num,\n        EXTRACT(EPOCH FROM (CURRENT_TIMESTAMP - vt.timestamp)) / 3600 AS hours_since_update\n    FROM vessel_tracking vt\n    INNER JOIN vessels v ON vt.vessel_id = v.vessel_id\n    LEFT JOIN carriers c ON v.carrier_id = c.carrier_id\n    WHERE vt.timestamp >= CURRENT_TIMESTAMP - INTERVAL '7 days'\n        AND vt.data_quality = 'High'\n),\nvessel_position_sequences AS (\n    -- Second CTE: Create position sequences for each vessel with temporal ordering\n    SELECT\n        vtc.tracking_id,\n        vtc.vessel_id,\n        vtc.mmsi,\n        vtc.vessel_name,\n        vtc.imo_number,\n        vtc.carrier_id,\n        vtc.carrier_name,\n        vtc.timestamp,\n        vtc.tracking_hour,\n        vtc.tracking_date,\n        vtc.latitude,\n        vtc.longitude,\n        vtc.position_geom,\n        vtc.speed_knots,\n        vtc.course_degrees,\n        vtc.heading_degrees,\n        vtc.navigation_status,\n        vtc.destination,\n        vtc.eta,\n        vtc.hours_since_update,\n        -- Previous position for distance calculation\n        LAG(vtc.position_geom, 1) OVER (\n            PARTITION BY vtc.vessel_id\n            ORDER BY vtc.timestamp\n        ) AS prev_position_geom,\n        LAG(vtc.timestamp, 1) OVER (\n            PARTITION BY vtc.vessel_id\n            ORDER BY vtc.timestamp\n        ) AS prev_timestamp,\n        LAG(vtc.latitude, 1) OVER (\n            PARTITION BY vtc.vessel_id\n            ORDER BY vtc.timestamp\n        ) AS prev_latitude,\n        LAG(vtc.longitude, 1) OVER (\n            PARTITION BY vtc.vessel_id\n            ORDER BY vtc.timestamp\n        ) AS prev_longitude,\n        -- Next position for forward-looking analysis\n        LEAD(vtc.position_geom, 1) OVER (\n            PARTITION BY vtc.vessel_id\n            ORDER BY vtc.timestamp\n        ) AS next_position_geom,\n        LEAD(vtc.timestamp, 1) OVER (\n            PARTITION BY vtc.vessel_id\n            ORDER BY vtc.timestamp\n        ) AS next_timestamp,\n        -- Position sequence number\n        ROW_NUMBER() OVER (\n            PARTITION BY vtc.vessel_id\n            ORDER BY vtc.timestamp\n        ) AS position_sequence\n    FROM vessel_tracking_cohorts vtc\n),\nvessel_movement_calculations AS (\n    -- Third CTE: Calculate vessel movements, distances, and speeds\n    SELECT\n        vps.tracking_id,\n        vps.vessel_id,\n        vps.mmsi,\n        vps.vessel_name,\n        vps.imo_number,\n        vps.carrier_id,\n        vps.carrier_name,\n        vps.timestamp,\n        vps.tracking_hour,\n        vps.tracking_date,\n        vps.latitude,\n        vps.longitude,\n        vps.position_geom,\n        vps.speed_knots AS reported_speed_knots,\n        vps.course_degrees AS reported_course_degrees,\n        vps.heading_degrees AS reported_heading_degrees,\n        vps.navigation_status,\n        vps.destination,\n        vps.eta,\n        vps.hours_since_update,\n        vps.position_sequence,\n        -- Calculate distance from previous position\n        CASE\n            WHEN vps.prev_position_geom IS NOT NULL AND vps.position_geom IS NOT NULL THEN\n                ST_DISTANCE(vps.prev_position_geom, vps.position_geom) / 1852.0  -- Convert meters to nautical miles\n            ELSE NULL\n        END AS distance_nm_from_prev,\n        -- Calculate time difference\n        CASE\n            WHEN vps.prev_timestamp IS NOT NULL THEN\n                EXTRACT(EPOCH FROM (vps.timestamp - vps.prev_timestamp)) / 3600.0  -- Hours\n            ELSE NULL\n        END AS time_hours_from_prev,\n        -- Calculate calculated speed (distance/time)\n        CASE\n            WHEN vps.prev_position_geom IS NOT NULL \n                AND vps.position_geom IS NOT NULL \n                AND vps.prev_timestamp IS NOT NULL \n                AND EXTRACT(EPOCH FROM (vps.timestamp - vps.prev_timestamp)) > 0 THEN\n                (ST_DISTANCE(vps.prev_position_geom, vps.position_geom) / 1852.0) / \n                (EXTRACT(EPOCH FROM (vps.timestamp - vps.prev_timestamp)) / 3600.0)\n            ELSE NULL\n        END AS calculated_speed_knots,\n        -- Calculate bearing from previous position\n        CASE\n            WHEN vps.prev_latitude IS NOT NULL \n                AND vps.prev_longitude IS NOT NULL \n                AND vps.latitude IS NOT NULL \n                AND vps.longitude IS NOT NULL THEN\n                DEGREES(\n                    ATAN2(\n                        SIN(RADIANS(vps.longitude - vps.prev_longitude)) * COS(RADIANS(vps.latitude)),\n                        COS(RADIANS(vps.prev_latitude)) * SIN(RADIANS(vps.latitude)) - \n                        SIN(RADIANS(vps.prev_latitude)) * COS(RADIANS(vps.latitude)) * \n                        COS(RADIANS(vps.longitude - vps.prev_longitude))\n                    )\n                )\n            ELSE NULL\n        END AS calculated_course_degrees\n    FROM vessel_position_sequences vps\n),\nvessel_route_deviations AS (\n    -- Fourth CTE: Detect route deviations by comparing actual positions with planned routes\n    SELECT\n        vmc.tracking_id,\n        vmc.vessel_id,\n        vmc.mmsi,\n        vmc.vessel_name,\n        vmc.imo_number,\n        vmc.carrier_id,\n        vmc.carrier_name,\n        vmc.timestamp,\n        vmc.tracking_hour,\n        vmc.tracking_date,\n        vmc.latitude,\n        vmc.longitude,\n        vmc.position_geom,\n        vmc.reported_speed_knots,\n        vmc.calculated_speed_knots,\n        vmc.reported_course_degrees,\n        vmc.calculated_course_degrees,\n        vmc.reported_heading_degrees,\n        vmc.navigation_status,\n        vmc.destination,\n        vmc.eta,\n        vmc.hours_since_update,\n        vmc.position_sequence,\n        vmc.distance_nm_from_prev,\n        vmc.time_hours_from_prev,\n        -- Find nearest planned route\n        (\n            SELECT r.route_id\n            FROM routes r\n            INNER JOIN route_ports rp ON r.route_id = rp.route_id\n            INNER JOIN ports p ON rp.port_id = p.port_id\n            WHERE r.carrier_id = vmc.carrier_id\n                AND r.status = 'Active'\n            ORDER BY \n                CASE\n                    WHEN p.port_geom IS NOT NULL AND vmc.position_geom IS NOT NULL THEN\n                        ST_DISTANCE(p.port_geom, vmc.position_geom)\n                    ELSE 999999999\n                END\n            LIMIT 1\n        ) AS nearest_route_id,\n        -- Calculate distance to nearest port on route\n        (\n            SELECT MIN(\n                CASE\n                    WHEN p.port_geom IS NOT NULL AND vmc.position_geom IS NOT NULL THEN\n                        ST_DISTANCE(p.port_geom, vmc.position_geom) / 1852.0\n                    ELSE 999999999\n                END\n            )\n            FROM routes r\n            INNER JOIN route_ports rp ON r.route_id = rp.route_id\n            INNER JOIN ports p ON rp.port_id = p.port_id\n            WHERE r.carrier_id = vmc.carrier_id\n                AND r.status = 'Active'\n        ) AS distance_nm_to_nearest_route_port,\n        -- Speed deviation (reported vs calculated)\n        CASE\n            WHEN vmc.reported_speed_knots IS NOT NULL \n                AND vmc.calculated_speed_knots IS NOT NULL THEN\n                ABS(vmc.reported_speed_knots - vmc.calculated_speed_knots)\n            ELSE NULL\n        END AS speed_deviation_knots,\n        -- Course deviation (reported vs calculated)\n        CASE\n            WHEN vmc.reported_course_degrees IS NOT NULL \n                AND vmc.calculated_course_degrees IS NOT NULL THEN\n                ABS(\n                    CASE\n                        WHEN ABS(vmc.reported_course_degrees - vmc.calculated_course_degrees) > 180 THEN\n                            360 - ABS(vmc.reported_course_degrees - vmc.calculated_course_degrees)\n                        ELSE\n                            ABS(vmc.reported_course_degrees - vmc.calculated_course_degrees)\n                    END\n                )\n            ELSE NULL\n        END AS course_deviation_degrees\n    FROM vessel_movement_calculations vmc\n),\nvessel_operational_patterns AS (\n    -- Fifth CTE: Identify operational patterns with window functions\n    SELECT\n        vrd.tracking_id,\n        vrd.vessel_id,\n        vrd.mmsi,\n        vrd.vessel_name,\n        vrd.imo_number,\n        vrd.carrier_id,\n        vrd.carrier_name,\n        vrd.timestamp,\n        vrd.tracking_hour,\n        vrd.tracking_date,\n        vrd.latitude,\n        vrd.longitude,\n        vrd.position_geom,\n        vrd.reported_speed_knots,\n        vrd.calculated_speed_knots,\n        vrd.reported_course_degrees,\n        vrd.calculated_course_degrees,\n        vrd.reported_heading_degrees,\n        vrd.navigation_status,\n        vrd.destination,\n        vrd.eta,\n        vrd.hours_since_update,\n        vrd.position_sequence,\n        vrd.distance_nm_from_prev,\n        vrd.time_hours_from_prev,\n        vrd.nearest_route_id,\n        vrd.distance_nm_to_nearest_route_port,\n        vrd.speed_deviation_knots,\n        vrd.course_deviation_degrees,\n        -- Moving averages for speed\n        AVG(vrd.calculated_speed_knots) OVER (\n            PARTITION BY vrd.vessel_id\n            ORDER BY vrd.timestamp\n            ROWS BETWEEN 4 PRECEDING AND CURRENT ROW\n        ) AS moving_avg_speed_5,\n        AVG(vrd.calculated_speed_knots) OVER (\n            PARTITION BY vrd.vessel_id\n            ORDER BY vrd.timestamp\n            ROWS BETWEEN 9 PRECEDING AND CURRENT ROW\n        ) AS moving_avg_speed_10,\n        -- Speed variance\n        STDDEV(vrd.calculated_speed_knots) OVER (\n            PARTITION BY vrd.vessel_id\n            ORDER BY vrd.timestamp\n            ROWS BETWEEN 9 PRECEDING AND CURRENT ROW\n        ) AS speed_variance_10,\n        -- Total distance traveled\n        SUM(vrd.distance_nm_from_prev) OVER (\n            PARTITION BY vrd.vessel_id\n            ORDER BY vrd.timestamp\n            ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW\n        ) AS cumulative_distance_nm,\n        -- Time at sea\n        SUM(vrd.time_hours_from_prev) OVER (\n            PARTITION BY vrd.vessel_id\n            ORDER BY vrd.timestamp\n            ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW\n        ) AS cumulative_time_hours\n    FROM vessel_route_deviations vrd\n),\nvessel_status_classification AS (\n    -- Sixth CTE: Classify vessel status and operational state\n    SELECT\n        vop.tracking_id,\n        vop.vessel_id,\n        vop.mmsi,\n        vop.vessel_name,\n        vop.imo_number,\n        vop.carrier_id,\n        vop.carrier_name,\n        vop.timestamp,\n        vop.tracking_hour,\n        vop.tracking_date,\n        vop.latitude,\n        vop.longitude,\n        vop.position_geom,\n        ROUND(CAST(vop.reported_speed_knots AS NUMERIC), 2) AS reported_speed_knots,\n        ROUND(CAST(vop.calculated_speed_knots AS NUMERIC), 2) AS calculated_speed_knots,\n        ROUND(CAST(vop.reported_course_degrees AS NUMERIC), 2) AS reported_course_degrees,\n        ROUND(CAST(vop.calculated_course_degrees AS NUMERIC), 2) AS calculated_course_degrees,\n        ROUND(CAST(vop.reported_heading_degrees AS NUMERIC), 2) AS reported_heading_degrees,\n        vop.navigation_status,\n        vop.destination,\n        vop.eta,\n        vop.hours_since_update,\n        vop.position_sequence,\n        ROUND(CAST(vop.distance_nm_from_prev AS NUMERIC), 2) AS distance_nm_from_prev,\n        ROUND(CAST(vop.time_hours_from_prev AS NUMERIC), 2) AS time_hours_from_prev,\n        vop.nearest_route_id,\n        ROUND(CAST(vop.distance_nm_to_nearest_route_port AS NUMERIC), 2) AS distance_nm_to_nearest_route_port,\n        ROUND(CAST(vop.speed_deviation_knots AS NUMERIC), 2) AS speed_deviation_knots,\n        ROUND(CAST(vop.course_deviation_degrees AS NUMERIC), 2) AS course_deviation_degrees,\n        ROUND(CAST(vop.moving_avg_speed_5 AS NUMERIC), 2) AS moving_avg_speed_5,\n        ROUND(CAST(vop.moving_avg_speed_10 AS NUMERIC), 2) AS moving_avg_speed_10,\n        ROUND(CAST(vop.speed_variance_10 AS NUMERIC), 2) AS speed_variance_10,\n        ROUND(CAST(vop.cumulative_distance_nm AS NUMERIC), 2) AS cumulative_distance_nm,\n        ROUND(CAST(vop.cumulative_time_hours AS NUMERIC), 2) AS cumulative_time_hours,\n        -- Operational status classification\n        CASE\n            WHEN vop.navigation_status IN ('Moored', 'At anchor') THEN 'Docked'\n            WHEN vop.calculated_speed_knots < 0.5 THEN 'Stationary'\n            WHEN vop.calculated_speed_knots < 5 THEN 'Slow Speed'\n            WHEN vop.calculated_speed_knots < 15 THEN 'Normal Speed'\n            WHEN vop.calculated_speed_knots >= 15 THEN 'High Speed'\n            ELSE 'Unknown'\n        END AS operational_status,\n        -- Route deviation classification\n        CASE\n            WHEN vop.distance_nm_to_nearest_route_port > 50 THEN 'Major Deviation'\n            WHEN vop.distance_nm_to_nearest_route_port > 20 THEN 'Moderate Deviation'\n            WHEN vop.distance_nm_to_nearest_route_port > 5 THEN 'Minor Deviation'\n            WHEN vop.distance_nm_to_nearest_route_port <= 5 THEN 'On Route'\n            ELSE 'Unknown'\n        END AS route_deviation_status,\n        -- Data freshness classification\n        CASE\n            WHEN vop.hours_since_update < 1 THEN 'Very Recent'\n            WHEN vop.hours_since_update < 6 THEN 'Recent'\n            WHEN vop.hours_since_update < 24 THEN 'Stale'\n            ELSE 'Very Stale'\n        END AS data_freshness_status\n    FROM vessel_operational_patterns vop\n)\nSELECT\n    vessel_id,\n    mmsi,\n    vessel_name,\n    imo_number,\n    carrier_id,\n    carrier_name,\n    timestamp,\n    latitude,\n    longitude,\n    reported_speed_knots,\n    calculated_speed_knots,\n    reported_course_degrees,\n    calculated_course_degrees,\n    reported_heading_degrees,\n    navigation_status,\n    destination,\n    eta,\n    hours_since_update,\n    distance_nm_from_prev,\n    time_hours_from_prev,\n    nearest_route_id,\n    distance_nm_to_nearest_route_port,\n    speed_deviation_knots,\n    course_deviation_degrees,\n    moving_avg_speed_5,\n    moving_avg_speed_10,\n    speed_variance_10,\n    cumulative_distance_nm,\n    cumulative_time_hours,\n    operational_status,\n    route_deviation_status,\n    data_freshness_status\nFROM vessel_status_classification\nWHERE hours_since_update < 24\nORDER BY timestamp DESC, vessel_id\nLIMIT 10000;",
      "line_number": 60
    },
    {
      "number": 2,
      "title": "Port Call Performance Analysis with Delay Detection and On-Time Performance Metrics",
      "description": "Use Case: Port Operations Optimization - Comprehensive Port Call Performance Analysis with Delay Detection for Terminal Efficiency Description: Enterprise-level port call performance analysis with multi-level CTE nesting, delay detection algorithms, on-time performance calculations, dwell time analysis, and advanced window functions. Demonstrates production patterns used by port authorities and terminal operators for operational efficiency monitoring. Business Value: Port call performance report",
      "complexity": "Deep nested CTEs (7+ levels), temporal analysis, delay calculations, window functions with multiple frame clauses, percentile calculations, time-series analysis, performance scoring algorithms",
      "expected_output": "Port call performance report with delay metrics, on-time performance rates, dwell times, and operational efficiency classifications.",
      "sql": "WITH port_call_cohorts AS (\n    -- First CTE: Identify port call cohorts and time windows\n    SELECT\n        pc.port_call_id,\n        pc.vessel_id,\n        pc.port_id,\n        pc.voyage_number,\n        pc.route_id,\n        pc.scheduled_arrival,\n        pc.actual_arrival,\n        pc.scheduled_departure,\n        pc.actual_departure,\n        pc.port_call_type,\n        pc.containers_loaded,\n        pc.containers_discharged,\n        pc.containers_transshipped,\n        pc.status,\n        v.vessel_name,\n        v.imo_number,\n        v.carrier_id,\n        c.carrier_name,\n        p.port_name,\n        p.port_code,\n        p.locode,\n        DATE_TRUNC('day', pc.scheduled_arrival) AS scheduled_arrival_date,\n        DATE_TRUNC('hour', pc.scheduled_arrival) AS scheduled_arrival_hour,\n        DATE_TRUNC('day', pc.actual_arrival) AS actual_arrival_date,\n        DATE_TRUNC('hour', pc.actual_arrival) AS actual_arrival_hour\n    FROM port_calls pc\n    INNER JOIN vessels v ON pc.vessel_id = v.vessel_id\n    LEFT JOIN carriers c ON v.carrier_id = c.carrier_id\n    INNER JOIN ports p ON pc.port_id = p.port_id\n    WHERE pc.scheduled_arrival IS NOT NULL\n        AND pc.status IN ('Completed', 'In Progress')\n),\nport_call_delay_calculations AS (\n    -- Second CTE: Calculate delays and time differences\n    SELECT\n        pcc.port_call_id,\n        pcc.vessel_id,\n        pcc.port_id,\n        pcc.voyage_number,\n        pcc.route_id,\n        pcc.vessel_name,\n        pcc.imo_number,\n        pcc.carrier_id,\n        pcc.carrier_name,\n        pcc.port_name,\n        pcc.port_code,\n        pcc.locode,\n        pcc.scheduled_arrival,\n        pcc.actual_arrival,\n        pcc.scheduled_departure,\n        pcc.actual_departure,\n        pcc.port_call_type,\n        pcc.containers_loaded,\n        pcc.containers_discharged,\n        pcc.containers_transshipped,\n        pcc.status,\n        pcc.scheduled_arrival_date,\n        pcc.actual_arrival_date,\n        -- Arrival delay calculation (in hours)\n        CASE\n            WHEN pcc.actual_arrival IS NOT NULL AND pcc.scheduled_arrival IS NOT NULL THEN\n                EXTRACT(EPOCH FROM (pcc.actual_arrival - pcc.scheduled_arrival)) / 3600.0\n            ELSE NULL\n        END AS arrival_delay_hours,\n        -- Departure delay calculation (in hours)\n        CASE\n            WHEN pcc.actual_departure IS NOT NULL AND pcc.scheduled_departure IS NOT NULL THEN\n                EXTRACT(EPOCH FROM (pcc.actual_departure - pcc.scheduled_departure)) / 3600.0\n            ELSE NULL\n        END AS departure_delay_hours,\n        -- Dwell time calculation (time at port)\n        CASE\n            WHEN pcc.actual_arrival IS NOT NULL AND pcc.actual_departure IS NOT NULL THEN\n                EXTRACT(EPOCH FROM (pcc.actual_departure - pcc.actual_arrival)) / 3600.0\n            WHEN pcc.actual_arrival IS NOT NULL AND pcc.scheduled_departure IS NOT NULL THEN\n                EXTRACT(EPOCH FROM (pcc.scheduled_departure - pcc.actual_arrival)) / 3600.0\n            ELSE NULL\n        END AS dwell_time_hours,\n        -- Scheduled dwell time\n        CASE\n            WHEN pcc.scheduled_arrival IS NOT NULL AND pcc.scheduled_departure IS NOT NULL THEN\n                EXTRACT(EPOCH FROM (pcc.scheduled_departure - pcc.scheduled_arrival)) / 3600.0\n            ELSE NULL\n        END AS scheduled_dwell_time_hours,\n        -- Total containers handled\n        COALESCE(pcc.containers_loaded, 0) + COALESCE(pcc.containers_discharged, 0) + COALESCE(pcc.containers_transshipped, 0) AS total_containers_handled\n    FROM port_call_cohorts pcc\n),\nport_call_performance_metrics AS (\n    -- Third CTE: Calculate performance metrics with window functions\n    SELECT\n        pcdc.port_call_id,\n        pcdc.vessel_id,\n        pcdc.port_id,\n        pcdc.voyage_number,\n        pcdc.route_id,\n        pcdc.vessel_name,\n        pcdc.imo_number,\n        pcdc.carrier_id,\n        pcdc.carrier_name,\n        pcdc.port_name,\n        pcdc.port_code,\n        pcdc.locode,\n        pcdc.scheduled_arrival,\n        pcdc.actual_arrival,\n        pcdc.scheduled_departure,\n        pcdc.actual_departure,\n        pcdc.port_call_type,\n        pcdc.total_containers_handled,\n        pcdc.arrival_delay_hours,\n        pcdc.departure_delay_hours,\n        pcdc.dwell_time_hours,\n        pcdc.scheduled_dwell_time_hours,\n        -- Dwell time variance\n        CASE\n            WHEN pcdc.dwell_time_hours IS NOT NULL AND pcdc.scheduled_dwell_time_hours IS NOT NULL THEN\n                pcdc.dwell_time_hours - pcdc.scheduled_dwell_time_hours\n            ELSE NULL\n        END AS dwell_time_variance_hours,\n        -- On-time arrival indicator\n        CASE\n            WHEN pcdc.arrival_delay_hours IS NOT NULL THEN\n                CASE\n                    WHEN pcdc.arrival_delay_hours <= 0 THEN TRUE\n                    WHEN ABS(pcdc.arrival_delay_hours) <= 2 THEN TRUE  -- Within 2 hours considered on-time\n                    ELSE FALSE\n                END\n            ELSE NULL\n        END AS on_time_arrival,\n        -- On-time departure indicator\n        CASE\n            WHEN pcdc.departure_delay_hours IS NOT NULL THEN\n                CASE\n                    WHEN pcdc.departure_delay_hours <= 0 THEN TRUE\n                    WHEN ABS(pcdc.departure_delay_hours) <= 2 THEN TRUE\n                    ELSE FALSE\n                END\n            ELSE NULL\n        END AS on_time_departure,\n        -- Moving averages for port performance\n        AVG(pcdc.arrival_delay_hours) OVER (\n            PARTITION BY pcdc.port_id\n            ORDER BY pcdc.scheduled_arrival\n            ROWS BETWEEN 29 PRECEDING AND CURRENT ROW\n        ) AS port_moving_avg_arrival_delay_30,\n        AVG(pcdc.dwell_time_hours) OVER (\n            PARTITION BY pcdc.port_id\n            ORDER BY pcdc.scheduled_arrival\n            ROWS BETWEEN 29 PRECEDING AND CURRENT ROW\n        ) AS port_moving_avg_dwell_time_30,\n        -- Carrier performance metrics\n        AVG(pcdc.arrival_delay_hours) OVER (\n            PARTITION BY pcdc.carrier_id\n            ORDER BY pcdc.scheduled_arrival\n            ROWS BETWEEN 29 PRECEDING AND CURRENT ROW\n        ) AS carrier_moving_avg_arrival_delay_30,\n        -- Percentile rankings\n        PERCENT_RANK() OVER (\n            PARTITION BY pcdc.port_id\n            ORDER BY pcdc.arrival_delay_hours\n        ) AS arrival_delay_percentile_rank,\n        PERCENT_RANK() OVER (\n            PARTITION BY pcdc.port_id\n            ORDER BY pcdc.dwell_time_hours\n        ) AS dwell_time_percentile_rank\n    FROM port_call_delay_calculations pcdc\n),\nport_call_classification AS (\n    -- Fourth CTE: Classify port calls by performance\n    SELECT\n        pcpm.port_call_id,\n        pcpm.vessel_id,\n        pcpm.port_id,\n        pcpm.voyage_number,\n        pcpm.route_id,\n        pcpm.vessel_name,\n        pcpm.imo_number,\n        pcpm.carrier_id,\n        pcpm.carrier_name,\n        pcpm.port_name,\n        pcpm.port_code,\n        pcpm.locode,\n        pcpm.scheduled_arrival,\n        pcpm.actual_arrival,\n        pcpm.scheduled_departure,\n        pcpm.actual_departure,\n        pcpm.port_call_type,\n        pcpm.total_containers_handled,\n        ROUND(CAST(pcpm.arrival_delay_hours AS NUMERIC), 2) AS arrival_delay_hours,\n        ROUND(CAST(pcpm.departure_delay_hours AS NUMERIC), 2) AS departure_delay_hours,\n        ROUND(CAST(pcpm.dwell_time_hours AS NUMERIC), 2) AS dwell_time_hours,\n        ROUND(CAST(pcpm.scheduled_dwell_time_hours AS NUMERIC), 2) AS scheduled_dwell_time_hours,\n        ROUND(CAST(pcpm.dwell_time_variance_hours AS NUMERIC), 2) AS dwell_time_variance_hours,\n        pcpm.on_time_arrival,\n        pcpm.on_time_departure,\n        ROUND(CAST(pcpm.port_moving_avg_arrival_delay_30 AS NUMERIC), 2) AS port_moving_avg_arrival_delay_30,\n        ROUND(CAST(pcpm.port_moving_avg_dwell_time_30 AS NUMERIC), 2) AS port_moving_avg_dwell_time_30,\n        ROUND(CAST(pcpm.carrier_moving_avg_arrival_delay_30 AS NUMERIC), 2) AS carrier_moving_avg_arrival_delay_30,\n        ROUND(CAST(pcpm.arrival_delay_percentile_rank * 100 AS NUMERIC), 2) AS arrival_delay_percentile_rank,\n        ROUND(CAST(pcpm.dwell_time_percentile_rank * 100 AS NUMERIC), 2) AS dwell_time_percentile_rank,\n        -- Performance classification\n        CASE\n            WHEN pcpm.arrival_delay_hours IS NOT NULL THEN\n                CASE\n                    WHEN pcpm.arrival_delay_hours <= -2 THEN 'Early Arrival'\n                    WHEN pcpm.arrival_delay_hours <= 2 THEN 'On-Time Arrival'\n                    WHEN pcpm.arrival_delay_hours <= 6 THEN 'Minor Delay'\n                    WHEN pcpm.arrival_delay_hours <= 12 THEN 'Moderate Delay'\n                    ELSE 'Major Delay'\n                END\n            ELSE 'Unknown'\n        END AS arrival_performance_class,\n        -- Dwell time efficiency classification\n        CASE\n            WHEN pcpm.dwell_time_hours IS NOT NULL AND pcpm.scheduled_dwell_time_hours IS NOT NULL THEN\n                CASE\n                    WHEN pcpm.dwell_time_hours <= pcpm.scheduled_dwell_time_hours * 0.9 THEN 'Efficient'\n                    WHEN pcpm.dwell_time_hours <= pcpm.scheduled_dwell_time_hours * 1.1 THEN 'Normal'\n                    WHEN pcpm.dwell_time_hours <= pcpm.scheduled_dwell_time_hours * 1.5 THEN 'Extended'\n                    ELSE 'Inefficient'\n                END\n            ELSE 'Unknown'\n        END AS dwell_time_efficiency_class\n    FROM port_call_performance_metrics pcpm\n)\nSELECT\n    port_call_id,\n    vessel_id,\n    vessel_name,\n    imo_number,\n    port_id,\n    port_name,\n    port_code,\n    locode,\n    carrier_id,\n    carrier_name,\n    voyage_number,\n    route_id,\n    scheduled_arrival,\n    actual_arrival,\n    scheduled_departure,\n    actual_departure,\n    port_call_type,\n    total_containers_handled,\n    arrival_delay_hours,\n    departure_delay_hours,\n    dwell_time_hours,\n    scheduled_dwell_time_hours,\n    dwell_time_variance_hours,\n    on_time_arrival,\n    on_time_departure,\n    port_moving_avg_arrival_delay_30,\n    port_moving_avg_dwell_time_30,\n    carrier_moving_avg_arrival_delay_30,\n    arrival_delay_percentile_rank,\n    dwell_time_percentile_rank,\n    arrival_performance_class,\n    dwell_time_efficiency_class\nFROM port_call_classification\nWHERE scheduled_arrival >= CURRENT_TIMESTAMP - INTERVAL '90 days'\nORDER BY scheduled_arrival DESC, arrival_delay_hours DESC\nLIMIT 10000;",
      "line_number": 476
    },
    {
      "number": 3,
      "title": "Route Optimization Analysis with Transit Time Comparison and Multi-Carrier Benchmarking",
      "description": "Use Case: Logistics Route Planning - Comprehensive Route Optimization Analysis with Transit Time Comparison for Supply Chain Efficiency Description: Enterprise-level route optimization analysis with multi-level CTE nesting, transit time comparison across carriers, route efficiency scoring, distance analysis, and advanced window functions. Demonstrates production patterns used by logistics companies and shipping lines for route optimization. Business Value: Route optimization report showing trans",
      "complexity": "Deep nested CTEs (7+ levels), temporal analysis, spatial distance calculations, window functions with multiple frame clauses, percentile calculations, multi-carrier comparisons, efficiency scoring algorithms",
      "expected_output": "Route optimization report with transit times, distances, efficiency metrics, and carrier performance comparisons.",
      "sql": "WITH route_sailing_analysis AS (\n    -- First CTE: Analyze sailings by route with transit metrics\n    SELECT\n        s.sailing_id,\n        s.vessel_id,\n        s.voyage_number,\n        s.route_id,\n        s.origin_port_id,\n        s.destination_port_id,\n        s.scheduled_departure,\n        s.actual_departure,\n        s.scheduled_arrival,\n        s.actual_arrival,\n        s.transit_days,\n        s.distance_nautical_miles,\n        s.average_speed_knots,\n        s.total_containers,\n        s.total_teu,\n        s.capacity_utilization_percent,\n        s.status,\n        r.route_name,\n        r.route_code,\n        r.carrier_id,\n        c.carrier_name,\n        op.port_name AS origin_port_name,\n        op.port_code AS origin_port_code,\n        dp.port_name AS destination_port_name,\n        dp.port_code AS destination_port_code,\n        -- Calculate actual transit time\n        CASE\n            WHEN s.actual_departure IS NOT NULL AND s.actual_arrival IS NOT NULL THEN\n                EXTRACT(EPOCH FROM (s.actual_arrival - s.actual_departure)) / 86400.0\n            WHEN s.actual_departure IS NOT NULL AND s.scheduled_arrival IS NOT NULL THEN\n                EXTRACT(EPOCH FROM (s.scheduled_arrival - s.actual_departure)) / 86400.0\n            ELSE s.transit_days\n        END AS actual_transit_days,\n        -- Calculate scheduled transit time\n        CASE\n            WHEN s.scheduled_departure IS NOT NULL AND s.scheduled_arrival IS NOT NULL THEN\n                EXTRACT(EPOCH FROM (s.scheduled_arrival - s.scheduled_departure)) / 86400.0\n            ELSE s.transit_days\n        END AS scheduled_transit_days\n    FROM sailings s\n    INNER JOIN routes r ON s.route_id = r.route_id\n    LEFT JOIN carriers c ON r.carrier_id = c.carrier_id\n    INNER JOIN ports op ON s.origin_port_id = op.port_id\n    INNER JOIN ports dp ON s.destination_port_id = dp.port_id\n    WHERE s.status IN ('Completed', 'In Progress')\n        AND s.distance_nautical_miles IS NOT NULL\n),\nroute_port_pair_aggregation AS (\n    -- Second CTE: Aggregate sailings by route and port pair\n    SELECT\n        rsa.route_id,\n        rsa.route_name,\n        rsa.route_code,\n        rsa.carrier_id,\n        rsa.carrier_name,\n        rsa.origin_port_id,\n        rsa.origin_port_name,\n        rsa.origin_port_code,\n        rsa.destination_port_id,\n        rsa.destination_port_name,\n        rsa.destination_port_code,\n        COUNT(*) AS total_sailings,\n        COUNT(CASE WHEN rsa.status = 'Completed' THEN 1 END) AS completed_sailings,\n        AVG(rsa.actual_transit_days) AS avg_actual_transit_days,\n        AVG(rsa.scheduled_transit_days) AS avg_scheduled_transit_days,\n        AVG(rsa.distance_nautical_miles) AS avg_distance_nm,\n        AVG(rsa.average_speed_knots) AS avg_speed_knots,\n        AVG(rsa.capacity_utilization_percent) AS avg_capacity_utilization,\n        AVG(rsa.total_teu) AS avg_teu,\n        PERCENTILE_CONT(0.5) WITHIN GROUP (ORDER BY rsa.actual_transit_days) AS median_transit_days,\n        PERCENTILE_CONT(0.25) WITHIN GROUP (ORDER BY rsa.actual_transit_days) AS q1_transit_days,\n        PERCENTILE_CONT(0.75) WITHIN GROUP (ORDER BY rsa.actual_transit_days) AS q3_transit_days,\n        STDDEV(rsa.actual_transit_days) AS stddev_transit_days,\n        MIN(rsa.actual_transit_days) AS min_transit_days,\n        MAX(rsa.actual_transit_days) AS max_transit_days\n    FROM route_sailing_analysis rsa\n    GROUP BY\n        rsa.route_id,\n        rsa.route_name,\n        rsa.route_code,\n        rsa.carrier_id,\n        rsa.carrier_name,\n        rsa.origin_port_id,\n        rsa.origin_port_name,\n        rsa.origin_port_code,\n        rsa.destination_port_id,\n        rsa.destination_port_name,\n        rsa.destination_port_code\n),\nroute_efficiency_calculations AS (\n    -- Third CTE: Calculate route efficiency metrics\n    SELECT\n        rppa.route_id,\n        rppa.route_name,\n        rppa.route_code,\n        rppa.carrier_id,\n        rppa.carrier_name,\n        rppa.origin_port_id,\n        rppa.origin_port_name,\n        rppa.origin_port_code,\n        rppa.destination_port_id,\n        rppa.destination_port_name,\n        rppa.destination_port_code,\n        rppa.total_sailings,\n        rppa.completed_sailings,\n        ROUND(CAST(rppa.avg_actual_transit_days AS NUMERIC), 2) AS avg_actual_transit_days,\n        ROUND(CAST(rppa.avg_scheduled_transit_days AS NUMERIC), 2) AS avg_scheduled_transit_days,\n        ROUND(CAST(rppa.avg_distance_nm AS NUMERIC), 2) AS avg_distance_nm,\n        ROUND(CAST(rppa.avg_speed_knots AS NUMERIC), 2) AS avg_speed_knots,\n        ROUND(CAST(rppa.avg_capacity_utilization AS NUMERIC), 2) AS avg_capacity_utilization,\n        ROUND(CAST(rppa.avg_teu AS NUMERIC), 2) AS avg_teu,\n        ROUND(CAST(rppa.median_transit_days AS NUMERIC), 2) AS median_transit_days,\n        ROUND(CAST(rppa.q1_transit_days AS NUMERIC), 2) AS q1_transit_days,\n        ROUND(CAST(rppa.q3_transit_days AS NUMERIC), 2) AS q3_transit_days,\n        ROUND(CAST(rppa.stddev_transit_days AS NUMERIC), 2) AS stddev_transit_days,\n        ROUND(CAST(rppa.min_transit_days AS NUMERIC), 2) AS min_transit_days,\n        ROUND(CAST(rppa.max_transit_days AS NUMERIC), 2) AS max_transit_days,\n        -- Transit time variance\n        CASE\n            WHEN rppa.avg_actual_transit_days IS NOT NULL AND rppa.avg_scheduled_transit_days IS NOT NULL THEN\n                rppa.avg_actual_transit_days - rppa.avg_scheduled_transit_days\n            ELSE NULL\n        END AS transit_time_variance_days,\n        -- Speed efficiency (distance / time)\n        CASE\n            WHEN rppa.avg_actual_transit_days IS NOT NULL \n                AND rppa.avg_actual_transit_days > 0 \n                AND rppa.avg_distance_nm IS NOT NULL THEN\n                rppa.avg_distance_nm / rppa.avg_actual_transit_days\n            ELSE NULL\n        END AS speed_efficiency_nm_per_day,\n        -- Completion rate\n        CASE\n            WHEN rppa.total_sailings > 0 THEN\n                (rppa.completed_sailings::NUMERIC / rppa.total_sailings::NUMERIC) * 100\n            ELSE 0\n        END AS completion_rate_percent\n    FROM route_port_pair_aggregation rppa\n),\ncarrier_route_comparison AS (\n    -- Fourth CTE: Compare routes across carriers for same port pair\n    SELECT\n        rec.route_id,\n        rec.route_name,\n        rec.route_code,\n        rec.carrier_id,\n        rec.carrier_name,\n        rec.origin_port_id,\n        rec.origin_port_name,\n        rec.origin_port_code,\n        rec.destination_port_id,\n        rec.destination_port_name,\n        rec.destination_port_code,\n        rec.total_sailings,\n        rec.completed_sailings,\n        rec.avg_actual_transit_days,\n        rec.avg_scheduled_transit_days,\n        rec.avg_distance_nm,\n        rec.avg_speed_knots,\n        rec.avg_capacity_utilization,\n        rec.avg_teu,\n        rec.median_transit_days,\n        rec.stddev_transit_days,\n        rec.transit_time_variance_days,\n        rec.speed_efficiency_nm_per_day,\n        rec.completion_rate_percent,\n        -- Compare with other carriers on same port pair\n        (\n            SELECT MIN(rec2.avg_actual_transit_days)\n            FROM route_efficiency_calculations rec2\n            WHERE rec2.origin_port_id = rec.origin_port_id\n                AND rec2.destination_port_id = rec.destination_port_id\n                AND rec2.carrier_id != rec.carrier_id\n        ) AS fastest_competitor_transit_days,\n        (\n            SELECT AVG(rec2.avg_actual_transit_days)\n            FROM route_efficiency_calculations rec2\n            WHERE rec2.origin_port_id = rec.origin_port_id\n                AND rec2.destination_port_id = rec.destination_port_id\n                AND rec2.carrier_id != rec.carrier_id\n        ) AS market_avg_transit_days,\n        -- Ranking within port pair\n        RANK() OVER (\n            PARTITION BY rec.origin_port_id, rec.destination_port_id\n            ORDER BY rec.avg_actual_transit_days ASC\n        ) AS transit_time_rank,\n        COUNT(*) OVER (\n            PARTITION BY rec.origin_port_id, rec.destination_port_id\n        ) AS competitors_count\n    FROM route_efficiency_calculations rec\n),\nroute_optimization_scoring AS (\n    -- Fifth CTE: Calculate optimization scores\n    SELECT\n        crc.route_id,\n        crc.route_name,\n        crc.route_code,\n        crc.carrier_id,\n        crc.carrier_name,\n        crc.origin_port_id,\n        crc.origin_port_name,\n        crc.origin_port_code,\n        crc.destination_port_id,\n        crc.destination_port_name,\n        crc.destination_port_code,\n        crc.total_sailings,\n        crc.completed_sailings,\n        crc.avg_actual_transit_days,\n        crc.avg_scheduled_transit_days,\n        crc.avg_distance_nm,\n        crc.avg_speed_knots,\n        crc.avg_capacity_utilization,\n        crc.avg_teu,\n        crc.median_transit_days,\n        crc.stddev_transit_days,\n        crc.transit_time_variance_days,\n        crc.speed_efficiency_nm_per_day,\n        crc.completion_rate_percent,\n        crc.fastest_competitor_transit_days,\n        crc.market_avg_transit_days,\n        crc.transit_time_rank,\n        crc.competitors_count,\n        -- Transit time performance vs market\n        CASE\n            WHEN crc.market_avg_transit_days IS NOT NULL AND crc.avg_actual_transit_days IS NOT NULL THEN\n                ((crc.market_avg_transit_days - crc.avg_actual_transit_days) / crc.market_avg_transit_days) * 100\n            ELSE NULL\n        END AS transit_time_advantage_percent,\n        -- Optimization score (weighted factors)\n        (\n            -- Transit time component (40% weight) - faster is better\n            CASE\n                WHEN crc.market_avg_transit_days IS NOT NULL AND crc.avg_actual_transit_days IS NOT NULL THEN\n                    GREATEST(0, 1.0 - ((crc.avg_actual_transit_days - crc.fastest_competitor_transit_days) / NULLIF(crc.market_avg_transit_days, 0))) * 40\n                ELSE 0\n            END +\n            -- Capacity utilization component (30% weight)\n            COALESCE(crc.avg_capacity_utilization / 100.0 * 30, 0) +\n            -- Completion rate component (20% weight)\n            COALESCE(crc.completion_rate_percent / 100.0 * 20, 0) +\n            -- Consistency component (10% weight) - lower stddev is better\n            CASE\n                WHEN crc.stddev_transit_days IS NOT NULL AND crc.avg_actual_transit_days IS NOT NULL AND crc.avg_actual_transit_days > 0 THEN\n                    GREATEST(0, 1.0 - (crc.stddev_transit_days / crc.avg_actual_transit_days)) * 10\n                ELSE 0\n            END\n        ) AS optimization_score\n    FROM carrier_route_comparison crc\n),\nroute_classification AS (\n    -- Sixth CTE: Classify routes by performance\n    SELECT\n        ros.route_id,\n        ros.route_name,\n        ros.route_code,\n        ros.carrier_id,\n        ros.carrier_name,\n        ros.origin_port_id,\n        ros.origin_port_name,\n        ros.origin_port_code,\n        ros.destination_port_id,\n        ros.destination_port_name,\n        ros.destination_port_code,\n        ros.total_sailings,\n        ros.completed_sailings,\n        ros.avg_actual_transit_days,\n        ros.avg_scheduled_transit_days,\n        ros.avg_distance_nm,\n        ros.avg_speed_knots,\n        ros.avg_capacity_utilization,\n        ros.avg_teu,\n        ros.median_transit_days,\n        ros.stddev_transit_days,\n        ros.transit_time_variance_days,\n        ros.speed_efficiency_nm_per_day,\n        ros.completion_rate_percent,\n        ros.fastest_competitor_transit_days,\n        ros.market_avg_transit_days,\n        ros.transit_time_rank,\n        ros.competitors_count,\n        ros.transit_time_advantage_percent,\n        ROUND(CAST(ros.optimization_score AS NUMERIC), 2) AS optimization_score,\n        -- Performance classification\n        CASE\n            WHEN ros.optimization_score >= 80 THEN 'Highly Optimized'\n            WHEN ros.optimization_score >= 60 THEN 'Well Optimized'\n            WHEN ros.optimization_score >= 40 THEN 'Moderately Optimized'\n            WHEN ros.optimization_score >= 20 THEN 'Needs Optimization'\n            ELSE 'Poorly Optimized'\n        END AS optimization_class,\n        -- Transit time classification\n        CASE\n            WHEN ros.transit_time_rank = 1 AND ros.competitors_count > 1 THEN 'Fastest'\n            WHEN ros.transit_time_advantage_percent IS NOT NULL AND ros.transit_time_advantage_percent > 10 THEN 'Faster than Market'\n            WHEN ros.transit_time_advantage_percent IS NOT NULL AND ros.transit_time_advantage_percent > -10 THEN 'Market Average'\n            ELSE 'Slower than Market'\n        END AS transit_time_class\n    FROM route_optimization_scoring ros\n)\nSELECT\n    route_id,\n    route_name,\n    route_code,\n    carrier_id,\n    carrier_name,\n    origin_port_id,\n    origin_port_name,\n    origin_port_code,\n    destination_port_id,\n    destination_port_name,\n    destination_port_code,\n    total_sailings,\n    completed_sailings,\n    avg_actual_transit_days,\n    avg_scheduled_transit_days,\n    avg_distance_nm,\n    avg_speed_knots,\n    avg_capacity_utilization,\n    avg_teu,\n    median_transit_days,\n    stddev_transit_days,\n    transit_time_variance_days,\n    speed_efficiency_nm_per_day,\n    completion_rate_percent,\n    fastest_competitor_transit_days,\n    market_avg_transit_days,\n    transit_time_rank,\n    competitors_count,\n    ROUND(CAST(transit_time_advantage_percent AS NUMERIC), 2) AS transit_time_advantage_percent,\n    optimization_score,\n    optimization_class,\n    transit_time_class\nFROM route_classification\nWHERE total_sailings >= 5\nORDER BY optimization_score DESC, avg_actual_transit_days ASC\nLIMIT 1000;",
      "line_number": 762
    },
    {
      "number": 4,
      "title": "Carrier Performance Metrics with On-Time Performance Analysis and Reliability Scoring",
      "description": "Use Case: Carrier Selection - Comprehensive Carrier Performance Analysis with On-Time Performance Metrics for Shipping Line Evaluation Description: Enterprise-level carrier performance analysis with multi-level CTE nesting, on-time performance calculations, vessel utilization metrics, capacity analysis, reliability scoring, and advanced window functions. Demonstrates production patterns used by freight forwarders and shippers for carrier evaluation. Business Value: Carrier performance report sho",
      "complexity": "Deep nested CTEs (7+ levels), temporal analysis, performance scoring algorithms, window functions with multiple frame clauses, percentile calculations, multi-metric aggregation, carrier comparisons",
      "expected_output": "Carrier performance report with on-time performance rates, vessel utilization, capacity metrics, reliability scores, and performance rankings.",
      "sql": "WITH carrier_sailing_metrics AS (\n    -- First CTE: Aggregate sailing metrics by carrier\n    SELECT\n        c.carrier_id,\n        c.carrier_name,\n        c.scac_code,\n        c.carrier_type,\n        COUNT(DISTINCT s.sailing_id) AS total_sailings,\n        COUNT(DISTINCT CASE WHEN s.status = 'Completed' THEN s.sailing_id END) AS completed_sailings,\n        COUNT(DISTINCT CASE WHEN s.status = 'Cancelled' THEN s.sailing_id END) AS cancelled_sailings,\n        COUNT(DISTINCT s.vessel_id) AS unique_vessels,\n        COUNT(DISTINCT s.route_id) AS unique_routes,\n        AVG(s.transit_days) AS avg_transit_days,\n        AVG(s.distance_nautical_miles) AS avg_distance_nm,\n        AVG(s.average_speed_knots) AS avg_speed_knots,\n        AVG(s.capacity_utilization_percent) AS avg_capacity_utilization,\n        AVG(s.total_teu) AS avg_teu_per_sailing,\n        SUM(s.total_teu) AS total_teu_carried,\n        PERCENTILE_CONT(0.5) WITHIN GROUP (ORDER BY s.transit_days) AS median_transit_days,\n        STDDEV(s.transit_days) AS stddev_transit_days\n    FROM carriers c\n    LEFT JOIN routes r ON c.carrier_id = r.carrier_id\n    LEFT JOIN sailings s ON r.route_id = s.route_id\n    WHERE c.status = 'Active'\n        AND (s.status IS NULL OR s.status IN ('Completed', 'In Progress', 'Cancelled'))\n    GROUP BY c.carrier_id, c.carrier_name, c.scac_code, c.carrier_type\n),\ncarrier_port_call_metrics AS (\n    -- Second CTE: Aggregate port call performance by carrier\n    SELECT\n        c.carrier_id,\n        COUNT(DISTINCT pc.port_call_id) AS total_port_calls,\n        COUNT(DISTINCT CASE WHEN pc.status = 'Completed' THEN pc.port_call_id END) AS completed_port_calls,\n        COUNT(DISTINCT CASE \n            WHEN pc.actual_arrival IS NOT NULL \n                AND pc.scheduled_arrival IS NOT NULL \n                AND ABS(EXTRACT(EPOCH FROM (pc.actual_arrival - pc.scheduled_arrival)) / 3600.0) <= 2 \n            THEN pc.port_call_id \n        END) AS on_time_arrivals,\n        COUNT(DISTINCT CASE \n            WHEN pc.actual_departure IS NOT NULL \n                AND pc.scheduled_departure IS NOT NULL \n                AND ABS(EXTRACT(EPOCH FROM (pc.actual_departure - pc.scheduled_departure)) / 3600.0) <= 2 \n            THEN pc.port_call_id \n        END) AS on_time_departures,\n        AVG(CASE \n            WHEN pc.actual_arrival IS NOT NULL AND pc.scheduled_arrival IS NOT NULL THEN\n                EXTRACT(EPOCH FROM (pc.actual_arrival - pc.scheduled_arrival)) / 3600.0\n            ELSE NULL\n        END) AS avg_arrival_delay_hours,\n        AVG(CASE \n            WHEN pc.actual_departure IS NOT NULL AND pc.scheduled_departure IS NOT NULL THEN\n                EXTRACT(EPOCH FROM (pc.actual_departure - pc.scheduled_departure)) / 3600.0\n            ELSE NULL\n        END) AS avg_departure_delay_hours,\n        AVG(CASE \n            WHEN pc.actual_arrival IS NOT NULL AND pc.actual_departure IS NOT NULL THEN\n                EXTRACT(EPOCH FROM (pc.actual_departure - pc.actual_arrival)) / 3600.0\n            ELSE NULL\n        END) AS avg_dwell_time_hours,\n        SUM(COALESCE(pc.containers_loaded, 0) + COALESCE(pc.containers_discharged, 0) + COALESCE(pc.containers_transshipped, 0)) AS total_containers_handled\n    FROM carriers c\n    LEFT JOIN vessels v ON c.carrier_id = v.carrier_id\n    LEFT JOIN port_calls pc ON v.vessel_id = pc.vessel_id\n    WHERE c.status = 'Active'\n        AND (pc.status IS NULL OR pc.status IN ('Completed', 'In Progress'))\n    GROUP BY c.carrier_id\n),\ncarrier_performance_aggregation AS (\n    -- Third CTE: Combine sailing and port call metrics\n    SELECT\n        csm.carrier_id,\n        csm.carrier_name,\n        csm.scac_code,\n        csm.carrier_type,\n        csm.total_sailings,\n        csm.completed_sailings,\n        csm.cancelled_sailings,\n        csm.unique_vessels,\n        csm.unique_routes,\n        csm.avg_transit_days,\n        csm.avg_distance_nm,\n        csm.avg_speed_knots,\n        csm.avg_capacity_utilization,\n        csm.avg_teu_per_sailing,\n        csm.total_teu_carried,\n        csm.median_transit_days,\n        csm.stddev_transit_days,\n        cpmc.total_port_calls,\n        cpmc.completed_port_calls,\n        cpmc.on_time_arrivals,\n        cpmc.on_time_departures,\n        cpmc.avg_arrival_delay_hours,\n        cpmc.avg_departure_delay_hours,\n        cpmc.avg_dwell_time_hours,\n        cpmc.total_containers_handled,\n        -- Completion rates\n        CASE\n            WHEN csm.total_sailings > 0 THEN\n                (csm.completed_sailings::NUMERIC / csm.total_sailings::NUMERIC) * 100\n            ELSE 0\n        END AS sailing_completion_rate,\n        CASE\n            WHEN cpmc.total_port_calls > 0 THEN\n                (cpmc.completed_port_calls::NUMERIC / cpmc.total_port_calls::NUMERIC) * 100\n            ELSE 0\n        END AS port_call_completion_rate,\n        -- On-time performance rates\n        CASE\n            WHEN cpmc.total_port_calls > 0 THEN\n                (cpmc.on_time_arrivals::NUMERIC / cpmc.total_port_calls::NUMERIC) * 100\n            ELSE 0\n        END AS on_time_arrival_rate,\n        CASE\n            WHEN cpmc.total_port_calls > 0 THEN\n                (cpmc.on_time_departures::NUMERIC / cpmc.total_port_calls::NUMERIC) * 100\n            ELSE 0\n        END AS on_time_departure_rate\n    FROM carrier_sailing_metrics csm\n    LEFT JOIN carrier_port_call_metrics cpmc ON csm.carrier_id = cpmc.carrier_id\n),\ncarrier_performance_comparison AS (\n    -- Fourth CTE: Compare carriers with market averages\n    SELECT\n        cpa.carrier_id,\n        cpa.carrier_name,\n        cpa.scac_code,\n        cpa.carrier_type,\n        cpa.total_sailings,\n        cpa.completed_sailings,\n        cpa.cancelled_sailings,\n        cpa.unique_vessels,\n        cpa.unique_routes,\n        ROUND(CAST(cpa.avg_transit_days AS NUMERIC), 2) AS avg_transit_days,\n        ROUND(CAST(cpa.avg_distance_nm AS NUMERIC), 2) AS avg_distance_nm,\n        ROUND(CAST(cpa.avg_speed_knots AS NUMERIC), 2) AS avg_speed_knots,\n        ROUND(CAST(cpa.avg_capacity_utilization AS NUMERIC), 2) AS avg_capacity_utilization,\n        ROUND(CAST(cpa.avg_teu_per_sailing AS NUMERIC), 2) AS avg_teu_per_sailing,\n        ROUND(CAST(cpa.total_teu_carried AS NUMERIC), 2) AS total_teu_carried,\n        ROUND(CAST(cpa.median_transit_days AS NUMERIC), 2) AS median_transit_days,\n        ROUND(CAST(cpa.stddev_transit_days AS NUMERIC), 2) AS stddev_transit_days,\n        cpa.total_port_calls,\n        cpa.completed_port_calls,\n        cpa.on_time_arrivals,\n        cpa.on_time_departures,\n        ROUND(CAST(cpa.avg_arrival_delay_hours AS NUMERIC), 2) AS avg_arrival_delay_hours,\n        ROUND(CAST(cpa.avg_departure_delay_hours AS NUMERIC), 2) AS avg_departure_delay_hours,\n        ROUND(CAST(cpa.avg_dwell_time_hours AS NUMERIC), 2) AS avg_dwell_time_hours,\n        ROUND(CAST(cpa.total_containers_handled AS NUMERIC), 0) AS total_containers_handled,\n        ROUND(CAST(cpa.sailing_completion_rate AS NUMERIC), 2) AS sailing_completion_rate,\n        ROUND(CAST(cpa.port_call_completion_rate AS NUMERIC), 2) AS port_call_completion_rate,\n        ROUND(CAST(cpa.on_time_arrival_rate AS NUMERIC), 2) AS on_time_arrival_rate,\n        ROUND(CAST(cpa.on_time_departure_rate AS NUMERIC), 2) AS on_time_departure_rate,\n        -- Market averages for comparison\n        AVG(cpa.avg_transit_days) OVER () AS market_avg_transit_days,\n        AVG(cpa.avg_capacity_utilization) OVER () AS market_avg_capacity_utilization,\n        AVG(cpa.on_time_arrival_rate) OVER () AS market_avg_on_time_arrival_rate,\n        AVG(cpa.sailing_completion_rate) OVER () AS market_avg_completion_rate,\n        -- Rankings\n        RANK() OVER (ORDER BY cpa.on_time_arrival_rate DESC) AS on_time_rank,\n        RANK() OVER (ORDER BY cpa.avg_capacity_utilization DESC) AS capacity_utilization_rank,\n        RANK() OVER (ORDER BY cpa.sailing_completion_rate DESC) AS completion_rate_rank,\n        RANK() OVER (ORDER BY cpa.total_teu_carried DESC) AS volume_rank,\n        -- Percentile rankings\n        PERCENT_RANK() OVER (ORDER BY cpa.on_time_arrival_rate) AS on_time_percentile,\n        PERCENT_RANK() OVER (ORDER BY cpa.avg_capacity_utilization) AS capacity_percentile,\n        PERCENT_RANK() OVER (ORDER BY cpa.sailing_completion_rate) AS completion_percentile\n    FROM carrier_performance_aggregation cpa\n    WHERE cpa.total_sailings > 0 OR cpa.total_port_calls > 0\n),\ncarrier_reliability_scoring AS (\n    -- Fifth CTE: Calculate comprehensive reliability score\n    SELECT\n        cpc.carrier_id,\n        cpc.carrier_name,\n        cpc.scac_code,\n        cpc.carrier_type,\n        cpc.total_sailings,\n        cpc.completed_sailings,\n        cpc.cancelled_sailings,\n        cpc.unique_vessels,\n        cpc.unique_routes,\n        cpc.avg_transit_days,\n        cpc.avg_distance_nm,\n        cpc.avg_speed_knots,\n        cpc.avg_capacity_utilization,\n        cpc.avg_teu_per_sailing,\n        cpc.total_teu_carried,\n        cpc.median_transit_days,\n        cpc.stddev_transit_days,\n        cpc.total_port_calls,\n        cpc.completed_port_calls,\n        cpc.on_time_arrivals,\n        cpc.on_time_departures,\n        cpc.avg_arrival_delay_hours,\n        cpc.avg_departure_delay_hours,\n        cpc.avg_dwell_time_hours,\n        cpc.total_containers_handled,\n        cpc.sailing_completion_rate,\n        cpc.port_call_completion_rate,\n        cpc.on_time_arrival_rate,\n        cpc.on_time_departure_rate,\n        cpc.market_avg_transit_days,\n        cpc.market_avg_capacity_utilization,\n        cpc.market_avg_on_time_arrival_rate,\n        cpc.market_avg_completion_rate,\n        cpc.on_time_rank,\n        cpc.capacity_utilization_rank,\n        cpc.completion_rate_rank,\n        cpc.volume_rank,\n        ROUND(CAST(cpc.on_time_percentile * 100 AS NUMERIC), 2) AS on_time_percentile,\n        ROUND(CAST(cpc.capacity_percentile * 100 AS NUMERIC), 2) AS capacity_percentile,\n        ROUND(CAST(cpc.completion_percentile * 100 AS NUMERIC), 2) AS completion_percentile,\n        -- Comprehensive reliability score (weighted factors)\n        (\n            -- On-time performance component (35% weight)\n            COALESCE(cpc.on_time_arrival_rate / 100.0 * 35, 0) +\n            -- Completion rate component (30% weight)\n            COALESCE(cpc.sailing_completion_rate / 100.0 * 30, 0) +\n            -- Capacity utilization component (20% weight)\n            COALESCE(cpc.avg_capacity_utilization / 100.0 * 20, 0) +\n            -- Consistency component (15% weight) - lower stddev is better\n            CASE\n                WHEN cpc.stddev_transit_days IS NOT NULL AND cpc.avg_transit_days IS NOT NULL AND cpc.avg_transit_days > 0 THEN\n                    GREATEST(0, 1.0 - (cpc.stddev_transit_days / cpc.avg_transit_days)) * 15\n                ELSE 0\n            END\n        ) AS reliability_score\n    FROM carrier_performance_comparison cpc\n),\ncarrier_performance_classification AS (\n    -- Sixth CTE: Classify carriers by performance\n    SELECT\n        crs.carrier_id,\n        crs.carrier_name,\n        crs.scac_code,\n        crs.carrier_type,\n        crs.total_sailings,\n        crs.completed_sailings,\n        crs.cancelled_sailings,\n        crs.unique_vessels,\n        crs.unique_routes,\n        crs.avg_transit_days,\n        crs.avg_distance_nm,\n        crs.avg_speed_knots,\n        crs.avg_capacity_utilization,\n        crs.avg_teu_per_sailing,\n        crs.total_teu_carried,\n        crs.median_transit_days,\n        crs.stddev_transit_days,\n        crs.total_port_calls,\n        crs.completed_port_calls,\n        crs.on_time_arrivals,\n        crs.on_time_departures,\n        crs.avg_arrival_delay_hours,\n        crs.avg_departure_delay_hours,\n        crs.avg_dwell_time_hours,\n        crs.total_containers_handled,\n        crs.sailing_completion_rate,\n        crs.port_call_completion_rate,\n        crs.on_time_arrival_rate,\n        crs.on_time_departure_rate,\n        crs.market_avg_transit_days,\n        crs.market_avg_capacity_utilization,\n        crs.market_avg_on_time_arrival_rate,\n        crs.market_avg_completion_rate,\n        crs.on_time_rank,\n        crs.capacity_utilization_rank,\n        crs.completion_rate_rank,\n        crs.volume_rank,\n        crs.on_time_percentile,\n        crs.capacity_percentile,\n        crs.completion_percentile,\n        ROUND(CAST(crs.reliability_score AS NUMERIC), 2) AS reliability_score,\n        -- Performance classification\n        CASE\n            WHEN crs.reliability_score >= 80 THEN 'Excellent'\n            WHEN crs.reliability_score >= 65 THEN 'Good'\n            WHEN crs.reliability_score >= 50 THEN 'Average'\n            WHEN crs.reliability_score >= 35 THEN 'Below Average'\n            ELSE 'Poor'\n        END AS performance_class,\n        -- On-time performance classification\n        CASE\n            WHEN crs.on_time_arrival_rate >= 95 THEN 'Excellent On-Time'\n            WHEN crs.on_time_arrival_rate >= 85 THEN 'Good On-Time'\n            WHEN crs.on_time_arrival_rate >= 75 THEN 'Average On-Time'\n            WHEN crs.on_time_arrival_rate >= 65 THEN 'Below Average On-Time'\n            ELSE 'Poor On-Time'\n        END AS on_time_class\n    FROM carrier_reliability_scoring crs\n)\nSELECT\n    carrier_id,\n    carrier_name,\n    scac_code,\n    carrier_type,\n    total_sailings,\n    completed_sailings,\n    cancelled_sailings,\n    unique_vessels,\n    unique_routes,\n    avg_transit_days,\n    avg_distance_nm,\n    avg_speed_knots,\n    avg_capacity_utilization,\n    avg_teu_per_sailing,\n    total_teu_carried,\n    median_transit_days,\n    stddev_transit_days,\n    total_port_calls,\n    completed_port_calls,\n    on_time_arrivals,\n    on_time_departures,\n    avg_arrival_delay_hours,\n    avg_departure_delay_hours,\n    avg_dwell_time_hours,\n    total_containers_handled,\n    sailing_completion_rate,\n    port_call_completion_rate,\n    on_time_arrival_rate,\n    on_time_departure_rate,\n    market_avg_transit_days,\n    market_avg_capacity_utilization,\n    market_avg_on_time_arrival_rate,\n    market_avg_completion_rate,\n    on_time_rank,\n    capacity_utilization_rank,\n    completion_rate_rank,\n    volume_rank,\n    on_time_percentile,\n    capacity_percentile,\n    completion_percentile,\n    reliability_score,\n    performance_class,\n    on_time_class\nFROM carrier_performance_classification\nORDER BY reliability_score DESC, on_time_arrival_rate DESC\nLIMIT 100;",
      "line_number": 1122
    },
    {
      "number": 5,
      "title": "Port Statistics Aggregation with Throughput Analysis and Operational Efficiency Metrics",
      "description": "Use Case: Port Operations Management - Comprehensive Port Statistics Aggregation with Throughput Analysis for Terminal Planning Description: Enterprise-level port statistics aggregation with multi-level CTE nesting, throughput calculations, vessel call analysis, container flow metrics, berth utilization, and advanced window functions. Demonstrates production patterns used by port authorities and terminal operators for operational planning. Business Value: Port statistics report showing vessel ca",
      "complexity": "Deep nested CTEs (7+ levels), temporal aggregation, throughput calculations, window functions with multiple frame clauses, percentile calculations, efficiency metrics, trend analysis",
      "expected_output": "Port statistics report with vessel calls, container throughput, berth utilization, and operational efficiency metrics.",
      "sql": "WITH port_statistics_base AS (\n    -- First CTE: Base port statistics with temporal grouping\n    SELECT\n        ps.statistic_id,\n        ps.port_id,\n        ps.statistic_date,\n        ps.statistic_period,\n        ps.total_vessel_calls,\n        ps.total_container_teu,\n        ps.containers_loaded,\n        ps.containers_discharged,\n        ps.containers_transshipped,\n        ps.average_vessel_size_teu,\n        ps.average_dwell_time_hours,\n        ps.berth_utilization_percent,\n        ps.crane_utilization_percent,\n        p.port_name,\n        p.port_code,\n        p.locode,\n        p.country,\n        p.country_code,\n        DATE_TRUNC('month', ps.statistic_date) AS statistic_month,\n        DATE_TRUNC('quarter', ps.statistic_date) AS statistic_quarter,\n        DATE_TRUNC('year', ps.statistic_date) AS statistic_year\n    FROM port_statistics ps\n    INNER JOIN ports p ON ps.port_id = p.port_id\n    WHERE ps.statistic_date >= CURRENT_DATE - INTERVAL '2 years'\n),\nport_monthly_aggregation AS (\n    -- Second CTE: Aggregate statistics by month\n    SELECT\n        psb.port_id,\n        psb.port_name,\n        psb.port_code,\n        psb.locode,\n        psb.country,\n        psb.country_code,\n        psb.statistic_month,\n        COUNT(DISTINCT psb.statistic_id) AS statistics_count,\n        SUM(psb.total_vessel_calls) AS monthly_vessel_calls,\n        SUM(psb.total_container_teu) AS monthly_container_teu,\n        SUM(psb.containers_loaded) AS monthly_containers_loaded,\n        SUM(psb.containers_discharged) AS monthly_containers_discharged,\n        SUM(psb.containers_transshipped) AS monthly_containers_transshipped,\n        AVG(psb.average_vessel_size_teu) AS monthly_avg_vessel_size,\n        AVG(psb.average_dwell_time_hours) AS monthly_avg_dwell_time,\n        AVG(psb.berth_utilization_percent) AS monthly_avg_berth_utilization,\n        AVG(psb.crane_utilization_percent) AS monthly_avg_crane_utilization,\n        PERCENTILE_CONT(0.5) WITHIN GROUP (ORDER BY psb.total_container_teu) AS median_monthly_teu,\n        PERCENTILE_CONT(0.25) WITHIN GROUP (ORDER BY psb.total_container_teu) AS q1_monthly_teu,\n        PERCENTILE_CONT(0.75) WITHIN GROUP (ORDER BY psb.total_container_teu) AS q3_monthly_teu,\n        STDDEV(psb.total_container_teu) AS stddev_monthly_teu\n    FROM port_statistics_base psb\n    GROUP BY\n        psb.port_id,\n        psb.port_name,\n        psb.port_code,\n        psb.locode,\n        psb.country,\n        psb.country_code,\n        psb.statistic_month\n),\nport_throughput_analysis AS (\n    -- Third CTE: Analyze throughput patterns with window functions\n    SELECT\n        pma.port_id,\n        pma.port_name,\n        pma.port_code,\n        pma.locode,\n        pma.country,\n        pma.country_code,\n        pma.statistic_month,\n        pma.monthly_vessel_calls,\n        pma.monthly_container_teu,\n        pma.monthly_containers_loaded,\n        pma.monthly_containers_discharged,\n        pma.monthly_containers_transshipped,\n        ROUND(CAST(pma.monthly_avg_vessel_size AS NUMERIC), 2) AS monthly_avg_vessel_size,\n        ROUND(CAST(pma.monthly_avg_dwell_time AS NUMERIC), 2) AS monthly_avg_dwell_time,\n        ROUND(CAST(pma.monthly_avg_berth_utilization AS NUMERIC), 2) AS monthly_avg_berth_utilization,\n        ROUND(CAST(pma.monthly_avg_crane_utilization AS NUMERIC), 2) AS monthly_avg_crane_utilization,\n        ROUND(CAST(pma.median_monthly_teu AS NUMERIC), 2) AS median_monthly_teu,\n        ROUND(CAST(pma.q1_monthly_teu AS NUMERIC), 2) AS q1_monthly_teu,\n        ROUND(CAST(pma.q3_monthly_teu AS NUMERIC), 2) AS q3_monthly_teu,\n        ROUND(CAST(pma.stddev_monthly_teu AS NUMERIC), 2) AS stddev_monthly_teu,\n        -- Moving averages for trend analysis\n        AVG(pma.monthly_container_teu) OVER (\n            PARTITION BY pma.port_id\n            ORDER BY pma.statistic_month\n            ROWS BETWEEN 2 PRECEDING AND CURRENT ROW\n        ) AS moving_avg_teu_3_month,\n        AVG(pma.monthly_container_teu) OVER (\n            PARTITION BY pma.port_id\n            ORDER BY pma.statistic_month\n            ROWS BETWEEN 11 PRECEDING AND CURRENT ROW\n        ) AS moving_avg_teu_12_month,\n        AVG(pma.monthly_vessel_calls) OVER (\n            PARTITION BY pma.port_id\n            ORDER BY pma.statistic_month\n            ROWS BETWEEN 2 PRECEDING AND CURRENT ROW\n        ) AS moving_avg_calls_3_month,\n        -- Trend indicators\n        LAG(pma.monthly_container_teu, 1) OVER (\n            PARTITION BY pma.port_id\n            ORDER BY pma.statistic_month\n        ) AS prev_month_teu,\n        LAG(pma.monthly_container_teu, 12) OVER (\n            PARTITION BY pma.port_id\n            ORDER BY pma.statistic_month\n        ) AS prev_year_teu,\n        -- Growth rates\n        CASE\n            WHEN LAG(pma.monthly_container_teu, 1) OVER (PARTITION BY pma.port_id ORDER BY pma.statistic_month) > 0 THEN\n                ((pma.monthly_container_teu - LAG(pma.monthly_container_teu, 1) OVER (PARTITION BY pma.port_id ORDER BY pma.statistic_month)) / \n                 LAG(pma.monthly_container_teu, 1) OVER (PARTITION BY pma.port_id ORDER BY pma.statistic_month)) * 100\n            ELSE NULL\n        END AS month_over_month_growth_percent,\n        CASE\n            WHEN LAG(pma.monthly_container_teu, 12) OVER (PARTITION BY pma.port_id ORDER BY pma.statistic_month) > 0 THEN\n                ((pma.monthly_container_teu - LAG(pma.monthly_container_teu, 12) OVER (PARTITION BY pma.port_id ORDER BY pma.statistic_month)) / \n                 LAG(pma.monthly_container_teu, 12) OVER (PARTITION BY pma.port_id ORDER BY pma.statistic_month)) * 100\n            ELSE NULL\n        END AS year_over_year_growth_percent\n    FROM port_monthly_aggregation pma\n),\nport_efficiency_calculations AS (\n    -- Fourth CTE: Calculate operational efficiency metrics\n    SELECT\n        pta.port_id,\n        pta.port_name,\n        pta.port_code,\n        pta.locode,\n        pta.country,\n        pta.country_code,\n        pta.statistic_month,\n        pta.monthly_vessel_calls,\n        pta.monthly_container_teu,\n        pta.monthly_containers_loaded,\n        pta.monthly_containers_discharged,\n        pta.monthly_containers_transshipped,\n        pta.monthly_avg_vessel_size,\n        pta.monthly_avg_dwell_time,\n        pta.monthly_avg_berth_utilization,\n        pta.monthly_avg_crane_utilization,\n        pta.median_monthly_teu,\n        pta.q1_monthly_teu,\n        pta.q3_monthly_teu,\n        pta.stddev_monthly_teu,\n        ROUND(CAST(pta.moving_avg_teu_3_month AS NUMERIC), 2) AS moving_avg_teu_3_month,\n        ROUND(CAST(pta.moving_avg_teu_12_month AS NUMERIC), 2) AS moving_avg_teu_12_month,\n        ROUND(CAST(pta.moving_avg_calls_3_month AS NUMERIC), 2) AS moving_avg_calls_3_month,\n        pta.prev_month_teu,\n        pta.prev_year_teu,\n        ROUND(CAST(pta.month_over_month_growth_percent AS NUMERIC), 2) AS month_over_month_growth_percent,\n        ROUND(CAST(pta.year_over_year_growth_percent AS NUMERIC), 2) AS year_over_year_growth_percent,\n        -- Throughput per vessel call\n        CASE\n            WHEN pta.monthly_vessel_calls > 0 THEN\n                pta.monthly_container_teu / pta.monthly_vessel_calls\n            ELSE NULL\n        END AS teu_per_vessel_call,\n        -- Container flow balance (loaded vs discharged)\n        CASE\n            WHEN (pta.monthly_containers_loaded + pta.monthly_containers_discharged) > 0 THEN\n                (pta.monthly_containers_loaded::NUMERIC / (pta.monthly_containers_loaded + pta.monthly_containers_discharged)) * 100\n            ELSE NULL\n        END AS loading_percentage,\n        -- Transshipment ratio\n        CASE\n            WHEN pta.monthly_container_teu > 0 THEN\n                (pta.monthly_containers_transshipped::NUMERIC / pta.monthly_container_teu) * 100\n            ELSE 0\n        END AS transshipment_percentage,\n        -- Efficiency score components\n        CASE\n            WHEN pta.monthly_avg_berth_utilization IS NOT NULL THEN\n                pta.monthly_avg_berth_utilization / 100.0\n            ELSE 0\n        END AS berth_efficiency_score,\n        CASE\n            WHEN pta.monthly_avg_crane_utilization IS NOT NULL THEN\n                pta.monthly_avg_crane_utilization / 100.0\n            ELSE 0\n        END AS crane_efficiency_score,\n        CASE\n            WHEN pta.monthly_avg_dwell_time IS NOT NULL AND pta.monthly_avg_dwell_time > 0 THEN\n                GREATEST(0, 1.0 - (pta.monthly_avg_dwell_time / 72.0))  -- 72 hours as baseline\n            ELSE 0\n        END AS dwell_time_efficiency_score\n    FROM port_throughput_analysis pta\n),\nport_performance_scoring AS (\n    -- Fifth CTE: Calculate comprehensive performance scores\n    SELECT\n        pec.port_id,\n        pec.port_name,\n        pec.port_code,\n        pec.locode,\n        pec.country,\n        pec.country_code,\n        pec.statistic_month,\n        pec.monthly_vessel_calls,\n        pec.monthly_container_teu,\n        pec.monthly_containers_loaded,\n        pec.monthly_containers_discharged,\n        pec.monthly_containers_transshipped,\n        pec.monthly_avg_vessel_size,\n        pec.monthly_avg_dwell_time,\n        pec.monthly_avg_berth_utilization,\n        pec.monthly_avg_crane_utilization,\n        pec.median_monthly_teu,\n        pec.stddev_monthly_teu,\n        pec.moving_avg_teu_3_month,\n        pec.moving_avg_teu_12_month,\n        pec.moving_avg_calls_3_month,\n        pec.prev_month_teu,\n        pec.prev_year_teu,\n        pec.month_over_month_growth_percent,\n        pec.year_over_year_growth_percent,\n        ROUND(CAST(pec.teu_per_vessel_call AS NUMERIC), 2) AS teu_per_vessel_call,\n        ROUND(CAST(pec.loading_percentage AS NUMERIC), 2) AS loading_percentage,\n        ROUND(CAST(pec.transshipment_percentage AS NUMERIC), 2) AS transshipment_percentage,\n        pec.berth_efficiency_score,\n        pec.crane_efficiency_score,\n        pec.dwell_time_efficiency_score,\n        -- Comprehensive performance score (weighted factors)\n        (\n            -- Throughput growth component (30% weight)\n            CASE\n                WHEN pec.year_over_year_growth_percent IS NOT NULL THEN\n                    GREATEST(0, LEAST(1.0, (pec.year_over_year_growth_percent + 20) / 40.0)) * 30\n                ELSE 15\n            END +\n            -- Berth utilization component (25% weight)\n            pec.berth_efficiency_score * 25 +\n            -- Crane utilization component (20% weight)\n            pec.crane_efficiency_score * 20 +\n            -- Dwell time efficiency component (15% weight)\n            pec.dwell_time_efficiency_score * 15 +\n            -- Throughput per vessel component (10% weight)\n            CASE\n                WHEN pec.teu_per_vessel_call IS NOT NULL THEN\n                    LEAST(1.0, pec.teu_per_vessel_call / 2000.0) * 10\n                ELSE 0\n            END\n        ) AS performance_score,\n        -- Market comparison\n        AVG(pec.monthly_container_teu) OVER () AS market_avg_monthly_teu,\n        PERCENT_RANK() OVER (ORDER BY pec.monthly_container_teu) AS throughput_percentile\n    FROM port_efficiency_calculations pec\n),\nport_classification AS (\n    -- Sixth CTE: Classify ports by performance\n    SELECT\n        pps.port_id,\n        pps.port_name,\n        pps.port_code,\n        pps.locode,\n        pps.country,\n        pps.country_code,\n        pps.statistic_month,\n        pps.monthly_vessel_calls,\n        pps.monthly_container_teu,\n        pps.monthly_containers_loaded,\n        pps.monthly_containers_discharged,\n        pps.monthly_containers_transshipped,\n        pps.monthly_avg_vessel_size,\n        pps.monthly_avg_dwell_time,\n        pps.monthly_avg_berth_utilization,\n        pps.monthly_avg_crane_utilization,\n        pps.median_monthly_teu,\n        pps.stddev_monthly_teu,\n        pps.moving_avg_teu_3_month,\n        pps.moving_avg_teu_12_month,\n        pps.moving_avg_calls_3_month,\n        pps.prev_month_teu,\n        pps.prev_year_teu,\n        pps.month_over_month_growth_percent,\n        pps.year_over_year_growth_percent,\n        pps.teu_per_vessel_call,\n        pps.loading_percentage,\n        pps.transshipment_percentage,\n        pps.berth_efficiency_score,\n        pps.crane_efficiency_score,\n        pps.dwell_time_efficiency_score,\n        ROUND(CAST(pps.performance_score AS NUMERIC), 2) AS performance_score,\n        ROUND(CAST(pps.market_avg_monthly_teu AS NUMERIC), 2) AS market_avg_monthly_teu,\n        ROUND(CAST(pps.throughput_percentile * 100 AS NUMERIC), 2) AS throughput_percentile,\n        -- Performance classification\n        CASE\n            WHEN pps.performance_score >= 80 THEN 'Excellent'\n            WHEN pps.performance_score >= 65 THEN 'Good'\n            WHEN pps.performance_score >= 50 THEN 'Average'\n            WHEN pps.performance_score >= 35 THEN 'Below Average'\n            ELSE 'Poor'\n        END AS performance_class,\n        -- Growth classification\n        CASE\n            WHEN pps.year_over_year_growth_percent IS NOT NULL THEN\n                CASE\n                    WHEN pps.year_over_year_growth_percent > 10 THEN 'Strong Growth'\n                    WHEN pps.year_over_year_growth_percent > 5 THEN 'Moderate Growth'\n                    WHEN pps.year_over_year_growth_percent > 0 THEN 'Slow Growth'\n                    WHEN pps.year_over_year_growth_percent > -5 THEN 'Declining'\n                    ELSE 'Sharp Decline'\n                END\n            ELSE 'Unknown'\n        END AS growth_class\n    FROM port_performance_scoring pps\n)\nSELECT\n    port_id,\n    port_name,\n    port_code,\n    locode,\n    country,\n    country_code,\n    statistic_month,\n    monthly_vessel_calls,\n    monthly_container_teu,\n    monthly_containers_loaded,\n    monthly_containers_discharged,\n    monthly_containers_transshipped,\n    monthly_avg_vessel_size,\n    monthly_avg_dwell_time,\n    monthly_avg_berth_utilization,\n    monthly_avg_crane_utilization,\n    median_monthly_teu,\n    stddev_monthly_teu,\n    moving_avg_teu_3_month,\n    moving_avg_teu_12_month,\n    moving_avg_calls_3_month,\n    prev_month_teu,\n    prev_year_teu,\n    month_over_month_growth_percent,\n    year_over_year_growth_percent,\n    teu_per_vessel_call,\n    loading_percentage,\n    transshipment_percentage,\n    performance_score,\n    market_avg_monthly_teu,\n    throughput_percentile,\n    performance_class,\n    growth_class\nFROM port_classification\nORDER BY statistic_month DESC, performance_score DESC\nLIMIT 1000;",
      "line_number": 1482
    },
    {
      "number": 6,
      "title": "Sailing Capacity Utilization Analysis with Vessel Deployment Optimization",
      "description": "Use Case: Fleet Optimization - Comprehensive Sailing Capacity Utilization Analysis for Vessel Deployment Planning Description: Enterprise-level sailing capacity utilization analysis with multi-level CTE nesting, capacity calculations, utilization scoring, route analysis, vessel deployment optimization, and advanced window functions. Demonstrates production patterns used by shipping lines for fleet optimization. Business Value: Capacity utilization report showing vessel utilization rates, route e",
      "complexity": "Deep nested CTEs (7+ levels), capacity calculations, utilization scoring algorithms, window functions with multiple frame clauses, percentile calculations, route analysis, optimization algorithms",
      "expected_output": "Capacity utilization report with vessel utilization rates, route efficiency metrics, and optimization recommendations.",
      "sql": "WITH vessel_capacity_analysis AS (\n    -- First CTE: Analyze vessel capacity and sailing utilization\n    SELECT\n        s.sailing_id,\n        s.vessel_id,\n        s.voyage_number,\n        s.route_id,\n        s.origin_port_id,\n        s.destination_port_id,\n        s.scheduled_departure,\n        s.actual_departure,\n        s.scheduled_arrival,\n        s.actual_arrival,\n        s.transit_days,\n        s.distance_nautical_miles,\n        s.average_speed_knots,\n        s.total_containers,\n        s.total_teu,\n        s.capacity_utilization_percent,\n        s.status,\n        v.vessel_name,\n        v.imo_number,\n        v.container_capacity_teu,\n        v.carrier_id,\n        c.carrier_name,\n        r.route_name,\n        r.route_code,\n        op.port_name AS origin_port_name,\n        dp.port_name AS destination_port_name,\n        -- Calculate actual capacity utilization\n        CASE\n            WHEN v.container_capacity_teu > 0 AND s.total_teu IS NOT NULL THEN\n                (s.total_teu / v.container_capacity_teu) * 100\n            WHEN s.capacity_utilization_percent IS NOT NULL THEN\n                s.capacity_utilization_percent\n            ELSE NULL\n        END AS calculated_utilization_percent,\n        -- Calculate capacity gap (unused capacity)\n        CASE\n            WHEN v.container_capacity_teu > 0 AND s.total_teu IS NOT NULL THEN\n                v.container_capacity_teu - s.total_teu\n            ELSE NULL\n        END AS unused_capacity_teu\n    FROM sailings s\n    INNER JOIN vessels v ON s.vessel_id = v.vessel_id\n    LEFT JOIN carriers c ON v.carrier_id = c.carrier_id\n    LEFT JOIN routes r ON s.route_id = r.route_id\n    INNER JOIN ports op ON s.origin_port_id = op.port_id\n    INNER JOIN ports dp ON s.destination_port_id = dp.port_id\n    WHERE s.status IN ('Completed', 'In Progress')\n        AND v.container_capacity_teu IS NOT NULL\n),\nroute_capacity_aggregation AS (\n    -- Second CTE: Aggregate capacity metrics by route\n    SELECT\n        vca.route_id,\n        vca.route_name,\n        vca.route_code,\n        vca.carrier_id,\n        vca.carrier_name,\n        vca.origin_port_id,\n        vca.origin_port_name,\n        vca.destination_port_id,\n        vca.destination_port_name,\n        COUNT(*) AS total_sailings,\n        COUNT(DISTINCT vca.vessel_id) AS unique_vessels,\n        AVG(vca.calculated_utilization_percent) AS avg_utilization_percent,\n        AVG(vca.capacity_utilization_percent) AS avg_reported_utilization,\n        AVG(vca.total_teu) AS avg_teu_per_sailing,\n        SUM(vca.total_teu) AS total_teu_carried,\n        SUM(vca.unused_capacity_teu) AS total_unused_capacity_teu,\n        AVG(vca.container_capacity_teu) AS avg_vessel_capacity,\n        PERCENTILE_CONT(0.5) WITHIN GROUP (ORDER BY vca.calculated_utilization_percent) AS median_utilization,\n        PERCENTILE_CONT(0.25) WITHIN GROUP (ORDER BY vca.calculated_utilization_percent) AS q1_utilization,\n        PERCENTILE_CONT(0.75) WITHIN GROUP (ORDER BY vca.calculated_utilization_percent) AS q3_utilization,\n        STDDEV(vca.calculated_utilization_percent) AS stddev_utilization,\n        MIN(vca.calculated_utilization_percent) AS min_utilization,\n        MAX(vca.calculated_utilization_percent) AS max_utilization,\n        COUNT(CASE WHEN vca.calculated_utilization_percent >= 90 THEN 1 END) AS high_utilization_sailings,\n        COUNT(CASE WHEN vca.calculated_utilization_percent < 50 THEN 1 END) AS low_utilization_sailings\n    FROM vessel_capacity_analysis vca\n    WHERE vca.calculated_utilization_percent IS NOT NULL\n    GROUP BY\n        vca.route_id,\n        vca.route_name,\n        vca.route_code,\n        vca.carrier_id,\n        vca.carrier_name,\n        vca.origin_port_id,\n        vca.origin_port_name,\n        vca.destination_port_id,\n        vca.destination_port_name\n),\nvessel_capacity_aggregation AS (\n    -- Third CTE: Aggregate capacity metrics by vessel\n    SELECT\n        vca.vessel_id,\n        vca.vessel_name,\n        vca.imo_number,\n        vca.container_capacity_teu,\n        vca.carrier_id,\n        vca.carrier_name,\n        COUNT(*) AS total_sailings,\n        AVG(vca.calculated_utilization_percent) AS avg_utilization_percent,\n        AVG(vca.total_teu) AS avg_teu_per_sailing,\n        SUM(vca.total_teu) AS total_teu_carried,\n        SUM(vca.unused_capacity_teu) AS total_unused_capacity_teu,\n        PERCENTILE_CONT(0.5) WITHIN GROUP (ORDER BY vca.calculated_utilization_percent) AS median_utilization,\n        STDDEV(vca.calculated_utilization_percent) AS stddev_utilization,\n        COUNT(DISTINCT vca.route_id) AS unique_routes,\n        COUNT(CASE WHEN vca.calculated_utilization_percent >= 90 THEN 1 END) AS high_utilization_sailings,\n        COUNT(CASE WHEN vca.calculated_utilization_percent < 50 THEN 1 END) AS low_utilization_sailings\n    FROM vessel_capacity_analysis vca\n    WHERE vca.calculated_utilization_percent IS NOT NULL\n    GROUP BY\n        vca.vessel_id,\n        vca.vessel_name,\n        vca.imo_number,\n        vca.container_capacity_teu,\n        vca.carrier_id,\n        vca.carrier_name\n),\ncapacity_utilization_scoring AS (\n    -- Fourth CTE: Calculate utilization scores and optimization opportunities\n    SELECT\n        rca.route_id,\n        rca.route_name,\n        rca.route_code,\n        rca.carrier_id,\n        rca.carrier_name,\n        rca.origin_port_id,\n        rca.origin_port_name,\n        rca.destination_port_id,\n        rca.destination_port_name,\n        rca.total_sailings,\n        rca.unique_vessels,\n        ROUND(CAST(rca.avg_utilization_percent AS NUMERIC), 2) AS avg_utilization_percent,\n        ROUND(CAST(rca.avg_reported_utilization AS NUMERIC), 2) AS avg_reported_utilization,\n        ROUND(CAST(rca.avg_teu_per_sailing AS NUMERIC), 2) AS avg_teu_per_sailing,\n        ROUND(CAST(rca.total_teu_carried AS NUMERIC), 2) AS total_teu_carried,\n        ROUND(CAST(rca.total_unused_capacity_teu AS NUMERIC), 2) AS total_unused_capacity_teu,\n        ROUND(CAST(rca.avg_vessel_capacity AS NUMERIC), 2) AS avg_vessel_capacity,\n        ROUND(CAST(rca.median_utilization AS NUMERIC), 2) AS median_utilization,\n        ROUND(CAST(rca.q1_utilization AS NUMERIC), 2) AS q1_utilization,\n        ROUND(CAST(rca.q3_utilization AS NUMERIC), 2) AS q3_utilization,\n        ROUND(CAST(rca.stddev_utilization AS NUMERIC), 2) AS stddev_utilization,\n        ROUND(CAST(rca.min_utilization AS NUMERIC), 2) AS min_utilization,\n        ROUND(CAST(rca.max_utilization AS NUMERIC), 2) AS max_utilization,\n        rca.high_utilization_sailings,\n        rca.low_utilization_sailings,\n        -- Utilization efficiency score\n        CASE\n            WHEN rca.avg_utilization_percent >= 90 THEN 100\n            WHEN rca.avg_utilization_percent >= 80 THEN 80 + (rca.avg_utilization_percent - 80) * 2\n            WHEN rca.avg_utilization_percent >= 70 THEN 60 + (rca.avg_utilization_percent - 70) * 2\n            WHEN rca.avg_utilization_percent >= 60 THEN 40 + (rca.avg_utilization_percent - 60) * 2\n            WHEN rca.avg_utilization_percent >= 50 THEN 20 + (rca.avg_utilization_percent - 50) * 2\n            ELSE rca.avg_utilization_percent * 0.4\n        END AS utilization_efficiency_score,\n        -- Optimization potential (unused capacity percentage)\n        CASE\n            WHEN rca.avg_vessel_capacity > 0 THEN\n                (rca.total_unused_capacity_teu / (rca.avg_vessel_capacity * rca.total_sailings)) * 100\n            ELSE NULL\n        END AS optimization_potential_percent,\n        -- Market comparison\n        AVG(rca.avg_utilization_percent) OVER () AS market_avg_utilization,\n        PERCENT_RANK() OVER (ORDER BY rca.avg_utilization_percent) AS utilization_percentile\n    FROM route_capacity_aggregation rca\n),\nvessel_deployment_analysis AS (\n    -- Fifth CTE: Analyze vessel deployment patterns\n    SELECT\n        vca.vessel_id,\n        vca.vessel_name,\n        vca.imo_number,\n        vca.container_capacity_teu,\n        vca.carrier_id,\n        vca.carrier_name,\n        vca.total_sailings,\n        ROUND(CAST(vca.avg_utilization_percent AS NUMERIC), 2) AS avg_utilization_percent,\n        ROUND(CAST(vca.avg_teu_per_sailing AS NUMERIC), 2) AS avg_teu_per_sailing,\n        ROUND(CAST(vca.total_teu_carried AS NUMERIC), 2) AS total_teu_carried,\n        ROUND(CAST(vca.total_unused_capacity_teu AS NUMERIC), 2) AS total_unused_capacity_teu,\n        ROUND(CAST(vca.median_utilization AS NUMERIC), 2) AS median_utilization,\n        ROUND(CAST(vca.stddev_utilization AS NUMERIC), 2) AS stddev_utilization,\n        vca.unique_routes,\n        vca.high_utilization_sailings,\n        vca.low_utilization_sailings,\n        -- Vessel utilization efficiency\n        CASE\n            WHEN vca.avg_utilization_percent >= 85 THEN 'Highly Utilized'\n            WHEN vca.avg_utilization_percent >= 70 THEN 'Well Utilized'\n            WHEN vca.avg_utilization_percent >= 55 THEN 'Moderately Utilized'\n            WHEN vca.avg_utilization_percent >= 40 THEN 'Underutilized'\n            ELSE 'Poorly Utilized'\n        END AS utilization_class,\n        -- Deployment efficiency (utilization vs route diversity)\n        CASE\n            WHEN vca.unique_routes > 0 THEN\n                vca.avg_utilization_percent / vca.unique_routes\n            ELSE NULL\n        END AS deployment_efficiency_score\n    FROM vessel_capacity_aggregation vca\n),\ncapacity_optimization_recommendations AS (\n    -- Sixth CTE: Generate optimization recommendations\n    SELECT\n        cus.route_id,\n        cus.route_name,\n        cus.route_code,\n        cus.carrier_id,\n        cus.carrier_name,\n        cus.origin_port_id,\n        cus.origin_port_name,\n        cus.destination_port_id,\n        cus.destination_port_name,\n        cus.total_sailings,\n        cus.unique_vessels,\n        cus.avg_utilization_percent,\n        cus.avg_reported_utilization,\n        cus.avg_teu_per_sailing,\n        cus.total_teu_carried,\n        cus.total_unused_capacity_teu,\n        cus.avg_vessel_capacity,\n        cus.median_utilization,\n        cus.stddev_utilization,\n        cus.min_utilization,\n        cus.max_utilization,\n        cus.high_utilization_sailings,\n        cus.low_utilization_sailings,\n        ROUND(CAST(cus.utilization_efficiency_score AS NUMERIC), 2) AS utilization_efficiency_score,\n        ROUND(CAST(cus.optimization_potential_percent AS NUMERIC), 2) AS optimization_potential_percent,\n        ROUND(CAST(cus.market_avg_utilization AS NUMERIC), 2) AS market_avg_utilization,\n        ROUND(CAST(cus.utilization_percentile * 100 AS NUMERIC), 2) AS utilization_percentile,\n        -- Optimization classification\n        CASE\n            WHEN cus.avg_utilization_percent >= 85 THEN 'Optimal'\n            WHEN cus.avg_utilization_percent >= 70 THEN 'Good'\n            WHEN cus.avg_utilization_percent >= 55 THEN 'Moderate'\n            WHEN cus.avg_utilization_percent >= 40 THEN 'Needs Improvement'\n            ELSE 'Poor'\n        END AS utilization_class,\n        -- Optimization recommendation\n        CASE\n            WHEN cus.avg_utilization_percent < 50 AND cus.total_sailings > 10 THEN 'Consider Route Consolidation'\n            WHEN cus.avg_utilization_percent < 60 AND cus.stddev_utilization > 20 THEN 'Improve Load Planning'\n            WHEN cus.avg_utilization_percent >= 90 THEN 'Maintain Current Operations'\n            WHEN cus.optimization_potential_percent > 30 THEN 'High Optimization Potential'\n            ELSE 'Monitor and Optimize'\n        END AS optimization_recommendation\n    FROM capacity_utilization_scoring cus\n)\nSELECT\n    route_id,\n    route_name,\n    route_code,\n    carrier_id,\n    carrier_name,\n    origin_port_id,\n    origin_port_name,\n    destination_port_id,\n    destination_port_name,\n    total_sailings,\n    unique_vessels,\n    avg_utilization_percent,\n    avg_reported_utilization,\n    avg_teu_per_sailing,\n    total_teu_carried,\n    total_unused_capacity_teu,\n    avg_vessel_capacity,\n    median_utilization,\n    stddev_utilization,\n    min_utilization,\n    max_utilization,\n    high_utilization_sailings,\n    low_utilization_sailings,\n    utilization_efficiency_score,\n    optimization_potential_percent,\n    market_avg_utilization,\n    utilization_percentile,\n    utilization_class,\n    optimization_recommendation\nFROM capacity_optimization_recommendations\nWHERE total_sailings >= 5\nORDER BY avg_utilization_percent ASC, optimization_potential_percent DESC\nLIMIT 1000;",
      "line_number": 1850
    },
    {
      "number": 7,
      "title": "Multi-Port Route Analysis with Transshipment Detection and Route Path Optimization",
      "description": "Use Case: Route Planning - Comprehensive Multi-Port Route Analysis with Transshipment Detection for Logistics Optimization Description: Enterprise-level multi-port route analysis with recursive CTE traversal, transshipment detection, route path analysis, connectivity mapping, and advanced window functions. Demonstrates production patterns used by logistics companies for multi-port route optimization. Business Value: Multi-port route report showing route paths, transshipment points, connectivity ",
      "complexity": "Recursive CTE with route traversal, transshipment detection algorithms, path analysis, window functions with multiple frame clauses, connectivity calculations, cycle detection",
      "expected_output": "Multi-port route report with route paths, transshipment points, connectivity analysis, and path optimization recommendations.",
      "sql": "WITH RECURSIVE route_port_paths AS (\n    -- Anchor CTE: Direct port connections in routes\n    SELECT\n        r.route_id,\n        r.route_name,\n        r.route_code,\n        r.carrier_id,\n        c.carrier_name,\n        rp1.port_id AS origin_port_id,\n        p1.port_name AS origin_port_name,\n        p1.port_code AS origin_port_code,\n        rp1.port_sequence AS origin_sequence,\n        rp2.port_id AS destination_port_id,\n        p2.port_name AS destination_port_name,\n        p2.port_code AS destination_port_code,\n        rp2.port_sequence AS destination_sequence,\n        1 AS hop_count,\n        ARRAY[rp1.port_id::VARCHAR, rp2.port_id::VARCHAR]::VARCHAR[] AS port_path,\n        ARRAY[rp1.port_sequence::INTEGER, rp2.port_sequence::INTEGER]::INTEGER[] AS sequence_path,\n        CASE\n            WHEN rp2.port_role = 'Transshipment' THEN TRUE\n            ELSE FALSE\n        END AS has_transshipment,\n        CASE\n            WHEN p1.port_geom IS NOT NULL AND p2.port_geom IS NOT NULL THEN\n                ST_DISTANCE(p1.port_geom, p2.port_geom) / 1852.0\n            ELSE NULL\n        END AS distance_nm\n    FROM routes r\n    LEFT JOIN carriers c ON r.carrier_id = c.carrier_id\n    INNER JOIN route_ports rp1 ON r.route_id = rp1.route_id\n    INNER JOIN route_ports rp2 ON r.route_id = rp2.route_id\n    INNER JOIN ports p1 ON rp1.port_id = p1.port_id\n    INNER JOIN ports p2 ON rp2.port_id = p2.port_id\n    WHERE rp2.port_sequence = rp1.port_sequence + 1\n        AND r.status = 'Active'\n    UNION ALL\n    -- Recursive CTE: Extend paths through multiple ports\n    SELECT\n        rpp.route_id,\n        rpp.route_name,\n        rpp.route_code,\n        rpp.carrier_id,\n        rpp.carrier_name,\n        rpp.origin_port_id,\n        rpp.origin_port_name,\n        rpp.origin_port_code,\n        rpp.origin_sequence,\n        rp_next.port_id AS destination_port_id,\n        p_next.port_name AS destination_port_name,\n        p_next.port_code AS destination_port_code,\n        rp_next.port_sequence AS destination_sequence,\n        rpp.hop_count + 1 AS hop_count,\n        (rpp.port_path || ARRAY[rp_next.port_id::VARCHAR])::VARCHAR[] AS port_path,\n        (rpp.sequence_path || ARRAY[rp_next.port_sequence::INTEGER])::INTEGER[] AS sequence_path,\n        CASE\n            WHEN rpp.has_transshipment = TRUE OR rp_next.port_role = 'Transshipment' THEN TRUE\n            ELSE FALSE\n        END AS has_transshipment,\n        CASE\n            WHEN rpp.distance_nm IS NOT NULL AND p_prev.port_geom IS NOT NULL AND p_next.port_geom IS NOT NULL THEN\n                rpp.distance_nm + (ST_DISTANCE(p_prev.port_geom, p_next.port_geom) / 1852.0)\n            ELSE rpp.distance_nm\n        END AS distance_nm\n    FROM route_port_paths rpp\n    INNER JOIN route_ports rp_next ON rpp.route_id = rp_next.route_id\n    INNER JOIN ports p_next ON rp_next.port_id = p_next.port_id\n    INNER JOIN ports p_prev ON rpp.destination_port_id = p_prev.port_id\n    WHERE rp_next.port_sequence = rpp.destination_sequence + 1\n        AND rp_next.port_id != ALL(rpp.port_path)  -- Avoid cycles\n        AND rpp.hop_count < 10  -- Limit recursion depth\n),\nroute_path_aggregation AS (\n    -- Second CTE: Aggregate paths by route and port pairs\n    SELECT\n        rpp.route_id,\n        rpp.route_name,\n        rpp.route_code,\n        rpp.carrier_id,\n        rpp.carrier_name,\n        rpp.origin_port_id,\n        rpp.origin_port_name,\n        rpp.origin_port_code,\n        rpp.destination_port_id,\n        rpp.destination_port_name,\n        rpp.destination_port_code,\n        rpp.hop_count,\n        rpp.port_path,\n        rpp.sequence_path,\n        rpp.has_transshipment,\n        rpp.distance_nm,\n        -- Count intermediate ports\n        array_length(rpp.port_path, 1) - 2 AS intermediate_port_count,\n        -- Check if direct route exists\n        CASE\n            WHEN rpp.hop_count = 1 THEN TRUE\n            ELSE FALSE\n        END AS is_direct_route\n    FROM route_port_paths rpp\n),\ntransshipment_detection AS (\n    -- Third CTE: Detect and analyze transshipment points\n    SELECT\n        rpa.route_id,\n        rpa.route_name,\n        rpa.route_code,\n        rpa.carrier_id,\n        rpa.carrier_name,\n        rpa.origin_port_id,\n        rpa.origin_port_name,\n        rpa.origin_port_code,\n        rpa.destination_port_id,\n        rpa.destination_port_name,\n        rpa.destination_port_code,\n        rpa.hop_count,\n        rpa.port_path,\n        rpa.sequence_path,\n        rpa.has_transshipment,\n        rpa.distance_nm,\n        rpa.intermediate_port_count,\n        rpa.is_direct_route,\n        -- Extract transshipment ports from path\n        CASE\n            WHEN rpa.has_transshipment AND array_length(rpa.port_path, 1) > 2 THEN\n                rpa.port_path[2:array_length(rpa.port_path, 1) - 1]\n            ELSE ARRAY[]::VARCHAR[]\n        END AS transshipment_ports,\n        -- Count transshipments\n        CASE\n            WHEN rpa.has_transshipment THEN\n                array_length(rpa.port_path, 1) - 2\n            ELSE 0\n        END AS transshipment_count\n    FROM route_path_aggregation rpa\n),\nroute_connectivity_analysis AS (\n    -- Fourth CTE: Analyze route connectivity and path efficiency\n    SELECT\n        td.route_id,\n        td.route_name,\n        td.route_code,\n        td.carrier_id,\n        td.carrier_name,\n        td.origin_port_id,\n        td.origin_port_name,\n        td.origin_port_code,\n        td.destination_port_id,\n        td.destination_port_name,\n        td.destination_port_code,\n        td.hop_count,\n        td.port_path,\n        td.sequence_path,\n        td.has_transshipment,\n        ROUND(CAST(td.distance_nm AS NUMERIC), 2) AS distance_nm,\n        td.intermediate_port_count,\n        td.is_direct_route,\n        td.transshipment_ports,\n        td.transshipment_count,\n        -- Find shortest path for same port pair\n        MIN(td.hop_count) OVER (\n            PARTITION BY td.origin_port_id, td.destination_port_id, td.carrier_id\n        ) AS shortest_path_hops,\n        MIN(td.distance_nm) OVER (\n            PARTITION BY td.origin_port_id, td.destination_port_id, td.carrier_id\n        ) AS shortest_path_distance,\n        -- Path efficiency (distance per hop)\n        CASE\n            WHEN td.hop_count > 0 THEN\n                td.distance_nm / td.hop_count\n            ELSE NULL\n        END AS distance_per_hop_nm,\n        -- Compare with direct distance\n        (\n            SELECT ST_DISTANCE(p1.port_geom, p2.port_geom) / 1852.0\n            FROM ports p1, ports p2\n            WHERE p1.port_id = td.origin_port_id\n                AND p2.port_id = td.destination_port_id\n                AND p1.port_geom IS NOT NULL\n                AND p2.port_geom IS NOT NULL\n        ) AS direct_distance_nm,\n        -- Path efficiency ratio\n        CASE\n            WHEN (\n                SELECT ST_DISTANCE(p1.port_geom, p2.port_geom) / 1852.0\n                FROM ports p1, ports p2\n                WHERE p1.port_id = td.origin_port_id\n                    AND p2.port_id = td.destination_port_id\n                    AND p1.port_geom IS NOT NULL\n                    AND p2.port_geom IS NOT NULL\n            ) > 0 THEN\n                td.distance_nm / (\n                    SELECT ST_DISTANCE(p1.port_geom, p2.port_geom) / 1852.0\n                    FROM ports p1, ports p2\n                    WHERE p1.port_id = td.origin_port_id\n                        AND p2.port_id = td.destination_port_id\n                        AND p1.port_geom IS NOT NULL\n                        AND p2.port_geom IS NOT NULL\n                )\n            ELSE NULL\n        END AS path_efficiency_ratio\n    FROM transshipment_detection td\n),\nroute_path_optimization AS (\n    -- Fifth CTE: Identify optimization opportunities\n    SELECT\n        rca.route_id,\n        rca.route_name,\n        rca.route_code,\n        rca.carrier_id,\n        rca.carrier_name,\n        rca.origin_port_id,\n        rca.origin_port_name,\n        rca.origin_port_code,\n        rca.destination_port_id,\n        rca.destination_port_name,\n        rca.destination_port_code,\n        rca.hop_count,\n        rca.port_path,\n        rca.sequence_path,\n        rca.has_transshipment,\n        rca.distance_nm,\n        rca.intermediate_port_count,\n        rca.is_direct_route,\n        rca.transshipment_ports,\n        rca.transshipment_count,\n        rca.shortest_path_hops,\n        rca.shortest_path_distance,\n        ROUND(CAST(rca.distance_per_hop_nm AS NUMERIC), 2) AS distance_per_hop_nm,\n        ROUND(CAST(rca.direct_distance_nm AS NUMERIC), 2) AS direct_distance_nm,\n        ROUND(CAST(rca.path_efficiency_ratio AS NUMERIC), 2) AS path_efficiency_ratio,\n        -- Path classification\n        CASE\n            WHEN rca.is_direct_route THEN 'Direct'\n            WHEN rca.transshipment_count = 1 THEN 'Single Transshipment'\n            WHEN rca.transshipment_count = 2 THEN 'Double Transshipment'\n            WHEN rca.transshipment_count > 2 THEN 'Multiple Transshipments'\n            ELSE 'Multi-Port'\n        END AS path_type,\n        -- Optimization opportunity\n        CASE\n            WHEN rca.hop_count > rca.shortest_path_hops THEN 'Can Optimize'\n            WHEN rca.path_efficiency_ratio IS NOT NULL AND rca.path_efficiency_ratio > 1.5 THEN 'Inefficient Path'\n            WHEN rca.transshipment_count > 2 THEN 'Too Many Transshipments'\n            WHEN rca.is_direct_route THEN 'Optimal'\n            ELSE 'Acceptable'\n        END AS optimization_status\n    FROM route_connectivity_analysis rca\n)\nSELECT\n    route_id,\n    route_name,\n    route_code,\n    carrier_id,\n    carrier_name,\n    origin_port_id,\n    origin_port_name,\n    origin_port_code,\n    destination_port_id,\n    destination_port_name,\n    destination_port_code,\n    hop_count,\n    port_path,\n    sequence_path,\n    has_transshipment,\n    distance_nm,\n    intermediate_port_count,\n    is_direct_route,\n    transshipment_ports,\n    transshipment_count,\n    shortest_path_hops,\n    shortest_path_distance,\n    distance_per_hop_nm,\n    direct_distance_nm,\n    path_efficiency_ratio,\n    path_type,\n    optimization_status\nFROM route_path_optimization\nWHERE hop_count <= 5\nORDER BY hop_count ASC, distance_nm ASC\nLIMIT 2000;",
      "line_number": 2158
    },
    {
      "number": 8,
      "title": "Vessel Utilization Analysis Across Carriers with Fleet Performance Comparison",
      "description": "Use Case: Fleet Management - Comprehensive Vessel Utilization Analysis Across Carriers for Fleet Optimization Description: Enterprise-level vessel utilization analysis with multi-level CTE nesting, utilization calculations, carrier comparisons, vessel performance metrics, and advanced window functions. Demonstrates production patterns used by shipping lines for fleet optimization. Business Value: Vessel utilization report showing utilization rates across carriers, vessel performance, optimizatio",
      "complexity": "Deep nested CTEs (7+ levels), utilization calculations, carrier comparisons, window functions with multiple frame clauses, percentile calculations, performance metrics, fleet analysis",
      "expected_output": "Vessel utilization report with utilization rates across carriers, vessel performance metrics, and optimization opportunities.",
      "sql": "WITH vessel_sailing_utilization AS (\n    -- First CTE: Calculate vessel utilization from sailings\n    SELECT\n        v.vessel_id,\n        v.vessel_name,\n        v.imo_number,\n        v.container_capacity_teu,\n        v.carrier_id,\n        c.carrier_name,\n        COUNT(DISTINCT s.sailing_id) AS total_sailings,\n        COUNT(DISTINCT CASE WHEN s.status = 'Completed' THEN s.sailing_id END) AS completed_sailings,\n        AVG(s.capacity_utilization_percent) AS avg_utilization_percent,\n        AVG(s.total_teu) AS avg_teu_per_sailing,\n        SUM(s.total_teu) AS total_teu_carried,\n        AVG(s.transit_days) AS avg_transit_days,\n        AVG(s.distance_nautical_miles) AS avg_distance_nm,\n        PERCENTILE_CONT(0.5) WITHIN GROUP (ORDER BY s.capacity_utilization_percent) AS median_utilization,\n        PERCENTILE_CONT(0.25) WITHIN GROUP (ORDER BY s.capacity_utilization_percent) AS q1_utilization,\n        PERCENTILE_CONT(0.75) WITHIN GROUP (ORDER BY s.capacity_utilization_percent) AS q3_utilization,\n        STDDEV(s.capacity_utilization_percent) AS stddev_utilization,\n        MIN(s.capacity_utilization_percent) AS min_utilization,\n        MAX(s.capacity_utilization_percent) AS max_utilization,\n        COUNT(DISTINCT s.route_id) AS unique_routes,\n        COUNT(DISTINCT s.origin_port_id) AS unique_origin_ports,\n        COUNT(DISTINCT s.destination_port_id) AS unique_destination_ports\n    FROM vessels v\n    LEFT JOIN carriers c ON v.carrier_id = c.carrier_id\n    LEFT JOIN sailings s ON v.vessel_id = s.vessel_id\n    WHERE v.status = 'Active'\n        AND v.container_capacity_teu IS NOT NULL\n        AND (s.status IS NULL OR s.status IN ('Completed', 'In Progress'))\n    GROUP BY v.vessel_id, v.vessel_name, v.imo_number, v.container_capacity_teu, v.carrier_id, c.carrier_name\n),\nvessel_port_call_utilization AS (\n    -- Second CTE: Calculate utilization from port calls\n    SELECT\n        v.vessel_id,\n        COUNT(DISTINCT pc.port_call_id) AS total_port_calls,\n        SUM(COALESCE(pc.containers_loaded, 0) + COALESCE(pc.containers_discharged, 0) + COALESCE(pc.containers_transshipped, 0)) AS total_containers_handled,\n        AVG(CASE \n            WHEN pc.actual_arrival IS NOT NULL AND pc.actual_departure IS NOT NULL THEN\n                EXTRACT(EPOCH FROM (pc.actual_departure - pc.actual_arrival)) / 3600.0\n            ELSE NULL\n        END) AS avg_dwell_time_hours\n    FROM vessels v\n    LEFT JOIN port_calls pc ON v.vessel_id = pc.vessel_id\n    WHERE v.status = 'Active'\n        AND (pc.status IS NULL OR pc.status IN ('Completed', 'In Progress'))\n    GROUP BY v.vessel_id\n),\nvessel_comprehensive_utilization AS (\n    -- Third CTE: Combine sailing and port call utilization\n    SELECT\n        vsu.vessel_id,\n        vsu.vessel_name,\n        vsu.imo_number,\n        vsu.container_capacity_teu,\n        vsu.carrier_id,\n        vsu.carrier_name,\n        vsu.total_sailings,\n        vsu.completed_sailings,\n        ROUND(CAST(vsu.avg_utilization_percent AS NUMERIC), 2) AS avg_utilization_percent,\n        ROUND(CAST(vsu.avg_teu_per_sailing AS NUMERIC), 2) AS avg_teu_per_sailing,\n        ROUND(CAST(vsu.total_teu_carried AS NUMERIC), 2) AS total_teu_carried,\n        ROUND(CAST(vsu.avg_transit_days AS NUMERIC), 2) AS avg_transit_days,\n        ROUND(CAST(vsu.avg_distance_nm AS NUMERIC), 2) AS avg_distance_nm,\n        ROUND(CAST(vsu.median_utilization AS NUMERIC), 2) AS median_utilization,\n        ROUND(CAST(vsu.q1_utilization AS NUMERIC), 2) AS q1_utilization,\n        ROUND(CAST(vsu.q3_utilization AS NUMERIC), 2) AS q3_utilization,\n        ROUND(CAST(vsu.stddev_utilization AS NUMERIC), 2) AS stddev_utilization,\n        ROUND(CAST(vsu.min_utilization AS NUMERIC), 2) AS min_utilization,\n        ROUND(CAST(vsu.max_utilization AS NUMERIC), 2) AS max_utilization,\n        vsu.unique_routes,\n        vsu.unique_origin_ports,\n        vsu.unique_destination_ports,\n        vpcu.total_port_calls,\n        ROUND(CAST(vpcu.total_containers_handled AS NUMERIC), 0) AS total_containers_handled,\n        ROUND(CAST(vpcu.avg_dwell_time_hours AS NUMERIC), 2) AS avg_dwell_time_hours,\n        -- Calculate theoretical maximum capacity\n        CASE\n            WHEN vsu.total_sailings > 0 AND vsu.avg_transit_days IS NOT NULL THEN\n                vsu.container_capacity_teu * (365.0 / vsu.avg_transit_days) * vsu.total_sailings / 365.0\n            ELSE NULL\n        END AS theoretical_max_capacity_teu,\n        -- Utilization efficiency score\n        CASE\n            WHEN vsu.avg_utilization_percent >= 90 THEN 100\n            WHEN vsu.avg_utilization_percent >= 80 THEN 80 + (vsu.avg_utilization_percent - 80) * 2\n            WHEN vsu.avg_utilization_percent >= 70 THEN 60 + (vsu.avg_utilization_percent - 70) * 2\n            WHEN vsu.avg_utilization_percent >= 60 THEN 40 + (vsu.avg_utilization_percent - 60) * 2\n            WHEN vsu.avg_utilization_percent >= 50 THEN 20 + (vsu.avg_utilization_percent - 50) * 2\n            ELSE vsu.avg_utilization_percent * 0.4\n        END AS utilization_efficiency_score\n    FROM vessel_sailing_utilization vsu\n    LEFT JOIN vessel_port_call_utilization vpcu ON vsu.vessel_id = vpcu.vessel_id\n),\ncarrier_vessel_comparison AS (\n    -- Fourth CTE: Compare vessels within and across carriers\n    SELECT\n        vcu.vessel_id,\n        vcu.vessel_name,\n        vcu.imo_number,\n        vcu.container_capacity_teu,\n        vcu.carrier_id,\n        vcu.carrier_name,\n        vcu.total_sailings,\n        vcu.completed_sailings,\n        vcu.avg_utilization_percent,\n        vcu.avg_teu_per_sailing,\n        vcu.total_teu_carried,\n        vcu.avg_transit_days,\n        vcu.avg_distance_nm,\n        vcu.median_utilization,\n        vcu.stddev_utilization,\n        vcu.min_utilization,\n        vcu.max_utilization,\n        vcu.unique_routes,\n        vcu.unique_origin_ports,\n        vcu.unique_destination_ports,\n        vcu.total_port_calls,\n        vcu.total_containers_handled,\n        vcu.avg_dwell_time_hours,\n        vcu.theoretical_max_capacity_teu,\n        vcu.utilization_efficiency_score,\n        -- Carrier averages for comparison\n        AVG(vcu.avg_utilization_percent) OVER (PARTITION BY vcu.carrier_id) AS carrier_avg_utilization,\n        AVG(vcu.avg_utilization_percent) OVER () AS market_avg_utilization,\n        -- Rankings\n        RANK() OVER (PARTITION BY vcu.carrier_id ORDER BY vcu.avg_utilization_percent DESC) AS carrier_utilization_rank,\n        RANK() OVER (ORDER BY vcu.avg_utilization_percent DESC) AS market_utilization_rank,\n        COUNT(*) OVER (PARTITION BY vcu.carrier_id) AS carrier_vessel_count,\n        COUNT(*) OVER () AS total_vessel_count,\n        -- Percentile rankings\n        PERCENT_RANK() OVER (PARTITION BY vcu.carrier_id ORDER BY vcu.avg_utilization_percent) AS carrier_percentile,\n        PERCENT_RANK() OVER (ORDER BY vcu.avg_utilization_percent) AS market_percentile\n    FROM vessel_comprehensive_utilization vcu\n    WHERE vcu.total_sailings > 0\n),\nvessel_performance_classification AS (\n    -- Fifth CTE: Classify vessels by performance\n    SELECT\n        cvc.vessel_id,\n        cvc.vessel_name,\n        cvc.imo_number,\n        cvc.container_capacity_teu,\n        cvc.carrier_id,\n        cvc.carrier_name,\n        cvc.total_sailings,\n        cvc.completed_sailings,\n        cvc.avg_utilization_percent,\n        cvc.avg_teu_per_sailing,\n        cvc.total_teu_carried,\n        cvc.avg_transit_days,\n        cvc.avg_distance_nm,\n        cvc.median_utilization,\n        cvc.stddev_utilization,\n        cvc.min_utilization,\n        cvc.max_utilization,\n        cvc.unique_routes,\n        cvc.unique_origin_ports,\n        cvc.unique_destination_ports,\n        cvc.total_port_calls,\n        cvc.total_containers_handled,\n        cvc.avg_dwell_time_hours,\n        ROUND(CAST(cvc.theoretical_max_capacity_teu AS NUMERIC), 2) AS theoretical_max_capacity_teu,\n        ROUND(CAST(cvc.utilization_efficiency_score AS NUMERIC), 2) AS utilization_efficiency_score,\n        ROUND(CAST(cvc.carrier_avg_utilization AS NUMERIC), 2) AS carrier_avg_utilization,\n        ROUND(CAST(cvc.market_avg_utilization AS NUMERIC), 2) AS market_avg_utilization,\n        cvc.carrier_utilization_rank,\n        cvc.market_utilization_rank,\n        cvc.carrier_vessel_count,\n        cvc.total_vessel_count,\n        ROUND(CAST(cvc.carrier_percentile * 100 AS NUMERIC), 2) AS carrier_percentile,\n        ROUND(CAST(cvc.market_percentile * 100 AS NUMERIC), 2) AS market_percentile,\n        -- Performance classification\n        CASE\n            WHEN cvc.avg_utilization_percent >= 85 THEN 'Highly Utilized'\n            WHEN cvc.avg_utilization_percent >= 70 THEN 'Well Utilized'\n            WHEN cvc.avg_utilization_percent >= 55 THEN 'Moderately Utilized'\n            WHEN cvc.avg_utilization_percent >= 40 THEN 'Underutilized'\n            ELSE 'Poorly Utilized'\n        END AS utilization_class,\n        -- Performance vs carrier\n        CASE\n            WHEN cvc.avg_utilization_percent > cvc.carrier_avg_utilization * 1.1 THEN 'Above Carrier Average'\n            WHEN cvc.avg_utilization_percent > cvc.carrier_avg_utilization * 0.9 THEN 'At Carrier Average'\n            ELSE 'Below Carrier Average'\n        END AS carrier_performance_class,\n        -- Performance vs market\n        CASE\n            WHEN cvc.avg_utilization_percent > cvc.market_avg_utilization * 1.1 THEN 'Above Market Average'\n            WHEN cvc.avg_utilization_percent > cvc.market_avg_utilization * 0.9 THEN 'At Market Average'\n            ELSE 'Below Market Average'\n        END AS market_performance_class\n    FROM carrier_vessel_comparison cvc\n)\nSELECT\n    vessel_id,\n    vessel_name,\n    imo_number,\n    container_capacity_teu,\n    carrier_id,\n    carrier_name,\n    total_sailings,\n    completed_sailings,\n    avg_utilization_percent,\n    avg_teu_per_sailing,\n    total_teu_carried,\n    avg_transit_days,\n    avg_distance_nm,\n    median_utilization,\n    stddev_utilization,\n    min_utilization,\n    max_utilization,\n    unique_routes,\n    unique_origin_ports,\n    unique_destination_ports,\n    total_port_calls,\n    total_containers_handled,\n    avg_dwell_time_hours,\n    theoretical_max_capacity_teu,\n    utilization_efficiency_score,\n    carrier_avg_utilization,\n    market_avg_utilization,\n    carrier_utilization_rank,\n    market_utilization_rank,\n    carrier_vessel_count,\n    total_vessel_count,\n    carrier_percentile,\n    market_percentile,\n    utilization_class,\n    carrier_performance_class,\n    market_performance_class\nFROM vessel_performance_classification\nORDER BY avg_utilization_percent DESC, carrier_id\nLIMIT 500;",
      "line_number": 2459
    },
    {
      "number": 9,
      "title": "Port Pair Demand Analysis with Trade Flow Intelligence and Market Trends",
      "description": "Use Case: Market Analysis - Comprehensive Port Pair Demand Analysis for Trade Flow Intelligence Description: Enterprise-level port pair demand analysis with multi-level CTE nesting, demand calculations, trade flow analysis, trend detection, market opportunity identification, and advanced window functions. Demonstrates production patterns used by shipping lines for market analysis. Business Value: Port pair demand report showing trade volumes, demand trends, market opportunities, and growth patte",
      "complexity": "Deep nested CTEs (7+ levels), demand calculations, trend analysis, window functions with multiple frame clauses, percentile calculations, market analysis, growth rate calculations",
      "expected_output": "Port pair demand report with trade volumes, demand trends, and market opportunity analysis.",
      "sql": "WITH port_pair_sailing_volume AS (\n    -- First CTE: Aggregate sailing volumes by port pair\n    SELECT\n        s.origin_port_id,\n        op.port_name AS origin_port_name,\n        op.port_code AS origin_port_code,\n        op.locode AS origin_locode,\n        op.country AS origin_country,\n        s.destination_port_id,\n        dp.port_name AS destination_port_name,\n        dp.port_code AS destination_port_code,\n        dp.locode AS destination_locode,\n        dp.country AS destination_country,\n        r.carrier_id,\n        c.carrier_name,\n        COUNT(DISTINCT s.sailing_id) AS total_sailings,\n        COUNT(DISTINCT CASE WHEN s.status = 'Completed' THEN s.sailing_id END) AS completed_sailings,\n        SUM(s.total_teu) AS total_teu_carried,\n        AVG(s.total_teu) AS avg_teu_per_sailing,\n        AVG(s.capacity_utilization_percent) AS avg_capacity_utilization,\n        DATE_TRUNC('month', s.scheduled_departure) AS sailing_month,\n        DATE_TRUNC('quarter', s.scheduled_departure) AS sailing_quarter,\n        DATE_TRUNC('year', s.scheduled_departure) AS sailing_year\n    FROM sailings s\n    INNER JOIN routes r ON s.route_id = r.route_id\n    INNER JOIN ports op ON s.origin_port_id = op.port_id\n    INNER JOIN ports dp ON s.destination_port_id = dp.port_id\n    LEFT JOIN carriers c ON r.carrier_id = c.carrier_id\n    WHERE s.scheduled_departure >= CURRENT_DATE - INTERVAL '2 years'\n        AND s.status IN ('Completed', 'In Progress')\n    GROUP BY\n        s.origin_port_id,\n        op.port_name,\n        op.port_code,\n        op.locode,\n        op.country,\n        s.destination_port_id,\n        dp.port_name,\n        dp.port_code,\n        dp.locode,\n        dp.country,\n        r.carrier_id,\n        c.carrier_name,\n        DATE_TRUNC('month', s.scheduled_departure),\n        DATE_TRUNC('quarter', s.scheduled_departure),\n        DATE_TRUNC('year', s.scheduled_departure)\n),\nport_pair_monthly_aggregation AS (\n    -- Second CTE: Aggregate by port pair and month\n    SELECT\n        ppsv.origin_port_id,\n        ppsv.origin_port_name,\n        ppsv.origin_port_code,\n        ppsv.origin_locode,\n        ppsv.origin_country,\n        ppsv.destination_port_id,\n        ppsv.destination_port_name,\n        ppsv.destination_port_code,\n        ppsv.destination_locode,\n        ppsv.destination_country,\n        ppsv.sailing_month,\n        COUNT(DISTINCT ppsv.carrier_id) AS unique_carriers,\n        SUM(ppsv.total_sailings) AS monthly_sailings,\n        SUM(ppsv.completed_sailings) AS monthly_completed_sailings,\n        SUM(ppsv.total_teu_carried) AS monthly_teu,\n        AVG(ppsv.avg_teu_per_sailing) AS monthly_avg_teu_per_sailing,\n        AVG(ppsv.avg_capacity_utilization) AS monthly_avg_capacity_utilization,\n        PERCENTILE_CONT(0.5) WITHIN GROUP (ORDER BY ppsv.total_teu_carried) AS median_monthly_teu,\n        STDDEV(ppsv.total_teu_carried) AS stddev_monthly_teu\n    FROM port_pair_sailing_volume ppsv\n    GROUP BY\n        ppsv.origin_port_id,\n        ppsv.origin_port_name,\n        ppsv.origin_port_code,\n        ppsv.origin_locode,\n        ppsv.origin_country,\n        ppsv.destination_port_id,\n        ppsv.destination_port_name,\n        ppsv.destination_port_code,\n        ppsv.destination_locode,\n        ppsv.destination_country,\n        ppsv.sailing_month\n),\nport_pair_trend_analysis AS (\n    -- Third CTE: Analyze trends with window functions\n    SELECT\n        ppma.origin_port_id,\n        ppma.origin_port_name,\n        ppma.origin_port_code,\n        ppma.origin_locode,\n        ppma.origin_country,\n        ppma.destination_port_id,\n        ppma.destination_port_name,\n        ppma.destination_port_code,\n        ppma.destination_locode,\n        ppma.destination_country,\n        ppma.sailing_month,\n        ppma.unique_carriers,\n        ppma.monthly_sailings,\n        ppma.monthly_completed_sailings,\n        ROUND(CAST(ppma.monthly_teu AS NUMERIC), 2) AS monthly_teu,\n        ROUND(CAST(ppma.monthly_avg_teu_per_sailing AS NUMERIC), 2) AS monthly_avg_teu_per_sailing,\n        ROUND(CAST(ppma.monthly_avg_capacity_utilization AS NUMERIC), 2) AS monthly_avg_capacity_utilization,\n        ROUND(CAST(ppma.median_monthly_teu AS NUMERIC), 2) AS median_monthly_teu,\n        ROUND(CAST(ppma.stddev_monthly_teu AS NUMERIC), 2) AS stddev_monthly_teu,\n        -- Moving averages\n        AVG(ppma.monthly_teu) OVER (\n            PARTITION BY ppma.origin_port_id, ppma.destination_port_id\n            ORDER BY ppma.sailing_month\n            ROWS BETWEEN 2 PRECEDING AND CURRENT ROW\n        ) AS moving_avg_teu_3_month,\n        AVG(ppma.monthly_teu) OVER (\n            PARTITION BY ppma.origin_port_id, ppma.destination_port_id\n            ORDER BY ppma.sailing_month\n            ROWS BETWEEN 11 PRECEDING AND CURRENT ROW\n        ) AS moving_avg_teu_12_month,\n        -- Previous periods for comparison\n        LAG(ppma.monthly_teu, 1) OVER (\n            PARTITION BY ppma.origin_port_id, ppma.destination_port_id\n            ORDER BY ppma.sailing_month\n        ) AS prev_month_teu,\n        LAG(ppma.monthly_teu, 12) OVER (\n            PARTITION BY ppma.origin_port_id, ppma.destination_port_id\n            ORDER BY ppma.sailing_month\n        ) AS prev_year_teu,\n        -- Growth rates\n        CASE\n            WHEN LAG(ppma.monthly_teu, 1) OVER (PARTITION BY ppma.origin_port_id, ppma.destination_port_id ORDER BY ppma.sailing_month) > 0 THEN\n                ((ppma.monthly_teu - LAG(ppma.monthly_teu, 1) OVER (PARTITION BY ppma.origin_port_id, ppma.destination_port_id ORDER BY ppma.sailing_month)) / \n                 LAG(ppma.monthly_teu, 1) OVER (PARTITION BY ppma.origin_port_id, ppma.destination_port_id ORDER BY ppma.sailing_month)) * 100\n            ELSE NULL\n        END AS month_over_month_growth_percent,\n        CASE\n            WHEN LAG(ppma.monthly_teu, 12) OVER (PARTITION BY ppma.origin_port_id, ppma.destination_port_id ORDER BY ppma.sailing_month) > 0 THEN\n                ((ppma.monthly_teu - LAG(ppma.monthly_teu, 12) OVER (PARTITION BY ppma.origin_port_id, ppma.destination_port_id ORDER BY ppma.sailing_month)) / \n                 LAG(ppma.monthly_teu, 12) OVER (PARTITION BY ppma.origin_port_id, ppma.destination_port_id ORDER BY ppma.sailing_month)) * 100\n            ELSE NULL\n        END AS year_over_year_growth_percent\n    FROM port_pair_monthly_aggregation ppma\n),\nport_pair_demand_scoring AS (\n    -- Fourth CTE: Calculate demand scores and market opportunity\n    SELECT\n        ppta.origin_port_id,\n        ppta.origin_port_name,\n        ppta.origin_port_code,\n        ppta.origin_locode,\n        ppta.origin_country,\n        ppta.destination_port_id,\n        ppta.destination_port_name,\n        ppta.destination_port_code,\n        ppta.destination_locode,\n        ppta.destination_country,\n        ppta.sailing_month,\n        ppta.unique_carriers,\n        ppta.monthly_sailings,\n        ppta.monthly_completed_sailings,\n        ppta.monthly_teu,\n        ppta.monthly_avg_teu_per_sailing,\n        ppta.monthly_avg_capacity_utilization,\n        ppta.median_monthly_teu,\n        ppta.stddev_monthly_teu,\n        ROUND(CAST(ppta.moving_avg_teu_3_month AS NUMERIC), 2) AS moving_avg_teu_3_month,\n        ROUND(CAST(ppta.moving_avg_teu_12_month AS NUMERIC), 2) AS moving_avg_teu_12_month,\n        ppta.prev_month_teu,\n        ppta.prev_year_teu,\n        ROUND(CAST(ppta.month_over_month_growth_percent AS NUMERIC), 2) AS month_over_month_growth_percent,\n        ROUND(CAST(ppta.year_over_year_growth_percent AS NUMERIC), 2) AS year_over_year_growth_percent,\n        -- Total demand (sum across all months)\n        SUM(ppta.monthly_teu) OVER (\n            PARTITION BY ppta.origin_port_id, ppta.destination_port_id\n        ) AS total_demand_teu,\n        -- Average monthly demand\n        AVG(ppta.monthly_teu) OVER (\n            PARTITION BY ppta.origin_port_id, ppta.destination_port_id\n        ) AS avg_monthly_demand_teu,\n        -- Market comparison\n        AVG(ppta.monthly_teu) OVER () AS market_avg_monthly_teu,\n        PERCENT_RANK() OVER (ORDER BY ppta.monthly_teu) AS demand_percentile,\n        -- Demand score (weighted factors)\n        (\n            -- Volume component (40% weight)\n            CASE\n                WHEN AVG(ppta.monthly_teu) OVER () > 0 THEN\n                    LEAST(1.0, ppta.monthly_teu / AVG(ppta.monthly_teu) OVER ()) * 40\n                ELSE 0\n            END +\n            -- Growth component (30% weight)\n            CASE\n                WHEN ppta.year_over_year_growth_percent IS NOT NULL THEN\n                    GREATEST(0, LEAST(1.0, (ppta.year_over_year_growth_percent + 20) / 40.0)) * 30\n                ELSE 15\n            END +\n            -- Carrier competition component (20% weight)\n            CASE\n                WHEN ppta.unique_carriers > 0 THEN\n                    LEAST(1.0, ppta.unique_carriers / 10.0) * 20\n                ELSE 0\n            END +\n            -- Capacity utilization component (10% weight)\n            COALESCE(ppta.monthly_avg_capacity_utilization / 100.0 * 10, 0)\n        ) AS demand_score\n    FROM port_pair_trend_analysis ppta\n),\nport_pair_market_classification AS (\n    -- Fifth CTE: Classify port pairs by market opportunity\n    SELECT\n        pds.origin_port_id,\n        pds.origin_port_name,\n        pds.origin_port_code,\n        pds.origin_locode,\n        pds.origin_country,\n        pds.destination_port_id,\n        pds.destination_port_name,\n        pds.destination_port_code,\n        pds.destination_locode,\n        pds.destination_country,\n        pds.sailing_month,\n        pds.unique_carriers,\n        pds.monthly_sailings,\n        pds.monthly_completed_sailings,\n        pds.monthly_teu,\n        pds.monthly_avg_teu_per_sailing,\n        pds.monthly_avg_capacity_utilization,\n        pds.median_monthly_teu,\n        pds.stddev_monthly_teu,\n        pds.moving_avg_teu_3_month,\n        pds.moving_avg_teu_12_month,\n        pds.prev_month_teu,\n        pds.prev_year_teu,\n        pds.month_over_month_growth_percent,\n        pds.year_over_year_growth_percent,\n        ROUND(CAST(pds.total_demand_teu AS NUMERIC), 2) AS total_demand_teu,\n        ROUND(CAST(pds.avg_monthly_demand_teu AS NUMERIC), 2) AS avg_monthly_demand_teu,\n        ROUND(CAST(pds.market_avg_monthly_teu AS NUMERIC), 2) AS market_avg_monthly_teu,\n        ROUND(CAST(pds.demand_percentile * 100 AS NUMERIC), 2) AS demand_percentile,\n        ROUND(CAST(pds.demand_score AS NUMERIC), 2) AS demand_score,\n        -- Market classification\n        CASE\n            WHEN pds.avg_monthly_demand_teu >= pds.market_avg_monthly_teu * 2 THEN 'High Demand'\n            WHEN pds.avg_monthly_demand_teu >= pds.market_avg_monthly_teu THEN 'Medium Demand'\n            WHEN pds.avg_monthly_demand_teu >= pds.market_avg_monthly_teu * 0.5 THEN 'Low Demand'\n            ELSE 'Very Low Demand'\n        END AS demand_class,\n        -- Growth classification\n        CASE\n            WHEN pds.year_over_year_growth_percent IS NOT NULL THEN\n                CASE\n                    WHEN pds.year_over_year_growth_percent > 15 THEN 'Strong Growth'\n                    WHEN pds.year_over_year_growth_percent > 5 THEN 'Moderate Growth'\n                    WHEN pds.year_over_year_growth_percent > 0 THEN 'Slow Growth'\n                    WHEN pds.year_over_year_growth_percent > -5 THEN 'Declining'\n                    ELSE 'Sharp Decline'\n                END\n            ELSE 'Unknown'\n        END AS growth_class,\n        -- Market opportunity\n        CASE\n            WHEN pds.avg_monthly_demand_teu > pds.market_avg_monthly_teu \n                AND pds.year_over_year_growth_percent > 10 \n                AND pds.unique_carriers < 5 THEN 'High Opportunity'\n            WHEN pds.avg_monthly_demand_teu > pds.market_avg_monthly_teu \n                AND pds.year_over_year_growth_percent > 5 THEN 'Medium Opportunity'\n            WHEN pds.avg_monthly_demand_teu < pds.market_avg_monthly_teu \n                AND pds.year_over_year_growth_percent < -5 THEN 'Low Opportunity'\n            ELSE 'Monitor'\n        END AS market_opportunity\n    FROM port_pair_demand_scoring pds\n)\nSELECT\n    origin_port_id,\n    origin_port_name,\n    origin_port_code,\n    origin_locode,\n    origin_country,\n    destination_port_id,\n    destination_port_name,\n    destination_port_code,\n    destination_locode,\n    destination_country,\n    sailing_month,\n    unique_carriers,\n    monthly_sailings,\n    monthly_completed_sailings,\n    monthly_teu,\n    monthly_avg_teu_per_sailing,\n    monthly_avg_capacity_utilization,\n    median_monthly_teu,\n    stddev_monthly_teu,\n    moving_avg_teu_3_month,\n    moving_avg_teu_12_month,\n    prev_month_teu,\n    prev_year_teu,\n    month_over_month_growth_percent,\n    year_over_year_growth_percent,\n    total_demand_teu,\n    avg_monthly_demand_teu,\n    market_avg_monthly_teu,\n    demand_percentile,\n    demand_score,\n    demand_class,\n    growth_class,\n    market_opportunity\nFROM port_pair_market_classification\nORDER BY sailing_month DESC, demand_score DESC\nLIMIT 2000;",
      "line_number": 2716
    },
    {
      "number": 10,
      "title": "Voyage Completion Rate Analysis with Port Call Success Metrics and Delay Root Cause Analysis",
      "description": "Use Case: Operations Management - Comprehensive Voyage Completion Rate Analysis for Service Reliability Description: Enterprise-level voyage completion analysis with multi-level CTE nesting, completion rate calculations, port call success metrics, delay root cause analysis, and advanced window functions. Demonstrates production patterns used by shipping lines for operational reliability. Business Value: Voyage completion report showing completion rates, port call success metrics, delay patterns,",
      "complexity": "Deep nested CTEs (7+ levels), completion rate calculations, delay analysis, window functions with multiple frame clauses, percentile calculations, root cause analysis, temporal analysis",
      "expected_output": "Voyage completion report with completion rates, port call success metrics, and delay root cause analysis.",
      "sql": "WITH voyage_port_call_sequence AS (\n    -- First CTE: Sequence port calls within voyages\n    SELECT\n        v.voyage_id,\n        v.voyage_number,\n        v.vessel_id,\n        ve.vessel_name,\n        ve.imo_number,\n        ve.carrier_id,\n        c.carrier_name,\n        v.route_id,\n        r.route_name,\n        v.status AS voyage_status,\n        v.start_date AS scheduled_start_date,\n        v.start_date AS actual_start_date,\n        v.end_date AS scheduled_end_date,\n        v.end_date AS actual_end_date,\n        vpc.voyage_port_call_id,\n        vpc.port_call_id,\n        pc.port_id,\n        p.port_name,\n        p.port_code,\n        p.locode,\n        vpc.port_sequence,\n        pc.scheduled_arrival,\n        pc.actual_arrival,\n        pc.scheduled_departure,\n        pc.actual_departure,\n        pc.status AS port_call_status,\n        pc.containers_loaded,\n        pc.containers_discharged,\n        pc.containers_transshipped,\n        -- Calculate delays\n        CASE\n            WHEN pc.actual_arrival IS NOT NULL AND pc.scheduled_arrival IS NOT NULL THEN\n                EXTRACT(EPOCH FROM (pc.actual_arrival - pc.scheduled_arrival)) / 3600.0\n            ELSE NULL\n        END AS arrival_delay_hours,\n        CASE\n            WHEN pc.actual_departure IS NOT NULL AND pc.scheduled_departure IS NOT NULL THEN\n                EXTRACT(EPOCH FROM (pc.actual_departure - pc.scheduled_departure)) / 3600.0\n            ELSE NULL\n        END AS departure_delay_hours,\n        -- Calculate dwell time\n        CASE\n            WHEN pc.actual_arrival IS NOT NULL AND pc.actual_departure IS NOT NULL THEN\n                EXTRACT(EPOCH FROM (pc.actual_departure - pc.actual_arrival)) / 3600.0\n            ELSE NULL\n        END AS dwell_time_hours,\n        -- Port call success indicators\n        CASE\n            WHEN pc.actual_arrival IS NOT NULL AND pc.actual_departure IS NOT NULL THEN 1\n            ELSE 0\n        END AS port_call_completed,\n        CASE\n            WHEN pc.actual_arrival IS NOT NULL AND pc.scheduled_arrival IS NOT NULL \n                AND EXTRACT(EPOCH FROM (pc.actual_arrival - pc.scheduled_arrival)) / 3600.0 <= 6 THEN 1\n            ELSE 0\n        END AS on_time_arrival,\n        CASE\n            WHEN pc.actual_departure IS NOT NULL AND pc.scheduled_departure IS NOT NULL \n                AND EXTRACT(EPOCH FROM (pc.actual_departure - pc.scheduled_departure)) / 3600.0 <= 6 THEN 1\n            ELSE 0\n        END AS on_time_departure\n    FROM voyages v\n    INNER JOIN vessels ve ON v.vessel_id = ve.vessel_id\n    LEFT JOIN carriers c ON ve.carrier_id = c.carrier_id\n    LEFT JOIN routes r ON v.route_id = r.route_id\n    LEFT JOIN voyage_port_calls vpc ON v.voyage_id = vpc.voyage_id\n    LEFT JOIN port_calls pc ON vpc.port_call_id = pc.port_call_id\n    LEFT JOIN ports p ON pc.port_id = p.port_id\n    WHERE v.start_date >= CURRENT_DATE - INTERVAL '2 years'\n),\nvoyage_completion_metrics AS (\n    -- Second CTE: Calculate voyage-level completion metrics\n    SELECT\n        vpcs.voyage_id,\n        vpcs.voyage_number,\n        vpcs.vessel_id,\n        vpcs.vessel_name,\n        vpcs.imo_number,\n        vpcs.carrier_id,\n        vpcs.carrier_name,\n        vpcs.route_id,\n        vpcs.route_name,\n        vpcs.voyage_status,\n        vpcs.scheduled_start_date,\n        vpcs.actual_start_date,\n        vpcs.scheduled_end_date,\n        vpcs.actual_end_date,\n        COUNT(DISTINCT vpcs.voyage_port_call_id) AS total_port_calls,\n        SUM(vpcs.port_call_completed) AS completed_port_calls,\n        SUM(vpcs.on_time_arrival) AS on_time_arrivals,\n        SUM(vpcs.on_time_departure) AS on_time_departures,\n        AVG(vpcs.arrival_delay_hours) AS avg_arrival_delay_hours,\n        AVG(vpcs.departure_delay_hours) AS avg_departure_delay_hours,\n        AVG(vpcs.dwell_time_hours) AS avg_dwell_time_hours,\n        MAX(vpcs.arrival_delay_hours) AS max_arrival_delay_hours,\n        MAX(vpcs.departure_delay_hours) AS max_departure_delay_hours,\n        PERCENTILE_CONT(0.5) WITHIN GROUP (ORDER BY vpcs.arrival_delay_hours) AS median_arrival_delay,\n        PERCENTILE_CONT(0.5) WITHIN GROUP (ORDER BY vpcs.departure_delay_hours) AS median_departure_delay,\n        PERCENTILE_CONT(0.75) WITHIN GROUP (ORDER BY vpcs.arrival_delay_hours) AS p75_arrival_delay,\n        PERCENTILE_CONT(0.75) WITHIN GROUP (ORDER BY vpcs.departure_delay_hours) AS p75_departure_delay,\n        STDDEV(vpcs.arrival_delay_hours) AS stddev_arrival_delay,\n        STDDEV(vpcs.departure_delay_hours) AS stddev_departure_delay,\n        -- Voyage completion indicators\n        CASE\n            WHEN vpcs.actual_end_date IS NOT NULL THEN 1\n            ELSE 0\n        END AS voyage_completed,\n        CASE\n            WHEN vpcs.actual_start_date IS NOT NULL AND vpcs.scheduled_start_date IS NOT NULL \n                AND EXTRACT(EPOCH FROM (vpcs.actual_start_date - vpcs.scheduled_start_date)) / 3600.0 <= 12 THEN 1\n            ELSE 0\n        END AS on_time_start,\n        CASE\n            WHEN vpcs.actual_end_date IS NOT NULL AND vpcs.scheduled_end_date IS NOT NULL \n                AND EXTRACT(EPOCH FROM (vpcs.actual_end_date - vpcs.scheduled_end_date)) / 3600.0 <= 24 THEN 1\n            ELSE 0\n        END AS on_time_completion,\n        -- Voyage duration\n        CASE\n            WHEN vpcs.actual_start_date IS NOT NULL AND vpcs.actual_end_date IS NOT NULL THEN\n                EXTRACT(EPOCH FROM (vpcs.actual_end_date - vpcs.actual_start_date)) / 24.0\n            ELSE NULL\n        END AS actual_voyage_duration_days,\n        CASE\n            WHEN vpcs.scheduled_start_date IS NOT NULL AND vpcs.scheduled_end_date IS NOT NULL THEN\n                EXTRACT(EPOCH FROM (vpcs.scheduled_end_date - vpcs.scheduled_start_date)) / 24.0\n            ELSE NULL\n        END AS scheduled_voyage_duration_days\n    FROM voyage_port_call_sequence vpcs\n    GROUP BY\n        vpcs.voyage_id,\n        vpcs.voyage_number,\n        vpcs.vessel_id,\n        vpcs.vessel_name,\n        vpcs.imo_number,\n        vpcs.carrier_id,\n        vpcs.carrier_name,\n        vpcs.route_id,\n        vpcs.route_name,\n        vpcs.voyage_status,\n        vpcs.scheduled_start_date,\n        vpcs.actual_start_date,\n        vpcs.scheduled_end_date,\n        vpcs.actual_end_date\n),\nvoyage_completion_rates AS (\n    -- Third CTE: Calculate completion rates and success metrics\n    SELECT\n        vcm.voyage_id,\n        vcm.voyage_number,\n        vcm.vessel_id,\n        vcm.vessel_name,\n        vcm.imo_number,\n        vcm.carrier_id,\n        vcm.carrier_name,\n        vcm.route_id,\n        vcm.route_name,\n        vcm.voyage_status,\n        vcm.scheduled_start_date,\n        vcm.actual_start_date,\n        vcm.scheduled_end_date,\n        vcm.actual_end_date,\n        vcm.total_port_calls,\n        vcm.completed_port_calls,\n        vcm.on_time_arrivals,\n        vcm.on_time_departures,\n        ROUND(CAST(vcm.avg_arrival_delay_hours AS NUMERIC), 2) AS avg_arrival_delay_hours,\n        ROUND(CAST(vcm.avg_departure_delay_hours AS NUMERIC), 2) AS avg_departure_delay_hours,\n        ROUND(CAST(vcm.avg_dwell_time_hours AS NUMERIC), 2) AS avg_dwell_time_hours,\n        ROUND(CAST(vcm.max_arrival_delay_hours AS NUMERIC), 2) AS max_arrival_delay_hours,\n        ROUND(CAST(vcm.max_departure_delay_hours AS NUMERIC), 2) AS max_departure_delay_hours,\n        ROUND(CAST(vcm.median_arrival_delay AS NUMERIC), 2) AS median_arrival_delay,\n        ROUND(CAST(vcm.median_departure_delay AS NUMERIC), 2) AS median_departure_delay,\n        ROUND(CAST(vcm.p75_arrival_delay AS NUMERIC), 2) AS p75_arrival_delay,\n        ROUND(CAST(vcm.p75_departure_delay AS NUMERIC), 2) AS p75_departure_delay,\n        ROUND(CAST(vcm.stddev_arrival_delay AS NUMERIC), 2) AS stddev_arrival_delay,\n        ROUND(CAST(vcm.stddev_departure_delay AS NUMERIC), 2) AS stddev_departure_delay,\n        vcm.voyage_completed,\n        vcm.on_time_start,\n        vcm.on_time_completion,\n        ROUND(CAST(vcm.actual_voyage_duration_days AS NUMERIC), 2) AS actual_voyage_duration_days,\n        ROUND(CAST(vcm.scheduled_voyage_duration_days AS NUMERIC), 2) AS scheduled_voyage_duration_days,\n        -- Completion rates\n        CASE\n            WHEN vcm.total_port_calls > 0 THEN\n                ROUND(CAST((vcm.completed_port_calls::NUMERIC / vcm.total_port_calls::NUMERIC) * 100 AS NUMERIC), 2)\n            ELSE 0\n        END AS port_call_completion_rate,\n        CASE\n            WHEN vcm.total_port_calls > 0 THEN\n                ROUND(CAST((vcm.on_time_arrivals::NUMERIC / vcm.total_port_calls::NUMERIC) * 100 AS NUMERIC), 2)\n            ELSE 0\n        END AS on_time_arrival_rate,\n        CASE\n            WHEN vcm.total_port_calls > 0 THEN\n                ROUND(CAST((vcm.on_time_departures::NUMERIC / vcm.total_port_calls::NUMERIC) * 100 AS NUMERIC), 2)\n            ELSE 0\n        END AS on_time_departure_rate,\n        -- Voyage delay\n        CASE\n            WHEN vcm.actual_voyage_duration_days IS NOT NULL AND vcm.scheduled_voyage_duration_days IS NOT NULL THEN\n                ROUND(CAST((vcm.actual_voyage_duration_days - vcm.scheduled_voyage_duration_days) AS NUMERIC), 2)\n            ELSE NULL\n        END AS voyage_delay_days\n    FROM voyage_completion_metrics vcm\n),\ncarrier_voyage_comparison AS (\n    -- Fourth CTE: Compare voyages within and across carriers\n    SELECT\n        vcr.voyage_id,\n        vcr.voyage_number,\n        vcr.vessel_id,\n        vcr.vessel_name,\n        vcr.imo_number,\n        vcr.carrier_id,\n        vcr.carrier_name,\n        vcr.route_id,\n        vcr.route_name,\n        vcr.voyage_status,\n        vcr.scheduled_start_date,\n        vcr.actual_start_date,\n        vcr.scheduled_end_date,\n        vcr.actual_end_date,\n        vcr.total_port_calls,\n        vcr.completed_port_calls,\n        vcr.on_time_arrivals,\n        vcr.on_time_departures,\n        vcr.avg_arrival_delay_hours,\n        vcr.avg_departure_delay_hours,\n        vcr.avg_dwell_time_hours,\n        vcr.max_arrival_delay_hours,\n        vcr.max_departure_delay_hours,\n        vcr.median_arrival_delay,\n        vcr.median_departure_delay,\n        vcr.p75_arrival_delay,\n        vcr.p75_departure_delay,\n        vcr.stddev_arrival_delay,\n        vcr.stddev_departure_delay,\n        vcr.voyage_completed,\n        vcr.on_time_start,\n        vcr.on_time_completion,\n        vcr.actual_voyage_duration_days,\n        vcr.scheduled_voyage_duration_days,\n        vcr.port_call_completion_rate,\n        vcr.on_time_arrival_rate,\n        vcr.on_time_departure_rate,\n        vcr.voyage_delay_days,\n        -- Carrier averages for comparison\n        AVG(vcr.port_call_completion_rate) OVER (PARTITION BY vcr.carrier_id) AS carrier_avg_completion_rate,\n        AVG(vcr.on_time_arrival_rate) OVER (PARTITION BY vcr.carrier_id) AS carrier_avg_on_time_arrival_rate,\n        AVG(vcr.on_time_departure_rate) OVER (PARTITION BY vcr.carrier_id) AS carrier_avg_on_time_departure_rate,\n        AVG(vcr.avg_arrival_delay_hours) OVER (PARTITION BY vcr.carrier_id) AS carrier_avg_arrival_delay,\n        AVG(vcr.avg_departure_delay_hours) OVER (PARTITION BY vcr.carrier_id) AS carrier_avg_departure_delay,\n        -- Market averages\n        AVG(vcr.port_call_completion_rate) OVER () AS market_avg_completion_rate,\n        AVG(vcr.on_time_arrival_rate) OVER () AS market_avg_on_time_arrival_rate,\n        AVG(vcr.on_time_departure_rate) OVER () AS market_avg_on_time_departure_rate,\n        AVG(vcr.avg_arrival_delay_hours) OVER () AS market_avg_arrival_delay,\n        AVG(vcr.avg_departure_delay_hours) OVER () AS market_avg_departure_delay,\n        -- Rankings\n        RANK() OVER (PARTITION BY vcr.carrier_id ORDER BY vcr.port_call_completion_rate DESC) AS carrier_completion_rank,\n        RANK() OVER (ORDER BY vcr.port_call_completion_rate DESC) AS market_completion_rank,\n        PERCENT_RANK() OVER (PARTITION BY vcr.carrier_id ORDER BY vcr.port_call_completion_rate) AS carrier_completion_percentile,\n        PERCENT_RANK() OVER (ORDER BY vcr.port_call_completion_rate) AS market_completion_percentile\n    FROM voyage_completion_rates vcr\n),\nvoyage_reliability_classification AS (\n    -- Fifth CTE: Classify voyages by reliability\n    SELECT\n        cvc.voyage_id,\n        cvc.voyage_number,\n        cvc.vessel_id,\n        cvc.vessel_name,\n        cvc.imo_number,\n        cvc.carrier_id,\n        cvc.carrier_name,\n        cvc.route_id,\n        cvc.route_name,\n        cvc.voyage_status,\n        cvc.scheduled_start_date,\n        cvc.actual_start_date,\n        cvc.scheduled_end_date,\n        cvc.actual_end_date,\n        cvc.total_port_calls,\n        cvc.completed_port_calls,\n        cvc.on_time_arrivals,\n        cvc.on_time_departures,\n        cvc.avg_arrival_delay_hours,\n        cvc.avg_departure_delay_hours,\n        cvc.avg_dwell_time_hours,\n        cvc.max_arrival_delay_hours,\n        cvc.max_departure_delay_hours,\n        cvc.median_arrival_delay,\n        cvc.median_departure_delay,\n        cvc.p75_arrival_delay,\n        cvc.p75_departure_delay,\n        cvc.stddev_arrival_delay,\n        cvc.stddev_departure_delay,\n        cvc.voyage_completed,\n        cvc.on_time_start,\n        cvc.on_time_completion,\n        cvc.actual_voyage_duration_days,\n        cvc.scheduled_voyage_duration_days,\n        cvc.port_call_completion_rate,\n        cvc.on_time_arrival_rate,\n        cvc.on_time_departure_rate,\n        cvc.voyage_delay_days,\n        ROUND(CAST(cvc.carrier_avg_completion_rate AS NUMERIC), 2) AS carrier_avg_completion_rate,\n        ROUND(CAST(cvc.carrier_avg_on_time_arrival_rate AS NUMERIC), 2) AS carrier_avg_on_time_arrival_rate,\n        ROUND(CAST(cvc.carrier_avg_on_time_departure_rate AS NUMERIC), 2) AS carrier_avg_on_time_departure_rate,\n        ROUND(CAST(cvc.carrier_avg_arrival_delay AS NUMERIC), 2) AS carrier_avg_arrival_delay,\n        ROUND(CAST(cvc.carrier_avg_departure_delay AS NUMERIC), 2) AS carrier_avg_departure_delay,\n        ROUND(CAST(cvc.market_avg_completion_rate AS NUMERIC), 2) AS market_avg_completion_rate,\n        ROUND(CAST(cvc.market_avg_on_time_arrival_rate AS NUMERIC), 2) AS market_avg_on_time_arrival_rate,\n        ROUND(CAST(cvc.market_avg_on_time_departure_rate AS NUMERIC), 2) AS market_avg_on_time_departure_rate,\n        ROUND(CAST(cvc.market_avg_arrival_delay AS NUMERIC), 2) AS market_avg_arrival_delay,\n        ROUND(CAST(cvc.market_avg_departure_delay AS NUMERIC), 2) AS market_avg_departure_delay,\n        cvc.carrier_completion_rank,\n        cvc.market_completion_rank,\n        ROUND(CAST(cvc.carrier_completion_percentile * 100 AS NUMERIC), 2) AS carrier_completion_percentile,\n        ROUND(CAST(cvc.market_completion_percentile * 100 AS NUMERIC), 2) AS market_completion_percentile,\n        -- Reliability classification\n        CASE\n            WHEN cvc.port_call_completion_rate >= 95 AND cvc.on_time_arrival_rate >= 80 THEN 'Highly Reliable'\n            WHEN cvc.port_call_completion_rate >= 90 AND cvc.on_time_arrival_rate >= 70 THEN 'Reliable'\n            WHEN cvc.port_call_completion_rate >= 80 AND cvc.on_time_arrival_rate >= 60 THEN 'Moderately Reliable'\n            WHEN cvc.port_call_completion_rate >= 70 THEN 'Less Reliable'\n            ELSE 'Unreliable'\n        END AS reliability_class,\n        -- Delay root cause indicators\n        CASE\n            WHEN cvc.avg_arrival_delay_hours > cvc.avg_departure_delay_hours * 1.5 THEN 'Arrival Delays Primary'\n            WHEN cvc.avg_departure_delay_hours > cvc.avg_arrival_delay_hours * 1.5 THEN 'Departure Delays Primary'\n            WHEN cvc.avg_arrival_delay_hours > 0 AND cvc.avg_departure_delay_hours > 0 THEN 'Both Arrival and Departure Delays'\n            WHEN cvc.avg_arrival_delay_hours > 0 THEN 'Arrival Delays Only'\n            WHEN cvc.avg_departure_delay_hours > 0 THEN 'Departure Delays Only'\n            ELSE 'No Significant Delays'\n        END AS delay_root_cause,\n        -- Performance vs carrier\n        CASE\n            WHEN cvc.port_call_completion_rate > cvc.carrier_avg_completion_rate * 1.05 THEN 'Above Carrier Average'\n            WHEN cvc.port_call_completion_rate > cvc.carrier_avg_completion_rate * 0.95 THEN 'At Carrier Average'\n            ELSE 'Below Carrier Average'\n        END AS carrier_performance_class,\n        -- Performance vs market\n        CASE\n            WHEN cvc.port_call_completion_rate > cvc.market_avg_completion_rate * 1.05 THEN 'Above Market Average'\n            WHEN cvc.port_call_completion_rate > cvc.market_avg_completion_rate * 0.95 THEN 'At Market Average'\n            ELSE 'Below Market Average'\n        END AS market_performance_class\n    FROM carrier_voyage_comparison cvc\n)\nSELECT\n    voyage_id,\n    voyage_number,\n    vessel_id,\n    vessel_name,\n    imo_number,\n    carrier_id,\n    carrier_name,\n    route_id,\n    route_name,\n    voyage_status,\n    scheduled_start_date,\n    actual_start_date,\n    scheduled_end_date,\n    actual_end_date,\n    total_port_calls,\n    completed_port_calls,\n    on_time_arrivals,\n    on_time_departures,\n    avg_arrival_delay_hours,\n    avg_departure_delay_hours,\n    avg_dwell_time_hours,\n    max_arrival_delay_hours,\n    max_departure_delay_hours,\n    median_arrival_delay,\n    median_departure_delay,\n    p75_arrival_delay,\n    p75_departure_delay,\n    stddev_arrival_delay,\n    stddev_departure_delay,\n    voyage_completed,\n    on_time_start,\n    on_time_completion,\n    actual_voyage_duration_days,\n    scheduled_voyage_duration_days,\n    port_call_completion_rate,\n    on_time_arrival_rate,\n    on_time_departure_rate,\n    voyage_delay_days,\n    carrier_avg_completion_rate,\n    carrier_avg_on_time_arrival_rate,\n    carrier_avg_on_time_departure_rate,\n    carrier_avg_arrival_delay,\n    carrier_avg_departure_delay,\n    market_avg_completion_rate,\n    market_avg_on_time_arrival_rate,\n    market_avg_on_time_departure_rate,\n    market_avg_arrival_delay,\n    market_avg_departure_delay,\n    carrier_completion_rank,\n    market_completion_rank,\n    carrier_completion_percentile,\n    market_completion_percentile,\n    reliability_class,\n    delay_root_cause,\n    carrier_performance_class,\n    market_performance_class\nFROM voyage_reliability_classification\nORDER BY scheduled_start_date DESC, port_call_completion_rate DESC\nLIMIT 1000;",
      "line_number": 3043
    },
    {
      "number": 11,
      "title": "Carrier Route Performance Analysis with Service Quality Metrics and Competitive Benchmarking",
      "description": "Use Case: Strategic Planning - Comprehensive Carrier Route Performance Analysis for Service Optimization Description: Enterprise-level carrier route performance analysis with multi-level CTE nesting, performance metrics, service quality scoring, competitive benchmarking, and advanced window functions. Demonstrates production patterns used by shipping lines for strategic route planning. Business Value: Carrier route performance report showing service quality metrics, competitive positioning, rout",
      "complexity": "Deep nested CTEs (7+ levels), performance calculations, competitive analysis, window functions with multiple frame clauses, percentile calculations, service quality scoring, route profitability analysis",
      "expected_output": "Carrier route performance report with service quality metrics, competitive positioning, and route optimization recommendations.",
      "sql": "WITH carrier_route_sailing_metrics AS (\n    -- First CTE: Aggregate sailing metrics by carrier and route\n    SELECT\n        r.carrier_id,\n        c.carrier_name,\n        s.route_id,\n        r.route_name,\n        r.route_type,\n        COUNT(DISTINCT s.sailing_id) AS total_sailings,\n        COUNT(DISTINCT CASE WHEN s.status = 'Completed' THEN s.sailing_id END) AS completed_sailings,\n        COUNT(DISTINCT CASE WHEN s.status = 'Cancelled' THEN s.sailing_id END) AS cancelled_sailings,\n        SUM(s.total_teu) AS total_teu_carried,\n        AVG(s.total_teu) AS avg_teu_per_sailing,\n        AVG(s.capacity_utilization_percent) AS avg_capacity_utilization,\n        AVG(s.transit_days) AS avg_transit_days,\n        AVG(s.distance_nautical_miles) AS avg_distance_nm,\n        PERCENTILE_CONT(0.5) WITHIN GROUP (ORDER BY s.transit_days) AS median_transit_days,\n        PERCENTILE_CONT(0.75) WITHIN GROUP (ORDER BY s.transit_days) AS p75_transit_days,\n        STDDEV(s.transit_days) AS stddev_transit_days,\n        MIN(s.transit_days) AS min_transit_days,\n        MAX(s.transit_days) AS max_transit_days,\n        -- On-time performance\n        COUNT(DISTINCT CASE \n            WHEN s.actual_departure IS NOT NULL AND s.scheduled_departure IS NOT NULL\n                AND EXTRACT(EPOCH FROM (s.actual_departure - s.scheduled_departure)) / 3600.0 <= 6 THEN s.sailing_id\n        END) AS on_time_departures,\n        COUNT(DISTINCT CASE \n            WHEN s.actual_arrival IS NOT NULL AND s.scheduled_arrival IS NOT NULL\n                AND EXTRACT(EPOCH FROM (s.actual_arrival - s.scheduled_arrival)) / 3600.0 <= 6 THEN s.sailing_id\n        END) AS on_time_arrivals\n    FROM sailings s\n    INNER JOIN routes r ON s.route_id = r.route_id\n    INNER JOIN carriers c ON r.carrier_id = c.carrier_id\n    WHERE s.scheduled_departure >= CURRENT_DATE - INTERVAL '2 years'\n    GROUP BY r.carrier_id, c.carrier_name, s.route_id, r.route_name, r.route_type\n),\ncarrier_route_port_call_metrics AS (\n    -- Second CTE: Aggregate port call metrics by carrier and route\n    SELECT\n        r.carrier_id,\n        s.route_id,\n        COUNT(DISTINCT pc.port_call_id) AS total_port_calls,\n        AVG(CASE \n            WHEN pc.actual_arrival IS NOT NULL AND pc.scheduled_arrival IS NOT NULL THEN\n                EXTRACT(EPOCH FROM (pc.actual_arrival - pc.scheduled_arrival)) / 3600.0\n            ELSE NULL\n        END) AS avg_arrival_delay_hours,\n        AVG(CASE \n            WHEN pc.actual_departure IS NOT NULL AND pc.scheduled_departure IS NOT NULL THEN\n                EXTRACT(EPOCH FROM (pc.actual_departure - pc.scheduled_departure)) / 3600.0\n            ELSE NULL\n        END) AS avg_departure_delay_hours,\n        AVG(CASE \n            WHEN pc.actual_arrival IS NOT NULL AND pc.actual_departure IS NOT NULL THEN\n                EXTRACT(EPOCH FROM (pc.actual_departure - pc.actual_arrival)) / 3600.0\n            ELSE NULL\n        END) AS avg_dwell_time_hours,\n        SUM(COALESCE(pc.containers_loaded, 0) + COALESCE(pc.containers_discharged, 0) + COALESCE(pc.containers_transshipped, 0)) AS total_containers_handled\n    FROM sailings s\n    INNER JOIN routes r ON s.route_id = r.route_id\n    INNER JOIN port_calls pc ON s.vessel_id = pc.vessel_id AND s.voyage_number = pc.voyage_number\n    WHERE s.scheduled_departure >= CURRENT_DATE - INTERVAL '2 years'\n    GROUP BY r.carrier_id, s.route_id\n),\ncarrier_route_comprehensive_metrics AS (\n    -- Third CTE: Combine sailing and port call metrics\n    SELECT\n        crsm.carrier_id,\n        crsm.carrier_name,\n        crsm.route_id,\n        crsm.route_name,\n        crsm.route_type,\n        crsm.total_sailings,\n        crsm.completed_sailings,\n        crsm.cancelled_sailings,\n        ROUND(CAST(crsm.total_teu_carried AS NUMERIC), 2) AS total_teu_carried,\n        ROUND(CAST(crsm.avg_teu_per_sailing AS NUMERIC), 2) AS avg_teu_per_sailing,\n        ROUND(CAST(crsm.avg_capacity_utilization AS NUMERIC), 2) AS avg_capacity_utilization,\n        ROUND(CAST(crsm.avg_transit_days AS NUMERIC), 2) AS avg_transit_days,\n        ROUND(CAST(crsm.avg_distance_nm AS NUMERIC), 2) AS avg_distance_nm,\n        ROUND(CAST(crsm.median_transit_days AS NUMERIC), 2) AS median_transit_days,\n        ROUND(CAST(crsm.p75_transit_days AS NUMERIC), 2) AS p75_transit_days,\n        ROUND(CAST(crsm.stddev_transit_days AS NUMERIC), 2) AS stddev_transit_days,\n        crsm.min_transit_days,\n        crsm.max_transit_days,\n        crsm.on_time_departures,\n        crsm.on_time_arrivals,\n        crpcm.total_port_calls,\n        ROUND(CAST(crpcm.avg_arrival_delay_hours AS NUMERIC), 2) AS avg_arrival_delay_hours,\n        ROUND(CAST(crpcm.avg_departure_delay_hours AS NUMERIC), 2) AS avg_departure_delay_hours,\n        ROUND(CAST(crpcm.avg_dwell_time_hours AS NUMERIC), 2) AS avg_dwell_time_hours,\n        ROUND(CAST(crpcm.total_containers_handled AS NUMERIC), 0) AS total_containers_handled,\n        -- Completion rate\n        CASE\n            WHEN crsm.total_sailings > 0 THEN\n                ROUND(CAST((crsm.completed_sailings::NUMERIC / crsm.total_sailings::NUMERIC) * 100 AS NUMERIC), 2)\n            ELSE 0\n        END AS completion_rate,\n        -- On-time performance rates\n        CASE\n            WHEN crsm.total_sailings > 0 THEN\n                ROUND(CAST((crsm.on_time_departures::NUMERIC / crsm.total_sailings::NUMERIC) * 100 AS NUMERIC), 2)\n            ELSE 0\n        END AS on_time_departure_rate,\n        CASE\n            WHEN crsm.total_sailings > 0 THEN\n                ROUND(CAST((crsm.on_time_arrivals::NUMERIC / crsm.total_sailings::NUMERIC) * 100 AS NUMERIC), 2)\n            ELSE 0\n        END AS on_time_arrival_rate,\n        -- Cancellation rate\n        CASE\n            WHEN crsm.total_sailings > 0 THEN\n                ROUND(CAST((crsm.cancelled_sailings::NUMERIC / crsm.total_sailings::NUMERIC) * 100 AS NUMERIC), 2)\n            ELSE 0\n        END AS cancellation_rate\n    FROM carrier_route_sailing_metrics crsm\n    LEFT JOIN carrier_route_port_call_metrics crpcm ON crsm.carrier_id = crpcm.carrier_id AND crsm.route_id = crpcm.route_id\n),\nroute_competitive_benchmark AS (\n    -- Fourth CTE: Calculate competitive benchmarks by route\n    SELECT\n        crcm.carrier_id,\n        crcm.carrier_name,\n        crcm.route_id,\n        crcm.route_name,\n        crcm.route_type,\n        crcm.total_sailings,\n        crcm.completed_sailings,\n        crcm.cancelled_sailings,\n        crcm.total_teu_carried,\n        crcm.avg_teu_per_sailing,\n        crcm.avg_capacity_utilization,\n        crcm.avg_transit_days,\n        crcm.avg_distance_nm,\n        crcm.median_transit_days,\n        crcm.p75_transit_days,\n        crcm.stddev_transit_days,\n        crcm.min_transit_days,\n        crcm.max_transit_days,\n        crcm.on_time_departures,\n        crcm.on_time_arrivals,\n        crcm.total_port_calls,\n        crcm.avg_arrival_delay_hours,\n        crcm.avg_departure_delay_hours,\n        crcm.avg_dwell_time_hours,\n        crcm.total_containers_handled,\n        crcm.completion_rate,\n        crcm.on_time_departure_rate,\n        crcm.on_time_arrival_rate,\n        crcm.cancellation_rate,\n        -- Route averages (competitor benchmarks)\n        AVG(crcm.completion_rate) OVER (PARTITION BY crcm.route_id) AS route_avg_completion_rate,\n        AVG(crcm.on_time_departure_rate) OVER (PARTITION BY crcm.route_id) AS route_avg_on_time_departure_rate,\n        AVG(crcm.on_time_arrival_rate) OVER (PARTITION BY crcm.route_id) AS route_avg_on_time_arrival_rate,\n        AVG(crcm.avg_transit_days) OVER (PARTITION BY crcm.route_id) AS route_avg_transit_days,\n        AVG(crcm.avg_capacity_utilization) OVER (PARTITION BY crcm.route_id) AS route_avg_capacity_utilization,\n        MIN(crcm.avg_transit_days) OVER (PARTITION BY crcm.route_id) AS route_best_transit_days,\n        MAX(crcm.avg_capacity_utilization) OVER (PARTITION BY crcm.route_id) AS route_best_capacity_utilization,\n        -- Rankings within route\n        RANK() OVER (PARTITION BY crcm.route_id ORDER BY crcm.completion_rate DESC) AS route_completion_rank,\n        RANK() OVER (PARTITION BY crcm.route_id ORDER BY crcm.on_time_arrival_rate DESC) AS route_on_time_rank,\n        RANK() OVER (PARTITION BY crcm.route_id ORDER BY crcm.avg_transit_days ASC) AS route_transit_rank,\n        RANK() OVER (PARTITION BY crcm.route_id ORDER BY crcm.avg_capacity_utilization DESC) AS route_capacity_rank,\n        COUNT(*) OVER (PARTITION BY crcm.route_id) AS route_carrier_count,\n        PERCENT_RANK() OVER (PARTITION BY crcm.route_id ORDER BY crcm.completion_rate) AS route_completion_percentile,\n        PERCENT_RANK() OVER (PARTITION BY crcm.route_id ORDER BY crcm.on_time_arrival_rate) AS route_on_time_percentile\n    FROM carrier_route_comprehensive_metrics crcm\n),\ncarrier_route_performance_scoring AS (\n    -- Fifth CTE: Calculate performance scores\n    SELECT\n        rcb.carrier_id,\n        rcb.carrier_name,\n        rcb.route_id,\n        rcb.route_name,\n        rcb.route_type,\n        rcb.total_sailings,\n        rcb.completed_sailings,\n        rcb.cancelled_sailings,\n        rcb.total_teu_carried,\n        rcb.avg_teu_per_sailing,\n        rcb.avg_capacity_utilization,\n        rcb.avg_transit_days,\n        rcb.avg_distance_nm,\n        rcb.median_transit_days,\n        rcb.p75_transit_days,\n        rcb.stddev_transit_days,\n        rcb.min_transit_days,\n        rcb.max_transit_days,\n        rcb.on_time_departures,\n        rcb.on_time_arrivals,\n        rcb.total_port_calls,\n        rcb.avg_arrival_delay_hours,\n        rcb.avg_departure_delay_hours,\n        rcb.avg_dwell_time_hours,\n        rcb.total_containers_handled,\n        rcb.completion_rate,\n        rcb.on_time_departure_rate,\n        rcb.on_time_arrival_rate,\n        rcb.cancellation_rate,\n        ROUND(CAST(rcb.route_avg_completion_rate AS NUMERIC), 2) AS route_avg_completion_rate,\n        ROUND(CAST(rcb.route_avg_on_time_departure_rate AS NUMERIC), 2) AS route_avg_on_time_departure_rate,\n        ROUND(CAST(rcb.route_avg_on_time_arrival_rate AS NUMERIC), 2) AS route_avg_on_time_arrival_rate,\n        ROUND(CAST(rcb.route_avg_transit_days AS NUMERIC), 2) AS route_avg_transit_days,\n        ROUND(CAST(rcb.route_avg_capacity_utilization AS NUMERIC), 2) AS route_avg_capacity_utilization,\n        ROUND(CAST(rcb.route_best_transit_days AS NUMERIC), 2) AS route_best_transit_days,\n        ROUND(CAST(rcb.route_best_capacity_utilization AS NUMERIC), 2) AS route_best_capacity_utilization,\n        rcb.route_completion_rank,\n        rcb.route_on_time_rank,\n        rcb.route_transit_rank,\n        rcb.route_capacity_rank,\n        rcb.route_carrier_count,\n        ROUND(CAST(rcb.route_completion_percentile * 100 AS NUMERIC), 2) AS route_completion_percentile,\n        ROUND(CAST(rcb.route_on_time_percentile * 100 AS NUMERIC), 2) AS route_on_time_percentile,\n        -- Performance score (weighted factors)\n        (\n            -- Completion rate component (30% weight)\n            (rcb.completion_rate / 100.0) * 30 +\n            -- On-time performance component (25% weight)\n            ((rcb.on_time_arrival_rate + rcb.on_time_departure_rate) / 200.0) * 25 +\n            -- Capacity utilization component (20% weight)\n            (rcb.avg_capacity_utilization / 100.0) * 20 +\n            -- Transit time component (15% weight) - inverse (faster is better)\n            CASE\n                WHEN rcb.route_avg_transit_days > 0 THEN\n                    GREATEST(0, (1.0 - (rcb.avg_transit_days - rcb.route_best_transit_days) / rcb.route_avg_transit_days)) * 15\n                ELSE 0\n            END +\n            -- Volume component (10% weight)\n            CASE\n                WHEN MAX(rcb.total_teu_carried) OVER (PARTITION BY rcb.route_id) > 0 THEN\n                    (rcb.total_teu_carried / MAX(rcb.total_teu_carried) OVER (PARTITION BY rcb.route_id)) * 10\n                ELSE 0\n            END\n        ) AS performance_score\n    FROM route_competitive_benchmark rcb\n),\ncarrier_route_classification AS (\n    -- Sixth CTE: Classify carrier routes by performance\n    SELECT\n        crps.carrier_id,\n        crps.carrier_name,\n        crps.route_id,\n        crps.route_name,\n        crps.route_type,\n        crps.total_sailings,\n        crps.completed_sailings,\n        crps.cancelled_sailings,\n        crps.total_teu_carried,\n        crps.avg_teu_per_sailing,\n        crps.avg_capacity_utilization,\n        crps.avg_transit_days,\n        crps.avg_distance_nm,\n        crps.median_transit_days,\n        crps.p75_transit_days,\n        crps.stddev_transit_days,\n        crps.min_transit_days,\n        crps.max_transit_days,\n        crps.on_time_departures,\n        crps.on_time_arrivals,\n        crps.total_port_calls,\n        crps.avg_arrival_delay_hours,\n        crps.avg_departure_delay_hours,\n        crps.avg_dwell_time_hours,\n        crps.total_containers_handled,\n        crps.completion_rate,\n        crps.on_time_departure_rate,\n        crps.on_time_arrival_rate,\n        crps.cancellation_rate,\n        crps.route_avg_completion_rate,\n        crps.route_avg_on_time_departure_rate,\n        crps.route_avg_on_time_arrival_rate,\n        crps.route_avg_transit_days,\n        crps.route_avg_capacity_utilization,\n        crps.route_best_transit_days,\n        crps.route_best_capacity_utilization,\n        crps.route_completion_rank,\n        crps.route_on_time_rank,\n        crps.route_transit_rank,\n        crps.route_capacity_rank,\n        crps.route_carrier_count,\n        crps.route_completion_percentile,\n        crps.route_on_time_percentile,\n        ROUND(CAST(crps.performance_score AS NUMERIC), 2) AS performance_score,\n        -- Performance classification\n        CASE\n            WHEN crps.performance_score >= 85 THEN 'Excellent'\n            WHEN crps.performance_score >= 75 THEN 'Good'\n            WHEN crps.performance_score >= 65 THEN 'Average'\n            WHEN crps.performance_score >= 55 THEN 'Below Average'\n            ELSE 'Poor'\n        END AS performance_class,\n        -- Competitive position\n        CASE\n            WHEN crps.route_completion_rank = 1 AND crps.route_on_time_rank <= 2 THEN 'Market Leader'\n            WHEN crps.route_completion_rank <= 2 AND crps.route_on_time_rank <= 3 THEN 'Strong Competitor'\n            WHEN crps.route_completion_rank <= 3 THEN 'Competitive'\n            WHEN crps.route_completion_rank <= crps.route_carrier_count * 0.5 THEN 'Average'\n            ELSE 'Needs Improvement'\n        END AS competitive_position,\n        -- Service quality indicators\n        CASE\n            WHEN crps.completion_rate >= 95 AND crps.on_time_arrival_rate >= 85 THEN 'High Quality'\n            WHEN crps.completion_rate >= 90 AND crps.on_time_arrival_rate >= 75 THEN 'Good Quality'\n            WHEN crps.completion_rate >= 85 AND crps.on_time_arrival_rate >= 65 THEN 'Acceptable Quality'\n            ELSE 'Quality Issues'\n        END AS service_quality\n    FROM carrier_route_performance_scoring crps\n)\nSELECT\n    carrier_id,\n    carrier_name,\n    route_id,\n    route_name,\n    route_type,\n    total_sailings,\n    completed_sailings,\n    cancelled_sailings,\n    total_teu_carried,\n    avg_teu_per_sailing,\n    avg_capacity_utilization,\n    avg_transit_days,\n    avg_distance_nm,\n    median_transit_days,\n    p75_transit_days,\n    stddev_transit_days,\n    min_transit_days,\n    max_transit_days,\n    on_time_departures,\n    on_time_arrivals,\n    total_port_calls,\n    avg_arrival_delay_hours,\n    avg_departure_delay_hours,\n    avg_dwell_time_hours,\n    total_containers_handled,\n    completion_rate,\n    on_time_departure_rate,\n    on_time_arrival_rate,\n    cancellation_rate,\n    route_avg_completion_rate,\n    route_avg_on_time_departure_rate,\n    route_avg_on_time_arrival_rate,\n    route_avg_transit_days,\n    route_avg_capacity_utilization,\n    route_best_transit_days,\n    route_best_capacity_utilization,\n    route_completion_rank,\n    route_on_time_rank,\n    route_transit_rank,\n    route_capacity_rank,\n    route_carrier_count,\n    route_completion_percentile,\n    route_on_time_percentile,\n    performance_score,\n    performance_class,\n    competitive_position,\n    service_quality\nFROM carrier_route_classification\nORDER BY performance_score DESC, route_id, carrier_id\nLIMIT 500;",
      "line_number": 3479
    },
    {
      "number": 12,
      "title": "Vessel Tracking and Position Analysis with Route Deviation Detection and Speed Optimization",
      "description": "Use Case: Real-Time Monitoring - Comprehensive Vessel Tracking Analysis for Route Optimization Description: Enterprise-level vessel tracking analysis with multi-level CTE nesting, position tracking, route deviation detection, speed analysis, distance calculations, and advanced spatial operations. Demonstrates production patterns used by shipping lines for real-time vessel monitoring. Business Value: Vessel tracking report showing current positions, route deviations, speed patterns, distance trav",
      "complexity": "Deep nested CTEs (7+ levels), spatial operations (ST_DISTANCE, ST_BEARING, ST_MAKEPOINT), route deviation calculations, speed analysis, window functions with multiple frame clauses, temporal analysis, distance calculations",
      "expected_output": "Vessel tracking report with positions, route deviations, speed patterns, and optimization recommendations.",
      "sql": "WITH vessel_tracking_sequence AS (\n    -- First CTE: Sequence tracking points with temporal ordering\n    SELECT\n        vt.tracking_id,\n        vt.vessel_id,\n        ve.vessel_name,\n        ve.imo_number,\n        ve.container_capacity_teu,\n        vt.timestamp AS position_timestamp,\n        vt.latitude,\n        vt.longitude,\n        vt.position_geom,\n        vt.speed_knots,\n        vt.heading_degrees,\n        vt.navigation_status AS status,\n        s.sailing_id,\n        s.route_id,\n        r.route_name,\n        s.origin_port_id,\n        op.port_name AS origin_port_name,\n        s.destination_port_id,\n        dp.port_name AS destination_port_name,\n        -- Calculate position point\n        ST_MAKEPOINT(vt.longitude, vt.latitude)::GEOGRAPHY AS position_geography,\n        -- Previous position for distance calculation\n        LAG(vt.timestamp, 1) OVER (\n            PARTITION BY vt.vessel_id\n            ORDER BY vt.timestamp\n        ) AS prev_timestamp,\n        LAG(ST_MAKEPOINT(vt.longitude, vt.latitude)::GEOGRAPHY, 1) OVER (\n            PARTITION BY vt.vessel_id\n            ORDER BY vt.timestamp\n        ) AS prev_position,\n        LAG(vt.latitude, 1) OVER (\n            PARTITION BY vt.vessel_id\n            ORDER BY vt.timestamp\n        ) AS prev_latitude,\n        LAG(vt.longitude, 1) OVER (\n            PARTITION BY vt.vessel_id\n            ORDER BY vt.timestamp\n        ) AS prev_longitude,\n        LAG(vt.speed_knots, 1) OVER (\n            PARTITION BY vt.vessel_id\n            ORDER BY vt.timestamp\n        ) AS prev_speed_knots\n    FROM vessel_tracking vt\n    INNER JOIN vessels ve ON vt.vessel_id = ve.vessel_id\n    LEFT JOIN sailings s ON vt.vessel_id = s.vessel_id\n    LEFT JOIN routes r ON s.route_id = r.route_id\n    LEFT JOIN ports op ON s.origin_port_id = op.port_id\n    LEFT JOIN ports dp ON s.destination_port_id = dp.port_id\n    WHERE vt.timestamp >= CURRENT_TIMESTAMP - INTERVAL '30 days'\n),\nvessel_distance_calculations AS (\n    -- Second CTE: Calculate distances and speeds between tracking points\n    SELECT\n        vts.tracking_id,\n        vts.vessel_id,\n        vts.vessel_name,\n        vts.imo_number,\n        vts.container_capacity_teu,\n        vts.position_timestamp,\n        vts.latitude,\n        vts.longitude,\n        vts.position_geom,\n        vts.speed_knots,\n        vts.heading_degrees,\n        vts.status,\n        vts.sailing_id,\n        vts.route_id,\n        vts.route_name,\n        vts.origin_port_id,\n        vts.origin_port_name,\n        vts.destination_port_id,\n        vts.destination_port_name,\n        vts.position_geography,\n        vts.prev_timestamp,\n        vts.prev_position,\n        vts.prev_latitude,\n        vts.prev_longitude,\n        vts.prev_speed_knots,\n        -- Distance from previous position (nautical miles)\n        CASE\n            WHEN vts.prev_position IS NOT NULL AND vts.position_geography IS NOT NULL THEN\n                ST_DISTANCE(vts.prev_position, vts.position_geography) / 1852.0\n            ELSE NULL\n        END AS distance_from_prev_nm,\n        -- Time difference (hours)\n        CASE\n            WHEN vts.prev_timestamp IS NOT NULL THEN\n                EXTRACT(EPOCH FROM (vts.position_timestamp - vts.prev_timestamp)) / 3600.0\n            ELSE NULL\n        END AS time_diff_hours,\n        -- Calculated speed (nautical miles per hour)\n        CASE\n            WHEN vts.prev_position IS NOT NULL \n                AND vts.prev_timestamp IS NOT NULL \n                AND EXTRACT(EPOCH FROM (vts.position_timestamp - vts.prev_timestamp)) > 0 THEN\n                (ST_DISTANCE(vts.prev_position, vts.position_geography) / 1852.0) / \n                (EXTRACT(EPOCH FROM (vts.position_timestamp - vts.prev_timestamp)) / 3600.0)\n            ELSE NULL\n        END AS calculated_speed_knots,\n        -- Bearing from previous position (degrees)\n        CASE\n            WHEN vts.prev_latitude IS NOT NULL AND vts.prev_longitude IS NOT NULL THEN\n                DEGREES(\n                    ATAN2(\n                        SIN(RADIANS(vts.longitude - vts.prev_longitude)) * COS(RADIANS(vts.latitude)),\n                        COS(RADIANS(vts.prev_latitude)) * SIN(RADIANS(vts.latitude)) - \n                        SIN(RADIANS(vts.prev_latitude)) * COS(RADIANS(vts.latitude)) * \n                        COS(RADIANS(vts.longitude - vts.prev_longitude))\n                    )\n                )\n            ELSE NULL\n        END AS bearing_degrees\n    FROM vessel_tracking_sequence vts\n),\nroute_deviation_analysis AS (\n    -- Third CTE: Analyze route deviations\n    SELECT\n        vdc.tracking_id,\n        vdc.vessel_id,\n        vdc.vessel_name,\n        vdc.imo_number,\n        vdc.container_capacity_teu,\n        vdc.position_timestamp,\n        vdc.latitude,\n        vdc.longitude,\n        vdc.position_geom,\n        vdc.speed_knots,\n        vdc.heading_degrees,\n        vdc.status,\n        vdc.sailing_id,\n        vdc.route_id,\n        vdc.route_name,\n        vdc.origin_port_id,\n        vdc.origin_port_name,\n        vdc.destination_port_id,\n        vdc.destination_port_name,\n        vdc.position_geography,\n        ROUND(CAST(vdc.distance_from_prev_nm AS NUMERIC), 2) AS distance_from_prev_nm,\n        ROUND(CAST(vdc.time_diff_hours AS NUMERIC), 4) AS time_diff_hours,\n        ROUND(CAST(vdc.calculated_speed_knots AS NUMERIC), 2) AS calculated_speed_knots,\n        ROUND(CAST(vdc.bearing_degrees AS NUMERIC), 2) AS bearing_degrees,\n        -- Distance to origin port\n        CASE\n            WHEN op.port_geom IS NOT NULL AND vdc.position_geography IS NOT NULL THEN\n                ST_DISTANCE(op.port_geom, vdc.position_geography) / 1852.0\n            ELSE NULL\n        END AS distance_to_origin_nm,\n        -- Distance to destination port\n        CASE\n            WHEN dp.port_geom IS NOT NULL AND vdc.position_geography IS NOT NULL THEN\n                ST_DISTANCE(dp.port_geom, vdc.position_geography) / 1852.0\n            ELSE NULL\n        END AS distance_to_destination_nm,\n        -- Expected position based on route (simplified - using great circle)\n        CASE\n            WHEN op.port_geom IS NOT NULL AND dp.port_geom IS NOT NULL THEN\n                -- Calculate expected position as interpolation along route\n                -- Simplified: use distance ratio\n                NULL -- Complex calculation would require route waypoints\n            ELSE NULL\n        END AS expected_latitude,\n        CASE\n            WHEN op.port_geom IS NOT NULL AND dp.port_geom IS NOT NULL THEN\n                NULL -- Complex calculation would require route waypoints\n            ELSE NULL\n        END AS expected_longitude\n    FROM vessel_distance_calculations vdc\n    LEFT JOIN ports op ON vdc.origin_port_id = op.port_id\n    LEFT JOIN ports dp ON vdc.destination_port_id = dp.port_id\n),\nvessel_speed_analysis AS (\n    -- Fourth CTE: Analyze speed patterns\n    SELECT\n        rda.tracking_id,\n        rda.vessel_id,\n        rda.vessel_name,\n        rda.imo_number,\n        rda.container_capacity_teu,\n        rda.position_timestamp,\n        rda.latitude,\n        rda.longitude,\n        rda.position_geom,\n        rda.speed_knots,\n        rda.heading_degrees,\n        rda.status,\n        rda.sailing_id,\n        rda.route_id,\n        rda.route_name,\n        rda.origin_port_id,\n        rda.origin_port_name,\n        rda.destination_port_id,\n        rda.destination_port_name,\n        rda.distance_from_prev_nm,\n        rda.time_diff_hours,\n        rda.calculated_speed_knots,\n        rda.bearing_degrees,\n        rda.distance_to_origin_nm,\n        rda.distance_to_destination_nm,\n        -- Speed statistics\n        AVG(rda.speed_knots) OVER (\n            PARTITION BY rda.vessel_id\n            ORDER BY rda.position_timestamp\n            ROWS BETWEEN 11 PRECEDING AND CURRENT ROW\n        ) AS moving_avg_speed_12_points,\n        AVG(rda.speed_knots) OVER (\n            PARTITION BY rda.vessel_id\n            ORDER BY rda.position_timestamp\n            ROWS BETWEEN 23 PRECEDING AND CURRENT ROW\n        ) AS moving_avg_speed_24_points,\n        STDDEV(rda.speed_knots) OVER (\n            PARTITION BY rda.vessel_id\n            ORDER BY rda.position_timestamp\n            ROWS BETWEEN 11 PRECEDING AND CURRENT ROW\n        ) AS moving_stddev_speed_12_points,\n        MIN(rda.speed_knots) OVER (\n            PARTITION BY rda.vessel_id\n            ORDER BY rda.position_timestamp\n            ROWS BETWEEN 11 PRECEDING AND CURRENT ROW\n        ) AS min_speed_12_points,\n        MAX(rda.speed_knots) OVER (\n            PARTITION BY rda.vessel_id\n            ORDER BY rda.position_timestamp\n            ROWS BETWEEN 11 PRECEDING AND CURRENT ROW\n        ) AS max_speed_12_points,\n        -- Speed change\n        CASE\n            WHEN LAG(rda.speed_knots, 1) OVER (PARTITION BY rda.vessel_id ORDER BY rda.position_timestamp) IS NOT NULL THEN\n                rda.speed_knots - LAG(rda.speed_knots, 1) OVER (PARTITION BY rda.vessel_id ORDER BY rda.position_timestamp)\n            ELSE NULL\n        END AS speed_change_knots,\n        -- Speed classification\n        CASE\n            WHEN rda.speed_knots >= 20 THEN 'High Speed'\n            WHEN rda.speed_knots >= 15 THEN 'Normal Speed'\n            WHEN rda.speed_knots >= 10 THEN 'Slow Speed'\n            WHEN rda.speed_knots >= 5 THEN 'Very Slow'\n            ELSE 'Stopped/Anchored'\n        END AS speed_class,\n        -- Cumulative distance\n        SUM(rda.distance_from_prev_nm) OVER (\n            PARTITION BY rda.vessel_id, rda.sailing_id\n            ORDER BY rda.position_timestamp\n            ROWS UNBOUNDED PRECEDING\n        ) AS cumulative_distance_nm\n    FROM route_deviation_analysis rda\n),\nvessel_tracking_summary AS (\n    -- Fifth CTE: Summarize tracking data by vessel and sailing\n    SELECT\n        vsa.tracking_id,\n        vsa.vessel_id,\n        vsa.vessel_name,\n        vsa.imo_number,\n        vsa.container_capacity_teu,\n        vsa.position_timestamp,\n        vsa.latitude,\n        vsa.longitude,\n        vsa.position_geom,\n        vsa.speed_knots,\n        vsa.heading_degrees,\n        vsa.status,\n        vsa.sailing_id,\n        vsa.route_id,\n        vsa.route_name,\n        vsa.origin_port_id,\n        vsa.origin_port_name,\n        vsa.destination_port_id,\n        vsa.destination_port_name,\n        vsa.distance_from_prev_nm,\n        vsa.time_diff_hours,\n        vsa.calculated_speed_knots,\n        vsa.bearing_degrees,\n        vsa.distance_to_origin_nm,\n        vsa.distance_to_destination_nm,\n        ROUND(CAST(vsa.moving_avg_speed_12_points AS NUMERIC), 2) AS moving_avg_speed_12_points,\n        ROUND(CAST(vsa.moving_avg_speed_24_points AS NUMERIC), 2) AS moving_avg_speed_24_points,\n        ROUND(CAST(vsa.moving_stddev_speed_12_points AS NUMERIC), 2) AS moving_stddev_speed_12_points,\n        ROUND(CAST(vsa.min_speed_12_points AS NUMERIC), 2) AS min_speed_12_points,\n        ROUND(CAST(vsa.max_speed_12_points AS NUMERIC), 2) AS max_speed_12_points,\n        ROUND(CAST(vsa.speed_change_knots AS NUMERIC), 2) AS speed_change_knots,\n        vsa.speed_class,\n        ROUND(CAST(vsa.cumulative_distance_nm AS NUMERIC), 2) AS cumulative_distance_nm,\n        -- Tracking point sequence number\n        ROW_NUMBER() OVER (\n            PARTITION BY vsa.vessel_id, vsa.sailing_id\n            ORDER BY vsa.position_timestamp\n        ) AS tracking_point_sequence,\n        -- Total tracking points for this sailing\n        COUNT(*) OVER (PARTITION BY vsa.vessel_id, vsa.sailing_id) AS total_tracking_points,\n        -- Time since sailing start\n        CASE\n            WHEN MIN(vsa.position_timestamp) OVER (PARTITION BY vsa.vessel_id, vsa.sailing_id) IS NOT NULL THEN\n                EXTRACT(EPOCH FROM (vsa.position_timestamp - MIN(vsa.position_timestamp) OVER (PARTITION BY vsa.vessel_id, vsa.sailing_id))) / 3600.0\n            ELSE NULL\n        END AS hours_since_sailing_start\n    FROM vessel_speed_analysis vsa\n),\nvessel_route_optimization AS (\n    -- Sixth CTE: Identify optimization opportunities\n    SELECT\n        vts.tracking_id,\n        vts.vessel_id,\n        vts.vessel_name,\n        vts.imo_number,\n        vts.container_capacity_teu,\n        vts.position_timestamp,\n        vts.latitude,\n        vts.longitude,\n        vts.position_geom,\n        vts.speed_knots,\n        vts.heading_degrees,\n        vts.status,\n        vts.sailing_id,\n        vts.route_id,\n        vts.route_name,\n        vts.origin_port_id,\n        vts.origin_port_name,\n        vts.destination_port_id,\n        vts.destination_port_name,\n        vts.distance_from_prev_nm,\n        vts.time_diff_hours,\n        vts.calculated_speed_knots,\n        vts.bearing_degrees,\n        vts.distance_to_origin_nm,\n        vts.distance_to_destination_nm,\n        vts.moving_avg_speed_12_points,\n        vts.moving_avg_speed_24_points,\n        vts.moving_stddev_speed_12_points,\n        vts.min_speed_12_points,\n        vts.max_speed_12_points,\n        vts.speed_change_knots,\n        vts.speed_class,\n        vts.cumulative_distance_nm,\n        vts.tracking_point_sequence,\n        vts.total_tracking_points,\n        ROUND(CAST(vts.hours_since_sailing_start AS NUMERIC), 2) AS hours_since_sailing_start,\n        -- Speed efficiency indicator\n        CASE\n            WHEN vts.moving_avg_speed_12_points IS NOT NULL AND vts.moving_avg_speed_24_points IS NOT NULL THEN\n                CASE\n                    WHEN vts.moving_avg_speed_12_points > vts.moving_avg_speed_24_points * 1.1 THEN 'Accelerating'\n                    WHEN vts.moving_avg_speed_12_points < vts.moving_avg_speed_24_points * 0.9 THEN 'Decelerating'\n                    ELSE 'Steady Speed'\n                END\n            ELSE 'Insufficient Data'\n        END AS speed_trend,\n        -- Route efficiency (distance vs expected)\n        CASE\n            WHEN vts.distance_to_destination_nm IS NOT NULL AND vts.cumulative_distance_nm IS NOT NULL THEN\n                CASE\n                    WHEN vts.cumulative_distance_nm > vts.distance_to_destination_nm * 1.2 THEN 'Inefficient Route'\n                    WHEN vts.cumulative_distance_nm > vts.distance_to_destination_nm * 1.1 THEN 'Slightly Inefficient'\n                    ELSE 'Efficient Route'\n                END\n            ELSE 'Unknown'\n        END AS route_efficiency,\n        -- Optimization recommendation\n        CASE\n            WHEN vts.speed_knots < 10 AND vts.distance_to_destination_nm > 100 THEN 'Consider Increasing Speed'\n            WHEN vts.speed_knots > 20 AND vts.distance_to_destination_nm < 50 THEN 'Consider Reducing Speed'\n            WHEN vts.moving_stddev_speed_12_points > 5 THEN 'Speed Inconsistency - Review Operations'\n            ELSE 'Normal Operations'\n        END AS optimization_recommendation\n    FROM vessel_tracking_summary vts\n)\nSELECT\n    tracking_id,\n    vessel_id,\n    vessel_name,\n    imo_number,\n    container_capacity_teu,\n    position_timestamp,\n    latitude,\n    longitude,\n    speed_knots,\n    heading_degrees,\n    status,\n    sailing_id,\n    route_id,\n    route_name,\n    origin_port_id,\n    origin_port_name,\n    destination_port_id,\n    destination_port_name,\n    distance_from_prev_nm,\n    time_diff_hours,\n    calculated_speed_knots,\n    bearing_degrees,\n    distance_to_origin_nm,\n    distance_to_destination_nm,\n    moving_avg_speed_12_points,\n    moving_avg_speed_24_points,\n    moving_stddev_speed_12_points,\n    min_speed_12_points,\n    max_speed_12_points,\n    speed_change_knots,\n    speed_class,\n    cumulative_distance_nm,\n    tracking_point_sequence,\n    total_tracking_points,\n    hours_since_sailing_start,\n    speed_trend,\n    route_efficiency,\n    optimization_recommendation\nFROM vessel_route_optimization\nORDER BY vessel_id, position_timestamp DESC\nLIMIT 5000;",
      "line_number": 3860
    },
    {
      "number": 13,
      "title": "Port Capacity Utilization Analysis with Berth Optimization and Congestion Detection",
      "description": "Use Case: Port Operations - Comprehensive Port Capacity Utilization Analysis for Berth Optimization Description: Enterprise-level port capacity analysis with multi-level CTE nesting, capacity calculations, berth utilization, congestion detection, throughput analysis, and advanced window functions. Demonstrates production patterns used by port operators for capacity planning. Business Value: Port capacity report showing utilization rates, berth efficiency, congestion patterns, and optimization op",
      "complexity": "Deep nested CTEs (7+ levels), capacity calculations, berth utilization analysis, congestion detection, window functions with multiple frame clauses, percentile calculations, throughput analysis, temporal aggregation",
      "expected_output": "Port capacity report with utilization rates, berth efficiency, congestion patterns, and optimization recommendations.",
      "sql": "WITH port_call_detailed_metrics AS (\n    -- First CTE: Aggregate port call metrics with berth information\n    SELECT\n        pc.port_call_id,\n        pc.port_id,\n        p.port_name,\n        p.port_code,\n        p.locode,\n        p.country,\n        p.berth_count,\n        p.container_capacity_teu AS annual_container_capacity_teu,\n        pc.vessel_id,\n        ve.vessel_name,\n        ve.imo_number,\n        ve.container_capacity_teu AS vessel_capacity_teu,\n        pc.status AS port_call_status,\n        pc.scheduled_arrival,\n        pc.actual_arrival,\n        pc.scheduled_departure,\n        pc.actual_departure,\n        pc.containers_loaded,\n        pc.containers_discharged,\n        pc.containers_transshipped,\n        COALESCE(pc.containers_loaded, 0) + COALESCE(pc.containers_discharged, 0) + COALESCE(pc.containers_transshipped, 0) AS total_containers,\n        -- Calculate dwell time\n        CASE\n            WHEN pc.actual_arrival IS NOT NULL AND pc.actual_departure IS NOT NULL THEN\n                EXTRACT(EPOCH FROM (pc.actual_departure - pc.actual_arrival)) / 3600.0\n            ELSE NULL\n        END AS dwell_time_hours,\n        -- Calculate delays\n        CASE\n            WHEN pc.actual_arrival IS NOT NULL AND pc.scheduled_arrival IS NOT NULL THEN\n                EXTRACT(EPOCH FROM (pc.actual_arrival - pc.scheduled_arrival)) / 3600.0\n            ELSE NULL\n        END AS arrival_delay_hours,\n        CASE\n            WHEN pc.actual_departure IS NOT NULL AND pc.scheduled_departure IS NOT NULL THEN\n                EXTRACT(EPOCH FROM (pc.actual_departure - pc.scheduled_departure)) / 3600.0\n            ELSE NULL\n        END AS departure_delay_hours,\n        -- Time period for aggregation\n        DATE_TRUNC('day', COALESCE(pc.actual_arrival, pc.scheduled_arrival)) AS port_call_date,\n        DATE_TRUNC('week', COALESCE(pc.actual_arrival, pc.scheduled_arrival)) AS port_call_week,\n        DATE_TRUNC('month', COALESCE(pc.actual_arrival, pc.scheduled_arrival)) AS port_call_month\n    FROM port_calls pc\n    INNER JOIN ports p ON pc.port_id = p.port_id\n    LEFT JOIN vessels ve ON pc.vessel_id = ve.vessel_id\n    WHERE COALESCE(pc.actual_arrival, pc.scheduled_arrival) >= CURRENT_DATE - INTERVAL '2 years'\n),\nport_daily_capacity_metrics AS (\n    -- Second CTE: Aggregate daily capacity metrics\n    SELECT\n        pcdm.port_id,\n        pcdm.port_name,\n        pcdm.port_code,\n        pcdm.locode,\n        pcdm.country,\n        pcdm.berth_count,\n        pcdm.annual_container_capacity_teu,\n        pcdm.port_call_date,\n        COUNT(DISTINCT pcdm.port_call_id) AS daily_port_calls,\n        COUNT(DISTINCT CASE WHEN pcdm.port_call_status = 'Completed' THEN pcdm.port_call_id END) AS daily_completed_calls,\n        COUNT(DISTINCT CASE WHEN pcdm.actual_arrival IS NOT NULL AND pcdm.actual_departure IS NOT NULL THEN pcdm.port_call_id END) AS daily_active_calls,\n        SUM(pcdm.total_containers) AS daily_total_containers,\n        SUM(pcdm.containers_loaded) AS daily_containers_loaded,\n        SUM(pcdm.containers_discharged) AS daily_containers_discharged,\n        SUM(pcdm.containers_transshipped) AS daily_containers_transshipped,\n        AVG(pcdm.dwell_time_hours) AS avg_dwell_time_hours,\n        AVG(pcdm.arrival_delay_hours) AS avg_arrival_delay_hours,\n        AVG(pcdm.departure_delay_hours) AS avg_departure_delay_hours,\n        MAX(pcdm.dwell_time_hours) AS max_dwell_time_hours,\n        PERCENTILE_CONT(0.5) WITHIN GROUP (ORDER BY pcdm.dwell_time_hours) AS median_dwell_time_hours,\n        PERCENTILE_CONT(0.75) WITHIN GROUP (ORDER BY pcdm.dwell_time_hours) AS p75_dwell_time_hours,\n        PERCENTILE_CONT(0.9) WITHIN GROUP (ORDER BY pcdm.dwell_time_hours) AS p90_dwell_time_hours,\n        -- Concurrent berth usage (simplified - count overlapping port calls)\n        COUNT(DISTINCT CASE \n            WHEN pcdm.actual_arrival IS NOT NULL AND pcdm.actual_departure IS NOT NULL THEN pcdm.port_call_id\n        END) AS concurrent_berths_used,\n        -- Vessel capacity utilization\n        SUM(pcdm.vessel_capacity_teu) AS total_vessel_capacity_teu,\n        AVG(pcdm.vessel_capacity_teu) AS avg_vessel_capacity_teu\n    FROM port_call_detailed_metrics pcdm\n    GROUP BY\n        pcdm.port_id,\n        pcdm.port_name,\n        pcdm.port_code,\n        pcdm.locode,\n        pcdm.country,\n        pcdm.berth_count,\n        pcdm.annual_container_capacity_teu,\n        pcdm.port_call_date\n),\nport_capacity_utilization AS (\n    -- Third CTE: Calculate capacity utilization metrics\n    SELECT\n        pdcm.port_id,\n        pdcm.port_name,\n        pdcm.port_code,\n        pdcm.locode,\n        pdcm.country,\n        pdcm.berth_count,\n        pdcm.annual_container_capacity_teu,\n        pdcm.port_call_date,\n        pdcm.daily_port_calls,\n        pdcm.daily_completed_calls,\n        pdcm.daily_active_calls,\n        ROUND(CAST(pdcm.daily_total_containers AS NUMERIC), 0) AS daily_total_containers,\n        ROUND(CAST(pdcm.daily_containers_loaded AS NUMERIC), 0) AS daily_containers_loaded,\n        ROUND(CAST(pdcm.daily_containers_discharged AS NUMERIC), 0) AS daily_containers_discharged,\n        ROUND(CAST(pdcm.daily_containers_transshipped AS NUMERIC), 0) AS daily_containers_transshipped,\n        ROUND(CAST(pdcm.avg_dwell_time_hours AS NUMERIC), 2) AS avg_dwell_time_hours,\n        ROUND(CAST(pdcm.avg_arrival_delay_hours AS NUMERIC), 2) AS avg_arrival_delay_hours,\n        ROUND(CAST(pdcm.avg_departure_delay_hours AS NUMERIC), 2) AS avg_departure_delay_hours,\n        ROUND(CAST(pdcm.max_dwell_time_hours AS NUMERIC), 2) AS max_dwell_time_hours,\n        ROUND(CAST(pdcm.median_dwell_time_hours AS NUMERIC), 2) AS median_dwell_time_hours,\n        ROUND(CAST(pdcm.p75_dwell_time_hours AS NUMERIC), 2) AS p75_dwell_time_hours,\n        ROUND(CAST(pdcm.p90_dwell_time_hours AS NUMERIC), 2) AS p90_dwell_time_hours,\n        pdcm.concurrent_berths_used,\n        ROUND(CAST(pdcm.total_vessel_capacity_teu AS NUMERIC), 0) AS total_vessel_capacity_teu,\n        ROUND(CAST(pdcm.avg_vessel_capacity_teu AS NUMERIC), 2) AS avg_vessel_capacity_teu,\n        -- Berth utilization rate\n        CASE\n            WHEN pdcm.berth_count > 0 THEN\n                ROUND(CAST((pdcm.concurrent_berths_used::NUMERIC / pdcm.berth_count::NUMERIC) * 100 AS NUMERIC), 2)\n            ELSE NULL\n        END AS berth_utilization_percent,\n        -- Daily capacity utilization (containers vs annual capacity)\n        CASE\n            WHEN pdcm.annual_container_capacity_teu > 0 THEN\n                ROUND(CAST((pdcm.daily_total_containers::NUMERIC / (pdcm.annual_container_capacity_teu::NUMERIC / 365.0)) * 100 AS NUMERIC), 2)\n            ELSE NULL\n        END AS daily_capacity_utilization_percent,\n        -- Moving averages\n        AVG(pdcm.daily_total_containers) OVER (\n            PARTITION BY pdcm.port_id\n            ORDER BY pdcm.port_call_date\n            ROWS BETWEEN 6 PRECEDING AND CURRENT ROW\n        ) AS moving_avg_daily_containers_7_day,\n        AVG(pdcm.concurrent_berths_used) OVER (\n            PARTITION BY pdcm.port_id\n            ORDER BY pdcm.port_call_date\n            ROWS BETWEEN 6 PRECEDING AND CURRENT ROW\n        ) AS moving_avg_berths_7_day,\n        AVG(pdcm.avg_dwell_time_hours) OVER (\n            PARTITION BY pdcm.port_id\n            ORDER BY pdcm.port_call_date\n            ROWS BETWEEN 6 PRECEDING AND CURRENT ROW\n        ) AS moving_avg_dwell_time_7_day\n    FROM port_daily_capacity_metrics pdcm\n),\nport_congestion_analysis AS (\n    -- Fourth CTE: Analyze congestion patterns\n    SELECT\n        pcu.port_id,\n        pcu.port_name,\n        pcu.port_code,\n        pcu.locode,\n        pcu.country,\n        pcu.berth_count,\n        pcu.annual_container_capacity_teu,\n        pcu.port_call_date,\n        pcu.daily_port_calls,\n        pcu.daily_completed_calls,\n        pcu.daily_active_calls,\n        pcu.daily_total_containers,\n        pcu.daily_containers_loaded,\n        pcu.daily_containers_discharged,\n        pcu.daily_containers_transshipped,\n        pcu.avg_dwell_time_hours,\n        pcu.avg_arrival_delay_hours,\n        pcu.avg_departure_delay_hours,\n        pcu.max_dwell_time_hours,\n        pcu.median_dwell_time_hours,\n        pcu.p75_dwell_time_hours,\n        pcu.p90_dwell_time_hours,\n        pcu.concurrent_berths_used,\n        pcu.total_vessel_capacity_teu,\n        pcu.avg_vessel_capacity_teu,\n        pcu.berth_utilization_percent,\n        pcu.daily_capacity_utilization_percent,\n        ROUND(CAST(pcu.moving_avg_daily_containers_7_day AS NUMERIC), 0) AS moving_avg_daily_containers_7_day,\n        ROUND(CAST(pcu.moving_avg_berths_7_day AS NUMERIC), 2) AS moving_avg_berths_7_day,\n        ROUND(CAST(pcu.moving_avg_dwell_time_7_day AS NUMERIC), 2) AS moving_avg_dwell_time_7_day,\n        -- Congestion indicators\n        CASE\n            WHEN pcu.berth_utilization_percent >= 90 THEN 'Severe Congestion'\n            WHEN pcu.berth_utilization_percent >= 80 THEN 'High Congestion'\n            WHEN pcu.berth_utilization_percent >= 70 THEN 'Moderate Congestion'\n            WHEN pcu.berth_utilization_percent >= 60 THEN 'Low Congestion'\n            ELSE 'No Congestion'\n        END AS congestion_level,\n        CASE\n            WHEN pcu.avg_dwell_time_hours > pcu.moving_avg_dwell_time_7_day * 1.2 THEN 'Increasing Dwell Time'\n            WHEN pcu.avg_dwell_time_hours < pcu.moving_avg_dwell_time_7_day * 0.8 THEN 'Decreasing Dwell Time'\n            ELSE 'Stable Dwell Time'\n        END AS dwell_time_trend,\n        CASE\n            WHEN pcu.avg_arrival_delay_hours > 12 THEN 'High Arrival Delays'\n            WHEN pcu.avg_arrival_delay_hours > 6 THEN 'Moderate Arrival Delays'\n            WHEN pcu.avg_arrival_delay_hours > 0 THEN 'Low Arrival Delays'\n            ELSE 'No Arrival Delays'\n        END AS arrival_delay_level,\n        -- Capacity stress indicator\n        CASE\n            WHEN pcu.daily_capacity_utilization_percent >= 120 THEN 'Over Capacity'\n            WHEN pcu.daily_capacity_utilization_percent >= 100 THEN 'At Capacity'\n            WHEN pcu.daily_capacity_utilization_percent >= 80 THEN 'Near Capacity'\n            WHEN pcu.daily_capacity_utilization_percent >= 60 THEN 'Moderate Utilization'\n            ELSE 'Low Utilization'\n        END AS capacity_stress_level\n    FROM port_capacity_utilization pcu\n),\nport_optimization_recommendations AS (\n    -- Fifth CTE: Generate optimization recommendations\n    SELECT\n        pca.port_id,\n        pca.port_name,\n        pca.port_code,\n        pca.locode,\n        pca.country,\n        pca.berth_count,\n        pca.annual_container_capacity_teu,\n        pca.port_call_date,\n        pca.daily_port_calls,\n        pca.daily_completed_calls,\n        pca.daily_active_calls,\n        pca.daily_total_containers,\n        pca.daily_containers_loaded,\n        pca.daily_containers_discharged,\n        pca.daily_containers_transshipped,\n        pca.avg_dwell_time_hours,\n        pca.avg_arrival_delay_hours,\n        pca.avg_departure_delay_hours,\n        pca.max_dwell_time_hours,\n        pca.median_dwell_time_hours,\n        pca.p75_dwell_time_hours,\n        pca.p90_dwell_time_hours,\n        pca.concurrent_berths_used,\n        pca.total_vessel_capacity_teu,\n        pca.avg_vessel_capacity_teu,\n        pca.berth_utilization_percent,\n        pca.daily_capacity_utilization_percent,\n        pca.moving_avg_daily_containers_7_day,\n        pca.moving_avg_berths_7_day,\n        pca.moving_avg_dwell_time_7_day,\n        pca.congestion_level,\n        pca.dwell_time_trend,\n        pca.arrival_delay_level,\n        pca.capacity_stress_level,\n        -- Optimization recommendations\n        CASE\n            WHEN pca.congestion_level IN ('Severe Congestion', 'High Congestion') THEN 'Consider Adding Berths or Optimizing Berth Allocation'\n            WHEN pca.avg_dwell_time_hours > 48 THEN 'Review Cargo Handling Efficiency - Dwell Time Too High'\n            WHEN pca.avg_arrival_delay_hours > 12 THEN 'Improve Arrival Scheduling - High Delays'\n            WHEN pca.daily_capacity_utilization_percent > 100 THEN 'Capacity Exceeded - Consider Expansion'\n            WHEN pca.berth_utilization_percent < 50 AND pca.daily_total_containers > 0 THEN 'Underutilized Berths - Optimize Allocation'\n            ELSE 'Operations Normal'\n        END AS optimization_recommendation,\n        -- Efficiency score\n        (\n            -- Berth utilization component (30%)\n            COALESCE(pca.berth_utilization_percent / 100.0 * 30, 0) +\n            -- Capacity utilization component (25%)\n            CASE\n                WHEN pca.daily_capacity_utilization_percent IS NOT NULL THEN\n                    LEAST(1.0, pca.daily_capacity_utilization_percent / 100.0) * 25\n                ELSE 0\n            END +\n            -- Dwell time efficiency component (25%) - inverse (lower is better)\n            CASE\n                WHEN pca.avg_dwell_time_hours IS NOT NULL THEN\n                    GREATEST(0, (1.0 - (pca.avg_dwell_time_hours - 24) / 48.0)) * 25\n                ELSE 0\n            END +\n            -- Delay efficiency component (20%) - inverse (lower is better)\n            CASE\n                WHEN pca.avg_arrival_delay_hours IS NOT NULL THEN\n                    GREATEST(0, (1.0 - pca.avg_arrival_delay_hours / 24.0)) * 20\n                ELSE 0\n            END\n        ) AS efficiency_score\n    FROM port_congestion_analysis pca\n)\nSELECT\n    port_id,\n    port_name,\n    port_code,\n    locode,\n    country,\n    berth_count,\n    annual_container_capacity_teu,\n    port_call_date,\n    daily_port_calls,\n    daily_completed_calls,\n    daily_active_calls,\n    daily_total_containers,\n    daily_containers_loaded,\n    daily_containers_discharged,\n    daily_containers_transshipped,\n    avg_dwell_time_hours,\n    avg_arrival_delay_hours,\n    avg_departure_delay_hours,\n    max_dwell_time_hours,\n    median_dwell_time_hours,\n    p75_dwell_time_hours,\n    p90_dwell_time_hours,\n    concurrent_berths_used,\n    total_vessel_capacity_teu,\n    avg_vessel_capacity_teu,\n    berth_utilization_percent,\n    daily_capacity_utilization_percent,\n    moving_avg_daily_containers_7_day,\n    moving_avg_berths_7_day,\n    moving_avg_dwell_time_7_day,\n    congestion_level,\n    dwell_time_trend,\n    arrival_delay_level,\n    capacity_stress_level,\n    optimization_recommendation,\n    ROUND(CAST(efficiency_score AS NUMERIC), 2) AS efficiency_score\nFROM port_optimization_recommendations\nORDER BY port_call_date DESC, efficiency_score DESC\nLIMIT 2000;",
      "line_number": 4291
    },
    {
      "number": 14,
      "title": "Sailing Schedule Reliability Analysis with On-Time Performance Metrics and Service Consistency",
      "description": "Use Case: Service Quality - Comprehensive Sailing Schedule Reliability Analysis for Service Consistency Description: Enterprise-level sailing schedule reliability analysis with multi-level CTE nesting, on-time performance calculations, schedule adherence metrics, service consistency analysis, and advanced window functions. Demonstrates production patterns used by shipping lines for schedule reliability. Business Value: Sailing schedule reliability report showing on-time performance, schedule adh",
      "complexity": "Deep nested CTEs (7+ levels), reliability calculations, schedule adherence analysis, window functions with multiple frame clauses, percentile calculations, consistency metrics, temporal analysis",
      "expected_output": "Sailing schedule reliability report with on-time performance metrics, schedule adherence, and service consistency analysis.",
      "sql": "WITH sailing_schedule_metrics AS (\n    -- First CTE: Calculate schedule adherence metrics\n    SELECT\n        s.sailing_id,\n        r.carrier_id,\n        c.carrier_name,\n        s.route_id,\n        r.route_name,\n        s.vessel_id,\n        ve.vessel_name,\n        ve.imo_number,\n        s.origin_port_id,\n        op.port_name AS origin_port_name,\n        op.port_code AS origin_port_code,\n        s.destination_port_id,\n        dp.port_name AS destination_port_name,\n        dp.port_code AS destination_port_code,\n        s.status AS sailing_status,\n        s.scheduled_departure,\n        s.actual_departure,\n        s.scheduled_arrival,\n        s.actual_arrival,\n        s.total_teu,\n        s.capacity_utilization_percent,\n        s.transit_days,\n        s.distance_nautical_miles,\n        -- Departure delay (hours)\n        CASE\n            WHEN s.actual_departure IS NOT NULL AND s.scheduled_departure IS NOT NULL THEN\n                EXTRACT(EPOCH FROM (s.actual_departure - s.scheduled_departure)) / 3600.0\n            ELSE NULL\n        END AS departure_delay_hours,\n        -- Arrival delay (hours)\n        CASE\n            WHEN s.actual_arrival IS NOT NULL AND s.scheduled_arrival IS NOT NULL THEN\n                EXTRACT(EPOCH FROM (s.actual_arrival - s.scheduled_arrival)) / 3600.0\n            ELSE NULL\n        END AS arrival_delay_hours,\n        -- Actual transit time (days)\n        CASE\n            WHEN s.actual_departure IS NOT NULL AND s.actual_arrival IS NOT NULL THEN\n                EXTRACT(EPOCH FROM (s.actual_arrival - s.actual_departure)) / 24.0\n            ELSE NULL\n        END AS actual_transit_days,\n        -- Scheduled transit time (days)\n        CASE\n            WHEN s.scheduled_departure IS NOT NULL AND s.scheduled_arrival IS NOT NULL THEN\n                EXTRACT(EPOCH FROM (s.scheduled_arrival - s.scheduled_departure)) / 24.0\n            ELSE NULL\n        END AS scheduled_transit_days,\n        -- On-time indicators\n        CASE\n            WHEN s.actual_departure IS NOT NULL AND s.scheduled_departure IS NOT NULL\n                AND EXTRACT(EPOCH FROM (s.actual_departure - s.scheduled_departure)) / 3600.0 <= 6 THEN 1\n            ELSE 0\n        END AS on_time_departure,\n        CASE\n            WHEN s.actual_arrival IS NOT NULL AND s.scheduled_arrival IS NOT NULL\n                AND EXTRACT(EPOCH FROM (s.actual_arrival - s.scheduled_arrival)) / 3600.0 <= 6 THEN 1\n            ELSE 0\n        END AS on_time_arrival,\n        -- Completion indicator\n        CASE\n            WHEN s.status = 'Completed' THEN 1\n            ELSE 0\n        END AS sailing_completed,\n        -- Time period for aggregation\n        DATE_TRUNC('week', s.scheduled_departure) AS sailing_week,\n        DATE_TRUNC('month', s.scheduled_departure) AS sailing_month,\n        DATE_TRUNC('quarter', s.scheduled_departure) AS sailing_quarter\n    FROM sailings s\n    INNER JOIN routes r ON s.route_id = r.route_id\n    INNER JOIN carriers c ON r.carrier_id = c.carrier_id\n    LEFT JOIN vessels ve ON s.vessel_id = ve.vessel_id\n    LEFT JOIN ports op ON s.origin_port_id = op.port_id\n    LEFT JOIN ports dp ON s.destination_port_id = dp.port_id\n    WHERE s.scheduled_departure >= CURRENT_DATE - INTERVAL '2 years'\n),\ncarrier_route_reliability_metrics AS (\n    -- Second CTE: Aggregate reliability metrics by carrier and route\n    SELECT\n        ssm.carrier_id,\n        ssm.carrier_name,\n        ssm.route_id,\n        ssm.route_name,\n        ssm.sailing_month,\n        COUNT(DISTINCT ssm.sailing_id) AS total_sailings,\n        SUM(ssm.sailing_completed) AS completed_sailings,\n        SUM(ssm.on_time_departure) AS on_time_departures,\n        SUM(ssm.on_time_arrival) AS on_time_arrivals,\n        AVG(ssm.departure_delay_hours) AS avg_departure_delay_hours,\n        AVG(ssm.arrival_delay_hours) AS avg_arrival_delay_hours,\n        AVG(ssm.actual_transit_days) AS avg_actual_transit_days,\n        AVG(ssm.scheduled_transit_days) AS avg_scheduled_transit_days,\n        PERCENTILE_CONT(0.5) WITHIN GROUP (ORDER BY ssm.departure_delay_hours) AS median_departure_delay,\n        PERCENTILE_CONT(0.5) WITHIN GROUP (ORDER BY ssm.arrival_delay_hours) AS median_arrival_delay,\n        PERCENTILE_CONT(0.75) WITHIN GROUP (ORDER BY ssm.departure_delay_hours) AS p75_departure_delay,\n        PERCENTILE_CONT(0.75) WITHIN GROUP (ORDER BY ssm.arrival_delay_hours) AS p75_arrival_delay,\n        PERCENTILE_CONT(0.9) WITHIN GROUP (ORDER BY ssm.departure_delay_hours) AS p90_departure_delay,\n        PERCENTILE_CONT(0.9) WITHIN GROUP (ORDER BY ssm.arrival_delay_hours) AS p90_arrival_delay,\n        STDDEV(ssm.departure_delay_hours) AS stddev_departure_delay,\n        STDDEV(ssm.arrival_delay_hours) AS stddev_arrival_delay,\n        MIN(ssm.departure_delay_hours) AS min_departure_delay,\n        MAX(ssm.departure_delay_hours) AS max_departure_delay,\n        MIN(ssm.arrival_delay_hours) AS min_arrival_delay,\n        MAX(ssm.arrival_delay_hours) AS max_arrival_delay,\n        -- Completion rate\n        CASE\n            WHEN COUNT(DISTINCT ssm.sailing_id) > 0 THEN\n                (SUM(ssm.sailing_completed)::NUMERIC / COUNT(DISTINCT ssm.sailing_id)::NUMERIC) * 100\n            ELSE 0\n        END AS completion_rate,\n        -- On-time performance rates\n        CASE\n            WHEN COUNT(DISTINCT ssm.sailing_id) > 0 THEN\n                (SUM(ssm.on_time_departure)::NUMERIC / COUNT(DISTINCT ssm.sailing_id)::NUMERIC) * 100\n            ELSE 0\n        END AS on_time_departure_rate,\n        CASE\n            WHEN COUNT(DISTINCT ssm.sailing_id) > 0 THEN\n                (SUM(ssm.on_time_arrival)::NUMERIC / COUNT(DISTINCT ssm.sailing_id)::NUMERIC) * 100\n            ELSE 0\n        END AS on_time_arrival_rate\n    FROM sailing_schedule_metrics ssm\n    GROUP BY\n        ssm.carrier_id,\n        ssm.carrier_name,\n        ssm.route_id,\n        ssm.route_name,\n        ssm.sailing_month\n),\nreliability_trend_analysis AS (\n    -- Third CTE: Analyze reliability trends\n    SELECT\n        crrm.carrier_id,\n        crrm.carrier_name,\n        crrm.route_id,\n        crrm.route_name,\n        crrm.sailing_month,\n        crrm.total_sailings,\n        crrm.completed_sailings,\n        crrm.on_time_departures,\n        crrm.on_time_arrivals,\n        ROUND(CAST(crrm.avg_departure_delay_hours AS NUMERIC), 2) AS avg_departure_delay_hours,\n        ROUND(CAST(crrm.avg_arrival_delay_hours AS NUMERIC), 2) AS avg_arrival_delay_hours,\n        ROUND(CAST(crrm.avg_actual_transit_days AS NUMERIC), 2) AS avg_actual_transit_days,\n        ROUND(CAST(crrm.avg_scheduled_transit_days AS NUMERIC), 2) AS avg_scheduled_transit_days,\n        ROUND(CAST(crrm.median_departure_delay AS NUMERIC), 2) AS median_departure_delay,\n        ROUND(CAST(crrm.median_arrival_delay AS NUMERIC), 2) AS median_arrival_delay,\n        ROUND(CAST(crrm.p75_departure_delay AS NUMERIC), 2) AS p75_departure_delay,\n        ROUND(CAST(crrm.p75_arrival_delay AS NUMERIC), 2) AS p75_arrival_delay,\n        ROUND(CAST(crrm.p90_departure_delay AS NUMERIC), 2) AS p90_departure_delay,\n        ROUND(CAST(crrm.p90_arrival_delay AS NUMERIC), 2) AS p90_arrival_delay,\n        ROUND(CAST(crrm.stddev_departure_delay AS NUMERIC), 2) AS stddev_departure_delay,\n        ROUND(CAST(crrm.stddev_arrival_delay AS NUMERIC), 2) AS stddev_arrival_delay,\n        ROUND(CAST(crrm.min_departure_delay AS NUMERIC), 2) AS min_departure_delay,\n        ROUND(CAST(crrm.max_departure_delay AS NUMERIC), 2) AS max_departure_delay,\n        ROUND(CAST(crrm.min_arrival_delay AS NUMERIC), 2) AS min_arrival_delay,\n        ROUND(CAST(crrm.max_arrival_delay AS NUMERIC), 2) AS max_arrival_delay,\n        ROUND(CAST(crrm.completion_rate AS NUMERIC), 2) AS completion_rate,\n        ROUND(CAST(crrm.on_time_departure_rate AS NUMERIC), 2) AS on_time_departure_rate,\n        ROUND(CAST(crrm.on_time_arrival_rate AS NUMERIC), 2) AS on_time_arrival_rate,\n        -- Moving averages\n        AVG(crrm.completion_rate) OVER (\n            PARTITION BY crrm.carrier_id, crrm.route_id\n            ORDER BY crrm.sailing_month\n            ROWS BETWEEN 2 PRECEDING AND CURRENT ROW\n        ) AS moving_avg_completion_rate_3_month,\n        AVG(crrm.on_time_arrival_rate) OVER (\n            PARTITION BY crrm.carrier_id, crrm.route_id\n            ORDER BY crrm.sailing_month\n            ROWS BETWEEN 2 PRECEDING AND CURRENT ROW\n        ) AS moving_avg_on_time_rate_3_month,\n        AVG(crrm.avg_arrival_delay_hours) OVER (\n            PARTITION BY crrm.carrier_id, crrm.route_id\n            ORDER BY crrm.sailing_month\n            ROWS BETWEEN 2 PRECEDING AND CURRENT ROW\n        ) AS moving_avg_delay_3_month,\n        -- Previous periods for comparison\n        LAG(crrm.completion_rate, 1) OVER (\n            PARTITION BY crrm.carrier_id, crrm.route_id\n            ORDER BY crrm.sailing_month\n        ) AS prev_month_completion_rate,\n        LAG(crrm.on_time_arrival_rate, 1) OVER (\n            PARTITION BY crrm.carrier_id, crrm.route_id\n            ORDER BY crrm.sailing_month\n        ) AS prev_month_on_time_rate,\n        LAG(crrm.avg_arrival_delay_hours, 1) OVER (\n            PARTITION BY crrm.carrier_id, crrm.route_id\n            ORDER BY crrm.sailing_month\n        ) AS prev_month_avg_delay,\n        LAG(crrm.completion_rate, 12) OVER (\n            PARTITION BY crrm.carrier_id, crrm.route_id\n            ORDER BY crrm.sailing_month\n        ) AS prev_year_completion_rate,\n        LAG(crrm.on_time_arrival_rate, 12) OVER (\n            PARTITION BY crrm.carrier_id, crrm.route_id\n            ORDER BY crrm.sailing_month\n        ) AS prev_year_on_time_rate,\n        -- Trend indicators\n        CASE\n            WHEN LAG(crrm.completion_rate, 1) OVER (PARTITION BY crrm.carrier_id, crrm.route_id ORDER BY crrm.sailing_month) IS NOT NULL THEN\n                crrm.completion_rate - LAG(crrm.completion_rate, 1) OVER (PARTITION BY crrm.carrier_id, crrm.route_id ORDER BY crrm.sailing_month)\n            ELSE NULL\n        END AS completion_rate_change,\n        CASE\n            WHEN LAG(crrm.on_time_arrival_rate, 1) OVER (PARTITION BY crrm.carrier_id, crrm.route_id ORDER BY crrm.sailing_month) IS NOT NULL THEN\n                crrm.on_time_arrival_rate - LAG(crrm.on_time_arrival_rate, 1) OVER (PARTITION BY crrm.carrier_id, crrm.route_id ORDER BY crrm.sailing_month)\n            ELSE NULL\n        END AS on_time_rate_change\n    FROM carrier_route_reliability_metrics crrm\n),\nservice_consistency_analysis AS (\n    -- Fourth CTE: Analyze service consistency\n    SELECT\n        rta.carrier_id,\n        rta.carrier_name,\n        rta.route_id,\n        rta.route_name,\n        rta.sailing_month,\n        rta.total_sailings,\n        rta.completed_sailings,\n        rta.on_time_departures,\n        rta.on_time_arrivals,\n        rta.avg_departure_delay_hours,\n        rta.avg_arrival_delay_hours,\n        rta.avg_actual_transit_days,\n        rta.avg_scheduled_transit_days,\n        rta.median_departure_delay,\n        rta.median_arrival_delay,\n        rta.p75_departure_delay,\n        rta.p75_arrival_delay,\n        rta.p90_departure_delay,\n        rta.p90_arrival_delay,\n        rta.stddev_departure_delay,\n        rta.stddev_arrival_delay,\n        rta.min_departure_delay,\n        rta.max_departure_delay,\n        rta.min_arrival_delay,\n        rta.max_arrival_delay,\n        rta.completion_rate,\n        rta.on_time_departure_rate,\n        rta.on_time_arrival_rate,\n        ROUND(CAST(rta.moving_avg_completion_rate_3_month AS NUMERIC), 2) AS moving_avg_completion_rate_3_month,\n        ROUND(CAST(rta.moving_avg_on_time_rate_3_month AS NUMERIC), 2) AS moving_avg_on_time_rate_3_month,\n        ROUND(CAST(rta.moving_avg_delay_3_month AS NUMERIC), 2) AS moving_avg_delay_3_month,\n        rta.prev_month_completion_rate,\n        rta.prev_month_on_time_rate,\n        rta.prev_month_avg_delay,\n        rta.prev_year_completion_rate,\n        rta.prev_year_on_time_rate,\n        ROUND(CAST(rta.completion_rate_change AS NUMERIC), 2) AS completion_rate_change,\n        ROUND(CAST(rta.on_time_rate_change AS NUMERIC), 2) AS on_time_rate_change,\n        -- Consistency metrics (lower stddev = more consistent)\n        CASE\n            WHEN rta.stddev_arrival_delay <= 2 THEN 'Highly Consistent'\n            WHEN rta.stddev_arrival_delay <= 4 THEN 'Consistent'\n            WHEN rta.stddev_arrival_delay <= 6 THEN 'Moderately Consistent'\n            WHEN rta.stddev_arrival_delay <= 8 THEN 'Inconsistent'\n            ELSE 'Highly Inconsistent'\n        END AS consistency_level,\n        -- Trend classification\n        CASE\n            WHEN rta.completion_rate_change IS NOT NULL THEN\n                CASE\n                    WHEN rta.completion_rate_change > 2 THEN 'Improving'\n                    WHEN rta.completion_rate_change > 0 THEN 'Slightly Improving'\n                    WHEN rta.completion_rate_change > -2 THEN 'Stable'\n                    WHEN rta.completion_rate_change > -5 THEN 'Declining'\n                    ELSE 'Sharply Declining'\n                END\n            ELSE 'Unknown'\n        END AS completion_trend,\n        CASE\n            WHEN rta.on_time_rate_change IS NOT NULL THEN\n                CASE\n                    WHEN rta.on_time_rate_change > 2 THEN 'Improving'\n                    WHEN rta.on_time_rate_change > 0 THEN 'Slightly Improving'\n                    WHEN rta.on_time_rate_change > -2 THEN 'Stable'\n                    WHEN rta.on_time_rate_change > -5 THEN 'Declining'\n                    ELSE 'Sharply Declining'\n                END\n            ELSE 'Unknown'\n        END AS on_time_trend,\n        -- Reliability score\n        (\n            -- Completion rate component (40%)\n            (rta.completion_rate / 100.0) * 40 +\n            -- On-time performance component (35%)\n            ((rta.on_time_arrival_rate + rta.on_time_departure_rate) / 200.0) * 35 +\n            -- Consistency component (15%) - inverse of stddev\n            CASE\n                WHEN rta.stddev_arrival_delay IS NOT NULL THEN\n                    GREATEST(0, (1.0 - rta.stddev_arrival_delay / 12.0)) * 15\n                ELSE 0\n            END +\n            -- Delay component (10%) - inverse (lower is better)\n            CASE\n                WHEN rta.avg_arrival_delay_hours IS NOT NULL THEN\n                    GREATEST(0, (1.0 - rta.avg_arrival_delay_hours / 24.0)) * 10\n                ELSE 0\n            END\n        ) AS reliability_score\n    FROM reliability_trend_analysis rta\n),\nreliability_classification AS (\n    -- Fifth CTE: Classify reliability performance\n    SELECT\n        sca.carrier_id,\n        sca.carrier_name,\n        sca.route_id,\n        sca.route_name,\n        sca.sailing_month,\n        sca.total_sailings,\n        sca.completed_sailings,\n        sca.on_time_departures,\n        sca.on_time_arrivals,\n        sca.avg_departure_delay_hours,\n        sca.avg_arrival_delay_hours,\n        sca.avg_actual_transit_days,\n        sca.avg_scheduled_transit_days,\n        sca.median_departure_delay,\n        sca.median_arrival_delay,\n        sca.p75_departure_delay,\n        sca.p75_arrival_delay,\n        sca.p90_departure_delay,\n        sca.p90_arrival_delay,\n        sca.stddev_departure_delay,\n        sca.stddev_arrival_delay,\n        sca.min_departure_delay,\n        sca.max_departure_delay,\n        sca.min_arrival_delay,\n        sca.max_arrival_delay,\n        sca.completion_rate,\n        sca.on_time_departure_rate,\n        sca.on_time_arrival_rate,\n        sca.moving_avg_completion_rate_3_month,\n        sca.moving_avg_on_time_rate_3_month,\n        sca.moving_avg_delay_3_month,\n        sca.prev_month_completion_rate,\n        sca.prev_month_on_time_rate,\n        sca.prev_month_avg_delay,\n        sca.prev_year_completion_rate,\n        sca.prev_year_on_time_rate,\n        sca.completion_rate_change,\n        sca.on_time_rate_change,\n        sca.consistency_level,\n        sca.completion_trend,\n        sca.on_time_trend,\n        ROUND(CAST(sca.reliability_score AS NUMERIC), 2) AS reliability_score,\n        -- Reliability classification\n        CASE\n            WHEN sca.reliability_score >= 90 THEN 'Excellent Reliability'\n            WHEN sca.reliability_score >= 80 THEN 'Good Reliability'\n            WHEN sca.reliability_score >= 70 THEN 'Acceptable Reliability'\n            WHEN sca.reliability_score >= 60 THEN 'Below Average Reliability'\n            ELSE 'Poor Reliability'\n        END AS reliability_class,\n        -- Market comparison\n        AVG(sca.reliability_score) OVER (PARTITION BY sca.route_id) AS route_avg_reliability_score,\n        AVG(sca.reliability_score) OVER () AS market_avg_reliability_score,\n        RANK() OVER (PARTITION BY sca.route_id ORDER BY sca.reliability_score DESC) AS route_reliability_rank,\n        PERCENT_RANK() OVER (PARTITION BY sca.route_id ORDER BY sca.reliability_score) AS route_reliability_percentile\n    FROM service_consistency_analysis sca\n)\nSELECT\n    carrier_id,\n    carrier_name,\n    route_id,\n    route_name,\n    sailing_month,\n    total_sailings,\n    completed_sailings,\n    on_time_departures,\n    on_time_arrivals,\n    avg_departure_delay_hours,\n    avg_arrival_delay_hours,\n    avg_actual_transit_days,\n    avg_scheduled_transit_days,\n    median_departure_delay,\n    median_arrival_delay,\n    p75_departure_delay,\n    p75_arrival_delay,\n    p90_departure_delay,\n    p90_arrival_delay,\n    stddev_departure_delay,\n    stddev_arrival_delay,\n    min_departure_delay,\n    max_departure_delay,\n    min_arrival_delay,\n    max_arrival_delay,\n    completion_rate,\n    on_time_departure_rate,\n    on_time_arrival_rate,\n    moving_avg_completion_rate_3_month,\n    moving_avg_on_time_rate_3_month,\n    moving_avg_delay_3_month,\n    prev_month_completion_rate,\n    prev_month_on_time_rate,\n    prev_month_avg_delay,\n    prev_year_completion_rate,\n    prev_year_on_time_rate,\n    completion_rate_change,\n    on_time_rate_change,\n    consistency_level,\n    completion_trend,\n    on_time_trend,\n    reliability_score,\n    reliability_class,\n    ROUND(CAST(route_avg_reliability_score AS NUMERIC), 2) AS route_avg_reliability_score,\n    ROUND(CAST(market_avg_reliability_score AS NUMERIC), 2) AS market_avg_reliability_score,\n    route_reliability_rank,\n    ROUND(CAST(route_reliability_percentile * 100 AS NUMERIC), 2) AS route_reliability_percentile\nFROM reliability_classification\nORDER BY sailing_month DESC, reliability_score DESC\nLIMIT 1000;",
      "line_number": 4636
    },
    {
      "number": 15,
      "title": "Carrier Market Share Analysis with Route Dominance and Competitive Positioning",
      "description": "Use Case: Market Intelligence - Comprehensive Carrier Market Share Analysis for Competitive Strategy Description: Enterprise-level carrier market share analysis with multi-level CTE nesting, market share calculations, route dominance analysis, competitive positioning, and advanced window functions. Demonstrates production patterns used by shipping lines for market intelligence. Business Value: Carrier market share report showing market share by route, competitive positioning, route dominance, an",
      "complexity": "Deep nested CTEs (7+ levels), market share calculations, route dominance analysis, window functions with multiple frame clauses, percentile calculations, competitive positioning, growth trend analysis",
      "expected_output": "Carrier market share report with market share by route, competitive positioning, and route dominance analysis.",
      "sql": "WITH carrier_route_volume AS (\n    -- First CTE: Aggregate carrier volumes by route\n    SELECT\n        r.carrier_id,\n        c.carrier_name,\n        s.route_id,\n        r.route_name,\n        r.route_type,\n        COUNT(DISTINCT s.sailing_id) AS total_sailings,\n        COUNT(DISTINCT CASE WHEN s.status = 'Completed' THEN s.sailing_id END) AS completed_sailings,\n        SUM(s.total_teu) AS total_teu_carried,\n        AVG(s.total_teu) AS avg_teu_per_sailing,\n        AVG(s.capacity_utilization_percent) AS avg_capacity_utilization,\n        DATE_TRUNC('month', s.scheduled_departure) AS sailing_month,\n        DATE_TRUNC('quarter', s.scheduled_departure) AS sailing_quarter,\n        DATE_TRUNC('year', s.scheduled_departure) AS sailing_year\n    FROM sailings s\n    INNER JOIN routes r ON s.route_id = r.route_id\n    INNER JOIN carriers c ON r.carrier_id = c.carrier_id\n    WHERE s.scheduled_departure >= CURRENT_DATE - INTERVAL '2 years'\n    GROUP BY\n        r.carrier_id,\n        c.carrier_name,\n        s.route_id,\n        r.route_name,\n        r.route_type,\n        DATE_TRUNC('month', s.scheduled_departure),\n        DATE_TRUNC('quarter', s.scheduled_departure),\n        DATE_TRUNC('year', s.scheduled_departure)\n),\nroute_total_volume AS (\n    -- Second CTE: Calculate total volume by route\n    SELECT\n        crv.route_id,\n        crv.route_name,\n        crv.route_type,\n        crv.sailing_month,\n        crv.sailing_quarter,\n        crv.sailing_year,\n        SUM(crv.total_teu_carried) AS route_total_teu,\n        SUM(crv.total_sailings) AS route_total_sailings,\n        COUNT(DISTINCT crv.carrier_id) AS route_unique_carriers\n    FROM carrier_route_volume crv\n    GROUP BY\n        crv.route_id,\n        crv.route_name,\n        crv.route_type,\n        crv.sailing_month,\n        crv.sailing_quarter,\n        crv.sailing_year\n),\ncarrier_market_share_calculation AS (\n    -- Third CTE: Calculate market share\n    SELECT\n        crv.carrier_id,\n        crv.carrier_name,\n        crv.route_id,\n        crv.route_name,\n        crv.route_type,\n        crv.sailing_month,\n        crv.sailing_quarter,\n        crv.sailing_year,\n        crv.total_sailings,\n        crv.completed_sailings,\n        ROUND(CAST(crv.total_teu_carried AS NUMERIC), 2) AS total_teu_carried,\n        ROUND(CAST(crv.avg_teu_per_sailing AS NUMERIC), 2) AS avg_teu_per_sailing,\n        ROUND(CAST(crv.avg_capacity_utilization AS NUMERIC), 2) AS avg_capacity_utilization,\n        rtv.route_total_teu,\n        rtv.route_total_sailings,\n        rtv.route_unique_carriers,\n        -- Market share by TEU\n        CASE\n            WHEN rtv.route_total_teu > 0 THEN\n                ROUND(CAST((crv.total_teu_carried::NUMERIC / rtv.route_total_teu::NUMERIC) * 100 AS NUMERIC), 2)\n            ELSE 0\n        END AS market_share_teu_percent,\n        -- Market share by sailings\n        CASE\n            WHEN rtv.route_total_sailings > 0 THEN\n                ROUND(CAST((crv.total_sailings::NUMERIC / rtv.route_total_sailings::NUMERIC) * 100 AS NUMERIC), 2)\n            ELSE 0\n        END AS market_share_sailings_percent\n    FROM carrier_route_volume crv\n    INNER JOIN route_total_volume rtv ON\n        crv.route_id = rtv.route_id\n        AND crv.sailing_month = rtv.sailing_month\n),\ncarrier_route_rankings AS (\n    -- Fourth CTE: Calculate rankings and competitive position\n    SELECT\n        cmsc.carrier_id,\n        cmsc.carrier_name,\n        cmsc.route_id,\n        cmsc.route_name,\n        cmsc.route_type,\n        cmsc.sailing_month,\n        cmsc.sailing_quarter,\n        cmsc.sailing_year,\n        cmsc.total_sailings,\n        cmsc.completed_sailings,\n        cmsc.total_teu_carried,\n        cmsc.avg_teu_per_sailing,\n        cmsc.avg_capacity_utilization,\n        cmsc.route_total_teu,\n        cmsc.route_total_sailings,\n        cmsc.route_unique_carriers,\n        cmsc.market_share_teu_percent,\n        cmsc.market_share_sailings_percent,\n        -- Rankings within route\n        RANK() OVER (\n            PARTITION BY cmsc.route_id, cmsc.sailing_month\n            ORDER BY cmsc.total_teu_carried DESC\n        ) AS route_rank_by_teu,\n        RANK() OVER (\n            PARTITION BY cmsc.route_id, cmsc.sailing_month\n            ORDER BY cmsc.total_sailings DESC\n        ) AS route_rank_by_sailings,\n        RANK() OVER (\n            PARTITION BY cmsc.route_id, cmsc.sailing_month\n            ORDER BY cmsc.market_share_teu_percent DESC\n        ) AS route_rank_by_market_share,\n        -- Percentile rankings\n        PERCENT_RANK() OVER (\n            PARTITION BY cmsc.route_id, cmsc.sailing_month\n            ORDER BY cmsc.market_share_teu_percent\n        ) AS route_market_share_percentile,\n        -- Market concentration (HHI calculation component)\n        POWER(cmsc.market_share_teu_percent / 100.0, 2) AS hhi_component\n    FROM carrier_market_share_calculation cmsc\n),\nroute_market_concentration AS (\n    -- Fifth CTE: Calculate market concentration metrics\n    SELECT\n        crr.route_id,\n        crr.route_name,\n        crr.route_type,\n        crr.sailing_month,\n        crr.sailing_quarter,\n        crr.sailing_year,\n        crr.route_total_teu,\n        crr.route_total_sailings,\n        crr.route_unique_carriers,\n        -- Herfindahl-Hirschman Index (HHI) - sum of squared market shares\n        SUM(crr.hhi_component) * 10000 AS hhi_index,\n        -- Market concentration classification\n        CASE\n            WHEN SUM(crr.hhi_component) * 10000 >= 2500 THEN 'Highly Concentrated'\n            WHEN SUM(crr.hhi_component) * 10000 >= 1500 THEN 'Moderately Concentrated'\n            WHEN SUM(crr.hhi_component) * 10000 >= 1000 THEN 'Moderately Competitive'\n            ELSE 'Competitive'\n        END AS market_concentration_level,\n        -- Top carrier market share\n        MAX(crr.market_share_teu_percent) AS top_carrier_market_share,\n        -- Top 3 carriers combined market share\n        SUM(CASE WHEN crr.route_rank_by_market_share <= 3 THEN crr.market_share_teu_percent ELSE 0 END) AS top3_carriers_market_share,\n        -- Top 5 carriers combined market share\n        SUM(CASE WHEN crr.route_rank_by_market_share <= 5 THEN crr.market_share_teu_percent ELSE 0 END) AS top5_carriers_market_share\n    FROM carrier_route_rankings crr\n    GROUP BY\n        crr.route_id,\n        crr.route_name,\n        crr.route_type,\n        crr.sailing_month,\n        crr.sailing_quarter,\n        crr.sailing_year,\n        crr.route_total_teu,\n        crr.route_total_sailings,\n        crr.route_unique_carriers\n),\ncarrier_route_dominance AS (\n    -- Sixth CTE: Identify route dominance\n    SELECT\n        crr.carrier_id,\n        crr.carrier_name,\n        crr.route_id,\n        crr.route_name,\n        crr.route_type,\n        crr.sailing_month,\n        crr.sailing_quarter,\n        crr.sailing_year,\n        crr.total_sailings,\n        crr.completed_sailings,\n        crr.total_teu_carried,\n        crr.avg_teu_per_sailing,\n        crr.avg_capacity_utilization,\n        crr.route_total_teu,\n        crr.route_total_sailings,\n        crr.route_unique_carriers,\n        crr.market_share_teu_percent,\n        crr.market_share_sailings_percent,\n        crr.route_rank_by_teu,\n        crr.route_rank_by_sailings,\n        crr.route_rank_by_market_share,\n        ROUND(CAST(crr.route_market_share_percentile * 100 AS NUMERIC), 2) AS route_market_share_percentile,\n        rmc.hhi_index,\n        rmc.market_concentration_level,\n        rmc.top_carrier_market_share,\n        rmc.top3_carriers_market_share,\n        rmc.top5_carriers_market_share,\n        -- Route dominance classification\n        CASE\n            WHEN crr.market_share_teu_percent >= 50 THEN 'Market Leader'\n            WHEN crr.market_share_teu_percent >= 30 THEN 'Strong Position'\n            WHEN crr.market_share_teu_percent >= 15 THEN 'Significant Player'\n            WHEN crr.market_share_teu_percent >= 5 THEN 'Minor Player'\n            ELSE 'Marginal Player'\n        END AS route_dominance_class,\n        -- Competitive position\n        CASE\n            WHEN crr.route_rank_by_market_share = 1 THEN 'Market Leader'\n            WHEN crr.route_rank_by_market_share <= 3 THEN 'Top 3'\n            WHEN crr.route_rank_by_market_share <= 5 THEN 'Top 5'\n            WHEN crr.route_rank_by_market_share <= crr.route_unique_carriers * 0.5 THEN 'Mid-Tier'\n            ELSE 'Bottom Tier'\n        END AS competitive_position,\n        -- Previous period market share for trend\n        LAG(crr.market_share_teu_percent, 1) OVER (\n            PARTITION BY crr.carrier_id, crr.route_id\n            ORDER BY crr.sailing_month\n        ) AS prev_month_market_share,\n        LAG(crr.market_share_teu_percent, 12) OVER (\n            PARTITION BY crr.carrier_id, crr.route_id\n            ORDER BY crr.sailing_month\n        ) AS prev_year_market_share\n    FROM carrier_route_rankings crr\n    INNER JOIN route_market_concentration rmc ON\n        crr.route_id = rmc.route_id\n        AND crr.sailing_month = rmc.sailing_month\n),\ncarrier_market_trends AS (\n    -- Seventh CTE: Analyze market trends\n    SELECT\n        crd.carrier_id,\n        crd.carrier_name,\n        crd.route_id,\n        crd.route_name,\n        crd.route_type,\n        crd.sailing_month,\n        crd.sailing_quarter,\n        crd.sailing_year,\n        crd.total_sailings,\n        crd.completed_sailings,\n        crd.total_teu_carried,\n        crd.avg_teu_per_sailing,\n        crd.avg_capacity_utilization,\n        crd.route_total_teu,\n        crd.route_total_sailings,\n        crd.route_unique_carriers,\n        crd.market_share_teu_percent,\n        crd.market_share_sailings_percent,\n        crd.route_rank_by_teu,\n        crd.route_rank_by_sailings,\n        crd.route_rank_by_market_share,\n        crd.route_market_share_percentile,\n        crd.hhi_index,\n        crd.market_concentration_level,\n        crd.top_carrier_market_share,\n        crd.top3_carriers_market_share,\n        crd.top5_carriers_market_share,\n        crd.route_dominance_class,\n        crd.competitive_position,\n        crd.prev_month_market_share,\n        crd.prev_year_market_share,\n        -- Market share change\n        CASE\n            WHEN crd.prev_month_market_share IS NOT NULL THEN\n                crd.market_share_teu_percent - crd.prev_month_market_share\n            ELSE NULL\n        END AS month_over_month_change,\n        CASE\n            WHEN crd.prev_year_market_share IS NOT NULL THEN\n                crd.market_share_teu_percent - crd.prev_year_market_share\n            ELSE NULL\n        END AS year_over_year_change,\n        -- Market share trend\n        CASE\n            WHEN crd.prev_month_market_share IS NOT NULL THEN\n                CASE\n                    WHEN crd.market_share_teu_percent > crd.prev_month_market_share * 1.05 THEN 'Rapid Growth'\n                    WHEN crd.market_share_teu_percent > crd.prev_month_market_share * 1.02 THEN 'Growing'\n                    WHEN crd.market_share_teu_percent > crd.prev_month_market_share * 0.98 THEN 'Stable'\n                    WHEN crd.market_share_teu_percent > crd.prev_month_market_share * 0.95 THEN 'Declining'\n                    ELSE 'Rapid Decline'\n                END\n            ELSE 'Unknown'\n        END AS market_share_trend,\n        -- Moving average market share\n        AVG(crd.market_share_teu_percent) OVER (\n            PARTITION BY crd.carrier_id, crd.route_id\n            ORDER BY crd.sailing_month\n            ROWS BETWEEN 2 PRECEDING AND CURRENT ROW\n        ) AS moving_avg_market_share_3_month\n    FROM carrier_route_dominance crd\n)\nSELECT\n    carrier_id,\n    carrier_name,\n    route_id,\n    route_name,\n    route_type,\n    sailing_month,\n    sailing_quarter,\n    sailing_year,\n    total_sailings,\n    completed_sailings,\n    total_teu_carried,\n    avg_teu_per_sailing,\n    avg_capacity_utilization,\n    route_total_teu,\n    route_total_sailings,\n    route_unique_carriers,\n    market_share_teu_percent,\n    market_share_sailings_percent,\n    route_rank_by_teu,\n    route_rank_by_sailings,\n    route_rank_by_market_share,\n    route_market_share_percentile,\n    hhi_index,\n    market_concentration_level,\n    top_carrier_market_share,\n    top3_carriers_market_share,\n    top5_carriers_market_share,\n    route_dominance_class,\n    competitive_position,\n    prev_month_market_share,\n    prev_year_market_share,\n    ROUND(CAST(month_over_month_change AS NUMERIC), 2) AS month_over_month_change,\n    ROUND(CAST(year_over_year_change AS NUMERIC), 2) AS year_over_year_change,\n    market_share_trend,\n    ROUND(CAST(moving_avg_market_share_3_month AS NUMERIC), 2) AS moving_avg_market_share_3_month\nFROM carrier_market_trends\nORDER BY sailing_month DESC, market_share_teu_percent DESC\nLIMIT 2000;",
      "line_number": 5073
    },
    {
      "number": 16,
      "title": "Vessel Route Efficiency Analysis with Fuel Optimization and Transit Time Benchmarking",
      "description": "Use Case: Fleet Optimization - Comprehensive Vessel Route Efficiency Analysis for Fuel Optimization Description: Enterprise-level vessel route efficiency analysis with multi-level CTE nesting, efficiency calculations, fuel optimization metrics, transit time benchmarking, distance analysis, and advanced spatial operations. Demonstrates production patterns used by shipping lines for route optimization. Business Value: Vessel route efficiency report showing efficiency metrics, fuel consumption patt",
      "complexity": "Deep nested CTEs (7+ levels), efficiency calculations, fuel optimization analysis, spatial operations (ST_DISTANCE), window functions with multiple frame clauses, percentile calculations, transit time benchmarking, distance analysis",
      "expected_output": "Vessel route efficiency report with efficiency metrics, fuel optimization, and transit time benchmarking.",
      "sql": "WITH vessel_route_sailing_metrics AS (\n    -- First CTE: Aggregate sailing metrics by vessel and route\n    SELECT\n        s.sailing_id,\n        s.vessel_id,\n        ve.vessel_name,\n        ve.imo_number,\n        ve.vessel_type,\n        ve.container_capacity_teu,\n        ve.max_speed_knots,\n        r.carrier_id,\n        c.carrier_name,\n        s.route_id,\n        r.route_name,\n        r.route_type,\n        s.origin_port_id,\n        op.port_name AS origin_port_name,\n        op.port_code AS origin_port_code,\n        op.port_geom AS origin_port_geom,\n        s.destination_port_id,\n        dp.port_name AS destination_port_name,\n        dp.port_code AS destination_port_code,\n        dp.port_geom AS destination_port_geom,\n        s.status AS sailing_status,\n        s.scheduled_departure,\n        s.actual_departure,\n        s.scheduled_arrival,\n        s.actual_arrival,\n        s.total_teu,\n        s.capacity_utilization_percent,\n        s.transit_days,\n        s.distance_nautical_miles,\n        -- Calculate great circle distance\n        CASE\n            WHEN op.port_geom IS NOT NULL AND dp.port_geom IS NOT NULL THEN\n                ST_DISTANCE(op.port_geom, dp.port_geom) / 1852.0\n            ELSE s.distance_nautical_miles\n        END AS great_circle_distance_nm,\n        -- Actual transit time (days)\n        CASE\n            WHEN s.actual_departure IS NOT NULL AND s.actual_arrival IS NOT NULL THEN\n                EXTRACT(EPOCH FROM (s.actual_arrival - s.actual_departure)) / 24.0\n            ELSE NULL\n        END AS actual_transit_days,\n        -- Scheduled transit time (days)\n        CASE\n            WHEN s.scheduled_departure IS NOT NULL AND s.scheduled_arrival IS NOT NULL THEN\n                EXTRACT(EPOCH FROM (s.scheduled_arrival - s.scheduled_departure)) / 24.0\n            ELSE NULL\n        END AS scheduled_transit_days,\n        -- Average speed (knots)\n        CASE\n            WHEN s.actual_departure IS NOT NULL AND s.actual_arrival IS NOT NULL \n                AND EXTRACT(EPOCH FROM (s.actual_arrival - s.actual_departure)) > 0 THEN\n                s.distance_nautical_miles / (EXTRACT(EPOCH FROM (s.actual_arrival - s.actual_departure)) / 24.0)\n            ELSE NULL\n        END AS avg_speed_knots,\n        DATE_TRUNC('month', s.scheduled_departure) AS sailing_month\n    FROM sailings s\n    INNER JOIN vessels ve ON s.vessel_id = ve.vessel_id\n    INNER JOIN routes r ON s.route_id = r.route_id\n    LEFT JOIN carriers c ON r.carrier_id = c.carrier_id\n    LEFT JOIN ports op ON s.origin_port_id = op.port_id\n    LEFT JOIN ports dp ON s.destination_port_id = dp.port_id\n    WHERE s.scheduled_departure >= CURRENT_DATE - INTERVAL '2 years'\n        AND s.status = 'Completed'\n),\nroute_efficiency_benchmarks AS (\n    -- Second CTE: Calculate route efficiency benchmarks\n    SELECT\n        vrsm.route_id,\n        vrsm.route_name,\n        vrsm.origin_port_id,\n        vrsm.origin_port_code,\n        vrsm.destination_port_id,\n        vrsm.destination_port_code,\n        vrsm.sailing_month,\n        COUNT(DISTINCT vrsm.sailing_id) AS route_sailings,\n        AVG(vrsm.great_circle_distance_nm) AS route_avg_distance_nm,\n        AVG(vrsm.actual_transit_days) AS route_avg_transit_days,\n        AVG(vrsm.avg_speed_knots) AS route_avg_speed_knots,\n        PERCENTILE_CONT(0.5) WITHIN GROUP (ORDER BY vrsm.actual_transit_days) AS route_median_transit_days,\n        PERCENTILE_CONT(0.25) WITHIN GROUP (ORDER BY vrsm.actual_transit_days) AS route_q1_transit_days,\n        PERCENTILE_CONT(0.75) WITHIN GROUP (ORDER BY vrsm.actual_transit_days) AS route_q3_transit_days,\n        MIN(vrsm.actual_transit_days) AS route_best_transit_days,\n        MAX(vrsm.actual_transit_days) AS route_worst_transit_days,\n        STDDEV(vrsm.actual_transit_days) AS route_stddev_transit_days,\n        AVG(vrsm.capacity_utilization_percent) AS route_avg_capacity_utilization,\n        -- Route efficiency score (distance / transit time)\n        AVG(vrsm.great_circle_distance_nm / NULLIF(vrsm.actual_transit_days, 0)) AS route_avg_distance_per_day\n    FROM vessel_route_sailing_metrics vrsm\n    GROUP BY\n        vrsm.route_id,\n        vrsm.route_name,\n        vrsm.origin_port_id,\n        vrsm.origin_port_code,\n        vrsm.destination_port_id,\n        vrsm.destination_port_code,\n        vrsm.sailing_month\n),\nvessel_route_efficiency_analysis AS (\n    -- Third CTE: Analyze vessel route efficiency\n    SELECT\n        vrsm.sailing_id,\n        vrsm.vessel_id,\n        vrsm.vessel_name,\n        vrsm.imo_number,\n        vrsm.vessel_type,\n        vrsm.container_capacity_teu,\n        vrsm.max_speed_knots,\n        vrsm.carrier_id,\n        vrsm.carrier_name,\n        vrsm.route_id,\n        vrsm.route_name,\n        vrsm.route_type,\n        vrsm.origin_port_id,\n        vrsm.origin_port_code,\n        vrsm.destination_port_id,\n        vrsm.destination_port_code,\n        vrsm.sailing_status,\n        vrsm.scheduled_departure,\n        vrsm.actual_departure,\n        vrsm.scheduled_arrival,\n        vrsm.actual_arrival,\n        vrsm.total_teu,\n        vrsm.capacity_utilization_percent,\n        vrsm.transit_days,\n        ROUND(CAST(vrsm.distance_nautical_miles AS NUMERIC), 2) AS distance_nautical_miles,\n        ROUND(CAST(vrsm.great_circle_distance_nm AS NUMERIC), 2) AS great_circle_distance_nm,\n        ROUND(CAST(vrsm.actual_transit_days AS NUMERIC), 2) AS actual_transit_days,\n        ROUND(CAST(vrsm.scheduled_transit_days AS NUMERIC), 2) AS scheduled_transit_days,\n        ROUND(CAST(vrsm.avg_speed_knots AS NUMERIC), 2) AS avg_speed_knots,\n        vrsm.sailing_month,\n        reb.route_sailings,\n        ROUND(CAST(reb.route_avg_distance_nm AS NUMERIC), 2) AS route_avg_distance_nm,\n        ROUND(CAST(reb.route_avg_transit_days AS NUMERIC), 2) AS route_avg_transit_days,\n        ROUND(CAST(reb.route_avg_speed_knots AS NUMERIC), 2) AS route_avg_speed_knots,\n        ROUND(CAST(reb.route_median_transit_days AS NUMERIC), 2) AS route_median_transit_days,\n        ROUND(CAST(reb.route_q1_transit_days AS NUMERIC), 2) AS route_q1_transit_days,\n        ROUND(CAST(reb.route_q3_transit_days AS NUMERIC), 2) AS route_q3_transit_days,\n        ROUND(CAST(reb.route_best_transit_days AS NUMERIC), 2) AS route_best_transit_days,\n        ROUND(CAST(reb.route_worst_transit_days AS NUMERIC), 2) AS route_worst_transit_days,\n        ROUND(CAST(reb.route_stddev_transit_days AS NUMERIC), 2) AS route_stddev_transit_days,\n        ROUND(CAST(reb.route_avg_capacity_utilization AS NUMERIC), 2) AS route_avg_capacity_utilization,\n        ROUND(CAST(reb.route_avg_distance_per_day AS NUMERIC), 2) AS route_avg_distance_per_day,\n        -- Efficiency metrics\n        CASE\n            WHEN vrsm.actual_transit_days > 0 THEN\n                ROUND(CAST((vrsm.great_circle_distance_nm / vrsm.actual_transit_days) AS NUMERIC), 2)\n            ELSE NULL\n        END AS distance_per_day_nm,\n        -- Transit time efficiency (vs route benchmark)\n        CASE\n            WHEN reb.route_avg_transit_days > 0 THEN\n                ROUND(CAST(((reb.route_avg_transit_days - vrsm.actual_transit_days) / reb.route_avg_transit_days) * 100 AS NUMERIC), 2)\n            ELSE NULL\n        END AS transit_time_efficiency_percent,\n        -- Speed efficiency (vs vessel max speed)\n        CASE\n            WHEN vrsm.max_speed_knots > 0 THEN\n                ROUND(CAST((vrsm.avg_speed_knots / vrsm.max_speed_knots) * 100 AS NUMERIC), 2)\n            ELSE NULL\n        END AS speed_utilization_percent,\n        -- Route deviation (actual distance vs great circle)\n        CASE\n            WHEN vrsm.great_circle_distance_nm > 0 THEN\n                ROUND(CAST(((vrsm.distance_nautical_miles - vrsm.great_circle_distance_nm) / vrsm.great_circle_distance_nm) * 100 AS NUMERIC), 2)\n            ELSE NULL\n        END AS route_deviation_percent\n    FROM vessel_route_sailing_metrics vrsm\n    INNER JOIN route_efficiency_benchmarks reb ON\n        vrsm.route_id = reb.route_id\n        AND vrsm.origin_port_id = reb.origin_port_id\n        AND vrsm.destination_port_id = reb.destination_port_id\n        AND vrsm.sailing_month = reb.sailing_month\n),\nfuel_optimization_analysis AS (\n    -- Fourth CTE: Analyze fuel optimization opportunities\n    SELECT\n        vrea.sailing_id,\n        vrea.vessel_id,\n        vrea.vessel_name,\n        vrea.imo_number,\n        vrea.vessel_type,\n        vrea.container_capacity_teu,\n        vrea.max_speed_knots,\n        vrea.carrier_id,\n        vrea.carrier_name,\n        vrea.route_id,\n        vrea.route_name,\n        vrea.route_type,\n        vrea.origin_port_id,\n        vrea.origin_port_code,\n        vrea.destination_port_id,\n        vrea.destination_port_code,\n        vrea.sailing_status,\n        vrea.scheduled_departure,\n        vrea.actual_departure,\n        vrea.scheduled_arrival,\n        vrea.actual_arrival,\n        vrea.total_teu,\n        vrea.capacity_utilization_percent,\n        vrea.transit_days,\n        vrea.distance_nautical_miles,\n        vrea.great_circle_distance_nm,\n        vrea.actual_transit_days,\n        vrea.scheduled_transit_days,\n        vrea.avg_speed_knots,\n        vrea.sailing_month,\n        vrea.route_sailings,\n        vrea.route_avg_distance_nm,\n        vrea.route_avg_transit_days,\n        vrea.route_avg_speed_knots,\n        vrea.route_median_transit_days,\n        vrea.route_q1_transit_days,\n        vrea.route_q3_transit_days,\n        vrea.route_best_transit_days,\n        vrea.route_worst_transit_days,\n        vrea.route_stddev_transit_days,\n        vrea.route_avg_capacity_utilization,\n        vrea.route_avg_distance_per_day,\n        vrea.distance_per_day_nm,\n        vrea.transit_time_efficiency_percent,\n        vrea.speed_utilization_percent,\n        vrea.route_deviation_percent,\n        -- Fuel efficiency indicators (simplified - based on speed and distance)\n        -- Higher speed = higher fuel consumption (cubic relationship)\n        CASE\n            WHEN vrea.avg_speed_knots IS NOT NULL THEN\n                -- Estimated fuel consumption factor (speed^3 * distance)\n                ROUND(CAST(POWER(vrea.avg_speed_knots / 20.0, 3) * vrea.distance_nautical_miles AS NUMERIC), 2)\n            ELSE NULL\n        END AS estimated_fuel_factor,\n        -- Speed optimization opportunity\n        CASE\n            WHEN vrea.avg_speed_knots > vrea.route_avg_speed_knots * 1.1 THEN 'Speed Too High - Fuel Waste'\n            WHEN vrea.avg_speed_knots < vrea.route_avg_speed_knots * 0.9 THEN 'Speed Too Low - Time Waste'\n            ELSE 'Optimal Speed'\n        END AS speed_optimization_status,\n        -- Route optimization opportunity\n        CASE\n            WHEN vrea.route_deviation_percent > 10 THEN 'Route Deviation High - Consider Optimization'\n            WHEN vrea.route_deviation_percent > 5 THEN 'Moderate Route Deviation'\n            ELSE 'Efficient Route'\n        END AS route_optimization_status,\n        -- Transit time efficiency classification\n        CASE\n            WHEN vrea.transit_time_efficiency_percent > 10 THEN 'Faster Than Average'\n            WHEN vrea.transit_time_efficiency_percent > 0 THEN 'Slightly Faster'\n            WHEN vrea.transit_time_efficiency_percent > -5 THEN 'Average'\n            WHEN vrea.transit_time_efficiency_percent > -10 THEN 'Slower Than Average'\n            ELSE 'Much Slower'\n        END AS transit_time_efficiency_class\n    FROM vessel_route_efficiency_analysis vrea\n),\nvessel_efficiency_scoring AS (\n    -- Fifth CTE: Calculate overall efficiency scores\n    SELECT\n        foa.sailing_id,\n        foa.vessel_id,\n        foa.vessel_name,\n        foa.imo_number,\n        foa.vessel_type,\n        foa.container_capacity_teu,\n        foa.max_speed_knots,\n        foa.carrier_id,\n        foa.carrier_name,\n        foa.route_id,\n        foa.route_name,\n        foa.route_type,\n        foa.origin_port_id,\n        foa.origin_port_code,\n        foa.destination_port_id,\n        foa.destination_port_code,\n        foa.sailing_status,\n        foa.scheduled_departure,\n        foa.actual_departure,\n        foa.scheduled_arrival,\n        foa.actual_arrival,\n        foa.total_teu,\n        foa.capacity_utilization_percent,\n        foa.transit_days,\n        foa.distance_nautical_miles,\n        foa.great_circle_distance_nm,\n        foa.actual_transit_days,\n        foa.scheduled_transit_days,\n        foa.avg_speed_knots,\n        foa.sailing_month,\n        foa.route_sailings,\n        foa.route_avg_distance_nm,\n        foa.route_avg_transit_days,\n        foa.route_avg_speed_knots,\n        foa.route_median_transit_days,\n        foa.route_q1_transit_days,\n        foa.route_q3_transit_days,\n        foa.route_best_transit_days,\n        foa.route_worst_transit_days,\n        foa.route_stddev_transit_days,\n        foa.route_avg_capacity_utilization,\n        foa.route_avg_distance_per_day,\n        foa.distance_per_day_nm,\n        foa.transit_time_efficiency_percent,\n        foa.speed_utilization_percent,\n        foa.route_deviation_percent,\n        foa.estimated_fuel_factor,\n        foa.speed_optimization_status,\n        foa.route_optimization_status,\n        foa.transit_time_efficiency_class,\n        -- Overall efficiency score\n        (\n            -- Transit time efficiency component (35%)\n            CASE\n                WHEN foa.transit_time_efficiency_percent IS NOT NULL THEN\n                    GREATEST(0, LEAST(1.0, (foa.transit_time_efficiency_percent + 20) / 40.0)) * 35\n                ELSE 0\n            END +\n            -- Speed utilization component (25%)\n            CASE\n                WHEN foa.speed_utilization_percent IS NOT NULL THEN\n                    (foa.speed_utilization_percent / 100.0) * 25\n                ELSE 0\n            END +\n            -- Route efficiency component (25%) - inverse of deviation\n            CASE\n                WHEN foa.route_deviation_percent IS NOT NULL THEN\n                    GREATEST(0, (1.0 - ABS(foa.route_deviation_percent) / 20.0)) * 25\n                ELSE 0\n            END +\n            -- Capacity utilization component (15%)\n            (foa.capacity_utilization_percent / 100.0) * 15\n        ) AS efficiency_score,\n        -- Fuel efficiency score (inverse of fuel factor)\n        CASE\n            WHEN foa.estimated_fuel_factor IS NOT NULL THEN\n                GREATEST(0, (1.0 - (foa.estimated_fuel_factor - MIN(foa.estimated_fuel_factor) OVER (PARTITION BY foa.route_id)) / \n                    NULLIF(MAX(foa.estimated_fuel_factor) OVER (PARTITION BY foa.route_id) - MIN(foa.estimated_fuel_factor) OVER (PARTITION BY foa.route_id), 0)))\n            ELSE NULL\n        END AS fuel_efficiency_score\n    FROM fuel_optimization_analysis foa\n),\nefficiency_classification AS (\n    -- Sixth CTE: Classify efficiency performance\n    SELECT\n        ves.sailing_id,\n        ves.vessel_id,\n        ves.vessel_name,\n        ves.imo_number,\n        ves.vessel_type,\n        ves.container_capacity_teu,\n        ves.max_speed_knots,\n        ves.carrier_id,\n        ves.carrier_name,\n        ves.route_id,\n        ves.route_name,\n        ves.route_type,\n        ves.origin_port_id,\n        ves.origin_port_code,\n        ves.destination_port_id,\n        ves.destination_port_code,\n        ves.sailing_status,\n        ves.scheduled_departure,\n        ves.actual_departure,\n        ves.scheduled_arrival,\n        ves.actual_arrival,\n        ves.total_teu,\n        ves.capacity_utilization_percent,\n        ves.transit_days,\n        ves.distance_nautical_miles,\n        ves.great_circle_distance_nm,\n        ves.actual_transit_days,\n        ves.scheduled_transit_days,\n        ves.avg_speed_knots,\n        ves.sailing_month,\n        ves.route_sailings,\n        ves.route_avg_distance_nm,\n        ves.route_avg_transit_days,\n        ves.route_avg_speed_knots,\n        ves.route_median_transit_days,\n        ves.route_q1_transit_days,\n        ves.route_q3_transit_days,\n        ves.route_best_transit_days,\n        ves.route_worst_transit_days,\n        ves.route_stddev_transit_days,\n        ves.route_avg_capacity_utilization,\n        ves.route_avg_distance_per_day,\n        ves.distance_per_day_nm,\n        ves.transit_time_efficiency_percent,\n        ves.speed_utilization_percent,\n        ves.route_deviation_percent,\n        ves.estimated_fuel_factor,\n        ves.speed_optimization_status,\n        ves.route_optimization_status,\n        ves.transit_time_efficiency_class,\n        ROUND(CAST(ves.efficiency_score AS NUMERIC), 2) AS efficiency_score,\n        ROUND(CAST(ves.fuel_efficiency_score AS NUMERIC), 2) AS fuel_efficiency_score,\n        -- Efficiency classification\n        CASE\n            WHEN ves.efficiency_score >= 85 THEN 'Highly Efficient'\n            WHEN ves.efficiency_score >= 75 THEN 'Efficient'\n            WHEN ves.efficiency_score >= 65 THEN 'Moderately Efficient'\n            WHEN ves.efficiency_score >= 55 THEN 'Less Efficient'\n            ELSE 'Inefficient'\n        END AS efficiency_class,\n        -- Rankings\n        RANK() OVER (PARTITION BY ves.route_id ORDER BY ves.efficiency_score DESC) AS route_efficiency_rank,\n        PERCENT_RANK() OVER (PARTITION BY ves.route_id ORDER BY ves.efficiency_score) AS route_efficiency_percentile\n    FROM vessel_efficiency_scoring ves\n)\nSELECT\n    sailing_id,\n    vessel_id,\n    vessel_name,\n    imo_number,\n    vessel_type,\n    container_capacity_teu,\n    max_speed_knots,\n    carrier_id,\n    carrier_name,\n    route_id,\n    route_name,\n    route_type,\n    origin_port_id,\n    origin_port_code,\n    destination_port_id,\n    destination_port_code,\n    sailing_status,\n    scheduled_departure,\n    actual_departure,\n    scheduled_arrival,\n    actual_arrival,\n    total_teu,\n    capacity_utilization_percent,\n    transit_days,\n    distance_nautical_miles,\n    great_circle_distance_nm,\n    actual_transit_days,\n    scheduled_transit_days,\n    avg_speed_knots,\n    sailing_month,\n    route_sailings,\n    route_avg_distance_nm,\n    route_avg_transit_days,\n    route_avg_speed_knots,\n    route_median_transit_days,\n    route_q1_transit_days,\n    route_q3_transit_days,\n    route_best_transit_days,\n    route_worst_transit_days,\n    route_stddev_transit_days,\n    route_avg_capacity_utilization,\n    route_avg_distance_per_day,\n    distance_per_day_nm,\n    transit_time_efficiency_percent,\n    speed_utilization_percent,\n    route_deviation_percent,\n    estimated_fuel_factor,\n    speed_optimization_status,\n    route_optimization_status,\n    transit_time_efficiency_class,\n    efficiency_score,\n    fuel_efficiency_score,\n    efficiency_class,\n    route_efficiency_rank,\n    ROUND(CAST(route_efficiency_percentile * 100 AS NUMERIC), 2) AS route_efficiency_percentile\nFROM efficiency_classification\nORDER BY sailing_month DESC, efficiency_score DESC\nLIMIT 2000;",
      "line_number": 5427
    },
    {
      "number": 17,
      "title": "Port Call Sequence Optimization with Multi-Port Voyage Planning and Dwell Time Minimization",
      "description": "Use Case: Voyage Planning - Comprehensive Port Call Sequence Optimization for Multi-Port Voyage Efficiency Description: Enterprise-level port call sequence analysis with multi-level CTE nesting, sequence optimization, dwell time minimization, voyage planning, and advanced recursive CTEs. Demonstrates production patterns used by shipping lines for voyage optimization. Business Value: Port call sequence report showing optimal port call orders, dwell time minimization, voyage efficiency, and planni",
      "complexity": "Deep nested CTEs (7+ levels), recursive CTEs for sequence optimization, spatial distance calculations, temporal analysis, window functions with multiple frame clauses, optimization algorithms",
      "expected_output": "Port call sequence report with optimal sequences, dwell time analysis, and voyage efficiency recommendations.",
      "sql": "WITH voyage_port_call_sequence AS (\n    -- First CTE: Extract port call sequences from voyages\n    SELECT\n        v.voyage_id,\n        v.voyage_number,\n        v.vessel_id,\n        ve.vessel_name,\n        v.route_id,\n        r.route_name,\n        vpc.voyage_port_call_id,\n        vpc.port_call_id,\n        pc.port_id,\n        p.port_name,\n        p.port_code,\n        p.locode,\n        p.port_geom,\n        vpc.port_sequence,\n        pc.scheduled_arrival,\n        pc.actual_arrival,\n        pc.scheduled_departure,\n        pc.actual_departure,\n        -- Calculate dwell time\n        CASE\n            WHEN pc.actual_arrival IS NOT NULL AND pc.actual_departure IS NOT NULL THEN\n                EXTRACT(EPOCH FROM (pc.actual_departure - pc.actual_arrival)) / 3600.0\n            ELSE NULL\n        END AS dwell_time_hours,\n        -- Calculate delays\n        CASE\n            WHEN pc.actual_arrival IS NOT NULL AND pc.scheduled_arrival IS NOT NULL THEN\n                EXTRACT(EPOCH FROM (pc.actual_arrival - pc.scheduled_arrival)) / 3600.0\n            ELSE NULL\n        END AS arrival_delay_hours\n    FROM voyages v\n    INNER JOIN vessels ve ON v.vessel_id = ve.vessel_id\n    LEFT JOIN routes r ON v.route_id = r.route_id\n    INNER JOIN voyage_port_calls vpc ON v.voyage_id = vpc.voyage_id\n    INNER JOIN port_calls pc ON vpc.port_call_id = pc.port_call_id\n    INNER JOIN ports p ON pc.port_id = p.port_id\n    WHERE v.start_date >= CURRENT_DATE - INTERVAL '2 years'\n        AND vpc.port_sequence IS NOT NULL\n),\nport_call_distances AS (\n    -- Second CTE: Calculate distances between consecutive port calls\n    SELECT\n        vpcs.voyage_id,\n        vpcs.voyage_number,\n        vpcs.vessel_id,\n        vpcs.vessel_name,\n        vpcs.route_id,\n        vpcs.route_name,\n        vpcs.voyage_port_call_id,\n        vpcs.port_call_id,\n        vpcs.port_id,\n        vpcs.port_name,\n        vpcs.port_code,\n        vpcs.locode,\n        vpcs.port_geom,\n        vpcs.port_sequence,\n        vpcs.scheduled_arrival,\n        vpcs.actual_arrival,\n        vpcs.scheduled_departure,\n        vpcs.actual_departure,\n        vpcs.dwell_time_hours,\n        vpcs.arrival_delay_hours,\n        -- Previous port call\n        LAG(vpcs.port_id, 1) OVER (\n            PARTITION BY vpcs.voyage_id\n            ORDER BY vpcs.port_sequence\n        ) AS prev_port_id,\n        LAG(vpcs.port_geom, 1) OVER (\n            PARTITION BY vpcs.voyage_id\n            ORDER BY vpcs.port_sequence\n        ) AS prev_port_geom,\n        LAG(vpcs.port_name, 1) OVER (\n            PARTITION BY vpcs.voyage_id\n            ORDER BY vpcs.port_sequence\n        ) AS prev_port_name,\n        LAG(vpcs.actual_departure, 1) OVER (\n            PARTITION BY vpcs.voyage_id\n            ORDER BY vpcs.port_sequence\n        ) AS prev_departure,\n        -- Distance from previous port (nautical miles)\n        CASE\n            WHEN LAG(vpcs.port_geom, 1) OVER (PARTITION BY vpcs.voyage_id ORDER BY vpcs.port_sequence) IS NOT NULL\n                AND vpcs.port_geom IS NOT NULL THEN\n                ST_DISTANCE(\n                    LAG(vpcs.port_geom, 1) OVER (PARTITION BY vpcs.voyage_id ORDER BY vpcs.port_sequence),\n                    vpcs.port_geom\n                ) / 1852.0\n            ELSE NULL\n        END AS distance_from_prev_nm,\n        -- Transit time from previous port (hours)\n        CASE\n            WHEN LAG(vpcs.actual_departure, 1) OVER (PARTITION BY vpcs.voyage_id ORDER BY vpcs.port_sequence) IS NOT NULL\n                AND vpcs.actual_arrival IS NOT NULL THEN\n                EXTRACT(EPOCH FROM (\n                    vpcs.actual_arrival - LAG(vpcs.actual_departure, 1) OVER (PARTITION BY vpcs.voyage_id ORDER BY vpcs.port_sequence)\n                )) / 3600.0\n            ELSE NULL\n        END AS transit_time_from_prev_hours\n    FROM voyage_port_call_sequence vpcs\n),\nvoyage_efficiency_metrics AS (\n    -- Third CTE: Calculate voyage-level efficiency metrics\n    SELECT\n        pcd.voyage_id,\n        pcd.voyage_number,\n        pcd.vessel_id,\n        pcd.vessel_name,\n        pcd.route_id,\n        pcd.route_name,\n        COUNT(DISTINCT pcd.port_call_id) AS total_port_calls,\n        SUM(pcd.dwell_time_hours) AS total_dwell_time_hours,\n        AVG(pcd.dwell_time_hours) AS avg_dwell_time_hours,\n        MAX(pcd.dwell_time_hours) AS max_dwell_time_hours,\n        PERCENTILE_CONT(0.5) WITHIN GROUP (ORDER BY pcd.dwell_time_hours) AS median_dwell_time_hours,\n        PERCENTILE_CONT(0.75) WITHIN GROUP (ORDER BY pcd.dwell_time_hours) AS p75_dwell_time_hours,\n        SUM(pcd.distance_from_prev_nm) AS total_voyage_distance_nm,\n        AVG(pcd.distance_from_prev_nm) AS avg_leg_distance_nm,\n        SUM(pcd.transit_time_from_prev_hours) AS total_transit_time_hours,\n        AVG(pcd.transit_time_from_prev_hours) AS avg_transit_time_hours,\n        -- Voyage duration\n        CASE\n            WHEN MIN(pcd.actual_arrival) IS NOT NULL\n                AND MAX(pcd.actual_departure) IS NOT NULL THEN\n                EXTRACT(EPOCH FROM (\n                    MAX(pcd.actual_departure) -\n                    MIN(pcd.actual_arrival)\n                )) / 24.0\n            ELSE NULL\n        END AS total_voyage_duration_days,\n        -- Port call sequence as array\n        ARRAY_AGG(pcd.port_id ORDER BY pcd.port_sequence) AS port_sequence,\n        ARRAY_AGG(pcd.port_name ORDER BY pcd.port_sequence) AS port_name_sequence\n    FROM port_call_distances pcd\n    GROUP BY\n        pcd.voyage_id,\n        pcd.voyage_number,\n        pcd.vessel_id,\n        pcd.vessel_name,\n        pcd.route_id,\n        pcd.route_name\n),\nport_call_optimization_analysis AS (\n    -- Fourth CTE: Analyze optimization opportunities\n    SELECT\n        vem.voyage_id,\n        vem.voyage_number,\n        vem.vessel_id,\n        vem.vessel_name,\n        vem.route_id,\n        vem.route_name,\n        vem.total_port_calls,\n        ROUND(CAST(vem.total_dwell_time_hours AS NUMERIC), 2) AS total_dwell_time_hours,\n        ROUND(CAST(vem.avg_dwell_time_hours AS NUMERIC), 2) AS avg_dwell_time_hours,\n        ROUND(CAST(vem.max_dwell_time_hours AS NUMERIC), 2) AS max_dwell_time_hours,\n        ROUND(CAST(vem.median_dwell_time_hours AS NUMERIC), 2) AS median_dwell_time_hours,\n        ROUND(CAST(vem.p75_dwell_time_hours AS NUMERIC), 2) AS p75_dwell_time_hours,\n        ROUND(CAST(vem.total_voyage_distance_nm AS NUMERIC), 2) AS total_voyage_distance_nm,\n        ROUND(CAST(vem.avg_leg_distance_nm AS NUMERIC), 2) AS avg_leg_distance_nm,\n        ROUND(CAST(vem.total_transit_time_hours AS NUMERIC), 2) AS total_transit_time_hours,\n        ROUND(CAST(vem.avg_transit_time_hours AS NUMERIC), 2) AS avg_transit_time_hours,\n        ROUND(CAST(vem.total_voyage_duration_days AS NUMERIC), 2) AS total_voyage_duration_days,\n        vem.port_sequence,\n        vem.port_name_sequence,\n        -- Benchmark comparisons\n        AVG(vem.total_dwell_time_hours) OVER (PARTITION BY vem.route_id) AS route_avg_total_dwell_time,\n        AVG(vem.total_voyage_duration_days) OVER (PARTITION BY vem.route_id) AS route_avg_voyage_duration,\n        AVG(vem.total_voyage_distance_nm) OVER (PARTITION BY vem.route_id) AS route_avg_voyage_distance,\n        -- Optimization potential\n        CASE\n            WHEN vem.avg_dwell_time_hours > AVG(vem.avg_dwell_time_hours) OVER (PARTITION BY vem.route_id) * 1.2 THEN 'High Dwell Time Optimization Potential'\n            WHEN vem.avg_dwell_time_hours > AVG(vem.avg_dwell_time_hours) OVER (PARTITION BY vem.route_id) * 1.1 THEN 'Moderate Dwell Time Optimization Potential'\n            ELSE 'Normal Dwell Time'\n        END AS dwell_time_optimization_potential,\n        CASE\n            WHEN vem.total_voyage_distance_nm > AVG(vem.total_voyage_distance_nm) OVER (PARTITION BY vem.route_id) * 1.15 THEN 'High Distance Optimization Potential'\n            WHEN vem.total_voyage_distance_nm > AVG(vem.total_voyage_distance_nm) OVER (PARTITION BY vem.route_id) * 1.05 THEN 'Moderate Distance Optimization Potential'\n            ELSE 'Normal Distance'\n        END AS distance_optimization_potential\n    FROM voyage_efficiency_metrics vem\n),\nsequence_efficiency_scoring AS (\n    -- Fifth CTE: Score sequence efficiency\n    SELECT\n        pcoa.voyage_id,\n        pcoa.voyage_number,\n        pcoa.vessel_id,\n        pcoa.vessel_name,\n        pcoa.route_id,\n        pcoa.route_name,\n        pcoa.total_port_calls,\n        pcoa.total_dwell_time_hours,\n        pcoa.avg_dwell_time_hours,\n        pcoa.max_dwell_time_hours,\n        pcoa.median_dwell_time_hours,\n        pcoa.p75_dwell_time_hours,\n        pcoa.total_voyage_distance_nm,\n        pcoa.avg_leg_distance_nm,\n        pcoa.total_transit_time_hours,\n        pcoa.avg_transit_time_hours,\n        pcoa.total_voyage_duration_days,\n        pcoa.port_sequence,\n        pcoa.port_name_sequence,\n        ROUND(CAST(pcoa.route_avg_total_dwell_time AS NUMERIC), 2) AS route_avg_total_dwell_time,\n        ROUND(CAST(pcoa.route_avg_voyage_duration AS NUMERIC), 2) AS route_avg_voyage_duration,\n        ROUND(CAST(pcoa.route_avg_voyage_distance AS NUMERIC), 2) AS route_avg_voyage_distance,\n        pcoa.dwell_time_optimization_potential,\n        pcoa.distance_optimization_potential,\n        -- Efficiency score\n        (\n            -- Dwell time efficiency (40%) - inverse (lower is better)\n            CASE\n                WHEN pcoa.route_avg_total_dwell_time > 0 THEN\n                    GREATEST(0, (1.0 - (pcoa.total_dwell_time_hours - pcoa.route_avg_total_dwell_time) / pcoa.route_avg_total_dwell_time)) * 40\n                ELSE 0\n            END +\n            -- Distance efficiency (30%) - inverse (lower is better)\n            CASE\n                WHEN pcoa.route_avg_voyage_distance > 0 THEN\n                    GREATEST(0, (1.0 - (pcoa.total_voyage_distance_nm - pcoa.route_avg_voyage_distance) / pcoa.route_avg_voyage_distance)) * 30\n                ELSE 0\n            END +\n            -- Duration efficiency (30%) - inverse (lower is better)\n            CASE\n                WHEN pcoa.route_avg_voyage_duration > 0 THEN\n                    GREATEST(0, (1.0 - (pcoa.total_voyage_duration_days - pcoa.route_avg_voyage_duration) / pcoa.route_avg_voyage_duration)) * 30\n                ELSE 0\n            END\n        ) AS efficiency_score\n    FROM port_call_optimization_analysis pcoa\n)\nSELECT\n    voyage_id,\n    voyage_number,\n    vessel_id,\n    vessel_name,\n    route_id,\n    route_name,\n    total_port_calls,\n    total_dwell_time_hours,\n    avg_dwell_time_hours,\n    max_dwell_time_hours,\n    median_dwell_time_hours,\n    p75_dwell_time_hours,\n    total_voyage_distance_nm,\n    avg_leg_distance_nm,\n    total_transit_time_hours,\n    avg_transit_time_hours,\n    total_voyage_duration_days,\n    port_sequence,\n    port_name_sequence,\n    route_avg_total_dwell_time,\n    route_avg_voyage_duration,\n    route_avg_voyage_distance,\n    dwell_time_optimization_potential,\n    distance_optimization_potential,\n    ROUND(CAST(efficiency_score AS NUMERIC), 2) AS efficiency_score\nFROM sequence_efficiency_scoring\nORDER BY efficiency_score ASC, total_voyage_duration_days DESC\nLIMIT 1000;",
      "line_number": 5915
    },
    {
      "number": 18,
      "title": "Vessel Performance Benchmarking with Fleet Comparison and Operational Excellence Metrics",
      "description": "Use Case: Fleet Management - Comprehensive Vessel Performance Benchmarking for Operational Excellence Description: Enterprise-level vessel performance benchmarking with multi-level CTE nesting, performance metrics, fleet comparisons, operational excellence scoring, and advanced window functions. Demonstrates production patterns used by shipping lines for fleet optimization. Business Value: Vessel performance report showing performance benchmarks, fleet comparisons, operational excellence metrics",
      "complexity": "Deep nested CTEs (7+ levels), performance benchmarking, fleet comparisons, window functions with multiple frame clauses, percentile calculations, excellence scoring, multi-dimensional analysis",
      "expected_output": "Vessel performance report with benchmarks, fleet comparisons, and operational excellence metrics.",
      "sql": "WITH vessel_operational_metrics AS (\n    -- First CTE: Aggregate vessel operational metrics\n    SELECT\n        ve.vessel_id,\n        ve.vessel_name,\n        ve.imo_number,\n        ve.vessel_type,\n        ve.container_capacity_teu,\n        ve.year_built,\n        ve.carrier_id,\n        c.carrier_name,\n        COUNT(DISTINCT s.sailing_id) AS total_sailings,\n        COUNT(DISTINCT CASE WHEN s.status = 'Completed' THEN s.sailing_id END) AS completed_sailings,\n        SUM(s.total_teu) AS total_teu_carried,\n        AVG(s.total_teu) AS avg_teu_per_sailing,\n        AVG(s.capacity_utilization_percent) AS avg_capacity_utilization,\n        AVG(s.transit_days) AS avg_transit_days,\n        AVG(s.distance_nautical_miles) AS avg_distance_nm,\n        -- On-time performance\n        COUNT(DISTINCT CASE \n            WHEN s.actual_departure IS NOT NULL AND s.scheduled_departure IS NOT NULL\n                AND EXTRACT(EPOCH FROM (s.actual_departure - s.scheduled_departure)) / 3600.0 <= 6 THEN s.sailing_id\n        END) AS on_time_departures,\n        COUNT(DISTINCT CASE \n            WHEN s.actual_arrival IS NOT NULL AND s.scheduled_arrival IS NOT NULL\n                AND EXTRACT(EPOCH FROM (s.actual_arrival - s.scheduled_arrival)) / 3600.0 <= 6 THEN s.sailing_id\n        END) AS on_time_arrivals,\n        -- Port call metrics\n        COUNT(DISTINCT pc.port_call_id) AS total_port_calls,\n        AVG(CASE \n            WHEN pc.actual_arrival IS NOT NULL AND pc.actual_departure IS NOT NULL THEN\n                EXTRACT(EPOCH FROM (pc.actual_departure - pc.actual_arrival)) / 3600.0\n            ELSE NULL\n        END) AS avg_dwell_time_hours,\n        AVG(CASE \n            WHEN pc.actual_arrival IS NOT NULL AND pc.scheduled_arrival IS NOT NULL THEN\n                EXTRACT(EPOCH FROM (pc.actual_arrival - pc.scheduled_arrival)) / 3600.0\n            ELSE NULL\n        END) AS avg_arrival_delay_hours\n    FROM vessels ve\n    LEFT JOIN carriers c ON ve.carrier_id = c.carrier_id\n    LEFT JOIN sailings s ON ve.vessel_id = s.vessel_id\n    LEFT JOIN port_calls pc ON s.vessel_id = pc.vessel_id AND s.voyage_number = pc.voyage_number\n    WHERE ve.status = 'Active'\n        AND (s.scheduled_departure IS NULL OR s.scheduled_departure >= CURRENT_DATE - INTERVAL '2 years')\n    GROUP BY\n        ve.vessel_id,\n        ve.vessel_name,\n        ve.imo_number,\n        ve.vessel_type,\n        ve.container_capacity_teu,\n        ve.year_built,\n        ve.carrier_id,\n        c.carrier_name\n),\nvessel_performance_calculations AS (\n    -- Second CTE: Calculate performance metrics\n    SELECT\n        vom.vessel_id,\n        vom.vessel_name,\n        vom.imo_number,\n        vom.vessel_type,\n        vom.container_capacity_teu,\n        vom.year_built,\n        vom.carrier_id,\n        vom.carrier_name,\n        vom.total_sailings,\n        vom.completed_sailings,\n        ROUND(CAST(vom.total_teu_carried AS NUMERIC), 2) AS total_teu_carried,\n        ROUND(CAST(vom.avg_teu_per_sailing AS NUMERIC), 2) AS avg_teu_per_sailing,\n        ROUND(CAST(vom.avg_capacity_utilization AS NUMERIC), 2) AS avg_capacity_utilization,\n        ROUND(CAST(vom.avg_transit_days AS NUMERIC), 2) AS avg_transit_days,\n        ROUND(CAST(vom.avg_distance_nm AS NUMERIC), 2) AS avg_distance_nm,\n        vom.on_time_departures,\n        vom.on_time_arrivals,\n        vom.total_port_calls,\n        ROUND(CAST(vom.avg_dwell_time_hours AS NUMERIC), 2) AS avg_dwell_time_hours,\n        ROUND(CAST(vom.avg_arrival_delay_hours AS NUMERIC), 2) AS avg_arrival_delay_hours,\n        -- Completion rate\n        CASE\n            WHEN vom.total_sailings > 0 THEN\n                ROUND(CAST((vom.completed_sailings::NUMERIC / vom.total_sailings::NUMERIC) * 100 AS NUMERIC), 2)\n            ELSE 0\n        END AS completion_rate,\n        -- On-time performance rates\n        CASE\n            WHEN vom.total_sailings > 0 THEN\n                ROUND(CAST((vom.on_time_departures::NUMERIC / vom.total_sailings::NUMERIC) * 100 AS NUMERIC), 2)\n            ELSE 0\n        END AS on_time_departure_rate,\n        CASE\n            WHEN vom.total_sailings > 0 THEN\n                ROUND(CAST((vom.on_time_arrivals::NUMERIC / vom.total_sailings::NUMERIC) * 100 AS NUMERIC), 2)\n            ELSE 0\n        END AS on_time_arrival_rate,\n        -- Utilization efficiency\n        CASE\n            WHEN vom.container_capacity_teu > 0 AND vom.total_sailings > 0 THEN\n                (vom.total_teu_carried / (vom.container_capacity_teu * vom.total_sailings)) * 100\n            ELSE NULL\n        END AS utilization_efficiency_percent\n    FROM vessel_operational_metrics vom\n    WHERE vom.total_sailings > 0\n),\nfleet_benchmark_metrics AS (\n    -- Third CTE: Calculate fleet benchmarks\n    SELECT\n        vpc.vessel_id,\n        vpc.vessel_name,\n        vpc.imo_number,\n        vpc.vessel_type,\n        vpc.container_capacity_teu,\n        vpc.year_built,\n        vpc.carrier_id,\n        vpc.carrier_name,\n        vpc.total_sailings,\n        vpc.completed_sailings,\n        vpc.total_teu_carried,\n        vpc.avg_teu_per_sailing,\n        vpc.avg_capacity_utilization,\n        vpc.avg_transit_days,\n        vpc.avg_distance_nm,\n        vpc.on_time_departures,\n        vpc.on_time_arrivals,\n        vpc.total_port_calls,\n        vpc.avg_dwell_time_hours,\n        vpc.avg_arrival_delay_hours,\n        vpc.completion_rate,\n        vpc.on_time_departure_rate,\n        vpc.on_time_arrival_rate,\n        ROUND(CAST(vpc.utilization_efficiency_percent AS NUMERIC), 2) AS utilization_efficiency_percent,\n        -- Fleet averages\n        AVG(vpc.completion_rate) OVER (PARTITION BY vpc.carrier_id) AS carrier_avg_completion_rate,\n        AVG(vpc.on_time_arrival_rate) OVER (PARTITION BY vpc.carrier_id) AS carrier_avg_on_time_rate,\n        AVG(vpc.avg_capacity_utilization) OVER (PARTITION BY vpc.carrier_id) AS carrier_avg_capacity_utilization,\n        AVG(vpc.avg_dwell_time_hours) OVER (PARTITION BY vpc.carrier_id) AS carrier_avg_dwell_time,\n        -- Market averages\n        AVG(vpc.completion_rate) OVER () AS market_avg_completion_rate,\n        AVG(vpc.on_time_arrival_rate) OVER () AS market_avg_on_time_rate,\n        AVG(vpc.avg_capacity_utilization) OVER () AS market_avg_capacity_utilization,\n        AVG(vpc.avg_dwell_time_hours) OVER () AS market_avg_dwell_time,\n        -- Rankings\n        RANK() OVER (PARTITION BY vpc.carrier_id ORDER BY vpc.completion_rate DESC) AS carrier_completion_rank,\n        RANK() OVER (PARTITION BY vpc.carrier_id ORDER BY vpc.on_time_arrival_rate DESC) AS carrier_on_time_rank,\n        RANK() OVER (PARTITION BY vpc.carrier_id ORDER BY vpc.avg_capacity_utilization DESC) AS carrier_capacity_rank,\n        RANK() OVER (ORDER BY vpc.completion_rate DESC) AS market_completion_rank,\n        RANK() OVER (ORDER BY vpc.on_time_arrival_rate DESC) AS market_on_time_rank,\n        RANK() OVER (ORDER BY vpc.avg_capacity_utilization DESC) AS market_capacity_rank,\n        -- Percentiles\n        PERCENT_RANK() OVER (PARTITION BY vpc.carrier_id ORDER BY vpc.completion_rate) AS carrier_completion_percentile,\n        PERCENT_RANK() OVER (PARTITION BY vpc.carrier_id ORDER BY vpc.on_time_arrival_rate) AS carrier_on_time_percentile,\n        PERCENT_RANK() OVER (ORDER BY vpc.completion_rate) AS market_completion_percentile,\n        PERCENT_RANK() OVER (ORDER BY vpc.on_time_arrival_rate) AS market_on_time_percentile\n    FROM vessel_performance_calculations vpc\n),\noperational_excellence_scoring AS (\n    -- Fourth CTE: Calculate operational excellence scores\n    SELECT\n        fbm.vessel_id,\n        fbm.vessel_name,\n        fbm.imo_number,\n        fbm.vessel_type,\n        fbm.container_capacity_teu,\n        fbm.year_built,\n        fbm.carrier_id,\n        fbm.carrier_name,\n        fbm.total_sailings,\n        fbm.completed_sailings,\n        fbm.total_teu_carried,\n        fbm.avg_teu_per_sailing,\n        fbm.avg_capacity_utilization,\n        fbm.avg_transit_days,\n        fbm.avg_distance_nm,\n        fbm.on_time_departures,\n        fbm.on_time_arrivals,\n        fbm.total_port_calls,\n        fbm.avg_dwell_time_hours,\n        fbm.avg_arrival_delay_hours,\n        fbm.completion_rate,\n        fbm.on_time_departure_rate,\n        fbm.on_time_arrival_rate,\n        fbm.utilization_efficiency_percent,\n        ROUND(CAST(fbm.carrier_avg_completion_rate AS NUMERIC), 2) AS carrier_avg_completion_rate,\n        ROUND(CAST(fbm.carrier_avg_on_time_rate AS NUMERIC), 2) AS carrier_avg_on_time_rate,\n        ROUND(CAST(fbm.carrier_avg_capacity_utilization AS NUMERIC), 2) AS carrier_avg_capacity_utilization,\n        ROUND(CAST(fbm.carrier_avg_dwell_time AS NUMERIC), 2) AS carrier_avg_dwell_time,\n        ROUND(CAST(fbm.market_avg_completion_rate AS NUMERIC), 2) AS market_avg_completion_rate,\n        ROUND(CAST(fbm.market_avg_on_time_rate AS NUMERIC), 2) AS market_avg_on_time_rate,\n        ROUND(CAST(fbm.market_avg_capacity_utilization AS NUMERIC), 2) AS market_avg_capacity_utilization,\n        ROUND(CAST(fbm.market_avg_dwell_time AS NUMERIC), 2) AS market_avg_dwell_time,\n        fbm.carrier_completion_rank,\n        fbm.carrier_on_time_rank,\n        fbm.carrier_capacity_rank,\n        fbm.market_completion_rank,\n        fbm.market_on_time_rank,\n        fbm.market_capacity_rank,\n        ROUND(CAST(fbm.carrier_completion_percentile * 100 AS NUMERIC), 2) AS carrier_completion_percentile,\n        ROUND(CAST(fbm.carrier_on_time_percentile * 100 AS NUMERIC), 2) AS carrier_on_time_percentile,\n        ROUND(CAST(fbm.market_completion_percentile * 100 AS NUMERIC), 2) AS market_completion_percentile,\n        ROUND(CAST(fbm.market_on_time_percentile * 100 AS NUMERIC), 2) AS market_on_time_percentile,\n        -- Operational excellence score (weighted)\n        (\n            -- Completion rate component (30%)\n            (fbm.completion_rate / 100.0) * 30 +\n            -- On-time performance component (25%)\n            ((fbm.on_time_arrival_rate + fbm.on_time_departure_rate) / 200.0) * 25 +\n            -- Capacity utilization component (25%)\n            (fbm.avg_capacity_utilization / 100.0) * 25 +\n            -- Dwell time efficiency component (10%) - inverse (lower is better)\n            CASE\n                WHEN fbm.avg_dwell_time_hours IS NOT NULL THEN\n                    GREATEST(0, (1.0 - (fbm.avg_dwell_time_hours - 24) / 48.0)) * 10\n                ELSE 0\n            END +\n            -- Utilization efficiency component (10%)\n            CASE\n                WHEN fbm.utilization_efficiency_percent IS NOT NULL THEN\n                    (fbm.utilization_efficiency_percent / 100.0) * 10\n                ELSE 0\n            END\n        ) AS operational_excellence_score\n    FROM fleet_benchmark_metrics fbm\n),\nvessel_performance_classification AS (\n    -- Fifth CTE: Classify vessel performance\n    SELECT\n        oes.vessel_id,\n        oes.vessel_name,\n        oes.imo_number,\n        oes.vessel_type,\n        oes.container_capacity_teu,\n        oes.year_built,\n        oes.carrier_id,\n        oes.carrier_name,\n        oes.total_sailings,\n        oes.completed_sailings,\n        oes.total_teu_carried,\n        oes.avg_teu_per_sailing,\n        oes.avg_capacity_utilization,\n        oes.avg_transit_days,\n        oes.avg_distance_nm,\n        oes.on_time_departures,\n        oes.on_time_arrivals,\n        oes.total_port_calls,\n        oes.avg_dwell_time_hours,\n        oes.avg_arrival_delay_hours,\n        oes.completion_rate,\n        oes.on_time_departure_rate,\n        oes.on_time_arrival_rate,\n        oes.utilization_efficiency_percent,\n        oes.carrier_avg_completion_rate,\n        oes.carrier_avg_on_time_rate,\n        oes.carrier_avg_capacity_utilization,\n        oes.carrier_avg_dwell_time,\n        oes.market_avg_completion_rate,\n        oes.market_avg_on_time_rate,\n        oes.market_avg_capacity_utilization,\n        oes.market_avg_dwell_time,\n        oes.carrier_completion_rank,\n        oes.carrier_on_time_rank,\n        oes.carrier_capacity_rank,\n        oes.market_completion_rank,\n        oes.market_on_time_rank,\n        oes.market_capacity_rank,\n        oes.carrier_completion_percentile,\n        oes.carrier_on_time_percentile,\n        oes.market_completion_percentile,\n        oes.market_on_time_percentile,\n        ROUND(CAST(oes.operational_excellence_score AS NUMERIC), 2) AS operational_excellence_score,\n        -- Performance classification\n        CASE\n            WHEN oes.operational_excellence_score >= 90 THEN 'Excellent'\n            WHEN oes.operational_excellence_score >= 80 THEN 'Good'\n            WHEN oes.operational_excellence_score >= 70 THEN 'Average'\n            WHEN oes.operational_excellence_score >= 60 THEN 'Below Average'\n            ELSE 'Poor'\n        END AS performance_class,\n        -- Carrier performance position\n        CASE\n            WHEN oes.completion_rate > oes.carrier_avg_completion_rate * 1.1 THEN 'Top Performer'\n            WHEN oes.completion_rate > oes.carrier_avg_completion_rate * 0.9 THEN 'Average Performer'\n            ELSE 'Underperformer'\n        END AS carrier_performance_position,\n        -- Market performance position\n        CASE\n            WHEN oes.completion_rate > oes.market_avg_completion_rate * 1.1 THEN 'Above Market'\n            WHEN oes.completion_rate > oes.market_avg_completion_rate * 0.9 THEN 'At Market'\n            ELSE 'Below Market'\n        END AS market_performance_position\n    FROM operational_excellence_scoring oes\n)\nSELECT\n    vessel_id,\n    vessel_name,\n    imo_number,\n    vessel_type,\n    container_capacity_teu,\n    year_built,\n    carrier_id,\n    carrier_name,\n    total_sailings,\n    completed_sailings,\n    total_teu_carried,\n    avg_teu_per_sailing,\n    avg_capacity_utilization,\n    avg_transit_days,\n    avg_distance_nm,\n    on_time_departures,\n    on_time_arrivals,\n    total_port_calls,\n    avg_dwell_time_hours,\n    avg_arrival_delay_hours,\n    completion_rate,\n    on_time_departure_rate,\n    on_time_arrival_rate,\n    utilization_efficiency_percent,\n    carrier_avg_completion_rate,\n    carrier_avg_on_time_rate,\n    carrier_avg_capacity_utilization,\n    carrier_avg_dwell_time,\n    market_avg_completion_rate,\n    market_avg_on_time_rate,\n    market_avg_capacity_utilization,\n    market_avg_dwell_time,\n    carrier_completion_rank,\n    carrier_on_time_rank,\n    carrier_capacity_rank,\n    market_completion_rank,\n    market_on_time_rank,\n    market_capacity_rank,\n    carrier_completion_percentile,\n    carrier_on_time_percentile,\n    market_completion_percentile,\n    market_on_time_percentile,\n    operational_excellence_score,\n    performance_class,\n    carrier_performance_position,\n    market_performance_position\nFROM vessel_performance_classification\nORDER BY operational_excellence_score DESC, completion_rate DESC\nLIMIT 500;",
      "line_number": 6198
    },
    {
      "number": 19,
      "title": "Route Network Connectivity Analysis with Port Hub Identification and Network Optimization",
      "description": "Use Case: Network Planning - Comprehensive Route Network Connectivity Analysis for Hub Optimization Description: Enterprise-level route network analysis with multi-level CTE nesting, connectivity calculations, hub identification, network optimization, and advanced recursive CTEs. Demonstrates production patterns used by shipping lines for network planning. Business Value: Route network report showing port connectivity, hub identification, network efficiency, and optimization opportunities. Helps",
      "complexity": "Deep nested CTEs (7+ levels), recursive CTEs for network traversal, connectivity analysis, hub scoring, window functions with multiple frame clauses, network metrics",
      "expected_output": "Route network report with connectivity metrics, hub identification, and network optimization recommendations.",
      "sql": "WITH route_port_connections AS (\n    -- First CTE: Extract port connections from routes\n    SELECT DISTINCT\n        r.route_id,\n        r.route_name,\n        r.route_type,\n        rp.port_id AS port_id,\n        p.port_name,\n        p.port_code,\n        p.locode,\n        p.country,\n        p.port_geom,\n        rp.port_sequence,\n        -- Connected ports (next port in route)\n        LEAD(rp.port_id, 1) OVER (\n            PARTITION BY r.route_id\n            ORDER BY rp.port_sequence\n        ) AS connected_port_id,\n        LEAD(p.port_name, 1) OVER (\n            PARTITION BY r.route_id\n            ORDER BY rp.port_sequence\n        ) AS connected_port_name,\n        LEAD(p.port_code, 1) OVER (\n            PARTITION BY r.route_id\n            ORDER BY rp.port_sequence\n        ) AS connected_port_code\n    FROM routes r\n    INNER JOIN route_ports rp ON r.route_id = rp.route_id\n    INNER JOIN ports p ON rp.port_id = p.port_id\n    WHERE rp.port_sequence IS NOT NULL\n),\nport_connection_aggregation AS (\n    -- Second CTE: Aggregate connections by port\n    SELECT\n        rpc.port_id,\n        rpc.port_name,\n        rpc.port_code,\n        rpc.locode,\n        rpc.country,\n        rpc.port_geom,\n        COUNT(DISTINCT rpc.route_id) AS total_routes,\n        COUNT(DISTINCT rpc.connected_port_id) AS unique_connected_ports,\n        COUNT(DISTINCT CASE WHEN rpc.connected_port_id IS NOT NULL THEN rpc.route_id END) AS outgoing_connections,\n        -- Incoming connections (ports that connect TO this port)\n        (SELECT COUNT(DISTINCT rpc2.route_id)\n         FROM route_port_connections rpc2\n         WHERE rpc2.connected_port_id = rpc.port_id) AS incoming_connections,\n        -- Total connections (incoming + outgoing)\n        COUNT(DISTINCT CASE WHEN rpc.connected_port_id IS NOT NULL THEN rpc.route_id END) +\n        (SELECT COUNT(DISTINCT rpc2.route_id)\n         FROM route_port_connections rpc2\n         WHERE rpc2.connected_port_id = rpc.port_id) AS total_connections\n    FROM route_port_connections rpc\n    GROUP BY\n        rpc.port_id,\n        rpc.port_name,\n        rpc.port_code,\n        rpc.locode,\n        rpc.country,\n        rpc.port_geom\n),\nport_hub_scoring AS (\n    -- Third CTE: Calculate hub scores\n    SELECT\n        pca.port_id,\n        pca.port_name,\n        pca.port_code,\n        pca.locode,\n        pca.country,\n        pca.port_geom,\n        pca.total_routes,\n        pca.unique_connected_ports,\n        pca.outgoing_connections,\n        pca.incoming_connections,\n        pca.total_connections,\n        -- Hub score components\n        -- Route diversity (30%)\n        CASE\n            WHEN MAX(pca.total_routes) OVER () > 0 THEN\n                (pca.total_routes::NUMERIC / MAX(pca.total_routes) OVER ()) * 30\n            ELSE 0\n        END AS route_diversity_score,\n        -- Connectivity score (40%)\n        CASE\n            WHEN MAX(pca.total_connections) OVER () > 0 THEN\n                (pca.total_connections::NUMERIC / MAX(pca.total_connections) OVER ()) * 40\n            ELSE 0\n        END AS connectivity_score,\n        -- Unique connections score (30%)\n        CASE\n            WHEN MAX(pca.unique_connected_ports) OVER () > 0 THEN\n                (pca.unique_connected_ports::NUMERIC / MAX(pca.unique_connected_ports) OVER ()) * 30\n            ELSE 0\n        END AS unique_connections_score,\n        -- Total hub score\n        (\n            CASE\n                WHEN MAX(pca.total_routes) OVER () > 0 THEN\n                    (pca.total_routes::NUMERIC / MAX(pca.total_routes) OVER ()) * 30\n                ELSE 0\n            END +\n            CASE\n                WHEN MAX(pca.total_connections) OVER () > 0 THEN\n                    (pca.total_connections::NUMERIC / MAX(pca.total_connections) OVER ()) * 40\n                ELSE 0\n            END +\n            CASE\n                WHEN MAX(pca.unique_connected_ports) OVER () > 0 THEN\n                    (pca.unique_connected_ports::NUMERIC / MAX(pca.unique_connected_ports) OVER ()) * 30\n                ELSE 0\n            END\n        ) AS hub_score\n    FROM port_connection_aggregation pca\n),\nport_pair_connectivity AS (\n    -- Fourth CTE: Analyze port pair connectivity\n    SELECT\n        rpc1.port_id AS origin_port_id,\n        rpc1.port_name AS origin_port_name,\n        rpc1.port_code AS origin_port_code,\n        rpc1.connected_port_id AS destination_port_id,\n        rpc1.connected_port_name AS destination_port_name,\n        rpc1.connected_port_code AS destination_port_code,\n        COUNT(DISTINCT rpc1.route_id) AS direct_routes,\n        -- Distance between ports\n        CASE\n            WHEN rpc1.port_geom IS NOT NULL AND rpc2.port_geom IS NOT NULL THEN\n                ST_DISTANCE(rpc1.port_geom, rpc2.port_geom) / 1852.0\n            ELSE NULL\n        END AS distance_nm\n    FROM route_port_connections rpc1\n    LEFT JOIN ports rpc2 ON rpc1.connected_port_id = rpc2.port_id\n    WHERE rpc1.connected_port_id IS NOT NULL\n    GROUP BY\n        rpc1.port_id,\n        rpc1.port_name,\n        rpc1.port_code,\n        rpc1.connected_port_id,\n        rpc1.connected_port_name,\n        rpc1.connected_port_code,\n        rpc1.port_geom,\n        rpc2.port_geom\n),\nnetwork_efficiency_metrics AS (\n    -- Fifth CTE: Calculate network efficiency metrics\n    SELECT\n        phs.port_id,\n        phs.port_name,\n        phs.port_code,\n        phs.locode,\n        phs.country,\n        phs.port_geom,\n        phs.total_routes,\n        phs.unique_connected_ports,\n        phs.outgoing_connections,\n        phs.incoming_connections,\n        phs.total_connections,\n        ROUND(CAST(phs.route_diversity_score AS NUMERIC), 2) AS route_diversity_score,\n        ROUND(CAST(phs.connectivity_score AS NUMERIC), 2) AS connectivity_score,\n        ROUND(CAST(phs.unique_connections_score AS NUMERIC), 2) AS unique_connections_score,\n        ROUND(CAST(phs.hub_score AS NUMERIC), 2) AS hub_score,\n        -- Average distance to connected ports\n        AVG(ppc.distance_nm) AS avg_distance_to_connected_ports,\n        -- Market averages for comparison\n        AVG(phs.total_routes) OVER () AS market_avg_routes,\n        AVG(phs.total_connections) OVER () AS market_avg_connections,\n        AVG(phs.unique_connected_ports) OVER () AS market_avg_unique_ports,\n        -- Rankings\n        RANK() OVER (ORDER BY phs.hub_score DESC) AS hub_rank,\n        PERCENT_RANK() OVER (ORDER BY phs.hub_score) AS hub_percentile\n    FROM port_hub_scoring phs\n    LEFT JOIN port_pair_connectivity ppc ON phs.port_id = ppc.origin_port_id\n    GROUP BY\n        phs.port_id,\n        phs.port_name,\n        phs.port_code,\n        phs.locode,\n        phs.country,\n        phs.port_geom,\n        phs.total_routes,\n        phs.unique_connected_ports,\n        phs.outgoing_connections,\n        phs.incoming_connections,\n        phs.total_connections,\n        phs.route_diversity_score,\n        phs.connectivity_score,\n        phs.unique_connections_score,\n        phs.hub_score\n),\nhub_classification AS (\n    -- Sixth CTE: Classify ports by hub status\n    SELECT\n        nem.port_id,\n        nem.port_name,\n        nem.port_code,\n        nem.locode,\n        nem.country,\n        nem.port_geom,\n        nem.total_routes,\n        nem.unique_connected_ports,\n        nem.outgoing_connections,\n        nem.incoming_connections,\n        nem.total_connections,\n        nem.route_diversity_score,\n        nem.connectivity_score,\n        nem.unique_connections_score,\n        nem.hub_score,\n        ROUND(CAST(nem.avg_distance_to_connected_ports AS NUMERIC), 2) AS avg_distance_to_connected_ports,\n        ROUND(CAST(nem.market_avg_routes AS NUMERIC), 2) AS market_avg_routes,\n        ROUND(CAST(nem.market_avg_connections AS NUMERIC), 2) AS market_avg_connections,\n        ROUND(CAST(nem.market_avg_unique_ports AS NUMERIC), 2) AS market_avg_unique_ports,\n        nem.hub_rank,\n        ROUND(CAST(nem.hub_percentile * 100 AS NUMERIC), 2) AS hub_percentile,\n        -- Hub classification\n        CASE\n            WHEN nem.hub_score >= 80 THEN 'Major Hub'\n            WHEN nem.hub_score >= 60 THEN 'Regional Hub'\n            WHEN nem.hub_score >= 40 THEN 'Local Hub'\n            WHEN nem.hub_score >= 20 THEN 'Connected Port'\n            ELSE 'Isolated Port'\n        END AS hub_class,\n        -- Network role\n        CASE\n            WHEN nem.incoming_connections > nem.outgoing_connections * 1.5 THEN 'Destination Hub'\n            WHEN nem.outgoing_connections > nem.incoming_connections * 1.5 THEN 'Origin Hub'\n            WHEN nem.incoming_connections > 0 AND nem.outgoing_connections > 0 THEN 'Transit Hub'\n            ELSE 'Terminal Port'\n        END AS network_role,\n        -- Optimization recommendation\n        CASE\n            WHEN nem.hub_score < nem.market_avg_connections AND nem.total_routes > 0 THEN 'Increase Connectivity'\n            WHEN nem.avg_distance_to_connected_ports > 2000 THEN 'Optimize Route Distances'\n            WHEN nem.unique_connected_ports < nem.market_avg_unique_ports THEN 'Expand Connections'\n            ELSE 'Network Optimal'\n        END AS optimization_recommendation\n    FROM network_efficiency_metrics nem\n)\nSELECT\n    port_id,\n    port_name,\n    port_code,\n    locode,\n    country,\n    total_routes,\n    unique_connected_ports,\n    outgoing_connections,\n    incoming_connections,\n    total_connections,\n    route_diversity_score,\n    connectivity_score,\n    unique_connections_score,\n    hub_score,\n    avg_distance_to_connected_ports,\n    market_avg_routes,\n    market_avg_connections,\n    market_avg_unique_ports,\n    hub_rank,\n    hub_percentile,\n    hub_class,\n    network_role,\n    optimization_recommendation\nFROM hub_classification\nORDER BY hub_score DESC, total_connections DESC\nLIMIT 500;",
      "line_number": 6560
    },
    {
      "number": 20,
      "title": "Sailing Frequency Analysis with Service Consistency Metrics and Schedule Optimization",
      "description": "Use Case: Service Planning - Comprehensive Sailing Frequency Analysis for Schedule Optimization Description: Enterprise-level sailing frequency analysis with multi-level CTE nesting, frequency calculations, service consistency metrics, schedule optimization, and advanced window functions. Demonstrates production patterns used by shipping lines for service planning. Business Value: Sailing frequency report showing service frequencies, consistency metrics, schedule gaps, and optimization opportuni",
      "complexity": "Deep nested CTEs (7+ levels), frequency calculations, temporal analysis, consistency metrics, window functions with multiple frame clauses, schedule gap detection, optimization algorithms",
      "expected_output": "Sailing frequency report with service frequencies, consistency metrics, and schedule optimization recommendations.",
      "sql": "WITH sailing_schedule_analysis AS (\n    -- First CTE: Extract sailing schedules by route and port pair\n    SELECT\n        s.sailing_id,\n        r.carrier_id,\n        c.carrier_name,\n        s.route_id,\n        r.route_name,\n        s.origin_port_id,\n        op.port_name AS origin_port_name,\n        op.port_code AS origin_port_code,\n        s.destination_port_id,\n        dp.port_name AS destination_port_name,\n        dp.port_code AS destination_port_code,\n        s.scheduled_departure,\n        s.actual_departure,\n        s.scheduled_arrival,\n        s.actual_arrival,\n        s.status,\n        DATE_TRUNC('week', s.scheduled_departure) AS sailing_week,\n        DATE_TRUNC('month', s.scheduled_departure) AS sailing_month,\n        DATE_TRUNC('quarter', s.scheduled_departure) AS sailing_quarter,\n        EXTRACT(DOW FROM s.scheduled_departure) AS day_of_week,\n        EXTRACT(WEEK FROM s.scheduled_departure) AS week_of_year\n    FROM sailings s\n    INNER JOIN routes r ON s.route_id = r.route_id\n    INNER JOIN carriers c ON r.carrier_id = c.carrier_id\n    LEFT JOIN ports op ON s.origin_port_id = op.port_id\n    LEFT JOIN ports dp ON s.destination_port_id = dp.port_id\n    WHERE s.scheduled_departure >= CURRENT_DATE - INTERVAL '2 years'\n),\nroute_port_pair_frequency AS (\n    -- Second CTE: Calculate frequency by route and port pair\n    SELECT\n        ssa.carrier_id,\n        ssa.carrier_name,\n        ssa.route_id,\n        ssa.route_name,\n        ssa.origin_port_id,\n        ssa.origin_port_name,\n        ssa.origin_port_code,\n        ssa.destination_port_id,\n        ssa.destination_port_name,\n        ssa.destination_port_code,\n        ssa.sailing_week,\n        ssa.sailing_month,\n        ssa.sailing_quarter,\n        COUNT(DISTINCT ssa.sailing_id) AS sailings_per_week,\n        COUNT(DISTINCT CASE WHEN ssa.status = 'Completed' THEN ssa.sailing_id END) AS completed_sailings_per_week,\n        COUNT(DISTINCT CASE WHEN ssa.status = 'Cancelled' THEN ssa.sailing_id END) AS cancelled_sailings_per_week,\n        -- Day of week distribution\n        COUNT(DISTINCT CASE WHEN ssa.day_of_week = 0 THEN ssa.sailing_id END) AS sunday_sailings,\n        COUNT(DISTINCT CASE WHEN ssa.day_of_week = 1 THEN ssa.sailing_id END) AS monday_sailings,\n        COUNT(DISTINCT CASE WHEN ssa.day_of_week = 2 THEN ssa.sailing_id END) AS tuesday_sailings,\n        COUNT(DISTINCT CASE WHEN ssa.day_of_week = 3 THEN ssa.sailing_id END) AS wednesday_sailings,\n        COUNT(DISTINCT CASE WHEN ssa.day_of_week = 4 THEN ssa.sailing_id END) AS thursday_sailings,\n        COUNT(DISTINCT CASE WHEN ssa.day_of_week = 5 THEN ssa.sailing_id END) AS friday_sailings,\n        COUNT(DISTINCT CASE WHEN ssa.day_of_week = 6 THEN ssa.sailing_id END) AS saturday_sailings\n    FROM sailing_schedule_analysis ssa\n    GROUP BY\n        ssa.carrier_id,\n        ssa.carrier_name,\n        ssa.route_id,\n        ssa.route_name,\n        ssa.origin_port_id,\n        ssa.origin_port_name,\n        ssa.origin_port_code,\n        ssa.destination_port_id,\n        ssa.destination_port_name,\n        ssa.destination_port_code,\n        ssa.sailing_week,\n        ssa.sailing_month,\n        ssa.sailing_quarter\n),\nfrequency_consistency_metrics AS (\n    -- Third CTE: Calculate consistency metrics\n    SELECT\n        rppf.carrier_id,\n        rppf.carrier_name,\n        rppf.route_id,\n        rppf.route_name,\n        rppf.origin_port_id,\n        rppf.origin_port_name,\n        rppf.origin_port_code,\n        rppf.destination_port_id,\n        rppf.destination_port_name,\n        rppf.destination_port_code,\n        rppf.sailing_month,\n        rppf.sailing_quarter,\n        COUNT(DISTINCT rppf.sailing_week) AS weeks_with_sailings,\n        SUM(rppf.sailings_per_week) AS total_sailings,\n        SUM(rppf.completed_sailings_per_week) AS total_completed_sailings,\n        SUM(rppf.cancelled_sailings_per_week) AS total_cancelled_sailings,\n        AVG(rppf.sailings_per_week) AS avg_sailings_per_week,\n        PERCENTILE_CONT(0.5) WITHIN GROUP (ORDER BY rppf.sailings_per_week) AS median_sailings_per_week,\n        PERCENTILE_CONT(0.75) WITHIN GROUP (ORDER BY rppf.sailings_per_week) AS p75_sailings_per_week,\n        STDDEV(rppf.sailings_per_week) AS stddev_sailings_per_week,\n        MIN(rppf.sailings_per_week) AS min_sailings_per_week,\n        MAX(rppf.sailings_per_week) AS max_sailings_per_week,\n        -- Day distribution\n        SUM(rppf.sunday_sailings) AS total_sunday_sailings,\n        SUM(rppf.monday_sailings) AS total_monday_sailings,\n        SUM(rppf.tuesday_sailings) AS total_tuesday_sailings,\n        SUM(rppf.wednesday_sailings) AS total_wednesday_sailings,\n        SUM(rppf.thursday_sailings) AS total_thursday_sailings,\n        SUM(rppf.friday_sailings) AS total_friday_sailings,\n        SUM(rppf.saturday_sailings) AS total_saturday_sailings,\n        -- Consistency indicators\n        CASE\n            WHEN STDDEV(rppf.sailings_per_week) IS NOT NULL AND AVG(rppf.sailings_per_week) > 0 THEN\n                (STDDEV(rppf.sailings_per_week) / AVG(rppf.sailings_per_week)) * 100\n            ELSE NULL\n        END AS frequency_coefficient_of_variation\n    FROM route_port_pair_frequency rppf\n    GROUP BY\n        rppf.carrier_id,\n        rppf.carrier_name,\n        rppf.route_id,\n        rppf.route_name,\n        rppf.origin_port_id,\n        rppf.origin_port_name,\n        rppf.origin_port_code,\n        rppf.destination_port_id,\n        rppf.destination_port_name,\n        rppf.destination_port_code,\n        rppf.sailing_month,\n        rppf.sailing_quarter\n),\nschedule_gap_analysis AS (\n    -- Fourth CTE: Analyze schedule gaps\n    SELECT\n        fcm.carrier_id,\n        fcm.carrier_name,\n        fcm.route_id,\n        fcm.route_name,\n        fcm.origin_port_id,\n        fcm.origin_port_name,\n        fcm.origin_port_code,\n        fcm.destination_port_id,\n        fcm.destination_port_name,\n        fcm.destination_port_code,\n        fcm.sailing_month,\n        fcm.sailing_quarter,\n        fcm.weeks_with_sailings,\n        fcm.total_sailings,\n        fcm.total_completed_sailings,\n        fcm.total_cancelled_sailings,\n        ROUND(CAST(fcm.avg_sailings_per_week AS NUMERIC), 2) AS avg_sailings_per_week,\n        ROUND(CAST(fcm.median_sailings_per_week AS NUMERIC), 2) AS median_sailings_per_week,\n        ROUND(CAST(fcm.p75_sailings_per_week AS NUMERIC), 2) AS p75_sailings_per_week,\n        ROUND(CAST(fcm.stddev_sailings_per_week AS NUMERIC), 2) AS stddev_sailings_per_week,\n        fcm.min_sailings_per_week,\n        fcm.max_sailings_per_week,\n        fcm.total_sunday_sailings,\n        fcm.total_monday_sailings,\n        fcm.total_tuesday_sailings,\n        fcm.total_wednesday_sailings,\n        fcm.total_thursday_sailings,\n        fcm.total_friday_sailings,\n        fcm.total_saturday_sailings,\n        ROUND(CAST(fcm.frequency_coefficient_of_variation AS NUMERIC), 2) AS frequency_coefficient_of_variation,\n        -- Expected weeks in month (approximately 4.33)\n        CASE\n            WHEN EXTRACT(MONTH FROM fcm.sailing_month) IN (1, 3, 5, 7, 8, 10, 12) THEN 4.43\n            WHEN EXTRACT(MONTH FROM fcm.sailing_month) IN (4, 6, 9, 11) THEN 4.33\n            ELSE 4.29\n        END AS expected_weeks_in_month,\n        -- Service frequency (sailings per week)\n        CASE\n            WHEN fcm.weeks_with_sailings > 0 THEN\n                fcm.total_sailings / fcm.weeks_with_sailings::NUMERIC\n            ELSE 0\n        END AS service_frequency_per_week,\n        -- Consistency score (lower CV = more consistent)\n        CASE\n            WHEN fcm.frequency_coefficient_of_variation IS NOT NULL THEN\n                GREATEST(0, 100 - fcm.frequency_coefficient_of_variation)\n            ELSE NULL\n        END AS consistency_score,\n        -- Gap analysis\n        CASE\n            WHEN fcm.weeks_with_sailings < \n                CASE\n                    WHEN EXTRACT(MONTH FROM fcm.sailing_month) IN (1, 3, 5, 7, 8, 10, 12) THEN 4\n                    WHEN EXTRACT(MONTH FROM fcm.sailing_month) IN (4, 6, 9, 11) THEN 4\n                    ELSE 4\n                END * 0.8 THEN 'Significant Gaps'\n            WHEN fcm.weeks_with_sailings < \n                CASE\n                    WHEN EXTRACT(MONTH FROM fcm.sailing_month) IN (1, 3, 5, 7, 8, 10, 12) THEN 4\n                    WHEN EXTRACT(MONTH FROM fcm.sailing_month) IN (4, 6, 9, 11) THEN 4\n                    ELSE 4\n                END * 0.9 THEN 'Moderate Gaps'\n            ELSE 'Consistent Service'\n        END AS gap_classification\n    FROM frequency_consistency_metrics fcm\n),\nfrequency_optimization AS (\n    -- Fifth CTE: Generate optimization recommendations\n    SELECT\n        sga.carrier_id,\n        sga.carrier_name,\n        sga.route_id,\n        sga.route_name,\n        sga.origin_port_id,\n        sga.origin_port_name,\n        sga.origin_port_code,\n        sga.destination_port_id,\n        sga.destination_port_name,\n        sga.destination_port_code,\n        sga.sailing_month,\n        sga.sailing_quarter,\n        sga.weeks_with_sailings,\n        sga.total_sailings,\n        sga.total_completed_sailings,\n        sga.total_cancelled_sailings,\n        sga.avg_sailings_per_week,\n        sga.median_sailings_per_week,\n        sga.p75_sailings_per_week,\n        sga.stddev_sailings_per_week,\n        sga.min_sailings_per_week,\n        sga.max_sailings_per_week,\n        sga.total_sunday_sailings,\n        sga.total_monday_sailings,\n        sga.total_tuesday_sailings,\n        sga.total_wednesday_sailings,\n        sga.total_thursday_sailings,\n        sga.total_friday_sailings,\n        sga.total_saturday_sailings,\n        sga.frequency_coefficient_of_variation,\n        sga.expected_weeks_in_month,\n        ROUND(CAST(sga.service_frequency_per_week AS NUMERIC), 2) AS service_frequency_per_week,\n        ROUND(CAST(sga.consistency_score AS NUMERIC), 2) AS consistency_score,\n        sga.gap_classification,\n        -- Market comparison\n        AVG(sga.service_frequency_per_week) OVER (PARTITION BY sga.route_id) AS route_avg_frequency,\n        AVG(sga.consistency_score) OVER (PARTITION BY sga.route_id) AS route_avg_consistency,\n        -- Optimization recommendations\n        CASE\n            WHEN sga.service_frequency_per_week < AVG(sga.service_frequency_per_week) OVER (PARTITION BY sga.route_id) * 0.8 THEN 'Increase Frequency'\n            WHEN sga.consistency_score < 70 THEN 'Improve Consistency'\n            WHEN sga.gap_classification IN ('Significant Gaps', 'Moderate Gaps') THEN 'Fill Schedule Gaps'\n            WHEN sga.total_cancelled_sailings > sga.total_sailings * 0.1 THEN 'Reduce Cancellations'\n            ELSE 'Schedule Optimal'\n        END AS optimization_recommendation,\n        -- Service level classification\n        CASE\n            WHEN sga.service_frequency_per_week >= 2 THEN 'High Frequency Service'\n            WHEN sga.service_frequency_per_week >= 1 THEN 'Regular Service'\n            WHEN sga.service_frequency_per_week >= 0.5 THEN 'Low Frequency Service'\n            ELSE 'Irregular Service'\n        END AS service_level\n    FROM schedule_gap_analysis sga\n)\nSELECT\n    carrier_id,\n    carrier_name,\n    route_id,\n    route_name,\n    origin_port_id,\n    origin_port_name,\n    origin_port_code,\n    destination_port_id,\n    destination_port_name,\n    destination_port_code,\n    sailing_month,\n    sailing_quarter,\n    weeks_with_sailings,\n    total_sailings,\n    total_completed_sailings,\n    total_cancelled_sailings,\n    avg_sailings_per_week,\n    median_sailings_per_week,\n    p75_sailings_per_week,\n    stddev_sailings_per_week,\n    min_sailings_per_week,\n    max_sailings_per_week,\n    total_sunday_sailings,\n    total_monday_sailings,\n    total_tuesday_sailings,\n    total_wednesday_sailings,\n    total_thursday_sailings,\n    total_friday_sailings,\n    total_saturday_sailings,\n    frequency_coefficient_of_variation,\n    expected_weeks_in_month,\n    service_frequency_per_week,\n    consistency_score,\n    gap_classification,\n    ROUND(CAST(route_avg_frequency AS NUMERIC), 2) AS route_avg_frequency,\n    ROUND(CAST(route_avg_consistency AS NUMERIC), 2) AS route_avg_consistency,\n    optimization_recommendation,\n    service_level\nFROM frequency_optimization\nORDER BY sailing_month DESC, service_frequency_per_week DESC\nLIMIT 2000;",
      "line_number": 6845
    },
    {
      "number": 21,
      "title": "Port Call Delay Prediction with Risk Assessment and Delay Pattern Analysis",
      "description": "Use Case: Predictive Analytics - Comprehensive Port Call Delay Prediction for Risk Management Description: Enterprise-level port call delay prediction with multi-level CTE nesting, delay pattern analysis, risk assessment, predictive metrics, and advanced window functions. Demonstrates production patterns used by shipping lines for delay prediction and risk management. Business Value: Port call delay prediction report showing delay probabilities, risk factors, pattern analysis, and mitigation rec",
      "complexity": "Deep nested CTEs (7+ levels), delay pattern analysis, risk scoring, predictive metrics, window functions with multiple frame clauses, percentile calculations, temporal pattern detection",
      "expected_output": "Port call delay prediction report with delay probabilities, risk factors, and mitigation recommendations.",
      "sql": "WITH port_call_historical_delays AS (\n    -- First CTE: Extract historical delay data\n    SELECT\n        pc.port_call_id,\n        pc.port_id,\n        p.port_name,\n        p.port_code,\n        p.locode,\n        pc.vessel_id,\n        ve.vessel_name,\n        ve.vessel_type,\n        r.carrier_id,\n        c.carrier_name,\n        s.route_id,\n        r.route_name,\n        pc.scheduled_arrival,\n        pc.actual_arrival,\n        pc.scheduled_departure,\n        pc.actual_departure,\n        pc.status,\n        -- Delay calculations\n        CASE\n            WHEN pc.actual_arrival IS NOT NULL AND pc.scheduled_arrival IS NOT NULL THEN\n                EXTRACT(EPOCH FROM (pc.actual_arrival - pc.scheduled_arrival)) / 3600.0\n            ELSE NULL\n        END AS arrival_delay_hours,\n        CASE\n            WHEN pc.actual_departure IS NOT NULL AND pc.scheduled_departure IS NOT NULL THEN\n                EXTRACT(EPOCH FROM (pc.actual_departure - pc.scheduled_departure)) / 3600.0\n            ELSE NULL\n        END AS departure_delay_hours,\n        -- Dwell time\n        CASE\n            WHEN pc.actual_arrival IS NOT NULL AND pc.actual_departure IS NOT NULL THEN\n                EXTRACT(EPOCH FROM (pc.actual_departure - pc.actual_arrival)) / 3600.0\n            ELSE NULL\n        END AS dwell_time_hours,\n        -- Temporal features\n        EXTRACT(DOW FROM pc.scheduled_arrival) AS day_of_week,\n        EXTRACT(MONTH FROM pc.scheduled_arrival) AS month,\n        EXTRACT(QUARTER FROM pc.scheduled_arrival) AS quarter,\n        EXTRACT(HOUR FROM pc.scheduled_arrival) AS hour_of_day,\n        DATE_TRUNC('week', pc.scheduled_arrival) AS arrival_week,\n        DATE_TRUNC('month', pc.scheduled_arrival) AS arrival_month,\n        -- Container volume\n        COALESCE(pc.containers_loaded, 0) + COALESCE(pc.containers_discharged, 0) + COALESCE(pc.containers_transshipped, 0) AS total_containers,\n        pc.containers_loaded,\n        pc.containers_discharged,\n        pc.containers_transshipped\n    FROM port_calls pc\n    INNER JOIN ports p ON pc.port_id = p.port_id\n    LEFT JOIN vessels ve ON pc.vessel_id = ve.vessel_id\n    LEFT JOIN sailings s ON pc.vessel_id = s.vessel_id AND pc.voyage_number = s.voyage_number\n    LEFT JOIN routes r ON s.route_id = r.route_id\n    LEFT JOIN carriers c ON r.carrier_id = c.carrier_id\n    WHERE pc.scheduled_arrival >= CURRENT_DATE - INTERVAL '2 years'\n),\nport_delay_statistics AS (\n    -- Second CTE: Calculate port-level delay statistics\n    SELECT\n        pchd.port_id,\n        pchd.port_name,\n        pchd.port_code,\n        pchd.locode,\n        COUNT(DISTINCT pchd.port_call_id) AS total_port_calls,\n        COUNT(DISTINCT CASE WHEN pchd.arrival_delay_hours IS NOT NULL THEN pchd.port_call_id END) AS port_calls_with_delays,\n        AVG(pchd.arrival_delay_hours) AS port_avg_arrival_delay,\n        PERCENTILE_CONT(0.5) WITHIN GROUP (ORDER BY pchd.arrival_delay_hours) AS port_median_arrival_delay,\n        PERCENTILE_CONT(0.75) WITHIN GROUP (ORDER BY pchd.arrival_delay_hours) AS port_p75_arrival_delay,\n        PERCENTILE_CONT(0.9) WITHIN GROUP (ORDER BY pchd.arrival_delay_hours) AS port_p90_arrival_delay,\n        STDDEV(pchd.arrival_delay_hours) AS port_stddev_arrival_delay,\n        -- Delay rate\n        CASE\n            WHEN COUNT(DISTINCT pchd.port_call_id) > 0 THEN\n                (COUNT(DISTINCT CASE WHEN pchd.arrival_delay_hours > 6 THEN pchd.port_call_id END)::NUMERIC / \n                 COUNT(DISTINCT pchd.port_call_id)::NUMERIC) * 100\n            ELSE 0\n        END AS port_delay_rate_percent,\n        -- Day of week patterns\n        AVG(CASE WHEN pchd.day_of_week = 0 THEN pchd.arrival_delay_hours ELSE NULL END) AS avg_delay_sunday,\n        AVG(CASE WHEN pchd.day_of_week = 1 THEN pchd.arrival_delay_hours ELSE NULL END) AS avg_delay_monday,\n        AVG(CASE WHEN pchd.day_of_week = 2 THEN pchd.arrival_delay_hours ELSE NULL END) AS avg_delay_tuesday,\n        AVG(CASE WHEN pchd.day_of_week = 3 THEN pchd.arrival_delay_hours ELSE NULL END) AS avg_delay_wednesday,\n        AVG(CASE WHEN pchd.day_of_week = 4 THEN pchd.arrival_delay_hours ELSE NULL END) AS avg_delay_thursday,\n        AVG(CASE WHEN pchd.day_of_week = 5 THEN pchd.arrival_delay_hours ELSE NULL END) AS avg_delay_friday,\n        AVG(CASE WHEN pchd.day_of_week = 6 THEN pchd.arrival_delay_hours ELSE NULL END) AS avg_delay_saturday\n    FROM port_call_historical_delays pchd\n    GROUP BY\n        pchd.port_id,\n        pchd.port_name,\n        pchd.port_code,\n        pchd.locode\n),\ncarrier_port_delay_patterns AS (\n    -- Third CTE: Analyze carrier-port delay patterns\n    SELECT\n        pchd.port_id,\n        pchd.port_name,\n        pchd.port_code,\n        pchd.carrier_id,\n        pchd.carrier_name,\n        COUNT(DISTINCT pchd.port_call_id) AS carrier_port_calls,\n        AVG(pchd.arrival_delay_hours) AS carrier_port_avg_delay,\n        PERCENTILE_CONT(0.5) WITHIN GROUP (ORDER BY pchd.arrival_delay_hours) AS carrier_port_median_delay,\n        STDDEV(pchd.arrival_delay_hours) AS carrier_port_stddev_delay,\n        -- Delay rate for this carrier-port combination\n        CASE\n            WHEN COUNT(DISTINCT pchd.port_call_id) > 0 THEN\n                (COUNT(DISTINCT CASE WHEN pchd.arrival_delay_hours > 6 THEN pchd.port_call_id END)::NUMERIC / \n                 COUNT(DISTINCT pchd.port_call_id)::NUMERIC) * 100\n            ELSE 0\n        END AS carrier_port_delay_rate\n    FROM port_call_historical_delays pchd\n    WHERE pchd.carrier_id IS NOT NULL\n    GROUP BY\n        pchd.port_id,\n        pchd.port_name,\n        pchd.port_code,\n        pchd.carrier_id,\n        pchd.carrier_name\n),\ndelay_risk_scoring AS (\n    -- Fourth CTE: Calculate delay risk scores\n    SELECT\n        pds.port_id,\n        pds.port_name,\n        pds.port_code,\n        pds.locode,\n        pds.total_port_calls,\n        pds.port_calls_with_delays,\n        ROUND(CAST(pds.port_avg_arrival_delay AS NUMERIC), 2) AS port_avg_arrival_delay,\n        ROUND(CAST(pds.port_median_arrival_delay AS NUMERIC), 2) AS port_median_arrival_delay,\n        ROUND(CAST(pds.port_p75_arrival_delay AS NUMERIC), 2) AS port_p75_arrival_delay,\n        ROUND(CAST(pds.port_p90_arrival_delay AS NUMERIC), 2) AS port_p90_arrival_delay,\n        ROUND(CAST(pds.port_stddev_arrival_delay AS NUMERIC), 2) AS port_stddev_arrival_delay,\n        ROUND(CAST(pds.port_delay_rate_percent AS NUMERIC), 2) AS port_delay_rate_percent,\n        ROUND(CAST(pds.avg_delay_sunday AS NUMERIC), 2) AS avg_delay_sunday,\n        ROUND(CAST(pds.avg_delay_monday AS NUMERIC), 2) AS avg_delay_monday,\n        ROUND(CAST(pds.avg_delay_tuesday AS NUMERIC), 2) AS avg_delay_tuesday,\n        ROUND(CAST(pds.avg_delay_wednesday AS NUMERIC), 2) AS avg_delay_wednesday,\n        ROUND(CAST(pds.avg_delay_thursday AS NUMERIC), 2) AS avg_delay_thursday,\n        ROUND(CAST(pds.avg_delay_friday AS NUMERIC), 2) AS avg_delay_friday,\n        ROUND(CAST(pds.avg_delay_saturday AS NUMERIC), 2) AS avg_delay_saturday,\n        -- Risk score components\n        -- Delay frequency component (40%)\n        CASE\n            WHEN pds.port_delay_rate_percent >= 50 THEN 40\n            WHEN pds.port_delay_rate_percent >= 30 THEN 30\n            WHEN pds.port_delay_rate_percent >= 20 THEN 20\n            WHEN pds.port_delay_rate_percent >= 10 THEN 10\n            ELSE pds.port_delay_rate_percent * 0.4\n        END AS delay_frequency_score,\n        -- Delay severity component (35%)\n        CASE\n            WHEN pds.port_avg_arrival_delay >= 24 THEN 35\n            WHEN pds.port_avg_arrival_delay >= 12 THEN 28\n            WHEN pds.port_avg_arrival_delay >= 6 THEN 21\n            WHEN pds.port_avg_arrival_delay >= 3 THEN 14\n            WHEN pds.port_avg_arrival_delay >= 0 THEN 7\n            ELSE 0\n        END AS delay_severity_score,\n        -- Delay variability component (25%) - higher stddev = higher risk\n        CASE\n            WHEN pds.port_stddev_arrival_delay >= 12 THEN 25\n            WHEN pds.port_stddev_arrival_delay >= 8 THEN 20\n            WHEN pds.port_stddev_arrival_delay >= 4 THEN 15\n            WHEN pds.port_stddev_arrival_delay >= 2 THEN 10\n            WHEN pds.port_stddev_arrival_delay >= 0 THEN 5\n            ELSE 0\n        END AS delay_variability_score,\n        -- Total risk score\n        (\n            CASE\n                WHEN pds.port_delay_rate_percent >= 50 THEN 40\n                WHEN pds.port_delay_rate_percent >= 30 THEN 30\n                WHEN pds.port_delay_rate_percent >= 20 THEN 20\n                WHEN pds.port_delay_rate_percent >= 10 THEN 10\n                ELSE pds.port_delay_rate_percent * 0.4\n            END +\n            CASE\n                WHEN pds.port_avg_arrival_delay >= 24 THEN 35\n                WHEN pds.port_avg_arrival_delay >= 12 THEN 28\n                WHEN pds.port_avg_arrival_delay >= 6 THEN 21\n                WHEN pds.port_avg_arrival_delay >= 3 THEN 14\n                WHEN pds.port_avg_arrival_delay >= 0 THEN 7\n                ELSE 0\n            END +\n            CASE\n                WHEN pds.port_stddev_arrival_delay >= 12 THEN 25\n                WHEN pds.port_stddev_arrival_delay >= 8 THEN 20\n                WHEN pds.port_stddev_arrival_delay >= 4 THEN 15\n                WHEN pds.port_stddev_arrival_delay >= 2 THEN 10\n                WHEN pds.port_stddev_arrival_delay >= 0 THEN 5\n                ELSE 0\n            END\n        ) AS delay_risk_score\n    FROM port_delay_statistics pds\n),\ndelay_prediction_and_mitigation AS (\n    -- Fifth CTE: Generate predictions and mitigation recommendations\n    SELECT\n        drs.port_id,\n        drs.port_name,\n        drs.port_code,\n        drs.locode,\n        drs.total_port_calls,\n        drs.port_calls_with_delays,\n        drs.port_avg_arrival_delay,\n        drs.port_median_arrival_delay,\n        drs.port_p75_arrival_delay,\n        drs.port_p90_arrival_delay,\n        drs.port_stddev_arrival_delay,\n        drs.port_delay_rate_percent,\n        drs.avg_delay_sunday,\n        drs.avg_delay_monday,\n        drs.avg_delay_tuesday,\n        drs.avg_delay_wednesday,\n        drs.avg_delay_thursday,\n        drs.avg_delay_friday,\n        drs.avg_delay_saturday,\n        ROUND(CAST(drs.delay_frequency_score AS NUMERIC), 2) AS delay_frequency_score,\n        ROUND(CAST(drs.delay_severity_score AS NUMERIC), 2) AS delay_severity_score,\n        ROUND(CAST(drs.delay_variability_score AS NUMERIC), 2) AS delay_variability_score,\n        ROUND(CAST(drs.delay_risk_score AS NUMERIC), 2) AS delay_risk_score,\n        -- Risk classification\n        CASE\n            WHEN drs.delay_risk_score >= 80 THEN 'Very High Risk'\n            WHEN drs.delay_risk_score >= 60 THEN 'High Risk'\n            WHEN drs.delay_risk_score >= 40 THEN 'Moderate Risk'\n            WHEN drs.delay_risk_score >= 20 THEN 'Low Risk'\n            ELSE 'Very Low Risk'\n        END AS risk_classification,\n        -- Predicted delay probability\n        CASE\n            WHEN drs.port_delay_rate_percent >= 50 THEN 'Very High Probability (>50%)'\n            WHEN drs.port_delay_rate_percent >= 30 THEN 'High Probability (30-50%)'\n            WHEN drs.port_delay_rate_percent >= 20 THEN 'Moderate Probability (20-30%)'\n            WHEN drs.port_delay_rate_percent >= 10 THEN 'Low Probability (10-20%)'\n            ELSE 'Very Low Probability (<10%)'\n        END AS delay_probability,\n        -- Worst day prediction\n        CASE\n            WHEN GREATEST(\n                COALESCE(drs.avg_delay_sunday, 0),\n                COALESCE(drs.avg_delay_monday, 0),\n                COALESCE(drs.avg_delay_tuesday, 0),\n                COALESCE(drs.avg_delay_wednesday, 0),\n                COALESCE(drs.avg_delay_thursday, 0),\n                COALESCE(drs.avg_delay_friday, 0),\n                COALESCE(drs.avg_delay_saturday, 0)\n            ) = drs.avg_delay_sunday THEN 'Sunday'\n            WHEN GREATEST(\n                COALESCE(drs.avg_delay_sunday, 0),\n                COALESCE(drs.avg_delay_monday, 0),\n                COALESCE(drs.avg_delay_tuesday, 0),\n                COALESCE(drs.avg_delay_wednesday, 0),\n                COALESCE(drs.avg_delay_thursday, 0),\n                COALESCE(drs.avg_delay_friday, 0),\n                COALESCE(drs.avg_delay_saturday, 0)\n            ) = drs.avg_delay_monday THEN 'Monday'\n            WHEN GREATEST(\n                COALESCE(drs.avg_delay_sunday, 0),\n                COALESCE(drs.avg_delay_monday, 0),\n                COALESCE(drs.avg_delay_tuesday, 0),\n                COALESCE(drs.avg_delay_wednesday, 0),\n                COALESCE(drs.avg_delay_thursday, 0),\n                COALESCE(drs.avg_delay_friday, 0),\n                COALESCE(drs.avg_delay_saturday, 0)\n            ) = drs.avg_delay_tuesday THEN 'Tuesday'\n            WHEN GREATEST(\n                COALESCE(drs.avg_delay_sunday, 0),\n                COALESCE(drs.avg_delay_monday, 0),\n                COALESCE(drs.avg_delay_tuesday, 0),\n                COALESCE(drs.avg_delay_wednesday, 0),\n                COALESCE(drs.avg_delay_thursday, 0),\n                COALESCE(drs.avg_delay_friday, 0),\n                COALESCE(drs.avg_delay_saturday, 0)\n            ) = drs.avg_delay_wednesday THEN 'Wednesday'\n            WHEN GREATEST(\n                COALESCE(drs.avg_delay_sunday, 0),\n                COALESCE(drs.avg_delay_monday, 0),\n                COALESCE(drs.avg_delay_tuesday, 0),\n                COALESCE(drs.avg_delay_wednesday, 0),\n                COALESCE(drs.avg_delay_thursday, 0),\n                COALESCE(drs.avg_delay_friday, 0),\n                COALESCE(drs.avg_delay_saturday, 0)\n            ) = drs.avg_delay_thursday THEN 'Thursday'\n            WHEN GREATEST(\n                COALESCE(drs.avg_delay_sunday, 0),\n                COALESCE(drs.avg_delay_monday, 0),\n                COALESCE(drs.avg_delay_tuesday, 0),\n                COALESCE(drs.avg_delay_wednesday, 0),\n                COALESCE(drs.avg_delay_thursday, 0),\n                COALESCE(drs.avg_delay_friday, 0),\n                COALESCE(drs.avg_delay_saturday, 0)\n            ) = drs.avg_delay_friday THEN 'Friday'\n            ELSE 'Saturday'\n        END AS worst_day_for_delays,\n        -- Mitigation recommendations\n        CASE\n            WHEN drs.delay_risk_score >= 80 THEN 'Implement Contingency Plans - Very High Delay Risk'\n            WHEN drs.delay_risk_score >= 60 THEN 'Add Buffer Time - High Delay Risk'\n            WHEN drs.delay_risk_score >= 40 THEN 'Monitor Closely - Moderate Delay Risk'\n            WHEN drs.delay_risk_score >= 20 THEN 'Standard Operations - Low Delay Risk'\n            ELSE 'Normal Operations - Very Low Delay Risk'\n        END AS mitigation_recommendation\n    FROM delay_risk_scoring drs\n)\nSELECT\n    port_id,\n    port_name,\n    port_code,\n    locode,\n    total_port_calls,\n    port_calls_with_delays,\n    port_avg_arrival_delay,\n    port_median_arrival_delay,\n    port_p75_arrival_delay,\n    port_p90_arrival_delay,\n    port_stddev_arrival_delay,\n    port_delay_rate_percent,\n    avg_delay_sunday,\n    avg_delay_monday,\n    avg_delay_tuesday,\n    avg_delay_wednesday,\n    avg_delay_thursday,\n    avg_delay_friday,\n    avg_delay_saturday,\n    delay_frequency_score,\n    delay_severity_score,\n    delay_variability_score,\n    delay_risk_score,\n    risk_classification,\n    delay_probability,\n    worst_day_for_delays,\n    mitigation_recommendation\nFROM delay_prediction_and_mitigation\nORDER BY delay_risk_score DESC, port_delay_rate_percent DESC\nLIMIT 500;",
      "line_number": 7162
    },
    {
      "number": 22,
      "title": "Carrier Route Profitability Analysis with Revenue Optimization and Cost Efficiency Metrics",
      "description": "Use Case: Financial Analysis - Comprehensive Carrier Route Profitability Analysis for Revenue Optimization Description: Enterprise-level route profitability analysis with multi-level CTE nesting, revenue calculations, cost efficiency metrics, profitability scoring, and advanced window functions. Demonstrates production patterns used by shipping lines for financial analysis. Business Value: Route profitability report showing revenue metrics, cost efficiency, profitability scores, and optimization",
      "complexity": "Deep nested CTEs (7+ levels), revenue calculations, cost analysis, profitability scoring, window functions with multiple frame clauses, efficiency metrics, financial ratios",
      "expected_output": "Route profitability report with revenue metrics, cost efficiency, and profitability optimization recommendations.",
      "sql": "WITH route_revenue_metrics AS (\n    -- First CTE: Calculate route revenue metrics\n    SELECT\n        r.carrier_id,\n        c.carrier_name,\n        s.route_id,\n        r.route_name,\n        r.route_type,\n        DATE_TRUNC('month', s.scheduled_departure) AS sailing_month,\n        DATE_TRUNC('quarter', s.scheduled_departure) AS sailing_quarter,\n        COUNT(DISTINCT s.sailing_id) AS total_sailings,\n        COUNT(DISTINCT CASE WHEN s.status = 'Completed' THEN s.sailing_id END) AS completed_sailings,\n        SUM(s.total_teu) AS total_teu_carried,\n        AVG(s.total_teu) AS avg_teu_per_sailing,\n        AVG(s.capacity_utilization_percent) AS avg_capacity_utilization,\n        AVG(s.transit_days) AS avg_transit_days,\n        AVG(s.distance_nautical_miles) AS avg_distance_nm,\n        -- Estimated revenue (simplified - using capacity utilization and TEU)\n        SUM(s.total_teu * s.capacity_utilization_percent / 100.0) AS estimated_revenue_units,\n        -- Estimated costs (simplified - using distance and transit time)\n        SUM(s.distance_nautical_miles * s.transit_days) AS estimated_cost_units\n    FROM sailings s\n    INNER JOIN routes r ON s.route_id = r.route_id\n    INNER JOIN carriers c ON r.carrier_id = c.carrier_id\n    WHERE s.scheduled_departure >= CURRENT_DATE - INTERVAL '2 years'\n    GROUP BY\n        r.carrier_id,\n        c.carrier_name,\n        s.route_id,\n        r.route_name,\n        r.route_type,\n        DATE_TRUNC('month', s.scheduled_departure),\n        DATE_TRUNC('quarter', s.scheduled_departure)\n),\nroute_cost_efficiency AS (\n    -- Second CTE: Calculate cost efficiency metrics\n    SELECT\n        rrm.carrier_id,\n        rrm.carrier_name,\n        rrm.route_id,\n        rrm.route_name,\n        rrm.route_type,\n        rrm.sailing_month,\n        rrm.sailing_quarter,\n        rrm.total_sailings,\n        rrm.completed_sailings,\n        ROUND(CAST(rrm.total_teu_carried AS NUMERIC), 2) AS total_teu_carried,\n        ROUND(CAST(rrm.avg_teu_per_sailing AS NUMERIC), 2) AS avg_teu_per_sailing,\n        ROUND(CAST(rrm.avg_capacity_utilization AS NUMERIC), 2) AS avg_capacity_utilization,\n        ROUND(CAST(rrm.avg_transit_days AS NUMERIC), 2) AS avg_transit_days,\n        ROUND(CAST(rrm.avg_distance_nm AS NUMERIC), 2) AS avg_distance_nm,\n        ROUND(CAST(rrm.estimated_revenue_units AS NUMERIC), 2) AS estimated_revenue_units,\n        ROUND(CAST(rrm.estimated_cost_units AS NUMERIC), 2) AS estimated_cost_units,\n        -- Revenue per TEU\n        CASE\n            WHEN rrm.total_teu_carried > 0 THEN\n                rrm.estimated_revenue_units / rrm.total_teu_carried\n            ELSE NULL\n        END AS revenue_per_teu,\n        -- Cost per TEU\n        CASE\n            WHEN rrm.total_teu_carried > 0 THEN\n                rrm.estimated_cost_units / rrm.total_teu_carried\n            ELSE NULL\n        END AS cost_per_teu,\n        -- Revenue per nautical mile\n        CASE\n            WHEN rrm.avg_distance_nm > 0 THEN\n                rrm.estimated_revenue_units / (rrm.avg_distance_nm * rrm.total_sailings)\n            ELSE NULL\n        END AS revenue_per_nm,\n        -- Cost per nautical mile\n        CASE\n            WHEN rrm.avg_distance_nm > 0 THEN\n                rrm.estimated_cost_units / (rrm.avg_distance_nm * rrm.total_sailings)\n            ELSE NULL\n        END AS cost_per_nm,\n        -- Profitability ratio (revenue / cost)\n        CASE\n            WHEN rrm.estimated_cost_units > 0 THEN\n                rrm.estimated_revenue_units / rrm.estimated_cost_units\n            ELSE NULL\n        END AS profitability_ratio,\n        -- Completion rate\n        CASE\n            WHEN rrm.total_sailings > 0 THEN\n                (rrm.completed_sailings::NUMERIC / rrm.total_sailings::NUMERIC) * 100\n            ELSE 0\n        END AS completion_rate\n    FROM route_revenue_metrics rrm\n),\nroute_profitability_benchmark AS (\n    -- Third CTE: Calculate profitability benchmarks\n    SELECT\n        rce.carrier_id,\n        rce.carrier_name,\n        rce.route_id,\n        rce.route_name,\n        rce.route_type,\n        rce.sailing_month,\n        rce.sailing_quarter,\n        rce.total_sailings,\n        rce.completed_sailings,\n        rce.total_teu_carried,\n        rce.avg_teu_per_sailing,\n        rce.avg_capacity_utilization,\n        rce.avg_transit_days,\n        rce.avg_distance_nm,\n        rce.estimated_revenue_units,\n        rce.estimated_cost_units,\n        ROUND(CAST(rce.revenue_per_teu AS NUMERIC), 2) AS revenue_per_teu,\n        ROUND(CAST(rce.cost_per_teu AS NUMERIC), 2) AS cost_per_teu,\n        ROUND(CAST(rce.revenue_per_nm AS NUMERIC), 2) AS revenue_per_nm,\n        ROUND(CAST(rce.cost_per_nm AS NUMERIC), 2) AS cost_per_nm,\n        ROUND(CAST(rce.profitability_ratio AS NUMERIC), 2) AS profitability_ratio,\n        ROUND(CAST(rce.completion_rate AS NUMERIC), 2) AS completion_rate,\n        -- Route averages for comparison\n        AVG(rce.profitability_ratio) OVER (PARTITION BY rce.route_id) AS route_avg_profitability,\n        AVG(rce.revenue_per_teu) OVER (PARTITION BY rce.route_id) AS route_avg_revenue_per_teu,\n        AVG(rce.cost_per_teu) OVER (PARTITION BY rce.route_id) AS route_avg_cost_per_teu,\n        -- Market averages\n        AVG(rce.profitability_ratio) OVER () AS market_avg_profitability,\n        AVG(rce.revenue_per_teu) OVER () AS market_avg_revenue_per_teu,\n        AVG(rce.cost_per_teu) OVER () AS market_avg_cost_per_teu,\n        -- Rankings\n        RANK() OVER (PARTITION BY rce.route_id ORDER BY rce.profitability_ratio DESC) AS route_profitability_rank,\n        RANK() OVER (ORDER BY rce.profitability_ratio DESC) AS market_profitability_rank,\n        PERCENT_RANK() OVER (PARTITION BY rce.route_id ORDER BY rce.profitability_ratio) AS route_profitability_percentile,\n        PERCENT_RANK() OVER (ORDER BY rce.profitability_ratio) AS market_profitability_percentile\n    FROM route_cost_efficiency rce\n    WHERE rce.profitability_ratio IS NOT NULL\n),\nprofitability_scoring AS (\n    -- Fourth CTE: Calculate profitability scores\n    SELECT\n        rpb.carrier_id,\n        rpb.carrier_name,\n        rpb.route_id,\n        rpb.route_name,\n        rpb.route_type,\n        rpb.sailing_month,\n        rpb.sailing_quarter,\n        rpb.total_sailings,\n        rpb.completed_sailings,\n        rpb.total_teu_carried,\n        rpb.avg_teu_per_sailing,\n        rpb.avg_capacity_utilization,\n        rpb.avg_transit_days,\n        rpb.avg_distance_nm,\n        rpb.estimated_revenue_units,\n        rpb.estimated_cost_units,\n        rpb.revenue_per_teu,\n        rpb.cost_per_teu,\n        rpb.revenue_per_nm,\n        rpb.cost_per_nm,\n        rpb.profitability_ratio,\n        rpb.completion_rate,\n        ROUND(CAST(rpb.route_avg_profitability AS NUMERIC), 2) AS route_avg_profitability,\n        ROUND(CAST(rpb.route_avg_revenue_per_teu AS NUMERIC), 2) AS route_avg_revenue_per_teu,\n        ROUND(CAST(rpb.route_avg_cost_per_teu AS NUMERIC), 2) AS route_avg_cost_per_teu,\n        ROUND(CAST(rpb.market_avg_profitability AS NUMERIC), 2) AS market_avg_profitability,\n        ROUND(CAST(rpb.market_avg_revenue_per_teu AS NUMERIC), 2) AS market_avg_revenue_per_teu,\n        ROUND(CAST(rpb.market_avg_cost_per_teu AS NUMERIC), 2) AS market_avg_cost_per_teu,\n        rpb.route_profitability_rank,\n        rpb.market_profitability_rank,\n        ROUND(CAST(rpb.route_profitability_percentile * 100 AS NUMERIC), 2) AS route_profitability_percentile,\n        ROUND(CAST(rpb.market_profitability_percentile * 100 AS NUMERIC), 2) AS market_profitability_percentile,\n        -- Profitability score (weighted)\n        (\n            -- Profitability ratio component (40%)\n            CASE\n                WHEN rpb.market_avg_profitability > 0 THEN\n                    LEAST(1.0, (rpb.profitability_ratio / rpb.market_avg_profitability)) * 40\n                ELSE 0\n            END +\n            -- Revenue efficiency component (30%)\n            CASE\n                WHEN rpb.market_avg_revenue_per_teu > 0 THEN\n                    LEAST(1.0, (rpb.revenue_per_teu / rpb.market_avg_revenue_per_teu)) * 30\n                ELSE 0\n            END +\n            -- Cost efficiency component (20%) - inverse (lower cost is better)\n            CASE\n                WHEN rpb.market_avg_cost_per_teu > 0 THEN\n                    GREATEST(0, (1.0 - (rpb.cost_per_teu - rpb.market_avg_cost_per_teu) / rpb.market_avg_cost_per_teu)) * 20\n                ELSE 0\n            END +\n            -- Completion rate component (10%)\n            (rpb.completion_rate / 100.0) * 10\n        ) AS profitability_score\n    FROM route_profitability_benchmark rpb\n),\nprofitability_classification AS (\n    -- Fifth CTE: Classify profitability performance\n    SELECT\n        ps.carrier_id,\n        ps.carrier_name,\n        ps.route_id,\n        ps.route_name,\n        ps.route_type,\n        ps.sailing_month,\n        ps.sailing_quarter,\n        ps.total_sailings,\n        ps.completed_sailings,\n        ps.total_teu_carried,\n        ps.avg_teu_per_sailing,\n        ps.avg_capacity_utilization,\n        ps.avg_transit_days,\n        ps.avg_distance_nm,\n        ps.estimated_revenue_units,\n        ps.estimated_cost_units,\n        ps.revenue_per_teu,\n        ps.cost_per_teu,\n        ps.revenue_per_nm,\n        ps.cost_per_nm,\n        ps.profitability_ratio,\n        ps.completion_rate,\n        ps.route_avg_profitability,\n        ps.route_avg_revenue_per_teu,\n        ps.route_avg_cost_per_teu,\n        ps.market_avg_profitability,\n        ps.market_avg_revenue_per_teu,\n        ps.market_avg_cost_per_teu,\n        ps.route_profitability_rank,\n        ps.market_profitability_rank,\n        ps.route_profitability_percentile,\n        ps.market_profitability_percentile,\n        ROUND(CAST(ps.profitability_score AS NUMERIC), 2) AS profitability_score,\n        -- Profitability classification\n        CASE\n            WHEN ps.profitability_score >= 90 THEN 'Highly Profitable'\n            WHEN ps.profitability_score >= 80 THEN 'Profitable'\n            WHEN ps.profitability_score >= 70 THEN 'Moderately Profitable'\n            WHEN ps.profitability_score >= 60 THEN 'Marginally Profitable'\n            ELSE 'Unprofitable'\n        END AS profitability_class,\n        -- Optimization recommendations\n        CASE\n            WHEN ps.profitability_ratio < ps.route_avg_profitability * 0.8 THEN 'Improve Revenue or Reduce Costs'\n            WHEN ps.revenue_per_teu < ps.route_avg_revenue_per_teu * 0.9 THEN 'Increase Revenue per TEU'\n            WHEN ps.cost_per_teu > ps.route_avg_cost_per_teu * 1.1 THEN 'Reduce Costs per TEU'\n            WHEN ps.avg_capacity_utilization < 70 THEN 'Improve Capacity Utilization'\n            WHEN ps.completion_rate < 90 THEN 'Improve Completion Rate'\n            ELSE 'Route Optimized'\n        END AS optimization_recommendation\n    FROM profitability_scoring ps\n)\nSELECT\n    carrier_id,\n    carrier_name,\n    route_id,\n    route_name,\n    route_type,\n    sailing_month,\n    sailing_quarter,\n    total_sailings,\n    completed_sailings,\n    total_teu_carried,\n    avg_teu_per_sailing,\n    avg_capacity_utilization,\n    avg_transit_days,\n    avg_distance_nm,\n    estimated_revenue_units,\n    estimated_cost_units,\n    revenue_per_teu,\n    cost_per_teu,\n    revenue_per_nm,\n    cost_per_nm,\n    profitability_ratio,\n    completion_rate,\n    route_avg_profitability,\n    route_avg_revenue_per_teu,\n    route_avg_cost_per_teu,\n    market_avg_profitability,\n    market_avg_revenue_per_teu,\n    market_avg_cost_per_teu,\n    route_profitability_rank,\n    market_profitability_rank,\n    route_profitability_percentile,\n    market_profitability_percentile,\n    profitability_score,\n    profitability_class,\n    optimization_recommendation\nFROM profitability_classification\nORDER BY sailing_month DESC, profitability_score DESC\nLIMIT 2000;",
      "line_number": 7522
    },
    {
      "number": 23,
      "title": "Vessel Age and Performance Correlation Analysis with Fleet Modernization Recommendations",
      "description": "Use Case: Fleet Strategy - Comprehensive Vessel Age and Performance Correlation Analysis for Fleet Modernization Description: Enterprise-level vessel age analysis with multi-level CTE nesting, age-performance correlation, fleet modernization scoring, and advanced window functions. Demonstrates production patterns used by shipping lines for fleet strategy. Business Value: Vessel age-performance report showing age correlations, performance degradation patterns, modernization priorities, and fleet ",
      "complexity": "Deep nested CTEs (7+ levels), age calculations, performance correlation analysis, window functions with multiple frame clauses, percentile calculations, modernization scoring, regression-like analysis",
      "expected_output": "Vessel age-performance report with correlations, modernization priorities, and fleet strategy recommendations.",
      "sql": "WITH vessel_age_calculations AS (\n    -- First CTE: Calculate vessel age and performance metrics\n    SELECT\n        ve.vessel_id,\n        ve.vessel_name,\n        ve.imo_number,\n        ve.vessel_type,\n        ve.container_capacity_teu,\n        ve.year_built,\n        EXTRACT(YEAR FROM CURRENT_DATE) - ve.year_built AS vessel_age_years,\n        ve.carrier_id,\n        c.carrier_name,\n        ve.status,\n        -- Performance metrics\n        COUNT(DISTINCT s.sailing_id) AS total_sailings,\n        COUNT(DISTINCT CASE WHEN s.status = 'Completed' THEN s.sailing_id END) AS completed_sailings,\n        AVG(s.capacity_utilization_percent) AS avg_capacity_utilization,\n        AVG(s.transit_days) AS avg_transit_days,\n        -- On-time performance\n        COUNT(DISTINCT CASE \n            WHEN s.actual_arrival IS NOT NULL AND s.scheduled_arrival IS NOT NULL\n                AND EXTRACT(EPOCH FROM (s.actual_arrival - s.scheduled_arrival)) / 3600.0 <= 6 THEN s.sailing_id\n        END) AS on_time_arrivals,\n        -- Port call metrics\n        AVG(CASE \n            WHEN pc.actual_arrival IS NOT NULL AND pc.actual_departure IS NOT NULL THEN\n                EXTRACT(EPOCH FROM (pc.actual_departure - pc.actual_arrival)) / 3600.0\n            ELSE NULL\n        END) AS avg_dwell_time_hours,\n        AVG(CASE \n            WHEN pc.actual_arrival IS NOT NULL AND pc.scheduled_arrival IS NOT NULL THEN\n                EXTRACT(EPOCH FROM (pc.actual_arrival - pc.scheduled_arrival)) / 3600.0\n            ELSE NULL\n        END) AS avg_arrival_delay_hours\n    FROM vessels ve\n    LEFT JOIN carriers c ON ve.carrier_id = c.carrier_id\n    LEFT JOIN sailings s ON ve.vessel_id = s.vessel_id\n    LEFT JOIN port_calls pc ON s.vessel_id = pc.vessel_id AND s.voyage_number = pc.voyage_number\n    WHERE ve.status = 'Active'\n        AND ve.year_built IS NOT NULL\n        AND (s.scheduled_departure IS NULL OR s.scheduled_departure >= CURRENT_DATE - INTERVAL '2 years')\n    GROUP BY\n        ve.vessel_id,\n        ve.vessel_name,\n        ve.imo_number,\n        ve.vessel_type,\n        ve.container_capacity_teu,\n        ve.year_built,\n        ve.carrier_id,\n        c.carrier_name,\n        ve.status\n),\nvessel_age_performance_metrics AS (\n    -- Second CTE: Calculate performance metrics by age\n    SELECT\n        vac.vessel_id,\n        vac.vessel_name,\n        vac.imo_number,\n        vac.vessel_type,\n        vac.container_capacity_teu,\n        vac.year_built,\n        vac.vessel_age_years,\n        vac.carrier_id,\n        vac.carrier_name,\n        vac.status,\n        vac.total_sailings,\n        vac.completed_sailings,\n        ROUND(CAST(vac.avg_capacity_utilization AS NUMERIC), 2) AS avg_capacity_utilization,\n        ROUND(CAST(vac.avg_transit_days AS NUMERIC), 2) AS avg_transit_days,\n        vac.on_time_arrivals,\n        ROUND(CAST(vac.avg_dwell_time_hours AS NUMERIC), 2) AS avg_dwell_time_hours,\n        ROUND(CAST(vac.avg_arrival_delay_hours AS NUMERIC), 2) AS avg_arrival_delay_hours,\n        -- Age group classification\n        CASE\n            WHEN vac.vessel_age_years <= 5 THEN 'New (0-5 years)'\n            WHEN vac.vessel_age_years <= 10 THEN 'Young (6-10 years)'\n            WHEN vac.vessel_age_years <= 15 THEN 'Mid-Age (11-15 years)'\n            WHEN vac.vessel_age_years <= 20 THEN 'Mature (16-20 years)'\n            WHEN vac.vessel_age_years <= 25 THEN 'Old (21-25 years)'\n            ELSE 'Very Old (25+ years)'\n        END AS age_group,\n        -- Completion rate\n        CASE\n            WHEN vac.total_sailings > 0 THEN\n                ROUND(CAST((vac.completed_sailings::NUMERIC / vac.total_sailings::NUMERIC) * 100 AS NUMERIC), 2)\n            ELSE 0\n        END AS completion_rate,\n        -- On-time performance rate\n        CASE\n            WHEN vac.total_sailings > 0 THEN\n                ROUND(CAST((vac.on_time_arrivals::NUMERIC / vac.total_sailings::NUMERIC) * 100 AS NUMERIC), 2)\n            ELSE 0\n        END AS on_time_performance_rate\n    FROM vessel_age_calculations vac\n    WHERE vac.total_sailings > 0\n),\nage_group_benchmarks AS (\n    -- Third CTE: Calculate benchmarks by age group\n    SELECT\n        vapm.vessel_id,\n        vapm.vessel_name,\n        vapm.imo_number,\n        vapm.vessel_type,\n        vapm.container_capacity_teu,\n        vapm.year_built,\n        vapm.vessel_age_years,\n        vapm.carrier_id,\n        vapm.carrier_name,\n        vapm.status,\n        vapm.total_sailings,\n        vapm.completed_sailings,\n        vapm.avg_capacity_utilization,\n        vapm.avg_transit_days,\n        vapm.on_time_arrivals,\n        vapm.avg_dwell_time_hours,\n        vapm.avg_arrival_delay_hours,\n        vapm.age_group,\n        vapm.completion_rate,\n        vapm.on_time_performance_rate,\n        -- Age group averages\n        AVG(vapm.completion_rate) OVER (PARTITION BY vapm.age_group) AS age_group_avg_completion_rate,\n        AVG(vapm.on_time_performance_rate) OVER (PARTITION BY vapm.age_group) AS age_group_avg_on_time_rate,\n        AVG(vapm.avg_capacity_utilization) OVER (PARTITION BY vapm.age_group) AS age_group_avg_capacity_utilization,\n        AVG(vapm.avg_arrival_delay_hours) OVER (PARTITION BY vapm.age_group) AS age_group_avg_arrival_delay,\n        -- Market averages\n        AVG(vapm.completion_rate) OVER () AS market_avg_completion_rate,\n        AVG(vapm.on_time_performance_rate) OVER () AS market_avg_on_time_rate,\n        AVG(vapm.avg_capacity_utilization) OVER () AS market_avg_capacity_utilization,\n        AVG(vapm.avg_arrival_delay_hours) OVER () AS market_avg_arrival_delay,\n        -- Rankings within age group\n        RANK() OVER (PARTITION BY vapm.age_group ORDER BY vapm.completion_rate DESC) AS age_group_completion_rank,\n        RANK() OVER (PARTITION BY vapm.age_group ORDER BY vapm.on_time_performance_rate DESC) AS age_group_on_time_rank,\n        PERCENT_RANK() OVER (PARTITION BY vapm.age_group ORDER BY vapm.completion_rate) AS age_group_completion_percentile\n    FROM vessel_age_performance_metrics vapm\n),\nage_performance_correlation AS (\n    -- Fourth CTE: Analyze age-performance correlation\n    SELECT\n        agb.vessel_id,\n        agb.vessel_name,\n        agb.imo_number,\n        agb.vessel_type,\n        agb.container_capacity_teu,\n        agb.year_built,\n        agb.vessel_age_years,\n        agb.carrier_id,\n        agb.carrier_name,\n        agb.status,\n        agb.total_sailings,\n        agb.completed_sailings,\n        agb.avg_capacity_utilization,\n        agb.avg_transit_days,\n        agb.on_time_arrivals,\n        agb.avg_dwell_time_hours,\n        agb.avg_arrival_delay_hours,\n        agb.age_group,\n        agb.completion_rate,\n        agb.on_time_performance_rate,\n        ROUND(CAST(agb.age_group_avg_completion_rate AS NUMERIC), 2) AS age_group_avg_completion_rate,\n        ROUND(CAST(agb.age_group_avg_on_time_rate AS NUMERIC), 2) AS age_group_avg_on_time_rate,\n        ROUND(CAST(agb.age_group_avg_capacity_utilization AS NUMERIC), 2) AS age_group_avg_capacity_utilization,\n        ROUND(CAST(agb.age_group_avg_arrival_delay AS NUMERIC), 2) AS age_group_avg_arrival_delay,\n        ROUND(CAST(agb.market_avg_completion_rate AS NUMERIC), 2) AS market_avg_completion_rate,\n        ROUND(CAST(agb.market_avg_on_time_rate AS NUMERIC), 2) AS market_avg_on_time_rate,\n        ROUND(CAST(agb.market_avg_capacity_utilization AS NUMERIC), 2) AS market_avg_capacity_utilization,\n        ROUND(CAST(agb.market_avg_arrival_delay AS NUMERIC), 2) AS market_avg_arrival_delay,\n        agb.age_group_completion_rank,\n        agb.age_group_on_time_rank,\n        ROUND(CAST(agb.age_group_completion_percentile * 100 AS NUMERIC), 2) AS age_group_completion_percentile,\n        -- Performance vs age group average\n        CASE\n            WHEN agb.completion_rate > agb.age_group_avg_completion_rate * 1.1 THEN 'Above Age Group Average'\n            WHEN agb.completion_rate > agb.age_group_avg_completion_rate * 0.9 THEN 'At Age Group Average'\n            ELSE 'Below Age Group Average'\n        END AS age_group_performance_class,\n        -- Performance vs market average\n        CASE\n            WHEN agb.completion_rate > agb.market_avg_completion_rate * 1.1 THEN 'Above Market Average'\n            WHEN agb.completion_rate > agb.market_avg_completion_rate * 0.9 THEN 'At Market Average'\n            ELSE 'Below Market Average'\n        END AS market_performance_class,\n        -- Age impact indicator (performance degradation)\n        CASE\n            WHEN agb.vessel_age_years <= 5 AND agb.completion_rate < agb.market_avg_completion_rate THEN 'Underperforming for Age'\n            WHEN agb.vessel_age_years > 20 AND agb.completion_rate > agb.market_avg_completion_rate THEN 'Overperforming for Age'\n            WHEN agb.vessel_age_years > 15 AND agb.completion_rate < agb.age_group_avg_completion_rate THEN 'Age-Related Degradation'\n            ELSE 'Normal Performance for Age'\n        END AS age_impact_indicator\n    FROM age_group_benchmarks agb\n),\nmodernization_priority_scoring AS (\n    -- Fifth CTE: Calculate modernization priority scores\n    SELECT\n        apc.vessel_id,\n        apc.vessel_name,\n        apc.imo_number,\n        apc.vessel_type,\n        apc.container_capacity_teu,\n        apc.year_built,\n        apc.vessel_age_years,\n        apc.carrier_id,\n        apc.carrier_name,\n        apc.status,\n        apc.total_sailings,\n        apc.completed_sailings,\n        apc.avg_capacity_utilization,\n        apc.avg_transit_days,\n        apc.on_time_arrivals,\n        apc.avg_dwell_time_hours,\n        apc.avg_arrival_delay_hours,\n        apc.age_group,\n        apc.completion_rate,\n        apc.on_time_performance_rate,\n        apc.age_group_avg_completion_rate,\n        apc.age_group_avg_on_time_rate,\n        apc.age_group_avg_capacity_utilization,\n        apc.age_group_avg_arrival_delay,\n        apc.market_avg_completion_rate,\n        apc.market_avg_on_time_rate,\n        apc.market_avg_capacity_utilization,\n        apc.market_avg_arrival_delay,\n        apc.age_group_completion_rank,\n        apc.age_group_on_time_rank,\n        apc.age_group_completion_percentile,\n        apc.age_group_performance_class,\n        apc.market_performance_class,\n        apc.age_impact_indicator,\n        -- Modernization priority score (higher = higher priority for replacement)\n        (\n            -- Age component (40%) - older vessels have higher priority\n            CASE\n                WHEN apc.vessel_age_years >= 25 THEN 40\n                WHEN apc.vessel_age_years >= 20 THEN 32\n                WHEN apc.vessel_age_years >= 15 THEN 24\n                WHEN apc.vessel_age_years >= 10 THEN 16\n                WHEN apc.vessel_age_years >= 5 THEN 8\n                ELSE 0\n            END +\n            -- Performance degradation component (35%)\n            CASE\n                WHEN apc.completion_rate < apc.market_avg_completion_rate * 0.8 THEN 35\n                WHEN apc.completion_rate < apc.market_avg_completion_rate * 0.9 THEN 28\n                WHEN apc.completion_rate < apc.market_avg_completion_rate THEN 21\n                WHEN apc.completion_rate < apc.age_group_avg_completion_rate THEN 14\n                ELSE 0\n            END +\n            -- Capacity utilization component (15%)\n            CASE\n                WHEN apc.avg_capacity_utilization < 60 THEN 15\n                WHEN apc.avg_capacity_utilization < 70 THEN 10\n                WHEN apc.avg_capacity_utilization < 80 THEN 5\n                ELSE 0\n            END +\n            -- Delay component (10%)\n            CASE\n                WHEN apc.avg_arrival_delay_hours > 12 THEN 10\n                WHEN apc.avg_arrival_delay_hours > 6 THEN 7\n                WHEN apc.avg_arrival_delay_hours > 3 THEN 4\n                ELSE 0\n            END\n        ) AS modernization_priority_score\n    FROM age_performance_correlation apc\n),\nmodernization_recommendations AS (\n    -- Sixth CTE: Generate modernization recommendations\n    SELECT\n        mps.vessel_id,\n        mps.vessel_name,\n        mps.imo_number,\n        mps.vessel_type,\n        mps.container_capacity_teu,\n        mps.year_built,\n        mps.vessel_age_years,\n        mps.carrier_id,\n        mps.carrier_name,\n        mps.status,\n        mps.total_sailings,\n        mps.completed_sailings,\n        mps.avg_capacity_utilization,\n        mps.avg_transit_days,\n        mps.on_time_arrivals,\n        mps.avg_dwell_time_hours,\n        mps.avg_arrival_delay_hours,\n        mps.age_group,\n        mps.completion_rate,\n        mps.on_time_performance_rate,\n        mps.age_group_avg_completion_rate,\n        mps.age_group_avg_on_time_rate,\n        mps.age_group_avg_capacity_utilization,\n        mps.age_group_avg_arrival_delay,\n        mps.market_avg_completion_rate,\n        mps.market_avg_on_time_rate,\n        mps.market_avg_capacity_utilization,\n        mps.market_avg_arrival_delay,\n        mps.age_group_completion_rank,\n        mps.age_group_on_time_rank,\n        mps.age_group_completion_percentile,\n        mps.age_group_performance_class,\n        mps.market_performance_class,\n        mps.age_impact_indicator,\n        ROUND(CAST(mps.modernization_priority_score AS NUMERIC), 2) AS modernization_priority_score,\n        -- Modernization priority classification\n        CASE\n            WHEN mps.modernization_priority_score >= 70 THEN 'High Priority - Replace Soon'\n            WHEN mps.modernization_priority_score >= 50 THEN 'Medium Priority - Plan Replacement'\n            WHEN mps.modernization_priority_score >= 30 THEN 'Low Priority - Monitor'\n            ELSE 'No Immediate Action'\n        END AS modernization_priority,\n        -- Modernization recommendation\n        CASE\n            WHEN mps.vessel_age_years >= 25 THEN 'Consider Immediate Replacement - Vessel Age Exceeds Optimal'\n            WHEN mps.vessel_age_years >= 20 AND mps.completion_rate < mps.market_avg_completion_rate THEN 'Plan Replacement - Age and Performance Issues'\n            WHEN mps.completion_rate < mps.market_avg_completion_rate * 0.8 THEN 'Consider Replacement - Significant Performance Degradation'\n            WHEN mps.vessel_age_years >= 15 AND mps.avg_capacity_utilization < 70 THEN 'Evaluate Replacement - Age and Low Utilization'\n            ELSE 'Continue Operations - Performance Acceptable'\n        END AS modernization_recommendation\n    FROM modernization_priority_scoring mps\n)\nSELECT\n    vessel_id,\n    vessel_name,\n    imo_number,\n    vessel_type,\n    container_capacity_teu,\n    year_built,\n    vessel_age_years,\n    carrier_id,\n    carrier_name,\n    status,\n    total_sailings,\n    completed_sailings,\n    avg_capacity_utilization,\n    avg_transit_days,\n    on_time_arrivals,\n    avg_dwell_time_hours,\n    avg_arrival_delay_hours,\n    age_group,\n    completion_rate,\n    on_time_performance_rate,\n    age_group_avg_completion_rate,\n    age_group_avg_on_time_rate,\n    age_group_avg_capacity_utilization,\n    age_group_avg_arrival_delay,\n    market_avg_completion_rate,\n    market_avg_on_time_rate,\n    market_avg_capacity_utilization,\n    market_avg_arrival_delay,\n    age_group_completion_rank,\n    age_group_on_time_rank,\n    age_group_completion_percentile,\n    age_group_performance_class,\n    market_performance_class,\n    age_impact_indicator,\n    modernization_priority_score,\n    modernization_priority,\n    modernization_recommendation\nFROM modernization_recommendations\nORDER BY modernization_priority_score DESC, vessel_age_years DESC\nLIMIT 500;",
      "line_number": 7829
    },
    {
      "number": 24,
      "title": "Seasonal Demand Patterns Analysis with Peak Period Identification and Capacity Planning",
      "description": "Use Case: Capacity Planning - Comprehensive Seasonal Demand Patterns Analysis for Capacity Optimization Description: Enterprise-level seasonal demand analysis with multi-level CTE nesting, seasonal pattern detection, peak period identification, capacity planning metrics, and advanced window functions. Demonstrates production patterns used by shipping lines for seasonal capacity planning. Business Value: Seasonal demand report showing demand patterns, peak periods, seasonal trends, and capacity p",
      "complexity": "Deep nested CTEs (7+ levels), seasonal pattern analysis, peak detection, temporal aggregation, window functions with multiple frame clauses, trend analysis, capacity planning metrics",
      "expected_output": "Seasonal demand report with demand patterns, peak periods, and capacity planning recommendations.",
      "sql": "WITH sailing_seasonal_metrics AS (\n    -- First CTE: Extract seasonal metrics from sailings\n    SELECT\n        s.sailing_id,\n        r.carrier_id,\n        c.carrier_name,\n        s.route_id,\n        r.route_name,\n        s.origin_port_id,\n        op.port_name AS origin_port_name,\n        op.country AS origin_country,\n        s.destination_port_id,\n        dp.port_name AS destination_port_name,\n        dp.country AS destination_country,\n        s.scheduled_departure,\n        s.actual_departure,\n        s.status,\n        s.total_teu,\n        s.capacity_utilization_percent,\n        -- Seasonal features\n        EXTRACT(MONTH FROM s.scheduled_departure) AS departure_month,\n        EXTRACT(QUARTER FROM s.scheduled_departure) AS departure_quarter,\n        EXTRACT(YEAR FROM s.scheduled_departure) AS departure_year,\n        EXTRACT(WEEK FROM s.scheduled_departure) AS departure_week,\n        EXTRACT(DOW FROM s.scheduled_departure) AS departure_day_of_week,\n        -- Season classification\n        CASE\n            WHEN EXTRACT(MONTH FROM s.scheduled_departure) IN (12, 1, 2) THEN 'Winter'\n            WHEN EXTRACT(MONTH FROM s.scheduled_departure) IN (3, 4, 5) THEN 'Spring'\n            WHEN EXTRACT(MONTH FROM s.scheduled_departure) IN (6, 7, 8) THEN 'Summer'\n            ELSE 'Fall'\n        END AS season,\n        DATE_TRUNC('month', s.scheduled_departure) AS sailing_month,\n        DATE_TRUNC('quarter', s.scheduled_departure) AS sailing_quarter\n    FROM sailings s\n    INNER JOIN routes r ON s.route_id = r.route_id\n    INNER JOIN carriers c ON r.carrier_id = c.carrier_id\n    LEFT JOIN ports op ON s.origin_port_id = op.port_id\n    LEFT JOIN ports dp ON s.destination_port_id = dp.port_id\n    WHERE s.scheduled_departure >= CURRENT_DATE - INTERVAL '2 years'\n),\nmonthly_demand_aggregation AS (\n    -- Second CTE: Aggregate demand by month\n    SELECT\n        ssm.carrier_id,\n        ssm.carrier_name,\n        ssm.route_id,\n        ssm.route_name,\n        ssm.origin_port_id,\n        ssm.origin_port_name,\n        ssm.origin_country,\n        ssm.destination_port_id,\n        ssm.destination_port_name,\n        ssm.destination_country,\n        ssm.departure_month,\n        ssm.departure_quarter,\n        ssm.departure_year,\n        ssm.season,\n        ssm.sailing_month,\n        ssm.sailing_quarter,\n        COUNT(DISTINCT ssm.sailing_id) AS monthly_sailings,\n        COUNT(DISTINCT CASE WHEN ssm.status = 'Completed' THEN ssm.sailing_id END) AS monthly_completed_sailings,\n        SUM(ssm.total_teu) AS monthly_total_teu,\n        AVG(ssm.total_teu) AS monthly_avg_teu_per_sailing,\n        AVG(ssm.capacity_utilization_percent) AS monthly_avg_capacity_utilization,\n        PERCENTILE_CONT(0.5) WITHIN GROUP (ORDER BY ssm.total_teu) AS monthly_median_teu,\n        PERCENTILE_CONT(0.75) WITHIN GROUP (ORDER BY ssm.total_teu) AS monthly_p75_teu,\n        STDDEV(ssm.total_teu) AS monthly_stddev_teu\n    FROM sailing_seasonal_metrics ssm\n    GROUP BY\n        ssm.carrier_id,\n        ssm.carrier_name,\n        ssm.route_id,\n        ssm.route_name,\n        ssm.origin_port_id,\n        ssm.origin_port_name,\n        ssm.origin_country,\n        ssm.destination_port_id,\n        ssm.destination_port_name,\n        ssm.destination_country,\n        ssm.departure_month,\n        ssm.departure_quarter,\n        ssm.departure_year,\n        ssm.season,\n        ssm.sailing_month,\n        ssm.sailing_quarter\n),\nseasonal_pattern_analysis AS (\n    -- Third CTE: Analyze seasonal patterns\n    SELECT\n        mda.carrier_id,\n        mda.carrier_name,\n        mda.route_id,\n        mda.route_name,\n        mda.origin_port_id,\n        mda.origin_port_name,\n        mda.origin_country,\n        mda.destination_port_id,\n        mda.destination_port_name,\n        mda.destination_country,\n        mda.departure_month,\n        mda.departure_quarter,\n        mda.departure_year,\n        mda.season,\n        mda.sailing_month,\n        mda.sailing_quarter,\n        mda.monthly_sailings,\n        mda.monthly_completed_sailings,\n        ROUND(CAST(mda.monthly_total_teu AS NUMERIC), 2) AS monthly_total_teu,\n        ROUND(CAST(mda.monthly_avg_teu_per_sailing AS NUMERIC), 2) AS monthly_avg_teu_per_sailing,\n        ROUND(CAST(mda.monthly_avg_capacity_utilization AS NUMERIC), 2) AS monthly_avg_capacity_utilization,\n        ROUND(CAST(mda.monthly_median_teu AS NUMERIC), 2) AS monthly_median_teu,\n        ROUND(CAST(mda.monthly_p75_teu AS NUMERIC), 2) AS monthly_p75_teu,\n        ROUND(CAST(mda.monthly_stddev_teu AS NUMERIC), 2) AS monthly_stddev_teu,\n        -- Seasonal averages\n        AVG(mda.monthly_total_teu) OVER (PARTITION BY mda.route_id, mda.season) AS seasonal_avg_teu,\n        AVG(mda.monthly_total_teu) OVER (PARTITION BY mda.route_id) AS route_avg_monthly_teu,\n        AVG(mda.monthly_total_teu) OVER () AS market_avg_monthly_teu,\n        -- Year-over-year comparison\n        LAG(mda.monthly_total_teu, 12) OVER (\n            PARTITION BY mda.route_id, mda.departure_month\n            ORDER BY mda.sailing_month\n        ) AS prev_year_monthly_teu,\n        -- Seasonal index (demand vs average)\n        CASE\n            WHEN AVG(mda.monthly_total_teu) OVER (PARTITION BY mda.route_id) > 0 THEN\n                (mda.monthly_total_teu / AVG(mda.monthly_total_teu) OVER (PARTITION BY mda.route_id)) * 100\n            ELSE NULL\n        END AS seasonal_index\n    FROM monthly_demand_aggregation mda\n),\npeak_period_identification AS (\n    -- Fourth CTE: Identify peak periods\n    SELECT\n        spa.carrier_id,\n        spa.carrier_name,\n        spa.route_id,\n        spa.route_name,\n        spa.origin_port_id,\n        spa.origin_port_name,\n        spa.origin_country,\n        spa.destination_port_id,\n        spa.destination_port_name,\n        spa.destination_country,\n        spa.departure_month,\n        spa.departure_quarter,\n        spa.departure_year,\n        spa.season,\n        spa.sailing_month,\n        spa.sailing_quarter,\n        spa.monthly_sailings,\n        spa.monthly_completed_sailings,\n        spa.monthly_total_teu,\n        spa.monthly_avg_teu_per_sailing,\n        spa.monthly_avg_capacity_utilization,\n        spa.monthly_median_teu,\n        spa.monthly_p75_teu,\n        spa.monthly_stddev_teu,\n        ROUND(CAST(spa.seasonal_avg_teu AS NUMERIC), 2) AS seasonal_avg_teu,\n        ROUND(CAST(spa.route_avg_monthly_teu AS NUMERIC), 2) AS route_avg_monthly_teu,\n        ROUND(CAST(spa.market_avg_monthly_teu AS NUMERIC), 2) AS market_avg_monthly_teu,\n        spa.prev_year_monthly_teu,\n        ROUND(CAST(spa.seasonal_index AS NUMERIC), 2) AS seasonal_index,\n        -- Year-over-year growth\n        CASE\n            WHEN spa.prev_year_monthly_teu IS NOT NULL AND spa.prev_year_monthly_teu > 0 THEN\n                ((spa.monthly_total_teu - spa.prev_year_monthly_teu) / spa.prev_year_monthly_teu) * 100\n            ELSE NULL\n        END AS yoy_growth_percent,\n        -- Peak period classification\n        CASE\n            WHEN spa.seasonal_index >= 120 THEN 'Peak Period'\n            WHEN spa.seasonal_index >= 110 THEN 'High Demand'\n            WHEN spa.seasonal_index >= 90 THEN 'Normal Demand'\n            WHEN spa.seasonal_index >= 80 THEN 'Low Demand'\n            ELSE 'Very Low Demand'\n        END AS demand_classification,\n        -- Peak month ranking\n        RANK() OVER (\n            PARTITION BY spa.route_id, spa.departure_year\n            ORDER BY spa.monthly_total_teu DESC\n        ) AS peak_month_rank\n    FROM seasonal_pattern_analysis spa\n),\ncapacity_planning_recommendations AS (\n    -- Fifth CTE: Generate capacity planning recommendations\n    SELECT\n        ppi.carrier_id,\n        ppi.carrier_name,\n        ppi.route_id,\n        ppi.route_name,\n        ppi.origin_port_id,\n        ppi.origin_port_name,\n        ppi.origin_country,\n        ppi.destination_port_id,\n        ppi.destination_port_name,\n        ppi.destination_country,\n        ppi.departure_month,\n        ppi.departure_quarter,\n        ppi.departure_year,\n        ppi.season,\n        ppi.sailing_month,\n        ppi.sailing_quarter,\n        ppi.monthly_sailings,\n        ppi.monthly_completed_sailings,\n        ppi.monthly_total_teu,\n        ppi.monthly_avg_teu_per_sailing,\n        ppi.monthly_avg_capacity_utilization,\n        ppi.monthly_median_teu,\n        ppi.monthly_p75_teu,\n        ppi.monthly_stddev_teu,\n        ppi.seasonal_avg_teu,\n        ppi.route_avg_monthly_teu,\n        ppi.market_avg_monthly_teu,\n        ppi.prev_year_monthly_teu,\n        ppi.seasonal_index,\n        ROUND(CAST(ppi.yoy_growth_percent AS NUMERIC), 2) AS yoy_growth_percent,\n        ppi.demand_classification,\n        ppi.peak_month_rank,\n        -- Capacity planning recommendations\n        CASE\n            WHEN ppi.seasonal_index >= 120 AND ppi.monthly_avg_capacity_utilization >= 90 THEN 'Increase Capacity - Peak Period with High Utilization'\n            WHEN ppi.seasonal_index >= 110 AND ppi.monthly_avg_capacity_utilization >= 85 THEN 'Consider Capacity Increase - High Demand Period'\n            WHEN ppi.seasonal_index <= 80 AND ppi.monthly_avg_capacity_utilization < 60 THEN 'Reduce Capacity - Low Demand Period'\n            WHEN ppi.yoy_growth_percent > 15 THEN 'Plan for Growth - Significant Year-over-Year Increase'\n            ELSE 'Maintain Current Capacity'\n        END AS capacity_planning_recommendation,\n        -- Expected capacity requirement (based on trend)\n        CASE\n            WHEN ppi.yoy_growth_percent IS NOT NULL AND ppi.yoy_growth_percent > 0 THEN\n                ppi.monthly_total_teu * (1 + ppi.yoy_growth_percent / 100.0)\n            ELSE ppi.monthly_total_teu\n        END AS projected_next_year_demand\n    FROM peak_period_identification ppi\n)\nSELECT\n    carrier_id,\n    carrier_name,\n    route_id,\n    route_name,\n    origin_port_id,\n    origin_port_name,\n    origin_country,\n    destination_port_id,\n    destination_port_name,\n    destination_country,\n    departure_month,\n    departure_quarter,\n    departure_year,\n    season,\n    sailing_month,\n    sailing_quarter,\n    monthly_sailings,\n    monthly_completed_sailings,\n    monthly_total_teu,\n    monthly_avg_teu_per_sailing,\n    monthly_avg_capacity_utilization,\n    monthly_median_teu,\n    monthly_p75_teu,\n    monthly_stddev_teu,\n    seasonal_avg_teu,\n    route_avg_monthly_teu,\n    market_avg_monthly_teu,\n    prev_year_monthly_teu,\n    seasonal_index,\n    yoy_growth_percent,\n    demand_classification,\n    peak_month_rank,\n    capacity_planning_recommendation,\n    ROUND(CAST(projected_next_year_demand AS NUMERIC), 2) AS projected_next_year_demand\nFROM capacity_planning_recommendations\nORDER BY sailing_month DESC, seasonal_index DESC\nLIMIT 2000;",
      "line_number": 8209
    },
    {
      "number": 25,
      "title": "Port Infrastructure Utilization Analysis with Resource Optimization and Throughput Efficiency",
      "description": "Use Case: Port Operations - Comprehensive Port Infrastructure Utilization Analysis for Resource Optimization Description: Enterprise-level port infrastructure analysis with multi-level CTE nesting, infrastructure utilization calculations, resource optimization, throughput efficiency metrics, and advanced window functions. Demonstrates production patterns used by port operators for infrastructure optimization. Business Value: Port infrastructure report showing utilization rates, resource efficien",
      "complexity": "Deep nested CTEs (7+ levels), infrastructure utilization calculations, resource efficiency analysis, window functions with multiple frame clauses, throughput metrics, bottleneck detection",
      "expected_output": "Port infrastructure report with utilization rates, resource efficiency, and optimization recommendations.",
      "sql": "WITH port_infrastructure_metrics AS (\n    -- First CTE: Aggregate port infrastructure usage\n    SELECT\n        p.port_id,\n        p.port_name,\n        p.port_code,\n        p.locode,\n        p.country,\n        p.berth_count,\n        p.container_capacity_teu AS annual_container_capacity_teu,\n        pc.port_call_id,\n        pc.vessel_id,\n        ve.vessel_name,\n        ve.container_capacity_teu AS vessel_capacity_teu,\n        pc.scheduled_arrival,\n        pc.actual_arrival,\n        pc.scheduled_departure,\n        pc.actual_departure,\n        pc.status AS port_call_status,\n        COALESCE(pc.containers_loaded, 0) + COALESCE(pc.containers_discharged, 0) + COALESCE(pc.containers_transshipped, 0) AS total_containers,\n        pc.containers_loaded,\n        pc.containers_discharged,\n        pc.containers_transshipped,\n        -- Time period for aggregation\n        DATE_TRUNC('day', COALESCE(pc.actual_arrival, pc.scheduled_arrival)) AS port_call_date,\n        DATE_TRUNC('week', COALESCE(pc.actual_arrival, pc.scheduled_arrival)) AS port_call_week,\n        DATE_TRUNC('month', COALESCE(pc.actual_arrival, pc.scheduled_arrival)) AS port_call_month,\n        -- Dwell time\n        CASE\n            WHEN pc.actual_arrival IS NOT NULL AND pc.actual_departure IS NOT NULL THEN\n                EXTRACT(EPOCH FROM (pc.actual_departure - pc.actual_arrival)) / 3600.0\n            ELSE NULL\n        END AS dwell_time_hours\n    FROM ports p\n    LEFT JOIN port_calls pc ON p.port_id = pc.port_id\n    LEFT JOIN vessels ve ON pc.vessel_id = ve.vessel_id\n    WHERE COALESCE(pc.actual_arrival, pc.scheduled_arrival) >= CURRENT_DATE - INTERVAL '2 years'\n        OR pc.actual_arrival IS NULL\n),\ndaily_infrastructure_utilization AS (\n    -- Second CTE: Calculate daily infrastructure utilization\n    SELECT\n        pim.port_id,\n        pim.port_name,\n        pim.port_code,\n        pim.locode,\n        pim.country,\n        pim.berth_count,\n        pim.annual_container_capacity_teu,\n        pim.port_call_date,\n        COUNT(DISTINCT pim.port_call_id) AS daily_port_calls,\n        COUNT(DISTINCT CASE \n            WHEN pim.actual_arrival IS NOT NULL AND pim.actual_departure IS NOT NULL THEN pim.port_call_id\n        END) AS daily_active_berths,\n        SUM(pim.total_containers) AS daily_total_containers,\n        SUM(pim.containers_loaded) AS daily_containers_loaded,\n        SUM(pim.containers_discharged) AS daily_containers_discharged,\n        SUM(pim.containers_transshipped) AS daily_containers_transshipped,\n        AVG(pim.dwell_time_hours) AS avg_dwell_time_hours,\n        PERCENTILE_CONT(0.5) WITHIN GROUP (ORDER BY pim.dwell_time_hours) AS median_dwell_time_hours,\n        PERCENTILE_CONT(0.75) WITHIN GROUP (ORDER BY pim.dwell_time_hours) AS p75_dwell_time_hours,\n        PERCENTILE_CONT(0.9) WITHIN GROUP (ORDER BY pim.dwell_time_hours) AS p90_dwell_time_hours,\n        MAX(pim.dwell_time_hours) AS max_dwell_time_hours,\n        -- Vessel capacity utilization\n        SUM(pim.vessel_capacity_teu) AS total_vessel_capacity_teu,\n        AVG(pim.vessel_capacity_teu) AS avg_vessel_capacity_teu\n    FROM port_infrastructure_metrics pim\n    GROUP BY\n        pim.port_id,\n        pim.port_name,\n        pim.port_code,\n        pim.locode,\n        pim.country,\n        pim.berth_count,\n        pim.annual_container_capacity_teu,\n        pim.port_call_date\n),\ninfrastructure_efficiency_calculations AS (\n    -- Third CTE: Calculate infrastructure efficiency metrics\n    SELECT\n        diu.port_id,\n        diu.port_name,\n        diu.port_code,\n        diu.locode,\n        diu.country,\n        diu.berth_count,\n        diu.annual_container_capacity_teu,\n        diu.port_call_date,\n        diu.daily_port_calls,\n        diu.daily_active_berths,\n        ROUND(CAST(diu.daily_total_containers AS NUMERIC), 0) AS daily_total_containers,\n        ROUND(CAST(diu.daily_containers_loaded AS NUMERIC), 0) AS daily_containers_loaded,\n        ROUND(CAST(diu.daily_containers_discharged AS NUMERIC), 0) AS daily_containers_discharged,\n        ROUND(CAST(diu.daily_containers_transshipped AS NUMERIC), 0) AS daily_containers_transshipped,\n        ROUND(CAST(diu.avg_dwell_time_hours AS NUMERIC), 2) AS avg_dwell_time_hours,\n        ROUND(CAST(diu.median_dwell_time_hours AS NUMERIC), 2) AS median_dwell_time_hours,\n        ROUND(CAST(diu.p75_dwell_time_hours AS NUMERIC), 2) AS p75_dwell_time_hours,\n        ROUND(CAST(diu.p90_dwell_time_hours AS NUMERIC), 2) AS p90_dwell_time_hours,\n        ROUND(CAST(diu.max_dwell_time_hours AS NUMERIC), 2) AS max_dwell_time_hours,\n        ROUND(CAST(diu.total_vessel_capacity_teu AS NUMERIC), 0) AS total_vessel_capacity_teu,\n        ROUND(CAST(diu.avg_vessel_capacity_teu AS NUMERIC), 2) AS avg_vessel_capacity_teu,\n        -- Berth utilization rate\n        CASE\n            WHEN diu.berth_count > 0 THEN\n                ROUND(CAST((diu.daily_active_berths::NUMERIC / diu.berth_count::NUMERIC) * 100 AS NUMERIC), 2)\n            ELSE NULL\n        END AS berth_utilization_percent,\n        -- Daily capacity utilization\n        CASE\n            WHEN diu.annual_container_capacity_teu > 0 THEN\n                ROUND(CAST((diu.daily_total_containers::NUMERIC / (diu.annual_container_capacity_teu::NUMERIC / 365.0)) * 100 AS NUMERIC), 2)\n            ELSE NULL\n        END AS daily_capacity_utilization_percent,\n        -- Containers per berth per day\n        CASE\n            WHEN diu.daily_active_berths > 0 THEN\n                diu.daily_total_containers / diu.daily_active_berths\n            ELSE NULL\n        END AS containers_per_berth_per_day,\n        -- Containers per hour (throughput rate)\n        CASE\n            WHEN diu.avg_dwell_time_hours > 0 THEN\n                diu.daily_total_containers / diu.avg_dwell_time_hours\n            ELSE NULL\n        END AS containers_per_hour,\n        -- Moving averages\n        AVG(diu.daily_total_containers) OVER (\n            PARTITION BY diu.port_id\n            ORDER BY diu.port_call_date\n            ROWS BETWEEN 6 PRECEDING AND CURRENT ROW\n        ) AS moving_avg_daily_containers_7_day,\n        AVG(diu.daily_active_berths) OVER (\n            PARTITION BY diu.port_id\n            ORDER BY diu.port_call_date\n            ROWS BETWEEN 6 PRECEDING AND CURRENT ROW\n        ) AS moving_avg_active_berths_7_day,\n        AVG(diu.avg_dwell_time_hours) OVER (\n            PARTITION BY diu.port_id\n            ORDER BY diu.port_call_date\n            ROWS BETWEEN 6 PRECEDING AND CURRENT ROW\n        ) AS moving_avg_dwell_time_7_day\n    FROM daily_infrastructure_utilization diu\n),\ninfrastructure_bottleneck_analysis AS (\n    -- Fourth CTE: Analyze infrastructure bottlenecks\n    SELECT\n        iec.port_id,\n        iec.port_name,\n        iec.port_code,\n        iec.locode,\n        iec.country,\n        iec.berth_count,\n        iec.annual_container_capacity_teu,\n        iec.port_call_date,\n        iec.daily_port_calls,\n        iec.daily_active_berths,\n        iec.daily_total_containers,\n        iec.daily_containers_loaded,\n        iec.daily_containers_discharged,\n        iec.daily_containers_transshipped,\n        iec.avg_dwell_time_hours,\n        iec.median_dwell_time_hours,\n        iec.p75_dwell_time_hours,\n        iec.p90_dwell_time_hours,\n        iec.max_dwell_time_hours,\n        iec.total_vessel_capacity_teu,\n        iec.avg_vessel_capacity_teu,\n        iec.berth_utilization_percent,\n        iec.daily_capacity_utilization_percent,\n        ROUND(CAST(iec.containers_per_berth_per_day AS NUMERIC), 2) AS containers_per_berth_per_day,\n        ROUND(CAST(iec.containers_per_hour AS NUMERIC), 2) AS containers_per_hour,\n        ROUND(CAST(iec.moving_avg_daily_containers_7_day AS NUMERIC), 0) AS moving_avg_daily_containers_7_day,\n        ROUND(CAST(iec.moving_avg_active_berths_7_day AS NUMERIC), 2) AS moving_avg_active_berths_7_day,\n        ROUND(CAST(iec.moving_avg_dwell_time_7_day AS NUMERIC), 2) AS moving_avg_dwell_time_7_day,\n        -- Bottleneck indicators\n        CASE\n            WHEN iec.berth_utilization_percent >= 90 THEN 'Berth Bottleneck'\n            WHEN iec.daily_capacity_utilization_percent >= 100 THEN 'Capacity Bottleneck'\n            WHEN iec.avg_dwell_time_hours > iec.moving_avg_dwell_time_7_day * 1.2 THEN 'Dwell Time Bottleneck'\n            WHEN iec.containers_per_hour < AVG(iec.containers_per_hour) OVER (PARTITION BY iec.port_id) * 0.8 THEN 'Throughput Bottleneck'\n            ELSE 'No Significant Bottleneck'\n        END AS bottleneck_type,\n        -- Infrastructure stress level\n        CASE\n            WHEN iec.berth_utilization_percent >= 90 AND iec.daily_capacity_utilization_percent >= 100 THEN 'Critical Stress'\n            WHEN iec.berth_utilization_percent >= 80 OR iec.daily_capacity_utilization_percent >= 90 THEN 'High Stress'\n            WHEN iec.berth_utilization_percent >= 70 OR iec.daily_capacity_utilization_percent >= 80 THEN 'Moderate Stress'\n            WHEN iec.berth_utilization_percent >= 60 OR iec.daily_capacity_utilization_percent >= 70 THEN 'Low Stress'\n            ELSE 'Normal Operations'\n        END AS infrastructure_stress_level,\n        -- Efficiency score\n        (\n            -- Berth utilization component (30%)\n            COALESCE(iec.berth_utilization_percent / 100.0 * 30, 0) +\n            -- Capacity utilization component (25%)\n            CASE\n                WHEN iec.daily_capacity_utilization_percent IS NOT NULL THEN\n                    LEAST(1.0, iec.daily_capacity_utilization_percent / 100.0) * 25\n                ELSE 0\n            END +\n            -- Throughput efficiency component (25%) - containers per hour\n            CASE\n                WHEN AVG(iec.containers_per_hour) OVER (PARTITION BY iec.port_id) > 0 THEN\n                    LEAST(1.0, iec.containers_per_hour / AVG(iec.containers_per_hour) OVER (PARTITION BY iec.port_id)) * 25\n                ELSE 0\n            END +\n            -- Dwell time efficiency component (20%) - inverse (lower is better)\n            CASE\n                WHEN iec.avg_dwell_time_hours IS NOT NULL THEN\n                    GREATEST(0, (1.0 - (iec.avg_dwell_time_hours - 24) / 48.0)) * 20\n                ELSE 0\n            END\n        ) AS infrastructure_efficiency_score\n    FROM infrastructure_efficiency_calculations iec\n),\ninfrastructure_optimization_recommendations AS (\n    -- Fifth CTE: Generate optimization recommendations\n    SELECT\n        iba.port_id,\n        iba.port_name,\n        iba.port_code,\n        iba.locode,\n        iba.country,\n        iba.berth_count,\n        iba.annual_container_capacity_teu,\n        iba.port_call_date,\n        iba.daily_port_calls,\n        iba.daily_active_berths,\n        iba.daily_total_containers,\n        iba.daily_containers_loaded,\n        iba.daily_containers_discharged,\n        iba.daily_containers_transshipped,\n        iba.avg_dwell_time_hours,\n        iba.median_dwell_time_hours,\n        iba.p75_dwell_time_hours,\n        iba.p90_dwell_time_hours,\n        iba.max_dwell_time_hours,\n        iba.total_vessel_capacity_teu,\n        iba.avg_vessel_capacity_teu,\n        iba.berth_utilization_percent,\n        iba.daily_capacity_utilization_percent,\n        iba.containers_per_berth_per_day,\n        iba.containers_per_hour,\n        iba.moving_avg_daily_containers_7_day,\n        iba.moving_avg_active_berths_7_day,\n        iba.moving_avg_dwell_time_7_day,\n        iba.bottleneck_type,\n        iba.infrastructure_stress_level,\n        ROUND(CAST(iba.infrastructure_efficiency_score AS NUMERIC), 2) AS infrastructure_efficiency_score,\n        -- Optimization recommendations\n        CASE\n            WHEN iba.bottleneck_type = 'Berth Bottleneck' THEN 'Add Berths or Optimize Berth Allocation'\n            WHEN iba.bottleneck_type = 'Capacity Bottleneck' THEN 'Expand Capacity or Optimize Operations'\n            WHEN iba.bottleneck_type = 'Dwell Time Bottleneck' THEN 'Improve Cargo Handling Efficiency'\n            WHEN iba.bottleneck_type = 'Throughput Bottleneck' THEN 'Increase Throughput Rate - Review Operations'\n            WHEN iba.berth_utilization_percent < 50 AND iba.daily_total_containers > 0 THEN 'Optimize Berth Allocation - Underutilized'\n            ELSE 'Infrastructure Operating Efficiently'\n        END AS optimization_recommendation\n    FROM infrastructure_bottleneck_analysis iba\n)\nSELECT\n    port_id,\n    port_name,\n    port_code,\n    locode,\n    country,\n    berth_count,\n    annual_container_capacity_teu,\n    port_call_date,\n    daily_port_calls,\n    daily_active_berths,\n    daily_total_containers,\n    daily_containers_loaded,\n    daily_containers_discharged,\n    daily_containers_transshipped,\n    avg_dwell_time_hours,\n    median_dwell_time_hours,\n    p75_dwell_time_hours,\n    p90_dwell_time_hours,\n    max_dwell_time_hours,\n    total_vessel_capacity_teu,\n    avg_vessel_capacity_teu,\n    berth_utilization_percent,\n    daily_capacity_utilization_percent,\n    containers_per_berth_per_day,\n    containers_per_hour,\n    moving_avg_daily_containers_7_day,\n    moving_avg_active_berths_7_day,\n    moving_avg_dwell_time_7_day,\n    bottleneck_type,\n    infrastructure_stress_level,\n    infrastructure_efficiency_score,\n    optimization_recommendation\nFROM infrastructure_optimization_recommendations\nORDER BY port_call_date DESC, infrastructure_efficiency_score DESC\nLIMIT 2000;",
      "line_number": 8503
    },
    {
      "number": 26,
      "title": "Transit Time Variability Analysis with Reliability Scoring and Schedule Predictability",
      "description": "Use Case: Service Reliability - Comprehensive Transit Time Variability Analysis for Schedule Predictability Description: Enterprise-level transit time variability analysis with multi-level CTE nesting, variability calculations, reliability scoring, schedule predictability metrics, and advanced window functions. Demonstrates production patterns used by shipping lines for service reliability. Business Value: Transit time variability report showing variability patterns, reliability scores, schedule",
      "complexity": "Deep nested CTEs (7+ levels), variability calculations, reliability scoring, window functions with multiple frame clauses, percentile calculations, predictability metrics, statistical analysis",
      "expected_output": "Transit time variability report with reliability scores, schedule predictability, and optimization recommendations.",
      "sql": "WITH sailing_transit_time_metrics AS (\n    -- First CTE: Calculate transit times for sailings\n    SELECT\n        s.sailing_id,\n        r.carrier_id,\n        c.carrier_name,\n        s.route_id,\n        r.route_name,\n        s.origin_port_id,\n        op.port_name AS origin_port_name,\n        s.destination_port_id,\n        dp.port_name AS destination_port_name,\n        s.scheduled_departure,\n        s.actual_departure,\n        s.scheduled_arrival,\n        s.actual_arrival,\n        s.status,\n        s.transit_days AS scheduled_transit_days,\n        -- Actual transit time (days)\n        CASE\n            WHEN s.actual_departure IS NOT NULL AND s.actual_arrival IS NOT NULL THEN\n                EXTRACT(EPOCH FROM (s.actual_arrival - s.actual_departure)) / 86400.0\n            ELSE NULL\n        END AS actual_transit_days,\n        -- Scheduled transit time (days)\n        CASE\n            WHEN s.scheduled_departure IS NOT NULL AND s.scheduled_arrival IS NOT NULL THEN\n                EXTRACT(EPOCH FROM (s.scheduled_arrival - s.scheduled_departure)) / 86400.0\n            ELSE NULL\n        END AS calculated_scheduled_transit_days,\n        -- Transit time variance\n        CASE\n            WHEN s.actual_departure IS NOT NULL AND s.actual_arrival IS NOT NULL\n                AND s.scheduled_departure IS NOT NULL AND s.scheduled_arrival IS NOT NULL THEN\n                (EXTRACT(EPOCH FROM (s.actual_arrival - s.actual_departure)) / 86400.0) -\n                (EXTRACT(EPOCH FROM (s.scheduled_arrival - s.scheduled_departure)) / 86400.0)\n            ELSE NULL\n        END AS transit_time_variance_days,\n        DATE_TRUNC('month', s.scheduled_departure) AS sailing_month,\n        DATE_TRUNC('quarter', s.scheduled_departure) AS sailing_quarter\n    FROM sailings s\n    INNER JOIN routes r ON s.route_id = r.route_id\n    INNER JOIN carriers c ON r.carrier_id = c.carrier_id\n    LEFT JOIN ports op ON s.origin_port_id = op.port_id\n    LEFT JOIN ports dp ON s.destination_port_id = dp.port_id\n    WHERE s.scheduled_departure >= CURRENT_DATE - INTERVAL '2 years'\n        AND s.status = 'Completed'\n),\nroute_transit_time_statistics AS (\n    -- Second CTE: Calculate transit time statistics by route\n    SELECT\n        sttm.carrier_id,\n        sttm.carrier_name,\n        sttm.route_id,\n        sttm.route_name,\n        sttm.origin_port_id,\n        sttm.origin_port_name,\n        sttm.destination_port_id,\n        sttm.destination_port_name,\n        sttm.sailing_month,\n        sttm.sailing_quarter,\n        COUNT(DISTINCT sttm.sailing_id) AS total_sailings,\n        AVG(sttm.actual_transit_days) AS avg_actual_transit_days,\n        AVG(sttm.calculated_scheduled_transit_days) AS avg_scheduled_transit_days,\n        AVG(sttm.transit_time_variance_days) AS avg_transit_time_variance,\n        PERCENTILE_CONT(0.5) WITHIN GROUP (ORDER BY sttm.actual_transit_days) AS median_actual_transit_days,\n        PERCENTILE_CONT(0.25) WITHIN GROUP (ORDER BY sttm.actual_transit_days) AS q1_actual_transit_days,\n        PERCENTILE_CONT(0.75) WITHIN GROUP (ORDER BY sttm.actual_transit_days) AS q3_actual_transit_days,\n        PERCENTILE_CONT(0.9) WITHIN GROUP (ORDER BY sttm.actual_transit_days) AS p90_actual_transit_days,\n        PERCENTILE_CONT(0.95) WITHIN GROUP (ORDER BY sttm.actual_transit_days) AS p95_actual_transit_days,\n        STDDEV(sttm.actual_transit_days) AS stddev_actual_transit_days,\n        MIN(sttm.actual_transit_days) AS min_actual_transit_days,\n        MAX(sttm.actual_transit_days) AS max_actual_transit_days,\n        -- Variability metrics\n        CASE\n            WHEN AVG(sttm.actual_transit_days) > 0 THEN\n                (STDDEV(sttm.actual_transit_days) / AVG(sttm.actual_transit_days)) * 100\n            ELSE NULL\n        END AS coefficient_of_variation_percent,\n        -- On-time performance (within 1 day of scheduled)\n        COUNT(DISTINCT CASE \n            WHEN ABS(sttm.transit_time_variance_days) <= 1 THEN sttm.sailing_id\n        END) AS on_time_transit_sailings\n    FROM sailing_transit_time_metrics sttm\n    WHERE sttm.actual_transit_days IS NOT NULL\n    GROUP BY\n        sttm.carrier_id,\n        sttm.carrier_name,\n        sttm.route_id,\n        sttm.route_name,\n        sttm.origin_port_id,\n        sttm.origin_port_name,\n        sttm.destination_port_id,\n        sttm.destination_port_name,\n        sttm.sailing_month,\n        sttm.sailing_quarter\n),\ntransit_time_reliability_metrics AS (\n    -- Third CTE: Calculate reliability metrics\n    SELECT\n        rtts.carrier_id,\n        rtts.carrier_name,\n        rtts.route_id,\n        rtts.route_name,\n        rtts.origin_port_id,\n        rtts.origin_port_name,\n        rtts.destination_port_id,\n        rtts.destination_port_name,\n        rtts.sailing_month,\n        rtts.sailing_quarter,\n        rtts.total_sailings,\n        ROUND(CAST(rtts.avg_actual_transit_days AS NUMERIC), 2) AS avg_actual_transit_days,\n        ROUND(CAST(rtts.avg_scheduled_transit_days AS NUMERIC), 2) AS avg_scheduled_transit_days,\n        ROUND(CAST(rtts.avg_transit_time_variance AS NUMERIC), 2) AS avg_transit_time_variance,\n        ROUND(CAST(rtts.median_actual_transit_days AS NUMERIC), 2) AS median_actual_transit_days,\n        ROUND(CAST(rtts.q1_actual_transit_days AS NUMERIC), 2) AS q1_actual_transit_days,\n        ROUND(CAST(rtts.q3_actual_transit_days AS NUMERIC), 2) AS q3_actual_transit_days,\n        ROUND(CAST(rtts.p90_actual_transit_days AS NUMERIC), 2) AS p90_actual_transit_days,\n        ROUND(CAST(rtts.p95_actual_transit_days AS NUMERIC), 2) AS p95_actual_transit_days,\n        ROUND(CAST(rtts.stddev_actual_transit_days AS NUMERIC), 2) AS stddev_actual_transit_days,\n        ROUND(CAST(rtts.min_actual_transit_days AS NUMERIC), 2) AS min_actual_transit_days,\n        ROUND(CAST(rtts.max_actual_transit_days AS NUMERIC), 2) AS max_actual_transit_days,\n        ROUND(CAST(rtts.coefficient_of_variation_percent AS NUMERIC), 2) AS coefficient_of_variation_percent,\n        rtts.on_time_transit_sailings,\n        -- On-time transit rate\n        CASE\n            WHEN rtts.total_sailings > 0 THEN\n                ROUND(CAST((rtts.on_time_transit_sailings::NUMERIC / rtts.total_sailings::NUMERIC) * 100 AS NUMERIC), 2)\n            ELSE 0\n        END AS on_time_transit_rate,\n        -- Interquartile range (IQR) - measure of variability\n        ROUND(CAST((rtts.q3_actual_transit_days - rtts.q1_actual_transit_days) AS NUMERIC), 2) AS interquartile_range_days,\n        -- Predictability window (p95 - p5 equivalent, using q1 and p95)\n        ROUND(CAST((rtts.p95_actual_transit_days - rtts.q1_actual_transit_days) AS NUMERIC), 2) AS predictability_window_days,\n        -- Moving averages for trend analysis\n        AVG(rtts.avg_actual_transit_days) OVER (\n            PARTITION BY rtts.carrier_id, rtts.route_id\n            ORDER BY rtts.sailing_month\n            ROWS BETWEEN 2 PRECEDING AND CURRENT ROW\n        ) AS moving_avg_transit_time_3_month,\n        AVG(rtts.stddev_actual_transit_days) OVER (\n            PARTITION BY rtts.carrier_id, rtts.route_id\n            ORDER BY rtts.sailing_month\n            ROWS BETWEEN 2 PRECEDING AND CURRENT ROW\n        ) AS moving_avg_stddev_3_month\n    FROM route_transit_time_statistics rtts\n),\nreliability_scoring AS (\n    -- Fourth CTE: Calculate reliability scores\n    SELECT\n        ttrm.carrier_id,\n        ttrm.carrier_name,\n        ttrm.route_id,\n        ttrm.route_name,\n        ttrm.origin_port_id,\n        ttrm.origin_port_name,\n        ttrm.destination_port_id,\n        ttrm.destination_port_name,\n        ttrm.sailing_month,\n        ttrm.sailing_quarter,\n        ttrm.total_sailings,\n        ttrm.avg_actual_transit_days,\n        ttrm.avg_scheduled_transit_days,\n        ttrm.avg_transit_time_variance,\n        ttrm.median_actual_transit_days,\n        ttrm.q1_actual_transit_days,\n        ttrm.q3_actual_transit_days,\n        ttrm.p90_actual_transit_days,\n        ttrm.p95_actual_transit_days,\n        ttrm.stddev_actual_transit_days,\n        ttrm.min_actual_transit_days,\n        ttrm.max_actual_transit_days,\n        ttrm.coefficient_of_variation_percent,\n        ttrm.on_time_transit_sailings,\n        ttrm.on_time_transit_rate,\n        ttrm.interquartile_range_days,\n        ttrm.predictability_window_days,\n        ROUND(CAST(ttrm.moving_avg_transit_time_3_month AS NUMERIC), 2) AS moving_avg_transit_time_3_month,\n        ROUND(CAST(ttrm.moving_avg_stddev_3_month AS NUMERIC), 2) AS moving_avg_stddev_3_month,\n        -- Route averages for comparison\n        AVG(ttrm.avg_actual_transit_days) OVER (PARTITION BY ttrm.route_id) AS route_avg_transit_days,\n        AVG(ttrm.stddev_actual_transit_days) OVER (PARTITION BY ttrm.route_id) AS route_avg_stddev,\n        AVG(ttrm.coefficient_of_variation_percent) OVER (PARTITION BY ttrm.route_id) AS route_avg_coefficient_of_variation,\n        -- Market averages\n        AVG(ttrm.avg_actual_transit_days) OVER () AS market_avg_transit_days,\n        AVG(ttrm.stddev_actual_transit_days) OVER () AS market_avg_stddev,\n        AVG(ttrm.coefficient_of_variation_percent) OVER () AS market_avg_coefficient_of_variation,\n        -- Reliability score (weighted)\n        (\n            -- On-time performance component (40%)\n            (ttrm.on_time_transit_rate / 100.0) * 40 +\n            -- Variability component (35%) - inverse (lower CV is better)\n            CASE\n                WHEN ttrm.coefficient_of_variation_percent IS NOT NULL THEN\n                    GREATEST(0, (1.0 - ttrm.coefficient_of_variation_percent / 50.0)) * 35\n                ELSE 0\n            END +\n            -- Predictability component (25%) - inverse (smaller window is better)\n            CASE\n                WHEN ttrm.avg_actual_transit_days > 0 THEN\n                    GREATEST(0, (1.0 - ttrm.predictability_window_days / (ttrm.avg_actual_transit_days * 2))) * 25\n                ELSE 0\n            END\n        ) AS reliability_score\n    FROM transit_time_reliability_metrics ttrm\n),\nreliability_classification AS (\n    -- Fifth CTE: Classify reliability performance\n    SELECT\n        rs.carrier_id,\n        rs.carrier_name,\n        rs.route_id,\n        rs.route_name,\n        rs.origin_port_id,\n        rs.origin_port_name,\n        rs.destination_port_id,\n        rs.destination_port_name,\n        rs.sailing_month,\n        rs.sailing_quarter,\n        rs.total_sailings,\n        rs.avg_actual_transit_days,\n        rs.avg_scheduled_transit_days,\n        rs.avg_transit_time_variance,\n        rs.median_actual_transit_days,\n        rs.q1_actual_transit_days,\n        rs.q3_actual_transit_days,\n        rs.p90_actual_transit_days,\n        rs.p95_actual_transit_days,\n        rs.stddev_actual_transit_days,\n        rs.min_actual_transit_days,\n        rs.max_actual_transit_days,\n        rs.coefficient_of_variation_percent,\n        rs.on_time_transit_sailings,\n        rs.on_time_transit_rate,\n        rs.interquartile_range_days,\n        rs.predictability_window_days,\n        rs.moving_avg_transit_time_3_month,\n        rs.moving_avg_stddev_3_month,\n        ROUND(CAST(rs.route_avg_transit_days AS NUMERIC), 2) AS route_avg_transit_days,\n        ROUND(CAST(rs.route_avg_stddev AS NUMERIC), 2) AS route_avg_stddev,\n        ROUND(CAST(rs.route_avg_coefficient_of_variation AS NUMERIC), 2) AS route_avg_coefficient_of_variation,\n        ROUND(CAST(rs.market_avg_transit_days AS NUMERIC), 2) AS market_avg_transit_days,\n        ROUND(CAST(rs.market_avg_stddev AS NUMERIC), 2) AS market_avg_stddev,\n        ROUND(CAST(rs.market_avg_coefficient_of_variation AS NUMERIC), 2) AS market_avg_coefficient_of_variation,\n        ROUND(CAST(rs.reliability_score AS NUMERIC), 2) AS reliability_score,\n        -- Reliability classification\n        CASE\n            WHEN rs.reliability_score >= 90 THEN 'Highly Reliable'\n            WHEN rs.reliability_score >= 80 THEN 'Reliable'\n            WHEN rs.reliability_score >= 70 THEN 'Moderately Reliable'\n            WHEN rs.reliability_score >= 60 THEN 'Less Reliable'\n            ELSE 'Unreliable'\n        END AS reliability_class,\n        -- Variability classification\n        CASE\n            WHEN rs.coefficient_of_variation_percent <= 5 THEN 'Very Low Variability'\n            WHEN rs.coefficient_of_variation_percent <= 10 THEN 'Low Variability'\n            WHEN rs.coefficient_of_variation_percent <= 15 THEN 'Moderate Variability'\n            WHEN rs.coefficient_of_variation_percent <= 20 THEN 'High Variability'\n            ELSE 'Very High Variability'\n        END AS variability_class,\n        -- Predictability classification\n        CASE\n            WHEN rs.predictability_window_days <= 2 THEN 'Highly Predictable'\n            WHEN rs.predictability_window_days <= 4 THEN 'Predictable'\n            WHEN rs.predictability_window_days <= 6 THEN 'Moderately Predictable'\n            WHEN rs.predictability_window_days <= 8 THEN 'Less Predictable'\n            ELSE 'Unpredictable'\n        END AS predictability_class,\n        -- Optimization recommendations\n        CASE\n            WHEN rs.coefficient_of_variation_percent > rs.route_avg_coefficient_of_variation * 1.2 THEN 'Reduce Transit Time Variability'\n            WHEN rs.on_time_transit_rate < 80 THEN 'Improve On-Time Transit Performance'\n            WHEN rs.predictability_window_days > 6 THEN 'Improve Schedule Predictability'\n            WHEN rs.stddev_actual_transit_days > rs.route_avg_stddev * 1.2 THEN 'Standardize Transit Times'\n            ELSE 'Transit Time Performance Optimal'\n        END AS optimization_recommendation\n    FROM reliability_scoring rs\n)\nSELECT\n    carrier_id,\n    carrier_name,\n    route_id,\n    route_name,\n    origin_port_id,\n    origin_port_name,\n    destination_port_id,\n    destination_port_name,\n    sailing_month,\n    sailing_quarter,\n    total_sailings,\n    avg_actual_transit_days,\n    avg_scheduled_transit_days,\n    avg_transit_time_variance,\n    median_actual_transit_days,\n    q1_actual_transit_days,\n    q3_actual_transit_days,\n    p90_actual_transit_days,\n    p95_actual_transit_days,\n    stddev_actual_transit_days,\n    min_actual_transit_days,\n    max_actual_transit_days,\n    coefficient_of_variation_percent,\n    on_time_transit_sailings,\n    on_time_transit_rate,\n    interquartile_range_days,\n    predictability_window_days,\n    moving_avg_transit_time_3_month,\n    moving_avg_stddev_3_month,\n    route_avg_transit_days,\n    route_avg_stddev,\n    route_avg_coefficient_of_variation,\n    market_avg_transit_days,\n    market_avg_stddev,\n    market_avg_coefficient_of_variation,\n    reliability_score,\n    reliability_class,\n    variability_class,\n    predictability_class,\n    optimization_recommendation\nFROM reliability_classification\nORDER BY sailing_month DESC, reliability_score DESC\nLIMIT 2000;",
      "line_number": 8820
    },
    {
      "number": 27,
      "title": "Port Pair Trade Volume Trends Analysis with Growth Forecasting and Market Opportunity Identification",
      "description": "Use Case: Market Intelligence - Comprehensive Port Pair Trade Volume Trends Analysis for Strategic Planning Description: Enterprise-level trade volume trends analysis with multi-level CTE nesting, trend detection, growth forecasting, market opportunity identification, and advanced window functions. Demonstrates production patterns used by shipping lines for strategic market planning. Business Value: Trade volume trends report showing volume patterns, growth trends, forecasted demand, and market ",
      "complexity": "Deep nested CTEs (7+ levels), trend analysis, growth forecasting, window functions with multiple frame clauses, temporal analysis, market opportunity scoring",
      "expected_output": "Trade volume trends report with growth forecasts, market opportunities, and strategic planning recommendations.",
      "sql": "WITH port_pair_monthly_volumes AS (\n    -- First CTE: Aggregate monthly volumes by port pair\n    SELECT\n        s.origin_port_id,\n        op.port_name AS origin_port_name,\n        op.port_code AS origin_port_code,\n        op.country AS origin_country,\n        s.destination_port_id,\n        dp.port_name AS destination_port_name,\n        dp.port_code AS destination_port_code,\n        dp.country AS destination_country,\n        DATE_TRUNC('month', s.scheduled_departure) AS sailing_month,\n        DATE_TRUNC('quarter', s.scheduled_departure) AS sailing_quarter,\n        DATE_TRUNC('year', s.scheduled_departure) AS sailing_year,\n        COUNT(DISTINCT s.sailing_id) AS monthly_sailings,\n        COUNT(DISTINCT CASE WHEN s.status = 'Completed' THEN s.sailing_id END) AS monthly_completed_sailings,\n        SUM(s.total_teu) AS monthly_total_teu,\n        AVG(s.total_teu) AS monthly_avg_teu_per_sailing,\n        AVG(s.capacity_utilization_percent) AS monthly_avg_capacity_utilization,\n        COUNT(DISTINCT r.carrier_id) AS unique_carriers\n    FROM sailings s\n    INNER JOIN routes r ON s.route_id = r.route_id\n    INNER JOIN ports op ON s.origin_port_id = op.port_id\n    INNER JOIN ports dp ON s.destination_port_id = dp.port_id\n    WHERE s.scheduled_departure >= CURRENT_DATE - INTERVAL '2 years'\n    GROUP BY\n        s.origin_port_id,\n        op.port_name,\n        op.port_code,\n        op.country,\n        s.destination_port_id,\n        dp.port_name,\n        dp.port_code,\n        dp.country,\n        DATE_TRUNC('month', s.scheduled_departure),\n        DATE_TRUNC('quarter', s.scheduled_departure),\n        DATE_TRUNC('year', s.scheduled_departure)\n),\nport_pair_trend_calculations AS (\n    -- Second CTE: Calculate trends and growth rates\n    SELECT\n        ppmv.origin_port_id,\n        ppmv.origin_port_name,\n        ppmv.origin_port_code,\n        ppmv.origin_country,\n        ppmv.destination_port_id,\n        ppmv.destination_port_name,\n        ppmv.destination_port_code,\n        ppmv.destination_country,\n        ppmv.sailing_month,\n        ppmv.sailing_quarter,\n        ppmv.sailing_year,\n        ppmv.monthly_sailings,\n        ppmv.monthly_completed_sailings,\n        ROUND(CAST(ppmv.monthly_total_teu AS NUMERIC), 2) AS monthly_total_teu,\n        ROUND(CAST(ppmv.monthly_avg_teu_per_sailing AS NUMERIC), 2) AS monthly_avg_teu_per_sailing,\n        ROUND(CAST(ppmv.monthly_avg_capacity_utilization AS NUMERIC), 2) AS monthly_avg_capacity_utilization,\n        ppmv.unique_carriers,\n        -- Previous periods\n        LAG(ppmv.monthly_total_teu, 1) OVER (\n            PARTITION BY ppmv.origin_port_id, ppmv.destination_port_id\n            ORDER BY ppmv.sailing_month\n        ) AS prev_month_teu,\n        LAG(ppmv.monthly_total_teu, 12) OVER (\n            PARTITION BY ppmv.origin_port_id, ppmv.destination_port_id\n            ORDER BY ppmv.sailing_month\n        ) AS prev_year_teu,\n        LAG(ppmv.monthly_total_teu, 3) OVER (\n            PARTITION BY ppmv.origin_port_id, ppmv.destination_port_id\n            ORDER BY ppmv.sailing_month\n        ) AS prev_quarter_teu,\n        -- Moving averages\n        AVG(ppmv.monthly_total_teu) OVER (\n            PARTITION BY ppmv.origin_port_id, ppmv.destination_port_id\n            ORDER BY ppmv.sailing_month\n            ROWS BETWEEN 2 PRECEDING AND CURRENT ROW\n        ) AS moving_avg_3_month,\n        AVG(ppmv.monthly_total_teu) OVER (\n            PARTITION BY ppmv.origin_port_id, ppmv.destination_port_id\n            ORDER BY ppmv.sailing_month\n            ROWS BETWEEN 11 PRECEDING AND CURRENT ROW\n        ) AS moving_avg_12_month,\n        -- Growth rates\n        CASE\n            WHEN LAG(ppmv.monthly_total_teu, 1) OVER (PARTITION BY ppmv.origin_port_id, ppmv.destination_port_id ORDER BY ppmv.sailing_month) > 0 THEN\n                ((ppmv.monthly_total_teu - LAG(ppmv.monthly_total_teu, 1) OVER (PARTITION BY ppmv.origin_port_id, ppmv.destination_port_id ORDER BY ppmv.sailing_month)) / \n                 LAG(ppmv.monthly_total_teu, 1) OVER (PARTITION BY ppmv.origin_port_id, ppmv.destination_port_id ORDER BY ppmv.sailing_month)) * 100\n            ELSE NULL\n        END AS month_over_month_growth_percent,\n        CASE\n            WHEN LAG(ppmv.monthly_total_teu, 12) OVER (PARTITION BY ppmv.origin_port_id, ppmv.destination_port_id ORDER BY ppmv.sailing_month) > 0 THEN\n                ((ppmv.monthly_total_teu - LAG(ppmv.monthly_total_teu, 12) OVER (PARTITION BY ppmv.origin_port_id, ppmv.destination_port_id ORDER BY ppmv.sailing_month)) / \n                 LAG(ppmv.monthly_total_teu, 12) OVER (PARTITION BY ppmv.origin_port_id, ppmv.destination_port_id ORDER BY ppmv.sailing_month)) * 100\n            ELSE NULL\n        END AS year_over_year_growth_percent,\n        CASE\n            WHEN LAG(ppmv.monthly_total_teu, 3) OVER (PARTITION BY ppmv.origin_port_id, ppmv.destination_port_id ORDER BY ppmv.sailing_month) > 0 THEN\n                ((ppmv.monthly_total_teu - LAG(ppmv.monthly_total_teu, 3) OVER (PARTITION BY ppmv.origin_port_id, ppmv.destination_port_id ORDER BY ppmv.sailing_month)) / \n                 LAG(ppmv.monthly_total_teu, 3) OVER (PARTITION BY ppmv.origin_port_id, ppmv.destination_port_id ORDER BY ppmv.sailing_month)) * 100\n            ELSE NULL\n        END AS quarter_over_quarter_growth_percent\n    FROM port_pair_monthly_volumes ppmv\n),\ntrend_classification AS (\n    -- Third CTE: Classify trends\n    SELECT\n        pptc.origin_port_id,\n        pptc.origin_port_name,\n        pptc.origin_port_code,\n        pptc.origin_country,\n        pptc.destination_port_id,\n        pptc.destination_port_name,\n        pptc.destination_port_code,\n        pptc.destination_country,\n        pptc.sailing_month,\n        pptc.sailing_quarter,\n        pptc.sailing_year,\n        pptc.monthly_sailings,\n        pptc.monthly_completed_sailings,\n        pptc.monthly_total_teu,\n        pptc.monthly_avg_teu_per_sailing,\n        pptc.monthly_avg_capacity_utilization,\n        pptc.unique_carriers,\n        pptc.prev_month_teu,\n        pptc.prev_year_teu,\n        pptc.prev_quarter_teu,\n        ROUND(CAST(pptc.moving_avg_3_month AS NUMERIC), 2) AS moving_avg_3_month,\n        ROUND(CAST(pptc.moving_avg_12_month AS NUMERIC), 2) AS moving_avg_12_month,\n        ROUND(CAST(pptc.month_over_month_growth_percent AS NUMERIC), 2) AS month_over_month_growth_percent,\n        ROUND(CAST(pptc.year_over_year_growth_percent AS NUMERIC), 2) AS year_over_year_growth_percent,\n        ROUND(CAST(pptc.quarter_over_quarter_growth_percent AS NUMERIC), 2) AS quarter_over_quarter_growth_percent,\n        -- Trend classification\n        CASE\n            WHEN pptc.year_over_year_growth_percent IS NOT NULL THEN\n                CASE\n                    WHEN pptc.year_over_year_growth_percent > 20 THEN 'Strong Growth'\n                    WHEN pptc.year_over_year_growth_percent > 10 THEN 'Moderate Growth'\n                    WHEN pptc.year_over_year_growth_percent > 0 THEN 'Slow Growth'\n                    WHEN pptc.year_over_year_growth_percent > -10 THEN 'Declining'\n                    ELSE 'Sharp Decline'\n                END\n            ELSE 'Unknown'\n        END AS growth_trend,\n        -- Trend direction\n        CASE\n            WHEN pptc.moving_avg_3_month > pptc.moving_avg_12_month * 1.05 THEN 'Accelerating'\n            WHEN pptc.moving_avg_3_month > pptc.moving_avg_12_month * 0.95 THEN 'Stable'\n            WHEN pptc.moving_avg_3_month < pptc.moving_avg_12_month * 0.95 THEN 'Decelerating'\n            ELSE 'Unknown'\n        END AS trend_direction,\n        -- Total volume over period\n        SUM(pptc.monthly_total_teu) OVER (\n            PARTITION BY pptc.origin_port_id, pptc.destination_port_id, pptc.sailing_year\n        ) AS annual_total_teu,\n        -- Average monthly volume\n        AVG(pptc.monthly_total_teu) OVER (\n            PARTITION BY pptc.origin_port_id, pptc.destination_port_id\n        ) AS avg_monthly_volume\n    FROM port_pair_trend_calculations pptc\n),\ngrowth_forecasting AS (\n    -- Fourth CTE: Forecast growth\n    SELECT\n        tc.origin_port_id,\n        tc.origin_port_name,\n        tc.origin_port_code,\n        tc.origin_country,\n        tc.destination_port_id,\n        tc.destination_port_name,\n        tc.destination_port_code,\n        tc.destination_country,\n        tc.sailing_month,\n        tc.sailing_quarter,\n        tc.sailing_year,\n        tc.monthly_sailings,\n        tc.monthly_completed_sailings,\n        tc.monthly_total_teu,\n        tc.monthly_avg_teu_per_sailing,\n        tc.monthly_avg_capacity_utilization,\n        tc.unique_carriers,\n        tc.prev_month_teu,\n        tc.prev_year_teu,\n        tc.prev_quarter_teu,\n        tc.moving_avg_3_month,\n        tc.moving_avg_12_month,\n        tc.month_over_month_growth_percent,\n        tc.year_over_year_growth_percent,\n        tc.quarter_over_quarter_growth_percent,\n        tc.growth_trend,\n        tc.trend_direction,\n        ROUND(CAST(tc.annual_total_teu AS NUMERIC), 2) AS annual_total_teu,\n        ROUND(CAST(tc.avg_monthly_volume AS NUMERIC), 2) AS avg_monthly_volume,\n        -- Forecasted next month (simplified - using moving average trend)\n        CASE\n            WHEN tc.moving_avg_3_month IS NOT NULL AND tc.moving_avg_12_month IS NOT NULL THEN\n                tc.monthly_total_teu * (1 + (tc.moving_avg_3_month - tc.moving_avg_12_month) / tc.moving_avg_12_month)\n            ELSE tc.monthly_total_teu\n        END AS forecasted_next_month_teu,\n        -- Forecasted next year (using year-over-year growth)\n        CASE\n            WHEN tc.year_over_year_growth_percent IS NOT NULL THEN\n                tc.monthly_total_teu * (1 + tc.year_over_year_growth_percent / 100.0)\n            ELSE tc.monthly_total_teu\n        END AS forecasted_next_year_teu,\n        -- Market comparison\n        AVG(tc.monthly_total_teu) OVER () AS market_avg_monthly_teu,\n        AVG(tc.year_over_year_growth_percent) OVER () AS market_avg_yoy_growth,\n        -- Market opportunity score\n        (\n            -- Volume component (40%)\n            CASE\n                WHEN AVG(tc.monthly_total_teu) OVER () > 0 THEN\n                    LEAST(1.0, tc.monthly_total_teu / AVG(tc.monthly_total_teu) OVER ()) * 40\n                ELSE 0\n            END +\n            -- Growth component (35%)\n            CASE\n                WHEN tc.year_over_year_growth_percent IS NOT NULL THEN\n                    GREATEST(0, LEAST(1.0, (tc.year_over_year_growth_percent + 20) / 40.0)) * 35\n                ELSE 15\n            END +\n            -- Competition component (25%) - fewer carriers = more opportunity\n            CASE\n                WHEN tc.unique_carriers > 0 THEN\n                    GREATEST(0, (1.0 - tc.unique_carriers / 10.0)) * 25\n                ELSE 0\n            END\n        ) AS market_opportunity_score\n    FROM trend_classification tc\n),\nmarket_opportunity_analysis AS (\n    -- Fifth CTE: Analyze market opportunities\n    SELECT\n        gf.origin_port_id,\n        gf.origin_port_name,\n        gf.origin_port_code,\n        gf.origin_country,\n        gf.destination_port_id,\n        gf.destination_port_name,\n        gf.destination_port_code,\n        gf.destination_country,\n        gf.sailing_month,\n        gf.sailing_quarter,\n        gf.sailing_year,\n        gf.monthly_sailings,\n        gf.monthly_completed_sailings,\n        gf.monthly_total_teu,\n        gf.monthly_avg_teu_per_sailing,\n        gf.monthly_avg_capacity_utilization,\n        gf.unique_carriers,\n        gf.prev_month_teu,\n        gf.prev_year_teu,\n        gf.prev_quarter_teu,\n        gf.moving_avg_3_month,\n        gf.moving_avg_12_month,\n        gf.month_over_month_growth_percent,\n        gf.year_over_year_growth_percent,\n        gf.quarter_over_quarter_growth_percent,\n        gf.growth_trend,\n        gf.trend_direction,\n        gf.annual_total_teu,\n        gf.avg_monthly_volume,\n        ROUND(CAST(gf.forecasted_next_month_teu AS NUMERIC), 2) AS forecasted_next_month_teu,\n        ROUND(CAST(gf.forecasted_next_year_teu AS NUMERIC), 2) AS forecasted_next_year_teu,\n        ROUND(CAST(gf.market_avg_monthly_teu AS NUMERIC), 2) AS market_avg_monthly_teu,\n        ROUND(CAST(gf.market_avg_yoy_growth AS NUMERIC), 2) AS market_avg_yoy_growth,\n        ROUND(CAST(gf.market_opportunity_score AS NUMERIC), 2) AS market_opportunity_score,\n        -- Market opportunity classification\n        CASE\n            WHEN gf.market_opportunity_score >= 80 THEN 'High Opportunity'\n            WHEN gf.market_opportunity_score >= 60 THEN 'Medium Opportunity'\n            WHEN gf.market_opportunity_score >= 40 THEN 'Low Opportunity'\n            ELSE 'Limited Opportunity'\n        END AS market_opportunity_class,\n        -- Strategic recommendation\n        CASE\n            WHEN gf.market_opportunity_score >= 80 AND gf.year_over_year_growth_percent > 15 THEN 'High Priority - Expand Service'\n            WHEN gf.market_opportunity_score >= 60 AND gf.year_over_year_growth_percent > 10 THEN 'Medium Priority - Consider Expansion'\n            WHEN gf.market_opportunity_score >= 40 AND gf.year_over_year_growth_percent > 5 THEN 'Monitor - Potential Opportunity'\n            WHEN gf.year_over_year_growth_percent < -10 THEN 'Review - Declining Market'\n            ELSE 'Maintain Current Service Level'\n        END AS strategic_recommendation\n    FROM growth_forecasting gf\n)\nSELECT\n    origin_port_id,\n    origin_port_name,\n    origin_port_code,\n    origin_country,\n    destination_port_id,\n    destination_port_name,\n    destination_port_code,\n    destination_country,\n    sailing_month,\n    sailing_quarter,\n    sailing_year,\n    monthly_sailings,\n    monthly_completed_sailings,\n    monthly_total_teu,\n    monthly_avg_teu_per_sailing,\n    monthly_avg_capacity_utilization,\n    unique_carriers,\n    prev_month_teu,\n    prev_year_teu,\n    prev_quarter_teu,\n    moving_avg_3_month,\n    moving_avg_12_month,\n    month_over_month_growth_percent,\n    year_over_year_growth_percent,\n    quarter_over_quarter_growth_percent,\n    growth_trend,\n    trend_direction,\n    annual_total_teu,\n    avg_monthly_volume,\n    forecasted_next_month_teu,\n    forecasted_next_year_teu,\n    market_avg_monthly_teu,\n    market_avg_yoy_growth,\n    market_opportunity_score,\n    market_opportunity_class,\n    strategic_recommendation\nFROM market_opportunity_analysis\nORDER BY sailing_month DESC, market_opportunity_score DESC\nLIMIT 2000;",
      "line_number": 9164
    },
    {
      "number": 28,
      "title": "Vessel Deployment Strategy Analysis with Fleet Optimization and Route Allocation",
      "description": "Use Case: Fleet Strategy - Comprehensive Vessel Deployment Strategy Analysis for Fleet Optimization Description: Enterprise-level vessel deployment analysis with multi-level CTE nesting, deployment optimization, route allocation analysis, fleet efficiency metrics, and advanced window functions. Demonstrates production patterns used by shipping lines for fleet strategy. Business Value: Vessel deployment report showing deployment patterns, route allocation efficiency, fleet optimization opportunit",
      "complexity": "Deep nested CTEs (7+ levels), deployment optimization, route allocation analysis, window functions with multiple frame clauses, efficiency metrics, fleet strategy scoring",
      "expected_output": "Vessel deployment report with deployment patterns, route allocation efficiency, and fleet optimization recommendations.",
      "sql": "WITH vessel_route_deployment AS (\n    -- First CTE: Analyze vessel deployment by route\n    SELECT\n        ve.vessel_id,\n        ve.vessel_name,\n        ve.imo_number,\n        ve.vessel_type,\n        ve.container_capacity_teu,\n        ve.carrier_id,\n        c.carrier_name,\n        s.route_id,\n        r.route_name,\n        r.route_type,\n        COUNT(DISTINCT s.sailing_id) AS sailings_on_route,\n        COUNT(DISTINCT CASE WHEN s.status = 'Completed' THEN s.sailing_id END) AS completed_sailings_on_route,\n        SUM(s.total_teu) AS total_teu_on_route,\n        AVG(s.total_teu) AS avg_teu_per_sailing_on_route,\n        AVG(s.capacity_utilization_percent) AS avg_capacity_utilization_on_route,\n        AVG(s.transit_days) AS avg_transit_days_on_route,\n        AVG(s.distance_nautical_miles) AS avg_distance_on_route,\n        DATE_TRUNC('month', s.scheduled_departure) AS sailing_month\n    FROM vessels ve\n    INNER JOIN carriers c ON ve.carrier_id = c.carrier_id\n    LEFT JOIN sailings s ON ve.vessel_id = s.vessel_id\n    LEFT JOIN routes r ON s.route_id = r.route_id\n    WHERE ve.status = 'Active'\n        AND (s.scheduled_departure IS NULL OR s.scheduled_departure >= CURRENT_DATE - INTERVAL '2 years')\n    GROUP BY\n        ve.vessel_id,\n        ve.vessel_name,\n        ve.imo_number,\n        ve.vessel_type,\n        ve.container_capacity_teu,\n        ve.carrier_id,\n        c.carrier_name,\n        s.route_id,\n        r.route_name,\n        r.route_type,\n        DATE_TRUNC('month', s.scheduled_departure)\n),\nvessel_deployment_summary AS (\n    -- Second CTE: Summarize vessel deployment across routes\n    SELECT\n        vrd.vessel_id,\n        vrd.vessel_name,\n        vrd.imo_number,\n        vrd.vessel_type,\n        vrd.container_capacity_teu,\n        vrd.carrier_id,\n        vrd.carrier_name,\n        COUNT(DISTINCT vrd.route_id) AS unique_routes_deployed,\n        SUM(vrd.sailings_on_route) AS total_sailings,\n        SUM(vrd.completed_sailings_on_route) AS total_completed_sailings,\n        SUM(vrd.total_teu_on_route) AS total_teu_carried,\n        AVG(vrd.avg_teu_per_sailing_on_route) AS avg_teu_per_sailing,\n        AVG(vrd.avg_capacity_utilization_on_route) AS avg_capacity_utilization,\n        AVG(vrd.avg_transit_days_on_route) AS avg_transit_days,\n        AVG(vrd.avg_distance_on_route) AS avg_distance_nm,\n        -- Primary route (route with most sailings)\n        (SELECT vrd2.route_id\n         FROM vessel_route_deployment vrd2\n         WHERE vrd2.vessel_id = vrd.vessel_id\n         GROUP BY vrd2.route_id\n         ORDER BY SUM(vrd2.sailings_on_route) DESC\n         LIMIT 1) AS primary_route_id,\n        (SELECT vrd2.route_name\n         FROM vessel_route_deployment vrd2\n         WHERE vrd2.vessel_id = vrd.vessel_id\n         GROUP BY vrd2.route_id, vrd2.route_name\n         ORDER BY SUM(vrd2.sailings_on_route) DESC\n         LIMIT 1) AS primary_route_name,\n        -- Route diversity (number of unique routes)\n        COUNT(DISTINCT vrd.route_id) AS route_diversity_count\n    FROM vessel_route_deployment vrd\n    GROUP BY\n        vrd.vessel_id,\n        vrd.vessel_name,\n        vrd.imo_number,\n        vrd.vessel_type,\n        vrd.container_capacity_teu,\n        vrd.carrier_id,\n        vrd.carrier_name\n),\nroute_deployment_analysis AS (\n    -- Third CTE: Analyze route deployment patterns\n    SELECT\n        vds.vessel_id,\n        vds.vessel_name,\n        vds.imo_number,\n        vds.vessel_type,\n        vds.container_capacity_teu,\n        vds.carrier_id,\n        vds.carrier_name,\n        vds.unique_routes_deployed,\n        vds.total_sailings,\n        vds.total_completed_sailings,\n        ROUND(CAST(vds.total_teu_carried AS NUMERIC), 2) AS total_teu_carried,\n        ROUND(CAST(vds.avg_teu_per_sailing AS NUMERIC), 2) AS avg_teu_per_sailing,\n        ROUND(CAST(vds.avg_capacity_utilization AS NUMERIC), 2) AS avg_capacity_utilization,\n        ROUND(CAST(vds.avg_transit_days AS NUMERIC), 2) AS avg_transit_days,\n        ROUND(CAST(vds.avg_distance_nm AS NUMERIC), 2) AS avg_distance_nm,\n        vds.primary_route_id,\n        vds.primary_route_name,\n        vds.route_diversity_count,\n        -- Carrier fleet averages\n        AVG(vds.avg_capacity_utilization) OVER (PARTITION BY vds.carrier_id) AS carrier_avg_capacity_utilization,\n        AVG(vds.total_sailings) OVER (PARTITION BY vds.carrier_id) AS carrier_avg_total_sailings,\n        AVG(vds.unique_routes_deployed) OVER (PARTITION BY vds.carrier_id) AS carrier_avg_unique_routes,\n        -- Market averages\n        AVG(vds.avg_capacity_utilization) OVER () AS market_avg_capacity_utilization,\n        AVG(vds.total_sailings) OVER () AS market_avg_total_sailings,\n        AVG(vds.unique_routes_deployed) OVER () AS market_avg_unique_routes,\n        -- Deployment specialization score (higher = more specialized)\n        CASE\n            WHEN vds.unique_routes_deployed = 1 THEN 100\n            WHEN vds.unique_routes_deployed = 2 THEN 80\n            WHEN vds.unique_routes_deployed = 3 THEN 60\n            WHEN vds.unique_routes_deployed = 4 THEN 40\n            WHEN vds.unique_routes_deployed = 5 THEN 20\n            ELSE 0\n        END AS specialization_score,\n        -- Utilization efficiency\n        CASE\n            WHEN vds.container_capacity_teu > 0 AND vds.total_sailings > 0 THEN\n                (vds.total_teu_carried / (vds.container_capacity_teu * vds.total_sailings)) * 100\n            ELSE NULL\n        END AS utilization_efficiency_percent\n    FROM vessel_deployment_summary vds\n    WHERE vds.total_sailings > 0\n),\ndeployment_optimization_scoring AS (\n    -- Fourth CTE: Calculate deployment optimization scores\n    SELECT\n        rda.vessel_id,\n        rda.vessel_name,\n        rda.imo_number,\n        rda.vessel_type,\n        rda.container_capacity_teu,\n        rda.carrier_id,\n        rda.carrier_name,\n        rda.unique_routes_deployed,\n        rda.total_sailings,\n        rda.total_completed_sailings,\n        rda.total_teu_carried,\n        rda.avg_teu_per_sailing,\n        rda.avg_capacity_utilization,\n        rda.avg_transit_days,\n        rda.avg_distance_nm,\n        rda.primary_route_id,\n        rda.primary_route_name,\n        rda.route_diversity_count,\n        ROUND(CAST(rda.carrier_avg_capacity_utilization AS NUMERIC), 2) AS carrier_avg_capacity_utilization,\n        ROUND(CAST(rda.carrier_avg_total_sailings AS NUMERIC), 2) AS carrier_avg_total_sailings,\n        ROUND(CAST(rda.carrier_avg_unique_routes AS NUMERIC), 2) AS carrier_avg_unique_routes,\n        ROUND(CAST(rda.market_avg_capacity_utilization AS NUMERIC), 2) AS market_avg_capacity_utilization,\n        ROUND(CAST(rda.market_avg_total_sailings AS NUMERIC), 2) AS market_avg_total_sailings,\n        ROUND(CAST(rda.market_avg_unique_routes AS NUMERIC), 2) AS market_avg_unique_routes,\n        rda.specialization_score,\n        ROUND(CAST(rda.utilization_efficiency_percent AS NUMERIC), 2) AS utilization_efficiency_percent,\n        -- Deployment efficiency score\n        (\n            -- Capacity utilization component (40%)\n            (rda.avg_capacity_utilization / 100.0) * 40 +\n            -- Utilization efficiency component (30%)\n            CASE\n                WHEN rda.utilization_efficiency_percent IS NOT NULL THEN\n                    (rda.utilization_efficiency_percent / 100.0) * 30\n                ELSE 0\n            END +\n            -- Specialization component (20%) - specialized deployment is often more efficient\n            (rda.specialization_score / 100.0) * 20 +\n            -- Activity component (10%) - more sailings = better utilization\n            CASE\n                WHEN rda.carrier_avg_total_sailings > 0 THEN\n                    LEAST(1.0, rda.total_sailings / rda.carrier_avg_total_sailings) * 10\n                ELSE 0\n            END\n        ) AS deployment_efficiency_score\n    FROM route_deployment_analysis rda\n),\ndeployment_strategy_recommendations AS (\n    -- Fifth CTE: Generate deployment strategy recommendations\n    SELECT\n        dos.vessel_id,\n        dos.vessel_name,\n        dos.imo_number,\n        dos.vessel_type,\n        dos.container_capacity_teu,\n        dos.carrier_id,\n        dos.carrier_name,\n        dos.unique_routes_deployed,\n        dos.total_sailings,\n        dos.total_completed_sailings,\n        dos.total_teu_carried,\n        dos.avg_teu_per_sailing,\n        dos.avg_capacity_utilization,\n        dos.avg_transit_days,\n        dos.avg_distance_nm,\n        dos.primary_route_id,\n        dos.primary_route_name,\n        dos.route_diversity_count,\n        dos.carrier_avg_capacity_utilization,\n        dos.carrier_avg_total_sailings,\n        dos.carrier_avg_unique_routes,\n        dos.market_avg_capacity_utilization,\n        dos.market_avg_total_sailings,\n        dos.market_avg_unique_routes,\n        dos.specialization_score,\n        dos.utilization_efficiency_percent,\n        ROUND(CAST(dos.deployment_efficiency_score AS NUMERIC), 2) AS deployment_efficiency_score,\n        -- Deployment strategy classification\n        CASE\n            WHEN dos.unique_routes_deployed = 1 THEN 'Specialized Deployment'\n            WHEN dos.unique_routes_deployed <= 3 THEN 'Focused Deployment'\n            WHEN dos.unique_routes_deployed <= 5 THEN 'Diversified Deployment'\n            ELSE 'Highly Diversified Deployment'\n        END AS deployment_strategy,\n        -- Performance vs carrier average\n        CASE\n            WHEN dos.avg_capacity_utilization > dos.carrier_avg_capacity_utilization * 1.1 THEN 'Above Carrier Average'\n            WHEN dos.avg_capacity_utilization > dos.carrier_avg_capacity_utilization * 0.9 THEN 'At Carrier Average'\n            ELSE 'Below Carrier Average'\n        END AS carrier_performance_class,\n        -- Optimization recommendations\n        CASE\n            WHEN dos.avg_capacity_utilization < 60 THEN 'Improve Capacity Utilization - Consider Route Reallocation'\n            WHEN dos.unique_routes_deployed > 5 THEN 'Consider Specialization - Too Many Routes'\n            WHEN dos.utilization_efficiency_percent < 50 THEN 'Optimize Deployment - Low Efficiency'\n            WHEN dos.total_sailings < dos.carrier_avg_total_sailings * 0.7 THEN 'Increase Deployment Activity'\n            ELSE 'Deployment Strategy Optimal'\n        END AS optimization_recommendation\n    FROM deployment_optimization_scoring dos\n)\nSELECT\n    vessel_id,\n    vessel_name,\n    imo_number,\n    vessel_type,\n    container_capacity_teu,\n    carrier_id,\n    carrier_name,\n    unique_routes_deployed,\n    total_sailings,\n    total_completed_sailings,\n    total_teu_carried,\n    avg_teu_per_sailing,\n    avg_capacity_utilization,\n    avg_transit_days,\n    avg_distance_nm,\n    primary_route_id,\n    primary_route_name,\n    route_diversity_count,\n    carrier_avg_capacity_utilization,\n    carrier_avg_total_sailings,\n    carrier_avg_unique_routes,\n    market_avg_capacity_utilization,\n    market_avg_total_sailings,\n    market_avg_unique_routes,\n    specialization_score,\n    utilization_efficiency_percent,\n    deployment_efficiency_score,\n    deployment_strategy,\n    carrier_performance_class,\n    optimization_recommendation\nFROM deployment_strategy_recommendations\nORDER BY deployment_efficiency_score DESC, avg_capacity_utilization DESC\nLIMIT 500;",
      "line_number": 9509
    },
    {
      "number": 29,
      "title": "Carrier Alliance Performance Analysis with Collaborative Efficiency Metrics and Network Synergy",
      "description": "Use Case: Strategic Partnerships - Comprehensive Carrier Alliance Performance Analysis for Partnership Optimization Description: Enterprise-level carrier alliance analysis with multi-level CTE nesting, alliance performance metrics, collaborative efficiency calculations, network synergy analysis, and advanced window functions. Demonstrates production patterns used by shipping lines for alliance management. Business Value: Carrier alliance report showing alliance performance, collaborative efficie",
      "complexity": "Deep nested CTEs (7+ levels), alliance performance analysis, collaborative metrics, window functions with multiple frame clauses, synergy calculations, partnership scoring",
      "expected_output": "Carrier alliance report with performance metrics, collaborative efficiency, and partnership optimization recommendations.",
      "sql": "WITH route_carrier_participation AS (\n    -- First CTE: Analyze carrier participation by route\n    SELECT\n        r.route_id,\n        r.route_name,\n        r.route_type,\n        r.carrier_id,\n        c.carrier_name,\n        COUNT(DISTINCT s.sailing_id) AS carrier_sailings_on_route,\n        COUNT(DISTINCT CASE WHEN s.status = 'Completed' THEN s.sailing_id END) AS carrier_completed_sailings,\n        SUM(s.total_teu) AS carrier_teu_on_route,\n        AVG(s.total_teu) AS carrier_avg_teu_per_sailing,\n        AVG(s.capacity_utilization_percent) AS carrier_avg_capacity_utilization,\n        DATE_TRUNC('month', s.scheduled_departure) AS sailing_month\n    FROM routes r\n    INNER JOIN sailings s ON r.route_id = s.route_id\n    INNER JOIN carriers c ON r.carrier_id = c.carrier_id\n    WHERE s.scheduled_departure >= CURRENT_DATE - INTERVAL '2 years'\n    GROUP BY\n        r.route_id,\n        r.route_name,\n        r.route_type,\n        r.carrier_id,\n        c.carrier_name,\n        DATE_TRUNC('month', s.scheduled_departure)\n),\nroute_totals AS (\n    -- Calculate route totals for concentration index\n    SELECT\n        route_id,\n        sailing_month,\n        SUM(carrier_teu_on_route) AS route_total_teu_window\n    FROM route_carrier_participation\n    GROUP BY route_id, sailing_month\n),\nroute_carrier_alliance_metrics AS (\n    -- Second CTE: Calculate route-level alliance metrics\n    SELECT\n        rcp.route_id,\n        rcp.route_name,\n        rcp.route_type,\n        rcp.sailing_month,\n        COUNT(DISTINCT rcp.carrier_id) AS unique_carriers_on_route,\n        SUM(rcp.carrier_sailings_on_route) AS total_route_sailings,\n        SUM(rcp.carrier_teu_on_route) AS total_route_teu,\n        AVG(rcp.carrier_avg_capacity_utilization) AS route_avg_capacity_utilization,\n        -- Carrier market share on route\n        SUM(rcp.carrier_teu_on_route) AS route_total_teu,\n        -- Alliance concentration (HHI-like metric)\n        SUM(POWER((rcp.carrier_teu_on_route::NUMERIC / NULLIF(rt.route_total_teu_window, 0)), 2)) * 10000.0 AS route_concentration_index,\n        -- Top carrier share\n        MAX(rcp.carrier_teu_on_route) AS top_carrier_teu_on_route,\n        -- Top 3 carriers combined share\n        SUM(CASE \n            WHEN rcp.carrier_teu_on_route IN (\n                SELECT carrier_teu_on_route \n                FROM route_carrier_participation rcp2 \n                WHERE rcp2.route_id = rcp.route_id \n                    AND rcp2.sailing_month = rcp.sailing_month\n                ORDER BY carrier_teu_on_route DESC \n                LIMIT 3\n            ) THEN rcp.carrier_teu_on_route \n            ELSE 0 \n        END) AS top3_carriers_teu\n    FROM route_carrier_participation rcp\n    INNER JOIN route_totals rt ON rcp.route_id = rt.route_id AND rcp.sailing_month = rt.sailing_month\n    GROUP BY\n        rcp.route_id,\n        rcp.route_name,\n        rcp.route_type,\n        rcp.sailing_month,\n        rt.route_total_teu_window\n),\ncarrier_alliance_performance AS (\n    -- Third CTE: Analyze carrier alliance performance\n    SELECT\n        rcp.carrier_id,\n        rcp.carrier_name,\n        rcp.route_id,\n        rcp.route_name,\n        rcp.route_type,\n        rcp.sailing_month,\n        rcp.carrier_sailings_on_route,\n        rcp.carrier_completed_sailings,\n        ROUND(CAST(rcp.carrier_teu_on_route AS NUMERIC), 2) AS carrier_teu_on_route,\n        ROUND(CAST(rcp.carrier_avg_teu_per_sailing AS NUMERIC), 2) AS carrier_avg_teu_per_sailing,\n        ROUND(CAST(rcp.carrier_avg_capacity_utilization AS NUMERIC), 2) AS carrier_avg_capacity_utilization,\n        rcam.unique_carriers_on_route,\n        rcam.total_route_sailings,\n        ROUND(CAST(rcam.total_route_teu AS NUMERIC), 2) AS total_route_teu,\n        ROUND(CAST(rcam.route_avg_capacity_utilization AS NUMERIC), 2) AS route_avg_capacity_utilization,\n        ROUND(CAST(rcam.route_concentration_index AS NUMERIC), 2) AS route_concentration_index,\n        ROUND(CAST(rcam.top_carrier_teu_on_route AS NUMERIC), 2) AS top_carrier_teu_on_route,\n        ROUND(CAST(rcam.top3_carriers_teu AS NUMERIC), 2) AS top3_carriers_teu,\n        -- Carrier market share on route\n        CASE\n            WHEN rcam.total_route_teu > 0 THEN\n                ROUND(CAST((rcp.carrier_teu_on_route::NUMERIC / rcam.total_route_teu::NUMERIC) * 100 AS NUMERIC), 2)\n            ELSE 0\n        END AS carrier_route_market_share,\n        -- Alliance type classification\n        CASE\n            WHEN rcam.unique_carriers_on_route = 1 THEN 'Solo Operation'\n            WHEN rcam.unique_carriers_on_route <= 3 THEN 'Small Alliance'\n            WHEN rcam.unique_carriers_on_route <= 5 THEN 'Medium Alliance'\n            ELSE 'Large Alliance'\n        END AS alliance_type,\n        -- Route concentration level\n        CASE\n            WHEN rcam.route_concentration_index >= 2500 THEN 'Highly Concentrated'\n            WHEN rcam.route_concentration_index >= 1500 THEN 'Moderately Concentrated'\n            WHEN rcam.route_concentration_index >= 1000 THEN 'Moderately Competitive'\n            ELSE 'Competitive'\n        END AS route_concentration_level\n    FROM route_carrier_participation rcp\n    INNER JOIN route_carrier_alliance_metrics rcam ON\n        rcp.route_id = rcam.route_id\n        AND rcp.sailing_month = rcam.sailing_month\n),\ncarrier_collaborative_efficiency AS (\n    -- Fourth CTE: Calculate collaborative efficiency metrics\n    SELECT\n        cap.carrier_id,\n        cap.carrier_name,\n        cap.route_id,\n        cap.route_name,\n        cap.route_type,\n        cap.sailing_month,\n        cap.carrier_sailings_on_route,\n        cap.carrier_completed_sailings,\n        cap.carrier_teu_on_route,\n        cap.carrier_avg_teu_per_sailing,\n        cap.carrier_avg_capacity_utilization,\n        cap.unique_carriers_on_route,\n        cap.total_route_sailings,\n        cap.total_route_teu,\n        cap.route_avg_capacity_utilization,\n        cap.route_concentration_index,\n        cap.top_carrier_teu_on_route,\n        cap.top3_carriers_teu,\n        cap.carrier_route_market_share,\n        cap.alliance_type,\n        cap.route_concentration_level,\n        -- Collaborative efficiency score\n        (\n            -- Capacity utilization component (35%)\n            (cap.carrier_avg_capacity_utilization / 100.0) * 35 +\n            -- Market share component (30%)\n            CASE\n                WHEN cap.carrier_route_market_share >= 30 THEN 30\n                WHEN cap.carrier_route_market_share >= 20 THEN 25\n                WHEN cap.carrier_route_market_share >= 10 THEN 20\n                WHEN cap.carrier_route_market_share >= 5 THEN 15\n                ELSE cap.carrier_route_market_share * 0.3\n            END +\n            -- Alliance efficiency component (25%) - optimal alliance size\n            CASE\n                WHEN cap.unique_carriers_on_route BETWEEN 2 AND 4 THEN 25\n                WHEN cap.unique_carriers_on_route = 1 THEN 20\n                WHEN cap.unique_carriers_on_route BETWEEN 5 AND 6 THEN 20\n                ELSE 15\n            END +\n            -- Route performance component (10%)\n            CASE\n                WHEN cap.route_avg_capacity_utilization >= 80 THEN 10\n                WHEN cap.route_avg_capacity_utilization >= 70 THEN 8\n                WHEN cap.route_avg_capacity_utilization >= 60 THEN 6\n                ELSE cap.route_avg_capacity_utilization * 0.1\n            END\n        ) AS collaborative_efficiency_score,\n        -- Network synergy indicator\n        CASE\n            WHEN cap.unique_carriers_on_route > 1 AND cap.route_avg_capacity_utilization > cap.carrier_avg_capacity_utilization * 1.1 THEN 'Positive Synergy'\n            WHEN cap.unique_carriers_on_route > 1 AND cap.route_avg_capacity_utilization > cap.carrier_avg_capacity_utilization THEN 'Neutral Synergy'\n            WHEN cap.unique_carriers_on_route > 1 THEN 'Negative Synergy'\n            ELSE 'No Alliance'\n        END AS network_synergy\n    FROM carrier_alliance_performance cap\n),\nalliance_optimization_recommendations AS (\n    -- Fifth CTE: Generate alliance optimization recommendations\n    SELECT\n        cce.carrier_id,\n        cce.carrier_name,\n        cce.route_id,\n        cce.route_name,\n        cce.route_type,\n        cce.sailing_month,\n        cce.carrier_sailings_on_route,\n        cce.carrier_completed_sailings,\n        cce.carrier_teu_on_route,\n        cce.carrier_avg_teu_per_sailing,\n        cce.carrier_avg_capacity_utilization,\n        cce.unique_carriers_on_route,\n        cce.total_route_sailings,\n        cce.total_route_teu,\n        cce.route_avg_capacity_utilization,\n        cce.route_concentration_index,\n        cce.top_carrier_teu_on_route,\n        cce.top3_carriers_teu,\n        cce.carrier_route_market_share,\n        cce.alliance_type,\n        cce.route_concentration_level,\n        ROUND(CAST(cce.collaborative_efficiency_score AS NUMERIC), 2) AS collaborative_efficiency_score,\n        cce.network_synergy,\n        -- Alliance performance classification\n        CASE\n            WHEN cce.collaborative_efficiency_score >= 85 THEN 'Excellent Alliance Performance'\n            WHEN cce.collaborative_efficiency_score >= 75 THEN 'Good Alliance Performance'\n            WHEN cce.collaborative_efficiency_score >= 65 THEN 'Average Alliance Performance'\n            WHEN cce.collaborative_efficiency_score >= 55 THEN 'Below Average Alliance Performance'\n            ELSE 'Poor Alliance Performance'\n        END AS alliance_performance_class,\n        -- Optimization recommendations\n        CASE\n            WHEN cce.network_synergy = 'Negative Synergy' THEN 'Review Alliance Structure - Negative Synergy Detected'\n            WHEN cce.unique_carriers_on_route > 6 THEN 'Consider Alliance Consolidation - Too Many Partners'\n            WHEN cce.carrier_route_market_share < 5 AND cce.unique_carriers_on_route > 1 THEN 'Increase Market Share or Consider Solo Operation'\n            WHEN cce.carrier_avg_capacity_utilization < 60 THEN 'Improve Capacity Utilization - Alliance Not Effective'\n            WHEN cce.route_avg_capacity_utilization < cce.carrier_avg_capacity_utilization THEN 'Route Underperforming - Review Alliance Benefits'\n            ELSE 'Alliance Operating Optimally'\n        END AS optimization_recommendation\n    FROM carrier_collaborative_efficiency cce\n)\nSELECT\n    carrier_id,\n    carrier_name,\n    route_id,\n    route_name,\n    route_type,\n    sailing_month,\n    carrier_sailings_on_route,\n    carrier_completed_sailings,\n    carrier_teu_on_route,\n    carrier_avg_teu_per_sailing,\n    carrier_avg_capacity_utilization,\n    unique_carriers_on_route,\n    total_route_sailings,\n    total_route_teu,\n    route_avg_capacity_utilization,\n    route_concentration_index,\n    top_carrier_teu_on_route,\n    top3_carriers_teu,\n    carrier_route_market_share,\n    alliance_type,\n    route_concentration_level,\n    collaborative_efficiency_score,\n    network_synergy,\n    alliance_performance_class,\n    optimization_recommendation\nFROM alliance_optimization_recommendations\nORDER BY sailing_month DESC, collaborative_efficiency_score DESC\nLIMIT 2000;",
      "line_number": 9797
    },
    {
      "number": 30,
      "title": "Comprehensive Maritime Intelligence Dashboard Query with Multi-Dimensional Analytics and Executive Summary",
      "description": "Use Case: Executive Dashboard - Comprehensive Maritime Intelligence Dashboard for Strategic Decision Making Description: Enterprise-level comprehensive dashboard query with multi-level CTE nesting, multi-dimensional analytics, executive summary metrics, KPI aggregation, and advanced window functions. Demonstrates production patterns used by shipping lines for executive dashboards and strategic intelligence. Business Value: Comprehensive maritime intelligence dashboard showing key performance ind",
      "complexity": "Deep nested CTEs (8+ levels), multi-dimensional analytics, KPI aggregation, executive metrics, window functions with multiple frame clauses, comprehensive reporting, strategic insights",
      "expected_output": "Comprehensive maritime intelligence dashboard with KPIs, operational metrics, financial performance, market intelligence, and strategic insights.",
      "sql": "WITH operational_kpis AS (\n    -- First CTE: Calculate operational KPIs\n    SELECT\n        COUNT(DISTINCT s.sailing_id) AS total_sailings,\n        COUNT(DISTINCT CASE WHEN s.status = 'Completed' THEN s.sailing_id END) AS completed_sailings,\n        COUNT(DISTINCT CASE WHEN s.status = 'Cancelled' THEN s.sailing_id END) AS cancelled_sailings,\n        SUM(s.total_teu) AS total_teu_carried,\n        AVG(s.capacity_utilization_percent) AS avg_capacity_utilization,\n        AVG(s.transit_days) AS avg_transit_days,\n        -- On-time performance\n        COUNT(DISTINCT CASE \n            WHEN s.actual_arrival IS NOT NULL AND s.scheduled_arrival IS NOT NULL\n                AND EXTRACT(EPOCH FROM (s.actual_arrival - s.scheduled_arrival)) / 3600.0 <= 6 THEN s.sailing_id\n        END) AS on_time_arrivals,\n        COUNT(DISTINCT CASE \n            WHEN s.actual_departure IS NOT NULL AND s.scheduled_departure IS NOT NULL\n                AND EXTRACT(EPOCH FROM (s.actual_departure - s.scheduled_departure)) / 3600.0 <= 6 THEN s.sailing_id\n        END) AS on_time_departures\n    FROM sailings s\n    WHERE s.scheduled_departure >= CURRENT_DATE - INTERVAL '1 year'\n),\ncarrier_performance_summary AS (\n    -- Second CTE: Summarize carrier performance\n    SELECT\n        c.carrier_id,\n        c.carrier_name,\n        COUNT(DISTINCT s.sailing_id) AS carrier_total_sailings,\n        COUNT(DISTINCT CASE WHEN s.status = 'Completed' THEN s.sailing_id END) AS carrier_completed_sailings,\n        SUM(s.total_teu) AS carrier_total_teu,\n        AVG(s.capacity_utilization_percent) AS carrier_avg_capacity_utilization,\n        AVG(s.transit_days) AS carrier_avg_transit_days,\n        COUNT(DISTINCT CASE \n            WHEN s.actual_arrival IS NOT NULL AND s.scheduled_arrival IS NOT NULL\n                AND EXTRACT(EPOCH FROM (s.actual_arrival - s.scheduled_arrival)) / 3600.0 <= 6 THEN s.sailing_id\n        END) AS carrier_on_time_arrivals\n    FROM carriers c\n    LEFT JOIN routes r2 ON c.carrier_id = r2.carrier_id\n    LEFT JOIN sailings s ON r2.route_id = s.route_id\n    WHERE s.scheduled_departure >= CURRENT_DATE - INTERVAL '1 year'\n        OR s.scheduled_departure IS NULL\n    GROUP BY c.carrier_id, c.carrier_name\n),\nport_operations_summary AS (\n    -- Third CTE: Summarize port operations\n    SELECT\n        p.port_id,\n        p.port_name,\n        p.port_code,\n        p.country,\n        COUNT(DISTINCT pc.port_call_id) AS total_port_calls,\n        COUNT(DISTINCT CASE WHEN pc.status = 'Completed' THEN pc.port_call_id END) AS completed_port_calls,\n        AVG(CASE \n            WHEN pc.actual_arrival IS NOT NULL AND pc.actual_departure IS NOT NULL THEN\n                EXTRACT(EPOCH FROM (pc.actual_departure - pc.actual_arrival)) / 3600.0\n            ELSE NULL\n        END) AS avg_dwell_time_hours,\n        AVG(CASE \n            WHEN pc.actual_arrival IS NOT NULL AND pc.scheduled_arrival IS NOT NULL THEN\n                EXTRACT(EPOCH FROM (pc.actual_arrival - pc.scheduled_arrival)) / 3600.0\n            ELSE NULL\n        END) AS avg_arrival_delay_hours,\n        SUM(COALESCE(pc.containers_loaded, 0) + COALESCE(pc.containers_discharged, 0) + COALESCE(pc.containers_transshipped, 0)) AS total_containers_handled\n    FROM ports p\n    LEFT JOIN port_calls pc ON p.port_id = pc.port_id\n    WHERE COALESCE(pc.actual_arrival, pc.scheduled_arrival) >= CURRENT_DATE - INTERVAL '1 year'\n        OR pc.actual_arrival IS NULL\n    GROUP BY p.port_id, p.port_name, p.port_code, p.country\n),\nroute_intelligence_summary AS (\n    -- Fourth CTE: Summarize route intelligence\n    SELECT\n        r.route_id,\n        r.route_name,\n        r.route_type,\n        COUNT(DISTINCT s.sailing_id) AS route_total_sailings,\n        SUM(s.total_teu) AS route_total_teu,\n        AVG(s.capacity_utilization_percent) AS route_avg_capacity_utilization,\n        AVG(s.transit_days) AS route_avg_transit_days,\n        COUNT(DISTINCT r.carrier_id) AS route_unique_carriers,\n        COUNT(DISTINCT s.vessel_id) AS route_unique_vessels\n    FROM routes r\n    LEFT JOIN sailings s ON r.route_id = s.route_id\n    WHERE s.scheduled_departure >= CURRENT_DATE - INTERVAL '1 year'\n        OR s.scheduled_departure IS NULL\n    GROUP BY r.route_id, r.route_name, r.route_type\n),\nvessel_fleet_summary AS (\n    -- Fifth CTE: Summarize vessel fleet\n    SELECT\n        COUNT(DISTINCT ve.vessel_id) AS total_vessels,\n        COUNT(DISTINCT CASE WHEN ve.status = 'Active' THEN ve.vessel_id END) AS active_vessels,\n        SUM(ve.container_capacity_teu) AS total_fleet_capacity_teu,\n        AVG(ve.container_capacity_teu) AS avg_vessel_capacity_teu,\n        COUNT(DISTINCT ve.carrier_id) AS unique_carriers_with_vessels\n    FROM vessels ve\n),\nexecutive_kpi_calculations AS (\n    -- Sixth CTE: Calculate executive KPIs\n    SELECT\n        ok.total_sailings,\n        ok.completed_sailings,\n        ok.cancelled_sailings,\n        ROUND(CAST(ok.total_teu_carried AS NUMERIC), 2) AS total_teu_carried,\n        ROUND(CAST(ok.avg_capacity_utilization AS NUMERIC), 2) AS avg_capacity_utilization,\n        ROUND(CAST(ok.avg_transit_days AS NUMERIC), 2) AS avg_transit_days,\n        ok.on_time_arrivals,\n        ok.on_time_departures,\n        -- Completion rate\n        CASE\n            WHEN ok.total_sailings > 0 THEN\n                ROUND(CAST((ok.completed_sailings::NUMERIC / ok.total_sailings::NUMERIC) * 100 AS NUMERIC), 2)\n            ELSE 0\n        END AS completion_rate,\n        -- On-time performance rate\n        CASE\n            WHEN ok.total_sailings > 0 THEN\n                ROUND(CAST((ok.on_time_arrivals::NUMERIC / ok.total_sailings::NUMERIC) * 100 AS NUMERIC), 2)\n            ELSE 0\n        END AS on_time_performance_rate,\n        -- Cancellation rate\n        CASE\n            WHEN ok.total_sailings > 0 THEN\n                ROUND(CAST((ok.cancelled_sailings::NUMERIC / ok.total_sailings::NUMERIC) * 100 AS NUMERIC), 2)\n            ELSE 0\n        END AS cancellation_rate,\n        -- Carrier count\n        (SELECT COUNT(DISTINCT carrier_id) FROM carriers) AS total_carriers,\n        -- Port count\n        (SELECT COUNT(DISTINCT port_id) FROM ports) AS total_ports,\n        -- Route count\n        (SELECT COUNT(DISTINCT route_id) FROM routes) AS total_routes,\n        -- Vessel fleet summary\n        vfs.total_vessels,\n        vfs.active_vessels,\n        ROUND(CAST(vfs.total_fleet_capacity_teu AS NUMERIC), 0) AS total_fleet_capacity_teu,\n        ROUND(CAST(vfs.avg_vessel_capacity_teu AS NUMERIC), 2) AS avg_vessel_capacity_teu,\n        vfs.unique_carriers_with_vessels,\n        -- Top performing carrier\n        (SELECT cps.carrier_name\n         FROM carrier_performance_summary cps\n         ORDER BY cps.carrier_avg_capacity_utilization DESC\n         LIMIT 1) AS top_carrier_by_utilization,\n        -- Busiest port\n        (SELECT pos.port_name\n         FROM port_operations_summary pos\n         ORDER BY pos.total_port_calls DESC\n         LIMIT 1) AS busiest_port,\n        -- Most active route\n        (SELECT ris.route_name\n         FROM route_intelligence_summary ris\n         ORDER BY ris.route_total_sailings DESC\n         LIMIT 1) AS most_active_route\n    FROM operational_kpis ok\n    CROSS JOIN vessel_fleet_summary vfs\n),\nmarket_intelligence_summary AS (\n    -- Seventh CTE: Summarize market intelligence\n    SELECT\n        COUNT(DISTINCT pp.port_pair_id) AS total_port_pairs,\n        AVG(pp.average_transit_days) AS market_avg_transit_days,\n        AVG(pp.service_frequency_weeks) AS market_avg_sailings_per_pair,\n        -- Market concentration (HHI approximation)\n        AVG(\n            POWER(\n                (SELECT COUNT(DISTINCT r3.carrier_id) FROM sailings s2 INNER JOIN routes r3 ON s2.route_id = r3.route_id WHERE s2.route_id = r2.route_id)::NUMERIC / \n                NULLIF((SELECT COUNT(DISTINCT carrier_id) FROM carriers), 0), \n                2\n            )\n        ) * 10000 AS market_concentration_index\n    FROM port_pairs pp\n    LEFT JOIN routes r2 ON pp.origin_port_id = r2.route_id -- Simplified join\n    GROUP BY pp.port_pair_id\n),\nexecutive_dashboard_summary AS (\n    -- Eighth CTE: Generate executive dashboard summary\n    SELECT\n        ekc.total_sailings,\n        ekc.completed_sailings,\n        ekc.cancelled_sailings,\n        ekc.total_teu_carried,\n        ekc.avg_capacity_utilization,\n        ekc.avg_transit_days,\n        ekc.on_time_arrivals,\n        ekc.on_time_departures,\n        ekc.completion_rate,\n        ekc.on_time_performance_rate,\n        ekc.cancellation_rate,\n        ekc.total_carriers,\n        ekc.total_ports,\n        ekc.total_routes,\n        ekc.total_vessels,\n        ekc.active_vessels,\n        ekc.total_fleet_capacity_teu,\n        ekc.avg_vessel_capacity_teu,\n        ekc.unique_carriers_with_vessels,\n        ekc.top_carrier_by_utilization,\n        ekc.busiest_port,\n        ekc.most_active_route,\n        -- Market intelligence\n        mis.total_port_pairs,\n        ROUND(CAST(mis.market_avg_transit_days AS NUMERIC), 2) AS market_avg_transit_days,\n        ROUND(CAST(mis.market_avg_sailings_per_pair AS NUMERIC), 2) AS market_avg_sailings_per_pair,\n        ROUND(CAST(mis.market_concentration_index AS NUMERIC), 2) AS market_concentration_index,\n        -- Overall performance score\n        (\n            -- Completion rate component (30%)\n            (ekc.completion_rate / 100.0) * 30 +\n            -- On-time performance component (25%)\n            (ekc.on_time_performance_rate / 100.0) * 25 +\n            -- Capacity utilization component (25%)\n            (ekc.avg_capacity_utilization / 100.0) * 25 +\n            -- Fleet utilization component (20%)\n            CASE\n                WHEN ekc.total_fleet_capacity_teu > 0 THEN\n                    LEAST(1.0, (ekc.total_teu_carried / (ekc.total_fleet_capacity_teu * 12.0))) * 20\n                ELSE 0\n            END\n        ) AS overall_performance_score,\n        -- Performance classification\n        CASE\n            WHEN (\n                (ekc.completion_rate / 100.0) * 30 +\n                (ekc.on_time_performance_rate / 100.0) * 25 +\n                (ekc.avg_capacity_utilization / 100.0) * 25 +\n                CASE\n                    WHEN ekc.total_fleet_capacity_teu > 0 THEN\n                        LEAST(1.0, (ekc.total_teu_carried / (ekc.total_fleet_capacity_teu * 12.0))) * 20\n                    ELSE 0\n                END\n            ) >= 90 THEN 'Excellent Performance'\n            WHEN (\n                (ekc.completion_rate / 100.0) * 30 +\n                (ekc.on_time_performance_rate / 100.0) * 25 +\n                (ekc.avg_capacity_utilization / 100.0) * 25 +\n                CASE\n                    WHEN ekc.total_fleet_capacity_teu > 0 THEN\n                        LEAST(1.0, (ekc.total_teu_carried / (ekc.total_fleet_capacity_teu * 12.0))) * 20\n                    ELSE 0\n                END\n            ) >= 80 THEN 'Good Performance'\n            WHEN (\n                (ekc.completion_rate / 100.0) * 30 +\n                (ekc.on_time_performance_rate / 100.0) * 25 +\n                (ekc.avg_capacity_utilization / 100.0) * 25 +\n                CASE\n                    WHEN ekc.total_fleet_capacity_teu > 0 THEN\n                        LEAST(1.0, (ekc.total_teu_carried / (ekc.total_fleet_capacity_teu * 12.0))) * 20\n                    ELSE 0\n                END\n            ) >= 70 THEN 'Average Performance'\n            WHEN (\n                (ekc.completion_rate / 100.0) * 30 +\n                (ekc.on_time_performance_rate / 100.0) * 25 +\n                (ekc.avg_capacity_utilization / 100.0) * 25 +\n                CASE\n                    WHEN ekc.total_fleet_capacity_teu > 0 THEN\n                        LEAST(1.0, (ekc.total_teu_carried / (ekc.total_fleet_capacity_teu * 12.0))) * 20\n                    ELSE 0\n                END\n            ) >= 60 THEN 'Below Average Performance'\n            ELSE 'Needs Improvement'\n        END AS performance_classification,\n        -- Strategic insights\n        CASE\n            WHEN ekc.completion_rate < 90 THEN 'Focus on Improving Completion Rate'\n            WHEN ekc.on_time_performance_rate < 80 THEN 'Improve On-Time Performance'\n            WHEN ekc.avg_capacity_utilization < 70 THEN 'Optimize Capacity Utilization'\n            WHEN ekc.cancellation_rate > 5 THEN 'Reduce Cancellation Rate'\n            ELSE 'Operations Performing Well'\n        END AS strategic_insight\n    FROM executive_kpi_calculations ekc\n    CROSS JOIN market_intelligence_summary mis\n)\nSELECT\n    total_sailings,\n    completed_sailings,\n    cancelled_sailings,\n    total_teu_carried,\n    avg_capacity_utilization,\n    avg_transit_days,\n    on_time_arrivals,\n    on_time_departures,\n    completion_rate,\n    on_time_performance_rate,\n    cancellation_rate,\n    total_carriers,\n    total_ports,\n    total_routes,\n    total_vessels,\n    active_vessels,\n    total_fleet_capacity_teu,\n    avg_vessel_capacity_teu,\n    unique_carriers_with_vessels,\n    top_carrier_by_utilization,\n    busiest_port,\n    most_active_route,\n    total_port_pairs,\n    market_avg_transit_days,\n    market_avg_sailings_per_pair,\n    market_concentration_index,\n    ROUND(CAST(overall_performance_score AS NUMERIC), 2) AS overall_performance_score,\n    performance_classification,\n    strategic_insight\nFROM executive_dashboard_summary\nLIMIT 1;",
      "line_number": 10071
    }
  ],
  "metadata": {
    "total_queries": 30,
    "extraction_timestamp": "20260204-2020",
    "format_date": "20260210-0053"
  }
}